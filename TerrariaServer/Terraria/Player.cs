using System;
using System.Collections.Generic;
using System.IO;
using System.Security.Cryptography;
using System.Text;
using Microsoft.Xna.Framework;
using ReLogic.Utilities;
using Terraria.Audio;
using Terraria.Chat;
using Terraria.DataStructures;
using Terraria.Enums;
using Terraria.GameContent;
using Terraria.GameContent.Achievements;
using Terraria.GameContent.Creative;
using Terraria.GameContent.Drawing;
using Terraria.GameContent.Events;
using Terraria.GameContent.Generation.Dungeon;
using Terraria.GameContent.Golf;
using Terraria.GameContent.Items;
using Terraria.GameContent.ObjectInteractions;
using Terraria.GameContent.Tile_Entities;
using Terraria.GameContent.UI;
using Terraria.GameInput;
using Terraria.Graphics;
using Terraria.Graphics.CameraModifiers;
using Terraria.Graphics.Capture;
using Terraria.Graphics.Shaders;
using Terraria.ID;
using Terraria.IO;
using Terraria.Localization;
using Terraria.Map;
using Terraria.ObjectData;
using Terraria.Social;
using Terraria.Testing;
using Terraria.UI;
using Terraria.UI.Chat;
using Terraria.UI.Gamepad;
using Terraria.Utilities;
using Terraria.WorldBuilding;

namespace Terraria;

public class Player : Entity, IFixLoadedData
{
	public static class BuilderAccToggleIDs
	{
		public const int RulerLine = 0;

		public const int RulerGrid = 1;

		public const int AutoActuate = 2;

		public const int AutoPaint = 3;

		public const int WireVisibility_Red = 4;

		public const int WireVisibility_Green = 5;

		public const int WireVisibility_Blue = 6;

		public const int WireVisibility_Yellow = 7;

		public const int HideAllWires = 8;

		public const int WireVisibility_Actuators = 9;

		public const int BlockSwap = 10;

		public const int TorchBiome = 11;

		public static readonly int Count = 12;
	}

	public struct PlayerInputSyncCache
	{
		public bool controlLeft;

		public bool controlRight;

		public bool controlUp;

		public bool controlDown;

		public bool controlJump;

		public bool PressingAnyInput
		{
			get
			{
				if (!controlLeft && !controlRight && !controlUp && !controlDown)
				{
					return controlJump;
				}
				return true;
			}
		}

		public PlayerInputSyncCache(Player player)
		{
			controlLeft = player.controlLeft;
			controlRight = player.controlRight;
			controlUp = player.controlUp;
			controlDown = player.controlDown;
			controlJump = player.controlJump;
		}
	}

	private struct ChannelCancelKey
	{
		public int ProjectileTypeExpected;

		public int ProjectileIndexExpected;

		public bool Matches(Projectile projectile)
		{
			if (projectile.aiStyle == 99 && projectile.ai[0] == -3f)
			{
				return true;
			}
			if (ProjectileTypeExpected == projectile.type)
			{
				return ProjectileIndexExpected == projectile.whoAmI;
			}
			return false;
		}

		public void TryTracking(Projectile projectile)
		{
			if (ProjectileTypeExpected == projectile.type)
			{
				ProjectileIndexExpected = projectile.whoAmI;
			}
		}
	}

	public struct RabbitOrderFrameHelper
	{
		public int DisplayFrame;

		private int _frameCounter;

		private int _aiState;

		private const int AIState_Idle = 0;

		private const int AIState_LookingAtCamera = 1;

		private const int AIState_Resting = 2;

		private const int AIState_EatingCarrot = 3;

		public void Update()
		{
			switch (_aiState)
			{
			case 0:
				UpdateFrame(0, 0, Main.rand.Next(1, 4), Main.rand.Next(180, 3600));
				break;
			case 1:
				UpdateFrame(7, 9, 0, 20);
				break;
			case 2:
			{
				int gameFramesPerDisplayFrame = 8;
				if (DisplayFrame == 13)
				{
					gameFramesPerDisplayFrame = 120;
				}
				UpdateFrame(10, 16, 0, gameFramesPerDisplayFrame);
				break;
			}
			case 3:
				UpdateFrame(17, 26, 0, 4);
				break;
			}
		}

		public void Reset()
		{
			ChangeToAIState(0);
		}

		private void ChangeToAIState(int aiState)
		{
			_aiState = aiState;
			_frameCounter = 0;
			Update();
		}

		private void UpdateFrame(int displayFrameMin, int displayFrameMax, int exitAIState, int gameFramesPerDisplayFrame)
		{
			DisplayFrame = Utils.Clamp(DisplayFrame, displayFrameMin, displayFrameMax);
			if (_frameCounter++ >= gameFramesPerDisplayFrame)
			{
				_frameCounter = 0;
				if (DisplayFrame++ >= displayFrameMax)
				{
					ChangeToAIState(exitAIState);
				}
			}
		}
	}

	public enum CompositeArmStretchAmount
	{
		Full,
		None,
		Quarter,
		ThreeQuarters
	}

	public struct CompositeArmData
	{
		public bool enabled;

		public CompositeArmStretchAmount stretch;

		public float rotation;

		public CompositeArmData(bool enabled, CompositeArmStretchAmount intendedStrech, float rotation)
		{
			this.enabled = enabled;
			stretch = intendedStrech;
			this.rotation = rotation;
		}
	}

	public delegate void DashStartAction(int dashDirection);

	public struct SetMatchRequest
	{
		public Player Player;

		public int Head;

		public int Body;

		public int Legs;

		public int ArmorSlotRequested;

		public bool Male;
	}

	public struct ItemSpaceStatus
	{
		public readonly bool CanTakeItem;

		public readonly bool ItemIsGoingToVoidVault;

		public bool CanTakeItemToPersonalInventory
		{
			get
			{
				if (CanTakeItem)
				{
					return !ItemIsGoingToVoidVault;
				}
				return false;
			}
		}

		public ItemSpaceStatus(bool CanTakeItem, bool ItemIsGoingToVoidVault = false)
		{
			this.CanTakeItem = CanTakeItem;
			this.ItemIsGoingToVoidVault = ItemIsGoingToVoidVault;
		}
	}

	public struct ItemCheckContext
	{
		public bool SkipItemConsumption;
	}

	private struct SpecialToolUsageSettings
	{
		public delegate bool CanUseToolCondition(Player user, Item item, int targetX, int targetY);

		public delegate void UseToolAction(Player user, Item item, int targetX, int targetY);

		public bool IsAValidTool;

		public CanUseToolCondition UsageCondition;

		public UseToolAction UsageAction;
	}

	public class SavedPlayerDataWithAnnoyingRules
	{
		public bool godmodePowerEnabled;

		public bool farPlacementRangePowerEnabled;

		public float spawnRatePowerSliderValue;
	}

	public static class Hooks
	{
		public static event Action<Player> OnEnterWorld;

		public static void PlayerConnect(int playerIndex)
		{
			PressurePlateHelper.ResetPlayer(playerIndex);
		}

		public static void PlayerDisconnect(int playerIndex)
		{
			PressurePlateHelper.ResetPlayer(playerIndex);
		}

		public static void EnterWorld(int playerIndex)
		{
			if (Hooks.OnEnterWorld != null)
			{
				Hooks.OnEnterWorld(Main.player[playerIndex]);
			}
			if (playerIndex == Main.myPlayer)
			{
				Main.ToggleGameplayUpdates(state: true);
			}
			if (playerIndex == Main.myPlayer)
			{
				_localMinionRespawner.Clear();
			}
			AchievementsHelper.CheckResearchAchievement(forced: true);
		}
	}

	public class SmartCursorSettings
	{
		public static bool SmartBlocksEnabled;

		public static bool SmartAxeAfterPickaxe;

		public static bool SmartCursorHoldCanReleaseMidUse;
	}

	public class Settings
	{
		public enum StackToNearbyChestsMode : byte
		{
			QuickStackToNearbyChests,
			SmartStackToNearbyChests
		}

		public enum HoverControlMode
		{
			Hold,
			Click
		}

		public static StackToNearbyChestsMode StackToChestsPreferredMode = StackToNearbyChestsMode.QuickStackToNearbyChests;

		public static bool CraftFromNearbyChests = true;

		public static HoverControlMode HoverControl = HoverControlMode.Hold;

		public static void CycleQuickStackMode()
		{
			StackToChestsPreferredMode = ((StackToChestsPreferredMode == StackToNearbyChestsMode.QuickStackToNearbyChests) ? StackToNearbyChestsMode.SmartStackToNearbyChests : StackToNearbyChestsMode.QuickStackToNearbyChests);
		}

		public static void CycleHoverControl()
		{
			switch (HoverControl)
			{
			case HoverControlMode.Hold:
				HoverControl = HoverControlMode.Click;
				break;
			case HoverControlMode.Click:
				HoverControl = HoverControlMode.Hold;
				break;
			}
		}
	}

	public struct SelectedItemState
	{
		private readonly Player player;

		private int selected;

		private int hotbar;

		private int buffered;

		private int overridden;

		public bool CanChangeSelectedItemImmediately
		{
			get
			{
				if (!player.UsingOrReusingItem)
				{
					return player.ItemTimeIsZero;
				}
				return false;
			}
		}

		public int Selected => selected;

		public int Hotbar => hotbar;

		public bool HasActiveOverride => overridden >= 0;

		public bool HasBufferedChange => buffered >= 0;

		public int LastNonOverridenSelection
		{
			get
			{
				if (!HasBufferedChange)
				{
					if (HasActiveOverride)
					{
						return -1;
					}
					return selected;
				}
				return buffered;
			}
		}

		public SelectedItemState(Player player)
		{
			this.player = player;
			selected = 0;
			hotbar = 0;
			buffered = -1;
			overridden = -1;
		}

		private void OverrideSelection(int item)
		{
			if (CanChangeSelectedItemImmediately && item != selected)
			{
				if (overridden == -1)
				{
					overridden = selected;
				}
				if (item == overridden)
				{
					overridden = -1;
				}
				selected = item;
			}
		}

		public void Select(int item)
		{
			if (item < 10)
			{
				hotbar = item;
			}
			if (player != Main.LocalPlayer)
			{
				selected = item;
			}
			else
			{
				if (item >= 10 && player.inventory[item].IsAir)
				{
					return;
				}
				if (selected != item)
				{
					buffered = item;
					if (item != overridden)
					{
						SoundEngine.PlaySound(12);
					}
				}
				else
				{
					buffered = -1;
					overridden = -1;
				}
				player.afkCounter = 0;
				player.afkCounterForKiting = 0;
			}
		}

		public void Update()
		{
			if (CanChangeSelectedItemImmediately && player == Main.LocalPlayer)
			{
				int num = selected;
				bool hasBufferedChange = HasBufferedChange;
				if (HasBufferedChange)
				{
					selected = buffered;
				}
				else if (HasActiveOverride)
				{
					selected = overridden;
				}
				buffered = -1;
				overridden = -1;
				if (selected >= 10 && player.HeldItem.IsAir)
				{
					selected = hotbar;
				}
				if (player.PickItemSelectionOverride(out var selectedSlot))
				{
					OverrideSelection(selectedSlot);
				}
				if (selected != num)
				{
					OnSelectionChanged(hasBufferedChange && !HasActiveOverride);
				}
			}
		}

		private void OnSelectionChanged(bool continueAutoReuseWithNewItem)
		{
			player.itemTime = (player.itemTimeMax = 0);
			player.lastItemUseAttemptSuccess = true;
			if (player.controlUseItem)
			{
				if (continueAutoReuseWithNewItem)
				{
					player.releaseUseItem = true;
				}
				else if (!player.releaseUseItem)
				{
					Main.blockMouse = true;
				}
			}
		}
	}

	public class SelectionRadial
	{
		public enum SelectionMode
		{
			Dpad4,
			RadialCircular,
			RadialQuicks
		}

		private int _SelectedBinding = -1;

		public int RadialCount;

		public int[] Bindings;

		public SelectionMode Mode;

		public int SelectedBinding => _SelectedBinding;

		public int SelectedItem
		{
			get
			{
				if (_SelectedBinding == -1)
				{
					return -1;
				}
				return Bindings[_SelectedBinding];
			}
		}

		public SelectionRadial(SelectionMode mode = SelectionMode.Dpad4)
		{
			Mode = mode;
			int radialCount = 0;
			switch (mode)
			{
			case SelectionMode.Dpad4:
				radialCount = 4;
				break;
			case SelectionMode.RadialCircular:
				radialCount = 10;
				break;
			case SelectionMode.RadialQuicks:
				radialCount = 4;
				break;
			}
			RadialCount = radialCount;
			Bindings = new int[RadialCount];
			for (int i = 0; i < RadialCount; i++)
			{
				Bindings[i] = -1;
			}
		}

		public void Update()
		{
			switch (Mode)
			{
			case SelectionMode.Dpad4:
				if (PlayerInput.Triggers.JustPressed.DpadRadial1)
				{
					ChangeSelection(0);
				}
				if (PlayerInput.Triggers.JustPressed.DpadRadial2)
				{
					ChangeSelection(1);
				}
				if (PlayerInput.Triggers.JustPressed.DpadRadial3)
				{
					ChangeSelection(2);
				}
				if (PlayerInput.Triggers.JustPressed.DpadRadial4)
				{
					ChangeSelection(3);
				}
				break;
			case SelectionMode.RadialCircular:
			case SelectionMode.RadialQuicks:
			{
				for (int i = 0; i < RadialCount; i++)
				{
					Bindings[i] = i;
				}
				if ((Mode != SelectionMode.RadialCircular || !PlayerInput.Triggers.Current.RadialHotbar) && (Mode != SelectionMode.RadialQuicks || !PlayerInput.Triggers.Current.RadialQuickbar))
				{
					break;
				}
				bool flag = Mode == SelectionMode.RadialCircular;
				float num = (float)Math.PI * 2f / (float)RadialCount / 2f;
				Vector2 vector = PlayerInput.GamepadThumbstickRight.RotatedBy(-(float)Math.PI / 2f + num);
				if (vector.Length() == 0f)
				{
					vector = PlayerInput.GamepadThumbstickLeft.RotatedBy(-(float)Math.PI / 2f + num);
				}
				int num2 = -1;
				if (vector.Length() > 0.3f)
				{
					num2 = (int)((vector.ToRotation() + (float)Math.PI) / ((float)Math.PI * 2f / (float)RadialCount));
					if (num2 >= RadialCount)
					{
						num2 -= RadialCount;
					}
				}
				if ((num2 != -1 || !flag) && _SelectedBinding != num2 && (num2 != -1 || !(vector != Vector2.Zero)))
				{
					ChangeSelection(num2);
				}
				break;
			}
			}
		}

		public void ChangeBinding(int itemSlot)
		{
			if (itemSlot >= 0 && itemSlot < 50 && Mode == SelectionMode.Dpad4)
			{
				if (PlayerInput.Triggers.JustPressed.DpadRadial1)
				{
					Bind(itemSlot, 0);
				}
				if (PlayerInput.Triggers.JustPressed.DpadRadial2)
				{
					Bind(itemSlot, 1);
				}
				if (PlayerInput.Triggers.JustPressed.DpadRadial3)
				{
					Bind(itemSlot, 2);
				}
				if (PlayerInput.Triggers.JustPressed.DpadRadial4)
				{
					Bind(itemSlot, 3);
				}
			}
		}

		public void ChangeSelection(int to)
		{
			if (_SelectedBinding == to)
			{
				_SelectedBinding = -1;
			}
			else
			{
				_SelectedBinding = to;
			}
		}

		private void Bind(int itemslot, int radialslot)
		{
			ChangeSelection(-1);
			if (Bindings[radialslot] == itemslot)
			{
				Bindings[radialslot] = -1;
				return;
			}
			for (int i = 0; i < RadialCount; i++)
			{
				if (Bindings[i] == itemslot)
				{
					Bindings[i] = -1;
				}
			}
			Bindings[radialslot] = itemslot;
		}

		public int GetDrawMode(int itemslot)
		{
			if (SelectedBinding != -1 && Bindings[SelectedBinding] == itemslot)
			{
				return 2;
			}
			for (int i = 0; i < RadialCount; i++)
			{
				if (Bindings[i] == itemslot)
				{
					return 1;
				}
			}
			return 0;
		}

		public void CopyTo(SelectionRadial that)
		{
			that._SelectedBinding = _SelectedBinding;
			that.Mode = Mode;
			that.RadialCount = RadialCount;
			Array.Resize(ref that.Bindings, RadialCount);
			for (int i = 0; i < RadialCount; i++)
			{
				that.Bindings[i] = Bindings[i];
			}
		}
	}

	public struct OverheadMessage
	{
		public string chatText;

		public TextSnippet[] snippets;

		public Vector2 messageSize;

		public int timeLeft;

		public Color color;

		public void NewMessage(string message, int displayTime)
		{
			chatText = message;
			snippets = ChatManager.ParseMessage(chatText, Color.White).ToArray();
			messageSize = ChatManager.GetStringSize(FontAssets.MouseText.Value, snippets, Vector2.One);
			timeLeft = displayTime;
		}
	}

	public bool active;

	public bool host;

	public Minecart.Customization MinecartSettings;

	public int emoteTime;

	public CreativeUnlocksTracker creativeTracker;

	private static byte[] ENCRYPTION_KEY = new UnicodeEncoding().GetBytes("h3y_gUyZ");

	public OverheadMessage chatOverhead;

	public SelectionRadial DpadRadial = new SelectionRadial();

	public SelectionRadial CircularRadial = new SelectionRadial(SelectionRadial.SelectionMode.RadialCircular);

	public SelectionRadial QuicksRadial = new SelectionRadial(SelectionRadial.SelectionMode.RadialQuicks);

	public bool alchemyTable;

	public bool GoingDownWithGrapple;

	public byte spelunkerTimer;

	public bool[] hideInfo = new bool[13];

	public int[] builderAccStatus = new int[BuilderAccToggleIDs.Count];

	public long lostCoins;

	public string lostCoinString = "";

	public int soulDrain;

	public float drainBoost;

	public bool dd2Accessory;

	public string name = "";

	public int taxMoney;

	public int taxTimer;

	public static int taxRate = 3600;

	public int numberOfDeathsPVE;

	public int numberOfDeathsPVP;

	public static int crystalLeafDamage = 100;

	public static int crystalLeafKB = 10;

	public float basiliskCharge;

	public static float PaladinsShieldRange = 800f;

	public Vector2 lastDeathPostion;

	public DateTime lastDeathTime;

	public bool showLastDeath;

	public bool usedAegisCrystal;

	public bool usedAegisFruit;

	public bool usedArcaneCrystal;

	public bool usedGalaxyPearl;

	public bool usedGummyWorm;

	public bool usedAmbrosia;

	public int extraAccessorySlots = 2;

	public bool extraAccessory;

	private bool dontConsumeWand;

	public int tankPet = -1;

	public bool tankPetReset;

	public int stringColor;

	public int counterWeight;

	public int vanityCounterWeight;

	public bool magicString;

	public bool yoyoString;

	public bool yoyoGlove;

	private float rapidAttackBonus;

	public bool stressBall;

	public bool stressBallPrevious;

	public bool staffOfRegrowthBonus;

	public int beetleOrbs;

	public float beetleCounter;

	public int beetleCountdown;

	public bool beetleDefense;

	public bool beetleOffense;

	public bool beetleBuff;

	public int solarShields;

	public int solarCounter;

	public const int maxSolarShields = 3;

	public Vector2[] solarShieldPos = new Vector2[3];

	public Vector2[] solarShieldVel = new Vector2[3];

	public bool solarDashing;

	public bool solarDashConsumedFlare;

	public const int nebulaMaxLevel = 3;

	public int nebulaLevelLife;

	public int nebulaLevelMana;

	public int nebulaManaCounter;

	public int nebulaLevelDamage;

	public bool manaMagnet;

	public bool lifeMagnet;

	public bool treasureMagnet;

	public bool chiselSpeed;

	public bool lifeForce;

	public bool hasDeadCellsDownDash;

	public bool calmed;

	public bool inferno;

	public float flameRingRot;

	public float flameRingScale = 1f;

	public byte flameRingFrame;

	public byte flameRingAlpha;

	public int netManaTime;

	public int netLifeTime;

	public bool netMana;

	public bool netLife;

	public Vector2[] beetlePos = new Vector2[3];

	public Vector2[] beetleVel = new Vector2[3];

	public int beetleFrame;

	public int beetleFrameCounter;

	public static int manaSickTime = 300;

	public static float manaSickLessDmg = 0.25f;

	public float manaSickReduction;

	public bool manaSick;

	public int afkCounter;

	public static readonly int AFKTimeNeededForNoWormSpawns = 300;

	public static readonly int AFKTimeNeededForNoLuckyStars = 10800;

	public int afkCounterForKiting;

	public static int AFKTimeNeededForAutoKiting = 3600;

	public bool stairFall;

	public int loadStatus;

	public Vector2[] itemFlamePos = new Vector2[7];

	public int itemFlameCount;

	public bool outOfRange;

	public float lifeSteal = 99999f;

	public float ghostDmg;

	public bool teleporting;

	public float teleportTime;

	public int teleportStyle;

	public int unacknowledgedTeleports;

	public bool sloping;

	public bool chilled;

	public bool dazed;

	public bool frozen;

	public bool stoned;

	public bool lastStoned;

	public bool ichor;

	public bool webbed;

	public bool tipsy;

	public bool noBuilding;

	public int ropeCount;

	public int manaRegenBonus;

	public float manaRegenDelayBonus;

	public int dashType;

	public int dash;

	public int dashTime;

	public int timeSinceLastDashStarted;

	public int dashDelay;

	public int eocDash;

	public int eocHit = -1;

	public float accRunSpeed;

	public bool cordage;

	public int gem = -1;

	public int gemCount;

	public BitsByte ownedLargeGems;

	public byte meleeEnchant;

	public byte pulleyDir;

	public bool pulley;

	public int pulleyFrame;

	public float pulleyFrameCounter;

	public bool blackBelt;

	public bool sliding;

	public int slideDir;

	public int snowBallLauncherInteractionCooldown;

	public bool iceSkate;

	public bool carpet;

	public int spikedBoots;

	public int carpetFrame = -1;

	public float carpetFrameCounter;

	public bool canCarpet;

	public int carpetTime;

	public int miscCounter;

	public int infernoCounter;

	public int insanityShadowCooldown;

	public int starCloakCooldown;

	public bool sandStorm;

	public bool crimsonRegen;

	public bool ghostHeal;

	public bool ghostHurt;

	public bool sticky;

	public bool slippy;

	public bool slippy2;

	public bool powerrun;

	public bool runningOnSand;

	public bool flapSound;

	public bool iceBarrier;

	public bool dangerSense;

	public byte luckPotion;

	public byte oldLuckPotion;

	public float endurance;

	public float whipRangeMultiplier;

	public float whipUseTimeMultiplier;

	public bool loveStruck;

	public bool stinky;

	public bool resistCold;

	public bool electrified;

	public bool dryadWard;

	public bool panic;

	public Item brainOfConfusionItem;

	public int brainOfConfusionDodgeAnimationCounter;

	public byte iceBarrierFrame;

	public byte iceBarrierFrameCounter;

	public bool shadowDodge;

	public float shadowDodgeCount;

	public bool palladiumRegen;

	public bool onHitDodge;

	public bool onHitRegen;

	public bool onHitPetal;

	public bool onHitTitaniumStorm;

	public int titaniumStormCooldown;

	public bool hasTitaniumStormBuff;

	public int petalTimer;

	public int shadowDodgeTimer;

	public int boneGloveTimer;

	public int phantomPhoneixCounter;

	public int fishingSkill;

	public bool cratePotion;

	public bool sonarPotion;

	public bool accFishingLine;

	public bool accFishingBobber;

	public bool accTackleBox;

	public bool accLavaFishing;

	public int maxMinions = 1;

	public int numMinions;

	public float slotsMinions;

	public bool pygmy;

	public bool raven;

	public bool slime;

	public bool hornetMinion;

	public bool impMinion;

	public bool twinsMinion;

	public bool spiderMinion;

	public int nextCycledSpiderMinionType;

	public bool pirateMinion;

	public bool sharknadoMinion;

	public bool UFOMinion;

	public bool DeadlySphereMinion;

	public bool stardustMinion;

	public bool stardustGuardian;

	public bool stardustDragon;

	public bool batsOfLight;

	public bool babyBird;

	public bool vampireFrog;

	public bool stormTiger;

	public int highestStormTigerGemOriginalDamage;

	public bool smolstar;

	public bool empressBlade;

	public bool flinxMinion;

	public bool abigailMinion;

	public int highestAbigailCounterOriginalDamage;

	public bool deadCellsMushroomBoiMinion;

	public bool palworldCattivaMinion;

	public bool palworldFoxsparksMinion;

	public float wingTime;

	public int wings;

	public int wingsLogic;

	public int wingTimeMax;

	public int wingFrame;

	public int wingFrameCounter;

	public int skinVariant;

	public int voiceVariant;

	public float voicePitchOffset;

	public bool ghost;

	public int ghostFrame;

	public int ghostFrameCounter;

	public int miscTimer;

	public int environmentBuffImmunityTimer;

	public int _framesLeftEligibleForDeadmansChestDeathAchievement;

	public bool pvpDeath;

	public BitsByte zone1 = (byte)0;

	public BitsByte zone2 = (byte)0;

	public BitsByte zone3 = (byte)0;

	public BitsByte zone4 = (byte)0;

	public BitsByte zone5 = (byte)0;

	private bool _wasInShimmerZone;

	public bool boneArmor;

	public bool frostArmor;

	public bool honey;

	public bool crystalLeaf;

	public int crystalLeafCooldown;

	public PortableStoolUsage portableStoolInfo;

	public bool preventAllItemPickups;

	public bool dontHurtCritters;

	public bool hasLucyTheAxe;

	public bool dontHurtNature;

	public int[] doubleTapCardinalTimer = new int[4];

	public int[] holdDownCardinalTimer = new int[4];

	public bool defendedByPaladin;

	public bool hasPaladinShield;

	public float[] speedSlice = new float[60];

	public int townNPCs;

	public double headFrameCounter;

	public double bodyFrameCounter;

	public double legFrameCounter;

	public bool immune;

	public bool immuneNoBlink;

	public int immuneTime;

	public int immuneAlphaDirection;

	public int immuneAlpha;

	public int team;

	private int _timeSinceLastImmuneGet;

	private int _immuneStrikes;

	public bool hbLocked;

	public static int nameLen = 20;

	public float maxRegenDelay;

	public int sign = -1;

	public bool editedChestName;

	public int reuseDelay;

	public int aggro;

	public float nearbyActiveNPCs;

	public bool creativeInterface;

	public bool mouseInterface;

	public bool lastMouseInterface;

	public int noThrow;

	public int changeItem = -1;

	public bool pendingItemReuse;

	public SelectedItemState selectedItemState;

	public int selectedKite;

	public int afkSelectedItem;

	public const int SupportedSlotsArmor = 3;

	public const int SupportedSlotsAccs = 7;

	public const int SupportedSlotSets = 10;

	public const int InitialAccSlotCount = 5;

	public const int miscSlotPet = 0;

	public const int miscSlotLight = 1;

	public const int miscSlotCart = 2;

	public const int miscSlotMount = 3;

	public const int miscSlotHook = 4;

	public const int SupportedMiscSlotCount = 5;

	public Item[] armor = new Item[20];

	public Item[] dye = new Item[10];

	public Item[] miscEquips = new Item[5];

	public Item[] miscDyes = new Item[5];

	public Item trashItem = new Item();

	public float itemRotation;

	public Vector2 itemLocation;

	public bool poundRelease;

	public float ghostFade;

	public float ghostDir = 1f;

	public static readonly int maxBuffs = 44;

	public int[] buffType = new int[maxBuffs];

	public int[] buffTime = new int[maxBuffs];

	public bool[] buffImmune = new bool[BuffID.Count];

	public int heldProj = -1;

	public int breathCD;

	public int breathMax = 200;

	public int breath = 200;

	public int lavaCD;

	public int lavaMax;

	public int lavaTime;

	public bool ignoreWater;

	public bool lavaVision;

	public float lavaOpacity = 1f;

	public bool armorEffectDrawShadow;

	public bool armorEffectDrawShadowSubtle;

	public bool armorEffectDrawOutlines;

	public bool armorEffectDrawShadowLokis;

	public bool armorEffectDrawShadowBasilisk;

	public bool armorEffectDrawOutlinesForbidden;

	public bool armorEffectDrawShadowEOCShield;

	public bool socialShadowRocketBoots;

	public bool socialGhost;

	public bool shroomiteStealth;

	public bool ashWoodBonus;

	public bool socialIgnoreLight;

	public int stealthTimer;

	public float stealth = 1f;

	public int beardGrowthTimer;

	public bool isDisplayDollOrInanimate;

	public bool isFullbright;

	public bool isHatRackDoll;

	public bool isFirstFractalAfterImage;

	public float firstFractalAfterImageOpacity;

	public string setBonus = "";

	public Item[] inventory = new Item[59];

	public bool[] inventoryChestStack = new bool[59];

	public Item lastVisualizedSelectedItem;

	public readonly Chest bank = Chest.CreateBank(-2);

	public readonly Chest bank2 = Chest.CreateBank(-3);

	public readonly Chest bank3 = Chest.CreateBank(-4);

	public readonly Chest bank4 = Chest.CreateBank(-5);

	public BitsByte voidVaultInfo;

	public float headRotation;

	public float bodyRotation;

	public float legRotation;

	public Vector2 headPosition;

	public Vector2 bodyPosition;

	public Vector2 legPosition;

	public Vector2 headVelocity;

	public Vector2 bodyVelocity;

	public Vector2 legVelocity;

	public float fullRotation;

	public Vector2 fullRotationOrigin = Vector2.Zero;

	public int fartKartCloudDelay;

	public const int fartKartCloudDelayMax = 20;

	public float gfxOffY;

	public float stepSpeed = 1f;

	public Vector2 netOffset;

	internal Vector2? netCameraTarget;

	internal Vector2? lastSyncedNetCameraTarget;

	public static bool deadForGood = false;

	public bool dead;

	public int deadTime;

	public int spectating = -1;

	public int respawnTimer;

	public static readonly int respawnTimerMax = 3600;

	public static readonly int DeadSpectatingLockoutTime = 60;

	public static readonly int SpectatingLingerAfterDeath = 180;

	public long lastTimePlayerWasSaved;

	public int attackCD;

	public int potionDelay;

	public byte difficulty;

	public byte wetSlime;

	public HitTile hitTile;

	public HitTile hitReplace;

	public int jump;

	public int head = -1;

	public int body = -1;

	public int legs = -1;

	public int coat = -1;

	public sbyte handon = -1;

	public sbyte handoff = -1;

	public sbyte back = -1;

	public sbyte front = -1;

	public sbyte shoe = -1;

	public sbyte waist = -1;

	public sbyte shield = -1;

	public sbyte neck = -1;

	public sbyte face = -1;

	public sbyte balloon = -1;

	public sbyte backpack = -1;

	public sbyte tail = -1;

	public sbyte faceHead = -1;

	public sbyte faceFlower = -1;

	public sbyte faceMask = -1;

	public sbyte balloonFront = -1;

	public sbyte beard = -1;

	public sbyte voiceOverride;

	public bool[] hideVisibleAccessory = new bool[10];

	public BitsByte hideMisc = (byte)0;

	public Rectangle headFrame;

	public Rectangle bodyFrame;

	public Rectangle legFrame;

	public Rectangle hairFrame;

	public PlayerInputSyncCache LocalInputCache;

	public bool controlLeft;

	public bool controlRight;

	public bool controlUp;

	public bool controlDown;

	public bool controlJump;

	public bool controlUseItem;

	public bool controlUseTile;

	public bool controlThrow;

	public bool controlInv;

	public bool controlHook;

	public bool controlTorch;

	public bool controlMap;

	public bool controlSmart;

	public bool controlMount;

	public bool controlQuickBuff;

	public bool releaseJump;

	public bool releaseUp;

	public bool releaseUseItem;

	public bool releaseUseTile;

	public bool releaseInventory;

	public bool releaseHook;

	public bool releaseThrow;

	public bool releaseQuickMana;

	public bool releaseQuickHeal;

	public bool releaseLeft;

	public bool releaseRight;

	public bool releaseSmart;

	public bool releaseMount;

	public bool releaseDown;

	public bool releaseQuickBuff;

	public bool controlQuickMana;

	public bool controlQuickHeal;

	public bool controlCreativeMenu;

	public bool releaseCreativeMenu;

	public bool tileInteractionHappened;

	public bool tileInteractAttempted;

	public bool controlDownHold;

	public bool isOperatingAnotherEntity;

	public bool lastItemUseAttemptSuccess;

	public bool autoReuseAllWeapons;

	public bool isControlledByFilm;

	public bool tryKeepingHoveringDown;

	public bool tryKeepingHoveringUp;

	public int altFunctionUse;

	public bool mapZoomIn;

	public bool mapZoomOut;

	public bool mapAlphaUp;

	public bool mapAlphaDown;

	public bool mapFullScreen;

	public bool mapStyle;

	public bool releaseMapFullscreen;

	public bool releaseMapStyle;

	public int leftTimer;

	public int rightTimer;

	public bool delayUseItem;

	public const int defaultWidth = 20;

	public const int defaultHeight = 42;

	public bool cursorItemIconEnabled;

	public bool cursorItemIconReversed;

	public int cursorItemIconID;

	public int cursorItemIconPush;

	public string cursorItemIconText = "";

	public int runSoundDelay;

	public float opacityForAnimation = 1f;

	public const int shadowMax = 3;

	public Vector2[] shadowPos = new Vector2[3];

	public float[] shadowRotation = new float[3];

	public Vector2[] shadowOrigin = new Vector2[3];

	public int[] shadowDirection = new int[3];

	public int shadowCount;

	public float manaCost = 1f;

	public bool fireWalk;

	public bool channel;

	public int step = -1;

	public TagEffectState TagEffectState;

	public PlayerIntentionGuesser IntentionGuesser;

	private ChannelCancelKey _channelShotCache;

	public bool skipAnimatingValuesInPlayerFrame;

	public RabbitOrderFrameHelper rabbitOrderFrame;

	public bool creativeGodMode;

	private const int MaxAdvancedShadows = 60;

	public int availableAdvancedShadowsCount;

	private EntityShadowInfo[] _advancedShadows = new EntityShadowInfo[60];

	private int _lastAddedAvancedShadow;

	public CompositeArmData compositeFrontArm;

	public CompositeArmData compositeBackArm;

	public int anglerQuestsFinished;

	public int golferScoreAccumulated;

	public int bartenderQuestLog;

	public bool downedDD2EventAnyDifficulty;

	public int armorPenetration;

	public int meleeArmorPenetration;

	public int statDefense;

	public int statLifeMax = 100;

	public int statLifeMax2 = 100;

	public int statLife = 100;

	public int statMana;

	public int statManaMax;

	public int statManaMax2;

	public int lifeRegen;

	public int lifeRegenCount;

	public float lifeRegenTime;

	public int manaRegen;

	public int manaRegenCount;

	public float manaRegenDelay;

	public bool manaRegenBuff;

	public bool noKnockback;

	private bool shimmerImmune;

	public bool spaceGun;

	public float gravDir = 1f;

	public bool chloroAmmoCost80;

	public bool huntressAmmoCost90;

	public bool ammoCost80;

	public bool ammoCost75;

	public int stickyBreak;

	public bool magicQuiver;

	public bool magmaStone;

	public bool lavaRose;

	public bool hasMoltenQuiver;

	public int phantasmTime;

	public bool ammoBox;

	public bool ammoPotion;

	public bool chaosState;

	public bool strongBees;

	public bool sporeSac;

	public bool shinyStone;

	public bool empressBrooch;

	public bool volatileGelatin;

	public int volatileGelatinCounter;

	public bool hasMagiluminescence;

	public bool shadowArmor;

	public bool dontStarveShader;

	public bool noirShader;

	public bool eyebrellaCloud;

	public int yoraiz0rEye;

	public bool yoraiz0rDarkness;

	public bool hasUnicornHorn;

	public bool hasAngelHalo;

	public bool hasRainbowCursor;

	public bool leinforsHair;

	public bool stardustMonolithShader;

	public bool nebulaMonolithShader;

	public bool vortexMonolithShader;

	public bool solarMonolithShader;

	public bool moonLordMonolithShader;

	public bool bloodMoonMonolithShader;

	public bool shimmerMonolithShader;

	public bool CRTMonolithShader;

	public bool retroMonolithShader;

	public int musicBox;

	public int overrideFishingBobber = -1;

	public bool unlockedBiomeTorches;

	public bool ateArtisanBread;

	public bool unlockedSuperCart;

	public bool enabledSuperCart = true;

	public bool suspiciouslookingTentacle;

	public bool crimsonHeart;

	public bool lightOrb;

	public bool blueFairy;

	public bool redFairy;

	public bool greenFairy;

	public bool bunny;

	public bool turtle;

	public bool eater;

	public bool penguin;

	public bool HasGardenGnomeNearby;

	public bool brokenMirrorBadLuck;

	public int brokenMirrorBadLuckTime;

	public bool magicLantern;

	public bool rabid;

	public bool sunflower;

	public bool wellFed;

	public bool puppy;

	public bool grinch;

	public bool miniMinotaur;

	public bool flowerBoots;

	public bool fairyBoots;

	public bool hellfireTreads;

	public bool moonLordLegs;

	public bool deadMansSweater;

	public bool arcticDivingGear;

	public bool coolWhipBuff;

	public bool cobWhipBuff;

	public bool wearsRobe;

	public bool onWrongGround;

	public bool onTrack;

	public int cartRampTime;

	public bool cartFlip;

	public float trackBoost;

	public Vector2 lastBoost = Vector2.Zero;

	public Mount mount;

	public bool blackCat;

	public bool spider;

	public bool squashling;

	public bool petFlagDD2Gato;

	public bool petFlagDD2Ghost;

	public bool petFlagDD2Dragon;

	public bool petFlagUpbeatStar;

	public bool petFlagSugarGlider;

	public bool petFlagBabyShark;

	public bool petFlagLilHarpy;

	public bool petFlagFennecFox;

	public bool petFlagGlitteryButterfly;

	public bool petFlagBabyImp;

	public bool petFlagBabyRedPanda;

	public bool petFlagPlantero;

	public bool petFlagDynamiteKitten;

	public bool petFlagBabyWerewolf;

	public bool petFlagShadowMimic;

	public bool petFlagVoltBunny;

	public bool petFlagKingSlimePet;

	public bool petFlagEyeOfCthulhuPet;

	public bool petFlagEaterOfWorldsPet;

	public bool petFlagBrainOfCthulhuPet;

	public bool petFlagSkeletronPet;

	public bool petFlagQueenBeePet;

	public bool petFlagDestroyerPet;

	public bool petFlagTwinsPet;

	public bool petFlagSkeletronPrimePet;

	public bool petFlagPlanteraPet;

	public bool petFlagGolemPet;

	public bool petFlagDukeFishronPet;

	public bool petFlagLunaticCultistPet;

	public bool petFlagMoonLordPet;

	public bool petFlagFairyQueenPet;

	public bool petFlagPumpkingPet;

	public bool petFlagEverscreamPet;

	public bool petFlagIceQueenPet;

	public bool petFlagMartianPet;

	public bool petFlagDD2OgrePet;

	public bool petFlagDD2BetsyPet;

	public bool petFlagQueenSlimePet;

	public bool petFlagBerniePet;

	public bool petFlagGlommerPet;

	public bool petFlagDeerclopsPet;

	public bool petFlagPigPet;

	public bool petFlagChesterPet;

	public bool petFlagJunimoPet;

	public bool petFlagBlueChickenPet;

	public bool petFlagSpiffo;

	public bool petFlagCaveling;

	public bool petFlagDirtiestBlock;

	public bool petFlagBoulderPet;

	public bool petFlagRainbowBoulderPet;

	public bool petFlagDeadCellsSwarmBiter;

	public bool petFlagPufferfish;

	public bool petFlagAxeFairyPet;

	public bool petFlagChillet;

	public bool petFlagChilletIgnis;

	public bool companionCube;

	public bool babyFaceMonster;

	public bool magicCuffs;

	public bool coldDash;

	public bool sailDash;

	public bool desertDash;

	public bool desertBoots;

	public bool eyeSpring;

	public bool snowman;

	public bool scope;

	public bool dino;

	public bool skeletron;

	public bool hornet;

	public bool zephyrfish;

	public bool tiki;

	public bool parrot;

	public bool truffle;

	public bool sapling;

	public bool cSapling;

	public bool wisp;

	public bool lizard;

	public bool archery;

	public bool poisoned;

	public bool venom;

	public bool blind;

	public bool blackout;

	public bool headcovered;

	public bool frostBurn;

	public bool onFrostBurn;

	public bool onFrostBurn2;

	public bool burned;

	public bool shimmering;

	public int timeShimmering;

	public float shimmerTransparency;

	public ShimmerUnstuckHelper shimmerUnstuckHelper;

	public bool suffocating;

	public byte suffocateDelay;

	public bool dripping;

	public bool drippingSlime;

	public bool drippingSparkleSlime;

	public bool onFire;

	public bool onFire2;

	public bool onFire3;

	public bool noItems;

	public bool cursed;

	public bool hungry;

	public bool starving;

	public bool heartyMeal;

	public bool windPushed;

	public bool wereWolf;

	public bool wolfAcc;

	public bool hideMerman;

	public bool hideWolf;

	public bool forceMerman;

	public bool forceWerewolf;

	public int sunScorchCounter;

	public bool rulerGrid;

	public bool rulerLine;

	public bool bleed;

	public bool confused;

	public bool accMerman;

	public bool merman;

	public bool trident;

	public bool brokenArmor;

	public bool silence;

	public bool slow;

	public bool gross;

	public bool tongued;

	public bool kbGlove;

	public bool autoReuseGlove;

	public bool meleeScaleGlove;

	public bool kbBuff;

	public bool remoteVisionForDrone;

	public Item starCloakItem;

	public Item starCloakItem_manaCloakOverrideItem;

	public Item starCloakItem_starVeilOverrideItem;

	public Item starCloakItem_beeCloakOverrideItem;

	public bool longInvince;

	public bool pStone;

	public static readonly float PhilosopherStoneDurationMultiplier = 0.75f;

	public bool manaFlower;

	public bool moonLeech;

	public bool vortexDebuff;

	public bool trapDebuffSource;

	public bool witheredArmor;

	public bool witheredWeapon;

	public bool slowOgreSpit;

	public bool parryDamageBuff;

	public bool ballistaPanic;

	public bool JustDroppedAnItem;

	public bool IsAllowedToHoldItems = true;

	public int meleeCrit = 4;

	public int magicCrit = 4;

	public int rangedCrit = 4;

	public float meleeDamage = 1f;

	public float magicDamage = 1f;

	public float rangedDamage = 1f;

	public float rangedMultDamage = 1f;

	public float arrowDamageAdditiveStack;

	public float arrowDamage = 1f;

	public float bulletDamage = 1f;

	public float rocketDamage = 1f;

	public float minionDamage = 1f;

	public float minionKB;

	public int revolverCritChanceBonus;

	public float meleeSpeed = 1f;

	public float summonerWeaponSpeedBonus;

	public float moveSpeed = 1f;

	public float pickSpeed = 1f;

	public float wallSpeed = 1f;

	public float tileSpeed = 1f;

	public bool autoPaint;

	public bool autoActuator;

	public int SpawnX = -1;

	public int SpawnY = -1;

	public Vector2? PotionOfReturnOriginalUsePosition;

	public Vector2? PotionOfReturnHomePosition;

	public int[] spX = new int[200];

	public int[] spY = new int[200];

	public string[] spN = new string[200];

	public int[] spI = new int[200];

	public static int tileRangeX = 5;

	public static int tileRangeY = 4;

	public int lastTileRangeX;

	public int lastTileRangeY;

	public static int tileTargetX;

	public static int tileTargetY;

	public static float defaultGravity = 0.4f;

	public static int jumpHeight = 15;

	public static float jumpSpeed = 5.01f;

	public float gravity = defaultGravity;

	public float maxFallSpeed = 10f;

	public float maxRunSpeed = 3f;

	public float runAcceleration = 0.08f;

	public float runSlowdown = 0.2f;

	public bool adjWaterSource;

	public bool adjHoney;

	public bool adjLava;

	public bool oldAdjWaterSource;

	public bool oldAdjHoney;

	public bool oldAdjLava;

	public bool[] adjTile = new bool[TileID.Count];

	public static int defaultItemGrabRange = 42;

	private static float itemGrabSpeed = 0.45f;

	private static float itemGrabSpeedMax = 4f;

	public byte hairDye;

	public Color hairDyeColor = Color.Transparent;

	public float hairDyeVar;

	public int skinDyePacked;

	public Color hairColor = new Color(215, 90, 55);

	public Color skinColor = new Color(255, 125, 90);

	public Color eyeColor = new Color(105, 90, 75);

	public Color shirtColor = new Color(175, 165, 140);

	public Color underShirtColor = new Color(160, 180, 215);

	public Color pantsColor = new Color(255, 230, 175);

	public Color shoeColor = new Color(160, 105, 60);

	public int hair;

	public bool hostile;

	public SoundPlaySet hermesStepSound = new SoundPlaySet();

	public Vector2 instantMovementAccumulatedThisFrame;

	public int accCompass;

	public int accWatch;

	public double accWatchTime;

	public int accDepthMeter;

	public bool accFishFinder;

	public bool accWeatherRadio;

	public bool accJarOfSouls;

	public bool accCalendar;

	public int lastCreatureHit = -1;

	public bool accThirdEye;

	public byte accThirdEyeCounter;

	public byte accThirdEyeNumber;

	public bool accStopwatch;

	public bool accOreFinder;

	public bool accCritterGuide;

	public byte accCritterGuideCounter;

	public byte accCritterGuideNumber;

	public bool accDreamCatcher;

	public bool hasFootball;

	public bool drawingFootball;

	public bool ActuationRodLock;

	public bool ActuationRodLockSetting;

	public bool InfoAccMechShowWires;

	public DateTime dpsStart;

	public DateTime dpsEnd;

	public DateTime dpsLastHit;

	public int dpsDamage;

	public bool dpsStarted;

	public string displayedFishingInfo = "";

	public bool discountEquipped;

	public bool discountAvailable;

	public bool hasLuckyCoin;

	public Item boneGloveItem;

	public bool goldRing;

	public bool accDivingHelm;

	public bool accFlipper;

	public bool deadCellsPotionStation;

	public bool hasLuck_LuckyCoin;

	public bool hasLuck_LuckyHorseshoe;

	public bool hasLuck_LuckyClover;

	public bool hasLuck_WiltedClover;

	public bool hasLuck_RavenFeather;

	public bool isPerformingJump_DownDash;

	public int downDashTime;

	public bool hasJumpOption_Cloud;

	public bool canJumpAgain_Cloud;

	public bool isPerformingJump_Cloud;

	public bool hasJumpOption_Sandstorm;

	public bool canJumpAgain_Sandstorm;

	public bool isPerformingJump_Sandstorm;

	public bool hasJumpOption_Blizzard;

	public bool canJumpAgain_Blizzard;

	public bool isPerformingJump_Blizzard;

	public bool hasJumpOption_Fart;

	public bool canJumpAgain_Fart;

	public bool isPerformingJump_Fart;

	public bool hasJumpOption_Sail;

	public bool canJumpAgain_Sail;

	public bool isPerformingJump_Sail;

	public bool hasJumpOption_Unicorn;

	public bool canJumpAgain_Unicorn;

	public bool isPerformingJump_Unicorn;

	public bool hasJumpOption_Santank;

	public bool canJumpAgain_Santank;

	public bool isPerformingJump_Santank;

	public bool hasJumpOption_WallOfFleshGoat;

	public bool canJumpAgain_WallOfFleshGoat;

	public bool isPerformingJump_WallOfFleshGoat;

	public bool hasJumpOption_Basilisk;

	public bool canJumpAgain_Basilisk;

	public bool isPerformingJump_Basilisk;

	public bool isPerformingPogostickTricks;

	public bool autoJump;

	public bool justJumped;

	public float jumpSpeedBoost;

	public int extraFall;

	public bool canFloatInWater;

	public bool hasFloatingTube;

	public bool frogLegJumpBoost;

	public bool skyStoneEffects;

	public bool spawnMax;

	public int blockRange;

	public int[] grappling = new int[20];

	public int grapCount;

	public int rocketTime;

	public int rocketTimeMax = 7;

	public int rocketDelay;

	public int rocketDelay2;

	public int rocketSoundDelay;

	public bool rocketRelease;

	public bool rocketFrame;

	public int rocketBoots;

	public int vanityRocketBoots;

	public bool canRocket;

	public bool jumpBoost;

	public bool noFallDmg;

	public int swimTime;

	public bool killGuide;

	public bool killClothier;

	public float equipmentBasedLuckBonus;

	public float lastEquipmentBasedLuckBonus;

	public bool hasCreditsSceneMusicBox;

	public bool lavaImmune;

	public bool gills;

	public bool slowFall;

	public bool findTreasure;

	public bool biomeSight;

	public bool invis;

	public bool detectCreature;

	public bool nightVision;

	public bool enemySpawns;

	public float thorns;

	public bool turtleArmor;

	public bool turtleThorns;

	public bool cactusThorns;

	public bool spiderArmor;

	public bool anglerSetSpawnReduction;

	public bool vampireBurningInSunlight;

	public bool insideUnbreakableWalls;

	public bool CanSeeInvisibleBlocks;

	public bool setSolar;

	public bool setVortex;

	public bool setNebula;

	public int nebulaCD;

	public bool setStardust;

	public bool setForbidden;

	public bool setForbiddenCooldownLocked;

	public bool setChlorophyte;

	public bool setSquireT3;

	public bool setHuntressT3;

	public bool setApprenticeT3;

	public bool setMonkT3;

	public bool setSquireT2;

	public bool setHuntressT2;

	public bool setApprenticeT2;

	public bool setMonkT2;

	public int maxTurrets = 1;

	public int maxTurretsOld = 1;

	public bool vortexStealthActive;

	public bool waterWalk;

	public bool waterWalk2;

	public int forcedGravity;

	public bool gravControl;

	public bool gravControl2;

	public Item honeyCombItem;

	public int wireOperationsCooldown;

	public int lastChest;

	public TrackedProjectileReference piggyBankProjTracker;

	public TrackedProjectileReference voidLensChest;

	public int chest = -1;

	public int chestX;

	public int chestY;

	public int fallStart;

	public int fallStart2;

	public int potionDelayTime = Item.potionDelay;

	public int restorationDelayTime = Item.restorationDelay;

	public int eggnogDelayTime = Item.eggnogDelay;

	public int mushroomDelayTime = Item.mushroomDelay;

	private bool _batbatCanHeal;

	private bool _spawnTentacleSpikes;

	private bool _spawnBloodButcherer;

	private bool _spawnVolcanoExplosion;

	private bool _spawnMuramasaCut;

	public PlayerPettingInfo petting;

	public PlayerSittingHelper sitting;

	public PlayerSleepingHelper sleeping;

	public PlayerEyeHelper eyeHelper;

	public PlayerInteractionAnchor tileEntityAnchor;

	public DoorOpeningHelper doorHelper;

	public ShoppingSettings currentShoppingSettings = ShoppingSettings.NotInShop;

	public int cHead;

	public int cBody;

	public int cLegs;

	public int cHandOn;

	public int cHandOff;

	public int cBack;

	public int cFront;

	public int cShoe;

	public int cWaist;

	public int cShield;

	public int cNeck;

	public int cFace;

	public int cFaceHead;

	public int cFaceFlower;

	public int cFaceMask;

	public int cBalloon;

	public int cBalloonFront;

	public int cWings;

	public int cCarpet;

	public int cFloatingTube;

	public int cBackpack;

	public int cTail;

	public int cShieldFallback;

	public int cGrapple;

	public int cMount;

	public int cMinecart;

	public int cPet;

	public int cLight;

	public int cYorai;

	public int cPortableStool;

	public int cUnicornHorn;

	public int cAngelHalo;

	public int cBeard;

	public int cMinion;

	public int cLeinShampoo;

	public int cFlameWaker;

	public int cCoat;

	public int[] ownedProjectileCounts = new int[ProjectileID.Count];

	public bool[] npcTypeNoAggro = new bool[NPCID.Count];

	public int lastPortalColorIndex;

	public int _portalPhysicsTime;

	public bool portalPhysicsFlag;

	public int lastTeleportPylonStyleUsed;

	public float MountFishronSpecialCounter;

	public Vector2 MinionRestTargetPoint = Vector2.Zero;

	public int MinionAttackTargetNPC = -1;

	private static MinionRespawner _localMinionRespawner = new MinionRespawner();

	public List<Point> TouchedTiles = new List<Point>();

	public int itemAnimation;

	public int itemAnimationMax;

	public int itemTime;

	public int itemTimeMax;

	public int toolTime;

	public static int BlockInteractionWithProjectiles = 3;

	public const int SafeItemAnimationTimeForPreventingExploits = 20;

	private Point FailedNoSpaceLocation;

	private int FailedNoSpaceCount;

	private HashSet<Point> _blackListedTileCoordsForGrappling = new HashSet<Point>();

	private bool makeStrongBee;

	public bool equippedAnyTileRangeAcc;

	public bool equippedAnyTileSpeedAcc;

	public bool equippedAnyWallSpeedAcc;

	private static List<NPC> _hallucinationCandidates = new List<NPC>();

	public bool behindBackWall;

	public int _funkytownAchievementCheckCooldown;

	public const int ChairSittingMaxDistance = 40;

	private static SmartInteractSystem _smartInteractSys = new SmartInteractSystem();

	private int _lastSmartCursorToolStrategy = -1;

	private bool[] nearbyTorch = new bool[TorchID.Count];

	private bool dryCoralTorch;

	private int luckyTorchCounter;

	private int nearbyTorches;

	public float torchLuck;

	private Vector2 _nextTorchLuckCheckCenter;

	public bool happyFunTorchTime;

	private int torchFunTimer;

	private int torchGodCooldown;

	private int numberOfTorchAttacksMade;

	private static int maxTorchAttacks = 200;

	private int[] unlitTorchX = new int[maxTorchAttacks];

	private int[] unlitTorchY = new int[maxTorchAttacks];

	private static int[] _torchAttackPosX = new int[400];

	private static int[] _torchAttackPosY = new int[400];

	public int ladyBugLuckTimeLeft;

	public float luck;

	public float luckMinimumCap = -0.7f;

	public float luckMaximumCap = 1f;

	public float coinLuck;

	public byte kiteLuckLevel;

	public bool luckNeedsSync;

	public int disableVoidBag = -1;

	private int _quickGrappleCooldown;

	public PlayerMovementAccsCache movementAbilitiesCache;

	private const int SunScorchGraceTime = 120;

	private static readonly int UnbreakableWallRescanPeriod = 20;

	private static readonly int UnbreakableWallRescanDistance = 256;

	private int _unbreakableWallScanCooldown;

	private Vector2 _unbreakableWallScanLastPosition;

	private SlotId _sizzleAudioHandle;

	public float wingAccRunSpeed = -1f;

	public float wingRunAccelerationMult = 1f;

	public const int SHIELD_PARRY_DURATION = 20;

	public const int SHIELD_PARRY_DURATION_DRAWING_TWEAKER = 20;

	public const int SHIELD_PARRY_DAMAGE_BUFF_MULTIPLIER = 5;

	public bool hasRaisableShield;

	public bool shieldRaised;

	public int shieldParryTimeLeft;

	public int shield_parry_cooldown;

	private bool _forceForwardCursor;

	private Point _inputMouseCoordsForward;

	private Point _mainMouseCoordsForward;

	private bool _forceSmartSelectCursor;

	private Point _inputMouseCoordsSmartSelect;

	private Point _mainMouseCoordsSmartSelect;

	private Point _tileTargetSmartSelect;

	private bool botherWithUnaimedMinecartTracks = true;

	private List<int> _projectilesToInteractWith = new List<int>();

	private int _lockTileInteractionsTimer;

	private bool extractinateHover;

	public int hoveredChestIndex = -1;

	public int[] hurtCooldowns = new int[ImmunityCooldownID.Count];

	public static PlayerGetItemLogger GetItemLogger = new PlayerGetItemLogger();

	public static int FlexibleWandRandomSeed;

	public static int FlexibleWandCycleOffset;

	public static Point FlexibleWandLastPosition;

	private ushort cannonCooldown;

	public static bool lastPound = true;

	public int framesInMovementForPlacementPreview;

	private static Point[] _tentacleSpikesMax5 = new Point[5];

	private static Point[] _bloodButchererMax5 = new Point[5];

	public int[] meleeNPCHitCooldown = new int[Main.maxNPCs];

	public static int musicNotes = 6;

	public float musicDist;

	private static List<Projectile> _oldestProjCheckList = new List<Projectile>();

	private int killingCardFireType;

	public EquipmentLoadout[] Loadouts = new EquipmentLoadout[3]
	{
		new EquipmentLoadout(),
		new EquipmentLoadout(),
		new EquipmentLoadout()
	};

	public int CurrentLoadoutIndex;

	public HashSet<string> oneTimeDialoguesSeen = new HashSet<string>();

	public SavedPlayerDataWithAnnoyingRules savedPerPlayerFieldsThatArentInThePlayerClass;

	private const int SaveSlotIndex_MouseItem = 0;

	private const int SaveSlotIndex_CreativeSacrifice = 1;

	private const int SaveSlotIndex_GuideItem = 2;

	private const int SaveSlotIndex_TinkererItem = 3;

	private const int SaveSlotIndexCount = 4;

	private Item[] _temporaryItemSlots = new Item[4];

	private Item[] _pendingRefunds = new Item[0];

	private static readonly PlayerFileData _visualCloneDummyData = new PlayerFileData();

	private static readonly MemoryStream _visualCloneStream = new MemoryStream();

	private static readonly BinaryWriter _visualCloneWriter = new BinaryWriter(_visualCloneStream);

	private static readonly BinaryReader _visualCloneReader = new BinaryReader(_visualCloneStream);

	public Vector2 BlehOldPositionFixer => -Vector2.UnitY;

	public float HeightOffsetVisual
	{
		get
		{
			if (mount.Active)
			{
				return mount.PlayerOffset;
			}
			if (portableStoolInfo.IsInUse)
			{
				return portableStoolInfo.VisualYOffset;
			}
			return 0f;
		}
	}

	public float HeightOffsetHitboxCenter
	{
		get
		{
			if (mount.Active)
			{
				return mount.PlayerOffsetHitbox;
			}
			if (portableStoolInfo.IsInUse)
			{
				return portableStoolInfo.HeightBoost - portableStoolInfo.VisualYOffset;
			}
			return 0f;
		}
	}

	public float MountXOffset
	{
		get
		{
			if (mount.Active)
			{
				return mount.PlayerXOFfset;
			}
			return 0f;
		}
	}

	public int HeightOffsetBoost
	{
		get
		{
			if (mount.Active)
			{
				return mount.HeightBoost;
			}
			if (portableStoolInfo.IsInUse)
			{
				return portableStoolInfo.HeightBoost;
			}
			return 0;
		}
	}

	public int HeightMapOffset
	{
		get
		{
			if (mount.Active)
			{
				return mount.PlayerHeadOffset;
			}
			if (portableStoolInfo.IsInUse)
			{
				return portableStoolInfo.HeightBoost;
			}
			return 0;
		}
	}

	public Rectangle HitboxForBestiaryNearbyCheck
	{
		get
		{
			Rectangle result = new Rectangle((int)position.X, (int)position.Y, width, height);
			result.Inflate(300, 200);
			return result;
		}
	}

	public bool IsConsideredStandingStill
	{
		get
		{
			if ((double)Math.Abs(velocity.X) < 0.05)
			{
				return (double)Math.Abs(velocity.Y) < 0.05;
			}
			return false;
		}
	}

	public float BaseHeight => height - HeightOffsetBoost;

	public Vector2 MountedCenter
	{
		get
		{
			return new Vector2(position.X + (float)(width / 2), position.Y + BaseHeight / 2f + HeightOffsetHitboxCenter);
		}
		set
		{
			position = new Vector2(value.X - (float)(width / 2), value.Y - BaseHeight / 2f - HeightOffsetHitboxCenter);
		}
	}

	public Vector2 MountedTop
	{
		get
		{
			float x = position.X + (float)(width / 2);
			float y = position.Y + HeightOffsetHitboxCenter;
			if (gravDir == -1f)
			{
				y = base.Bottom.Y - HeightOffsetHitboxCenter;
			}
			return new Vector2(x, y);
		}
		set
		{
			float x = value.X - (float)(width / 2);
			float y = value.Y - HeightOffsetHitboxCenter;
			if (gravDir == -1f)
			{
				y = value.Y - (float)height + HeightOffsetHitboxCenter;
			}
			position = new Vector2(x, y);
		}
	}

	public bool TileReplacementEnabled => builderAccStatus[10] == 0;

	public override Vector2 VisualPosition => position + new Vector2(0f, gfxOffY);

	public bool CCed
	{
		get
		{
			if (!frozen && !webbed)
			{
				return stoned;
			}
			return true;
		}
	}

	public float miscCounterNormalized => (float)miscCounter / 300f;

	public bool Male
	{
		get
		{
			return PlayerVariantID.Sets.Male[skinVariant];
		}
		set
		{
			if (value)
			{
				if (!Male)
				{
					skinVariant = PlayerVariantID.Sets.AltGenderReference[skinVariant];
				}
			}
			else if (Male)
			{
				skinVariant = PlayerVariantID.Sets.AltGenderReference[skinVariant];
			}
		}
	}

	public bool ZoneDungeon
	{
		get
		{
			return zone1[0];
		}
		set
		{
			zone1[0] = value;
		}
	}

	public bool ZoneCorrupt
	{
		get
		{
			return zone1[1];
		}
		set
		{
			zone1[1] = value;
		}
	}

	public bool ZoneHallow
	{
		get
		{
			return zone1[2];
		}
		set
		{
			zone1[2] = value;
		}
	}

	public bool ZoneMeteor
	{
		get
		{
			return zone1[3];
		}
		set
		{
			zone1[3] = value;
		}
	}

	public bool ZoneJungle
	{
		get
		{
			return zone1[4];
		}
		set
		{
			zone1[4] = value;
		}
	}

	public bool ZoneSnow
	{
		get
		{
			return zone1[5];
		}
		set
		{
			zone1[5] = value;
		}
	}

	public bool ZoneCrimson
	{
		get
		{
			return zone1[6];
		}
		set
		{
			zone1[6] = value;
		}
	}

	public bool ZoneWaterCandle
	{
		get
		{
			return zone1[7];
		}
		set
		{
			zone1[7] = value;
		}
	}

	public bool ZonePeaceCandle
	{
		get
		{
			return zone2[0];
		}
		set
		{
			zone2[0] = value;
		}
	}

	public bool ZoneTowerSolar
	{
		get
		{
			return zone2[1];
		}
		set
		{
			zone2[1] = value;
		}
	}

	public bool ZoneTowerVortex
	{
		get
		{
			return zone2[2];
		}
		set
		{
			zone2[2] = value;
		}
	}

	public bool ZoneTowerNebula
	{
		get
		{
			return zone2[3];
		}
		set
		{
			zone2[3] = value;
		}
	}

	public bool ZoneTowerStardust
	{
		get
		{
			return zone2[4];
		}
		set
		{
			zone2[4] = value;
		}
	}

	public bool ZoneDesert
	{
		get
		{
			return zone2[5];
		}
		set
		{
			zone2[5] = value;
		}
	}

	public bool ZoneGlowshroom
	{
		get
		{
			return zone2[6];
		}
		set
		{
			zone2[6] = value;
		}
	}

	public bool ZoneUndergroundDesert
	{
		get
		{
			return zone2[7];
		}
		set
		{
			zone2[7] = value;
		}
	}

	public bool ZoneSkyHeight
	{
		get
		{
			return zone3[0];
		}
		set
		{
			zone3[0] = value;
		}
	}

	public bool ZoneOverworldHeight
	{
		get
		{
			return zone3[1];
		}
		set
		{
			zone3[1] = value;
		}
	}

	public bool ZoneDirtLayerHeight
	{
		get
		{
			return zone3[2];
		}
		set
		{
			zone3[2] = value;
		}
	}

	public bool ZoneRockLayerHeight
	{
		get
		{
			return zone3[3];
		}
		set
		{
			zone3[3] = value;
		}
	}

	public bool ZoneUnderworldHeight
	{
		get
		{
			return zone3[4];
		}
		set
		{
			zone3[4] = value;
		}
	}

	public bool ZoneBeach
	{
		get
		{
			return zone3[5];
		}
		set
		{
			zone3[5] = value;
		}
	}

	public bool ZoneRain
	{
		get
		{
			return zone3[6];
		}
		set
		{
			zone3[6] = value;
		}
	}

	public bool ZoneSandstorm
	{
		get
		{
			return zone3[7];
		}
		set
		{
			zone3[7] = value;
		}
	}

	public bool ZoneOldOneArmy
	{
		get
		{
			return zone4[0];
		}
		set
		{
			zone4[0] = value;
		}
	}

	public bool ZoneGranite
	{
		get
		{
			return zone4[1];
		}
		set
		{
			zone4[1] = value;
		}
	}

	public bool ZoneMarble
	{
		get
		{
			return zone4[2];
		}
		set
		{
			zone4[2] = value;
		}
	}

	public bool ZoneHive
	{
		get
		{
			return zone4[3];
		}
		set
		{
			zone4[3] = value;
		}
	}

	public bool ZoneGemCave
	{
		get
		{
			return zone4[4];
		}
		set
		{
			zone4[4] = value;
		}
	}

	public bool ZoneLihzhardTemple
	{
		get
		{
			return zone4[5];
		}
		set
		{
			zone4[5] = value;
		}
	}

	public bool ZoneGraveyard
	{
		get
		{
			return zone4[6];
		}
		set
		{
			zone4[6] = value;
		}
	}

	public bool ZoneShadowCandle
	{
		get
		{
			return zone4[7];
		}
		set
		{
			zone4[7] = value;
		}
	}

	public bool ZoneShimmer
	{
		get
		{
			return zone5[0];
		}
		set
		{
			zone5[0] = value;
		}
	}

	public bool ShoppingZone_AnyBiome
	{
		get
		{
			if (!ZoneDungeon && !ZoneCorrupt && !ZoneCrimson && !ZoneGlowshroom && !ZoneHallow && !ZoneJungle && !ZoneSnow && !ZoneBeach)
			{
				return ZoneDesert;
			}
			return true;
		}
	}

	public bool ShoppingZone_BelowSurface => (double)position.Y > Main.worldSurface * 16.0;

	public bool ShoppingZone_Forest
	{
		get
		{
			if (ShoppingZone_AnyBiome || ShoppingZone_BelowSurface)
			{
				return false;
			}
			return true;
		}
	}

	public Vector2 Directions => new Vector2(direction, gravDir);

	public int selectedItem => selectedItemState.Selected;

	public Item HeldItem => inventory[selectedItem];

	public int breathCDMax
	{
		get
		{
			int num = 7;
			if (hasBreathingReed && itemAnimation == 0)
			{
				num *= 2;
			}
			if (accDivingHelm)
			{
				num *= 6;
			}
			return num;
		}
	}

	public bool ShouldFloatInWater
	{
		get
		{
			if (canFloatInWater && !controlDown)
			{
				if (mount.Active)
				{
					return mount.Type == 37;
				}
				return true;
			}
			return false;
		}
	}

	public bool CanBeTalkedTo
	{
		get
		{
			if (active && !dead && !ShouldNotDraw)
			{
				return stealth == 1f;
			}
			return false;
		}
	}

	public bool IsVoidVaultEnabled
	{
		get
		{
			return voidVaultInfo[0];
		}
		set
		{
			voidVaultInfo[0] = value;
		}
	}

	public Vector2 ReportedCameraPosition
	{
		get
		{
			if (!netCameraTarget.HasValue)
			{
				return position;
			}
			return netCameraTarget.Value;
		}
	}

	public bool TryingToHoverUp
	{
		get
		{
			if (!controlUp)
			{
				return tryKeepingHoveringUp;
			}
			return true;
		}
	}

	public bool TryingToHoverDown
	{
		get
		{
			if (!controlDown)
			{
				return tryKeepingHoveringDown;
			}
			return true;
		}
	}

	public Vector2 DefaultSize => new Vector2(20f, 42f);

	public bool UsingBiomeTorches
	{
		get
		{
			if (!unlockedBiomeTorches)
			{
				return false;
			}
			return builderAccStatus[11] == 0;
		}
		set
		{
			builderAccStatus[11] = ((!value) ? 1 : 0);
		}
	}

	public bool UsingSuperCart
	{
		get
		{
			if (!unlockedSuperCart)
			{
				return false;
			}
			return enabledSuperCart;
		}
		set
		{
			enabledSuperCart = value;
		}
	}

	public float bowEffectiveDamage => (rangedDamage / rangedMultDamage + arrowDamageAdditiveStack) * rangedMultDamage * arrowDamage;

	public float gunEffectiveDamage => rangedDamage * bulletDamage;

	public float specialistEffectiveDamage => rangedDamage * rocketDamage;

	public bool CanUseBootFlyingAbilities => !isPerformingJump_DownDash;

	public bool CanUseWingAbilities
	{
		get
		{
			if (!merman)
			{
				return !isPerformingJump_DownDash;
			}
			return false;
		}
	}

	public bool ShouldNotDraw
	{
		get
		{
			if (invis && whoAmI != Main.myPlayer && itemAnimation == 0)
			{
				if (!isDisplayDollOrInanimate)
				{
					return !isHatRackDoll;
				}
				return false;
			}
			return false;
		}
	}

	public int talkNPC { get; private set; }

	public bool isLockedToATile
	{
		get
		{
			if (!sitting.isSitting)
			{
				return sleeping.isSleeping;
			}
			return true;
		}
	}

	public bool PortalPhysicsEnabled
	{
		get
		{
			if (_portalPhysicsTime > 0)
			{
				return !mount.Active;
			}
			return false;
		}
	}

	public bool MountFishronSpecial
	{
		get
		{
			if (statLife >= statLifeMax2 / 2 && (!wet || lavaWet || honeyWet) && !dripping && !(MountFishronSpecialCounter > 0f))
			{
				if (Main.raining)
				{
					return WorldGen.InAPlaceWithWind(position, width, height);
				}
				return false;
			}
			return true;
		}
	}

	public bool HasMinionRestTarget => MinionRestTargetPoint != Vector2.Zero;

	public bool HasMinionAttackTargetNPC => MinionAttackTargetNPC != -1;

	public bool ItemTimeIsZero => itemTime == 0;

	public bool ItemAnimationJustStarted => itemAnimation == itemAnimationMax - 1;

	public bool UsingOrReusingItem
	{
		get
		{
			if (itemAnimation <= 0 && reuseDelay <= 0 && !channel)
			{
				return pendingItemReuse;
			}
			return true;
		}
	}

	public static SceneMetrics SceneMetrics => Main.PlayerSceneMetrics;

	public Vector2 SpectatingCameraPosition
	{
		get
		{
			if (spectating < 0)
			{
				return position;
			}
			Player player = Main.player[spectating];
			return player.Bottom + new Vector2(0f, player.gfxOffY - 21f) + player.netOffset;
		}
	}

	public bool CanDeathSpectate
	{
		get
		{
			if (dead && !ghost)
			{
				return deadTime >= DeadSpectatingLockoutTime;
			}
			return false;
		}
	}

	public float NormalizedLuck
	{
		get
		{
			float value = 0f;
			if (luck > 0f)
			{
				value = luck / luckMaximumCap;
			}
			else if (luck < 0f)
			{
				value = 0f - luck / luckMinimumCap;
			}
			return MathHelper.Clamp(value, -1f, 1f);
		}
	}

	public bool SlimeDontHyperJump
	{
		get
		{
			if (mount.Active && mount.IsConsideredASlimeMount && wetSlime > 0)
			{
				return !controlJump;
			}
			return false;
		}
	}

	private bool hasBreathingReed
	{
		get
		{
			if (inventory[selectedItem].type == 186)
			{
				if (mount.Active)
				{
					return !MountID.Sets.DontHoldItems[mount.Type];
				}
				return true;
			}
			return false;
		}
	}

	public bool IsRidingTracks
	{
		get
		{
			if (!mount.Active)
			{
				return false;
			}
			if (mount.Cart)
			{
				return true;
			}
			if (mount.CanGrindRails && onTrack)
			{
				return true;
			}
			return false;
		}
	}

	public Vector2? MouthPosition
	{
		get
		{
			if (mount.Active)
			{
				Mount.MountDelegatesData.OverridePositionMethod mouthPosition = mount.Delegations.MouthPosition;
				if (mouthPosition != null && mouthPosition(this, out var result))
				{
					return result;
				}
			}
			Vector2 spinningpoint = new Vector2(direction * 8, gravDir * -4f);
			return RotatedRelativePoint(MountedCenter, reverseRotation: false, addGfxOffY: false) + spinningpoint.RotatedBy(fullRotation);
		}
	}

	public Vector2? HandPosition
	{
		get
		{
			if (mount.Active)
			{
				Mount.MountDelegatesData.OverridePositionMethod handPosition = mount.Delegations.HandPosition;
				if (handPosition != null && handPosition(this, out var result))
				{
					return result;
				}
			}
			Vector2 vector = Main.OffsetsPlayerOnhand[bodyFrame.Y / 56] * 2f;
			if (direction != 1)
			{
				vector.X = (float)bodyFrame.Width - vector.X;
			}
			if (gravDir != 1f)
			{
				vector.Y = (float)bodyFrame.Height - vector.Y;
			}
			vector -= new Vector2(bodyFrame.Width - width, bodyFrame.Height - 42) / 2f;
			Vector2 vector2 = -new Vector2(20f, 42f) / 2f + vector;
			Vector2 pos = MountedCenter + vector2;
			ApplyItemPositionOffsetFromMount(ref pos);
			return RotatedRelativePoint(pos);
		}
	}

	public void RotateRelativePoint(ref float x, ref float y)
	{
		Vector2 vector = RotatedRelativePoint(new Vector2(x, y));
		x = vector.X;
		y = vector.Y;
	}

	public Vector2 RotatedRelativePoint(Vector2 pos, bool reverseRotation = false, bool addGfxOffY = true)
	{
		float num = (reverseRotation ? (0f - fullRotation) : fullRotation);
		if (sleeping.isSleeping)
		{
			num = 0f;
		}
		Vector2 vector = base.Bottom + new Vector2(0f, gfxOffY);
		int num2 = mount.PlayerOffset / 2 + 4;
		Vector2 vector2 = new Vector2(0f, -num2) + new Vector2(0f, num2).RotatedBy(num);
		if (addGfxOffY)
		{
			pos.Y += gfxOffY;
		}
		pos = vector + (pos - vector).RotatedBy(num) + vector2;
		if (sleeping.isSleeping)
		{
			sleeping.GetSleepingOffsetInfo(this, out var posOffset);
			pos += posOffset;
		}
		if (sitting.isSitting)
		{
			sitting.GetSittingOffsetInfo(this, out var posOffset2, out var seatAdjustment);
			pos += posOffset2 + new Vector2(0f, seatAdjustment);
		}
		return pos;
	}

	public bool CanDemonHeartAccessoryBeShown()
	{
		if (!IsItemSlotUnlockedAndUsable(8) && armor[8].type <= 0 && armor[18].type <= 0)
		{
			return dye[8].type > 0;
		}
		return true;
	}

	public bool CanMasterModeAccessoryBeShown()
	{
		if (!IsItemSlotUnlockedAndUsable(9) && armor[9].type <= 0 && armor[19].type <= 0)
		{
			return dye[9].type > 0;
		}
		return true;
	}

	public int GetAmountOfExtraAccessorySlotsToShow()
	{
		int num = 0;
		if (CanDemonHeartAccessoryBeShown())
		{
			num++;
		}
		if (CanMasterModeAccessoryBeShown())
		{
			num++;
		}
		return num;
	}

	public EntityShadowInfo GetAdvancedShadow(int shadowIndex)
	{
		if (shadowIndex > availableAdvancedShadowsCount)
		{
			shadowIndex = availableAdvancedShadowsCount;
		}
		int num = (_lastAddedAvancedShadow - shadowIndex).ModulusPositive(60);
		return _advancedShadows[num];
	}

	public void UpdateAdvancedShadows()
	{
		availableAdvancedShadowsCount++;
		if (availableAdvancedShadowsCount > 60)
		{
			availableAdvancedShadowsCount = 60;
		}
		if (++_lastAddedAvancedShadow >= 60)
		{
			_lastAddedAvancedShadow = 0;
		}
		_advancedShadows[_lastAddedAvancedShadow].CopyPlayer(this);
	}

	public void ResetAdvancedShadows()
	{
		availableAdvancedShadowsCount = 0;
	}

	public void SetCompositeArmFront(bool enabled, CompositeArmStretchAmount stretch, float rotation)
	{
		if (gravDir == -1f)
		{
			rotation = 0f - rotation;
		}
		compositeFrontArm = new CompositeArmData(enabled, stretch, rotation);
	}

	public void SetCompositeArmBack(bool enabled, CompositeArmStretchAmount stretch, float rotation)
	{
		if (gravDir == -1f)
		{
			rotation = 0f - rotation;
		}
		compositeBackArm = new CompositeArmData(enabled, stretch, rotation);
	}

	public int GetArmorPenetration(bool melee)
	{
		int num = armorPenetration;
		if (melee)
		{
			num += meleeArmorPenetration;
		}
		return num;
	}

	public void SetTalkNPC(int npcIndex)
	{
		talkNPC = npcIndex;
		if (Main.netMode != 1 && npcIndex >= 0 && npcIndex < Main.maxNPCs)
		{
			Main.BestiaryTracker.Chats.RegisterChatStartWith(Main.npc[npcIndex]);
		}
		if (talkNPC == -1)
		{
			currentShoppingSettings = ShoppingSettings.NotInShop;
		}
		else
		{
			currentShoppingSettings = Main.ShopHelper.GetShoppingSettings(this, Main.npc[talkNPC]);
		}
		if (currentShoppingSettings.PriceAdjustment <= 0.82f)
		{
			AchievementsHelper.HandleSpecialEvent(this, 20);
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.npcChatPortrait = null;
			if (npcIndex >= 0 && npcIndex < Main.maxNPCs && NPCID.Sets.NPCPortraits.TryGetValue(Main.npc[npcIndex].type, out var value))
			{
				Main.npcChatPortrait = value;
				Main.DoNPCPortraitHop();
			}
		}
	}

	public void SetItemTime(int frames)
	{
		itemTime = frames;
		itemTimeMax = frames;
	}

	public void ApplyItemTime(Item sItem)
	{
		SetItemTime(sItem.useTime);
	}

	public void ApplyItemTime(Item sItem, float multiplier)
	{
		SetItemTime((int)((float)sItem.useTime * multiplier));
	}

	public void SetDummyItemTime(int frames)
	{
		itemAnimation = frames;
		itemTime = frames;
		itemTimeMax = frames + 1;
	}

	private void SetItemAnimation(int frames)
	{
		itemAnimation = frames;
		itemAnimationMax = frames;
	}

	private void ApplyItemAnimation(Item sItem)
	{
		int num = 0;
		if (sItem.autoReuse && sItem.reuseDelay == 0 && sItem.useTime <= sItem.useAnimation && sItem.shoot > 0 && sItem.useStyle == 5)
		{
			num = 1;
		}
		if (sItem.melee && !ItemID.Sets.NoMeleeSpeedBonus[sItem.type])
		{
			SetItemAnimation((int)((float)sItem.useAnimation * meleeSpeed));
		}
		else if (sItem.summon && ItemID.Sets.SummonerWeaponThatScalesWithAttackSpeed[sItem.type])
		{
			SetItemAnimation((int)((float)sItem.useAnimation * summonerWeaponSpeedBonus * whipUseTimeMultiplier));
		}
		else if (sItem.createTile >= 0)
		{
			SetItemAnimation((int)((float)sItem.useAnimation * tileSpeed));
		}
		else if (sItem.createWall >= 0)
		{
			SetItemAnimation((int)((float)sItem.useAnimation * wallSpeed));
		}
		else
		{
			SetItemAnimation(sItem.useAnimation + num);
		}
		reuseDelay = sItem.reuseDelay;
	}

	public void MatchItemTimeToItemAnimation()
	{
		itemTime = itemAnimation;
	}

	public bool InOpposingTeam(Player otherPlayer)
	{
		if (hostile && otherPlayer.hostile)
		{
			if (otherPlayer.team != 0)
			{
				return otherPlayer.team != team;
			}
			return true;
		}
		return false;
	}

	public bool TeamChangeAllowed()
	{
		return true;
	}

	public void HealEffect(int healAmount, bool broadcast = true)
	{
		CombatText.NewText(new Rectangle((int)position.X, (int)position.Y, width, height), CombatText.HealLife, healAmount);
		if (broadcast && Main.netMode == 1 && whoAmI == Main.myPlayer)
		{
			NetMessage.SendData(35, -1, -1, null, whoAmI, healAmount);
		}
	}

	public void ManaEffect(int manaAmount)
	{
		CombatText.NewText(new Rectangle((int)position.X, (int)position.Y, width, height), CombatText.HealMana, manaAmount);
		if (Main.netMode == 1 && whoAmI == Main.myPlayer)
		{
			NetMessage.SendData(43, -1, -1, null, whoAmI, manaAmount);
		}
	}

	public void InterruptItemUsageIfOverTile(int tileTypeToBeOver)
	{
		Tile tile = Main.tile[tileTargetX, tileTargetY];
		if (tile != null && tile.active() && tile.type == tileTypeToBeOver)
		{
			Main.blockMouse = true;
		}
	}

	public Vector2 GetHairDrawOffset(int hairID, bool hatHair)
	{
		Vector2 zero = Vector2.Zero;
		if (!hatHair && hairID == 163)
		{
			return new Vector2(0f, -2f) * Directions;
		}
		if (hairID == 164)
		{
			return new Vector2(-2f, 0f) * Directions;
		}
		return zero;
	}

	public Vector2 GetFaceDrawOffset(int faceToCheck)
	{
		Vector2 zero = Vector2.Zero;
		switch (faceToCheck)
		{
		case 19:
			zero += new Vector2(0f, -6f) * Directions;
			break;
		case 22:
			if (head == 283)
			{
				zero += new Vector2(2f, 0f) * Directions;
			}
			break;
		}
		return zero;
	}

	public Vector2 GetHelmetDrawOffset(bool minimap = false)
	{
		Vector2 result = Vector2.Zero;
		if (head == 270)
		{
			result = new Vector2(-10f, 0f) * Directions;
			if (direction == -1)
			{
				result.X -= 2f;
			}
		}
		else if (head == 268)
		{
			result = new Vector2(0f, -6f) * Directions;
		}
		else if (head == 222)
		{
			float y = 0f;
			if (hair == 15 || hair == 76 || hair == 108)
			{
				y = 4f;
			}
			result = new Vector2(0f, y) * Directions;
		}
		else if (head == 272)
		{
			if (hair == 15 || hair == 76 || hair == 108)
			{
				result = new Vector2(0f, 4f) * Directions;
			}
		}
		else if (head == 275)
		{
			result = new Vector2(0f, -4f) * Directions;
		}
		result += GetHelmetOffsetAddonFromFaceHead();
		if (!minimap)
		{
			result += GetHelmetOffsetAddonFromMount();
		}
		return result;
	}

	public Vector2 GetHelmetOffsetAddonFromFaceHead()
	{
		Vector2 zero = Vector2.Zero;
		if (faceHead == 12 || faceHead == 13 || faceHead == 10 || faceHead == 11 || faceHead == 17 || faceHead == 18 || faceHead == 15 || faceHead == 16)
		{
			switch (head)
			{
			case 16:
			case 21:
			case 24:
			case 65:
			case 67:
			case 94:
			case 95:
			case 96:
			case 159:
			case 222:
			case 231:
			case 250:
				zero += new Vector2(2f, 0f) * Directions;
				break;
			case 59:
			case 64:
			case 106:
			case 138:
			case 181:
			case 220:
				zero += new Vector2(0f, -2f) * Directions;
				break;
			case 26:
			case 51:
			case 60:
			case 81:
			case 289:
				zero += new Vector2(2f, -2f) * Directions;
				break;
			case 97:
				zero += new Vector2(-2f, 0f) * Directions;
				break;
			case 117:
				zero += new Vector2(-4f, 0f) * Directions;
				break;
			}
		}
		return zero;
	}

	public Vector2 GetHelmetOffsetAddonFromMount()
	{
		Vector2 zero = Vector2.Zero;
		if (!mount.Active)
		{
			return zero;
		}
		if (mount.Type == 54)
		{
			switch (head)
			{
			case 13:
			case 15:
			case 16:
			case 59:
			case 60:
			case 63:
			case 64:
			case 81:
			case 126:
			case 231:
			case 279:
				zero += new Vector2(0f, -2f) * Directions;
				break;
			case 2:
			case 5:
			case 10:
			case 12:
			case 25:
			case 84:
			case 85:
			case 116:
			case 117:
			case 138:
			case 141:
			case 143:
			case 160:
			case 178:
			case 183:
			case 191:
			case 194:
			case 197:
			case 217:
			case 218:
			case 233:
			case 245:
			case 265:
			case 274:
			case 277:
				zero += new Vector2(-2f, 0f) * Directions;
				break;
			case 163:
			case 228:
			case 229:
			case 235:
				zero += new Vector2(-2f, 2f) * Directions;
				break;
			case 222:
			case 242:
			case 243:
			case 244:
				zero += new Vector2(0f, 2f) * Directions;
				break;
			case 73:
			case 91:
			case 227:
			case 280:
				zero += new Vector2(-2f, -2f) * Directions;
				break;
			case 195:
				zero += new Vector2(-4f, -2f) * Directions;
				break;
			case 241:
				zero += new Vector2(-4f, -14f) * Directions;
				break;
			case 272:
				zero += new Vector2(-4f, 4f) * Directions;
				break;
			case 203:
				zero += new Vector2(0f, -4f) * Directions;
				break;
			case 267:
				zero += new Vector2(-2f, -4f) * Directions;
				break;
			}
		}
		return zero;
	}

	public Vector2 GetBeardDrawOffset(bool minimap = false)
	{
		Vector2 zero = Vector2.Zero;
		zero = GetBeardOffsetAddonFromHelmet(zero);
		if (!minimap)
		{
			zero = GetBeardOffsetAddonFromMount(zero);
		}
		return zero;
	}

	public Vector2 GetBeardOffsetAddonFromHelmet(Vector2 beardOffset)
	{
		switch (head)
		{
		case 165:
			beardOffset += new Vector2(8f, 0f) * Directions;
			break;
		case 146:
		case 150:
		case 152:
			beardOffset += new Vector2(2f, 0f) * Directions;
			break;
		case 148:
			beardOffset += new Vector2(2f, 0f) * Directions;
			break;
		}
		return beardOffset;
	}

	public Vector2 GetBeardOffsetAddonFromMount(Vector2 beardOffset)
	{
		if (!mount.Active)
		{
			return beardOffset;
		}
		if (mount.Type == 54)
		{
			sbyte b = beard;
			if ((uint)(b - 1) <= 3u)
			{
				beardOffset += new Vector2(8f, 4f) * Directions;
				if (mount.Frame == 6)
				{
					beardOffset += new Vector2(0f, 2f) * Directions;
				}
				else if (mount.Frame == 7)
				{
					beardOffset += new Vector2(-2f, 4f) * Directions;
				}
			}
		}
		return beardOffset;
	}

	public Vector2 GetFaceHeadOffsetFromHelmet()
	{
		Vector2 vector = Vector2.Zero;
		if (faceHead == 12 || faceHead == 13 || faceHead == 10 || faceHead == 11 || faceHead == 17 || faceHead == 18 || faceHead == 15 || faceHead == 16)
		{
			switch (head)
			{
			case 20:
			case 221:
				vector = new Vector2(0f, -2f);
				break;
			case 196:
				vector = new Vector2(2f, 0f);
				break;
			}
		}
		return vector * Directions;
	}

	public Vector2 GetFrontDrawOffset()
	{
		Vector2 result = Vector2.Zero;
		sbyte b = front;
		if (b == 13)
		{
			result = new Vector2(-2f, 0f) * Directions;
		}
		return result;
	}

	public Vector2 GetLegsDrawOffset()
	{
		Vector2 result = Vector2.Zero;
		if (legs == 226)
		{
			result = new Vector2(-6f, 0f) * Directions;
		}
		return result;
	}

	public Vector2 GetShoeDrawOffset()
	{
		Vector2 result = Vector2.Zero;
		if (shoe == 27 || shoe == 28 || shoe == 29 || shoe == 30)
		{
			result = new Vector2(0f, 2f) * Directions;
		}
		return result;
	}

	public void AccumulateGolfingScore(int score)
	{
		int num = score;
		if (golferScoreAccumulated + num > 1000000000)
		{
			num = 1000000000 - golferScoreAccumulated;
		}
		golferScoreAccumulated += num;
	}

	public static byte FindClosest(Vector2 Position, int Width, int Height)
	{
		byte result = 0;
		for (int i = 0; i < 255; i++)
		{
			if (Main.player[i].active)
			{
				result = (byte)i;
				break;
			}
		}
		float num = -1f;
		for (int j = 0; j < 255; j++)
		{
			if (Main.player[j].active && !Main.player[j].dead)
			{
				float num2 = Math.Abs(Main.player[j].position.X + (float)(Main.player[j].width / 2) - (Position.X + (float)(Width / 2))) + Math.Abs(Main.player[j].position.Y + (float)(Main.player[j].height / 2) - (Position.Y + (float)(Height / 2)));
				if (num == -1f || num2 < num)
				{
					num = num2;
					result = (byte)j;
				}
			}
		}
		return result;
	}

	public void ToggleInv()
	{
		bool grappleAndInteractAreShared = PlayerInput.GrappleAndInteractAreShared;
		if (Main.mapFullscreen)
		{
			Main.mapFullscreen = false;
			releaseInventory = false;
			SoundEngine.PlaySound(11);
			if (PlayerInput.GrappleAndInteractAreShared)
			{
				LockGamepadTileInteractions();
			}
		}
		else if (PlayerInput.InBuildingMode)
		{
			PlayerInput.ExitBuildingMode();
		}
		else if (Main.ingameOptionsWindow)
		{
			if (PlayerInput.UsingGamepadUI && UILinkPointNavigator.CurrentPage == 1002)
			{
				UILinkPointNavigator.ChangePage(1001);
			}
			else
			{
				IngameOptions.Close();
			}
		}
		else if (Main.inFancyUI)
		{
			IngameFancyUI.Close();
		}
		else if (CaptureManager.Instance.Active)
		{
			CaptureManager.Instance.Active = false;
		}
		else if (talkNPC >= 0)
		{
			SetTalkNPC(-1);
			Main.npcChatCornerItem = 0;
			Main.npcChatText = "";
			SoundEngine.PlaySound(11);
			if (PlayerInput.UsingGamepad)
			{
				Main.npcChatRelease = false;
			}
			Main.playerInventory = false;
		}
		else if (sign >= 0)
		{
			CloseSign();
		}
		else if (Main.clothesWindow)
		{
			Main.CancelClothesWindow();
		}
		else if (NewCraftingUI.Visible)
		{
			NewCraftingUI.Close();
		}
		else if (!Main.playerInventory)
		{
			OpenInventory();
		}
		else
		{
			Main.playerInventory = false;
			if (channel && Main.mouseItem != null && !Main.mouseItem.IsAir)
			{
				channel = false;
			}
			tileEntityAnchor.Clear();
			if (!PlayerInput.UsingGamepad)
			{
				Main.ResetInventoryState();
			}
			else
			{
				PlayerInput.NavigatorUnCachePosition();
				Main.GamepadCursorAlpha = 0f;
				BlockInteractionWithProjectiles = 3;
				if (PlayerInput.GrappleAndInteractAreShared)
				{
					LockGamepadTileInteractions();
				}
			}
			SoundEngine.PlaySound(11);
			if (ItemSlot.Options.HighlightNewItems)
			{
				Item[] array = inventory;
				for (int i = 0; i < array.Length; i++)
				{
					array[i].newAndShiny = false;
				}
			}
			if (PlayerInput.UsingGamepad)
			{
				Main.npcChatRelease = false;
				tileInteractionHappened = true;
				releaseInventory = false;
				Main.mouseRight = true;
			}
		}
		if (grappleAndInteractAreShared)
		{
			GamepadEnableGrappleCooldown();
		}
	}

	public static void OpenInventory(bool quiet = false)
	{
		Main.playerInventory = true;
		Main.ResetInventoryState();
		if (!quiet)
		{
			SoundEngine.PlaySound(10);
		}
	}

	public void ToggleCreativeMenu()
	{
		if (!dead && difficulty == 3)
		{
			if (Main.playerInventory && !Main.CreativeMenu.Blocked)
			{
				Main.CreativeMenu.ToggleMenu();
				return;
			}
			bool num = !Main.playerInventory;
			IngameUIWindows.CloseAll(num);
			OpenInventory(!num);
			Main.CreativeMenu.ToggleMenu();
		}
	}

	public void dropItemCheck()
	{
		if (!Main.playerInventory)
		{
			noThrow = 0;
		}
		if (noThrow > 0)
		{
			noThrow--;
		}
		GetItemSettings returnItemFromSlot = GetItemSettings.ReturnItemFromSlot;
		if (!Main.InGuideCraftMenu && Main.guideItem.type > 0)
		{
			GetOrDropItem(Main.guideItem, returnItemFromSlot);
			Main.guideItem = new Item();
		}
		if (!Main.InReforgeMenu && Main.reforgeItem.type > 0)
		{
			GetOrDropItem(Main.reforgeItem, returnItemFromSlot);
			Main.reforgeItem = new Item();
		}
		if (Main.myPlayer == whoAmI)
		{
			inventory[58] = Main.mouseItem.Clone();
		}
		if (Main.mouseItem.type > 0 && Main.mouseItem.stack > 0 && !Main.gamePaused)
		{
			tileTargetX = (int)(((float)Main.mouseX + Main.screenPosition.X) / 16f);
			tileTargetY = (int)(((float)Main.mouseY + Main.screenPosition.Y) / 16f);
			if (gravDir == -1f)
			{
				tileTargetY = (int)((Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY) / 16f);
			}
		}
		if (Main.mouseItem.type > 0 && !Main.playerInventory)
		{
			GetOrDropItem(Main.mouseItem, returnItemFromSlot);
			Main.mouseItem = new Item();
			inventory[58] = new Item();
		}
		if (((controlThrow && releaseThrow && !inventory[selectedItem].favorited && inventory[selectedItem].type > 0 && !Main.drawingPlayerChat) || (((Main.mouseRight && !mouseInterface && Main.mouseRightRelease) || !Main.playerInventory) && Main.mouseItem.type > 0 && Main.mouseItem.stack > 0)) && (noThrow <= 0 || (controlThrow && releaseThrow)))
		{
			DropSelectedItem();
			if (Main.playerInventory && Main.mouseRight && !mouseInterface && Main.mouseRightRelease)
			{
				releaseUseTile = false;
				Main.mouseRightRelease = false;
			}
		}
	}

	public void DropSelectedItem()
	{
		if (Main.mouseItem != null && Main.mouseItem.type > 0 && Main.mouseItem.stack > 0)
		{
			DropSelectedItem(58, ref inventory[58]);
		}
		else if (!inventoryChestStack[selectedItem])
		{
			DropSelectedItem(selectedItem, ref inventory[selectedItem]);
		}
	}

	public void DropSelectedItem(int slot, ref Item theItemWeDrop)
	{
		bool flag = false;
		if (theItemWeDrop.favorited)
		{
			theItemWeDrop = GetItem(theItemWeDrop, GetItemSettings.ReturnItemFromSlot);
			if (slot == 58)
			{
				Main.mouseItem = theItemWeDrop;
			}
			if (theItemWeDrop.type == 0)
			{
				flag = true;
			}
		}
		if (!flag)
		{
			Item item = new Item();
			if (((Main.mouseRight && !mouseInterface && Main.mouseRightRelease) || !Main.playerInventory) && Main.mouseItem.type > 0 && Main.mouseItem.stack > 0)
			{
				item = theItemWeDrop;
				theItemWeDrop = Main.mouseItem;
				delayUseItem = true;
				controlUseItem = false;
			}
			if (whoAmI == Main.myPlayer && theItemWeDrop.type == 5095)
			{
				LucyAxeMessage.Create(LucyAxeMessage.MessageSource.ThrownAway, base.Top, new Vector2(direction * 7, -2f));
			}
			int num = Item.NewItem(GetItemSource_Misc(ItemSourceID.PlayerDrop), (int)position.X, (int)position.Y, width, height, theItemWeDrop.type);
			Main.item[num].OverrideWith(theItemWeDrop);
			theItemWeDrop = new Item();
			if (slot == 58)
			{
				Main.mouseItem = new Item();
			}
			WorldItem worldItem = Main.item[num];
			if (Main.netMode == 0)
			{
				worldItem.noGrabDelay = 100;
			}
			worldItem.velocity.Y = -2f;
			worldItem.velocity.X = (float)(4 * direction) + velocity.X;
			worldItem.favorited = false;
			worldItem.newAndShiny = false;
			if (((Main.mouseRight && !mouseInterface) || !Main.playerInventory) && Main.mouseItem.type > 0)
			{
				theItemWeDrop = item;
				Main.mouseItem = new Item();
			}
			else
			{
				SetItemAnimation(10);
				JustDroppedAnItem = true;
				DropSelectedItem_InterruptActionsThatUseAnimations();
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendData(21, -1, -1, null, num);
			}
		}
	}

	public void PlayDroppedItemAnimation(int time)
	{
		JustDroppedAnItem = true;
		SetItemAnimation(time);
		SetItemTime(time);
		DropSelectedItem_InterruptActionsThatUseAnimations();
	}

	private void DropSelectedItem_InterruptActionsThatUseAnimations()
	{
		if (heldProj >= 0)
		{
			Projectile projectile = Main.projectile[heldProj];
			if (projectile.active && projectile.owner == whoAmI)
			{
				projectile.Kill();
			}
		}
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile2 = Main.projectile[i];
			if (projectile2.active && projectile2.owner == whoAmI && (projectile2.aiStyle == 61 || projectile2.aiStyle == 160))
			{
				projectile2.Kill();
			}
		}
	}

	public int FindBuffIndex(int type)
	{
		if (buffImmune[type])
		{
			return -1;
		}
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffTime[i] >= 1 && buffType[i] == type)
			{
				return i;
			}
		}
		return -1;
	}

	public void AddBuff(int type, int time, bool fromNetPvP = false)
	{
		if (buffImmune[type])
		{
			return;
		}
		if (Main.netMode == 1 && Main.myPlayer != whoAmI)
		{
			if (Main.pvpBuff[type])
			{
				NetMessage.SendData(55, -1, -1, null, whoAmI, type, time);
			}
			return;
		}
		if (BuffID.Sets.IsFedState[type])
		{
			for (int i = 0; i < maxBuffs; i++)
			{
				if (BuffID.Sets.IsFedState[buffType[i]])
				{
					DelBuff(i);
				}
			}
		}
		if (!fromNetPvP)
		{
			time = AddBuff_DetermineBuffTimeToAdd(type, time);
		}
		if (!AddBuff_TryUpdatingExistingBuffTime(type, time))
		{
			AddBuff_RemoveOldPetBuffsOfMatchingType(type);
			AddBuff_RemoveOldMeleeBuffsOfMatchingType(type);
			AddBuff_ActuallyTryToAddTheBuff(type, time);
		}
	}

	private bool AddBuff_ActuallyTryToAddTheBuff(int type, int time)
	{
		int num = -1;
		while (num == -1)
		{
			int num2 = -1;
			for (int i = 0; i < maxBuffs; i++)
			{
				if (!Main.debuff[buffType[i]])
				{
					num2 = i;
					break;
				}
			}
			if (num2 == -1)
			{
				return false;
			}
			for (int j = num2; j < maxBuffs; j++)
			{
				if (buffType[j] == 0)
				{
					num = j;
					break;
				}
			}
			if (num == -1)
			{
				DelBuff(num2);
			}
		}
		buffType[num] = type;
		buffTime[num] = time;
		return true;
	}

	private void AddBuff_RemoveOldMeleeBuffsOfMatchingType(int type)
	{
		if (!Main.meleeBuff[type])
		{
			return;
		}
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] != type && Main.meleeBuff[buffType[i]])
			{
				DelBuff(i);
				i--;
			}
		}
	}

	private void AddBuff_RemoveOldPetBuffsOfMatchingType(int type)
	{
		if (Main.lightPet[type])
		{
			for (int i = 0; i < maxBuffs; i++)
			{
				if (Main.lightPet[buffType[i]])
				{
					DelBuff(i);
				}
			}
		}
		if (!Main.vanityPet[type])
		{
			return;
		}
		for (int j = 0; j < maxBuffs; j++)
		{
			if (Main.vanityPet[buffType[j]])
			{
				DelBuff(j);
			}
		}
	}

	private bool AddBuff_TryUpdatingExistingBuffTime(int type, int time)
	{
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] != type)
			{
				continue;
			}
			int num = BuffID.Sets.AddBuffTimeAdditivelyToCap[type];
			if (num > 0)
			{
				buffTime[i] += time;
				if (buffTime[i] > num)
				{
					buffTime[i] = num;
				}
			}
			else if (buffTime[i] < time)
			{
				buffTime[i] = time;
			}
			return true;
		}
		return false;
	}

	private int AddBuff_DetermineBuffTimeToAdd(int type, int time)
	{
		if (deadCellsPotionStation && BuffID.Sets.BuffTimeIsExtendedByDeadCellsPotionStationBuff[type])
		{
			time = (int)((float)time * 1.2f);
		}
		if (Main.expertMode && BuffID.Sets.BuffTimeIsExtendedWithGameDifficulty[type])
		{
			time = (int)(GameDifficultyData.DebuffTimeMultiplier.Sample(Main.Difficulty) * (float)time);
		}
		return time;
	}

	public void DelBuff(int b)
	{
		buffTime[b] = 0;
		buffType[b] = 0;
		int num = 0;
		for (int i = 0; i < maxBuffs - 1; i++)
		{
			if (buffTime[i] != 0 && buffType[i] != 0)
			{
				if (num < i)
				{
					buffTime[num] = buffTime[i];
					buffType[num] = buffType[i];
					buffTime[i] = 0;
					buffType[i] = 0;
				}
				num++;
			}
		}
	}

	public void ClearBuff(int type)
	{
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] == type)
			{
				DelBuff(i);
			}
		}
	}

	public int CountBuffs()
	{
		int num = 0;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[num] > 0)
			{
				num++;
			}
		}
		return num;
	}

	public bool CanConsumeConsumableItem(Item item)
	{
		return true;
	}

	public void QuickHeal()
	{
		if (Main.LocalPlayerHasPendingInventoryActions() || cursed || CCed || dead || statLife == statLifeMax2 || potionDelay > 0)
		{
			return;
		}
		Item item = QuickHeal_GetItemToUse();
		if (item == null || !ItemCheck_TryStartUse(item))
		{
			return;
		}
		if (mount.Active && Mount.DismountsOnItemUse(mount.Type))
		{
			mount.TryEarlyDismount(this);
		}
		SoundEngine.PlaySound(item.UseSound, position);
		if (item.potion)
		{
			ApplyPotionDelay(item);
		}
		ApplyLifeAndOrMana(item);
		if (item.type == 5)
		{
			TryToResetHungerToNeutral();
		}
		if (item.buffType > 0)
		{
			int num = item.buffTime;
			if (num == 0)
			{
				num = 3600;
			}
			AddBuff(item.buffType, num);
		}
		if (CanConsumeConsumableItem(item))
		{
			item.stack--;
			if (item.stack <= 0)
			{
				item.TurnToAir();
			}
		}
		if (Main.myPlayer == whoAmI && item.type == 126 && breath == 0)
		{
			AchievementsHelper.HandleSpecialEvent(this, 25);
		}
	}

	public Item QuickHeal_GetItemToUse()
	{
		int lifeDifference = statLifeMax2 - statLife;
		Item bestItem = null;
		int bestDifference = -statLifeMax2;
		for (int i = 0; i < 58; i++)
		{
			QuickHeal_GetItemToUse_TryChoosingItem(lifeDifference, ref bestItem, ref bestDifference, inventory[i]);
		}
		if (useVoidBag())
		{
			for (int j = 0; j < bank4.maxItems; j++)
			{
				QuickHeal_GetItemToUse_TryChoosingItem(lifeDifference, ref bestItem, ref bestDifference, bank4.item[j]);
			}
		}
		return bestItem;
	}

	private static void QuickHeal_GetItemToUse_TryChoosingItem(int lifeDifference, ref Item bestItem, ref int bestDifference, Item nextItem)
	{
		if (nextItem.stack <= 0 || nextItem.type <= 0 || !nextItem.potion || nextItem.healLife <= 0)
		{
			return;
		}
		int num = nextItem.healLife - lifeDifference;
		if (nextItem.type == 227 && num < 0)
		{
			num += 30;
			if (num > 0)
			{
				num = 0;
			}
		}
		if (bestDifference < 0)
		{
			if (num > bestDifference)
			{
				bestItem = nextItem;
				bestDifference = num;
			}
		}
		else if (num < bestDifference && num >= 0)
		{
			bestItem = nextItem;
			bestDifference = num;
		}
	}

	public void QuickMana()
	{
		if (Main.LocalPlayerHasPendingInventoryActions() || cursed || CCed || dead || statMana == statManaMax2)
		{
			return;
		}
		Item item = QuickMana_GetItemToUse();
		if (item == null || !ItemCheck_TryStartUse(item))
		{
			return;
		}
		if (mount.Active && Mount.DismountsOnItemUse(mount.Type))
		{
			mount.TryEarlyDismount(this);
		}
		SoundEngine.PlaySound(item.UseSound, position);
		if (item.potion)
		{
			ApplyPotionDelay(item);
		}
		ApplyLifeAndOrMana(item);
		if (CanConsumeConsumableItem(item))
		{
			item.stack--;
			if (item.stack <= 0)
			{
				item.TurnToAir();
			}
		}
	}

	public Item QuickMana_GetItemToUse()
	{
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].stack > 0 && inventory[i].type > 0 && inventory[i].healMana > 0 && (potionDelay == 0 || !inventory[i].potion))
			{
				return inventory[i];
			}
		}
		if (useVoidBag())
		{
			for (int j = 0; j < bank4.maxItems; j++)
			{
				if (bank4.item[j].stack > 0 && bank4.item[j].type > 0 && bank4.item[j].healMana > 0 && (potionDelay == 0 || !bank4.item[j].potion))
				{
					return bank4.item[j];
				}
			}
		}
		return null;
	}

	public void TrySwitchingLoadout(int loadoutIndex)
	{
		if ((whoAmI != Main.myPlayer || (!UsingOrReusingItem && !CCed && !dead)) && loadoutIndex != CurrentLoadoutIndex && loadoutIndex >= 0 && loadoutIndex < Loadouts.Length)
		{
			Loadouts[CurrentLoadoutIndex].Swap(this);
			Loadouts[loadoutIndex].Swap(this);
			CurrentLoadoutIndex = loadoutIndex;
			if (whoAmI == Main.myPlayer)
			{
				clientCloneLoadouts(Main.clientPlayer);
				Main.mouseLeftRelease = false;
				ItemSlot.RecordLoadoutChange();
				SoundEngine.PlaySound(12);
				NetMessage.TrySendData(147, -1, -1, null, whoAmI, loadoutIndex);
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.LoadoutChange, new ParticleOrchestraSettings
				{
					PositionInWorld = base.Center,
					UniqueInfoPiece = loadoutIndex
				}, whoAmI);
			}
		}
	}

	public void QuickBuff()
	{
		if (Main.LocalPlayerHasPendingInventoryActions() || cursed || CCed || dead || spectating >= 0)
		{
			return;
		}
		LegacySoundStyle legacySoundStyle = null;
		if (CountBuffs() == maxBuffs)
		{
			return;
		}
		Item item = QuickBuff_PickBestFoodItem();
		if (item != null && ItemCheck_TryStartUse(item))
		{
			if (mount.Active && Mount.DismountsOnItemUse(mount.Type))
			{
				mount.TryEarlyDismount(this);
			}
			legacySoundStyle = item.UseSound;
			int num = item.buffTime;
			if (num == 0)
			{
				num = 3600;
			}
			AddBuff(item.buffType, num);
			if (item.consumable)
			{
				item.stack--;
				if (item.stack <= 0)
				{
					item.TurnToAir();
				}
			}
		}
		if (CountBuffs() != maxBuffs)
		{
			int num2 = 58;
			for (int i = 0; i < num2; i++)
			{
				Item item2 = inventory[i];
				if (QuickBuff_ShouldUseItem(item2, out var btype))
				{
					if (mount.Active && Mount.DismountsOnItemUse(mount.Type))
					{
						mount.TryEarlyDismount(this);
					}
					legacySoundStyle = item2.UseSound;
					QuickBuff_UseItemForBuff(item2, btype);
					if (CountBuffs() == maxBuffs)
					{
						break;
					}
				}
			}
		}
		if (CountBuffs() != maxBuffs && useVoidBag())
		{
			int maxItems = bank4.maxItems;
			for (int j = 0; j < maxItems; j++)
			{
				Item item3 = bank4.item[j];
				if (QuickBuff_ShouldUseItem(item3, out var btype2))
				{
					if (mount.Active && Mount.DismountsOnItemUse(mount.Type))
					{
						mount.TryEarlyDismount(this);
					}
					legacySoundStyle = item3.UseSound;
					QuickBuff_UseItemForBuff(item3, btype2);
					if (CountBuffs() == maxBuffs)
					{
						break;
					}
				}
			}
		}
		if (legacySoundStyle != null)
		{
			SoundEngine.PlaySound(legacySoundStyle, position);
		}
	}

	private void QuickBuff_UseItemForBuff(Item item, int btype)
	{
		int num = item.buffTime;
		if (num == 0)
		{
			num = 3600;
		}
		AddBuff(btype, num);
		if (item.consumable)
		{
			item.stack--;
			if (item.stack <= 0)
			{
				item.TurnToAir();
			}
		}
	}

	private bool QuickBuff_ShouldUseItem(Item item, out int btype)
	{
		btype = 0;
		if (item.stack <= 0 || item.type <= 0 || item.buffType <= 0 || item.summon)
		{
			return false;
		}
		if (!ItemCheck_TryStartUse(item))
		{
			return false;
		}
		btype = item.buffType;
		bool flag = QuickBuff_ShouldBotherUsingThisBuff(btype);
		if (item.mana > 0 && flag)
		{
			if (statMana >= (int)((float)item.mana * manaCost))
			{
				manaRegenDelay = (int)maxRegenDelay;
				statMana -= (int)((float)item.mana * manaCost);
			}
			else
			{
				flag = false;
			}
		}
		if (whoAmI == Main.myPlayer && item.type == 603 && !Main.runningCollectorsEdition)
		{
			flag = false;
		}
		if (btype == 27)
		{
			btype = Main.rand.Next(3);
			if (btype == 0)
			{
				btype = 27;
			}
			if (btype == 1)
			{
				btype = 101;
			}
			if (btype == 2)
			{
				btype = 102;
			}
		}
		return flag;
	}

	private Item QuickBuff_PickBestFoodItem()
	{
		int num = 0;
		Item item = null;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffTime[i] >= 1)
			{
				int num2 = QuickBuff_FindFoodPriority(buffType[i]);
				if (num <= num2)
				{
					num = num2 + 1;
				}
			}
		}
		for (int j = 0; j < 58; j++)
		{
			Item item2 = inventory[j];
			if (!item2.IsAir)
			{
				int num3 = QuickBuff_FindFoodPriority(item2.buffType);
				if (num3 > 0 && num3 >= num && (item == null || item.buffTime < item2.buffTime || num3 > num))
				{
					item = item2;
					num = num3;
				}
			}
		}
		if (useVoidBag())
		{
			for (int k = 0; k < bank4.maxItems; k++)
			{
				Item item3 = bank4.item[k];
				if (!item3.IsAir)
				{
					int num4 = QuickBuff_FindFoodPriority(item3.buffType);
					if (num4 > 0 && num4 >= num && (item == null || item.buffTime < item3.buffTime || num4 > num))
					{
						item = item3;
						num = num4;
					}
				}
			}
		}
		return item;
	}

	private int QuickBuff_FindFoodPriority(int buffType)
	{
		return buffType switch
		{
			26 => 1, 
			206 => 2, 
			207 => 3, 
			_ => 0, 
		};
	}

	private bool QuickBuff_ShouldBotherUsingThisBuff(int attemptedType)
	{
		bool result = true;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (attemptedType == 27 && (buffType[i] == 27 || buffType[i] == 101 || buffType[i] == 102))
			{
				result = false;
				break;
			}
			if (BuffID.Sets.IsWellFed[attemptedType] && BuffID.Sets.IsWellFed[buffType[i]])
			{
				result = false;
				break;
			}
			if (buffType[i] == attemptedType)
			{
				result = false;
				break;
			}
			if (Main.meleeBuff[attemptedType] && Main.meleeBuff[buffType[i]])
			{
				result = false;
				break;
			}
		}
		if (Main.lightPet[attemptedType] || Main.vanityPet[attemptedType])
		{
			for (int j = 0; j < maxBuffs; j++)
			{
				if (Main.lightPet[buffType[j]] && Main.lightPet[attemptedType])
				{
					result = false;
				}
				if (Main.vanityPet[buffType[j]] && Main.vanityPet[attemptedType])
				{
					result = false;
				}
			}
		}
		return result;
	}

	public void PlayerNoSpaceTeleport()
	{
		FailedNoSpaceCount = 0;
		if (TeleportHelpers.FindClosestTeleportSpotNoSpace(this, out var resultPosition))
		{
			Teleport(resultPosition, 11);
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, resultPosition);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, resultPosition.X, resultPosition.Y, 11, Utils.ToInt(value: false));
			}
		}
		else
		{
			Shellphone_Spawn();
		}
	}

	private void UpdateFailedDismount()
	{
		if (FailedNoSpaceCount > 0 && (dead || !mount.Active || FailedNoSpaceLocation != position.ToTileCoordinates()))
		{
			FailedNoSpaceCount = 0;
		}
	}

	public void QuickMount()
	{
		if (mount.Active)
		{
			if (mount.TryDismountWithResult(this) != Mount.DismountCheckResult.FailedNoSpace)
			{
				return;
			}
			FailedNoSpaceLocation = position.ToTileCoordinates();
			FailedNoSpaceCount++;
			if (FailedNoSpaceCount < 3)
			{
				SoundEngine.PlaySound(0, (int)position.X, (int)position.Y);
				mount.DoFailedDismountDust(this, FailedNoSpaceCount * 20);
				return;
			}
			mount.Dismount(this, ignoreEffect: true);
			FailedNoSpaceCount = 0;
			if (Main.netMode == 0)
			{
				PlayerNoSpaceTeleport();
			}
			else if (Main.netMode == 1 && whoAmI == Main.myPlayer)
			{
				NetMessage.SendData(73, -1, -1, null, 4);
			}
		}
		else
		{
			if (frozen || tongued || webbed || stoned || gravDir == -1f || dead || noItems)
			{
				return;
			}
			Item item = QuickMount_GetItemToUse();
			if (item != null && item.mountType != -1 && mount.CanMount(item.mountType, this) && ItemCheck_TryStartUse(item))
			{
				bool flag = !QuickMinecartSnap();
				if (Mount.DismountsOnItemUse(item.mountType) && TryingToUseItem())
				{
					flag = false;
				}
				if (flag)
				{
					mount.SetMount(item.mountType, this);
					if (item.UseSound != null)
					{
						SoundEngine.PlaySound(item.UseSound, base.Center);
					}
				}
			}
			else
			{
				QuickMinecart();
			}
		}
	}

	public bool CanFitSpace(int heightBoost)
	{
		int num = 42 + heightBoost;
		return Collision.IsClearSpotTest(position + new Vector2(0f, height - num) + velocity, 16f, width, num, fallThrough: true, fall2: true);
	}

	public bool CanFitInSpaceWithSize(Vector2 size, Vector2 offset = default(Vector2))
	{
		return Collision.IsClearSpotTest(new Vector2(base.Center.X - size.X / 2f, base.Bottom.Y - size.Y) + velocity + offset, 16f, (int)size.X, (int)size.Y, fallThrough: true, fall2: true);
	}

	private void QuickMinecart()
	{
		TileReachCheckSettings.Simple.GetTileRegion(this, out var LX, out var LY, out var HX, out var HY);
		LX = Utils.Clamp(LX, 10, Main.maxTilesX - 10);
		HX = Utils.Clamp(HX, 10, Main.maxTilesX - 10);
		LY = Utils.Clamp(LY, 10, Main.maxTilesY - 10);
		HY = Utils.Clamp(HY, 10, Main.maxTilesY - 10);
		List<Point> tilesIn = Collision.GetTilesIn(new Vector2(LX, LY) * 16f, new Vector2(HX + 1, HY + 1) * 16f);
		if (tilesIn.Count <= 0)
		{
			return;
		}
		Point? point = null;
		_ = base.Hitbox;
		for (int i = 0; i < tilesIn.Count; i++)
		{
			Point point2 = tilesIn[i];
			Tile tileSafely = Framing.GetTileSafely(point2.X, point2.Y);
			if (tileSafely.active() && tileSafely.type == 314)
			{
				Vector2 vector = tilesIn[i].ToVector2() * 16f + new Vector2(8f);
				if ((!point.HasValue || Distance(vector) < Distance(point.Value.ToVector2() * 16f + new Vector2(8f))) && Collision.CanHitLine(base.Center, 0, 0, vector, 0, 0))
				{
					point = tilesIn[i];
				}
			}
		}
		if (point.HasValue)
		{
			LaunchMinecartHook(point.Value.X, point.Value.Y);
		}
	}

	private bool QuickMinecartSnap()
	{
		bool result = false;
		List<Point> tilesIn = Collision.GetTilesIn(base.TopLeft - new Vector2(24f), base.BottomRight + new Vector2(24f));
		if (tilesIn.Count > 0)
		{
			Point? point = null;
			_ = base.Hitbox;
			for (int i = 0; i < tilesIn.Count; i++)
			{
				Point point2 = tilesIn[i];
				Tile tileSafely = Framing.GetTileSafely(point2.X, point2.Y);
				if (tileSafely.active() && tileSafely.type == 314)
				{
					Vector2 vector = tilesIn[i].ToVector2() * 16f + new Vector2(8f);
					if (!point.HasValue || (Distance(vector) < Distance(point.Value.ToVector2() * 16f + new Vector2(8f)) && Collision.CanHitLine(base.Center, 0, 0, vector, 0, 0)))
					{
						point = tilesIn[i];
					}
				}
			}
			if (point.HasValue)
			{
				LaunchMinecartHook(point.Value.X, point.Value.Y);
				result = true;
			}
		}
		return result;
	}

	public Item QuickMount_GetItemToUse()
	{
		Item item = null;
		if (item == null && miscEquips[3].mountType != -1 && !MountID.Sets.Cart[miscEquips[3].mountType])
		{
			item = miscEquips[3];
		}
		if (item == null)
		{
			for (int i = 0; i < 58; i++)
			{
				if (inventory[i].mountType != -1 && !MountID.Sets.Cart[inventory[i].mountType])
				{
					item = inventory[i];
					break;
				}
			}
		}
		return item;
	}

	public void ClearGrapplingBlacklist()
	{
		_blackListedTileCoordsForGrappling.Clear();
	}

	public bool IsBlacklistedForGrappling(Point p)
	{
		return _blackListedTileCoordsForGrappling.Contains(p);
	}

	public void UpdateBlacklistedTilesForGrappling()
	{
		ClearGrapplingBlacklist();
		for (int i = 0; i < 1000; i++)
		{
			if (!Main.projectile[i].active || Main.projectile[i].owner != whoAmI || Main.projectile[i].aiStyle != 7 || Main.projectile[i].ai[0] != 2f)
			{
				continue;
			}
			Point pt = Main.projectile[i].Center.ToTileCoordinates();
			for (int j = -1; j <= 1; j++)
			{
				for (int k = -1; k <= 1; k++)
				{
					if (!WorldGen.SolidTile(pt.X + j, pt.Y + k))
					{
						_blackListedTileCoordsForGrappling.Add(new Point(pt.X + j, pt.Y + k));
					}
				}
			}
			Tile tileSafely = Framing.GetTileSafely(pt);
			if (tileSafely.type != 314 && !TileID.Sets.Platforms[tileSafely.type])
			{
				continue;
			}
			for (int l = -2; l <= 2; l++)
			{
				for (int m = -2; m <= 2; m++)
				{
					Point point = new Point(pt.X + l, pt.Y + m);
					Tile tileSafely2 = Framing.GetTileSafely(point);
					if (tileSafely2.type == 314 || TileID.Sets.Platforms[tileSafely2.type])
					{
						_blackListedTileCoordsForGrappling.Add(point);
					}
				}
			}
		}
	}

	public void QuickGrapple()
	{
		if (frozen || tongued || webbed || stoned || dead)
		{
			return;
		}
		if (PlayerInput.GrappleAndInteractAreShared)
		{
			if (Main.HoveringOverAnNPC || Main.SmartInteractShowingGenuine || Main.SmartInteractShowingFake || (_quickGrappleCooldown > 0 && !Main.mapFullscreen) || (WiresUI.Settings.DrawToolModeUI && PlayerInput.UsingGamepad))
			{
				return;
			}
			bool num = controlUseTile;
			bool flag = releaseUseTile;
			if (!num && !flag)
			{
				return;
			}
			Tile tileSafely = Framing.GetTileSafely(tileTargetX, tileTargetY);
			if ((tileSafely.active() && TileID.Sets.NoQuickGrapple[tileSafely.type]) || (inventory[selectedItem].type == 3384 && PlayerInput.UsingGamepad))
			{
				return;
			}
		}
		Item item = QuickGrapple_GetItemToUse();
		if (item == null)
		{
			return;
		}
		bool flag2 = false;
		if (mount.Active && mount.DismountOnItemUse && mount.CanDismount(this) && noItems && !cursed)
		{
			flag2 = true;
		}
		if (noItems && !flag2)
		{
			return;
		}
		if (mount.Active && !MountID.Sets.CanUseHooks[mount.Type])
		{
			mount.TryDismount(this);
		}
		if (!ItemCheck_TryStartUse(item))
		{
			return;
		}
		int num2 = item.shoot;
		int num3 = -1;
		int num4 = 100000;
		int num5 = 0;
		int num6 = 0;
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.owner == Main.myPlayer && projectile.aiStyle == 7)
			{
				if (projectile.ai[0] == 2f)
				{
					num6++;
				}
				else
				{
					num5++;
				}
				if (projectile.timeLeft < num4)
				{
					num3 = i;
					num4 = Main.projectile[i].timeLeft;
				}
			}
		}
		int num7 = 3;
		int num8 = 999;
		if (num2 == 73)
		{
			num7 = 2;
		}
		else if (num2 == 372)
		{
			num7 = 3;
		}
		else if (num2 == 165)
		{
			num7 = 8;
		}
		else if (num2 == 652)
		{
			num7 = 2;
		}
		else if (num2 == 646)
		{
			num7 = 4;
		}
		else if (num2 == 13 || num2 == 315 || (num2 >= 230 && num2 <= 235) || num2 == 331 || num2 == 753 || num2 == 865 || num2 == 935)
		{
			num7 = 1;
			num8 = 1;
		}
		else if (num2 == 256)
		{
			num7 = 2;
			num8 = 2;
		}
		num7 = Math.Max(1, num7 - num6);
		if (num5 >= num7)
		{
			return;
		}
		if (mount.Active && Mount.DismountsOnItemUse(mount.Type))
		{
			mount.TryEarlyDismount(this);
		}
		UpdateBlacklistedTilesForGrappling();
		SoundEngine.PlaySound(item.UseSound, position);
		if (Main.netMode == 1 && whoAmI == Main.myPlayer)
		{
			NetMessage.SendData(51, -1, -1, null, whoAmI, 2f);
		}
		float shootSpeed = item.shootSpeed;
		int damage = item.damage;
		float knockBack = item.knockBack;
		if (num3 >= 0 && num6 + num5 >= num8)
		{
			Main.projectile[num3].Kill();
		}
		if (num2 == 73)
		{
			for (int j = 0; j < 1000; j++)
			{
				if (Main.projectile[j].active && Main.projectile[j].owner == whoAmI && Main.projectile[j].type == 73)
				{
					num2 = 74;
				}
			}
		}
		if (item.type == 3572)
		{
			int num9 = -1;
			int num10 = -1;
			for (int k = 0; k < 1000; k++)
			{
				Projectile projectile2 = Main.projectile[k];
				if (projectile2.active && projectile2.owner == whoAmI && projectile2.type >= 646 && projectile2.type <= 649 && (num10 == -1 || num10 < projectile2.timeLeft))
				{
					num9 = projectile2.type;
					num10 = projectile2.timeLeft;
				}
			}
			switch (num9)
			{
			case 646:
				num2 = 647;
				break;
			case 647:
				num2 = 648;
				break;
			case 648:
				num2 = 649;
				break;
			case -1:
			case 649:
				num2 = 646;
				break;
			}
		}
		Vector2 vector = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
		float num11 = (float)Main.mouseX + Main.screenPosition.X - vector.X;
		float num12 = (float)Main.mouseY + Main.screenPosition.Y - vector.Y;
		if (gravDir == -1f)
		{
			num12 = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY - vector.Y;
		}
		float num13 = (float)Math.Sqrt(num11 * num11 + num12 * num12);
		if ((float.IsNaN(num11) && float.IsNaN(num12)) || (num11 == 0f && num12 == 0f))
		{
			num11 = direction;
			num12 = 0f;
			num13 = shootSpeed;
		}
		else
		{
			num13 = shootSpeed / num13;
		}
		num11 *= num13;
		num12 *= num13;
		Projectile.NewProjectile(GetProjectileSource_Item(item), vector.X, vector.Y, num11, num12, num2, damage, knockBack, whoAmI);
	}

	public Item QuickGrapple_GetItemToUse()
	{
		Item item = null;
		if (Main.projHook[miscEquips[4].shoot])
		{
			item = miscEquips[4];
		}
		if (item == null)
		{
			for (int i = 0; i < 58; i++)
			{
				if (Main.projHook[inventory[i].shoot])
				{
					item = inventory[i];
					break;
				}
			}
		}
		return item;
	}

	public void StatusToNPC(int type, int i)
	{
		if (meleeEnchant > 0)
		{
			if (meleeEnchant == 1)
			{
				Main.npc[i].AddBuff(70, 60 * Main.rand.Next(5, 10));
			}
			if (meleeEnchant == 2)
			{
				Main.npc[i].AddBuff(39, 60 * Main.rand.Next(3, 7));
			}
			if (meleeEnchant == 3)
			{
				Main.npc[i].AddBuff(24, 60 * Main.rand.Next(3, 7));
			}
			if (meleeEnchant == 5)
			{
				Main.npc[i].AddBuff(69, 60 * Main.rand.Next(10, 20));
			}
			if (meleeEnchant == 6)
			{
				Main.npc[i].AddBuff(31, 60 * Main.rand.Next(1, 4));
			}
			if (meleeEnchant == 8)
			{
				Main.npc[i].AddBuff(20, 60 * Main.rand.Next(5, 10));
			}
			if (meleeEnchant == 4)
			{
				Main.npc[i].AddBuff(72, 120);
			}
		}
		if (type == 2330 && Main.rand.Next(2) == 0)
		{
			Main.npc[i].AddBuff(31, 60 * Main.rand.Next(1, 4));
		}
		if (type == 3352)
		{
			Main.npc[i].AddBuff(30, 60 * Main.rand.Next(4, 7));
		}
		if (frostBurn)
		{
			Main.npc[i].AddBuff(324, 60 * Main.rand.Next(5, 15));
		}
		if (magmaStone)
		{
			if (Main.rand.Next(4) == 0)
			{
				Main.npc[i].AddBuff(323, 360);
			}
			else if (Main.rand.Next(2) == 0)
			{
				Main.npc[i].AddBuff(323, 240);
			}
			else
			{
				Main.npc[i].AddBuff(323, 120);
			}
		}
		if (type == 3211)
		{
			Main.npc[i].AddBuff(69, 60 * Main.rand.Next(5, 10));
		}
		if (type == 5129)
		{
			Main.npc[i].AddBuff(120, 300);
		}
		switch (type)
		{
		case 121:
			if (Main.rand.Next(2) == 0)
			{
				Main.npc[i].AddBuff(24, 180);
			}
			break;
		case 3823:
			if (Main.rand.Next(4) == 0)
			{
				Main.npc[i].AddBuff(323, 300);
			}
			break;
		case 5382:
			if (Main.rand.Next(3) == 0)
			{
				Main.npc[i].AddBuff(323, 300);
			}
			break;
		case 122:
			if (Main.rand.Next(10) == 0)
			{
				Main.npc[i].AddBuff(24, 180);
			}
			break;
		case 190:
			if (Main.rand.Next(4) == 0)
			{
				Main.npc[i].AddBuff(20, 420);
			}
			break;
		case 217:
			if (Main.rand.Next(5) == 0)
			{
				Main.npc[i].AddBuff(24, 180);
			}
			break;
		case 1123:
			Main.npc[i].AddBuff(31, 120);
			break;
		}
	}

	public void StatusToPlayerPvP(int type, int i)
	{
		if (meleeEnchant > 0)
		{
			if (meleeEnchant == 1)
			{
				Main.player[i].AddBuff(70, 60 * Main.rand.Next(5, 10));
			}
			if (meleeEnchant == 2)
			{
				Main.player[i].AddBuff(39, 60 * Main.rand.Next(3, 7));
			}
			if (meleeEnchant == 3)
			{
				Main.player[i].AddBuff(24, 60 * Main.rand.Next(3, 7));
			}
			if (meleeEnchant == 5)
			{
				Main.player[i].AddBuff(69, 60 * Main.rand.Next(10, 20));
			}
			if (meleeEnchant == 6)
			{
				Main.player[i].AddBuff(31, 60 * Main.rand.Next(1, 4));
			}
			if (meleeEnchant == 8)
			{
				Main.player[i].AddBuff(20, 60 * Main.rand.Next(5, 10));
			}
		}
		if (frostBurn)
		{
			Main.player[i].AddBuff(324, 60 * Main.rand.Next(1, 8));
		}
		if (magmaStone)
		{
			if (Main.rand.Next(7) == 0)
			{
				Main.player[i].AddBuff(323, 360);
			}
			else if (Main.rand.Next(3) == 0)
			{
				Main.player[i].AddBuff(323, 120);
			}
			else
			{
				Main.player[i].AddBuff(323, 60);
			}
		}
		if (type == 5129)
		{
			Main.player[i].AddBuff(120, 300);
		}
		switch (type)
		{
		case 121:
			if (Main.rand.Next(2) == 0)
			{
				Main.player[i].AddBuff(24, 180);
			}
			break;
		case 3823:
			if (Main.rand.Next(4) == 0)
			{
				Main.player[i].AddBuff(323, 300);
			}
			break;
		case 5382:
			if (Main.rand.Next(3) == 0)
			{
				Main.player[i].AddBuff(323, 300);
			}
			break;
		case 122:
			if (Main.rand.Next(10) == 0)
			{
				Main.player[i].AddBuff(24, 180);
			}
			break;
		case 190:
			if (Main.rand.Next(4) == 0)
			{
				Main.player[i].AddBuff(20, 420);
			}
			break;
		case 217:
			if (Main.rand.Next(5) == 0)
			{
				Main.player[i].AddBuff(24, 180);
			}
			break;
		case 1123:
			Main.player[i].AddBuff(31, 120);
			break;
		}
	}

	public void Ghost()
	{
		spectating = -1;
		immune = false;
		immuneAlpha = 0;
		ResetEffects();
		ResetVisibleAccessories();
		if (Main.hasFocus && whoAmI == Main.myPlayer)
		{
			controlUp = false;
			controlLeft = false;
			controlDown = false;
			controlRight = false;
			controlJump = false;
			if (!Main.drawingPlayerChat && !Main.editSign && !Main.editChest && !Main.blockInput)
			{
				PlayerInput.Triggers.Current.CopyInto(this);
				TrySyncingInput();
				TryOpeningInGameOptionsBasedOnInput();
			}
		}
		float num = 7f;
		float num2 = 0.2f;
		if (controlUp || controlJump)
		{
			if (velocity.Y > 0f)
			{
				velocity.Y *= 0.9f;
			}
			velocity.Y -= num2;
			if (velocity.Y < 0f - num)
			{
				velocity.Y = 0f - num;
			}
		}
		else if (controlDown)
		{
			if (velocity.Y < 0f)
			{
				velocity.Y *= 0.9f;
			}
			velocity.Y += num2;
			if (velocity.Y > num)
			{
				velocity.Y = num;
			}
		}
		else if ((double)velocity.Y < -0.1 || (double)velocity.Y > 0.1)
		{
			velocity.Y *= 0.9f;
		}
		else
		{
			velocity.Y = 0f;
		}
		if (controlLeft && !controlRight)
		{
			if (velocity.X > 0f)
			{
				velocity.X *= 0.9f;
			}
			velocity.X -= num2;
			if (velocity.X < 0f - num)
			{
				velocity.X = 0f - num;
			}
		}
		else if (controlRight && !controlLeft)
		{
			if (velocity.X < 0f)
			{
				velocity.X *= 0.9f;
			}
			velocity.X += num2;
			if (velocity.X > num)
			{
				velocity.X = num;
			}
		}
		else if (velocity.X < 0f - num2 || velocity.X > num2)
		{
			velocity.X *= 0.9f;
		}
		else
		{
			velocity.X = 0f;
		}
		position += velocity;
		ghostFrameCounter++;
		if (velocity.X < 0f)
		{
			direction = -1;
		}
		else if (velocity.X > 0f)
		{
			direction = 1;
		}
		if (ghostFrameCounter >= 8)
		{
			ghostFrameCounter = 0;
			ghostFrame++;
			if (ghostFrame >= 4)
			{
				ghostFrame = 0;
			}
		}
		int num3 = 640;
		float num4 = Main.leftWorld + (float)num3;
		if (position.X < num4)
		{
			position.X = num4;
			velocity.X = 0f;
		}
		float num5 = Main.rightWorld - (float)num3 - (float)width;
		if (position.X > num5)
		{
			position.X = num5;
			velocity.X = 0f;
		}
		float num6 = Main.topWorld + (float)num3;
		if (position.Y < num6)
		{
			position.Y = num6;
			if (velocity.Y < -0.1f)
			{
				velocity.Y = -0.1f;
			}
		}
		float num7 = Main.bottomWorld - (float)num3 - (float)height;
		if (position.Y > num7)
		{
			position.Y = num7;
			velocity.Y = 0f;
		}
		UpdateNetOffset(fallThrough: true, ignorePlats: true);
	}

	private void TrySyncingInput()
	{
		if (Main.netMode == 1)
		{
			bool flag = false;
			Player clientPlayer = Main.clientPlayer;
			if (controlUp != clientPlayer.controlUp)
			{
				flag = true;
			}
			if (controlDown != clientPlayer.controlDown)
			{
				flag = true;
			}
			if (controlLeft != clientPlayer.controlLeft)
			{
				flag = true;
			}
			if (controlRight != clientPlayer.controlRight)
			{
				flag = true;
			}
			if (controlJump != clientPlayer.controlJump)
			{
				flag = true;
			}
			if (controlUseItem != clientPlayer.controlUseItem)
			{
				flag = true;
			}
			if (selectedItem != clientPlayer.selectedItem)
			{
				flag = true;
			}
			if (autoReuseAllWeapons != clientPlayer.autoReuseAllWeapons)
			{
				flag = true;
			}
			if (controlDownHold != clientPlayer.controlDownHold)
			{
				flag = true;
			}
			if (isOperatingAnotherEntity != clientPlayer.isOperatingAnotherEntity)
			{
				flag = true;
			}
			if (lastItemUseAttemptSuccess != clientPlayer.lastItemUseAttemptSuccess)
			{
				flag = true;
			}
			if (flag)
			{
				NetMessage.SendData(13, -1, -1, null, Main.myPlayer);
			}
		}
	}

	public void OnHit(float x, float y, Entity victim)
	{
		if (Main.myPlayer != whoAmI)
		{
			return;
		}
		bool flag = victim is NPC && (((NPC)victim).type == 488 || ((NPC)victim).SpawnedFromStatue);
		if (titaniumStormCooldown > 0)
		{
			flag = true;
		}
		if (victim is NPC)
		{
			Main.BigBossProgressBar.TryTracking(victim.whoAmI);
		}
		if (onHitTitaniumStorm && !flag)
		{
			titaniumStormCooldown = 10;
			AddBuff(306, 600);
			if (ownedProjectileCounts[908] < 7)
			{
				ownedProjectileCounts[908]++;
				Projectile.NewProjectile(GetProjectileSource_OnHit(victim, 4), base.Center, Vector2.Zero, 908, 50, 15f, whoAmI);
			}
		}
		if (onHitDodge && shadowDodgeTimer == 0)
		{
			AddBuff(59, 1800);
		}
		if (onHitRegen)
		{
			AddBuff(58, 300);
		}
		if (stardustMinion && victim is NPC)
		{
			for (int i = 0; i < 1000; i++)
			{
				Projectile projectile = Main.projectile[i];
				if (projectile.active && projectile.owner == whoAmI && projectile.type == 613 && !(projectile.localAI[1] > 0f) && Main.rand.Next(2) == 0)
				{
					Vector2 vector = new Vector2(x, y) - projectile.Center;
					if (vector.Length() > 0f)
					{
						vector.Normalize();
					}
					vector *= 20f;
					Projectile.NewProjectile(Projectile.InheritSource(projectile), projectile.Center.X, projectile.Center.Y, vector.X, vector.Y, 614, projectile.damage / 3, 0f, projectile.owner, 0f, victim.whoAmI);
					projectile.localAI[1] = 30 + Main.rand.Next(4) * 10;
				}
			}
		}
		if (onHitPetal && petalTimer == 0)
		{
			petalTimer = 20;
			_ = position.X + (float)(width / 2);
			int num = direction;
			float num2 = Main.screenPosition.X;
			if (num < 0)
			{
				num2 += (float)Main.screenWidth;
			}
			float y2 = Main.screenPosition.Y;
			y2 += (float)Main.rand.Next(Main.screenHeight);
			Vector2 vector2 = new Vector2(num2, y2);
			float num3 = x - vector2.X;
			float num4 = y - vector2.Y;
			num3 += (float)Main.rand.Next(-50, 51) * 0.1f;
			num4 += (float)Main.rand.Next(-50, 51) * 0.1f;
			float num5 = (float)Math.Sqrt(num3 * num3 + num4 * num4);
			num5 = 24f / num5;
			num3 *= num5;
			num4 *= num5;
			Projectile.NewProjectile(GetProjectileSource_OnHit(victim, 5), num2, y2, num3, num4, 221, 36, 0f, whoAmI);
		}
		if (!crystalLeaf || petalTimer != 0)
		{
			return;
		}
		for (int j = 0; j < 1000; j++)
		{
			if (Main.projectile[j].owner != whoAmI || Main.projectile[j].type != 226)
			{
				continue;
			}
			petalTimer = 50;
			float num6 = 12f;
			Vector2 vector3 = new Vector2(Main.projectile[j].position.X + (float)width * 0.5f, Main.projectile[j].position.Y + (float)height * 0.5f);
			float num7 = x - vector3.X;
			float num8 = y - vector3.Y;
			float num9 = (float)Math.Sqrt(num7 * num7 + num8 * num8);
			int num10 = 180;
			float num11 = num6 * (float)num10;
			if (!(num9 >= num11))
			{
				num9 = num6 / num9;
				num7 *= num9;
				num8 *= num9;
				Utils.ChaseResults chaseResults = Utils.GetChaseResults(Main.projectile[j].Center, num6 * (float)num10, victim.Center, victim.velocity);
				if (chaseResults.InterceptionHappens && chaseResults.InterceptionTime <= 180f)
				{
					Vector2 vector4 = chaseResults.ChaserVelocity / num10;
					num7 = vector4.X;
					num8 = vector4.Y;
				}
				Projectile.NewProjectile(GetProjectileSource_SetBonus(6), Main.projectile[j].Center.X - 4f, Main.projectile[j].Center.Y, num7, num8, 227, crystalLeafDamage, crystalLeafKB, whoAmI);
				break;
			}
		}
	}

	public void OpenPresent(int itemType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(itemType);
		if (Main.rand.Next(15) == 0 && Main.hardMode)
		{
			QuickSpawnItem(itemSource_OpenItem, 602);
		}
		else if (Main.rand.Next(30) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1922);
		}
		else if (Main.rand.Next(400) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1927);
		}
		else if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1870);
			QuickSpawnItem(itemSource_OpenItem, 97, Main.rand.Next(30, 61));
		}
		else if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1909);
		}
		else if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1917);
		}
		else if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1915);
		}
		else if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1918);
		}
		else if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1921);
		}
		else if (Main.rand.Next(300) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1923);
		}
		else if (Main.rand.Next(40) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1907);
		}
		else if (Main.rand.Next(10) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1908);
		}
		else if (Main.rand.Next(15) == 0)
		{
			switch (Main.rand.Next(5))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 1932);
				QuickSpawnItem(itemSource_OpenItem, 1933);
				QuickSpawnItem(itemSource_OpenItem, 1934);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 1935);
				QuickSpawnItem(itemSource_OpenItem, 1936);
				QuickSpawnItem(itemSource_OpenItem, 1937);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 1940);
				QuickSpawnItem(itemSource_OpenItem, 1941);
				QuickSpawnItem(itemSource_OpenItem, 1942);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 1938);
				break;
			case 4:
				QuickSpawnItem(itemSource_OpenItem, 1939);
				break;
			}
		}
		else if (Main.rand.Next(7) == 0)
		{
			int num = Main.rand.Next(3);
			if (num == 0)
			{
				num = 1911;
			}
			if (num == 1)
			{
				num = 1919;
			}
			if (num == 2)
			{
				num = 1920;
			}
			QuickSpawnItem(itemSource_OpenItem, num);
		}
		else if (Main.rand.Next(8) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1912, Main.rand.Next(1, 4));
		}
		else if (Main.rand.Next(9) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1913, Main.rand.Next(20, 41));
		}
		else
		{
			switch (Main.rand.Next(3))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 1872, Main.rand.Next(20, 50));
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 586, Main.rand.Next(20, 50));
				break;
			default:
				QuickSpawnItem(itemSource_OpenItem, 591, Main.rand.Next(20, 50));
				break;
			}
		}
	}

	public void OpenLegacyPresent(int itemType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(itemType);
		int num = Main.rand.Next(14);
		if (num == 0 && Main.hardMode)
		{
			QuickSpawnItem(itemSource_OpenItem, 602);
		}
		else if (num <= 7)
		{
			QuickSpawnItem(itemSource_OpenItem, 586, Main.rand.Next(20, 50));
		}
		else
		{
			QuickSpawnItem(itemSource_OpenItem, 591, Main.rand.Next(20, 50));
		}
	}

	public void QuickSpawnItem(IEntitySource source, int item, int stack = 1)
	{
		if (stack > 0)
		{
			Item item2 = new Item();
			item2.SetDefaults(item);
			item2.Prefix(-1);
			item2.stack = stack;
			QuickSpawnItem(source, item2);
		}
	}

	public void QuickSpawnItem(IEntitySource source, Item item)
	{
		QuickSpawnItem(source, item, GetItemSettings.PickupItemFromWorld);
	}

	public void QuickSpawnItem(IEntitySource source, Item item, GetItemSettings settings)
	{
		item.newAndShiny = ItemSlot.Options.HighlightNewItems && !ItemID.Sets.NeverAppearsAsNewInInventory[item.type];
		GetOrDropItem(item, settings);
	}

	public void GetOrDropItem(Item item, GetItemSettings settings)
	{
		Item item2 = GetItem(item, settings);
		if (!item2.IsAir)
		{
			int num = Item.NewItem(GetItemSource_InventoryOverflow(), (int)position.X, (int)position.Y, width, height, item2.type, item2.stack, noBroadcast: false, item2.prefix, noGrabDelay: true);
			Main.item[num].newAndShiny = item.newAndShiny;
			settings.HandlePostAction(Main.item[num].inner);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(21, -1, -1, null, num, 1f);
			}
		}
	}

	public void OpenBossBag(int type)
	{
		bool masterMode = Main.masterMode;
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(type);
		switch (type)
		{
		case 3318:
		{
			if (Main.rand.Next(2) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2430);
			}
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2493);
			}
			int num8 = Main.rand.Next(256, 259);
			int num9;
			for (num9 = Main.rand.Next(256, 259); num9 == num8; num9 = Main.rand.Next(256, 259))
			{
			}
			QuickSpawnItem(itemSource_OpenItem, num8);
			QuickSpawnItem(itemSource_OpenItem, num9);
			if (Main.rand.Next(2) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2610);
			}
			else
			{
				QuickSpawnItem(itemSource_OpenItem, 2585);
			}
			QuickSpawnItem(itemSource_OpenItem, 998);
			if (Main.rand.Next(30) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1309);
			}
			QuickSpawnItem(itemSource_OpenItem, 3090);
			break;
		}
		case 3319:
		{
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2112);
			}
			if (Main.rand.Next(30) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1299);
			}
			short item = (short)(WorldGen.crimson ? 880 : 56);
			int num7 = Main.rand.Next(21) + 10;
			num7 += Main.rand.Next(21) + 10;
			num7 += Main.rand.Next(21) + 10;
			QuickSpawnItem(itemSource_OpenItem, item, num7);
			item = (short)(WorldGen.crimson ? 2171 : 59);
			num7 = Main.rand.Next(3) + 1;
			QuickSpawnItem(itemSource_OpenItem, item, num7);
			num7 = Main.rand.Next(31) + 20;
			QuickSpawnItem(itemSource_OpenItem, 47, num7);
			QuickSpawnItem(itemSource_OpenItem, 3097);
			break;
		}
		case 3320:
		{
			int num4 = Main.rand.Next(15, 30);
			if (masterMode)
			{
				num4 = Main.rand.Next(110, 136);
				QuickSpawnItem(itemSource_OpenItem, 56, num4);
			}
			else
			{
				num4 = Main.rand.Next(80, 111);
				QuickSpawnItem(itemSource_OpenItem, 56, num4);
			}
			if (masterMode)
			{
				num4 = Main.rand.Next(30, 51);
				QuickSpawnItem(itemSource_OpenItem, 86, num4);
			}
			else
			{
				num4 = Main.rand.Next(20, 41);
				QuickSpawnItem(itemSource_OpenItem, 86, num4);
			}
			if (Main.rand.Next(20) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 994);
			}
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2111);
			}
			QuickSpawnItem(itemSource_OpenItem, 3224);
			break;
		}
		case 3321:
		{
			int num3 = Main.rand.Next(20, 46);
			if (masterMode)
			{
				num3 = Main.rand.Next(110, 136);
				QuickSpawnItem(itemSource_OpenItem, 880, num3);
			}
			else
			{
				num3 = Main.rand.Next(80, 111);
				QuickSpawnItem(itemSource_OpenItem, 880, num3);
			}
			if (masterMode)
			{
				num3 = Main.rand.Next(30, 51);
				QuickSpawnItem(itemSource_OpenItem, 1329, num3);
			}
			else
			{
				num3 = Main.rand.Next(20, 41);
				QuickSpawnItem(itemSource_OpenItem, 1329, num3);
			}
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2104);
			}
			if (Main.rand.Next(20) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 3060);
			}
			QuickSpawnItem(itemSource_OpenItem, 3223);
			break;
		}
		case 3322:
		{
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2108);
			}
			int num5 = Main.rand.Next(3);
			switch (num5)
			{
			case 0:
				num5 = 1121;
				break;
			case 1:
				num5 = 1123;
				break;
			case 2:
				num5 = 2888;
				break;
			}
			QuickSpawnItem(itemSource_OpenItem, num5);
			QuickSpawnItem(itemSource_OpenItem, 3333);
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1132);
			}
			if (Main.rand.Next(9) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1170);
			}
			if (Main.rand.Next(9) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2502);
			}
			if (Main.rand.Next(9) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5483);
			}
			QuickSpawnItem(itemSource_OpenItem, 1129);
			QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(842, 845));
			QuickSpawnItem(itemSource_OpenItem, 1130, Main.rand.Next(10, 31));
			QuickSpawnItem(itemSource_OpenItem, 2431, Main.rand.Next(17, 31));
			break;
		}
		case 3323:
			QuickSpawnItem(itemSource_OpenItem, 3245);
			switch (Main.rand.Next(3))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 1281);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 1273);
				break;
			default:
				QuickSpawnItem(itemSource_OpenItem, 1313);
				break;
			}
			break;
		case 3324:
		{
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2105);
			}
			QuickSpawnItem(itemSource_OpenItem, 367);
			if (!extraAccessory)
			{
				QuickSpawnItem(itemSource_OpenItem, 3335);
			}
			int num6 = Main.rand.Next(4);
			num6 = ((num6 != 3) ? (489 + num6) : 2998);
			QuickSpawnItem(itemSource_OpenItem, num6);
			switch (Main.rand.Next(4))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 514);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 426);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 434);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 4912);
				break;
			}
			break;
		}
		case 3325:
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2113);
			}
			QuickSpawnItem(itemSource_OpenItem, 548, Main.rand.Next(25, 41));
			QuickSpawnItem(itemSource_OpenItem, 1225, Main.rand.Next(20, 36));
			QuickSpawnItem(itemSource_OpenItem, 3355);
			break;
		case 3326:
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2106);
			}
			QuickSpawnItem(itemSource_OpenItem, 549, Main.rand.Next(25, 41));
			QuickSpawnItem(itemSource_OpenItem, 1225, Main.rand.Next(20, 36));
			QuickSpawnItem(itemSource_OpenItem, 3354);
			break;
		case 3327:
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2107);
			}
			QuickSpawnItem(itemSource_OpenItem, 547, Main.rand.Next(25, 41));
			QuickSpawnItem(itemSource_OpenItem, 1225, Main.rand.Next(20, 36));
			QuickSpawnItem(itemSource_OpenItem, 3356);
			break;
		case 3328:
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2109);
			}
			QuickSpawnItem(itemSource_OpenItem, 1141);
			QuickSpawnItem(itemSource_OpenItem, 3336);
			if (Main.rand.Next(15) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1182);
			}
			if (Main.rand.Next(20) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1305);
			}
			if (Main.rand.Next(2) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1157);
			}
			if (Main.rand.Next(10) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 3021);
			}
			switch (Main.rand.Next(8))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 758);
				QuickSpawnItem(itemSource_OpenItem, 771, Main.rand.Next(50, 151));
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 1255);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 788);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 1178);
				break;
			case 4:
				QuickSpawnItem(itemSource_OpenItem, 1259);
				break;
			case 5:
				QuickSpawnItem(itemSource_OpenItem, 1155);
				break;
			case 6:
				QuickSpawnItem(itemSource_OpenItem, 3018);
				break;
			case 7:
				QuickSpawnItem(itemSource_OpenItem, 5477);
				break;
			}
			break;
		case 3329:
			TryGettingDevArmor(itemSource_OpenItem);
			QuickSpawnItem(itemSource_OpenItem, 3337);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2110);
			}
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 1294);
			}
			switch (Main.rand.Next(7))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 1258);
				QuickSpawnItem(itemSource_OpenItem, 1261, Main.rand.Next(60, 181));
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 1122);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 899);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 1248);
				break;
			case 4:
				QuickSpawnItem(itemSource_OpenItem, 1295);
				break;
			case 5:
				QuickSpawnItem(itemSource_OpenItem, 1296);
				break;
			default:
				QuickSpawnItem(itemSource_OpenItem, 1297);
				break;
			}
			QuickSpawnItem(itemSource_OpenItem, 2218, Main.rand.Next(18, 24));
			break;
		case 3330:
			TryGettingDevArmor(itemSource_OpenItem);
			QuickSpawnItem(itemSource_OpenItem, 3367);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2588);
			}
			if (Main.rand.Next(10) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 2609);
			}
			switch (Main.rand.Next(6))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 5526);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 2624);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 2622);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 2621);
				break;
			case 4:
				QuickSpawnItem(itemSource_OpenItem, 5478);
				break;
			case 5:
				if (Main.remixWorld)
				{
					QuickSpawnItem(itemSource_OpenItem, 157);
				}
				else
				{
					QuickSpawnItem(itemSource_OpenItem, 2623);
				}
				break;
			}
			break;
		case 3331:
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 3372);
			}
			break;
		case 3860:
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 3863);
			}
			switch (Main.rand.Next(4))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 3859);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 3827);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 3870);
				break;
			default:
				QuickSpawnItem(itemSource_OpenItem, 3858);
				break;
			}
			if (Main.rand.Next(4) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 3883);
			}
			QuickSpawnItem(itemSource_OpenItem, 3817, Main.rand.Next(30, 51));
			break;
		case 4782:
			TryGettingDevArmor(itemSource_OpenItem);
			QuickSpawnItem(itemSource_OpenItem, 4989);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4784);
			}
			if (Main.rand.Next(10) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4823);
			}
			if (Main.rand.Next(20) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4715);
			}
			if (Main.rand.Next(4) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4778, 3);
			}
			if (Main.rand.Next(20) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5075);
			}
			switch (Main.rand.Next(4))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 4923);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 4952);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 4953);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 4914);
				break;
			}
			break;
		case 4957:
		{
			QuickSpawnItem(itemSource_OpenItem, 4987);
			QuickSpawnItem(itemSource_OpenItem, 4986, Main.rand.Next(25, 76));
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4959);
			}
			if (Main.rand.Next(2) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4981);
			}
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4758);
			}
			if (Main.rand.Next(2) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4980);
			}
			int num = Main.rand.Next(4982, 4985);
			int num2 = Main.rand.Next(4982, 4985);
			while (num2 == num)
			{
				num = Main.rand.Next(4982, 4985);
			}
			QuickSpawnItem(itemSource_OpenItem, num);
			QuickSpawnItem(itemSource_OpenItem, num2);
			break;
		}
		}
		switch (type)
		{
		case 5111:
			QuickSpawnItem(itemSource_OpenItem, 5100);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5109);
			}
			if (Main.rand.Next(14) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5385);
			}
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5098);
			}
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5101);
			}
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5113);
			}
			switch (Main.rand.Next(4))
			{
			case 0:
				QuickSpawnItem(itemSource_OpenItem, 5117);
				break;
			case 1:
				QuickSpawnItem(itemSource_OpenItem, 5118);
				break;
			case 2:
				QuickSpawnItem(itemSource_OpenItem, 5119);
				break;
			case 3:
				QuickSpawnItem(itemSource_OpenItem, 5095);
				break;
			}
			break;
		case 3332:
		{
			TryGettingDevArmor(itemSource_OpenItem);
			if (Main.rand.Next(7) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 3373);
			}
			if (Main.rand.Next(10) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4469);
			}
			if (!HasItem(3384))
			{
				QuickSpawnItem(itemSource_OpenItem, 3384);
			}
			QuickSpawnItem(itemSource_OpenItem, 3460, Main.rand.Next(90, 111));
			QuickSpawnItem(itemSource_OpenItem, 1131);
			QuickSpawnItem(itemSource_OpenItem, 3577);
			QuickSpawnItem(itemSource_OpenItem, 4954);
			List<int> list = new List<int> { 3063, 3389, 3065, 1553, 3930, 3541, 3570, 3571, 3569, 5480 };
			for (int i = 0; i < 2; i++)
			{
				int index = Main.rand.Next(list.Count);
				int item2 = list[index];
				QuickSpawnItem(itemSource_OpenItem, item2);
				list.RemoveAt(index);
			}
			break;
		}
		}
		int num10 = -1;
		if (type == 3318)
		{
			num10 = 50;
		}
		if (type == 3319)
		{
			num10 = 4;
		}
		if (type == 3320)
		{
			num10 = 13;
		}
		if (type == 3321)
		{
			num10 = 266;
		}
		if (type == 3322)
		{
			num10 = 222;
		}
		if (type == 3323)
		{
			num10 = 35;
		}
		if (type == 3324)
		{
			num10 = 113;
		}
		if (type == 3325)
		{
			num10 = 134;
		}
		if (type == 3326)
		{
			num10 = 125;
		}
		if (type == 3327)
		{
			num10 = 127;
		}
		if (type == 3328)
		{
			num10 = 262;
		}
		if (type == 3329)
		{
			num10 = 245;
		}
		if (type == 3330)
		{
			num10 = 370;
		}
		if (type == 3331)
		{
			num10 = 439;
		}
		if (type == 3332)
		{
			num10 = 398;
		}
		if (type == 3860)
		{
			num10 = 551;
		}
		if (type == 3861)
		{
			num10 = 576;
		}
		if (type == 3862)
		{
			num10 = 564;
		}
		if (type == 4782)
		{
			num10 = 636;
		}
		if (type == 4957)
		{
			num10 = 657;
		}
		if (type == 5111)
		{
			num10 = 668;
		}
		if (num10 <= 0)
		{
			return;
		}
		NPC nPC = new NPC();
		nPC.SetDefaults(num10);
		float value = nPC.value;
		value *= 1f + (float)Main.rand.Next(-20, 21) * 0.01f;
		if (Main.rand.Next(5) == 0)
		{
			value *= 1f + (float)Main.rand.Next(5, 11) * 0.01f;
		}
		if (Main.rand.Next(10) == 0)
		{
			value *= 1f + (float)Main.rand.Next(10, 21) * 0.01f;
		}
		if (Main.rand.Next(15) == 0)
		{
			value *= 1f + (float)Main.rand.Next(15, 31) * 0.01f;
		}
		if (Main.rand.Next(20) == 0)
		{
			value *= 1f + (float)Main.rand.Next(20, 41) * 0.01f;
		}
		while ((int)value > 0)
		{
			if (value > 1000000f)
			{
				int num11 = (int)(value / 1000000f);
				value -= (float)(1000000 * num11);
				QuickSpawnItem(itemSource_OpenItem, 74, num11);
				continue;
			}
			if (value > 10000f)
			{
				int num12 = (int)(value / 10000f);
				value -= (float)(10000 * num12);
				QuickSpawnItem(itemSource_OpenItem, 73, num12);
				continue;
			}
			if (value > 100f)
			{
				int num13 = (int)(value / 100f);
				value -= (float)(100 * num13);
				QuickSpawnItem(itemSource_OpenItem, 72, num13);
				continue;
			}
			int num14 = (int)value;
			if (num14 < 1)
			{
				num14 = 1;
			}
			value -= (float)num14;
			QuickSpawnItem(itemSource_OpenItem, 71, num14);
		}
	}

	private void TryGettingDevArmor(IEntitySource source)
	{
		if (Main.rand.Next(Main.tenthAnniversaryWorld ? 8 : 16) == 0)
		{
			switch (Main.rand.Next(21))
			{
			case 0:
				QuickSpawnItem(source, 666);
				QuickSpawnItem(source, 667);
				QuickSpawnItem(source, 668);
				QuickSpawnItem(source, 665);
				QuickSpawnItem(source, 3287);
				break;
			case 1:
				QuickSpawnItem(source, 1554);
				QuickSpawnItem(source, 1555);
				QuickSpawnItem(source, 1556);
				QuickSpawnItem(source, 1586);
				break;
			case 2:
				QuickSpawnItem(source, 1554);
				QuickSpawnItem(source, 1587);
				QuickSpawnItem(source, 1588);
				QuickSpawnItem(source, 1586);
				break;
			case 3:
				QuickSpawnItem(source, 1557);
				QuickSpawnItem(source, 1558);
				QuickSpawnItem(source, 1559);
				QuickSpawnItem(source, 1585);
				break;
			case 4:
				QuickSpawnItem(source, 1560);
				QuickSpawnItem(source, 1561);
				QuickSpawnItem(source, 1562);
				QuickSpawnItem(source, 1584);
				break;
			case 5:
				QuickSpawnItem(source, 1563);
				QuickSpawnItem(source, 1564);
				QuickSpawnItem(source, 1565);
				QuickSpawnItem(source, 3582);
				break;
			case 6:
				QuickSpawnItem(source, 1566);
				QuickSpawnItem(source, 1567);
				QuickSpawnItem(source, 1568);
				break;
			case 7:
				QuickSpawnItem(source, 1580);
				QuickSpawnItem(source, 1581);
				QuickSpawnItem(source, 1582);
				QuickSpawnItem(source, 1583);
				break;
			case 8:
				QuickSpawnItem(source, 3226);
				QuickSpawnItem(source, 3227);
				QuickSpawnItem(source, 3228);
				QuickSpawnItem(source, 3288);
				break;
			case 9:
				QuickSpawnItem(source, 3583);
				QuickSpawnItem(source, 3581);
				QuickSpawnItem(source, 3578);
				QuickSpawnItem(source, 3579);
				QuickSpawnItem(source, 3580);
				break;
			case 10:
				QuickSpawnItem(source, 3585);
				QuickSpawnItem(source, 3586);
				QuickSpawnItem(source, 3587);
				QuickSpawnItem(source, 3588);
				QuickSpawnItem(source, 3024, 4);
				break;
			case 11:
				QuickSpawnItem(source, 3589);
				QuickSpawnItem(source, 3590);
				QuickSpawnItem(source, 3591);
				QuickSpawnItem(source, 3592);
				QuickSpawnItem(source, 3599, 4);
				break;
			case 12:
				QuickSpawnItem(source, 3368);
				QuickSpawnItem(source, 3921);
				QuickSpawnItem(source, 3922);
				QuickSpawnItem(source, 3923);
				QuickSpawnItem(source, 3924);
				break;
			case 13:
				QuickSpawnItem(source, 3925);
				QuickSpawnItem(source, 3926);
				QuickSpawnItem(source, 3927);
				QuickSpawnItem(source, 3928);
				QuickSpawnItem(source, 3929);
				break;
			case 14:
				QuickSpawnItem(source, 4732);
				QuickSpawnItem(source, 4733);
				QuickSpawnItem(source, 4734);
				QuickSpawnItem(source, 4730);
				break;
			case 15:
				QuickSpawnItem(source, 4747);
				QuickSpawnItem(source, 4748);
				QuickSpawnItem(source, 4749);
				QuickSpawnItem(source, 4746);
				break;
			case 16:
				QuickSpawnItem(source, 4751);
				QuickSpawnItem(source, 4752);
				QuickSpawnItem(source, 4753);
				QuickSpawnItem(source, 4750);
				break;
			case 17:
				QuickSpawnItem(source, 4755);
				QuickSpawnItem(source, 4756);
				QuickSpawnItem(source, 4757);
				QuickSpawnItem(source, 4754);
				break;
			case 18:
				QuickSpawnItem(source, 5583);
				QuickSpawnItem(source, 5584);
				QuickSpawnItem(source, 5585);
				QuickSpawnItem(source, 5586);
				QuickSpawnItem(source, 5587);
				break;
			case 19:
				QuickSpawnItem(source, 5683);
				QuickSpawnItem(source, 5684);
				QuickSpawnItem(source, 5685);
				QuickSpawnItem(source, 5686);
				break;
			case 20:
				QuickSpawnItem(source, 6137);
				QuickSpawnItem(source, 6138);
				QuickSpawnItem(source, 6139);
				QuickSpawnItem(source, 6140);
				QuickSpawnItem(source, 6141);
				break;
			}
		}
	}

	public void OpenFishingCrate(int crateItemID)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(crateItemID);
		bool flag = ItemID.Sets.IsFishingCrateHardmode[crateItemID];
		switch (crateItemID)
		{
		case 2334:
		case 3979:
		{
			bool flag3 = true;
			while (flag3)
			{
				if (flag && flag3 && Main.rand.Next(200) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3064);
					flag3 = false;
				}
				if (flag3 && Main.rand.Next(40) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3200);
					flag3 = false;
				}
				if (flag3 && Main.rand.Next(40) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3201);
					flag3 = false;
				}
				if (flag && flag3 && Main.rand.Next(25) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 2424);
					flag3 = false;
				}
				if (Main.rand.Next(20) == 0)
				{
					int num4 = Main.rand.Next(5);
					switch (num4)
					{
					case 0:
						num4 = 285;
						break;
					case 1:
						num4 = 953;
						break;
					case 2:
						num4 = 4341;
						break;
					case 3:
						num4 = 3068;
						break;
					case 4:
						num4 = 3084;
						break;
					}
					QuickSpawnItem(itemSource_OpenItem, num4);
					flag3 = false;
				}
				if (!flag && flag3 && Main.rand.Next(50) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 997);
					flag3 = false;
				}
				if (Main.rand.Next(7) == 0)
				{
					int item4;
					int stack7;
					if (Main.rand.Next(3) == 0)
					{
						item4 = 73;
						stack7 = Main.rand.Next(1, 6);
					}
					else
					{
						item4 = 72;
						stack7 = Main.rand.Next(20, 91);
					}
					QuickSpawnItem(itemSource_OpenItem, item4, stack7);
					flag3 = false;
				}
				if (Main.rand.Next(7) == 0)
				{
					int num5 = Main.rand.Next(4);
					switch (num5)
					{
					case 0:
						num5 = 12;
						break;
					case 1:
						num5 = 699;
						break;
					case 2:
						num5 = 11;
						break;
					case 3:
						num5 = 700;
						break;
					}
					if (Main.rand.Next(2) == 0 && flag)
					{
						num5 = Main.rand.Next(2);
						switch (num5)
						{
						case 0:
							num5 = 364;
							break;
						case 1:
							num5 = 1104;
							break;
						}
					}
					int stack8 = Main.rand.Next(4, 16);
					QuickSpawnItem(itemSource_OpenItem, num5, stack8);
					flag3 = false;
				}
				else if (Main.rand.Next(8) == 0)
				{
					int num6 = Main.rand.Next(4);
					switch (num6)
					{
					case 0:
						num6 = 20;
						break;
					case 1:
						num6 = 703;
						break;
					case 2:
						num6 = 22;
						break;
					case 3:
						num6 = 704;
						break;
					case 4:
						num6 = 21;
						break;
					case 5:
						num6 = 705;
						break;
					case 6:
						num6 = 19;
						break;
					case 7:
						num6 = 706;
						break;
					}
					int stack9 = Main.rand.Next(2, 6);
					if (Main.rand.Next(2) == 0 && flag)
					{
						num6 = Main.rand.Next(2);
						switch (num6)
						{
						case 0:
							num6 = 381;
							break;
						case 1:
							num6 = 1184;
							break;
						case 2:
							num6 = 382;
							break;
						case 3:
							num6 = 1191;
							break;
						case 4:
							num6 = 391;
							break;
						case 5:
							num6 = 1198;
							break;
						}
						stack9 = Main.rand.Next(2, 4);
					}
					QuickSpawnItem(itemSource_OpenItem, num6, stack9);
					flag3 = false;
				}
				if (Main.rand.Next(7) == 0)
				{
					int num7 = Main.rand.Next(10);
					switch (num7)
					{
					case 0:
						num7 = 288;
						break;
					case 1:
						num7 = 290;
						break;
					case 2:
						num7 = 292;
						break;
					case 3:
						num7 = 299;
						break;
					case 4:
						num7 = 298;
						break;
					case 5:
						num7 = 304;
						break;
					case 6:
						num7 = 291;
						break;
					case 7:
						num7 = 2322;
						break;
					case 8:
						num7 = 2323;
						break;
					case 9:
						num7 = 2329;
						break;
					}
					int stack10 = Main.rand.Next(1, 4);
					QuickSpawnItem(itemSource_OpenItem, num7, stack10);
					flag3 = false;
				}
			}
			if (Main.rand.Next(3) == 0)
			{
				int num8 = Main.rand.Next(2);
				switch (num8)
				{
				case 0:
					num8 = 28;
					break;
				case 1:
					num8 = 110;
					break;
				}
				int stack11 = Main.rand.Next(5, 16);
				QuickSpawnItem(itemSource_OpenItem, num8, stack11);
			}
			if (Main.rand.Next(3) == 0)
			{
				int item5 = ((Main.rand.Next(3) != 0) ? 2674 : 2675);
				int stack12 = Main.rand.Next(1, 5);
				QuickSpawnItem(itemSource_OpenItem, item5, stack12);
			}
			return;
		}
		case 2335:
		case 3980:
		{
			bool flag4 = true;
			while (flag4)
			{
				if (flag && flag4 && Main.rand.Next(60) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3064);
					flag4 = false;
				}
				if (flag4 && Main.rand.Next(25) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 2501);
					flag4 = false;
				}
				if (flag4 && Main.rand.Next(20) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 2587);
					flag4 = false;
				}
				if (flag4 && Main.rand.Next(15) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 2608);
					flag4 = false;
				}
				if (flag4 && Main.rand.Next(20) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3200);
					flag4 = false;
				}
				if (flag4 && Main.rand.Next(20) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3201);
					flag4 = false;
				}
				if (Main.rand.Next(4) == 0)
				{
					int item6 = 73;
					int stack13 = Main.rand.Next(5, 11);
					QuickSpawnItem(itemSource_OpenItem, item6, stack13);
					flag4 = false;
				}
				if (Main.rand.Next(6) == 0)
				{
					int num9 = Main.rand.Next(6);
					switch (num9)
					{
					case 0:
						num9 = 12;
						break;
					case 1:
						num9 = 699;
						break;
					case 2:
						num9 = 11;
						break;
					case 3:
						num9 = 700;
						break;
					case 4:
						num9 = 14;
						break;
					case 5:
						num9 = 701;
						break;
					}
					if (Main.rand.Next(2) == 0 && flag)
					{
						num9 = Main.rand.Next(4);
						switch (num9)
						{
						case 0:
							num9 = 364;
							break;
						case 1:
							num9 = 1104;
							break;
						case 2:
							num9 = 365;
							break;
						case 3:
							num9 = 1105;
							break;
						}
					}
					int stack14 = Main.rand.Next(12, 22);
					QuickSpawnItem(itemSource_OpenItem, num9, stack14);
					flag4 = false;
				}
				else if (Main.rand.Next(4) == 0)
				{
					int num10 = Main.rand.Next(6);
					switch (num10)
					{
					case 0:
						num10 = 20;
						break;
					case 1:
						num10 = 703;
						break;
					case 2:
						num10 = 22;
						break;
					case 3:
						num10 = 704;
						break;
					case 4:
						num10 = 21;
						break;
					case 5:
						num10 = 705;
						break;
					}
					int num11 = Main.rand.Next(4, 8);
					if (Main.rand.Next(3) != 0 && flag)
					{
						num10 = Main.rand.Next(4);
						switch (num10)
						{
						case 0:
							num10 = 381;
							break;
						case 1:
							num10 = 1184;
							break;
						case 2:
							num10 = 382;
							break;
						case 3:
							num10 = 1191;
							break;
						}
						num11 -= Main.rand.Next(2);
					}
					QuickSpawnItem(itemSource_OpenItem, num10, num11);
					flag4 = false;
				}
				if (Main.rand.Next(4) == 0)
				{
					int num12 = Main.rand.Next(8);
					switch (num12)
					{
					case 0:
						num12 = 288;
						break;
					case 1:
						num12 = 296;
						break;
					case 2:
						num12 = 304;
						break;
					case 3:
						num12 = 305;
						break;
					case 4:
						num12 = 2322;
						break;
					case 5:
						num12 = 2323;
						break;
					case 6:
						num12 = 2324;
						break;
					case 7:
						num12 = 2327;
						break;
					}
					int stack15 = Main.rand.Next(2, 5);
					QuickSpawnItem(itemSource_OpenItem, num12, stack15);
					flag4 = false;
				}
			}
			if (Main.rand.Next(2) == 0)
			{
				int item7 = Main.rand.Next(188, 190);
				int stack16 = Main.rand.Next(5, 16);
				QuickSpawnItem(itemSource_OpenItem, item7, stack16);
			}
			if (Main.rand.Next(2) == 0)
			{
				int item8 = ((Main.rand.Next(3) != 0) ? 2675 : 2676);
				int stack17 = Main.rand.Next(2, 5);
				QuickSpawnItem(itemSource_OpenItem, item8, stack17);
			}
			return;
		}
		case 2336:
		case 3981:
		{
			bool flag2 = true;
			while (flag2)
			{
				if (flag && flag2 && Main.rand.Next(20) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 3064);
					flag2 = false;
				}
				if (flag2 && Main.rand.Next(8) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 29);
					flag2 = false;
				}
				if (flag2 && Main.rand.Next(10) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 2491);
					flag2 = false;
				}
				if (Main.rand.Next(3) == 0)
				{
					int item = 73;
					int stack = Main.rand.Next(8, 21);
					QuickSpawnItem(itemSource_OpenItem, item, stack);
					flag2 = false;
				}
				if (Main.rand.Next(5) == 0)
				{
					int num = Main.rand.Next(4);
					switch (num)
					{
					case 0:
						num = 14;
						break;
					case 1:
						num = 701;
						break;
					case 2:
						num = 13;
						break;
					case 3:
						num = 702;
						break;
					}
					if (Main.rand.Next(2) == 0 && flag)
					{
						num = Main.rand.Next(4);
						switch (num)
						{
						case 0:
							num = 365;
							break;
						case 1:
							num = 1105;
							break;
						case 2:
							num = 366;
							break;
						case 3:
							num = 1106;
							break;
						}
					}
					int stack2 = Main.rand.Next(25, 35);
					QuickSpawnItem(itemSource_OpenItem, num, stack2);
					flag2 = false;
				}
				else
				{
					if (Main.rand.Next(3) != 0)
					{
						continue;
					}
					int num2 = Main.rand.Next(4);
					switch (num2)
					{
					case 0:
						num2 = 21;
						break;
					case 1:
						num2 = 19;
						break;
					case 2:
						num2 = 705;
						break;
					case 3:
						num2 = 706;
						break;
					}
					if (Main.rand.Next(3) != 0 && flag)
					{
						num2 = Main.rand.Next(4);
						switch (num2)
						{
						case 0:
							num2 = 382;
							break;
						case 1:
							num2 = 391;
							break;
						case 2:
							num2 = 1191;
							break;
						case 3:
							num2 = 1198;
							break;
						}
					}
					int stack3 = Main.rand.Next(8, 12);
					QuickSpawnItem(itemSource_OpenItem, num2, stack3);
					flag2 = false;
				}
			}
			if (Main.rand.Next(3) == 0)
			{
				int num3 = Main.rand.Next(5);
				switch (num3)
				{
				case 0:
					num3 = 288;
					break;
				case 1:
					num3 = 296;
					break;
				case 2:
					num3 = 305;
					break;
				case 3:
					num3 = 2322;
					break;
				case 4:
					num3 = 2323;
					break;
				}
				int stack4 = Main.rand.Next(2, 6);
				QuickSpawnItem(itemSource_OpenItem, num3, stack4);
			}
			if (Main.rand.Next(2) == 0)
			{
				int item2 = Main.rand.Next(188, 190);
				int stack5 = Main.rand.Next(5, 21);
				QuickSpawnItem(itemSource_OpenItem, item2, stack5);
			}
			if (Main.rand.Next(3) != 0)
			{
				int item3 = 2676;
				int stack6 = Main.rand.Next(3, 8);
				QuickSpawnItem(itemSource_OpenItem, item3, stack6);
			}
			if (Main.rand.Next(30) == 0 && !flag)
			{
				QuickSpawnItem(itemSource_OpenItem, 989);
			}
			if (Main.rand.Next(15) == 0 && flag)
			{
				QuickSpawnItem(itemSource_OpenItem, 989);
			}
			return;
		}
		}
		int maxValue = 1;
		bool flag5 = true;
		while (flag5)
		{
			if ((crateItemID == 5002 || crateItemID == 5003) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				int num13 = Main.rand.Next(4);
				num13 = ((Main.rand.Next(10) == 0) ? 863 : (num13 switch
				{
					0 => 186, 
					1 => 4404, 
					2 => 277, 
					_ => 187, 
				}));
				QuickSpawnItem(itemSource_OpenItem, num13);
				flag5 = false;
			}
			if ((crateItemID == 3203 || crateItemID == 3982) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(5) switch
				{
					0 => 162, 
					1 => 111, 
					2 => 96, 
					3 => 115, 
					_ => 64, 
				});
				flag5 = false;
			}
			if ((crateItemID == 3204 || crateItemID == 3983) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(5) switch
				{
					0 => 800, 
					1 => 802, 
					2 => 1256, 
					3 => 1290, 
					_ => 3062, 
				});
				flag5 = false;
			}
			if ((crateItemID == 3205 || crateItemID == 3984) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				int item9 = 3085;
				QuickSpawnItem(itemSource_OpenItem, item9);
				flag5 = false;
				if (Main.rand.Next(2) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 149, Main.rand.Next(5, 16));
				}
				if (Main.rand.Next(2) == 0)
				{
					int item10 = Main.rand.Next(3) switch
					{
						0 => 134, 
						1 => 137, 
						_ => 139, 
					};
					int stack18 = Main.rand.Next(25, 51);
					QuickSpawnItem(itemSource_OpenItem, item10, stack18);
				}
			}
			if ((crateItemID == 3206 || crateItemID == 3985) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(4) switch
				{
					0 => 158, 
					1 => 65, 
					2 => 159, 
					_ => 2219, 
				});
				flag5 = false;
			}
			if ((crateItemID == 3208 || crateItemID == 3987) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				if (Main.rand.Next(20) == 0)
				{
					int num14 = Main.rand.Next(5);
					num14 = 3017;
					QuickSpawnItem(itemSource_OpenItem, num14);
					flag5 = false;
				}
				else
				{
					QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(5) switch
					{
						0 => 212, 
						1 => 964, 
						2 => 211, 
						3 => 213, 
						_ => 2292, 
					});
					flag5 = false;
				}
			}
			if ((crateItemID == 4405 || crateItemID == 4406) && flag5 && Main.rand.Next(maxValue) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(6) switch
				{
					0 => 670, 
					1 => 724, 
					2 => 950, 
					3 => (!Main.remixWorld) ? 1319 : 725, 
					4 => 987, 
					_ => 1579, 
				});
				flag5 = false;
			}
			if (crateItemID == 4407 || crateItemID == 4408)
			{
				if (flag5 && Main.rand.Next(maxValue) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(8) switch
					{
						0 => 4056, 
						1 => 4442, 
						2 => 4055, 
						3 => 4061, 
						4 => 4062, 
						5 => 4276, 
						6 => 4262, 
						_ => 4263, 
					});
					flag5 = false;
				}
				if (Main.rand.Next(4) == 0)
				{
					int item11 = 4423;
					int stack19 = Main.rand.Next(4, 7);
					QuickSpawnItem(itemSource_OpenItem, item11, stack19);
					flag5 = false;
				}
				if (Main.rand.Next(2) == 0)
				{
					int item12 = 3380;
					int stack20 = Main.rand.Next(10, 17);
					QuickSpawnItem(itemSource_OpenItem, item12, stack20);
					flag5 = false;
				}
				if (Main.rand.Next(35) == 0)
				{
					QuickSpawnItem(itemSource_OpenItem, 857);
					flag5 = false;
				}
			}
			if (crateItemID == 4877 || crateItemID == 4878)
			{
				if (flag5 && Main.rand.Next(maxValue) == 0)
				{
					if (Main.rand.Next(20) == 0)
					{
						int num15 = Main.rand.Next(5);
						num15 = 906;
						QuickSpawnItem(itemSource_OpenItem, num15);
						flag5 = false;
					}
					else
					{
						QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(5) switch
						{
							0 => 4822, 
							1 => 4828, 
							2 => 4880, 
							3 => 4881, 
							_ => 4868, 
						});
						flag5 = false;
					}
					if (Main.rand.Next(4) == 0)
					{
						int item13 = 4858;
						int stack21 = 2;
						QuickSpawnItem(itemSource_OpenItem, item13, stack21);
						flag5 = false;
					}
				}
				QuickSpawnItem(itemSource_OpenItem, 4879);
				flag5 = false;
				if (Main.rand.Next(3) == 0)
				{
					int item14 = 4824;
					int stack22 = Main.rand.Next(7, 11);
					QuickSpawnItem(itemSource_OpenItem, item14, stack22);
					flag5 = false;
				}
				if (Main.rand.Next(2) == 0)
				{
					int num16 = Main.rand.Next(5);
					switch (num16)
					{
					case 0:
						num16 = 4902;
						break;
					case 1:
						num16 = 4903;
						break;
					case 2:
						num16 = 4904;
						break;
					case 3:
						num16 = 4905;
						break;
					case 4:
						num16 = 4906;
						break;
					}
					QuickSpawnItem(itemSource_OpenItem, num16);
					flag5 = false;
				}
			}
			if (Main.rand.Next(4) == 0)
			{
				int item15 = 73;
				int stack23 = Main.rand.Next(5, 13);
				QuickSpawnItem(itemSource_OpenItem, item15, stack23);
				flag5 = false;
			}
			if (Main.rand.Next(7) == 0)
			{
				int num17 = Main.rand.Next(8);
				switch (num17)
				{
				case 0:
					num17 = 12;
					break;
				case 1:
					num17 = 699;
					break;
				case 2:
					num17 = 11;
					break;
				case 3:
					num17 = 700;
					break;
				case 4:
					num17 = 14;
					break;
				case 5:
					num17 = 701;
					break;
				case 6:
					num17 = 13;
					break;
				case 7:
					num17 = 702;
					break;
				}
				if (crateItemID == 4877 || crateItemID == 4878)
				{
					num17 = 174;
				}
				if (Main.rand.Next(2) == 0 && flag)
				{
					num17 = Main.rand.Next(6);
					switch (num17)
					{
					case 0:
						num17 = 364;
						break;
					case 1:
						num17 = 1104;
						break;
					case 2:
						num17 = 365;
						break;
					case 3:
						num17 = 1105;
						break;
					case 4:
						num17 = 366;
						break;
					case 5:
						num17 = 1106;
						break;
					}
				}
				int stack24 = Main.rand.Next(20, 36);
				QuickSpawnItem(itemSource_OpenItem, num17, stack24);
				flag5 = false;
			}
			if (Main.rand.Next(4) != 0)
			{
				continue;
			}
			int num18 = Main.rand.Next(6);
			switch (num18)
			{
			case 0:
				num18 = 22;
				break;
			case 1:
				num18 = 21;
				break;
			case 2:
				num18 = 19;
				break;
			case 3:
				num18 = 704;
				break;
			case 4:
				num18 = 705;
				break;
			case 5:
				num18 = 706;
				break;
			}
			int num19 = Main.rand.Next(6, 17);
			if (crateItemID == 4877 || crateItemID == 4878)
			{
				num18 = 175;
			}
			if (Main.rand.Next(3) != 0 && flag)
			{
				num18 = Main.rand.Next(6);
				switch (num18)
				{
				case 0:
					num18 = 381;
					break;
				case 1:
					num18 = 382;
					break;
				case 2:
					num18 = 391;
					break;
				case 3:
					num18 = 1184;
					break;
				case 4:
					num18 = 1191;
					break;
				case 5:
					num18 = 1198;
					break;
				}
				num19 -= Main.rand.Next(2);
			}
			QuickSpawnItem(itemSource_OpenItem, num18, num19);
			flag5 = false;
		}
		if (Main.rand.Next(4) == 0)
		{
			int num20 = Main.rand.Next(6);
			switch (num20)
			{
			case 0:
				num20 = 288;
				break;
			case 1:
				num20 = 296;
				break;
			case 2:
				num20 = 304;
				break;
			case 3:
				num20 = 305;
				break;
			case 4:
				num20 = 2322;
				break;
			case 5:
				num20 = 2323;
				break;
			}
			int stack25 = Main.rand.Next(2, 5);
			QuickSpawnItem(itemSource_OpenItem, num20, stack25);
			flag5 = false;
		}
		if (Main.rand.Next(2) == 0)
		{
			int item16 = Main.rand.Next(188, 190);
			int stack26 = Main.rand.Next(5, 18);
			QuickSpawnItem(itemSource_OpenItem, item16, stack26);
		}
		if (Main.rand.Next(2) == 0)
		{
			int item17 = ((Main.rand.Next(2) != 0) ? 2675 : 2676);
			int stack27 = Main.rand.Next(2, 7);
			QuickSpawnItem(itemSource_OpenItem, item17, stack27);
		}
		if (crateItemID == 5002 || crateItemID == 5003)
		{
			if (Main.rand.Next(5) == 0)
			{
				int item18 = 5527;
				QuickSpawnItem(itemSource_OpenItem, item18);
			}
			if (Main.rand.Next(3) == 0)
			{
				int item19 = 4090;
				int stack28 = Main.rand.Next(20, 51);
				QuickSpawnItem(itemSource_OpenItem, item19, stack28);
			}
			if (Main.rand.Next(10) == 0)
			{
				int item20 = 4460;
				QuickSpawnItem(itemSource_OpenItem, item20);
			}
			if (Main.rand.Next(10) == 0)
			{
				int item21 = 4425;
				QuickSpawnItem(itemSource_OpenItem, item21);
			}
		}
		if ((crateItemID == 3205 || crateItemID == 3984) && Main.rand.Next(2) == 0)
		{
			int num21 = Main.rand.Next(25);
			switch (num21)
			{
			case 0:
				num21 = 1438;
				break;
			case 1:
				num21 = 1375;
				break;
			case 2:
				num21 = 1573;
				break;
			case 3:
				num21 = 1420;
				break;
			case 4:
				num21 = 1435;
				break;
			case 5:
				num21 = 1434;
				break;
			case 6:
				num21 = 1421;
				break;
			case 7:
				num21 = 5234;
				break;
			case 8:
				num21 = 1374;
				break;
			case 9:
				num21 = 1425;
				break;
			case 10:
				num21 = 1372;
				break;
			case 11:
				num21 = 1441;
				break;
			case 12:
				num21 = 1373;
				break;
			case 13:
				num21 = 1433;
				break;
			case 14:
				num21 = 1436;
				break;
			case 15:
				num21 = 1426;
				break;
			case 16:
				num21 = 1424;
				break;
			case 17:
				num21 = 1419;
				break;
			case 18:
				num21 = 2995;
				break;
			case 19:
				num21 = 1422;
				break;
			case 20:
				num21 = 1439;
				break;
			case 21:
				num21 = 1502;
				break;
			case 22:
				num21 = 1423;
				break;
			case 23:
				num21 = 1437;
				break;
			case 24:
				num21 = 1500;
				break;
			}
			QuickSpawnItem(itemSource_OpenItem, num21);
		}
		if (crateItemID == 3208 || crateItemID == 3987)
		{
			if (Main.rand.Next(3) == 0)
			{
				int item22 = 4564;
				int stack29 = Main.rand.Next(20, 51);
				QuickSpawnItem(itemSource_OpenItem, item22, stack29);
			}
			if (Main.rand.Next(20) == 0)
			{
				int item23 = 753;
				QuickSpawnItem(itemSource_OpenItem, item23);
			}
		}
		if ((crateItemID == 4405 || crateItemID == 4406) && Main.rand.Next(20) == 0)
		{
			int item24 = 669;
			QuickSpawnItem(itemSource_OpenItem, item24);
		}
		if ((crateItemID == 4407 || crateItemID == 4408) && Main.rand.Next(2) == 0)
		{
			int num22 = Main.rand.Next(14);
			switch (num22)
			{
			case 0:
				num22 = 4639;
				break;
			case 1:
				num22 = 4627;
				break;
			case 2:
				num22 = 4628;
				break;
			case 3:
				num22 = 4632;
				break;
			case 4:
				num22 = 4630;
				break;
			case 5:
				num22 = 4638;
				break;
			case 6:
				num22 = 4629;
				break;
			case 7:
				num22 = 4633;
				break;
			case 8:
				num22 = 4634;
				break;
			case 9:
				num22 = 4635;
				break;
			case 10:
				num22 = 4636;
				break;
			case 11:
				num22 = 4637;
				break;
			case 12:
				num22 = 4631;
				break;
			case 13:
				num22 = 4626;
				break;
			}
			QuickSpawnItem(itemSource_OpenItem, num22);
		}
		if (crateItemID == 3206 || crateItemID == 3985)
		{
			if (Main.rand.Next(2) == 0)
			{
				int num23 = Main.rand.Next(6);
				switch (num23)
				{
				case 0:
					num23 = 5226;
					break;
				case 1:
					num23 = 5254;
					break;
				case 2:
					num23 = 5238;
					break;
				case 3:
					num23 = 5258;
					break;
				case 4:
					num23 = 5255;
					break;
				case 5:
					num23 = 5388;
					break;
				}
				QuickSpawnItem(itemSource_OpenItem, num23);
			}
			if (Main.rand.Next(2) == 0)
			{
				int item25 = 751;
				int stack30 = Main.rand.Next(50, 101);
				QuickSpawnItem(itemSource_OpenItem, item25, stack30);
			}
			if (Main.rand.Next(40) == 0)
			{
				int item26 = 4978;
				QuickSpawnItem(itemSource_OpenItem, item26);
			}
			if (WorldGen.Skyblock.lowTiles && Main.rand.Next(3) == 0)
			{
				int item27 = 2197;
				QuickSpawnItem(itemSource_OpenItem, item27);
			}
		}
		if (crateItemID == 4877 || crateItemID == 4878)
		{
			if (Main.rand.Next(2) == 0)
			{
				int num24 = Main.rand.Next(12);
				switch (num24)
				{
				case 0:
					num24 = 1497;
					break;
				case 1:
					num24 = 1475;
					break;
				case 2:
					num24 = 1479;
					break;
				case 3:
					num24 = 1542;
					break;
				case 4:
					num24 = 1476;
					break;
				case 5:
					num24 = 1538;
					break;
				case 6:
					num24 = 1501;
					break;
				case 7:
					num24 = 1478;
					break;
				case 8:
					num24 = 1539;
					break;
				case 9:
					num24 = 1540;
					break;
				case 10:
					num24 = 1499;
					break;
				case 11:
					num24 = 1541;
					break;
				}
				QuickSpawnItem(itemSource_OpenItem, num24);
			}
			if (Main.rand.Next(20) == 0)
			{
				int item28 = 221;
				QuickSpawnItem(itemSource_OpenItem, item28);
			}
			if (Main.rand.Next(20) == 0)
			{
				int item29 = 4443;
				QuickSpawnItem(itemSource_OpenItem, item29);
			}
			if (Main.rand.Next(20) == 0)
			{
				int item30 = 4737;
				QuickSpawnItem(itemSource_OpenItem, item30);
			}
			if (Main.rand.Next(20) == 0)
			{
				int item31 = 4551;
				QuickSpawnItem(itemSource_OpenItem, item31);
			}
		}
		if (!flag || (crateItemID != 3982 && crateItemID != 3986 && crateItemID != 3983))
		{
			return;
		}
		if (Main.rand.Next(2) == 0)
		{
			int item32 = 521;
			if (crateItemID == 3986)
			{
				item32 = 520;
			}
			int stack31 = Main.rand.Next(2, 6);
			QuickSpawnItem(itemSource_OpenItem, item32, stack31);
		}
		if (Main.rand.Next(2) == 0)
		{
			int item33 = 522;
			int stack32 = Main.rand.Next(2, 6);
			switch (crateItemID)
			{
			case 3983:
				item33 = 1332;
				break;
			case 3986:
				item33 = 502;
				stack32 = Main.rand.Next(4, 11);
				break;
			}
			QuickSpawnItem(itemSource_OpenItem, item33, stack32);
		}
	}

	public int CountItem(int type, int stopCountingAt = 0)
	{
		int num = 0;
		for (int i = 0; i != 58; i++)
		{
			if (inventory[i].stack > 0 && inventory[i].type == type)
			{
				num += inventory[i].stack;
				if (num >= stopCountingAt)
				{
					return num;
				}
			}
		}
		return num;
	}

	public bool ConsumeItem(int type, bool reverseOrder = false, bool includeVoidBag = false)
	{
		int num = 0;
		int num2 = 58;
		int num3 = 1;
		if (reverseOrder)
		{
			num = 57;
			num2 = -1;
			num3 = -1;
		}
		for (int i = num; i != num2; i += num3)
		{
			if (inventory[i].stack > 0 && inventory[i].type == type)
			{
				inventory[i].stack--;
				if (inventory[i].stack <= 0)
				{
					inventory[i].SetDefaults(0);
				}
				return true;
			}
		}
		if (includeVoidBag && useVoidBag())
		{
			int num4 = FindItem(type, bank4.item);
			if (num4 == -1)
			{
				return false;
			}
			Item item = bank4.item[num4];
			item.stack--;
			if (item.stack <= 0)
			{
				item.TurnToAir();
			}
			return true;
		}
		return false;
	}

	public void OpenShadowLockbox(int boxType)
	{
		bool flag = true;
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(boxType);
		while (flag)
		{
			flag = false;
			int item = Main.rand.NextFromList(new short[5] { 274, 220, 112, 218, 3019 });
			if (Main.remixWorld)
			{
				item = Main.rand.NextFromList(new short[5] { 274, 220, 683, 218, 3019 });
			}
			QuickSpawnItem(itemSource_OpenItem, item);
			if (Main.rand.Next(5) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5010);
			}
		}
	}

	public void OpenLockBox(int lockboxItemType)
	{
		bool flag = true;
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(lockboxItemType);
		while (flag)
		{
			flag = false;
			int num = 0;
			QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(7) switch
			{
				1 => 3317, 
				2 => 155, 
				3 => 156, 
				4 => (!Main.remixWorld) ? 157 : 2623, 
				5 => 163, 
				6 => 113, 
				_ => 164, 
			});
			if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 329);
			}
			if (Main.rand.Next(8) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5465);
			}
			if (Main.getGoodWorld && Main.rand.Next(5) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 5515);
			}
		}
	}

	public void OpenHerbBag(int bagType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(bagType);
		int num = Main.rand.Next(2, 5);
		if (Main.rand.Next(3) == 0)
		{
			num++;
		}
		for (int i = 0; i < num; i++)
		{
			int num2 = Main.rand.Next(14);
			if (num2 == 0)
			{
				num2 = 313;
			}
			if (num2 == 1)
			{
				num2 = 314;
			}
			if (num2 == 2)
			{
				num2 = 315;
			}
			if (num2 == 3)
			{
				num2 = 317;
			}
			if (num2 == 4)
			{
				num2 = 316;
			}
			if (num2 == 5)
			{
				num2 = 318;
			}
			if (num2 == 6)
			{
				num2 = 2358;
			}
			if (num2 == 7)
			{
				num2 = 307;
			}
			if (num2 == 8)
			{
				num2 = 308;
			}
			if (num2 == 9)
			{
				num2 = 309;
			}
			if (num2 == 10)
			{
				num2 = 311;
			}
			if (num2 == 11)
			{
				num2 = 310;
			}
			if (num2 == 12)
			{
				num2 = 312;
			}
			if (num2 == 13)
			{
				num2 = 2357;
			}
			int num3 = Main.rand.Next(2, 5);
			if (Main.rand.Next(3) == 0)
			{
				num3 += Main.rand.Next(1, 5);
			}
			QuickSpawnItem(itemSource_OpenItem, num2, num3);
		}
	}

	public void OpenCanofWorms(int sourceItemType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(sourceItemType);
		QuickSpawnItem(itemSource_OpenItem, 2002, Main.rand.Next(5, 9));
		if (Main.rand.Next(10) < 3)
		{
			QuickSpawnItem(itemSource_OpenItem, 3191, Main.rand.Next(1, 3));
		}
		if (Main.rand.Next(20) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 2895);
		}
	}

	public void OpenOyster(int sourceItemType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(sourceItemType);
		if (Main.rand.Next(4) == 0)
		{
			if (Main.rand.Next(10) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4414);
			}
			else if (Main.rand.Next(3) == 0)
			{
				QuickSpawnItem(itemSource_OpenItem, 4413);
			}
			else
			{
				QuickSpawnItem(itemSource_OpenItem, 4412);
			}
		}
		QuickSpawnItem(itemSource_OpenItem, 4411);
	}

	private void QuickSpawnItem_CostumeSet(IEntitySource source, int item1, int item2, int item3)
	{
		QuickSpawnItem(source, item1);
		QuickSpawnItem(source, item2);
		QuickSpawnItem(source, item3);
	}

	private void QuickSpawnItem_CostumeSet(IEntitySource source, int item1, int item2)
	{
		QuickSpawnItem(source, item1);
		QuickSpawnItem(source, item2);
	}

	public void OpenChilletEgg(int itemType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(itemType);
		short item = 5665;
		if (Main.rand.Next(2) == 0)
		{
			item = 5666;
		}
		QuickSpawnItem(itemSource_OpenItem, item);
	}

	public void OpenGoodieBag(int itemType)
	{
		IEntitySource itemSource_OpenItem = GetItemSource_OpenItem(itemType);
		if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1810);
			return;
		}
		if (Main.rand.Next(150) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1800);
			return;
		}
		if (Main.rand.Next(4) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, 1809, Main.rand.Next(10, 41));
			return;
		}
		if (Main.rand.Next(10) == 0)
		{
			QuickSpawnItem(itemSource_OpenItem, Main.rand.Next(1846, 1851));
			return;
		}
		switch (Main.rand.Next(19))
		{
		case 0:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1749, 1750, 1751);
			break;
		case 1:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1746, 1747, 1748);
			break;
		case 2:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1752, 1753);
			break;
		case 3:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1767, 1768, 1769);
			break;
		case 4:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1770, 1771);
			break;
		case 5:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1772, 1773);
			break;
		case 6:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1754, 1755, 1756);
			break;
		case 7:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1757, 1758, 1759);
			break;
		case 8:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1760, 1761, 1762);
			break;
		case 9:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1763, 1764, 1765);
			break;
		case 10:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1766, 1775, 1776);
			break;
		case 11:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1777, 1778);
			break;
		case 12:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1779, 1780, 1781);
			break;
		case 13:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1819, 1820);
			break;
		case 14:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1821, 1822, 1823);
			break;
		case 15:
			QuickSpawnItem(itemSource_OpenItem, 1824);
			break;
		case 16:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1838, 1839, 1840);
			break;
		case 17:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1841, 1842, 1843);
			break;
		case 18:
			QuickSpawnItem_CostumeSet(itemSource_OpenItem, 1851, 1852);
			break;
		}
	}

	public void UpdateDyes()
	{
		cShieldFallback = -1;
		cHead = (cBody = (cLegs = (cHandOn = (cHandOff = (cBack = (cFront = (cShoe = (cWaist = (cShield = (cNeck = (cFace = (cFaceHead = (cFaceFlower = (cFaceMask = (cBalloon = (cBalloon = (cWings = (cCarpet = (cFloatingTube = (cBackpack = (cTail = 0)))))))))))))))))))));
		cGrapple = (cMount = (cMinecart = (cPet = (cLight = (cYorai = (cPortableStool = (cUnicornHorn = (cAngelHalo = (cBeard = (cMinion = (cLeinShampoo = (cFlameWaker = (cCoat = 0)))))))))))));
		skinDyePacked = 0;
		cHead = dye[0].dye;
		cBody = dye[1].dye;
		cLegs = dye[2].dye;
		if (wearsRobe)
		{
			cLegs = cBody;
		}
		cPet = miscDyes[0].dye;
		cLight = miscDyes[1].dye;
		cMinecart = miscDyes[2].dye;
		cMount = miscDyes[3].dye;
		cGrapple = miscDyes[4].dye;
		for (int i = 0; i < 20; i++)
		{
			if (IsItemSlotUnlockedAndUsable(i))
			{
				int num = i % 10;
				UpdateItemDye(i < 10, hideVisibleAccessory[num], armor[i], dye[num]);
			}
		}
		cYorai = cPet;
	}

	private void UpdateItemDye(bool isNotInVanitySlot, bool isSetToHidden, Item armorItem, Item dyeItem)
	{
		if (armorItem.IsAir)
		{
			return;
		}
		bool num = armorItem.wingSlot > 0 || armorItem.type == 934 || armorItem.type == 4341 || armorItem.type == 5126 || armorItem.type == 4563 || armorItem.type == 1987;
		bool flag = isNotInVanitySlot && isSetToHidden;
		if (armorItem.shieldSlot > 0 && armorItem.shieldSlot < ArmorIDs.Shield.Count && (cShieldFallback == -1 || !flag))
		{
			cShieldFallback = dyeItem.dye;
		}
		if (!num && flag)
		{
			return;
		}
		if (armorItem.handOnSlot > 0 && armorItem.handOnSlot < ArmorIDs.HandOn.Count)
		{
			cHandOn = dyeItem.dye;
		}
		if (armorItem.handOffSlot > 0 && armorItem.handOffSlot < ArmorIDs.HandOff.Count)
		{
			cHandOff = dyeItem.dye;
		}
		if (armorItem.backSlot > 0 && armorItem.backSlot < ArmorIDs.Back.Count)
		{
			if (ArmorIDs.Back.Sets.DrawInBackpackLayer[armorItem.backSlot])
			{
				cBackpack = dyeItem.dye;
			}
			else if (ArmorIDs.Back.Sets.DrawInTailLayer[armorItem.backSlot])
			{
				cTail = dyeItem.dye;
			}
			else
			{
				cBack = dyeItem.dye;
			}
		}
		if (armorItem.frontSlot > 0 && armorItem.frontSlot < ArmorIDs.Front.Count)
		{
			cFront = dyeItem.dye;
		}
		if (armorItem.shoeSlot > 0 && armorItem.shoeSlot < ArmorIDs.Shoe.Count)
		{
			if (armorItem.type == 4874)
			{
				cFlameWaker = dyeItem.dye;
				cShoe = dyeItem.dye;
			}
			else if (armorItem.type == 4822)
			{
				cFlameWaker = dyeItem.dye;
			}
			else
			{
				cShoe = dyeItem.dye;
			}
		}
		if (armorItem.waistSlot > 0 && armorItem.waistSlot < ArmorIDs.Waist.Count)
		{
			cWaist = dyeItem.dye;
		}
		if (armorItem.shieldSlot > 0 && armorItem.shieldSlot < ArmorIDs.Shield.Count)
		{
			cShield = dyeItem.dye;
		}
		if (armorItem.neckSlot > 0 && armorItem.neckSlot < ArmorIDs.Neck.Count)
		{
			cNeck = dyeItem.dye;
		}
		if (armorItem.faceSlot > 0 && armorItem.faceSlot < ArmorIDs.Face.Count)
		{
			if (ArmorIDs.Face.Sets.DrawInFaceHeadLayer[armorItem.faceSlot])
			{
				cFaceHead = dyeItem.dye;
			}
			else if (ArmorIDs.Face.Sets.DrawInFaceMaskLayer[armorItem.faceSlot])
			{
				cFaceMask = dyeItem.dye;
			}
			else if (ArmorIDs.Face.Sets.DrawInFaceFlowerLayer[armorItem.faceSlot])
			{
				cFaceFlower = dyeItem.dye;
			}
			else
			{
				cFace = dyeItem.dye;
			}
		}
		if (armorItem.beardSlot > 0 && armorItem.beardSlot < ArmorIDs.Beard.Count)
		{
			cBeard = dyeItem.dye;
		}
		if (armorItem.balloonSlot > 0 && armorItem.balloonSlot < ArmorIDs.Balloon.Count)
		{
			if (ArmorIDs.Balloon.Sets.DrawInFrontOfBackArmLayer[armorItem.balloonSlot])
			{
				cBalloonFront = dyeItem.dye;
			}
			else
			{
				cBalloon = dyeItem.dye;
			}
		}
		if (armorItem.wingSlot > 0 && armorItem.wingSlot < ArmorIDs.Wing.Count)
		{
			cWings = dyeItem.dye;
		}
		if (armorItem.type == 934)
		{
			cCarpet = dyeItem.dye;
		}
		if (armorItem.type == 4404)
		{
			cFloatingTube = dyeItem.dye;
		}
		if (armorItem.type == 4341 || armorItem.type == 5126)
		{
			cPortableStool = dyeItem.dye;
		}
		if (armorItem.type == 4563)
		{
			cUnicornHorn = dyeItem.dye;
		}
		if (armorItem.type == 1987)
		{
			cAngelHalo = dyeItem.dye;
		}
		if (armorItem.type == 4762)
		{
			cMinion = dyeItem.dye;
		}
		if (armorItem.type == 3929)
		{
			cLeinShampoo = dyeItem.dye;
		}
		if (armorItem.type == 5587)
		{
			cCoat = dyeItem.dye;
		}
	}

	public int ArmorSetDye()
	{
		return Main.rand.Next(3) switch
		{
			0 => cHead, 
			1 => cBody, 
			2 => cLegs, 
			_ => cBody, 
		};
	}

	public IEntitySource GetProjectileSource_Buff(int buffIndex)
	{
		int buffId = buffType[buffIndex];
		return new EntitySource_Buff(this, buffId, buffIndex);
	}

	public IEntitySource GetProjectileSource_Item(Item item)
	{
		return new EntitySource_ItemUse(this, item);
	}

	public IEntitySource GetItemSource_Item(Item item)
	{
		return new EntitySource_ItemUse(this, item);
	}

	public IEntitySource GetItemSource_OpenItem(int itemType)
	{
		return new EntitySource_ItemOpen(this, itemType);
	}

	public IEntitySource GetItemSource_Death()
	{
		return new EntitySource_ByItemSourceId(this, ItemSourceID.PlayerDeath);
	}

	public IEntitySource GetItemSource_InventoryOverflow()
	{
		return new EntitySource_ByItemSourceId(this, ItemSourceID.InventoryOverflow);
	}

	public IEntitySource GetItemSource_Misc(int itemSourceId)
	{
		return new EntitySource_ByItemSourceId(this, itemSourceId);
	}

	public IEntitySource GetProjectileSource_Item_WithPotentialAmmo(Item item, int ammoItemId)
	{
		return new EntitySource_ItemUse_WithAmmo(this, item, ammoItemId);
	}

	public IEntitySource GetProjectileSource_SetBonus(int projectileSourceId)
	{
		return new EntitySource_ByProjectileSourceId(projectileSourceId);
	}

	public IEntitySource GetProjectileSource_OnHit(Entity victim, int projectileSourceId)
	{
		return new EntitySource_OnHit_ByProjectileSourceID(this, victim, projectileSourceId);
	}

	public IEntitySource GetProjectileSource_OnHurt(Entity attacker, int projectileSourceId)
	{
		return new EntitySource_OnHit_ByProjectileSourceID(attacker, this, projectileSourceId);
	}

	public IEntitySource GetProjectileSource_Accessory(Item item)
	{
		return new EntitySource_ItemUse(this, item);
	}

	public IEntitySource GetProjectileSource_Misc(int projectileSourceId)
	{
		return new EntitySource_ByProjectileSourceId(projectileSourceId);
	}

	public IEntitySource GetProjectileSource_TileInteraction(int tileCoordsX, int tileCoordsY)
	{
		return new EntitySource_TileInteraction(this, tileCoordsX, tileCoordsY);
	}

	public IEntitySource GetItemSource_TileInteraction(int tileCoordsX, int tileCoordsY)
	{
		return new EntitySource_TileInteraction(this, tileCoordsX, tileCoordsY);
	}

	public IEntitySource GetNPCSource_TileInteraction(int tileCoordsX, int tileCoordsY)
	{
		return new EntitySource_TileInteraction(this, tileCoordsX, tileCoordsY);
	}

	public IEntitySource GetItemSource_OnHit(Entity victim, int itemSourceId)
	{
		return new EntitySource_OnHit_ByItemSourceID(this, victim, itemSourceId);
	}

	public void UpdateBuffs(int i)
	{
		if (soulDrain > 0 && whoAmI == Main.myPlayer)
		{
			AddBuff(151, 2);
		}
		if (Main.dontStarveWorld)
		{
			UpdateStarvingState(withEmote: true);
		}
		for (int j = 0; j < maxBuffs; j++)
		{
			if (buffType[j] <= 0 || buffTime[j] <= 0)
			{
				continue;
			}
			if (whoAmI == Main.myPlayer && !BuffID.Sets.TimeLeftDoesNotDecrease[buffType[j]])
			{
				buffTime[j]--;
			}
			if (buffType[j] == 1)
			{
				lavaImmune = true;
				fireWalk = true;
				buffImmune[24] = true;
			}
			else if (BuffID.Sets.MountType[buffType[j]] != -1)
			{
				mount.SetMount(BuffID.Sets.MountType[buffType[j]], this);
				buffTime[j] = 10;
				if (buffType[j] == 131)
				{
					ignoreWater = true;
					accFlipper = true;
				}
				else if (buffType[j] == 168)
				{
					ignoreWater = true;
					accFlipper = true;
				}
				else if (buffType[j] == 265)
				{
					canFloatInWater = true;
					accFlipper = true;
				}
				else if (buffType[j] == 279)
				{
					ignoreWater = true;
					accFlipper = true;
				}
				else if (buffType[j] == 305)
				{
					ignoreWater = true;
					accFlipper = true;
					lavaImmune = true;
					lavaVision = true;
					fireWalk = true;
				}
			}
			else if (buffType[j] == 383)
			{
				moveSpeed += 0.25f;
				pickSpeed -= 0.15f;
				tileSpeed += 0.15f;
				wallSpeed += 0.15f;
				byte b = (byte)Utils.Clamp(buffTime[j] / 10800, 0, 3);
				if (b != kiteLuckLevel)
				{
					kiteLuckLevel = b;
					luckNeedsSync = true;
				}
			}
			else if (buffType[j] == 159)
			{
				meleeArmorPenetration += 12;
			}
			else if (buffType[j] == 158)
			{
				manaRegenDelayBonus += 0.5f;
				manaRegenBonus += 10;
			}
			else if (buffType[j] == 192)
			{
				pickSpeed -= 0.2f;
				moveSpeed += 0.2f;
			}
			else if (buffType[j] == 321)
			{
				int num = 10;
				meleeCrit += num;
				rangedCrit += num;
				magicCrit += num;
				minionDamage += (float)num / 100f;
			}
			else if (buffType[j] == 2)
			{
				lifeRegen += 4;
			}
			else if (buffType[j] == 3)
			{
				moveSpeed += 0.25f;
			}
			else if (buffType[j] == 4)
			{
				gills = true;
			}
			else if (buffType[j] == 5)
			{
				statDefense += 8;
			}
			else if (buffType[j] == 6)
			{
				manaRegenBuff = true;
			}
			else if (buffType[j] == 7)
			{
				magicDamage += 0.2f;
			}
			else if (buffType[j] == 8)
			{
				slowFall = true;
			}
			else if (buffType[j] == 9)
			{
				findTreasure = true;
			}
			else if (buffType[j] == 343)
			{
				biomeSight = true;
			}
			else if (buffType[j] == 10)
			{
				invis = true;
			}
			else if (buffType[j] == 11)
			{
				Lighting.AddLight((int)(position.X + (float)(width / 2)) / 16, (int)(position.Y + (float)(height / 2)) / 16, 0.8f, 0.95f, 1f);
			}
			else if (buffType[j] == 12)
			{
				nightVision = true;
			}
			else if (buffType[j] == 13)
			{
				enemySpawns = true;
			}
			else if (buffType[j] == 14)
			{
				if (thorns < 1f)
				{
					thorns = 1f;
				}
			}
			else if (buffType[j] == 15)
			{
				waterWalk = true;
			}
			else if (buffType[j] == 16)
			{
				archery = true;
				arrowDamage *= 1.1f;
			}
			else if (buffType[j] == 17)
			{
				detectCreature = true;
			}
			else if (buffType[j] == 18)
			{
				gravControl = true;
			}
			else if (buffType[j] == 30)
			{
				bleed = true;
			}
			else if (buffType[j] == 31)
			{
				confused = true;
			}
			else if (buffType[j] == 32)
			{
				slow = true;
			}
			else if (buffType[j] == 35)
			{
				silence = true;
			}
			else if (buffType[j] == 160)
			{
				dazed = true;
			}
			else if (buffType[j] == 46)
			{
				chilled = true;
			}
			else if (buffType[j] == 47)
			{
				frozen = true;
			}
			else if (buffType[j] == 156)
			{
				stoned = true;
			}
			else if (buffType[j] == 69)
			{
				ichor = true;
				statDefense -= 15;
			}
			else if (buffType[j] == 36)
			{
				brokenArmor = true;
			}
			else if (buffType[j] == 48)
			{
				honey = true;
			}
			else if (buffType[j] == 59)
			{
				shadowDodge = true;
			}
			else if (buffType[j] == 93)
			{
				ammoBox = true;
			}
			else if (buffType[j] == 58)
			{
				palladiumRegen = true;
			}
			else if (buffType[j] == 306)
			{
				hasTitaniumStormBuff = true;
			}
			else if (buffType[j] == 88)
			{
				chaosState = true;
			}
			else if (buffType[j] == 215)
			{
				statDefense += 5;
			}
			else if (buffType[j] == 311)
			{
				summonerWeaponSpeedBonus += 0.35f;
			}
			else if (buffType[j] == 308)
			{
				summonerWeaponSpeedBonus += 0.25f;
			}
			else if (buffType[j] == 314)
			{
				summonerWeaponSpeedBonus += 0.12f;
			}
			else if (buffType[j] == 312)
			{
				coolWhipBuff = true;
			}
			else if (buffType[j] == 365)
			{
				cobWhipBuff = true;
			}
			else if (buffType[j] == 63)
			{
				moveSpeed += 1f;
			}
			else if (buffType[j] == 104)
			{
				pickSpeed -= 0.25f;
			}
			else if (buffType[j] == 105)
			{
				lifeMagnet = true;
			}
			else if (buffType[j] == 106)
			{
				calmed = true;
			}
			else if (buffType[j] == 121)
			{
				fishingSkill += 15;
			}
			else if (buffType[j] == 122)
			{
				sonarPotion = true;
			}
			else if (buffType[j] == 123)
			{
				cratePotion = true;
			}
			else if (buffType[j] == 107)
			{
				tileSpeed += 0.25f;
				wallSpeed += 0.25f;
				blockRange++;
			}
			else if (buffType[j] == 108)
			{
				kbBuff = true;
			}
			else if (buffType[j] == 109)
			{
				ignoreWater = true;
				accFlipper = true;
			}
			else if (buffType[j] == 110)
			{
				maxMinions++;
			}
			else if (buffType[j] == 150)
			{
				maxMinions++;
			}
			else if (buffType[j] == 348)
			{
				maxTurrets++;
			}
			else if (buffType[j] == 366)
			{
				deadCellsPotionStation = true;
			}
			else if (buffType[j] == 111)
			{
				dangerSense = true;
			}
			else if (buffType[j] == 112)
			{
				ammoPotion = true;
			}
			else if (buffType[j] == 113)
			{
				lifeForce = true;
				statLifeMax2 += statLifeMax / 5 / 20 * 20;
			}
			else if (buffType[j] == 114)
			{
				endurance += 0.1f;
			}
			else if (buffType[j] == 115)
			{
				meleeCrit += 10;
				rangedCrit += 10;
				magicCrit += 10;
			}
			else if (buffType[j] == 116)
			{
				inferno = true;
				Lighting.AddLight((int)(base.Center.X / 16f), (int)(base.Center.Y / 16f), 0.65f, 0.4f, 0.1f);
				int num2 = 323;
				float num3 = 200f;
				bool flag = infernoCounter % 60 == 0;
				int damage = 20;
				if (whoAmI != Main.myPlayer)
				{
					continue;
				}
				for (int k = 0; k < Main.maxNPCs; k++)
				{
					NPC nPC = Main.npc[k];
					if (nPC.active && !nPC.friendly && nPC.damage > 0 && !nPC.dontTakeDamage && !nPC.buffImmune[num2] && CanNPCBeHitByPlayerOrPlayerProjectile(nPC) && Vector2.Distance(base.Center, nPC.Center) <= num3)
					{
						if (nPC.FindBuffIndex(num2) == -1)
						{
							nPC.AddBuff(num2, 120);
						}
						if (flag)
						{
							ApplyDamageToNPC(nPC, damage, 0f, 0, crit: false);
						}
					}
				}
				if (!hostile)
				{
					continue;
				}
				for (int l = 0; l < 255; l++)
				{
					Player player = Main.player[l];
					if (player == this || !player.active || player.dead || !player.hostile || player.buffImmune[num2] || (player.team == team && player.team != 0) || !(Vector2.Distance(base.Center, player.Center) <= num3))
					{
						continue;
					}
					if (player.FindBuffIndex(num2) == -1)
					{
						player.AddBuff(num2, 120);
					}
					if (flag)
					{
						PlayerDeathReason playerDeathReason = PlayerDeathReason.ByOther(16);
						player.Hurt(playerDeathReason, damage, 0, pvp: true);
						if (Main.netMode != 0)
						{
							NetMessage.SendPlayerHurt(l, playerDeathReason, damage, 0, critical: false, pvp: true, ImmunityCooldownID.General);
						}
					}
				}
			}
			else if (buffType[j] == 117)
			{
				meleeDamage += 0.1f;
				rangedDamage += 0.1f;
				magicDamage += 0.1f;
				minionDamage += 0.1f;
			}
			else if (buffType[j] == 119)
			{
				loveStruck = true;
			}
			else if (buffType[j] == 120)
			{
				talkNPC = -1;
				stinky = true;
			}
			else if (buffType[j] == 124)
			{
				resistCold = true;
			}
			else if (buffType[j] == 257)
			{
				if (Main.myPlayer == whoAmI)
				{
					if (buffTime[j] > 36000)
					{
						luckPotion = 3;
					}
					else if (buffTime[j] > 18000)
					{
						luckPotion = 2;
					}
					else
					{
						luckPotion = 1;
					}
				}
			}
			else if (buffType[j] == 165)
			{
				lifeRegen += 6;
				statDefense += 8;
				dryadWard = true;
				if (thorns < 1f)
				{
					thorns += 0.5f;
				}
			}
			else if (buffType[j] == 144)
			{
				electrified = true;
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 0.3f, 0.8f, 1.1f);
			}
			else if (buffType[j] == 94)
			{
				manaSick = true;
				manaSickReduction = manaSickLessDmg * ((float)buffTime[j] / (float)manaSickTime);
			}
			else if (buffType[j] >= 95 && buffType[j] <= 97)
			{
				buffTime[j] = 5;
				int num4 = (byte)(1 + buffType[j] - 95);
				if (beetleOrbs > 0 && beetleOrbs != num4)
				{
					if (beetleOrbs > num4)
					{
						DelBuff(j);
						j--;
					}
					else
					{
						for (int m = 0; m < maxBuffs; m++)
						{
							if (buffType[m] >= 95 && buffType[m] <= 95 + num4 - 1)
							{
								DelBuff(m);
								m--;
							}
						}
					}
				}
				beetleOrbs = num4;
				if (!beetleDefense)
				{
					beetleOrbs = 0;
					DelBuff(j);
					j--;
				}
				else
				{
					beetleBuff = true;
				}
			}
			else if (buffType[j] >= 170 && buffType[j] <= 172)
			{
				buffTime[j] = 5;
				int num5 = (byte)(1 + buffType[j] - 170);
				if (solarShields > 0 && solarShields != num5)
				{
					if (solarShields > num5)
					{
						DelBuff(j);
						j--;
					}
					else
					{
						for (int n = 0; n < maxBuffs; n++)
						{
							if (buffType[n] >= 170 && buffType[n] <= 170 + num5 - 1)
							{
								DelBuff(n);
								n--;
							}
						}
					}
				}
				solarShields = num5;
				if (!setSolar)
				{
					solarShields = 0;
					DelBuff(j);
					j--;
				}
			}
			else if (buffType[j] >= 98 && buffType[j] <= 100)
			{
				int num6 = (byte)(1 + buffType[j] - 98);
				if (beetleOrbs > 0 && beetleOrbs != num6)
				{
					if (beetleOrbs > num6)
					{
						DelBuff(j);
						j--;
					}
					else
					{
						for (int num7 = 0; num7 < maxBuffs; num7++)
						{
							if (buffType[num7] >= 98 && buffType[num7] <= 98 + num6 - 1)
							{
								DelBuff(num7);
								num7--;
							}
						}
					}
				}
				beetleOrbs = num6;
				meleeDamage += 0.1f * (float)beetleOrbs;
				meleeSpeed += 0.1f * (float)beetleOrbs;
				if (!beetleOffense)
				{
					beetleOrbs = 0;
					DelBuff(j);
					j--;
				}
				else
				{
					beetleBuff = true;
				}
			}
			else if (buffType[j] >= 176 && buffType[j] <= 178)
			{
				UpdateBuffs_NebulaBuffs(ref nebulaLevelMana, 176, j);
			}
			else if (buffType[j] >= 173 && buffType[j] <= 175)
			{
				UpdateBuffs_NebulaBuffs(ref nebulaLevelLife, 173, j);
				lifeRegen += 6 * nebulaLevelLife;
			}
			else if (buffType[j] >= 179 && buffType[j] <= 181)
			{
				UpdateBuffs_NebulaBuffs(ref nebulaLevelDamage, 179, j);
				float num8 = 0.15f * (float)nebulaLevelDamage;
				meleeDamage += num8;
				rangedDamage += num8;
				magicDamage += num8;
				minionDamage += num8;
			}
			else if (buffType[j] == 62)
			{
				if ((double)statLife <= (double)statLifeMax2 * 0.5)
				{
					Lighting.AddLight((int)(base.Center.X / 16f), (int)(base.Center.Y / 16f), 0.1f, 0.2f, 0.45f);
					iceBarrier = true;
					endurance += 0.25f;
					iceBarrierFrameCounter++;
					if (iceBarrierFrameCounter > 2)
					{
						iceBarrierFrameCounter = 0;
						iceBarrierFrame++;
						if (iceBarrierFrame >= 12)
						{
							iceBarrierFrame = 0;
						}
					}
				}
				else
				{
					DelBuff(j);
					j--;
				}
			}
			else if (buffType[j] == 49)
			{
				for (int num9 = 191; num9 <= 194; num9++)
				{
					if (ownedProjectileCounts[num9] > 0)
					{
						pygmy = true;
					}
				}
				if (!pygmy)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 83)
			{
				if (ownedProjectileCounts[317] > 0)
				{
					raven = true;
				}
				if (!raven)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 64)
			{
				if (ownedProjectileCounts[266] > 0)
				{
					slime = true;
				}
				if (!slime)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 125)
			{
				if (ownedProjectileCounts[373] > 0)
				{
					hornetMinion = true;
				}
				if (!hornetMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 126)
			{
				if (ownedProjectileCounts[375] > 0)
				{
					impMinion = true;
				}
				if (!impMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 133)
			{
				if (ownedProjectileCounts[390] > 0 || ownedProjectileCounts[391] > 0 || ownedProjectileCounts[392] > 0)
				{
					spiderMinion = true;
				}
				if (!spiderMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 134)
			{
				if (ownedProjectileCounts[387] > 0 || ownedProjectileCounts[388] > 0)
				{
					twinsMinion = true;
				}
				if (!twinsMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 135)
			{
				if (ownedProjectileCounts[393] > 0 || ownedProjectileCounts[394] > 0 || ownedProjectileCounts[395] > 0)
				{
					pirateMinion = true;
				}
				if (!pirateMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 214)
			{
				if (ownedProjectileCounts[758] > 0)
				{
					vampireFrog = true;
				}
				if (!vampireFrog)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 139)
			{
				if (ownedProjectileCounts[407] > 0)
				{
					sharknadoMinion = true;
				}
				if (!sharknadoMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 140)
			{
				if (ownedProjectileCounts[423] > 0)
				{
					UFOMinion = true;
				}
				if (!UFOMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 182)
			{
				if (ownedProjectileCounts[613] > 0)
				{
					stardustMinion = true;
				}
				if (!stardustMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 213)
			{
				if (ownedProjectileCounts[755] > 0)
				{
					batsOfLight = true;
				}
				if (!batsOfLight)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 216)
			{
				bool flag2 = true;
				if (ownedProjectileCounts[759] > 0)
				{
					babyBird = true;
				}
				else if (whoAmI == Main.myPlayer)
				{
					if (numMinions < maxMinions)
					{
						int num10 = FindItem(4281);
						if (num10 != -1)
						{
							Item item = inventory[num10];
							int num11 = Projectile.NewProjectile(GetProjectileSource_Item(item), base.Top, Vector2.Zero, item.shoot, item.damage, item.knockBack, whoAmI);
							Main.projectile[num11].originalDamage = item.damage;
							babyBird = true;
						}
					}
					if (!babyBird)
					{
						DelBuff(j);
						j--;
						flag2 = false;
					}
				}
				if (flag2)
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 355)
			{
				if (ownedProjectileCounts[1022] > 0)
				{
					deadCellsMushroomBoiMinion = true;
				}
				if (!deadCellsMushroomBoiMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 385)
			{
				if (ownedProjectileCounts[1093] > 0)
				{
					palworldCattivaMinion = true;
				}
				if (!palworldCattivaMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 386)
			{
				if (ownedProjectileCounts[1094] > 0)
				{
					palworldFoxsparksMinion = true;
				}
				if (!palworldFoxsparksMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 325)
			{
				if (ownedProjectileCounts[951] > 0)
				{
					flinxMinion = true;
				}
				if (!flinxMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 335)
			{
				if (ownedProjectileCounts[970] > 0)
				{
					abigailMinion = true;
				}
				if (!abigailMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
				if (whoAmI == Main.myPlayer)
				{
					UpdateAbigailStatus();
				}
			}
			else if (buffType[j] == 263)
			{
				if (ownedProjectileCounts[831] > 0)
				{
					stormTiger = true;
				}
				if (!stormTiger)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
				if (whoAmI == Main.myPlayer)
				{
					UpdateStormTigerStatus();
				}
			}
			else if (buffType[j] == 271)
			{
				if (ownedProjectileCounts[864] > 0)
				{
					smolstar = true;
				}
				if (!smolstar)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 322)
			{
				if (ownedProjectileCounts[946] > 0)
				{
					empressBlade = true;
				}
				if (!empressBlade)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 187)
			{
				if (ownedProjectileCounts[623] > 0)
				{
					stardustGuardian = true;
				}
				if (!stardustGuardian)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 188)
			{
				if (ownedProjectileCounts[625] > 0)
				{
					stardustDragon = true;
				}
				if (!stardustDragon)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 161)
			{
				if (ownedProjectileCounts[533] > 0)
				{
					DeadlySphereMinion = true;
				}
				if (!DeadlySphereMinion)
				{
					DelBuff(j);
					j--;
				}
				else
				{
					buffTime[j] = 18000;
				}
			}
			else if (buffType[j] == 37)
			{
				if (Main.wofNPCIndex >= 0 && Main.npc[Main.wofNPCIndex].type == 113)
				{
					gross = true;
					buffTime[j] = 10;
				}
				else
				{
					DelBuff(j);
					j--;
				}
			}
			else if (buffType[j] == 38)
			{
				buffTime[j] = 10;
				tongued = true;
			}
			else if (buffType[j] == 376 && whoAmI == Main.myPlayer)
			{
				TorchGodsFlavor();
			}
			else if (buffType[j] == 146)
			{
				moveSpeed += 0.1f;
				moveSpeed *= 1.1f;
				sunflower = true;
			}
			else if (buffType[j] == 19)
			{
				buffTime[j] = 18000;
				lightOrb = true;
				bool flag3 = true;
				if (ownedProjectileCounts[18] > 0)
				{
					flag3 = false;
				}
				if (flag3 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 18, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 155)
			{
				buffTime[j] = 18000;
				crimsonHeart = true;
				bool flag4 = true;
				if (ownedProjectileCounts[500] > 0)
				{
					flag4 = false;
				}
				if (flag4 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 500, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 191)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref companionCube, 653);
			}
			else if (buffType[j] == 202)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDD2Dragon, 701);
			}
			else if (buffType[j] == 217)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagUpbeatStar, 764);
			}
			else if (buffType[j] == 219)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBabyShark, 774);
			}
			else if (buffType[j] == 258)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagLilHarpy, 815);
			}
			else if (buffType[j] == 259)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagFennecFox, 816);
			}
			else if (buffType[j] == 260)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagGlitteryButterfly, 817);
			}
			else if (buffType[j] == 261)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBabyImp, 821);
			}
			else if (buffType[j] == 262)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBabyRedPanda, 825);
			}
			else if (buffType[j] == 264)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagPlantero, 854);
			}
			else if (buffType[j] == 266)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDynamiteKitten, 858);
			}
			else if (buffType[j] == 267)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBabyWerewolf, 859);
			}
			else if (buffType[j] == 268)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagShadowMimic, 860);
			}
			else if (buffType[j] == 274)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagVoltBunny, 875);
			}
			else if (buffType[j] == 284)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagKingSlimePet, 881);
			}
			else if (buffType[j] == 285)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagEyeOfCthulhuPet, 882);
			}
			else if (buffType[j] == 286)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagEaterOfWorldsPet, 883);
			}
			else if (buffType[j] == 287)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBrainOfCthulhuPet, 884);
			}
			else if (buffType[j] == 288)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagSkeletronPet, 885);
			}
			else if (buffType[j] == 289)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagQueenBeePet, 886);
			}
			else if (buffType[j] == 290)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDestroyerPet, 887);
			}
			else if (buffType[j] == 291)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagTwinsPet, 888);
			}
			else if (buffType[j] == 292)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagSkeletronPrimePet, 889);
			}
			else if (buffType[j] == 293)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagPlanteraPet, 890);
			}
			else if (buffType[j] == 294)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagGolemPet, 891);
			}
			else if (buffType[j] == 295)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDukeFishronPet, 892);
			}
			else if (buffType[j] == 296)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagLunaticCultistPet, 893);
			}
			else if (buffType[j] == 297)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagMoonLordPet, 894);
			}
			else if (buffType[j] == 298)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagFairyQueenPet, 895);
			}
			else if (buffType[j] == 299)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagPumpkingPet, 896);
			}
			else if (buffType[j] == 300)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagEverscreamPet, 897);
			}
			else if (buffType[j] == 301)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagIceQueenPet, 898);
			}
			else if (buffType[j] == 302)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagMartianPet, 899);
			}
			else if (buffType[j] == 303)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDD2OgrePet, 900);
			}
			else if (buffType[j] == 304)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDD2BetsyPet, 901);
			}
			else if (buffType[j] == 317)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagQueenSlimePet, 934);
			}
			else if (buffType[j] == 327)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBerniePet, 956);
			}
			else if (buffType[j] == 328)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagGlommerPet, 957);
			}
			else if (buffType[j] == 329)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDeerclopsPet, 958);
			}
			else if (buffType[j] == 330)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagPigPet, 959);
			}
			else if (buffType[j] == 331)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagChesterPet, 960);
			}
			else if (buffType[j] == 341)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagKingSlimePet, 881);
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagQueenSlimePet, 934);
			}
			else if (buffType[j] == 345)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagJunimoPet, 994);
			}
			else if (buffType[j] == 349)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBlueChickenPet, 998);
			}
			else if (buffType[j] == 351)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagSpiffo, 1003);
			}
			else if (buffType[j] == 352)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagCaveling, 1004);
			}
			else if (buffType[j] == 354)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDirtiestBlock, 1018);
			}
			else if (buffType[j] == 373)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagBoulderPet, 1056);
			}
			else if (buffType[j] == 382)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagRainbowBoulderPet, 1090);
			}
			else if (buffType[j] == 356)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDeadCellsSwarmBiter, 1027);
			}
			else if (buffType[j] == 371)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagPufferfish, 1046);
			}
			else if (buffType[j] == 372)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagAxeFairyPet, 1050);
			}
			else if (buffType[j] == 200)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDD2Gato, 703);
			}
			else if (buffType[j] == 201)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagDD2Ghost, 702);
			}
			else if (buffType[j] == 218)
			{
				BuffHandle_SpawnPetIfNeededAndSetTime(j, ref petFlagSugarGlider, 765);
			}
			else if (buffType[j] == 190)
			{
				buffTime[j] = 18000;
				suspiciouslookingTentacle = true;
				bool flag5 = true;
				if (ownedProjectileCounts[650] > 0)
				{
					flag5 = false;
				}
				if (flag5 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 650, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 27 || buffType[j] == 101 || buffType[j] == 102)
			{
				buffTime[j] = 18000;
				bool flag6 = true;
				short num12 = 72;
				switch (buffType[j])
				{
				case 101:
					num12 = 86;
					break;
				case 102:
					num12 = 87;
					break;
				}
				if (head == 45 && body == 26 && legs == 25)
				{
					num12 = 72;
				}
				switch (num12)
				{
				case 72:
					blueFairy = true;
					break;
				case 86:
					redFairy = true;
					break;
				case 87:
					greenFairy = true;
					break;
				}
				if (ownedProjectileCounts[num12] > 0)
				{
					flag6 = false;
				}
				if (flag6 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, num12, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 40)
			{
				buffTime[j] = 18000;
				bunny = true;
				bool flag7 = true;
				if (ownedProjectileCounts[111] > 0)
				{
					flag7 = false;
				}
				if (flag7 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 111, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 148)
			{
				rabid = true;
				if (Main.rand.Next(1200) == 0)
				{
					int num13 = Main.rand.Next(6);
					float num14 = (float)Main.rand.Next(60, 100) * 0.01f;
					switch (num13)
					{
					case 0:
						AddBuff(22, (int)(60f * num14 * 3f));
						break;
					case 1:
						AddBuff(23, (int)(60f * num14 * 0.75f));
						break;
					case 2:
						AddBuff(31, (int)(60f * num14 * 1.5f));
						break;
					case 3:
						AddBuff(32, (int)(60f * num14 * 3.5f));
						break;
					case 4:
						AddBuff(33, (int)(60f * num14 * 5f));
						break;
					case 5:
						AddBuff(35, (int)(60f * num14 * 1f));
						break;
					}
				}
				meleeDamage += 0.2f;
				magicDamage += 0.2f;
				rangedDamage += 0.2f;
				minionDamage += 0.2f;
			}
			else if (buffType[j] == 41)
			{
				buffTime[j] = 18000;
				penguin = true;
				bool flag8 = true;
				if (ownedProjectileCounts[112] > 0)
				{
					flag8 = false;
				}
				if (flag8 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 112, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 152)
			{
				buffTime[j] = 18000;
				magicLantern = true;
				if (ownedProjectileCounts[492] == 0 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 492, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 91)
			{
				buffTime[j] = 18000;
				puppy = true;
				bool flag9 = true;
				if (ownedProjectileCounts[334] > 0)
				{
					flag9 = false;
				}
				if (flag9 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 334, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 92)
			{
				buffTime[j] = 18000;
				grinch = true;
				bool flag10 = true;
				if (ownedProjectileCounts[353] > 0)
				{
					flag10 = false;
				}
				if (flag10 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 353, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 84)
			{
				buffTime[j] = 18000;
				blackCat = true;
				bool flag11 = true;
				if (ownedProjectileCounts[319] > 0)
				{
					flag11 = false;
				}
				if (flag11 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 319, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 61)
			{
				buffTime[j] = 18000;
				dino = true;
				bool flag12 = true;
				if (ownedProjectileCounts[236] > 0)
				{
					flag12 = false;
				}
				if (flag12 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 236, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 154)
			{
				buffTime[j] = 18000;
				babyFaceMonster = true;
				bool flag13 = true;
				if (ownedProjectileCounts[499] > 0)
				{
					flag13 = false;
				}
				if (flag13 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 499, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 65)
			{
				buffTime[j] = 18000;
				eyeSpring = true;
				bool flag14 = true;
				if (ownedProjectileCounts[268] > 0)
				{
					flag14 = false;
				}
				if (flag14 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 268, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 66)
			{
				buffTime[j] = 18000;
				snowman = true;
				bool flag15 = true;
				if (ownedProjectileCounts[269] > 0)
				{
					flag15 = false;
				}
				if (flag15 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 269, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 42)
			{
				buffTime[j] = 18000;
				turtle = true;
				bool flag16 = true;
				if (ownedProjectileCounts[127] > 0)
				{
					flag16 = false;
				}
				if (flag16 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 127, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 45)
			{
				buffTime[j] = 18000;
				eater = true;
				bool flag17 = true;
				if (ownedProjectileCounts[175] > 0)
				{
					flag17 = false;
				}
				if (flag17 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 175, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 50)
			{
				buffTime[j] = 18000;
				skeletron = true;
				bool flag18 = true;
				if (ownedProjectileCounts[197] > 0)
				{
					flag18 = false;
				}
				if (flag18 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 197, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 51)
			{
				buffTime[j] = 18000;
				hornet = true;
				bool flag19 = true;
				if (ownedProjectileCounts[198] > 0)
				{
					flag19 = false;
				}
				if (flag19 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 198, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 52)
			{
				buffTime[j] = 18000;
				tiki = true;
				bool flag20 = true;
				if (ownedProjectileCounts[199] > 0)
				{
					flag20 = false;
				}
				if (flag20 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 199, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 53)
			{
				buffTime[j] = 18000;
				lizard = true;
				bool flag21 = true;
				if (ownedProjectileCounts[200] > 0)
				{
					flag21 = false;
				}
				if (flag21 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 200, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 54)
			{
				buffTime[j] = 18000;
				parrot = true;
				bool flag22 = true;
				if (ownedProjectileCounts[208] > 0)
				{
					flag22 = false;
				}
				if (flag22 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 208, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 55)
			{
				buffTime[j] = 18000;
				truffle = true;
				bool flag23 = true;
				if (ownedProjectileCounts[209] > 0)
				{
					flag23 = false;
				}
				if (flag23 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 209, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 56)
			{
				buffTime[j] = 18000;
				sapling = true;
				bool flag24 = true;
				if (ownedProjectileCounts[210] > 0)
				{
					flag24 = false;
				}
				if (flag24 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 210, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 85)
			{
				buffTime[j] = 18000;
				cSapling = true;
				bool flag25 = true;
				if (ownedProjectileCounts[324] > 0)
				{
					flag25 = false;
				}
				if (flag25 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 324, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 81)
			{
				buffTime[j] = 18000;
				spider = true;
				bool flag26 = true;
				if (ownedProjectileCounts[313] > 0)
				{
					flag26 = false;
				}
				if (flag26 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 313, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 82)
			{
				buffTime[j] = 18000;
				squashling = true;
				bool flag27 = true;
				if (ownedProjectileCounts[314] > 0)
				{
					flag27 = false;
				}
				if (flag27 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 314, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 57)
			{
				buffTime[j] = 18000;
				wisp = true;
				bool flag28 = true;
				if (ownedProjectileCounts[211] > 0)
				{
					flag28 = false;
				}
				if (flag28 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 211, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 60)
			{
				buffTime[j] = 18000;
				crystalLeaf = true;
				bool flag29 = true;
				for (int num15 = 0; num15 < 1000; num15++)
				{
					if (Main.projectile[num15].active && Main.projectile[num15].owner == whoAmI && Main.projectile[num15].type == 226)
					{
						if (!flag29)
						{
							Main.projectile[num15].Kill();
						}
						flag29 = false;
					}
				}
				if (flag29 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 226, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 127)
			{
				buffTime[j] = 18000;
				zephyrfish = true;
				bool flag30 = true;
				if (ownedProjectileCounts[380] > 0)
				{
					flag30 = false;
				}
				if (flag30 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 380, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 136)
			{
				buffTime[j] = 18000;
				miniMinotaur = true;
				bool flag31 = true;
				if (ownedProjectileCounts[398] > 0)
				{
					flag31 = false;
				}
				if (flag31 && whoAmI == Main.myPlayer)
				{
					Projectile.NewProjectile(GetProjectileSource_Buff(j), position.X + (float)(width / 2), position.Y + (float)(height / 2), 0f, 0f, 398, 0, 0f, whoAmI);
				}
			}
			else if (buffType[j] == 70)
			{
				venom = true;
			}
			else if (buffType[j] == 20)
			{
				poisoned = true;
			}
			else if (buffType[j] == 21)
			{
				potionDelay = buffTime[j];
			}
			else if (buffType[j] == 22)
			{
				blind = true;
			}
			else if (buffType[j] == 80)
			{
				blackout = true;
			}
			else if (buffType[j] == 23)
			{
				noItems = true;
				cursed = true;
			}
			else if (buffType[j] == 24)
			{
				onFire = true;
			}
			else if (buffType[j] == 103)
			{
				if (lavaWet)
				{
					DelBuff(j);
					continue;
				}
				dripping = true;
				buffImmune[24] = true;
				buffImmune[323] = true;
				buffImmune[67] = true;
			}
			else if (buffType[j] == 137)
			{
				drippingSlime = true;
			}
			else if (buffType[j] == 320)
			{
				drippingSparkleSlime = true;
			}
			else if (buffType[j] == 67)
			{
				burned = true;
			}
			else if (buffType[j] == 68)
			{
				suffocating = true;
			}
			else if (buffType[j] == 39)
			{
				onFire2 = true;
			}
			else if (buffType[j] == 323)
			{
				onFire3 = true;
			}
			else if (buffType[j] == 44)
			{
				onFrostBurn = true;
			}
			else if (buffType[j] == 324)
			{
				onFrostBurn2 = true;
			}
			else if (buffType[j] == 353)
			{
				shimmering = true;
				frozen = true;
				fallStart = (int)(position.Y / 16f);
				if (Main.myPlayer != whoAmI)
				{
					continue;
				}
				if (position.Y / 16f > (float)Main.UnderworldLayer)
				{
					if (Main.myPlayer == whoAmI)
					{
						DelBuff(j);
					}
					continue;
				}
				if (shimmerWet)
				{
					buffTime[j] = 60;
					continue;
				}
				bool flag32 = false;
				for (int num16 = (int)(position.X / 16f); (float)num16 <= (position.X + (float)width) / 16f; num16++)
				{
					for (int num17 = (int)(position.Y / 16f); (float)num17 <= (position.Y + (float)height) / 16f; num17++)
					{
						if (WorldGen.SolidTile3(num16, num17))
						{
							flag32 = true;
						}
					}
				}
				if (flag32)
				{
					buffTime[j] = 6;
				}
				else
				{
					DelBuff(j);
				}
			}
			else if (buffType[j] == 163)
			{
				headcovered = true;
				bleed = true;
			}
			else if (buffType[j] == 164)
			{
				vortexDebuff = true;
			}
			else if (buffType[j] == 194)
			{
				windPushed = true;
			}
			else if (buffType[j] == 195)
			{
				witheredArmor = true;
			}
			else if (buffType[j] == 205)
			{
				ballistaPanic = true;
			}
			else if (buffType[j] == 196)
			{
				witheredWeapon = true;
			}
			else if (buffType[j] == 197)
			{
				slowOgreSpit = true;
			}
			else if (buffType[j] == 198)
			{
				parryDamageBuff = true;
			}
			else if (buffType[j] == 145)
			{
				moonLeech = true;
			}
			else if (buffType[j] == 149)
			{
				webbed = true;
				if (velocity.Y != 0f)
				{
					velocity = new Vector2(0f, 1E-06f);
				}
				else
				{
					velocity = Vector2.Zero;
				}
				jumpHeight = 0;
				gravity = 0f;
				moveSpeed = 0f;
				dash = 0;
				dashType = 0;
				noKnockback = true;
				RemoveAllGrapplingHooks();
			}
			else if (buffType[j] == 43)
			{
				defendedByPaladin = true;
			}
			else if (buffType[j] == 29)
			{
				magicCrit += 2;
				magicDamage += 0.05f;
				statManaMax2 += 20;
				manaCost -= 0.02f;
			}
			else if (buffType[j] == 28)
			{
				if (!Main.dayTime && wolfAcc && !merman)
				{
					lifeRegen++;
					wereWolf = true;
					meleeCrit += 2;
					meleeDamage += 0.051f;
					meleeSpeed += 0.051f;
					statDefense += 3;
					moveSpeed += 0.05f;
				}
				else
				{
					DelBuff(j);
					j--;
				}
			}
			else if (buffType[j] == 33)
			{
				meleeDamage -= 0.051f;
				meleeSpeed -= 0.051f;
				statDefense -= 4;
				moveSpeed -= 0.1f;
			}
			else if (buffType[j] == 25)
			{
				tipsy = true;
				statDefense -= 4;
				meleeCrit += 2;
				meleeDamage += 0.1f;
				meleeSpeed += 0.1f;
			}
			else if (buffType[j] == 26)
			{
				wellFed = true;
				statDefense += 2;
				meleeCrit += 2;
				meleeDamage += 0.05f;
				meleeSpeed += 0.05f;
				magicCrit += 2;
				magicDamage += 0.05f;
				rangedCrit += 2;
				rangedDamage += 0.05f;
				minionDamage += 0.05f;
				minionKB += 0.5f;
				moveSpeed += 0.2f;
				pickSpeed -= 0.05f;
			}
			else if (buffType[j] == 206)
			{
				wellFed = true;
				statDefense += 3;
				meleeCrit += 3;
				meleeDamage += 0.075f;
				meleeSpeed += 0.075f;
				magicCrit += 3;
				magicDamage += 0.075f;
				rangedCrit += 3;
				rangedDamage += 0.075f;
				minionDamage += 0.075f;
				minionKB += 0.75f;
				moveSpeed += 0.3f;
				pickSpeed -= 0.1f;
			}
			else if (buffType[j] == 207)
			{
				wellFed = true;
				statDefense += 4;
				meleeCrit += 4;
				meleeDamage += 0.1f;
				meleeSpeed += 0.1f;
				magicCrit += 4;
				magicDamage += 0.1f;
				rangedCrit += 4;
				rangedDamage += 0.1f;
				minionDamage += 0.1f;
				minionKB += 1f;
				moveSpeed += 0.4f;
				pickSpeed -= 0.15f;
			}
			else if (buffType[j] == 333)
			{
				hungry = true;
				statDefense -= 2;
				meleeCrit -= 2;
				meleeDamage -= 0.05f;
				meleeSpeed -= 0.05f;
				magicCrit -= 2;
				magicDamage -= 0.05f;
				rangedCrit -= 2;
				rangedDamage -= 0.05f;
				minionDamage -= 0.05f;
				minionKB -= 0.5f;
				pickSpeed += 0.05f;
			}
			else if (buffType[j] == 334)
			{
				starving = true;
				statDefense -= 4;
				meleeCrit -= 4;
				meleeDamage -= 0.1f;
				meleeSpeed -= 0.1f;
				magicCrit -= 4;
				magicDamage -= 0.1f;
				rangedCrit -= 4;
				rangedDamage -= 0.1f;
				minionDamage -= 0.1f;
				minionKB -= 1f;
				pickSpeed += 0.15f;
			}
			else if (buffType[j] == 336)
			{
				heartyMeal = true;
			}
			else if (buffType[j] == 71)
			{
				meleeEnchant = 1;
			}
			else if (buffType[j] == 73)
			{
				meleeEnchant = 2;
			}
			else if (buffType[j] == 74)
			{
				meleeEnchant = 3;
			}
			else if (buffType[j] == 75)
			{
				meleeEnchant = 4;
			}
			else if (buffType[j] == 76)
			{
				meleeEnchant = 5;
			}
			else if (buffType[j] == 77)
			{
				meleeEnchant = 6;
			}
			else if (buffType[j] == 78)
			{
				meleeEnchant = 7;
			}
			else if (buffType[j] == 79)
			{
				meleeEnchant = 8;
			}
		}
		UpdateHungerBuffs();
		if (whoAmI == Main.myPlayer && luckPotion != oldLuckPotion)
		{
			luckNeedsSync = true;
			oldLuckPotion = luckPotion;
		}
		if (lavaVision && lavaWet && lavaOpacity > 0.4f)
		{
			lavaOpacity -= 0.04f;
			if (lavaOpacity < 0.4f)
			{
				lavaOpacity = 0.4f;
			}
		}
		else if (lavaOpacity < 1f)
		{
			lavaOpacity += 0.04f;
			if (lavaOpacity > 1f)
			{
				lavaOpacity = 1f;
			}
		}
	}

	private void UpdateBuffs_NebulaBuffs(ref int nebulaLevel, int baseBuffId, int b)
	{
		int num = 1 + buffType[b] - baseBuffId;
		nebulaLevel = num;
		if (buffTime[b] == 2 && nebulaLevel > 1)
		{
			nebulaLevel--;
			buffType[b]--;
			buffTime[b] = 480;
		}
	}

	public void TryToResetHungerToNeutral()
	{
		bool flag = false;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] > 0 && buffTime[i] > 0 && (buffType[i] == 332 || buffType[i] == 333 || buffType[i] == 334))
			{
				buffTime[i] = 0;
				flag = true;
			}
		}
		if (flag)
		{
			UpdateHungerBuffs();
		}
	}

	public void UpdateHungerBuffs()
	{
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] <= 0 || buffTime[i] <= 0)
			{
				continue;
			}
			if (buffType[i] == 332)
			{
				if (buffTime[i] <= 2 && whoAmI == Main.myPlayer)
				{
					if (Main.remixWorld && Main.dontStarveWorld)
					{
						AddBuff(333, 28800);
					}
					else
					{
						AddBuff(333, 18000);
					}
					EmoteBubble.MakeLocalPlayerEmote(147);
				}
				if (!Main.dontStarveWorld)
				{
					buffTime[i] = 0;
				}
			}
			else if (buffType[i] == 333)
			{
				if (buffTime[i] <= 2 && whoAmI == Main.myPlayer)
				{
					if (Main.remixWorld && Main.dontStarveWorld)
					{
						AddBuff(334, 5);
					}
					else
					{
						AddBuff(334, 5);
					}
					EmoteBubble.MakeLocalPlayerEmote(148);
					SoundEngine.PlaySound(SoundID.Hungry);
				}
				if (!Main.dontStarveWorld)
				{
					buffTime[i] = 0;
				}
			}
			else if (buffType[i] == 334 && !Main.dontStarveWorld)
			{
				buffTime[i] = 0;
			}
		}
	}

	public void UpdateStarvingState(bool withEmote)
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		bool flag = false;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffTime[i] > 0 && BuffID.Sets.IsFedState[buffType[i]])
			{
				flag = true;
				break;
			}
		}
		if (!flag)
		{
			if (Main.remixWorld && Main.dontStarveWorld)
			{
				AddBuff(332, 28800);
			}
			else
			{
				AddBuff(332, 18000);
			}
			if (withEmote)
			{
				EmoteBubble.MakeLocalPlayerEmote(146);
			}
		}
	}

	private void UpdateProjectileCaches(int i)
	{
		for (int j = 0; j < 1000; j++)
		{
			if (!Main.projectile[j].active || Main.projectile[j].owner != i)
			{
				continue;
			}
			ownedProjectileCounts[Main.projectile[j].type]++;
			switch (Main.projectile[j].type)
			{
			case 831:
			{
				int originalDamage2 = Main.projectile[j].originalDamage;
				if (highestStormTigerGemOriginalDamage < originalDamage2)
				{
					highestStormTigerGemOriginalDamage = originalDamage2;
				}
				break;
			}
			case 970:
			{
				int originalDamage = Main.projectile[j].originalDamage;
				if (highestAbigailCounterOriginalDamage < originalDamage)
				{
					highestAbigailCounterOriginalDamage = originalDamage;
				}
				break;
			}
			}
		}
	}

	private void ResetProjectileCaches()
	{
		highestStormTigerGemOriginalDamage = 0;
		highestAbigailCounterOriginalDamage = 0;
		for (int i = 0; i < ownedProjectileCounts.Length; i++)
		{
			ownedProjectileCounts[i] = 0;
		}
	}

	public void BuffHandle_SpawnPetIfNeededAndSetTime(int buffIndex, ref bool petBool, int petProjID, int buffTimeToGive = 18000)
	{
		buffTime[buffIndex] = buffTimeToGive;
		BuffHandle_SpawnPetIfNeeded(ref petBool, petProjID, buffIndex);
	}

	public void BuffHandle_SpawnPetIfNeeded(ref bool petBool, int petProjID, int buffIndex)
	{
		petBool = true;
		bool flag = true;
		if (ownedProjectileCounts[petProjID] > 0)
		{
			flag = false;
		}
		Vector2 center = base.Center;
		if (buffType[buffIndex] == 341)
		{
			float num = 10f;
			if (petProjID == 934)
			{
				center += new Vector2(num * (float)direction, 0f);
			}
			else
			{
				center -= new Vector2(num * (float)direction, 0f);
			}
		}
		if (flag && whoAmI == Main.myPlayer)
		{
			Projectile.NewProjectile(GetProjectileSource_Buff(buffIndex), center.X, center.Y, 0f, 0f, petProjID, 0, 0f, whoAmI);
		}
	}

	private Projectile FindNewestAI_164Minion(int type)
	{
		Projectile projectile = null;
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile2 = Main.projectile[i];
			if (projectile2.active && projectile2.owner == whoAmI && projectile2.type == type && (projectile == null || projectile.localAI[1] > projectile2.localAI[1]))
			{
				projectile = projectile2;
			}
		}
		return projectile;
	}

	private void UpdateAbigailStatus()
	{
		int num = 963;
		if (ownedProjectileCounts[970] < 1)
		{
			for (int i = 0; i < 1000; i++)
			{
				Projectile projectile = Main.projectile[i];
				if (projectile.active && projectile.owner == whoAmI && projectile.type == num)
				{
					projectile.Kill();
				}
			}
		}
		else if (ownedProjectileCounts[num] < 1)
		{
			Projectile.NewProjectile(FindNewestAI_164Minion(970).GetProjectileSource_FromThis(), base.Center, Vector2.Zero, num, 0, 0f, whoAmI);
		}
	}

	private void UpdateStormTigerStatus()
	{
		int num = GetDesiredStormTigerMinionRank() switch
		{
			1 => 833, 
			2 => 834, 
			3 => 835, 
			_ => -1, 
		};
		bool flag = false;
		if (num == -1)
		{
			flag = true;
		}
		for (int i = 0; i < ProjectileID.Sets.StormTigerIds.Length; i++)
		{
			int num2 = ProjectileID.Sets.StormTigerIds[i];
			if (num2 != num && ownedProjectileCounts[num2] >= 1)
			{
				flag = true;
				break;
			}
		}
		if (flag)
		{
			for (int j = 0; j < 1000; j++)
			{
				Projectile projectile = Main.projectile[j];
				if (projectile.active && projectile.owner == whoAmI && projectile.type != num && ProjectileID.Sets.StormTiger[projectile.type])
				{
					projectile.Kill();
				}
			}
		}
		else if (ownedProjectileCounts[num] < 1)
		{
			int num3 = Projectile.NewProjectile(FindNewestAI_164Minion(831).GetProjectileSource_FromThis(), base.Center, Vector2.Zero, num, 0, 0f, whoAmI, 0f, 1f);
			Main.projectile[num3].localAI[0] = 60f;
		}
	}

	private int GetDesiredStormTigerMinionRank()
	{
		int result = 0;
		int num = ownedProjectileCounts[831];
		if (num > 0)
		{
			result = 1;
		}
		if (num > 3)
		{
			result = 2;
		}
		if (num > 6)
		{
			result = 3;
		}
		return result;
	}

	public void Counterweight(Vector2 hitPos, int dmg, float kb)
	{
		if (!yoyoGlove && counterWeight <= 0)
		{
			return;
		}
		int num = -1;
		int num2 = 0;
		int num3 = 0;
		for (int i = 0; i < 1000; i++)
		{
			if (!Main.projectile[i].active || Main.projectile[i].owner != whoAmI)
			{
				continue;
			}
			if (Main.projectile[i].counterweight)
			{
				if (Main.projectile[i].ai[0] != -2f)
				{
					num3++;
				}
			}
			else if (Main.projectile[i].aiStyle == 99 && Main.projectile[i].ai[0] != -2f)
			{
				num2++;
				num = i;
			}
		}
		if (yoyoGlove && num2 < 2)
		{
			if (num >= 0)
			{
				Vector2 vector = hitPos - base.Center;
				vector.Normalize();
				vector *= 16f;
				Projectile.NewProjectile(Projectile.InheritSource(Main.projectile[num]), base.Center.X, base.Center.Y, vector.X, vector.Y, Main.projectile[num].type, Main.projectile[num].damage, Main.projectile[num].knockBack, whoAmI, 1f);
			}
		}
		else if (num3 < num2)
		{
			Vector2 vector2 = hitPos - base.Center;
			vector2.Normalize();
			vector2 *= 16f;
			float knockBack = (kb + 6f) / 2f;
			IEntitySource spawnSource = Projectile.InheritSource(Main.projectile[num]);
			int type = counterWeight;
			if (vanityCounterWeight != 0)
			{
				type = vanityCounterWeight;
			}
			if (num3 > 0)
			{
				Projectile.NewProjectile(spawnSource, base.Center.X, base.Center.Y, vector2.X, vector2.Y, type, dmg, knockBack, whoAmI, 1f);
			}
			else
			{
				Projectile.NewProjectile(spawnSource, base.Center.X, base.Center.Y, vector2.X, vector2.Y, type, dmg, knockBack, whoAmI);
			}
		}
	}

	public int beeType()
	{
		if (strongBees && Main.rand.Next(2) == 0)
		{
			makeStrongBee = true;
			return 566;
		}
		makeStrongBee = false;
		return 181;
	}

	public int beeDamage(int dmg)
	{
		if (makeStrongBee)
		{
			return dmg + Main.rand.Next(1, 4);
		}
		return dmg + Main.rand.Next(2);
	}

	public float beeKB(float KB)
	{
		if (makeStrongBee)
		{
			return 0.5f + KB * 1.1f;
		}
		return KB;
	}

	public void Yoraiz0rEye()
	{
		int num = 0;
		num += bodyFrame.Y / 56;
		if (num >= Main.OffsetsPlayerHeadgear.Length)
		{
			num = 0;
		}
		Vector2 vector = Main.OffsetsPlayerHeadgear[num];
		vector *= Directions;
		Vector2 pos = new Vector2(width / 2, height / 2) + vector + (MountedCenter - base.Center);
		sitting.GetSittingOffsetInfo(this, out var posOffset, out var seatAdjustment);
		pos += posOffset + new Vector2(0f, seatAdjustment);
		if (face == 19)
		{
			pos.Y -= 5f * gravDir;
		}
		if (head == 276)
		{
			pos.X += 2.5f * (float)direction;
		}
		if (mount.Active)
		{
			switch (mount.Type)
			{
			case 52:
				pos.X += 14f * (float)direction;
				pos.Y -= 2f * gravDir;
				break;
			case 54:
				ApplyHeadOffsetFromMount(ref pos);
				pos.X -= 14f * (float)direction;
				break;
			case 56:
			case 61:
				ApplyHeadOffsetFromMount(ref pos);
				pos.X += 6f * Directions.X;
				pos.Y -= 10f * Directions.Y;
				break;
			case 55:
				ApplyHeadOffsetFromMount(ref pos);
				pos.Y -= 8f * Directions.Y;
				break;
			}
		}
		float y = -11.5f * gravDir;
		Vector2 vector2 = new Vector2(3 * direction - ((direction == 1) ? 1 : 0), y) + Vector2.UnitY * gfxOffY + pos;
		Vector2 vector3 = new Vector2(3 * shadowDirection[1] - ((direction == 1) ? 1 : 0), y) + pos;
		Vector2 zero = Vector2.Zero;
		if (mount.Active && mount.AnyTrackRider)
		{
			Vector2 zero2 = Vector2.Zero;
			int num2 = Math.Sign(velocity.X);
			if (num2 == 0)
			{
				num2 = direction;
			}
			zero2 = new Vector2(MathHelper.Lerp(0f, -8f, fullRotation / ((float)Math.PI / 4f)), MathHelper.Lerp(0f, 2f, Math.Abs(fullRotation / ((float)Math.PI / 4f)))).RotatedBy(fullRotation);
			if (num2 == Math.Sign(fullRotation))
			{
				zero2 *= MathHelper.Lerp(1f, 0.6f, Math.Abs(fullRotation / ((float)Math.PI / 4f)));
			}
			zero += zero2;
		}
		if (sleeping.isSleeping)
		{
			zero += sleeping.visualOffsetOfBedBase * Directions;
		}
		if (fullRotation != 0f)
		{
			vector2 = vector2.RotatedBy(fullRotation, fullRotationOrigin);
			vector3 = vector3.RotatedBy(fullRotation, fullRotationOrigin);
		}
		float num3 = 0f;
		Vector2 vector4 = position + vector2 + zero;
		Vector2 vector5 = oldPosition + vector3 + zero;
		vector5.Y -= num3 / 2f;
		vector4.Y -= num3 / 2f;
		float num4 = 1f;
		switch (yoraiz0rEye % 10)
		{
		case 1:
			return;
		case 2:
			num4 = 0.5f;
			break;
		case 3:
			num4 = 0.625f;
			break;
		case 4:
			num4 = 0.75f;
			break;
		case 5:
			num4 = 0.875f;
			break;
		case 6:
			num4 = 1f;
			break;
		case 7:
			num4 = 1.1f;
			break;
		}
		if (yoraiz0rEye < 7)
		{
			DelegateMethods.v3_1 = Main.hslToRgb(Main.rgbToHsl(eyeColor).X, 1f, 0.5f).ToVector3() * 0.5f * num4;
			if (velocity != Vector2.Zero)
			{
				Utils.PlotTileLine(base.Center, base.Center + velocity * 2f, 4f, DelegateMethods.CastLightOpen);
			}
			else
			{
				Utils.PlotTileLine(base.Left, base.Right, 4f, DelegateMethods.CastLightOpen);
			}
		}
		int num5 = (int)Vector2.Distance(vector4, vector5) / 3 + 1;
		if (Vector2.Distance(vector4, vector5) % 3f != 0f)
		{
			num5++;
		}
		for (float num6 = 1f; num6 <= (float)num5; num6 += 1f)
		{
			Dust obj = Main.dust[Dust.NewDust(base.Center, 0, 0, 182)];
			obj.position = Vector2.Lerp(vector5, vector4, num6 / (float)num5);
			obj.noGravity = true;
			obj.velocity = Vector2.Zero;
			obj.customData = this;
			obj.scale = num4;
			obj.shader = GameShaders.Armor.GetSecondaryShader(cYorai, this);
		}
	}

	public bool IsItemSlotUnlockedAndUsable(int slot)
	{
		switch (slot)
		{
		default:
			return true;
		case 8:
		case 18:
		{
			bool result2 = extraAccessory;
			if (!Main.expertMode && !Main.gameMenu)
			{
				result2 = false;
			}
			return result2;
		}
		case 9:
		case 19:
		{
			bool result = true;
			if (!Main.masterMode && !Main.gameMenu)
			{
				result = false;
			}
			return result;
		}
		}
	}

	public void RefreshInfoAccs()
	{
		bool flag = false;
		accWatch = 0;
		accCompass = 0;
		accDepthMeter = 0;
		accFishFinder = false;
		accWeatherRadio = false;
		accCalendar = false;
		accThirdEye = false;
		accJarOfSouls = false;
		accCritterGuide = false;
		accStopwatch = false;
		accOreFinder = false;
		accDreamCatcher = false;
		for (int i = 0; i < 58; i++)
		{
			int type = inventory[i].type;
			RefreshInfoAccsFromItemType(type);
			if (type == 4131)
			{
				flag = true;
			}
		}
		for (int j = 0; j < 20; j++)
		{
			if (IsItemSlotUnlockedAndUsable(j))
			{
				int type2 = armor[j].type;
				RefreshInfoAccsFromItemType(type2);
			}
		}
		if (flag)
		{
			for (int k = 0; k < bank4.maxItems; k++)
			{
				int type3 = bank4.item[k].type;
				if (type3 < 0 || type3 > ItemID.Count || ItemID.Sets.WorksInVoidBag[type3])
				{
					RefreshInfoAccsFromItemType(type3);
				}
			}
		}
		RefreshInfoAccsFromTeamPlayers();
	}

	public void RefreshInfoAccsFromTeamPlayers()
	{
		if (Main.netMode != 1 || whoAmI != Main.myPlayer)
		{
			return;
		}
		for (int i = 0; i < 255; i++)
		{
			if (i == whoAmI || !Main.player[i].active || Main.player[i].dead || Main.player[i].team != team || Main.player[i].team == 0)
			{
				continue;
			}
			int num = 800;
			if ((Main.player[i].Center - base.Center).Length() < (float)num)
			{
				if (Main.player[i].accWatch > accWatch)
				{
					accWatch = Main.player[i].accWatch;
				}
				if (Main.player[i].accCompass > accCompass)
				{
					accCompass = Main.player[i].accCompass;
				}
				if (Main.player[i].accDepthMeter > accDepthMeter)
				{
					accDepthMeter = Main.player[i].accDepthMeter;
				}
				if (Main.player[i].accFishFinder)
				{
					accFishFinder = true;
				}
				if (Main.player[i].accWeatherRadio)
				{
					accWeatherRadio = true;
				}
				if (Main.player[i].accThirdEye)
				{
					accThirdEye = true;
				}
				if (Main.player[i].accJarOfSouls)
				{
					accJarOfSouls = true;
				}
				if (Main.player[i].accCalendar)
				{
					accCalendar = true;
				}
				if (Main.player[i].accStopwatch)
				{
					accStopwatch = true;
				}
				if (Main.player[i].accOreFinder)
				{
					accOreFinder = true;
				}
				if (Main.player[i].accCritterGuide)
				{
					accCritterGuide = true;
				}
				if (Main.player[i].accDreamCatcher)
				{
					accDreamCatcher = true;
				}
				if (Main.player[i].hasLuck_LuckyHorseshoe)
				{
					hasLuck_LuckyHorseshoe = true;
				}
				if (Main.player[i].hasLuck_LuckyCoin)
				{
					hasLuck_LuckyCoin = true;
				}
			}
		}
	}

	public void RefreshInfoAccsFromItemType(int accType)
	{
		if (accType == 5574)
		{
			hasLuck_LuckyClover = true;
		}
		if (accType == 5575)
		{
			hasLuck_WiltedClover = true;
		}
		if (accType == 5576)
		{
			hasLuck_RavenFeather = true;
		}
		if ((accType == 15 || accType == 707) && accWatch < 1)
		{
			accWatch = 1;
		}
		if ((accType == 16 || accType == 708) && accWatch < 2)
		{
			accWatch = 2;
		}
		if ((accType == 17 || accType == 709) && accWatch < 3)
		{
			accWatch = 3;
		}
		if (accType == 393)
		{
			accCompass = 1;
		}
		if (accType == 18)
		{
			accDepthMeter = 1;
		}
		if (accType == 395 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accWatch = 3;
			accDepthMeter = 1;
			accCompass = 1;
		}
		if (accType == 3120 || accType == 3036 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accFishFinder = true;
		}
		if (accType == 3037 || accType == 3036 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accWeatherRadio = true;
		}
		if (accType == 3096 || accType == 3036 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accCalendar = true;
		}
		if (accType == 3084 || accType == 3122 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accThirdEye = true;
		}
		if (accType == 3095 || accType == 3122 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accJarOfSouls = true;
		}
		if (accType == 3118 || accType == 3122 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accCritterGuide = true;
		}
		if (accType == 3099 || accType == 3121 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accStopwatch = true;
		}
		if (accType == 3102 || accType == 3121 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accOreFinder = true;
		}
		if (accType == 3119 || accType == 3121 || accType == 3123 || accType == 3124 || accType == 5358 || accType == 5359 || accType == 5360 || accType == 5361)
		{
			accDreamCatcher = true;
		}
	}

	public void RefreshMechanicalAccsFromItemType(int accType)
	{
		if (accType == 3619 || accType == 3611)
		{
			InfoAccMechShowWires = true;
		}
		if (accType == 486 || accType == 3611)
		{
			rulerLine = true;
		}
		if (accType == 2799 || accType == 3611)
		{
			rulerGrid = true;
		}
		if (accType == 2216 || accType == 3061 || accType == 5126)
		{
			autoPaint = true;
		}
		if (accType == 3624)
		{
			autoActuator = true;
		}
		if (accType == 4346)
		{
			preventAllItemPickups = true;
		}
		if (accType == 4767 || accType == 5323)
		{
			dontHurtCritters = true;
		}
		if (accType == 5309 || accType == 5323)
		{
			dontHurtNature = true;
		}
		if (accType == 5095)
		{
			hasLucyTheAxe = true;
		}
	}

	public void RefreshAutoKitingFromItemTypeAndSlot(int accType, int slot)
	{
		if (selectedKite <= -1 && ItemID.Sets.IsAKite[accType])
		{
			selectedKite = slot;
		}
	}

	public void UpdatePermanentBoosters()
	{
		if (usedAegisFruit)
		{
			statDefense += 4;
		}
		if (usedGummyWorm)
		{
			fishingSkill += 3;
		}
		if (usedAmbrosia)
		{
			pickSpeed -= 0.05f;
			tileSpeed += 0.05f;
			wallSpeed += 0.05f;
		}
	}

	private bool UpdateEquips_CanItemGrantBenefits(int itemSlot, Item item)
	{
		switch (itemSlot)
		{
		default:
			return true;
		case 0:
			return item.headSlot > -1;
		case 1:
			return item.bodySlot > -1;
		case 2:
			return item.legSlot > -1;
		case 3:
		case 4:
		case 5:
		case 6:
		case 7:
		case 8:
		case 9:
			return item.accessory;
		}
	}

	public void UpdateEquips(int i)
	{
		if (inventory[selectedItem].type == 277 && (!mount.Active || !mount.Cart))
		{
			trident = true;
		}
		RefreshAutoKitingFromItemTypeAndSlot(HeldItem.type, selectedItem);
		bool flag = false;
		for (int j = 0; j < 58; j++)
		{
			int type = inventory[j].type;
			RefreshInfoAccsFromItemType(type);
			RefreshMechanicalAccsFromItemType(type);
			RefreshAutoKitingFromItemTypeAndSlot(type, j);
			if (type == 4743)
			{
				hasFootball = true;
			}
			if (type == 4131)
			{
				flag = true;
			}
		}
		if (inventory[58].type == 4743)
		{
			hasFootball = true;
		}
		for (int k = 0; k < 10; k++)
		{
			Item item = armor[k];
			if (!item.IsAir && IsItemSlotUnlockedAndUsable(k) && (!item.expertOnly || Main.expertMode) && UpdateEquips_CanItemGrantBenefits(k, item))
			{
				if (item.accessory)
				{
					GrantPrefixBenefits(item);
				}
				GrantArmorBenefits(item);
			}
		}
		if (flag)
		{
			for (int l = 0; l < bank4.maxItems; l++)
			{
				int type2 = bank4.item[l].type;
				if (type2 < 0 || type2 > ItemID.Count || ItemID.Sets.WorksInVoidBag[type2])
				{
					RefreshInfoAccsFromItemType(type2);
					RefreshMechanicalAccsFromItemType(type2);
				}
			}
		}
		equippedAnyWallSpeedAcc = false;
		equippedAnyTileSpeedAcc = false;
		equippedAnyTileRangeAcc = false;
		for (int m = 3; m < 10; m++)
		{
			if (IsItemSlotUnlockedAndUsable(m))
			{
				ApplyEquipFunctional(m, armor[m]);
			}
		}
		if (stressBall != stressBallPrevious)
		{
			controlUseItem = false;
			stressBallPrevious = stressBall;
		}
		if (accFishingBobber)
		{
			fishingSkill += 10;
		}
		if (skyStoneEffects)
		{
			lifeRegen += 2;
			statDefense += 4;
			meleeSpeed += 0.1f;
			meleeDamage += 0.1f;
			meleeCrit += 2;
			rangedDamage += 0.1f;
			rangedCrit += 2;
			magicDamage += 0.1f;
			magicCrit += 2;
			pickSpeed -= 0.15f;
			minionDamage += 0.1f;
			minionKB += 0.5f;
		}
		if (dd2Accessory)
		{
			minionDamage += 0.1f;
			maxTurrets++;
		}
		for (int n = 3; n < 10; n++)
		{
			if (armor[n].wingSlot > 0 && IsItemSlotUnlockedAndUsable(n))
			{
				if (!hideVisibleAccessory[n] || (velocity.Y != 0f && mount.CanUseWings))
				{
					wings = armor[n].wingSlot;
				}
				wingsLogic = armor[n].wingSlot;
			}
		}
		for (int num = 13; num < 20; num++)
		{
			if (IsItemSlotUnlockedAndUsable(num))
			{
				ApplyEquipVanity(num, armor[num]);
			}
		}
		if (wet && ShouldFloatInWater)
		{
			accFlipper = true;
		}
		if (whoAmI == Main.myPlayer && SceneMetrics.HasClock && accWatch < 3)
		{
			accWatch++;
		}
		if (equippedAnyTileSpeedAcc)
		{
			int createTile = inventory[selectedItem].createTile;
			if (createTile >= 0 && !TileID.Sets.Torches[createTile])
			{
				tileSpeed += 0.5f;
			}
		}
		if (chiselSpeed)
		{
			pickSpeed -= 0.25f;
		}
		if (equippedAnyWallSpeedAcc)
		{
			wallSpeed += 0.5f;
		}
		if (equippedAnyTileRangeAcc && whoAmI == Main.myPlayer)
		{
			tileRangeX += 3;
			tileRangeY += 2;
		}
		if (!accThirdEye)
		{
			accThirdEyeCounter = 0;
		}
		RefreshInfoAccsFromTeamPlayers();
		if (whoAmI == Main.myPlayer && hasLuck_LuckyClover)
		{
			equipmentBasedLuckBonus += 0.03f;
		}
		if (whoAmI == Main.myPlayer && hasLuck_WiltedClover)
		{
			equipmentBasedLuckBonus -= 0.1f;
		}
		if (whoAmI == Main.myPlayer && hasLuck_RavenFeather)
		{
			equipmentBasedLuckBonus -= 0.1f;
		}
		if (whoAmI == Main.myPlayer && hasLuck_LuckyHorseshoe)
		{
			equipmentBasedLuckBonus += 0.05f;
		}
		if (whoAmI == Main.myPlayer && hasLuck_LuckyCoin)
		{
			equipmentBasedLuckBonus += 0.05f;
		}
		if (!accDreamCatcher && dpsStarted)
		{
			dpsStarted = false;
			dpsEnd = DateTime.Now;
		}
		if (HeldItem.type == 4760 && ownedProjectileCounts[866] < 1)
		{
			hasRaisableShield = true;
		}
		int num2 = 0;
		int num3 = 10 + num2;
		int num4 = 2;
		int num5 = 10 + num4;
		if (armor[num2].type == 5101 || armor[num3].type == 5101)
		{
			DoEyebrellaRainEffect();
			eyebrellaCloud = true;
		}
		if (armor[num4].type == 668 || armor[num5].type == 668)
		{
			vanityRocketBoots = 6;
		}
		if (lastEquipmentBasedLuckBonus != equipmentBasedLuckBonus)
		{
			lastEquipmentBasedLuckBonus = equipmentBasedLuckBonus;
			luckNeedsSync = true;
		}
		if (mount.Active)
		{
			mount.UpdateAfterEquips(this);
		}
	}

	private void GrantArmorBenefits(Item armorPiece)
	{
		int type = armorPiece.type;
		RefreshInfoAccsFromItemType(type);
		RefreshMechanicalAccsFromItemType(type);
		if (armorPiece.type == 3017 || armorPiece.type == 3993)
		{
			flowerBoots = true;
			if (whoAmI == Main.myPlayer)
			{
				DoBootsEffect(DoBootsEffect_PlaceFlowersOnTile);
			}
		}
		if (armorPiece.type == 5001)
		{
			moveSpeed += 0.25f;
			moonLordLegs = true;
		}
		statDefense += armorPiece.defense;
		lifeRegen += armorPiece.lifeRegen;
		if (armorPiece.shieldSlot > 0)
		{
			hasRaisableShield = true;
		}
		switch (armorPiece.type)
		{
		case 5007:
			deadMansSweater = true;
			break;
		case 3797:
			maxTurrets++;
			manaCost -= 0.1f;
			magicDamage += 0.1f;
			break;
		case 3798:
			magicDamage += 0.1f;
			minionDamage += 0.2f;
			break;
		case 3799:
			minionDamage += 0.1f;
			magicCrit += 20;
			moveSpeed += 0.2f;
			break;
		case 3800:
			maxTurrets++;
			lifeRegen += 4;
			break;
		case 3801:
			meleeDamage += 0.15f;
			minionDamage += 0.15f;
			break;
		case 3802:
			minionDamage += 0.15f;
			meleeCrit += 15;
			moveSpeed += 0.15f;
			break;
		case 3806:
			maxTurrets++;
			meleeSpeed += 0.2f;
			break;
		case 3807:
			meleeDamage += 0.2f;
			minionDamage += 0.2f;
			break;
		case 3808:
			minionDamage += 0.1f;
			meleeCrit += 15;
			moveSpeed += 0.2f;
			break;
		case 3803:
			maxTurrets++;
			rangedCrit += 10;
			break;
		case 3804:
			rangedDamage += 0.2f;
			minionDamage += 0.2f;
			huntressAmmoCost90 = true;
			break;
		case 3805:
			minionDamage += 0.1f;
			moveSpeed += 0.2f;
			break;
		case 3871:
			maxTurrets += 2;
			meleeDamage += 0.1f;
			minionDamage += 0.1f;
			break;
		case 3872:
			minionDamage += 0.3f;
			lifeRegen += 8;
			break;
		case 3873:
			minionDamage += 0.2f;
			meleeCrit += 20;
			moveSpeed += 0.2f;
			break;
		case 3874:
			maxTurrets += 2;
			magicDamage += 0.15f;
			minionDamage += 0.15f;
			break;
		case 3875:
			minionDamage += 0.25f;
			magicDamage += 0.1f;
			manaCost -= 0.15f;
			break;
		case 3876:
			minionDamage += 0.2f;
			magicCrit += 25;
			moveSpeed += 0.2f;
			break;
		case 3877:
			maxTurrets += 2;
			minionDamage += 0.1f;
			rangedCrit += 10;
			break;
		case 3878:
			minionDamage += 0.25f;
			rangedDamage += 0.25f;
			ammoCost80 = true;
			break;
		case 3879:
			minionDamage += 0.25f;
			rangedCrit += 10;
			moveSpeed += 0.2f;
			break;
		case 3880:
			maxTurrets += 2;
			minionDamage += 0.2f;
			meleeDamage += 0.2f;
			break;
		case 3881:
			meleeSpeed += 0.2f;
			meleeCrit += 5;
			minionDamage += 0.2f;
			break;
		case 3882:
			minionDamage += 0.2f;
			meleeCrit += 20;
			moveSpeed += 0.3f;
			break;
		}
		if (armorPiece.type == 5100)
		{
			SpawnHallucination(armorPiece);
		}
		if (armorPiece.type == 268)
		{
			accDivingHelm = true;
		}
		if (armorPiece.type == 238)
		{
			magicDamage += 0.05f;
			if (Main.tenthAnniversaryWorld)
			{
				maxMinions++;
			}
		}
		if (armorPiece.type == 3770)
		{
			slowFall = true;
		}
		if (armorPiece.type == 4404)
		{
			canFloatInWater = true;
		}
		if (armorPiece.type == 3776)
		{
			magicDamage += 0.15f;
			minionDamage += 0.15f;
		}
		if (armorPiece.type == 3777)
		{
			statManaMax2 += 40;
			minionDamage += 0.1f;
			maxMinions++;
		}
		if (armorPiece.type == 3778)
		{
			statManaMax2 += 40;
			magicDamage += 0.1f;
			maxMinions++;
		}
		if (armorPiece.type == 3212)
		{
			armorPenetration += 5;
		}
		if (armorPiece.type == 2277)
		{
			magicDamage += 0.05f;
			meleeDamage += 0.05f;
			rangedDamage += 0.05f;
			minionDamage += 0.05f;
			magicCrit += 5;
			rangedCrit += 5;
			meleeCrit += 5;
			meleeSpeed += 0.1f;
			moveSpeed += 0.1f;
		}
		if (armorPiece.type == 2279)
		{
			magicDamage += 0.06f;
			magicCrit += 6;
			manaCost -= 0.1f;
		}
		if (armorPiece.type == 3109 || armorPiece.type == 4008)
		{
			nightVision = true;
		}
		if (armorPiece.type == 256 || armorPiece.type == 257 || armorPiece.type == 258)
		{
			rangedCrit += 3;
			meleeCrit += 3;
			magicCrit += 3;
		}
		if (armorPiece.type == 3374)
		{
			rangedCrit += 4;
		}
		if (armorPiece.type == 3375)
		{
			rangedDamage += 0.05f;
		}
		if (armorPiece.type == 3376)
		{
			rangedCrit += 4;
		}
		if (armorPiece.type == 151 || armorPiece.type == 959 || armorPiece.type == 152 || armorPiece.type == 153)
		{
			rangedDamage += 0.05f;
		}
		if (armorPiece.type == 2275)
		{
			magicDamage += 0.06f;
			magicCrit += 6;
		}
		if (armorPiece.type == 123 || armorPiece.type == 124 || armorPiece.type == 125)
		{
			magicDamage += 0.09f;
		}
		if (armorPiece.type == 228 || armorPiece.type == 960)
		{
			statManaMax2 += 40;
			magicCrit += 6;
		}
		if (armorPiece.type == 229 || armorPiece.type == 961)
		{
			statManaMax2 += 20;
			magicDamage += 0.06f;
		}
		if (armorPiece.type == 230 || armorPiece.type == 962)
		{
			statManaMax2 += 20;
			magicCrit += 6;
		}
		if (armorPiece.type == 100 || armorPiece.type == 101 || armorPiece.type == 102)
		{
			magicCrit += 5;
			meleeCrit += 5;
			rangedCrit += 5;
		}
		if (armorPiece.type == 956 || armorPiece.type == 957 || armorPiece.type == 958)
		{
			magicCrit += 5;
			meleeCrit += 5;
			rangedCrit += 5;
		}
		if (armorPiece.type == 792 || armorPiece.type == 793 || armorPiece.type == 794)
		{
			meleeDamage += 0.03f;
			rangedDamage += 0.03f;
			magicDamage += 0.03f;
			minionDamage += 0.03f;
		}
		if (armorPiece.type == 231)
		{
			meleeCrit += 7;
		}
		if (armorPiece.type == 232)
		{
			meleeDamage += 0.07f;
		}
		if (armorPiece.type == 233)
		{
			meleeSpeed += 0.07f;
		}
		if (armorPiece.type == 371)
		{
			magicCrit += 9;
			magicDamage += 0.1f;
			statManaMax2 += 40;
		}
		if (armorPiece.type == 372)
		{
			moveSpeed += 0.1f;
			meleeDamage += 0.15f;
		}
		if (armorPiece.type == 373)
		{
			rangedDamage += 0.1f;
			rangedCrit += 10;
		}
		if (armorPiece.type == 374)
		{
			magicCrit += 5;
			meleeCrit += 5;
			rangedCrit += 5;
		}
		if (armorPiece.type == 375)
		{
			rangedDamage += 0.03f;
			meleeDamage += 0.03f;
			magicDamage += 0.03f;
			minionDamage += 0.03f;
			moveSpeed += 0.1f;
		}
		if (armorPiece.type == 376)
		{
			magicDamage += 0.15f;
			statManaMax2 += 60;
		}
		if (armorPiece.type == 377)
		{
			meleeCrit += 8;
			meleeDamage += 0.1f;
		}
		if (armorPiece.type == 378)
		{
			rangedDamage += 0.12f;
			rangedCrit += 7;
		}
		if (armorPiece.type == 379)
		{
			rangedDamage += 0.07f;
			meleeDamage += 0.07f;
			magicDamage += 0.07f;
			minionDamage += 0.07f;
		}
		if (armorPiece.type == 380)
		{
			magicCrit += 10;
			meleeCrit += 10;
			rangedCrit += 10;
		}
		if (armorPiece.type == 2367 || armorPiece.type == 2368 || armorPiece.type == 2369 || armorPiece.type == 5591 || armorPiece.type == 5592 || armorPiece.type == 5593)
		{
			fishingSkill += 5;
		}
		if (armorPiece.type == 400)
		{
			magicDamage += 0.12f;
			magicCrit += 12;
			statManaMax2 += 80;
		}
		if (armorPiece.type == 401)
		{
			meleeCrit += 7;
			meleeDamage += 0.14f;
		}
		if (armorPiece.type == 402)
		{
			rangedDamage += 0.14f;
			rangedCrit += 10;
		}
		if (armorPiece.type == 403)
		{
			rangedDamage += 0.08f;
			meleeDamage += 0.08f;
			magicDamage += 0.08f;
			minionDamage += 0.08f;
		}
		if (armorPiece.type == 404)
		{
			magicCrit += 7;
			meleeCrit += 7;
			rangedCrit += 7;
			moveSpeed += 0.05f;
		}
		if (armorPiece.type == 1205)
		{
			meleeDamage += 0.12f;
			meleeSpeed += 0.12f;
		}
		if (armorPiece.type == 1206)
		{
			rangedDamage += 0.09f;
			rangedCrit += 9;
		}
		if (armorPiece.type == 1207)
		{
			magicDamage += 0.09f;
			magicCrit += 9;
			statManaMax2 += 60;
		}
		if (armorPiece.type == 1208)
		{
			meleeDamage += 0.03f;
			rangedDamage += 0.03f;
			magicDamage += 0.03f;
			minionDamage += 0.03f;
			magicCrit += 2;
			meleeCrit += 2;
			rangedCrit += 2;
		}
		if (armorPiece.type == 1209)
		{
			meleeDamage += 0.02f;
			rangedDamage += 0.02f;
			magicDamage += 0.02f;
			minionDamage += 0.02f;
			magicCrit++;
			meleeCrit++;
			rangedCrit++;
		}
		if (armorPiece.type == 1210)
		{
			meleeDamage += 0.11f;
			meleeSpeed += 0.11f;
			moveSpeed += 0.07f;
		}
		if (armorPiece.type == 1211)
		{
			rangedCrit += 15;
			moveSpeed += 0.08f;
		}
		if (armorPiece.type == 1212)
		{
			magicCrit += 18;
			statManaMax2 += 80;
		}
		if (armorPiece.type == 1213)
		{
			magicCrit += 6;
			meleeCrit += 6;
			rangedCrit += 6;
		}
		if (armorPiece.type == 1214)
		{
			moveSpeed += 0.11f;
			meleeDamage += 0.08f;
			rangedDamage += 0.08f;
			magicDamage += 0.08f;
			minionDamage += 0.08f;
		}
		if (armorPiece.type == 1215)
		{
			meleeDamage += 0.09f;
			meleeCrit += 9;
			meleeSpeed += 0.09f;
		}
		if (armorPiece.type == 1216)
		{
			rangedDamage += 0.16f;
			rangedCrit += 7;
		}
		if (armorPiece.type == 1217)
		{
			magicDamage += 0.16f;
			magicCrit += 7;
			statManaMax2 += 100;
		}
		if (armorPiece.type == 1218)
		{
			meleeDamage += 0.04f;
			rangedDamage += 0.04f;
			magicDamage += 0.04f;
			minionDamage += 0.04f;
			magicCrit += 3;
			meleeCrit += 3;
			rangedCrit += 3;
		}
		if (armorPiece.type == 1219)
		{
			meleeDamage += 0.03f;
			rangedDamage += 0.03f;
			magicDamage += 0.03f;
			minionDamage += 0.03f;
			magicCrit += 3;
			meleeCrit += 3;
			rangedCrit += 3;
			moveSpeed += 0.06f;
		}
		if (armorPiece.type == 558 || armorPiece.type == 4898)
		{
			magicDamage += 0.12f;
			magicCrit += 12;
			statManaMax2 += 100;
		}
		if (armorPiece.type == 559 || armorPiece.type == 4896)
		{
			meleeCrit += 10;
			meleeDamage += 0.1f;
			meleeSpeed += 0.1f;
		}
		if (armorPiece.type == 553 || armorPiece.type == 4897)
		{
			rangedDamage += 0.15f;
			rangedCrit += 8;
		}
		if (armorPiece.type == 4873 || armorPiece.type == 4899)
		{
			minionDamage += 0.1f;
			maxMinions++;
		}
		if (armorPiece.type == 551 || armorPiece.type == 4900)
		{
			magicCrit += 7;
			meleeCrit += 7;
			rangedCrit += 7;
		}
		if (armorPiece.type == 552 || armorPiece.type == 4901)
		{
			rangedDamage += 0.07f;
			meleeDamage += 0.07f;
			magicDamage += 0.07f;
			minionDamage += 0.07f;
			moveSpeed += 0.08f;
		}
		if (armorPiece.type == 4982)
		{
			rangedCrit += 5;
			meleeCrit += 5;
			magicCrit += 5;
			manaCost -= 0.1f;
		}
		if (armorPiece.type == 4983)
		{
			rangedDamage += 0.05f;
			meleeDamage += 0.05f;
			magicDamage += 0.05f;
			minionDamage += 0.05f;
			huntressAmmoCost90 = true;
		}
		if (armorPiece.type == 4984)
		{
			meleeSpeed += 0.1f;
			moveSpeed += 0.2f;
		}
		if (armorPiece.type == 1001)
		{
			meleeDamage += 0.16f;
			meleeCrit += 6;
		}
		if (armorPiece.type == 1002)
		{
			rangedDamage += 0.16f;
			chloroAmmoCost80 = true;
		}
		if (armorPiece.type == 1003)
		{
			magicDamage += 0.16f;
			statManaMax2 += 80;
			manaCost -= 0.17f;
		}
		if (armorPiece.type == 5524)
		{
			minionDamage += 0.16f;
			maxMinions++;
		}
		if (armorPiece.type == 1004)
		{
			meleeDamage += 0.05f;
			magicDamage += 0.05f;
			rangedDamage += 0.05f;
			minionDamage += 0.05f;
			magicCrit += 7;
			meleeCrit += 7;
			rangedCrit += 7;
		}
		if (armorPiece.type == 1005)
		{
			magicCrit += 8;
			meleeCrit += 8;
			rangedCrit += 8;
			moveSpeed += 0.05f;
		}
		if (armorPiece.type == 2189)
		{
			statManaMax2 += 60;
			manaCost -= 0.13f;
			magicDamage += 0.1f;
			magicCrit += 10;
		}
		if (armorPiece.type == 1504)
		{
			magicDamage += 0.07f;
			magicCrit += 7;
		}
		if (armorPiece.type == 1505)
		{
			magicDamage += 0.08f;
			moveSpeed += 0.08f;
		}
		if (armorPiece.type == 1546)
		{
			rangedCrit += 5;
			arrowDamage *= 1.12f;
		}
		if (armorPiece.type == 1547)
		{
			rangedCrit += 5;
			bulletDamage *= 1.12f;
		}
		if (armorPiece.type == 1548)
		{
			rangedCrit += 5;
			rocketDamage *= 1.12f;
		}
		if (armorPiece.type == 1549)
		{
			rangedCrit += 13;
			rangedDamage += 0.13f;
			ammoCost80 = true;
		}
		if (armorPiece.type == 1550)
		{
			rangedCrit += 7;
			moveSpeed += 0.12f;
		}
		if (armorPiece.type == 1282)
		{
			statManaMax2 += 20;
			manaCost -= 0.05f;
		}
		if (armorPiece.type == 1283)
		{
			statManaMax2 += 40;
			manaCost -= 0.07f;
		}
		if (armorPiece.type == 1284)
		{
			statManaMax2 += 40;
			manaCost -= 0.09f;
		}
		if (armorPiece.type == 1285)
		{
			statManaMax2 += 60;
			manaCost -= 0.11f;
		}
		if (armorPiece.type == 1286 || armorPiece.type == 4256)
		{
			statManaMax2 += 60;
			manaCost -= 0.13f;
		}
		if (armorPiece.type == 1287)
		{
			statManaMax2 += 80;
			manaCost -= 0.15f;
		}
		if (armorPiece.type == 1316 || armorPiece.type == 1317 || armorPiece.type == 1318)
		{
			aggro += 250;
		}
		if (armorPiece.type == 1316)
		{
			meleeDamage += 0.06f;
		}
		if (armorPiece.type == 1317)
		{
			meleeDamage += 0.08f;
			meleeCrit += 8;
		}
		if (armorPiece.type == 1318)
		{
			meleeCrit += 4;
		}
		if (armorPiece.type == 2199 || armorPiece.type == 2202)
		{
			aggro += 250;
		}
		if (armorPiece.type == 2201)
		{
			aggro += 400;
		}
		if (armorPiece.type == 2199)
		{
			meleeDamage += 0.06f;
		}
		if (armorPiece.type == 2200)
		{
			meleeDamage += 0.08f;
			meleeCrit += 8;
			meleeSpeed += 0.06f;
			moveSpeed += 0.06f;
		}
		if (armorPiece.type == 2201)
		{
			meleeDamage += 0.05f;
			meleeCrit += 5;
		}
		if (armorPiece.type == 2202)
		{
			meleeSpeed += 0.06f;
			moveSpeed += 0.06f;
		}
		if (armorPiece.type == 684)
		{
			rangedDamage += 0.16f;
			meleeDamage += 0.16f;
		}
		if (armorPiece.type == 685)
		{
			meleeCrit += 11;
			rangedCrit += 11;
		}
		if (armorPiece.type == 686)
		{
			moveSpeed += 0.08f;
			meleeSpeed += 0.1f;
		}
		if (armorPiece.type == 5068)
		{
			maxMinions++;
			minionDamage += 0.05f;
		}
		if (armorPiece.type == 2361)
		{
			maxMinions++;
			minionDamage += 0.04f;
		}
		if (armorPiece.type == 2362)
		{
			maxMinions++;
			minionDamage += 0.04f;
		}
		if (armorPiece.type == 2363)
		{
			minionDamage += 0.05f;
		}
		if (armorPiece.type == 3266)
		{
			minionDamage += 0.08f;
		}
		if (armorPiece.type == 3267)
		{
			maxMinions++;
		}
		if (armorPiece.type == 3268)
		{
			minionDamage += 0.08f;
		}
		if (armorPiece.type == 410 || armorPiece.type == 411 || armorPiece.type == 5589 || armorPiece.type == 5590)
		{
			pickSpeed -= 0.1f;
		}
		if (armorPiece.type >= 1158 && armorPiece.type <= 1161)
		{
			maxMinions++;
		}
		if (armorPiece.type == 1159)
		{
			whipRangeMultiplier += 0.1f;
		}
		if (armorPiece.type >= 1159 && armorPiece.type <= 1161)
		{
			minionDamage += 0.1f;
		}
		if (armorPiece.type >= 2370 && armorPiece.type <= 2371)
		{
			minionDamage += 0.05f;
			maxMinions++;
		}
		if (armorPiece.type == 2372)
		{
			minionDamage += 0.06f;
			maxMinions++;
		}
		if (armorPiece.type == 3381)
		{
			maxMinions++;
			maxTurrets++;
			minionDamage += 0.22f;
		}
		if (armorPiece.type == 3382 || armorPiece.type == 3383)
		{
			maxMinions += 2;
			whipRangeMultiplier += 0.15f;
			minionDamage += 0.22f;
		}
		if (armorPiece.type == 2763)
		{
			aggro += 300;
			meleeCrit += 26;
			lifeRegen += 2;
		}
		if (armorPiece.type == 2764)
		{
			aggro += 300;
			meleeDamage += 0.29f;
			lifeRegen += 2;
		}
		if (armorPiece.type == 2765)
		{
			aggro += 300;
			meleeSpeed += 0.15f;
			moveSpeed += 0.15f;
			lifeRegen += 2;
		}
		if (armorPiece.type == 2757)
		{
			rangedCrit += 7;
			rangedDamage += 0.16f;
		}
		if (armorPiece.type == 2758)
		{
			ammoCost75 = true;
			rangedCrit += 12;
			rangedDamage += 0.12f;
		}
		if (armorPiece.type == 2759)
		{
			rangedCrit += 8;
			rangedDamage += 0.08f;
			moveSpeed += 0.1f;
		}
		if (armorPiece.type == 2760)
		{
			statManaMax2 += 60;
			manaCost -= 0.15f;
			magicCrit += 7;
			magicDamage += 0.07f;
		}
		if (armorPiece.type == 2761)
		{
			magicDamage += 0.09f;
			magicCrit += 9;
		}
		if (armorPiece.type == 2762)
		{
			moveSpeed += 0.1f;
			magicDamage += 0.1f;
		}
		if (armorPiece.type == 1832)
		{
			maxMinions++;
			minionDamage += 0.11f;
		}
		if (armorPiece.type == 1833)
		{
			maxMinions += 2;
			minionDamage += 0.11f;
		}
		if (armorPiece.type == 1834)
		{
			moveSpeed += 0.2f;
			maxMinions++;
			minionDamage += 0.11f;
		}
	}

	private void GrantPrefixBenefits(Item item)
	{
		if (item.prefix == 62)
		{
			statDefense++;
		}
		if (item.prefix == 63)
		{
			statDefense += 2;
		}
		if (item.prefix == 64)
		{
			statDefense += 3;
		}
		if (item.prefix == 65)
		{
			statDefense += 4;
		}
		if (item.prefix == 66)
		{
			statManaMax2 += 20;
		}
		if (item.prefix == 67)
		{
			meleeCrit += 2;
			rangedCrit += 2;
			magicCrit += 2;
		}
		if (item.prefix == 68)
		{
			meleeCrit += 4;
			rangedCrit += 4;
			magicCrit += 4;
		}
		if (item.prefix == 69)
		{
			meleeDamage += 0.01f;
			rangedDamage += 0.01f;
			magicDamage += 0.01f;
			minionDamage += 0.01f;
		}
		if (item.prefix == 70)
		{
			meleeDamage += 0.02f;
			rangedDamage += 0.02f;
			magicDamage += 0.02f;
			minionDamage += 0.02f;
		}
		if (item.prefix == 71)
		{
			meleeDamage += 0.03f;
			rangedDamage += 0.03f;
			magicDamage += 0.03f;
			minionDamage += 0.03f;
		}
		if (item.prefix == 72)
		{
			meleeDamage += 0.04f;
			rangedDamage += 0.04f;
			magicDamage += 0.04f;
			minionDamage += 0.04f;
		}
		if (item.prefix == 73)
		{
			moveSpeed += 0.01f;
		}
		if (item.prefix == 74)
		{
			moveSpeed += 0.02f;
		}
		if (item.prefix == 75)
		{
			moveSpeed += 0.03f;
		}
		if (item.prefix == 76)
		{
			moveSpeed += 0.04f;
		}
		if (item.prefix == 77)
		{
			meleeSpeed += 0.01f;
		}
		if (item.prefix == 78)
		{
			meleeSpeed += 0.02f;
		}
		if (item.prefix == 79)
		{
			meleeSpeed += 0.03f;
		}
		if (item.prefix == 80)
		{
			meleeSpeed += 0.04f;
		}
	}

	private void SpawnHallucination(Item item)
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		insanityShadowCooldown = Utils.Clamp(insanityShadowCooldown - 1, 0, 100);
		if (insanityShadowCooldown > 0)
		{
			return;
		}
		insanityShadowCooldown = Main.rand.Next(20, 101);
		float num = 500f;
		int damage = 18;
		_hallucinationCandidates.Clear();
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (nPC.CanBeChasedBy(this) && !(Distance(nPC.Center) > num) && Collision.CanHitLine(position, width, height, nPC.position, nPC.width, nPC.height))
			{
				_hallucinationCandidates.Add(nPC);
			}
		}
		if (_hallucinationCandidates.Count != 0)
		{
			Projectile.RandomizeInsanityShadowFor(Main.rand.NextFromCollection(_hallucinationCandidates), isHostile: false, out var spawnposition, out var spawnvelocity, out var ai, out var ai2);
			Projectile.NewProjectile(new EntitySource_ItemUse(this, item), spawnposition, spawnvelocity, 964, damage, 0f, whoAmI, ai, ai2);
		}
	}

	public void DoBootsEffect(Utils.TileActionAttempt theEffectMethod)
	{
		if (miscCounter % 2 == 0 && velocity.Y == 0f && grappling[0] == -1 && CanSpawnWalkingEffects())
		{
			int x = (int)base.Center.X / 16;
			int y = (int)(position.Y + (float)height - 1f) / 16;
			theEffectMethod(x, y);
		}
	}

	public bool DoBootsEffect_PlaceFlamesOnTile(int X, int Y)
	{
		Tile tile = Main.tile[X, Y + 1];
		if (tile == null || !tile.active() || tile.liquid > 0 || !WorldGen.SolidTileAllowBottomSlope(X, Y + 1))
		{
			return false;
		}
		ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.FlameWaders, new ParticleOrchestraSettings
		{
			PositionInWorld = new Vector2(X * 16 + 8, Y * 16 + 16)
		}, whoAmI);
		return true;
	}

	public bool DoBootsEffect_PlaceFlowersOnTile(int X, int Y)
	{
		Tile tile = Main.tile[X, Y];
		if (tile == null)
		{
			return false;
		}
		if (!tile.active() && tile.liquid == 0 && Main.tile[X, Y + 1] != null && WorldGen.SolidTile(X, Y + 1))
		{
			tile.frameY = 0;
			tile.slope(0);
			tile.halfBrick(halfBrick: false);
			if (Main.tile[X, Y + 1].type == 2 || Main.tile[X, Y + 1].type == 477)
			{
				int num = Main.rand.NextFromList<int>(6, 7, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 24, 27, 30, 33, 36, 39, 42);
				switch (num)
				{
				case 21:
				case 24:
				case 27:
				case 30:
				case 33:
				case 36:
				case 39:
				case 42:
					num += Main.rand.Next(3);
					break;
				}
				tile.active(active: true);
				tile.type = 3;
				tile.frameX = (short)(num * 18);
				tile.CopyPaintAndCoating(Main.tile[X, Y + 1]);
				if (Main.netMode == 1)
				{
					NetMessage.SendTileSquare(-1, X, Y);
				}
				return true;
			}
			if (Main.tile[X, Y + 1].type == 109 || Main.tile[X, Y + 1].type == 492)
			{
				if (Main.rand.Next(2) == 0)
				{
					tile.active(active: true);
					tile.type = 110;
					tile.frameX = (short)(18 * Main.rand.Next(4, 7));
					tile.CopyPaintAndCoating(Main.tile[X, Y + 1]);
					while (tile.frameX == 90)
					{
						tile.frameX = (short)(18 * Main.rand.Next(4, 7));
					}
				}
				else
				{
					tile.active(active: true);
					tile.type = 113;
					tile.frameX = (short)(18 * Main.rand.Next(2, 8));
					tile.CopyPaintAndCoating(Main.tile[X, Y + 1]);
					while (tile.frameX == 90)
					{
						tile.frameX = (short)(18 * Main.rand.Next(2, 8));
					}
				}
				if (Main.netMode == 1)
				{
					NetMessage.SendTileSquare(-1, X, Y);
				}
				return true;
			}
			if (Main.tile[X, Y + 1].type == 60)
			{
				tile.active(active: true);
				tile.type = 74;
				tile.frameX = (short)(18 * Main.rand.Next(9, 17));
				tile.CopyPaintAndCoating(Main.tile[X, Y + 1]);
				if (Main.netMode == 1)
				{
					NetMessage.SendTileSquare(-1, X, Y);
				}
				return true;
			}
			if (Main.tile[X, Y + 1].type == 633)
			{
				tile.active(active: true);
				tile.type = 637;
				tile.frameX = (short)(18 * Main.rand.Next(6, 11));
				tile.CopyPaintAndCoating(Main.tile[X, Y + 1]);
				if (Main.netMode == 1)
				{
					NetMessage.SendTileSquare(-1, X, Y);
				}
				return true;
			}
		}
		return false;
	}

	private void ApplyEquipVanity(int itemSlot, Item currentItem)
	{
		int type = currentItem.type;
		RefreshInfoAccsFromItemType(type);
		if (currentItem.wingSlot > 0)
		{
			wings = currentItem.wingSlot;
		}
		if (type == 861 || type == 3110 || type == 485)
		{
			hideWolf = false;
			forceWerewolf = true;
		}
		switch (type)
		{
		case 5452:
			remoteVisionForDrone = true;
			break;
		case 5345:
			CanSeeInvisibleBlocks = true;
			break;
		}
		ApplyShader(type);
		if (type >= 3309 && currentItem.type <= 3314)
		{
			vanityCounterWeight = 556 + currentItem.type - 3309;
		}
		if (((wet && !lavaWet && (!mount.Active || !mount.IsConsideredASlimeMount)) || !forceWerewolf) && (type == 861 || type == 3110 || type == 497))
		{
			hideMerman = false;
			forceMerman = true;
		}
		if ((!mount.Active || mount.Type != 47) && (type == 4822 || type == 4874))
		{
			DoBootsEffect(DoBootsEffect_PlaceFlamesOnTile);
		}
		ApplyMusicBox(currentItem);
		UpdateBootVisualEffects(currentItem);
		UpdateFishingBobber(currentItem);
		if (currentItem.voiceSlot != 0)
		{
			voiceOverride = currentItem.voiceSlot;
		}
		if (currentItem.type == 5077)
		{
			DoGlassSlipperSparkles();
		}
	}

	public void ApplyShader(int itemType)
	{
		switch (itemType)
		{
		case 3538:
			stardustMonolithShader = true;
			break;
		case 3537:
			nebulaMonolithShader = true;
			break;
		case 3536:
			vortexMonolithShader = true;
			break;
		case 3539:
			solarMonolithShader = true;
			break;
		case 4318:
			moonLordMonolithShader = true;
			break;
		case 4054:
			bloodMoonMonolithShader = true;
			break;
		case 5347:
			shimmerMonolithShader = true;
			break;
		case 5598:
			CRTMonolithShader = true;
			break;
		case 5599:
			retroMonolithShader = true;
			break;
		case 5655:
			noirShader = true;
			break;
		}
		if (itemType == 5113)
		{
			dontStarveShader = !dontStarveShader;
		}
	}

	private void DoGlassSlipperSparkles()
	{
		if (Main.rand.Next(60) == 0)
		{
			Rectangle r = Utils.CenteredRectangle(base.Center + new Vector2(0f, gravDir * 16f), new Vector2(20f, 8f));
			int num = Dust.NewDust(r.TopLeft(), r.Width, r.Height, 204, 0f, 0f, 150, default(Color), 0.3f);
			Main.dust[num].fadeIn = 1f;
			Main.dust[num].velocity *= 0.1f;
			Main.dust[num].noLight = true;
			Main.dust[num].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
		}
		if (CanSpawnWalkingEffects() && Main.rand.Next(10) == 0)
		{
			Rectangle r2 = Utils.CenteredRectangle(base.Center + new Vector2(direction * -2, gravDir * 16f), new Vector2(6f, 8f));
			int num2 = Dust.NewDust(r2.TopLeft(), r2.Width, r2.Height, 204, 0f, 0f, 150, default(Color), 0.3f);
			Main.dust[num2].fadeIn = 1f;
			Main.dust[num2].velocity *= 0.1f;
			Main.dust[num2].noLight = true;
			Main.dust[num2].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
		}
	}

	private void DoEyebrellaRainEffect()
	{
		if (Main.netMode == 2 || Main.dedServ || Main.mapFullscreen || Main.rand.Next(4) != 0)
		{
			return;
		}
		Vector2 pos = Vector2.Zero;
		ApplyHeadOffsetFromMount(ref pos);
		if (mount.Active)
		{
			int type = mount.Type;
			if (type == 54)
			{
				pos += new Vector2(-14f, 0f) * Directions;
			}
		}
		Vector2 vector = MountedCenter - new Vector2(0f, (float)height * 0.5f) + new Vector2((-0.5f + Main.rand.NextFloat()) * (float)(width + 18), -30f) + pos;
		int num = (int)(vector.X / 16f);
		int num2 = (int)(vector.Y / 16f);
		if (WorldGen.InWorld(num, num2))
		{
			Tile tile = Main.tile[num, num2];
			if (tile != null && !WorldGen.SolidTile3(tile) && tile.liquid <= 0)
			{
				Rain.NewRainForced(Velocity: new Vector2(Main.windSpeedCurrent * 3f, 9f), Position: vector);
			}
		}
	}

	public WingStats GetWingStats(int wingID)
	{
		if (wingID <= 0 || wingID >= ArmorIDs.Wing.Sets.Stats.Length)
		{
			return default(WingStats);
		}
		return ArmorIDs.Wing.Sets.Stats[wingID];
	}

	public bool CanUseStressBall()
	{
		if (selectedItem >= inventory.Length - 1 || !IsConsideredStandingStill)
		{
			return false;
		}
		if (whoAmI == Main.myPlayer && extractinateHover)
		{
			return true;
		}
		Item item = inventory[selectedItem];
		if (!wellFed && itemAnimation == 0 && releaseUseItem && (item.buffType == 26 || item.buffType == 206 || item.buffType == 207))
		{
			return true;
		}
		if (item.IsACoin || item.type == 1338)
		{
			return false;
		}
		if (item.damage > 0 || item.type == 1124)
		{
			return true;
		}
		return false;
	}

	private void ApplyEquipFunctional(int itemSlot, Item currentItem)
	{
		if (currentItem.expertOnly && !Main.expertMode)
		{
			return;
		}
		if (currentItem.type == 3810 || currentItem.type == 3809 || currentItem.type == 3812 || currentItem.type == 3811)
		{
			dd2Accessory = true;
		}
		if (!hideVisibleAccessory[itemSlot])
		{
			UpdateBootVisualEffects(currentItem);
			UpdateFishingBobber(currentItem);
			if (currentItem.voiceSlot != 0)
			{
				voiceOverride = currentItem.voiceSlot;
			}
			if (currentItem.type == 5077)
			{
				DoGlassSlipperSparkles();
			}
		}
		switch (currentItem.type)
		{
		case 5465:
			hasDeadCellsDownDash = true;
			break;
		case 4056:
			chiselSpeed = true;
			break;
		case 3990:
			accRunSpeed = 6f;
			autoJump = true;
			jumpSpeedBoost += 1.6f;
			extraFall += 10;
			break;
		case 3991:
			manaFlower = true;
			manaCost -= 0.08f;
			aggro -= 400;
			break;
		case 3992:
			kbGlove = true;
			autoReuseGlove = true;
			meleeScaleGlove = true;
			meleeSpeed += 0.12f;
			aggro += 400;
			break;
		case 3993:
			accRunSpeed = 6f;
			rocketBoots = (vanityRocketBoots = 2);
			break;
		case 4055:
			accRunSpeed = 6f;
			desertBoots = true;
			break;
		case 3994:
			autoJump = true;
			jumpSpeedBoost += 1.6f;
			extraFall += 10;
			accFlipper = true;
			break;
		case 3995:
			autoJump = true;
			jumpSpeedBoost += 1.6f;
			extraFall += 10;
			accFlipper = true;
			spikedBoots += 2;
			break;
		case 3996:
			autoJump = true;
			jumpSpeedBoost += 1.6f;
			extraFall += 10;
			spikedBoots += 2;
			break;
		case 3998:
			aggro += 400;
			break;
		case 4038:
			fireWalk = true;
			break;
		case 4003:
			fireWalk = true;
			lavaRose = true;
			break;
		case 4000:
			manaFlower = true;
			manaCost -= 0.08f;
			manaMagnet = true;
			break;
		case 4001:
			manaFlower = true;
			manaCost -= 0.08f;
			starCloakItem = currentItem;
			starCloakItem_manaCloakOverrideItem = currentItem;
			break;
		case 4002:
			magicQuiver = true;
			arrowDamageAdditiveStack += 0.1f;
			hasMoltenQuiver = true;
			break;
		case 4004:
			fireWalk = true;
			lavaRose = true;
			break;
		case 3999:
			fireWalk = true;
			break;
		case 4005:
			rangedCrit += 10;
			rangedDamage += 0.1f;
			aggro -= 400;
			break;
		case 4006:
			aggro -= 400;
			magicQuiver = true;
			arrowDamageAdditiveStack += 0.1f;
			break;
		case 4007:
			honeyCombItem = currentItem;
			armorPenetration += 5;
			break;
		case 4341:
		case 5126:
			portableStoolInfo.SetStats(26, 26, 26);
			break;
		case 4409:
			CanSeeInvisibleBlocks = true;
			break;
		case 5010:
			treasureMagnet = true;
			break;
		case 3245:
			boneGloveItem = currentItem;
			break;
		case 5107:
			hasMagiluminescence = true;
			MountedCenter.ToTileCoordinates();
			DelegateMethods.v3_1 = new Vector3(0.9f, 0.8f, 0.5f);
			Utils.PlotTileLine(base.Center, base.Center + velocity * 6f, 20f, DelegateMethods.CastLightOpen);
			Utils.PlotTileLine(base.Left, base.Right, 20f, DelegateMethods.CastLightOpen);
			break;
		}
		if (currentItem.type == 3015)
		{
			aggro -= 400;
			meleeCrit += 5;
			magicCrit += 5;
			rangedCrit += 5;
			meleeDamage += 0.05f;
			magicDamage += 0.05f;
			rangedDamage += 0.05f;
			minionDamage += 0.05f;
		}
		if (currentItem.type == 3016)
		{
			aggro += 400;
		}
		if (currentItem.type == 2373)
		{
			accFishingLine = true;
		}
		if (currentItem.type == 2374)
		{
			fishingSkill += 10;
		}
		if (currentItem.type == 5139 || currentItem.type == 5144 || currentItem.type == 5142 || currentItem.type == 5141 || currentItem.type == 5146 || currentItem.type == 5140 || currentItem.type == 5145 || currentItem.type == 5143)
		{
			accFishingBobber = true;
		}
		if (currentItem.type == 2375)
		{
			accTackleBox = true;
		}
		if (currentItem.type == 4881)
		{
			accLavaFishing = true;
		}
		if (currentItem.type == 3721)
		{
			accFishingLine = true;
			accTackleBox = true;
			fishingSkill += 10;
		}
		if (currentItem.type == 5064)
		{
			accFishingLine = true;
			accTackleBox = true;
			fishingSkill += 10;
			accLavaFishing = true;
		}
		if (currentItem.type == 3090)
		{
			npcTypeNoAggro[1] = true;
			npcTypeNoAggro[16] = true;
			npcTypeNoAggro[59] = true;
			npcTypeNoAggro[71] = true;
			npcTypeNoAggro[81] = true;
			npcTypeNoAggro[138] = true;
			npcTypeNoAggro[121] = true;
			npcTypeNoAggro[122] = true;
			npcTypeNoAggro[141] = true;
			npcTypeNoAggro[147] = true;
			npcTypeNoAggro[183] = true;
			npcTypeNoAggro[184] = true;
			npcTypeNoAggro[204] = true;
			npcTypeNoAggro[225] = true;
			npcTypeNoAggro[244] = true;
			npcTypeNoAggro[302] = true;
			npcTypeNoAggro[333] = true;
			npcTypeNoAggro[335] = true;
			npcTypeNoAggro[334] = true;
			npcTypeNoAggro[336] = true;
			npcTypeNoAggro[537] = true;
			npcTypeNoAggro[676] = true;
			npcTypeNoAggro[667] = true;
		}
		if (currentItem.stringColor > 0)
		{
			yoyoString = true;
		}
		if (currentItem.type == 3366)
		{
			if (counterWeight == 0)
			{
				if (Main.rand.Next(7) == 0)
				{
					counterWeight = 1079;
				}
				else
				{
					counterWeight = 556 + Main.rand.Next(6);
				}
			}
			yoyoGlove = true;
			yoyoString = true;
		}
		if (currentItem.type == 5543 && CanUseStressBall())
		{
			stressBall = true;
		}
		if (currentItem.type == 5540)
		{
			magicString = true;
		}
		if (currentItem.type == 5541)
		{
			if (counterWeight == 0)
			{
				if (Main.rand.Next(7) == 0)
				{
					counterWeight = 1079;
				}
				else
				{
					counterWeight = 556 + Main.rand.Next(6);
				}
			}
			yoyoGlove = true;
			yoyoString = true;
			magicString = true;
		}
		if (currentItem.type == 5547)
		{
			counterWeight = 1079;
		}
		if (currentItem.type >= 3309 && currentItem.type <= 3314)
		{
			counterWeight = 556 + currentItem.type - 3309;
		}
		if (currentItem.type == 3334)
		{
			yoyoGlove = true;
		}
		if (currentItem.type == 3337)
		{
			shinyStone = true;
		}
		if (currentItem.type == 4989)
		{
			empressBrooch = true;
			moveSpeed += 0.075f;
		}
		if (currentItem.type == 3336)
		{
			SporeSac(currentItem);
			sporeSac = true;
		}
		if (currentItem.type == 4987)
		{
			VolatileGelatin(currentItem);
			volatileGelatin = true;
		}
		ApplyShader(currentItem.type);
		if (currentItem.type == 2423)
		{
			autoJump = true;
			jumpSpeedBoost += 1.6f;
			extraFall += 10;
		}
		if (currentItem.type == 857)
		{
			hasJumpOption_Sandstorm = true;
		}
		if (currentItem.type == 983)
		{
			hasJumpOption_Sandstorm = true;
			jumpBoost = true;
		}
		if (currentItem.type == 987)
		{
			hasJumpOption_Blizzard = true;
		}
		if (currentItem.type == 1163)
		{
			hasJumpOption_Blizzard = true;
			jumpBoost = true;
		}
		if (currentItem.type == 1724)
		{
			hasJumpOption_Fart = true;
		}
		if (currentItem.type == 1863)
		{
			hasJumpOption_Fart = true;
			jumpBoost = true;
		}
		if (currentItem.type == 1164)
		{
			hasJumpOption_Cloud = true;
			hasJumpOption_Sandstorm = true;
			hasJumpOption_Blizzard = true;
			jumpBoost = true;
		}
		if (currentItem.type == 5331)
		{
			hasJumpOption_Cloud = true;
			hasJumpOption_Sandstorm = true;
			hasJumpOption_Blizzard = true;
			jumpBoost = true;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 1250)
		{
			jumpBoost = true;
			hasJumpOption_Cloud = true;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 1252)
		{
			hasJumpOption_Sandstorm = true;
			jumpBoost = true;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 1251)
		{
			hasJumpOption_Blizzard = true;
			jumpBoost = true;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 3250)
		{
			hasJumpOption_Fart = true;
			jumpBoost = true;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 3252)
		{
			hasJumpOption_Sail = true;
			jumpBoost = true;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 3251)
		{
			jumpBoost = true;
			honeyCombItem = currentItem;
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 1249)
		{
			jumpBoost = true;
			honeyCombItem = currentItem;
		}
		if (currentItem.type == 3241)
		{
			jumpBoost = true;
			hasJumpOption_Sail = true;
		}
		if ((currentItem.type == 1253 || currentItem.type == 3997) && (double)statLife <= (double)statLifeMax2 * 0.5)
		{
			AddBuff(62, 5);
		}
		if (currentItem.type == 1290)
		{
			panic = true;
		}
		if ((currentItem.type == 1300 || currentItem.type == 1858 || currentItem.type == 4005) && (inventory[selectedItem].useAmmo == AmmoID.Bullet || inventory[selectedItem].useAmmo == AmmoID.CandyCorn || inventory[selectedItem].useAmmo == AmmoID.Stake || inventory[selectedItem].useAmmo == 23 || inventory[selectedItem].useAmmo == AmmoID.Solution))
		{
			scope = true;
		}
		if (currentItem.type == 1858)
		{
			rangedCrit += 10;
			rangedDamage += 0.1f;
		}
		if (currentItem.type == 1301)
		{
			meleeCrit += 8;
			rangedCrit += 8;
			magicCrit += 8;
			meleeDamage += 0.1f;
			rangedDamage += 0.1f;
			magicDamage += 0.1f;
			minionDamage += 0.1f;
		}
		if (currentItem.type == 111)
		{
			statManaMax2 += 20;
		}
		if (currentItem.type == 982)
		{
			statManaMax2 += 20;
			manaRegenDelayBonus += 1f;
			manaRegenBonus += 25;
		}
		if (currentItem.type == 1595)
		{
			statManaMax2 += 20;
			magicCuffs = true;
		}
		if (currentItem.type == 2219)
		{
			manaMagnet = true;
		}
		if (currentItem.type == 2220)
		{
			manaMagnet = true;
			magicDamage += 0.15f;
		}
		if (currentItem.type == 2221)
		{
			manaMagnet = true;
			statManaMax2 += 20;
			magicCuffs = true;
		}
		if (whoAmI == Main.myPlayer && currentItem.type == 1923)
		{
			tileRangeX++;
			tileRangeY++;
		}
		if (currentItem.type == 1247)
		{
			starCloakItem = currentItem;
			honeyCombItem = currentItem;
			starCloakItem_beeCloakOverrideItem = currentItem;
		}
		if (currentItem.type == 1248)
		{
			meleeCrit += 10;
			rangedCrit += 10;
			magicCrit += 10;
		}
		if (currentItem.type == 854)
		{
			discountEquipped = true;
		}
		if (currentItem.type == 855)
		{
			hasLuckyCoin = true;
			hasLuck_LuckyCoin = true;
		}
		if (currentItem.type == 3033)
		{
			goldRing = true;
		}
		if (currentItem.type == 3034)
		{
			goldRing = true;
			hasLuckyCoin = true;
			hasLuck_LuckyCoin = true;
		}
		if (currentItem.type == 3035)
		{
			goldRing = true;
			hasLuckyCoin = true;
			hasLuck_LuckyCoin = true;
			discountEquipped = true;
		}
		if (currentItem.type == 53)
		{
			hasJumpOption_Cloud = true;
		}
		if (currentItem.type == 3201)
		{
			hasJumpOption_Sail = true;
		}
		if (currentItem.type == 54)
		{
			accRunSpeed = 6f;
		}
		if (currentItem.type == 3068)
		{
			cordage = true;
		}
		if (currentItem.type == 1579)
		{
			accRunSpeed = 6f;
		}
		if (currentItem.type == 3200)
		{
			accRunSpeed = 6f;
		}
		if (currentItem.type == 128)
		{
			rocketBoots = (vanityRocketBoots = 1);
		}
		if (currentItem.type == 156)
		{
			noKnockback = true;
		}
		if (currentItem.type == 158)
		{
			noFallDmg = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 934)
		{
			carpet = true;
		}
		if (currentItem.type == 953)
		{
			spikedBoots++;
		}
		if (currentItem.type == 975)
		{
			spikedBoots++;
		}
		if (currentItem.type == 976)
		{
			spikedBoots += 2;
		}
		if (currentItem.type == 977)
		{
			dashType = 1;
		}
		if (currentItem.type == 3097)
		{
			dashType = 2;
		}
		if (currentItem.type == 963)
		{
			blackBelt = true;
		}
		if (currentItem.type == 984)
		{
			blackBelt = true;
			dashType = 1;
			spikedBoots = 2;
		}
		if (currentItem.type == 1131)
		{
			gravControl2 = true;
		}
		if (currentItem.type == 1132)
		{
			honeyCombItem = currentItem;
		}
		if (currentItem.type == 1578)
		{
			honeyCombItem = currentItem;
			panic = true;
		}
		if (currentItem.type == 3224)
		{
			endurance += 0.17f;
		}
		if (currentItem.type == 3223)
		{
			brainOfConfusionItem = currentItem;
		}
		if (currentItem.type == 950)
		{
			iceSkate = true;
		}
		if (currentItem.type == 159)
		{
			jumpBoost = true;
		}
		if (currentItem.type == 3225)
		{
			jumpBoost = true;
		}
		if (currentItem.type == 187)
		{
			accFlipper = true;
		}
		if (currentItem.type == 211)
		{
			autoReuseGlove = true;
			meleeSpeed += 0.12f;
		}
		if (currentItem.type == 223)
		{
			manaCost -= 0.06f;
		}
		if (currentItem.type == 285)
		{
			moveSpeed += 0.05f;
		}
		if (currentItem.type == 212)
		{
			moveSpeed += 0.1f;
		}
		if (currentItem.type == 267)
		{
			killGuide = true;
		}
		if (currentItem.type == 1307)
		{
			killClothier = true;
		}
		if (currentItem.type == 193)
		{
			fireWalk = true;
		}
		if (currentItem.type == 861)
		{
			accMerman = true;
			wolfAcc = true;
			if (hideVisibleAccessory[itemSlot])
			{
				hideMerman = true;
				hideWolf = true;
			}
		}
		if (currentItem.type == 862)
		{
			starCloakItem = currentItem;
			longInvince = true;
			starCloakItem_starVeilOverrideItem = currentItem;
		}
		if (currentItem.type == 860)
		{
			pStone = true;
		}
		if (currentItem.type == 863)
		{
			waterWalk2 = true;
		}
		if (currentItem.type == 907)
		{
			waterWalk2 = true;
			fireWalk = true;
		}
		if (currentItem.type == 5044)
		{
			hasCreditsSceneMusicBox = true;
		}
		if (currentItem.type == 908 || currentItem.type == 5000)
		{
			waterWalk = true;
			fireWalk = true;
			lavaMax += 420;
			lavaRose = true;
		}
		if ((!mount.Active || mount.Type != 47) && !hideVisibleAccessory[itemSlot] && (currentItem.type == 4822 || currentItem.type == 4874))
		{
			DoBootsEffect(DoBootsEffect_PlaceFlamesOnTile);
		}
		if (currentItem.type == 906 || currentItem.type == 4038 || currentItem.type == 3999 || currentItem.type == 4003)
		{
			lavaMax += 420;
		}
		if (currentItem.type == 485)
		{
			wolfAcc = true;
			if (hideVisibleAccessory[itemSlot])
			{
				hideWolf = true;
			}
		}
		if (currentItem.type == 486)
		{
			rulerLine = true;
		}
		if (currentItem.type == 2799)
		{
			rulerGrid = true;
		}
		if (currentItem.type == 394)
		{
			accFlipper = true;
			accDivingHelm = true;
		}
		if (currentItem.type == 396)
		{
			noFallDmg = true;
			fireWalk = true;
			hasLuck_LuckyHorseshoe = true;
		}
		if (currentItem.type == 397)
		{
			noKnockback = true;
			fireWalk = true;
		}
		if (currentItem.type == 399)
		{
			jumpBoost = true;
			hasJumpOption_Cloud = true;
		}
		if (currentItem.type == 405)
		{
			accRunSpeed = 6f;
			rocketBoots = (vanityRocketBoots = 2);
		}
		if (currentItem.type == 1303)
		{
			if (!wet)
			{
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 0.225f, 0.05f, 0.15f);
			}
			if (wet)
			{
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 1.8f, 0.4f, 1.2f);
			}
		}
		if (currentItem.type == 1860)
		{
			accFlipper = true;
			accDivingHelm = true;
			if (!wet)
			{
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 0.225f, 0.05f, 0.15f);
			}
			if (wet)
			{
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 1.8f, 0.4f, 1.2f);
			}
		}
		if (currentItem.type == 1861)
		{
			arcticDivingGear = true;
			accFlipper = true;
			accDivingHelm = true;
			iceSkate = true;
			if (!wet)
			{
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 0.05f, 0.15f, 0.225f);
			}
			if (wet)
			{
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, 0.4f, 1.2f, 1.8f);
			}
		}
		if (currentItem.type == 2214)
		{
			equippedAnyTileSpeedAcc = true;
		}
		if (currentItem.type == 2215)
		{
			equippedAnyTileRangeAcc = true;
		}
		if (currentItem.type == 2216)
		{
			autoPaint = true;
		}
		if (currentItem.type == 2217)
		{
			equippedAnyWallSpeedAcc = true;
		}
		if (currentItem.type == 3061)
		{
			equippedAnyWallSpeedAcc = true;
			equippedAnyTileSpeedAcc = true;
			autoPaint = true;
			equippedAnyTileRangeAcc = true;
		}
		if (currentItem.type == 5126)
		{
			equippedAnyWallSpeedAcc = true;
			equippedAnyTileSpeedAcc = true;
			autoPaint = true;
			equippedAnyTileRangeAcc = true;
			treasureMagnet = true;
			chiselSpeed = true;
		}
		if (currentItem.type == 3624)
		{
			autoActuator = true;
		}
		if (currentItem.type == 897)
		{
			kbGlove = true;
			autoReuseGlove = true;
			meleeScaleGlove = true;
			meleeSpeed += 0.12f;
		}
		if (currentItem.type == 1343)
		{
			kbGlove = true;
			autoReuseGlove = true;
			meleeScaleGlove = true;
			meleeSpeed += 0.12f;
			meleeDamage += 0.12f;
			magmaStone = true;
		}
		if (currentItem.type == 1167)
		{
			minionKB += 2f;
			minionDamage += 0.15f;
		}
		if (currentItem.type == 1864)
		{
			minionKB += 2f;
			minionDamage += 0.15f;
			maxMinions++;
		}
		if (currentItem.type == 1845)
		{
			minionDamage += 0.1f;
			maxMinions++;
		}
		if (currentItem.type == 1321)
		{
			magicQuiver = true;
			arrowDamageAdditiveStack += 0.1f;
		}
		if (currentItem.type == 1322)
		{
			magmaStone = true;
		}
		if (currentItem.type == 1323)
		{
			lavaRose = true;
		}
		if (currentItem.type == 3333)
		{
			strongBees = true;
		}
		if (currentItem.type == 938 || currentItem.type == 3997 || currentItem.type == 3998)
		{
			noKnockback = true;
			if ((float)statLife > (float)statLifeMax2 * 0.25f)
			{
				hasPaladinShield = true;
				if (whoAmI != Main.myPlayer && miscCounter % 10 == 0)
				{
					int myPlayer = Main.myPlayer;
					if (Main.player[myPlayer].team == team && team != 0)
					{
						float num = position.X - Main.player[myPlayer].position.X;
						float num2 = position.Y - Main.player[myPlayer].position.Y;
						if ((float)Math.Sqrt(num * num + num2 * num2) < PaladinsShieldRange)
						{
							Main.player[myPlayer].AddBuff(43, 20);
						}
					}
				}
			}
		}
		if (currentItem.type == 936)
		{
			kbGlove = true;
			autoReuseGlove = true;
			meleeScaleGlove = true;
			meleeSpeed += 0.12f;
			meleeDamage += 0.12f;
		}
		if (currentItem.type == 898)
		{
			accRunSpeed = 6.75f;
			rocketBoots = (vanityRocketBoots = 2);
			moveSpeed += 0.08f;
		}
		if (currentItem.type == 1862)
		{
			accRunSpeed = 6.75f;
			rocketBoots = (vanityRocketBoots = 3);
			moveSpeed += 0.08f;
			iceSkate = true;
		}
		if (currentItem.type == 5000)
		{
			accRunSpeed = 6.75f;
			rocketBoots = (vanityRocketBoots = 4);
			moveSpeed += 0.08f;
			iceSkate = true;
		}
		if (currentItem.type == 4874)
		{
			accRunSpeed = 6f;
			rocketBoots = (vanityRocketBoots = 5);
		}
		if (currentItem.type == 3110)
		{
			accMerman = true;
			wolfAcc = true;
			if (hideVisibleAccessory[itemSlot])
			{
				hideMerman = true;
				hideWolf = true;
			}
		}
		if (currentItem.type == 1865 || currentItem.type == 3110)
		{
			skyStoneEffects = true;
		}
		if (currentItem.type == 899 && Main.dayTime)
		{
			skyStoneEffects = true;
		}
		if (currentItem.type == 900 && (!Main.dayTime || Main.eclipse))
		{
			skyStoneEffects = true;
		}
		if (currentItem.type == 407)
		{
			blockRange++;
		}
		if (currentItem.type == 489)
		{
			magicDamage += 0.15f;
		}
		if (currentItem.type == 490)
		{
			meleeDamage += 0.15f;
		}
		if (currentItem.type == 491)
		{
			rangedDamage += 0.15f;
		}
		if (currentItem.type == 2998)
		{
			minionDamage += 0.15f;
		}
		if (currentItem.type == 935)
		{
			magicDamage += 0.12f;
			meleeDamage += 0.12f;
			rangedDamage += 0.12f;
			minionDamage += 0.12f;
		}
		if (currentItem.wingSlot != -1)
		{
			wingTimeMax = GetWingStats(currentItem.wingSlot).FlyTime;
		}
		if (currentItem.wingSlot == 26)
		{
			ignoreWater = true;
		}
		if (currentItem.type == 5452)
		{
			remoteVisionForDrone = true;
		}
		if (currentItem.type == 885)
		{
			buffImmune[30] = true;
		}
		if (currentItem.type == 886)
		{
			buffImmune[36] = true;
		}
		if (currentItem.type == 887)
		{
			buffImmune[20] = true;
		}
		if (currentItem.type == 888)
		{
			buffImmune[22] = true;
		}
		if (currentItem.type == 889)
		{
			buffImmune[32] = true;
		}
		if (currentItem.type == 890)
		{
			buffImmune[35] = true;
		}
		if (currentItem.type == 891)
		{
			buffImmune[23] = true;
		}
		if (currentItem.type == 892)
		{
			buffImmune[33] = true;
		}
		if (currentItem.type == 893)
		{
			buffImmune[31] = true;
		}
		if (currentItem.type == 3781)
		{
			buffImmune[156] = true;
		}
		if (currentItem.type == 901)
		{
			buffImmune[33] = true;
			buffImmune[36] = true;
		}
		if (currentItem.type == 902)
		{
			buffImmune[30] = true;
			buffImmune[20] = true;
		}
		if (currentItem.type == 903)
		{
			buffImmune[32] = true;
			buffImmune[31] = true;
		}
		if (currentItem.type == 904)
		{
			buffImmune[35] = true;
			buffImmune[23] = true;
		}
		if (currentItem.type == 5354)
		{
			buffImmune[22] = true;
			buffImmune[156] = true;
		}
		if (currentItem.type == 5355 && !controlDownHold)
		{
			shimmerImmune = true;
		}
		if (currentItem.type == 1921)
		{
			buffImmune[46] = true;
			buffImmune[47] = true;
		}
		if (currentItem.type == 1612)
		{
			buffImmune[33] = true;
			buffImmune[36] = true;
			buffImmune[30] = true;
			buffImmune[20] = true;
			buffImmune[32] = true;
			buffImmune[31] = true;
			buffImmune[35] = true;
			buffImmune[23] = true;
			buffImmune[22] = true;
			buffImmune[156] = true;
		}
		if (currentItem.type == 1613)
		{
			buffImmune[46] = true;
			noKnockback = true;
			fireWalk = true;
			buffImmune[33] = true;
			buffImmune[36] = true;
			buffImmune[30] = true;
			buffImmune[20] = true;
			buffImmune[32] = true;
			buffImmune[31] = true;
			buffImmune[35] = true;
			buffImmune[23] = true;
			buffImmune[22] = true;
			buffImmune[156] = true;
		}
		if (currentItem.type == 497)
		{
			accMerman = true;
			if (hideVisibleAccessory[itemSlot])
			{
				hideMerman = true;
			}
		}
		if (currentItem.type == 535)
		{
			pStone = true;
		}
		if (currentItem.type == 536)
		{
			kbGlove = true;
			meleeScaleGlove = true;
		}
		if (currentItem.type == 532)
		{
			starCloakItem = currentItem;
		}
		if (currentItem.type == 554)
		{
			longInvince = true;
		}
		if (currentItem.type == 555)
		{
			manaFlower = true;
			manaCost -= 0.08f;
		}
		if (Main.myPlayer == whoAmI)
		{
			if (currentItem.type == 5104 || currentItem.type == 5105)
			{
				ApplyWilsonBeard(currentItem);
			}
			else if (currentItem.type == 576 && Main.rand.Next(540) == 0 && Main.curMusic > 0 && Main.curMusic <= Main.maxMusic && MusicID.Sets.CanBeRecorded[Main.curMusic])
			{
				SoundEngine.PlaySound(SoundID.Item166, base.Center);
				int num3 = -1;
				if (Main.curMusic == 1)
				{
					num3 = 0;
				}
				if (Main.curMusic == 2)
				{
					num3 = 1;
				}
				if (Main.curMusic == 3)
				{
					num3 = 2;
				}
				if (Main.curMusic == 4)
				{
					num3 = 4;
				}
				if (Main.curMusic == 5)
				{
					num3 = 5;
				}
				if (Main.curMusic == 6)
				{
					num3 = 3;
				}
				if (Main.curMusic == 7)
				{
					num3 = 6;
				}
				if (Main.curMusic == 8)
				{
					num3 = 7;
				}
				if (Main.curMusic == 9)
				{
					num3 = 9;
				}
				if (Main.curMusic == 10)
				{
					num3 = 8;
				}
				if (Main.curMusic == 11)
				{
					num3 = 11;
				}
				if (Main.curMusic == 12)
				{
					num3 = 10;
				}
				if (Main.curMusic == 13)
				{
					num3 = 12;
				}
				if (num3 > -1)
				{
					currentItem.SetDefaults(num3 + 562);
				}
				else if (Main.curMusic > 13 && Main.curMusic <= 27)
				{
					currentItem.SetDefaults(1596 + Main.curMusic - 14);
				}
				if (Main.curMusic == 28)
				{
					currentItem.SetDefaults(1963);
				}
				else if (Main.curMusic == 29)
				{
					currentItem.SetDefaults(1610);
				}
				else if (Main.curMusic == 30)
				{
					currentItem.SetDefaults(1963);
				}
				else if (Main.curMusic == 31)
				{
					currentItem.SetDefaults(1964);
				}
				else if (Main.curMusic == 32)
				{
					currentItem.SetDefaults(1965);
				}
				else if (Main.curMusic == 33)
				{
					currentItem.SetDefaults(2742);
				}
				else if (Main.curMusic == 34)
				{
					currentItem.SetDefaults(3370);
				}
				else if (Main.curMusic == 35)
				{
					currentItem.SetDefaults(3236);
				}
				else if (Main.curMusic == 36)
				{
					currentItem.SetDefaults(3237);
				}
				else if (Main.curMusic == 37)
				{
					currentItem.SetDefaults(3235);
				}
				else if (Main.curMusic == 38)
				{
					currentItem.SetDefaults(3044);
				}
				else if (Main.curMusic == 39)
				{
					currentItem.SetDefaults(3371);
				}
				else if (Main.curMusic == 40)
				{
					currentItem.SetDefaults(3796);
				}
				else if (Main.curMusic == 41)
				{
					currentItem.SetDefaults(3869);
				}
				else if (Main.curMusic == 42)
				{
					currentItem.SetDefaults(4079);
				}
				else if (Main.curMusic == 43)
				{
					currentItem.SetDefaults(4077);
				}
				else if (Main.curMusic == 44)
				{
					currentItem.SetDefaults(4082);
				}
				else if (Main.curMusic == 46)
				{
					currentItem.SetDefaults(4080);
				}
				else if (Main.curMusic == 47)
				{
					currentItem.SetDefaults(4081);
				}
				else if (Main.curMusic == 48)
				{
					currentItem.SetDefaults(4078);
				}
				else if (Main.curMusic == 49)
				{
					currentItem.SetDefaults(4237);
				}
				else if (Main.curMusic == 51)
				{
					currentItem.SetDefaults(4356);
				}
				else if (Main.curMusic == 52)
				{
					currentItem.SetDefaults(4357);
				}
				else if (Main.curMusic == 53)
				{
					currentItem.SetDefaults(4358);
				}
				else if (Main.curMusic == 54)
				{
					currentItem.SetDefaults(4421);
				}
				else if (Main.curMusic == 55)
				{
					currentItem.SetDefaults(4606);
				}
				else if (Main.curMusic == 56)
				{
					currentItem.SetDefaults(4979);
				}
				else if (Main.curMusic == 57)
				{
					currentItem.SetDefaults(4985);
				}
				else if (Main.curMusic == 58)
				{
					currentItem.SetDefaults(4990);
				}
				else if (Main.curMusic == 59)
				{
					currentItem.SetDefaults(4991);
				}
				else if (Main.curMusic == 60)
				{
					currentItem.SetDefaults(4992);
				}
				else if (Main.curMusic == 61)
				{
					currentItem.SetDefaults(5006);
				}
				else if (Main.curMusic == 62)
				{
					currentItem.SetDefaults(5014);
				}
				else if (Main.curMusic == 63)
				{
					currentItem.SetDefaults(5015);
				}
				else if (Main.curMusic == 64)
				{
					currentItem.SetDefaults(5016);
				}
				else if (Main.curMusic == 65)
				{
					currentItem.SetDefaults(5017);
				}
				else if (Main.curMusic == 66)
				{
					currentItem.SetDefaults(5018);
				}
				else if (Main.curMusic == 67)
				{
					currentItem.SetDefaults(5019);
				}
				else if (Main.curMusic == 68)
				{
					currentItem.SetDefaults(5020);
				}
				else if (Main.curMusic == 69)
				{
					currentItem.SetDefaults(5021);
				}
				else if (Main.curMusic == 70)
				{
					currentItem.SetDefaults(5022);
				}
				else if (Main.curMusic == 71)
				{
					currentItem.SetDefaults(5023);
				}
				else if (Main.curMusic == 72)
				{
					currentItem.SetDefaults(5024);
				}
				else if (Main.curMusic == 73)
				{
					currentItem.SetDefaults(5025);
				}
				else if (Main.curMusic == 74)
				{
					currentItem.SetDefaults(5026);
				}
				else if (Main.curMusic == 75)
				{
					currentItem.SetDefaults(5027);
				}
				else if (Main.curMusic == 76)
				{
					currentItem.SetDefaults(5028);
				}
				else if (Main.curMusic == 77)
				{
					currentItem.SetDefaults(5029);
				}
				else if (Main.curMusic == 78)
				{
					currentItem.SetDefaults(5030);
				}
				else if (Main.curMusic == 79)
				{
					currentItem.SetDefaults(5031);
				}
				else if (Main.curMusic == 80)
				{
					currentItem.SetDefaults(5032);
				}
				else if (Main.curMusic == 81)
				{
					currentItem.SetDefaults(5033);
				}
				else if (Main.curMusic == 82)
				{
					currentItem.SetDefaults(5034);
				}
				else if (Main.curMusic == 83)
				{
					currentItem.SetDefaults(5035);
				}
				else if (Main.curMusic == 84)
				{
					currentItem.SetDefaults(5036);
				}
				else if (Main.curMusic == 85)
				{
					currentItem.SetDefaults(5037);
				}
				else if (Main.curMusic == 86)
				{
					currentItem.SetDefaults(5038);
				}
				else if (Main.curMusic == 87)
				{
					currentItem.SetDefaults(5039);
				}
				else if (Main.curMusic == 88)
				{
					currentItem.SetDefaults(5040);
				}
				else if (Main.curMusic == 89)
				{
					currentItem.SetDefaults(5044);
				}
				else if (Main.curMusic == 90)
				{
					currentItem.SetDefaults(5112);
				}
				else if (Main.curMusic == 91)
				{
					currentItem.SetDefaults(5362);
				}
				else if (Main.curMusic == 92)
				{
					currentItem.SetDefaults(5582);
				}
				else if (Main.curMusic == 93)
				{
					currentItem.SetDefaults(5578);
				}
				else if (Main.curMusic == 94)
				{
					currentItem.SetDefaults(5580);
				}
				else if (Main.curMusic == 95)
				{
					currentItem.SetDefaults(5579);
				}
				else if (Main.curMusic == 96)
				{
					currentItem.SetDefaults(5538);
				}
				else if (Main.curMusic == 97)
				{
					currentItem.SetDefaults(5539);
				}
				else if (Main.curMusic == 98)
				{
					currentItem.SetDefaults(5581);
				}
				else if (Main.curMusic == 99)
				{
					currentItem.SetDefaults(5637);
				}
				else if (Main.curMusic == 100)
				{
					currentItem.SetDefaults(5639);
				}
				else if (Main.curMusic == 101)
				{
					currentItem.SetDefaults(5638);
				}
				else if (Main.curMusic == 104)
				{
					currentItem.SetDefaults(6144);
				}
			}
			ApplyMusicBox(currentItem);
		}
		if (mount.Active && mount.Type == 49)
		{
			waterWalk2 = false;
			waterWalk = false;
		}
	}

	private void ApplyWilsonBeard(Item currentItem)
	{
		beardGrowthTimer++;
		if (beardGrowthTimer >= 43200 && Main.rand.Next(540) == 0)
		{
			beardGrowthTimer = 0;
			short type = 5105;
			if (currentItem.type == 5105)
			{
				type = 5106;
			}
			SoundEngine.PlaySound(SoundID.Item60, base.Center);
			currentItem.SetDefaults(type);
		}
	}

	private void ApplyMusicBox(Item currentItem)
	{
		if (currentItem.type >= 562 && currentItem.type <= 574)
		{
			musicBox = currentItem.type - 562;
		}
		if (currentItem.type >= 1596 && currentItem.type <= 1609)
		{
			musicBox = currentItem.type - 1596 + 13;
		}
		if (currentItem.type == 1610)
		{
			musicBox = 27;
		}
		if (currentItem.type == 1963)
		{
			musicBox = 28;
		}
		if (currentItem.type == 1964)
		{
			musicBox = 29;
		}
		if (currentItem.type == 1965)
		{
			musicBox = 30;
		}
		if (currentItem.type == 2742)
		{
			musicBox = 31;
		}
		if (currentItem.type == 3044)
		{
			musicBox = 32;
		}
		if (currentItem.type == 3235)
		{
			musicBox = 33;
		}
		if (currentItem.type == 3236)
		{
			musicBox = 34;
		}
		if (currentItem.type == 3237)
		{
			musicBox = 35;
		}
		if (currentItem.type == 3370)
		{
			musicBox = 36;
		}
		if (currentItem.type == 3371)
		{
			musicBox = 37;
		}
		if (currentItem.type == 3796)
		{
			musicBox = 38;
		}
		if (currentItem.type == 3869)
		{
			musicBox = 39;
		}
		if (currentItem.type == 4082)
		{
			musicBox = 40;
		}
		if (currentItem.type == 4078)
		{
			musicBox = 41;
		}
		if (currentItem.type == 4079)
		{
			musicBox = 42;
		}
		if (currentItem.type == 4077)
		{
			musicBox = 43;
		}
		if (currentItem.type == 4080)
		{
			musicBox = 44;
		}
		if (currentItem.type == 4081)
		{
			musicBox = 45;
		}
		if (currentItem.type == 4237)
		{
			musicBox = 46;
		}
		if (currentItem.type == 4356)
		{
			musicBox = 47;
		}
		if (currentItem.type == 4357)
		{
			musicBox = 48;
		}
		if (currentItem.type == 4358)
		{
			musicBox = 49;
		}
		if (currentItem.type == 4421)
		{
			musicBox = 50;
		}
		if (currentItem.type == 4606)
		{
			musicBox = 51;
		}
		if (currentItem.type == 4979)
		{
			musicBox = 52;
		}
		if (currentItem.type == 4985)
		{
			musicBox = 53;
		}
		if (currentItem.type == 4990)
		{
			musicBox = 54;
		}
		if (currentItem.type == 4991)
		{
			musicBox = 55;
		}
		if (currentItem.type == 4992)
		{
			musicBox = 56;
		}
		if (currentItem.type == 5006)
		{
			musicBox = 57;
		}
		if (currentItem.type == 5014)
		{
			musicBox = 58;
		}
		if (currentItem.type == 5015)
		{
			musicBox = 59;
		}
		if (currentItem.type == 5016)
		{
			musicBox = 60;
		}
		if (currentItem.type == 5017)
		{
			musicBox = 61;
		}
		if (currentItem.type == 5018)
		{
			musicBox = 62;
		}
		if (currentItem.type == 5019)
		{
			musicBox = 63;
		}
		if (currentItem.type == 5020)
		{
			musicBox = 64;
		}
		if (currentItem.type == 5021)
		{
			musicBox = 65;
		}
		if (currentItem.type == 5022)
		{
			musicBox = 66;
		}
		if (currentItem.type == 5023)
		{
			musicBox = 67;
		}
		if (currentItem.type == 5024)
		{
			musicBox = 68;
		}
		if (currentItem.type == 5025)
		{
			musicBox = 69;
		}
		if (currentItem.type == 5026)
		{
			musicBox = 70;
		}
		if (currentItem.type == 5027)
		{
			musicBox = 71;
		}
		if (currentItem.type == 5028)
		{
			musicBox = 72;
		}
		if (currentItem.type == 5029)
		{
			musicBox = 73;
		}
		if (currentItem.type == 5030)
		{
			musicBox = 74;
		}
		if (currentItem.type == 5031)
		{
			musicBox = 75;
		}
		if (currentItem.type == 5032)
		{
			musicBox = 76;
		}
		if (currentItem.type == 5033)
		{
			musicBox = 77;
		}
		if (currentItem.type == 5034)
		{
			musicBox = 78;
		}
		if (currentItem.type == 5035)
		{
			musicBox = 79;
		}
		if (currentItem.type == 5036)
		{
			musicBox = 80;
		}
		if (currentItem.type == 5037)
		{
			musicBox = 81;
		}
		if (currentItem.type == 5038)
		{
			musicBox = 82;
		}
		if (currentItem.type == 5039)
		{
			musicBox = 83;
		}
		if (currentItem.type == 5040)
		{
			musicBox = 84;
		}
		if (currentItem.type == 5044)
		{
			musicBox = 85;
		}
		if (currentItem.type == 5112)
		{
			musicBox = 86;
		}
		if (currentItem.type == 5362)
		{
			musicBox = 87;
		}
		if (currentItem.type == 5578)
		{
			musicBox = 88;
		}
		if (currentItem.type == 5538)
		{
			musicBox = 89;
		}
		if (currentItem.type == 5579)
		{
			musicBox = 90;
		}
		if (currentItem.type == 5580)
		{
			musicBox = 91;
		}
		if (currentItem.type == 5539)
		{
			musicBox = 92;
		}
		if (currentItem.type == 5581)
		{
			musicBox = 93;
		}
		if (currentItem.type == 5582)
		{
			musicBox = 94;
		}
		if (currentItem.type == 5637)
		{
			musicBox = 95;
		}
		if (currentItem.type == 5638)
		{
			musicBox = 96;
		}
		if (currentItem.type == 5639)
		{
			musicBox = 97;
		}
		if (currentItem.type == 6144)
		{
			musicBox = 98;
		}
	}

	public void UpdateArmorSets(int i)
	{
		ArmorSetBonuses.GetCompleteSet(new ArmorSetBonus.QueryContext(this))?.Effect(this);
		UpdateArmorSets_Always_Beetle();
		UpdateArmorSets_Always_Solar();
		UpdateArmorSets_Always_Stardust();
		UpdateArmorSets_Always_Chlorophyte();
		UpdateArmorSets_Always_Vortex();
		ApplyArmorSoundAndDustChanges();
	}

	public void UpdateArmorSetsOld(int i)
	{
		setBonus = "";
		if (body == 67 && legs == 56 && head >= 103 && head <= 105)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Shroomite");
			shroomiteStealth = true;
		}
		if ((head == 52 && body == 32 && legs == 31) || (head == 53 && body == 33 && legs == 32) || (head == 54 && body == 34 && legs == 33) || (head == 55 && body == 35 && legs == 34) || (head == 71 && body == 47 && legs == 43) || (head == 166 && body == 173 && legs == 108) || (head == 167 && body == 174 && legs == 109))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Wood");
			statDefense++;
		}
		if (head == 278 && body == 246 && legs == 234)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.AshWood");
			ashWoodBonus = true;
		}
		if ((head == 1 && body == 1 && legs == 1) || ((head == 72 || head == 2) && body == 2 && legs == 2) || (head == 47 && body == 28 && legs == 27))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.MetalTier1");
			statDefense += 2;
		}
		if ((head == 3 && body == 3 && legs == 3) || ((head == 73 || head == 4) && body == 4 && legs == 4) || (head == 48 && body == 29 && legs == 28) || (head == 49 && body == 30 && legs == 29))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.MetalTier2");
			statDefense += 3;
		}
		if (head == 50 && body == 31 && legs == 30)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Platinum");
			statDefense += 4;
		}
		if (head == 112 && body == 75 && legs == 64)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Pumpkin");
			meleeDamage += 0.1f;
			magicDamage += 0.1f;
			rangedDamage += 0.1f;
			minionDamage += 0.1f;
		}
		if (head == 180 && body == 182 && legs == 122)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Gladiator");
			noKnockback = true;
		}
		if (head == 22 && body == 14 && legs == 14)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Ninja");
			moveSpeed += 0.2f;
		}
		if (head == 188 && body == 189 && legs == 129)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Fossil");
			ammoCost80 = true;
		}
		if ((head == 75 || head == 7) && body == 7 && legs == 7)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Bone");
			rangedCrit += 10;
		}
		if (head == 157 && body == 105 && legs == 98)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.BeetleDamage");
			ApplySetBonus_BeetleDamage();
		}
		else if (head == 157 && body == 106 && legs == 98)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.BeetleDefense");
			ApplySetBonus_BeetleDefense();
		}
		UpdateArmorSets_Always_Beetle();
		if (head == 14 && ((body >= 58 && body <= 63) || body == 167 || body == 213))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Wizard");
			magicCrit += 10;
		}
		if (head == 159 && ((body >= 58 && body <= 63) || body == 167 || body == 213))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.MagicHat");
			statManaMax2 += 60;
		}
		if ((head == 5 || head == 74) && (body == 5 || body == 48) && (legs == 5 || legs == 44))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.ShadowScale");
			shadowArmor = true;
		}
		if (head == 57 && body == 37 && legs == 35)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Crimson");
			crimsonRegen = true;
		}
		if (head == 101 && body == 66 && legs == 55)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.SpectreHealing");
			ghostHeal = true;
			magicDamage -= 0.4f;
		}
		if (head == 156 && body == 66 && legs == 55)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.SpectreDamage");
			ghostHurt = true;
		}
		if (head == 6 && body == 6 && legs == 6)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Meteor");
			spaceGun = true;
		}
		if (head == 46 && body == 27 && legs == 26)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Frost");
			frostBurn = true;
			meleeDamage += 0.1f;
			rangedDamage += 0.1f;
		}
		if ((head == 76 || head == 8) && (body == 49 || body == 8) && (legs == 45 || legs == 8))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Jungle");
			manaCost -= 0.16f;
		}
		if (head == 9 && body == 9 && legs == 9)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Molten");
			meleeDamage += 0.1f;
			fireWalk = true;
			if (!vampireBurningInSunlight)
			{
				buffImmune[24] = true;
			}
		}
		if ((head == 58 || head == 77) && (body == 38 || body == 50) && (legs == 36 || legs == 46))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Snow");
			buffImmune[46] = true;
			buffImmune[47] = true;
		}
		if ((head == 11 || head == 285 || head == 216) && (body == 20 || body == 252) && (legs == 19 || legs == 240))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Mining");
			pickSpeed -= 0.1f;
		}
		if (head == 78 && body == 51 && legs == 47)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.ChlorophyteMelee");
			AddBuff(60, 5);
			endurance += 0.05f;
		}
		else if (head == 283 && body == 51 && legs == 47)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.ChlorophyteSummon");
			AddBuff(60, 5);
			maxMinions += 2;
		}
		else if ((head == 80 || head == 79) && body == 51 && legs == 47)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Chlorophyte");
			AddBuff(60, 5);
			setChlorophyte = true;
		}
		UpdateArmorSets_Always_Chlorophyte();
		if ((head == 161 || head == 286) && (body == 169 || body == 253) && (legs == 104 || legs == 241))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Angler");
			anglerSetSpawnReduction = true;
		}
		if (head == 70 && body == 46 && legs == 42)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Cactus");
			cactusThorns = true;
		}
		if (head == 99 && body == 65 && legs == 54)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Turtle");
			endurance += 0.15f;
			thorns = 1f;
			turtleThorns = true;
		}
		if (body == 17 && legs == 16)
		{
			if (head == 29)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.CobaltCaster");
				manaCost -= 0.14f;
			}
			else if (head == 30)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.CobaltMelee");
				meleeSpeed += 0.15f;
			}
			else if (head == 31)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.CobaltRanged");
				ammoCost80 = true;
			}
		}
		if (body == 18 && legs == 17)
		{
			if (head == 32)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.MythrilCaster");
				manaCost -= 0.17f;
			}
			else if (head == 33)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.MythrilMelee");
				meleeCrit += 10;
			}
			else if (head == 34)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.MythrilRanged");
				ammoCost80 = true;
			}
		}
		if (body == 19 && legs == 18)
		{
			if (head == 35)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.AdamantiteCaster");
				manaCost -= 0.19f;
			}
			else if (head == 36)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.AdamantiteMelee");
				meleeSpeed += 0.2f;
				moveSpeed += 0.2f;
			}
			else if (head == 37)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.AdamantiteRanged");
				ammoCost75 = true;
			}
		}
		if (body == 54 && legs == 49 && (head == 83 || head == 84 || head == 85))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Palladium");
			onHitRegen = true;
		}
		if (body == 55 && legs == 50 && (head == 86 || head == 87 || head == 88))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Orichalcum");
			onHitPetal = true;
		}
		if (body == 56 && legs == 51)
		{
			bool flag = false;
			if (head == 91)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.Titanium");
				flag = true;
			}
			else if (head == 89)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.Titanium");
				flag = true;
			}
			else if (head == 90)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.Titanium");
				flag = true;
			}
			if (flag)
			{
				onHitTitaniumStorm = true;
			}
		}
		if ((body == 24 || body == 229) && (legs == 23 || legs == 212) && (head == 42 || head == 41 || head == 43 || head == 254 || head == 257 || head == 256 || head == 255 || head == 258))
		{
			if (head == 254 || head == 258)
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.HallowedSummoner");
				maxMinions += 2;
			}
			else
			{
				setBonus = Language.GetTextValue("ArmorSetBonus.Hallowed");
			}
			onHitDodge = true;
		}
		if (head == 261 && body == 230 && legs == 213)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.CrystalNinja");
			rangedDamage += 0.1f;
			meleeDamage += 0.1f;
			magicDamage += 0.1f;
			minionDamage += 0.1f;
			rangedCrit += 10;
			meleeCrit += 10;
			magicCrit += 10;
			dashType = 5;
		}
		if (head == 82 && body == 53 && legs == 48)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Tiki");
			maxMinions++;
			whipRangeMultiplier += 0.2f;
		}
		if (head == 134 && body == 95 && legs == 79)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Spooky");
			minionDamage += 0.25f;
		}
		if (head == 160 && body == 168 && legs == 103)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Bee");
			minionDamage += 0.1f;
			if (itemAnimation > 0 && inventory[selectedItem].type == 1121)
			{
				AchievementsHelper.HandleSpecialEvent(this, 3);
			}
		}
		if (head == 162 && body == 170 && legs == 105)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Spider");
			minionDamage += 0.12f;
		}
		if (head == 171 && body == 177 && legs == 112)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Solar");
			ApplySetBonus_Solar();
		}
		UpdateArmorSets_Always_Solar();
		if (head == 169 && body == 175 && legs == 110)
		{
			setVortex = true;
			setBonus = Language.GetTextValue("ArmorSetBonus.Vortex", Language.GetTextValue(Main.ReversedUpDownArmorSetBonuses ? "Key.UP" : "Key.DOWN"));
		}
		UpdateArmorSets_Always_Vortex();
		if (head == 170 && body == 176 && legs == 111)
		{
			if (nebulaCD > 0)
			{
				nebulaCD--;
			}
			setNebula = true;
			setBonus = Language.GetTextValue("ArmorSetBonus.Nebula");
		}
		if (head == 189 && body == 190 && legs == 130)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Stardust", Language.GetTextValue(Main.ReversedUpDownArmorSetBonuses ? "Key.UP" : "Key.DOWN"));
			ApplySetBonus_Stardust();
		}
		UpdateArmorSets_Always_Stardust();
		if (head == 200 && body == 198 && legs == 142)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.Forbidden", Language.GetTextValue(Main.ReversedUpDownArmorSetBonuses ? "Key.UP" : "Key.DOWN"));
			setForbidden = true;
			UpdateForbiddenSetLock();
			Lighting.AddLight(base.Center, 0.8f, 0.7f, 0.2f);
		}
		if (head == 204 && body == 201 && legs == 145)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.SquireTier2");
			setSquireT2 = true;
			maxTurrets++;
		}
		if (head == 203 && body == 200 && legs == 144)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.ApprenticeTier2");
			setApprenticeT2 = true;
			maxTurrets++;
		}
		if (head == 205 && body == 202 && (legs == 147 || legs == 146))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.HuntressTier2");
			setHuntressT2 = true;
			maxTurrets++;
		}
		if (head == 206 && body == 203 && legs == 148)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.MonkTier2");
			setMonkT2 = true;
			maxTurrets++;
		}
		if (head == 210 && body == 204 && legs == 152)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.SquireTier3");
			setSquireT3 = true;
			setSquireT2 = true;
			maxTurrets++;
		}
		if (head == 211 && body == 205 && legs == 153)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.ApprenticeTier3");
			setApprenticeT3 = true;
			setApprenticeT2 = true;
			maxTurrets++;
		}
		if (head == 212 && body == 206 && (legs == 154 || legs == 155))
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.HuntressTier3");
			setHuntressT3 = true;
			setHuntressT2 = true;
			maxTurrets++;
		}
		if (head == 213 && body == 207 && legs == 156)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.MonkTier3");
			setMonkT3 = true;
			setMonkT2 = true;
			maxTurrets++;
		}
		if (head == 185 && body == 187 && legs == 127)
		{
			setBonus = Language.GetTextValue("ArmorSetBonus.ObsidianOutlaw");
			minionDamage += 0.15f;
			whipRangeMultiplier += 0.3f;
			float num = 1.15f;
			float num2 = 1f / num;
			whipUseTimeMultiplier *= num2;
		}
		ApplyArmorSoundAndDustChanges();
	}

	private void UpdateArmorSets_Always_Vortex()
	{
		if (!setVortex)
		{
			vortexStealthActive = false;
		}
	}

	private void UpdateArmorSets_Always_Chlorophyte()
	{
		if (!setChlorophyte)
		{
			ClearBuff(60);
		}
	}

	private void UpdateArmorSets_Always_Stardust()
	{
		if (!setStardust && FindBuffIndex(187) != -1)
		{
			DelBuff(FindBuffIndex(187));
		}
	}

	public void ApplySetBonus_Stardust()
	{
		setStardust = true;
		if (whoAmI == Main.myPlayer)
		{
			if (FindBuffIndex(187) == -1)
			{
				AddBuff(187, 3600);
			}
			if (ownedProjectileCounts[623] < 1)
			{
				int num = 10;
				int num2 = 30;
				int num3 = Projectile.NewProjectile(GetProjectileSource_SetBonus(7), base.Center.X, base.Center.Y, 0f, -1f, 623, num2, num, Main.myPlayer);
				Main.projectile[num3].originalDamage = num2;
			}
		}
	}

	private void UpdateArmorSets_Always_Solar()
	{
		if (!setSolar)
		{
			solarCounter = 0;
		}
	}

	public void ApplySetBonus_Solar()
	{
		endurance += 0.12f;
		setSolar = true;
		solarCounter++;
		int num = 180;
		if (solarCounter >= num)
		{
			if (solarShields > 0 && solarShields < 3)
			{
				for (int i = 0; i < maxBuffs; i++)
				{
					if (buffType[i] >= 170 && buffType[i] <= 171)
					{
						DelBuff(i);
					}
				}
			}
			if (solarShields < 3)
			{
				AddBuff(170 + solarShields, 5);
				for (int j = 0; j < 16; j++)
				{
					Dust obj = Main.dust[Dust.NewDust(position, width, height, 6, 0f, 0f, 100)];
					obj.noGravity = true;
					obj.scale = 1.7f;
					obj.fadeIn = 0.5f;
					obj.velocity *= 5f;
					obj.shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
				solarCounter = 0;
			}
			else
			{
				solarCounter = num;
			}
		}
		for (int k = solarShields; k < 3; k++)
		{
			solarShieldPos[k] = Vector2.Zero;
		}
		for (int l = 0; l < solarShields; l++)
		{
			solarShieldPos[l] += solarShieldVel[l];
			Vector2 vector = ((float)miscCounter / 100f * ((float)Math.PI * 2f) + (float)l * ((float)Math.PI * 2f / (float)solarShields)).ToRotationVector2() * 6f;
			vector.X = direction * 20;
			if (mount.Active)
			{
				if (mount.Type == 52)
				{
					vector.X = direction * 50;
				}
				if (mount.Type == 54)
				{
					vector.X = direction * 54;
				}
				if (mount.Type == 56 || mount.Type == 61)
				{
					vector.X = direction * 40;
				}
			}
			solarShieldVel[l] = (vector - solarShieldPos[l]) * 0.2f;
		}
		if (dashDelay >= 0)
		{
			solarDashing = false;
			solarDashConsumedFlare = false;
		}
		bool flag = solarDashing && dashDelay < 0;
		if (solarShields > 0 || flag)
		{
			dashType = 3;
		}
	}

	private void UpdateArmorSets_Always_Beetle()
	{
		if (!beetleDefense && !beetleOffense)
		{
			beetleCounter = 0f;
			return;
		}
		beetleFrameCounter++;
		if (beetleFrameCounter >= 1)
		{
			beetleFrameCounter = 0;
			beetleFrame++;
			if (beetleFrame > 2)
			{
				beetleFrame = 0;
			}
		}
		for (int i = beetleOrbs; i < 3; i++)
		{
			beetlePos[i].X = 0f;
			beetlePos[i].Y = 0f;
		}
		for (int j = 0; j < beetleOrbs; j++)
		{
			beetlePos[j] += beetleVel[j];
			beetleVel[j].X += (float)Main.rand.Next(-100, 101) * 0.005f;
			beetleVel[j].Y += (float)Main.rand.Next(-100, 101) * 0.005f;
			float x = beetlePos[j].X;
			float y = beetlePos[j].Y;
			float num = (float)Math.Sqrt(x * x + y * y);
			if (num > 100f)
			{
				num = 20f / num;
				x *= 0f - num;
				y *= 0f - num;
				int num2 = 10;
				beetleVel[j].X = (beetleVel[j].X * (float)(num2 - 1) + x) / (float)num2;
				beetleVel[j].Y = (beetleVel[j].Y * (float)(num2 - 1) + y) / (float)num2;
			}
			else if (num > 30f)
			{
				num = 10f / num;
				x *= 0f - num;
				y *= 0f - num;
				int num3 = 20;
				beetleVel[j].X = (beetleVel[j].X * (float)(num3 - 1) + x) / (float)num3;
				beetleVel[j].Y = (beetleVel[j].Y * (float)(num3 - 1) + y) / (float)num3;
			}
			x = beetleVel[j].X;
			y = beetleVel[j].Y;
			num = (float)Math.Sqrt(x * x + y * y);
			if (num > 2f)
			{
				beetleVel[j] *= 0.9f;
			}
			beetlePos[j] -= velocity * 0.25f;
		}
	}

	public void ApplySetBonus_BeetleDefense()
	{
		beetleDefense = true;
		beetleCounter += 1f;
		int num = 180;
		if (!(beetleCounter >= (float)num))
		{
			return;
		}
		if (beetleOrbs > 0 && beetleOrbs < 3)
		{
			for (int i = 0; i < maxBuffs; i++)
			{
				if (buffType[i] >= 95 && buffType[i] <= 96)
				{
					DelBuff(i);
				}
			}
		}
		if (beetleOrbs < 3)
		{
			AddBuff(95 + beetleOrbs, 5);
			beetleCounter = 0f;
		}
		else
		{
			beetleCounter = num;
		}
	}

	public void ApplySetBonus_BeetleDamage()
	{
		int num = 0;
		beetleOffense = true;
		beetleCounter -= 3f;
		beetleCounter -= beetleCountdown / 20;
		beetleCountdown++;
		if (beetleCounter < 0f)
		{
			beetleCounter = 0f;
		}
		int num2 = 400;
		int num3 = 1200;
		int num4 = 3600;
		if (beetleCounter > (float)(num2 + num3 + num4 + num3))
		{
			beetleCounter = num2 + num3 + num4 + num3;
		}
		if (beetleCounter > (float)(num2 + num3 + num4))
		{
			AddBuff(100, 5);
			num = 3;
		}
		else if (beetleCounter > (float)(num2 + num3))
		{
			AddBuff(99, 5);
			num = 2;
		}
		else if (beetleCounter > (float)num2)
		{
			AddBuff(98, 5);
			num = 1;
		}
		if (num < beetleOrbs)
		{
			beetleCountdown = 0;
		}
		else if (num > beetleOrbs)
		{
			beetleCounter += 200f;
		}
		if (num == beetleOrbs || beetleOrbs <= 0)
		{
			return;
		}
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] >= 98 && buffType[i] <= 100 && buffType[i] != 97 + num)
			{
				DelBuff(i);
			}
		}
	}

	public void UpdateSocialShadow()
	{
		for (int num = 2; num > 0; num--)
		{
			shadowDirection[num] = shadowDirection[num - 1];
		}
		shadowDirection[0] = direction;
		shadowCount++;
		if (shadowCount == 1)
		{
			shadowPos[2] = shadowPos[1];
			shadowRotation[2] = shadowRotation[1];
			shadowOrigin[2] = shadowOrigin[1];
		}
		else if (shadowCount == 2)
		{
			shadowPos[1] = shadowPos[0];
			shadowRotation[1] = shadowRotation[0];
			shadowOrigin[1] = shadowOrigin[0];
		}
		else if (shadowCount >= 3)
		{
			shadowCount = 0;
			shadowPos[0] = position;
			shadowPos[0].Y += gfxOffY;
			shadowRotation[0] = fullRotation;
			shadowOrigin[0] = fullRotationOrigin;
		}
	}

	public void UpdateTeleportVisuals()
	{
		if (!(teleportTime > 0f))
		{
			return;
		}
		if (teleportStyle == 0)
		{
			if ((float)Main.rand.Next(100) <= 100f * teleportTime * 2f)
			{
				int num = Dust.NewDust(new Vector2(getRect().X, getRect().Y), getRect().Width, getRect().Height, 159);
				Main.dust[num].scale = teleportTime * 1.5f;
				Main.dust[num].noGravity = true;
				Main.dust[num].velocity *= 1.1f;
			}
		}
		else if (teleportStyle == 1)
		{
			if ((float)Main.rand.Next(100) <= 100f * teleportTime)
			{
				int num2 = Dust.NewDust(new Vector2(getRect().X, getRect().Y), getRect().Width, getRect().Height, 164);
				Main.dust[num2].scale = teleportTime * 1.5f;
				Main.dust[num2].noGravity = true;
				Main.dust[num2].velocity *= 1.1f;
			}
		}
		else if (teleportStyle == 2)
		{
			teleportTime = 0.005f;
		}
		else if (teleportStyle == 3)
		{
			teleportTime = 0.005f;
		}
		else if (teleportStyle == 4)
		{
			teleportTime -= 0.02f;
			if ((float)Main.rand.Next(100) <= 100f * teleportTime)
			{
				Dust obj = Main.dust[Dust.NewDust(position, width, height, 263)];
				obj.color = PortalHelper.GetPortalColor(lastPortalColorIndex);
				obj.noLight = true;
				obj.noGravity = true;
				obj.scale = 1.2f;
				obj.fadeIn = 0.4f;
			}
		}
		else if (teleportStyle == 9)
		{
			Rectangle hitbox = base.Hitbox;
			hitbox.Inflate(5, 5);
			if ((float)Main.rand.Next(100) <= 100f * teleportTime)
			{
				TeleportPylonsSystem.SpawnInWorldDust(lastTeleportPylonStyleUsed, hitbox);
			}
		}
		teleportTime -= 0.005f;
	}

	public void UpdateBiomesIfMovedEnoughForBlackFade(Vector2 oldPos)
	{
		if (Vector2.Distance(oldPos, position) > Main.BlackFadeDist)
		{
			UpdateSceneMetrics();
			UpdateBiomes();
		}
	}

	public void UpdateSceneMetrics()
	{
		SceneMetrics.Scan(new SceneMetricsScanSettings
		{
			BiomeScanCenterPositionInWorld = base.Center,
			ScanNPCPositions = true
		});
	}

	public void UpdateBiomes()
	{
		townNPCs = SceneMetrics.TownNPCCount;
		ZoneDungeon = SceneMetrics.ZoneDungeon;
		ZoneLihzhardTemple = SceneMetrics.ZoneLihzhardTemple;
		ZoneGranite = SceneMetrics.ZoneGranite;
		ZoneMarble = SceneMetrics.ZoneMarble;
		ZoneHive = SceneMetrics.ZoneHive;
		ZoneGemCave = SceneMetrics.ZoneGemCave;
		ZoneUndergroundDesert = SceneMetrics.ZoneUndergroundDesert;
		ZoneShimmer = SceneMetrics.ZoneShimmer;
		ZoneCorrupt = SceneMetrics.ZoneCorrupt;
		ZoneCrimson = SceneMetrics.ZoneCrimson;
		ZoneHallow = SceneMetrics.ZoneHallow;
		ZoneJungle = SceneMetrics.ZoneJungle;
		ZoneSnow = SceneMetrics.ZoneSnow;
		ZoneDesert = SceneMetrics.ZoneDesert;
		ZoneGlowshroom = SceneMetrics.ZoneGlowshroom;
		ZoneMeteor = SceneMetrics.ZoneMeteor;
		ZoneGraveyard = SceneMetrics.ZoneGraveyard;
		ZoneWaterCandle = SceneMetrics.ZoneWaterCandle;
		ZonePeaceCandle = SceneMetrics.ZonePeaceCandle;
		ZoneShadowCandle = SceneMetrics.ZoneShadowCandle;
		ZoneBeach = SceneMetrics.ZoneBeach;
		ZoneRain = SceneMetrics.ZoneRain;
		ZoneSandstorm = SceneMetrics.ZoneSandstorm;
		ZoneTowerSolar = SceneMetrics.CloseEnoughToSolarTower;
		ZoneTowerVortex = SceneMetrics.CloseEnoughToVortexTower;
		ZoneTowerNebula = SceneMetrics.CloseEnoughToNebulaTower;
		ZoneTowerStardust = SceneMetrics.CloseEnoughToStardustTower;
		ZoneOldOneArmy = SceneMetrics.CloseEnoughToDD2LanePortal;
		ZoneUnderworldHeight = SceneMetrics.ZoneUnderworldHeight;
		ZoneRockLayerHeight = SceneMetrics.ZoneRockLayerHeight;
		ZoneDirtLayerHeight = SceneMetrics.ZoneDirtLayerHeight;
		ZoneOverworldHeight = SceneMetrics.ZoneOverworldHeight;
		ZoneSkyHeight = SceneMetrics.ZoneSkyHeight;
		if (HasGardenGnomeNearby != SceneMetrics.HasGardenGnome)
		{
			luckNeedsSync = true;
			HasGardenGnomeNearby = SceneMetrics.HasGardenGnome;
		}
		behindBackWall = Framing.GetTileSafely(base.Center).wall > 0;
		if (!dead)
		{
			Point point = base.Center.ToTileCoordinates();
			if (WorldGen.InWorld(point.X, point.Y, 1))
			{
				int num = 0;
				if (Main.tile[point.X, point.Y] != null)
				{
					num = Main.tile[point.X, point.Y].wall;
				}
				switch (num)
				{
				case 86:
					AchievementsHelper.HandleSpecialEvent(this, 12);
					break;
				case 62:
					AchievementsHelper.HandleSpecialEvent(this, 13);
					break;
				}
			}
			if (_funkytownAchievementCheckCooldown > 0)
			{
				_funkytownAchievementCheckCooldown--;
			}
			if (Main.specialSeedWorld)
			{
				AchievementsHelper.HandleSpecialEvent(this, 26);
			}
			if (position.Y / 16f > (float)Main.UnderworldLayer)
			{
				AchievementsHelper.HandleSpecialEvent(this, 14);
			}
			else if (_funkytownAchievementCheckCooldown == 0 && (double)(position.Y / 16f) < Main.worldSurface && ZoneGlowshroom)
			{
				AchievementsHelper.HandleSpecialEvent(this, 15);
			}
			else if (_funkytownAchievementCheckCooldown == 0 && ZoneGraveyard)
			{
				AchievementsHelper.HandleSpecialEvent(this, 18);
			}
		}
		else
		{
			_funkytownAchievementCheckCooldown = 100;
		}
	}

	private void TrySpawningFaelings()
	{
		if (!_wasInShimmerZone && ZoneShimmer && Main.netMode != 1)
		{
			NPC.Spawner.SpawnFaelings(this);
		}
		_wasInShimmerZone = ZoneShimmer;
	}

	public void GetHairSettings(out bool fullHair, out bool hatHair, out bool hideHair, out bool backHairDraw, out bool drawsBackHairWithoutHeadgear)
	{
		fullHair = (hatHair = (hideHair = (drawsBackHairWithoutHeadgear = false)));
		switch (head)
		{
		case 0:
		case 259:
			drawsBackHairWithoutHeadgear = true;
			break;
		case 10:
		case 12:
		case 28:
		case 42:
		case 62:
		case 97:
		case 106:
		case 113:
		case 116:
		case 119:
		case 133:
		case 138:
		case 139:
		case 163:
		case 178:
		case 181:
		case 191:
		case 198:
		case 217:
		case 218:
		case 220:
		case 222:
		case 224:
		case 225:
		case 228:
		case 229:
		case 230:
		case 232:
		case 235:
		case 238:
		case 242:
		case 243:
		case 244:
		case 245:
		case 272:
		case 273:
		case 274:
		case 277:
		case 284:
		case 290:
			fullHair = true;
			break;
		case 13:
		case 14:
		case 15:
		case 16:
		case 18:
		case 21:
		case 24:
		case 25:
		case 26:
		case 29:
		case 40:
		case 44:
		case 51:
		case 56:
		case 59:
		case 60:
		case 63:
		case 64:
		case 65:
		case 67:
		case 68:
		case 69:
		case 81:
		case 92:
		case 94:
		case 95:
		case 100:
		case 114:
		case 121:
		case 126:
		case 130:
		case 136:
		case 140:
		case 143:
		case 145:
		case 158:
		case 159:
		case 161:
		case 182:
		case 184:
		case 190:
		case 195:
		case 215:
		case 216:
		case 219:
		case 223:
		case 226:
		case 227:
		case 231:
		case 233:
		case 234:
		case 262:
		case 263:
		case 264:
		case 265:
		case 267:
		case 275:
		case 279:
		case 280:
		case 281:
		case 286:
		case 289:
		case 292:
			hatHair = true;
			break;
		}
		if (face > -1 && ArmorIDs.Face.Sets.PreventHairDraw[face])
		{
			hideHair = true;
		}
		if (faceHead > -1 && head != 0)
		{
			hideHair = true;
		}
		int num = hair;
		backHairDraw = num > 50 && (num < 56 || num > 63) && (num < 74 || num > 77) && (num < 88 || num > 89) && num != 100 && num != 104 && num != 112 && num < 116;
		if (num == 133 || num == 134 || num == 146 || num == 162 || num == 6)
		{
			backHairDraw = true;
		}
	}

	public void UpdateDead()
	{
		deadTime++;
		isPerformingJump_DownDash = false;
		shimmerUnstuckHelper.Clear();
		timeShimmering = 0;
		forcedGravity = 0;
		_portalPhysicsTime = 0;
		MountFishronSpecialCounter = 0f;
		gem = -1;
		ownedLargeGems = (byte)0;
		brainOfConfusionDodgeAnimationCounter = 0;
		ResetFloorFlags();
		wings = 0;
		wingsLogic = 0;
		ResetVisibleAccessories();
		poisoned = false;
		honey = false;
		venom = false;
		onFire = false;
		dripping = false;
		drippingSlime = false;
		drippingSparkleSlime = false;
		slowOgreSpit = false;
		hungry = false;
		heartyMeal = false;
		starving = false;
		burned = false;
		suffocating = false;
		onFire2 = false;
		onFire3 = false;
		onFrostBurn = false;
		onFrostBurn2 = false;
		shimmering = false;
		blind = false;
		blackout = false;
		loveStruck = false;
		dryadWard = false;
		stinky = false;
		resistCold = false;
		electrified = false;
		moonLeech = false;
		headcovered = false;
		vortexDebuff = false;
		windPushed = false;
		setForbidden = false;
		setMonkT3 = false;
		setHuntressT3 = false;
		setApprenticeT3 = false;
		setSquireT3 = false;
		setForbiddenCooldownLocked = false;
		setSolar = (setVortex = (setNebula = (setStardust = false)));
		setChlorophyte = false;
		nebulaLevelDamage = (nebulaLevelLife = (nebulaLevelMana = 0));
		trapDebuffSource = false;
		yoraiz0rEye = 0;
		yoraiz0rDarkness = false;
		hasFloatingTube = false;
		hasUnicornHorn = false;
		hasAngelHalo = false;
		hasRainbowCursor = false;
		leinforsHair = false;
		musicBox = -1;
		overrideFishingBobber = -1;
		gravDir = 1f;
		killingCardFireType = 0;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] <= 0 || !Main.persistentBuff[buffType[i]])
			{
				buffTime[i] = 0;
				buffType[i] = 0;
			}
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.npcChatText = "";
			Main.editSign = false;
			Main.npcChatCornerItem = 0;
		}
		numMinions = 0;
		slotsMinions = 0f;
		grappling[0] = -1;
		grappling[1] = -1;
		grappling[2] = -1;
		sign = -1;
		SetTalkNPC(-1);
		statLife = 0;
		channel = false;
		potionDelay = 0;
		chest = -1;
		tileEntityAnchor.Clear();
		changeItem = -1;
		itemAnimation = 0;
		immuneAlpha += 2;
		if (immuneAlpha > 255)
		{
			immuneAlpha = 255;
		}
		headPosition += headVelocity;
		bodyPosition += bodyVelocity;
		legPosition += legVelocity;
		headRotation += headVelocity.X * 0.1f;
		bodyRotation += bodyVelocity.X * 0.1f;
		legRotation += legVelocity.X * 0.1f;
		headVelocity.Y += 0.1f;
		bodyVelocity.Y += 0.1f;
		legVelocity.Y += 0.1f;
		headVelocity.X *= 0.99f;
		bodyVelocity.X *= 0.99f;
		legVelocity.X *= 0.99f;
		for (int j = 0; j < npcTypeNoAggro.Length; j++)
		{
			npcTypeNoAggro[j] = false;
		}
		if (difficulty == 2 && (statLifeMax <= 0 || !Main.surviveHardcoreDeath))
		{
			if (respawnTimer > 0)
			{
				respawnTimer = Utils.Clamp(respawnTimer - 1, 0, respawnTimerMax);
			}
			else if (whoAmI == Main.myPlayer || Main.netMode == 2)
			{
				ghost = true;
			}
		}
		else
		{
			respawnTimer = Utils.Clamp(respawnTimer - 1, 0, respawnTimerMax);
			if (respawnTimer <= 0 && Main.myPlayer == whoAmI)
			{
				if (Main.mouseItem.type > 0)
				{
					Main.playerInventory = true;
				}
				Spawn(PlayerSpawnContext.ReviveFromDeath);
			}
		}
		if (whoAmI == Main.myPlayer && !Main.drawingPlayerChat && !Main.editSign && !Main.editChest && !Main.blockInput)
		{
			PlayerInput.Triggers.Current.CopyInto(this);
			TryOpeningInGameOptionsBasedOnInput();
			if (Main.netMode == 1 && CanDeathSpectate)
			{
				HandleSpectatingControls();
			}
			releaseRight = !controlRight;
			releaseLeft = !controlLeft;
		}
		UpdateSunScorchValues();
	}

	private void HandleSpectatingControls()
	{
		if (PlayerInput.Triggers.JustReleased.Jump || controlInv || controlThrow || controlTorch || controlSmart || controlMount || controlQuickHeal || controlQuickMana || controlCreativeMenu || PlayerInput.Triggers.Current.Hotbar1 || PlayerInput.Triggers.Current.Hotbar2 || PlayerInput.Triggers.Current.Hotbar3 || PlayerInput.Triggers.Current.Hotbar4 || PlayerInput.Triggers.Current.Hotbar5 || PlayerInput.Triggers.Current.Hotbar6 || PlayerInput.Triggers.Current.Hotbar7 || PlayerInput.Triggers.Current.Hotbar8 || PlayerInput.Triggers.Current.Hotbar9 || PlayerInput.Triggers.Current.Hotbar10 || PlayerInput.Triggers.Current.HotbarPlus || PlayerInput.Triggers.Current.HotbarMinus || PlayerInput.ScrollWheelDelta != 0)
		{
			afkCounter = Math.Min(afkCounter, AFKTimeNeededForNoWormSpawns);
			afkCounterForKiting = Math.Min(afkCounterForKiting, AFKTimeNeededForAutoKiting);
			SetOrRequestSpectating(-1);
			return;
		}
		if (CanWormholeToSpectating() && PlayerInput.Triggers.JustPressed.QuickBuff)
		{
			Player player = Main.player[spectating];
			UnityTeleport(position + player.Bottom - base.Bottom);
			TakeUnityPotion();
			return;
		}
		int num = 0;
		if (PlayerInput.Triggers.JustPressed.Right || (!PlayerInput.UsingGamepad && PlayerInput.Triggers.JustPressed.MouseLeft))
		{
			num++;
		}
		if (PlayerInput.Triggers.JustPressed.Left || (!PlayerInput.UsingGamepad && PlayerInput.Triggers.JustPressed.MouseRight))
		{
			num--;
		}
		if (num == 0)
		{
			return;
		}
		bool flag = SpectateNextPlayer(num, dead);
		if (!dead && inventory[selectedItem].type == 5644)
		{
			if (flag)
			{
				SoundEngine.PlaySound(SoundID.Item197);
			}
			else
			{
				SoundEngine.PlaySound(SoundID.Item198);
			}
		}
		if (!flag && !dead)
		{
			PunchCameraModifier punchCameraModifier = new PunchCameraModifier(position, new Vector2(1f, 0f), 5f, 6f, 15, -1f, "NoMoreTargets");
			punchCameraModifier.IsAScreenShake = false;
			Main.instance.CameraModifiers.Add(punchCameraModifier);
		}
	}

	public bool CanSpectate(int who)
	{
		if (who < 0 || who == whoAmI)
		{
			return true;
		}
		Player player = Main.player[who];
		if (player.active)
		{
			if (player.dead)
			{
				if (player.whoAmI == spectating)
				{
					return player.deadTime < SpectatingLingerAfterDeath;
				}
				return false;
			}
			return true;
		}
		return false;
	}

	public bool CanWormholeToSpectating()
	{
		if (!dead && spectating >= 0 && spectating != whoAmI && team > 0 && team == Main.player[spectating].team)
		{
			return HasUnityPotion();
		}
		return false;
	}

	public bool AnyoneToSpectate()
	{
		for (int i = 0; i < 255; i++)
		{
			if (i != whoAmI && CanSpectate(i))
			{
				return true;
			}
		}
		return false;
	}

	private int ClosestSpectatablePlayerTo(Vector2 pos)
	{
		int result = -1;
		float num = float.MaxValue;
		for (int i = 0; i < 255; i++)
		{
			if (i != whoAmI && CanSpectate(i))
			{
				float num2 = Main.player[i].DistanceSQ(pos);
				if (num2 < num)
				{
					result = i;
					num = num2;
				}
			}
		}
		return result;
	}

	private bool SpectateNextPlayer(int step, bool includeSelf)
	{
		if (Main.netMode == 0)
		{
			return false;
		}
		int num = ((spectating < 0) ? whoAmI : spectating);
		int num2 = num;
		while (true)
		{
			num2 += step;
			if (num2 >= 255)
			{
				num2 -= 255;
			}
			if (num2 < 0)
			{
				num2 += 255;
			}
			if (num2 == num)
			{
				break;
			}
			if ((num2 != whoAmI || includeSelf) && CanSpectate(num2))
			{
				SetOrRequestSpectating(num2);
				return true;
			}
		}
		return false;
	}

	private void SpectateNextClosestPlayer()
	{
		SetOrRequestSpectating(ClosestSpectatablePlayerTo(SpectatingCameraPosition));
	}

	public void SetOrRequestSpectating(int target)
	{
		if (target == whoAmI)
		{
			target = -1;
		}
		if (target == spectating)
		{
			return;
		}
		if (Main.netMode == 1)
		{
			if (whoAmI == Main.myPlayer)
			{
				if (target == -1)
				{
					spectating = target;
				}
				else if (spectating < 0)
				{
					spectating = whoAmI;
				}
				NetMessage.SendData(150, -1, -1, null, whoAmI, target);
			}
		}
		else
		{
			if (Main.netMode != 2)
			{
				return;
			}
			spectating = target;
			if (!CanSpectate(target))
			{
				SpectateNextClosestPlayer();
				return;
			}
			if (spectating >= 0)
			{
				RemoteClient.CheckSection(whoAmI, Main.player[spectating].position);
			}
			NetMessage.SendData(150, -1, -1, null, whoAmI, target);
		}
	}

	private void TryOpeningInGameOptionsBasedOnInput()
	{
		if (controlInv)
		{
			if (releaseInventory)
			{
				releaseInventory = false;
				if (Main.ingameOptionsWindow)
				{
					IngameOptions.Close();
				}
				else
				{
					IngameOptions.Open();
				}
			}
		}
		else
		{
			releaseInventory = true;
		}
	}

	public void UpdatePet(int i)
	{
		if (i == Main.myPlayer && miscEquips[0].buffType >= 1 && miscEquips[0].stack >= 1)
		{
			int num = miscEquips[0].buffType;
			if ((Main.vanityPet[num] || Main.lightPet[num]) && !hideMisc[0] && (miscEquips[0].type != 603 || Main.runningCollectorsEdition) && FindBuffIndex(num) == -1)
			{
				AddBuff(num, 3600);
				SoundEngine.PlaySound(miscEquips[0].UseSound, position);
			}
		}
	}

	public void UpdatePetLight(int i)
	{
		if (i != Main.myPlayer || miscEquips[1].buffType < 1 || miscEquips[1].stack < 1)
		{
			return;
		}
		int num = miscEquips[1].buffType;
		if ((!Main.vanityPet[num] && !Main.lightPet[num]) || hideMisc[1] || (miscEquips[1].type == 603 && !Main.runningCollectorsEdition))
		{
			return;
		}
		int num2 = FindBuffIndex(num);
		if (num == 27 && num2 == -1)
		{
			num2 = FindBuffIndex(102);
		}
		if (num == 27 && num2 == -1)
		{
			num2 = FindBuffIndex(101);
		}
		if (num2 == -1)
		{
			if (num == 27)
			{
				num = Utils.SelectRandom<int>(Main.rand, 27, 102, 101);
			}
			AddBuff(num, 3600);
			SoundEngine.PlaySound(miscEquips[1].UseSound, position);
		}
	}

	public void TogglePet()
	{
		hideMisc[0] = !hideMisc[0];
		if (hideMisc[0])
		{
			ClearBuff(miscEquips[0].buffType);
		}
	}

	public void ToggleLight()
	{
		hideMisc[1] = !hideMisc[1];
		if (hideMisc[1])
		{
			ClearBuff(miscEquips[1].buffType);
			if (miscEquips[1].buffType == 27)
			{
				ClearBuff(102);
				ClearBuff(101);
			}
		}
	}

	public bool IsWithinSnappngRangeToTile(int x, int y, int distanceInPixels)
	{
		if ((new Vector2(x * 16 + 8, y * 16 + 8) - new Vector2(base.Center.X, base.Bottom.Y - 16f)).Length() <= (float)distanceInPixels)
		{
			return true;
		}
		return false;
	}

	public void SmartInteractLookup()
	{
		Main.ClearSmartInteract();
		if (UILinkPointNavigator.InUse || (PlayerInput.UsingGamepad && Main.HoveringOverAnNPC))
		{
			Main.SmartInteractTileCoordsSelected.Clear();
		}
		if ((!PlayerInput.SettingsForUI.ShowGamepadHints && !Main.SmartCursorIsUsed) || !Main.mouseItem.IsAir)
		{
			_smartInteractSys.Clear();
			return;
		}
		SmartInteractLookup_PrepareCommonlyUsedInfo(out var mousevec, out var LX, out var HX, out var LY, out var HY);
		_smartInteractSys.RunQuery(new SmartInteractScanSettings
		{
			DemandOnlyZeroDistanceTargets = (PlayerInput.SettingsForUI.ShowGamepadHints && !Main.SmartCursorIsUsed),
			FullInteraction = true,
			HX = HX,
			HY = HY,
			LX = LX,
			LY = LY,
			mousevec = mousevec,
			player = this
		});
	}

	private void SmartInteractLookup_PrepareCommonlyUsedInfo(out Vector2 mousevec, out int LX, out int HX, out int LY, out int HY)
	{
		mousevec = Main.ReverseGravitySupport(Main.MouseScreen) + Main.screenPosition;
		TileReachCheckSettings.Simple.GetTileRegion(this, out LX, out LY, out HX, out HY);
		LX = Utils.Clamp(LX, 10, Main.maxTilesX - 10);
		HX = Utils.Clamp(HX, 10, Main.maxTilesX - 10);
		LY = Utils.Clamp(LY, 10, Main.maxTilesY - 10);
		HY = Utils.Clamp(HY, 10, Main.maxTilesY - 10);
	}

	public bool PickItemSelectionOverride(out int selectedSlot)
	{
		if (!Main.mouseItem.IsAir)
		{
			selectedSlot = 58;
			return true;
		}
		if (SmartSelectLookup(out selectedSlot))
		{
			return true;
		}
		if (afkCounterForKiting >= AFKTimeNeededForAutoKiting && selectedKite >= 0 && !noItems && !isOperatingAnotherEntity && spectating < 0)
		{
			selectedSlot = selectedKite;
			if (inventory[selectedKite].holdStyle == 0)
			{
				controlUseItem = (releaseUseItem = true);
			}
			return true;
		}
		selectedSlot = -1;
		return false;
	}

	public bool SmartSelectLookup(out int selectedSlot)
	{
		if (!controlTorch)
		{
			selectedSlot = -1;
			_lastSmartCursorToolStrategy = -1;
			return false;
		}
		PlayerInput.smartSelectPointer.SmartSelectLookup_GetTargetTile(this, out var tX, out var tY);
		SmartSelect_GetToolStrategy(tX, tY, out var toolStrategy, out var wetTile);
		if (PlayerInput.UsingGamepad && _lastSmartCursorToolStrategy != -1)
		{
			toolStrategy = _lastSmartCursorToolStrategy;
		}
		if (toolStrategy == 0 || toolStrategy == 4)
		{
			float num = Math.Abs((float)Main.mouseX + Main.screenPosition.X - (position.X + (float)(width / 2)));
			float num2 = Math.Abs((float)Main.mouseY + Main.screenPosition.Y - (position.Y + (float)(height / 2))) * 1.3f;
			if ((float)Math.Sqrt(num * num + num2 * num2) > 200f)
			{
				toolStrategy = 5;
			}
		}
		_lastSmartCursorToolStrategy = toolStrategy;
		selectedSlot = SmartSelect_PickToolForStrategy(tX, tY, toolStrategy, wetTile);
		return true;
	}

	private void SmartSelectLookup_GetTargetTile(out int tX, out int tY)
	{
		tX = (int)(((float)Main.mouseX + Main.screenPosition.X) / 16f);
		tY = (int)(((float)Main.mouseY + Main.screenPosition.Y) / 16f);
		if (gravDir == -1f)
		{
			tY = (int)((Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY) / 16f);
		}
	}

	private int SmartSelect_PickToolForStrategy(int tX, int tY, int toolStrategy, bool wetTile)
	{
		int result = selectedItem;
		for (int i = 0; i < 50; i++)
		{
			int type = inventory[i].type;
			switch (toolStrategy)
			{
			case 0:
				if (ItemID.Sets.Torches[type])
				{
					result = i;
					break;
				}
				if (ItemID.Sets.Glowsticks[type])
				{
					result = i;
				}
				continue;
			case 1:
				if (inventory[i].hammer <= 0)
				{
					continue;
				}
				result = i;
				break;
			case 2:
				if (inventory[i].axe <= 0)
				{
					continue;
				}
				result = i;
				break;
			case 3:
				if (inventory[i].pick <= 0)
				{
					continue;
				}
				result = i;
				break;
			case 4:
				if (!ItemID.Sets.Glowsticks[inventory[i].type] && inventory[i].type != 930 && ItemID.Sets.Torches[type] && !ItemID.Sets.WaterTorches[type])
				{
					if (!ItemID.Sets.Torches[inventory[selectedItem].type])
					{
						result = i;
					}
					continue;
				}
				if (ItemID.Sets.Glowsticks[type] && wetTile)
				{
					result = i;
				}
				else if (type == 930 && wetTile)
				{
					bool flag2 = false;
					for (int num2 = 57; num2 >= 0; num2--)
					{
						if (inventory[num2].ammo == inventory[i].useAmmo && inventory[num2].stack > 0)
						{
							flag2 = true;
							break;
						}
					}
					if (!flag2)
					{
						continue;
					}
					result = i;
				}
				else
				{
					if (!ItemID.Sets.WaterTorches[type])
					{
						continue;
					}
					result = i;
				}
				break;
			case 5:
				if (ItemID.Sets.Torches[type])
				{
					if (!ItemID.Sets.Torches[inventory[selectedItem].type])
					{
						result = i;
					}
					continue;
				}
				if (type == 930)
				{
					bool flag = false;
					for (int num = 57; num >= 0; num--)
					{
						if (inventory[num].ammo == inventory[i].useAmmo && inventory[num].stack > 0)
						{
							flag = true;
							break;
						}
					}
					if (!flag)
					{
						continue;
					}
					result = i;
				}
				else
				{
					if (!ItemID.Sets.Glowsticks[type])
					{
						continue;
					}
					result = i;
				}
				break;
			case 6:
				if (!ItemID.Sets.Torches[type])
				{
					continue;
				}
				result = i;
				break;
			case 7:
			{
				ItemTrader itemTrader = TryGettingItemTraderFromBlock(Main.tile[tX, tY]);
				if (itemTrader != null && itemTrader.TryGetTradeOption(inventory[i], out var _))
				{
					result = i;
					break;
				}
				if (ItemID.Sets.ExtractinatorMode[type] < 0)
				{
					continue;
				}
				result = i;
				break;
			}
			case 8:
				if (!ItemID.Sets.IsPaintScraper[type])
				{
					continue;
				}
				result = i;
				break;
			default:
				continue;
			}
			break;
		}
		return result;
	}

	private void SmartSelect_GetToolStrategy(int tX, int tY, out int toolStrategy, out bool wetTile)
	{
		toolStrategy = 0;
		bool flag = false;
		wetTile = false;
		try
		{
			SmartSelect_GetAvailableToolRanges(out var pickRange, out var axeRange, out var hammerRange, out var cannonRange, out var extractItemRange, out var paintScraperRange);
			wetTile = Main.tile[tX, tY].liquid > 0;
			if (Main.tile[tX, tY].active())
			{
				int type = Main.tile[tX, tY].type;
				if ((type == 219 || type == 642) && IsInTileInteractionRange(tX, tY, TileReachCheckSettings.Simple, extractItemRange))
				{
					toolStrategy = 7;
					flag = true;
				}
				else if (type == 209 && Main.tile[tX, tY].frameX / 72 < 3 && IsInTileInteractionRange(tX, tY, TileReachCheckSettings.Simple, cannonRange))
				{
					toolStrategy = 6;
					flag = true;
				}
				else if (Main.tileHammer[type] && IsInTileInteractionRange(tX, tY, TileReachCheckSettings.Simple, hammerRange))
				{
					toolStrategy = 1;
					flag = true;
				}
				else if (Main.tileAxe[type] && IsInTileInteractionRange(tX, tY, TileReachCheckSettings.Simple, axeRange))
				{
					toolStrategy = 2;
					flag = true;
				}
				else if (type == 184 && IsInTileInteractionRange(tX, tY, TileReachCheckSettings.Simple, paintScraperRange))
				{
					toolStrategy = 8;
					flag = true;
				}
				else if (IsInTileInteractionRange(tX, tY, TileReachCheckSettings.Simple, pickRange))
				{
					toolStrategy = 3;
					flag = true;
				}
			}
			else if (wetTile && wet)
			{
				toolStrategy = 4;
				flag = true;
			}
		}
		catch
		{
		}
		if (!flag && wet)
		{
			toolStrategy = 4;
		}
	}

	private void SmartSelect_GetAvailableToolRanges(out int pickRange, out int axeRange, out int hammerRange, out int cannonRange, out int extractItemRange, out int paintScraperRange)
	{
		pickRange = -10;
		axeRange = -10;
		hammerRange = -10;
		cannonRange = -10;
		extractItemRange = -10;
		paintScraperRange = -10;
		for (int i = 0; i < 50; i++)
		{
			if (inventory[i].pick > 0 && pickRange == -10)
			{
				pickRange = inventory[i].tileBoost;
			}
			if (inventory[i].axe > 0 && axeRange == -10)
			{
				axeRange = inventory[i].tileBoost;
			}
			if (inventory[i].hammer > 0 && hammerRange == -10)
			{
				hammerRange = inventory[i].tileBoost;
			}
			if (ItemID.Sets.Torches[inventory[i].type] && cannonRange == -10)
			{
				cannonRange = inventory[i].tileBoost;
			}
			if (ItemID.Sets.IsPaintScraper[inventory[i].type] && paintScraperRange == -10)
			{
				paintScraperRange = inventory[i].tileBoost;
			}
			if (ItemID.Sets.ExtractinatorMode[inventory[i].type] != -1 && extractItemRange == -10)
			{
				extractItemRange = inventory[i].tileBoost;
			}
		}
	}

	private void EndOngoingTorchGodEvent()
	{
		if (happyFunTorchTime)
		{
			RelightTorches();
			happyFunTorchTime = false;
			if (Main.netMode == 1)
			{
				NetMessage.SendData(4, -1, -1, null, whoAmI);
			}
		}
	}

	private void TryRecalculatingTorchLuck()
	{
		if (happyFunTorchTime)
		{
			luckyTorchCounter = 0;
			TorchAttack();
			return;
		}
		if (torchGodCooldown > 0)
		{
			torchGodCooldown--;
		}
		Vector2 nextTorchLuckCheckCenter = _nextTorchLuckCheckCenter;
		if ((0u | (((double)nextTorchLuckCheckCenter.Y < Main.worldSurface * 16.0) ? 1u : 0u) | (dead ? 1u : 0u)) != 0)
		{
			UpdateTorchLuck_ConsumeCountersAndCalculate();
			return;
		}
		int num = 1;
		int num2 = 40;
		int num3 = (int)nextTorchLuckCheckCenter.Y / 16 - num2;
		int value = (int)nextTorchLuckCheckCenter.X / 16 - num2;
		int value2 = (int)nextTorchLuckCheckCenter.X / 16 + num2;
		value = Utils.Clamp(value, 10, Main.maxTilesX - 10);
		value2 = Utils.Clamp(value2, 10, Main.maxTilesX - 10);
		for (int i = 0; i < num; i++)
		{
			int num4 = num3 + i + luckyTorchCounter * num;
			if (num4 < 10 || num4 > Main.maxTilesY - 10)
			{
				continue;
			}
			for (int j = value; j <= value2; j++)
			{
				Tile tile = Main.tile[j, num4];
				if (tile == null)
				{
					return;
				}
				if (!tile.active() || tile.type != 4 || tile.frameX < 0 || tile.frameY < 0)
				{
					continue;
				}
				if (tile.frameX < 66)
				{
					nearbyTorches++;
				}
				int num5 = tile.frameY / 22;
				if (num5 < TorchID.Count)
				{
					nearbyTorch[num5] = true;
					if (num5 == 17 && (tile.liquid == 0 || tile.liquidType() != 0))
					{
						dryCoralTorch = true;
					}
				}
			}
			if (num4 >= (int)nextTorchLuckCheckCenter.Y / 16 + num2)
			{
				UpdateTorchLuck_ConsumeCountersAndCalculate();
				return;
			}
		}
		luckyTorchCounter++;
	}

	private void RelightTorches()
	{
		torchGodCooldown = 3600;
		for (int i = 0; i < numberOfTorchAttacksMade; i++)
		{
			int num = unlitTorchX[i];
			int num2 = unlitTorchY[i];
			Tile tile = Main.tile[num, num2];
			if (tile != null && tile.active() && TileID.Sets.Torches[tile.type] && Main.tile[num, num2].frameX >= 66)
			{
				Main.tile[num, num2].frameX -= 66;
				NetMessage.SendTileSquare(-1, num, num2);
			}
		}
	}

	private void TorchAttack()
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		if ((double)position.Y < Main.worldSurface * 16.0)
		{
			EndOngoingTorchGodEvent();
			return;
		}
		AddBuff(80, 2);
		torchFunTimer++;
		if (torchFunTimer <= 20)
		{
			return;
		}
		torchFunTimer = 0;
		int num = 0;
		int num2 = 100;
		int value = (int)base.Center.X / 16 - num2;
		int value2 = (int)base.Center.X / 16 + num2;
		int value3 = (int)base.Center.Y / 16 - num2;
		int value4 = (int)base.Center.Y / 16 + num2;
		int num3 = Utils.Clamp(value, 10, Main.maxTilesX - 10);
		value2 = Utils.Clamp(value2, 10, Main.maxTilesX - 10);
		value3 = Utils.Clamp(value3, 10, Main.maxTilesY - 10);
		value4 = Utils.Clamp(value4, 10, Main.maxTilesY - 10);
		for (int i = num3; i <= value2; i++)
		{
			for (int j = value3; j <= value4; j++)
			{
				Tile tile = Main.tile[i, j];
				if (tile != null && (tile.active() & (tile.type == 4)) && tile.frameX < 66)
				{
					_torchAttackPosX[num] = i;
					_torchAttackPosY[num] = j;
					num++;
					if (num >= _torchAttackPosX.Length)
					{
						break;
					}
				}
			}
			if (num >= _torchAttackPosX.Length)
			{
				break;
			}
		}
		if (num == 0 || numberOfTorchAttacksMade >= maxTorchAttacks)
		{
			RelightTorches();
			happyFunTorchTime = false;
			if (Main.netMode == 1)
			{
				NetMessage.SendData(4, -1, -1, null, whoAmI);
			}
			if (numberOfTorchAttacksMade >= 95)
			{
				int number = Item.NewItem(new EntitySource_ByItemSourceId(this, ItemSourceID.TorchGod), (int)position.X, (int)position.Y, width, height, 5043);
				if (Main.netMode == 1)
				{
					NetMessage.SendData(21, -1, -1, null, number, 1f);
				}
			}
		}
		else
		{
			if (num <= 0)
			{
				return;
			}
			int num4 = Main.rand.Next(num);
			int num5 = _torchAttackPosX[num4];
			int num6 = _torchAttackPosY[num4];
			if (Main.tile[num5, num6].type == 4 && Main.tile[num5, num6].frameX < 66)
			{
				float num7 = 8f;
				int num8 = 20;
				if (num8 < 10)
				{
					num8 = 10;
				}
				int num9 = (int)MathHelper.Clamp(Main.tile[num5, num6].frameY / 22, 0f, TorchID.Count - 1);
				num9 = TorchID.Dust[num9];
				Main.tile[num5, num6].frameX += 66;
				unlitTorchX[numberOfTorchAttacksMade] = num5;
				unlitTorchY[numberOfTorchAttacksMade] = num6;
				numberOfTorchAttacksMade++;
				NetMessage.SendTileSquare(-1, num5, num6);
				Vector2 vector = new Vector2(num5 * 16 + 8, num6 * 16);
				Vector2 vector2 = base.Center - vector;
				float num10 = vector2.Length();
				vector2.Normalize();
				vector2 *= num7;
				int num11 = Projectile.NewProjectile(GetProjectileSource_Misc(10), vector, vector2, 949, num8, 1f, whoAmI, num9, num10);
				Main.projectile[num11].ai[0] = num9;
				Main.projectile[num11].ai[1] = num10;
				Main.projectile[num11].netUpdate = true;
				if ((num == 1 && numberOfTorchAttacksMade >= 95) || numberOfTorchAttacksMade >= maxTorchAttacks)
				{
					torchFunTimer = -180;
				}
			}
		}
	}

	private void UpdateTorchLuck_ConsumeCountersAndCalculate()
	{
		luckyTorchCounter = 0;
		torchLuck = 0f;
		_nextTorchLuckCheckCenter = base.Center;
		if (inventory[selectedItem].createTile == 4 && inventory[selectedItem].placeStyle < TorchID.Count)
		{
			nearbyTorch[inventory[selectedItem].placeStyle] = true;
		}
		float num = 0f;
		float num2 = 0f;
		if (!ZoneDungeon && !ZoneLihzhardTemple)
		{
			if (nearbyTorch[9])
			{
				if (ZoneSnow)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[16])
			{
				if (ZoneDesert)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[17])
			{
				if (WorldGen.oceanDepths((int)base.Center.X / 16, (int)base.Center.Y / 16))
				{
					num2 += 1f;
				}
				else if (dryCoralTorch)
				{
					num += 1f;
				}
			}
			if (nearbyTorch[21])
			{
				if (ZoneJungle)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[22])
			{
				if (ZoneGlowshroom)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[18])
			{
				if (ZoneCorrupt)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[8] && ZoneCorrupt)
			{
				num2 += 1f;
			}
			if (nearbyTorch[19])
			{
				if (ZoneCrimson)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[11] && ZoneCrimson)
			{
				num2 += 1f;
			}
			if (nearbyTorch[20])
			{
				if (ZoneHallow)
				{
					num2 += 1f;
				}
				else
				{
					num += 1f;
				}
			}
			if (nearbyTorch[13] && !ZoneSnow && !ZoneDesert && !ZoneCorrupt && !ZoneCrimson && !ZoneHallow && !ZoneJungle)
			{
				num2 += 0.5f;
			}
			if (nearbyTorch[0])
			{
				if (ZoneSnow)
				{
					num += 2f;
				}
				else if (ZoneDesert || ZoneCorrupt || ZoneCrimson || ZoneHallow)
				{
					num += 0.5f;
				}
			}
		}
		if (num2 >= 1f)
		{
			torchLuck += 1f;
		}
		else if (num2 > 0f)
		{
			torchLuck += 0.5f;
		}
		if (num >= 2f)
		{
			torchLuck += -1.5f;
		}
		else if (num >= 1f)
		{
			torchLuck += -1f;
		}
		else if (num > 0f)
		{
			torchLuck += -0.5f;
		}
		dryCoralTorch = false;
		for (int i = 0; i < TorchID.Count; i++)
		{
			nearbyTorch[i] = false;
		}
		if (torchLuck < 0f)
		{
			torchLuck = 0f;
		}
		if (torchGodCooldown <= 0 && !unlockedBiomeTorches && nearbyTorches > 100 && !happyFunTorchTime && (double)position.Y > Main.worldSurface * 16.0)
		{
			bool flag = false;
			for (int j = 0; j < inventory.Length; j++)
			{
				if (inventory[j].type == 5043)
				{
					flag = true;
					break;
				}
			}
			if (!flag)
			{
				happyFunTorchTime = true;
				numberOfTorchAttacksMade = 0;
			}
		}
		nearbyTorches = 0;
	}

	public void AddCoinLuck(Vector2 coinPosition, int coinAmount)
	{
		if (!dead && Vector2.Distance(coinPosition, base.Center) < 1000f)
		{
			coinLuck += coinAmount;
			if (coinLuck > 1000000f)
			{
				coinLuck = 1000000f;
			}
			luckNeedsSync = true;
		}
	}

	private void UpdateCoinLuck()
	{
		if (!(coinLuck <= 0f))
		{
			coinLuck *= (float)Math.Pow(0.9999, Main.dayRate);
			if ((double)coinLuck < 0.25)
			{
				coinLuck = 0f;
			}
		}
	}

	private float CalculateCoinLuck()
	{
		if (coinLuck == 0f)
		{
			return 0f;
		}
		if (coinLuck > 249000f)
		{
			return 0.2f;
		}
		if (coinLuck > 24900f)
		{
			return 0.175f;
		}
		if (coinLuck > 24900f)
		{
			return 0.175f;
		}
		if (coinLuck > 2490f)
		{
			return 0.15f;
		}
		if (coinLuck > 249f)
		{
			return 0.125f;
		}
		if ((double)coinLuck > 24.9)
		{
			return 0.1f;
		}
		if ((double)coinLuck > 2.49)
		{
			return 0.075f;
		}
		if ((double)coinLuck > 0.249)
		{
			return 0.05f;
		}
		return 0.025f;
	}

	private float GetLadyBugLuck()
	{
		if (ladyBugLuckTimeLeft > 0)
		{
			return (float)ladyBugLuckTimeLeft / (float)NPC.ladyBugGoodLuckTime;
		}
		if (ladyBugLuckTimeLeft < 0)
		{
			return (0f - (float)ladyBugLuckTimeLeft) / (float)NPC.ladyBugBadLuckTime;
		}
		return 0f;
	}

	public static float GetClosestPlayersLuck(Point Position)
	{
		return Main.player[FindClosest(new Vector2(Position.X * 16, Position.Y * 16), 1, 1)].luck;
	}

	public static float GetClosestPlayersLuck(Vector2 Position)
	{
		return Main.player[FindClosest(Position, 1, 1)].luck;
	}

	public bool IsThisCenx()
	{
		if (name.ToLower() == "cenx" || name.ToLower() == "cblox" || name.ToLower() == "jade lightning" || name.ToLower() == "cenigit")
		{
			return true;
		}
		return false;
	}

	public int RollLuck(int range)
	{
		return Luck.RollLuck(luck, range);
	}

	public int RollBadLuck(int range)
	{
		return Luck.RollBadLuck(luck, range);
	}

	public int RollOnlyBadLuck(int range)
	{
		return Luck.RollOnlyBadLuck(luck, range);
	}

	public int RollBadLuckExtreme(int range)
	{
		return Luck.RollBadLuckExtreme(luck, range);
	}

	public int RollOnlyBadLuckExtreme(int range)
	{
		return Luck.RollOnlyBadLuckExtreme(luck, range);
	}

	public static Player GetPlayerWithHighestLuck()
	{
		Player player = null;
		for (int i = 0; i < 255; i++)
		{
			Player player2 = Main.player[i];
			if (player2.active && (player == null || player.luck < player2.luck))
			{
				player = player2;
			}
		}
		if (player == null)
		{
			player = new Player();
		}
		return player;
	}

	public static float GetClosestRollLuck(Vector2 position, int range)
	{
		return Main.player[FindClosest(position, 1, 1)].RollLuck(range);
	}

	public static float GetClosestRollLuck(int x, int y, int range)
	{
		return Main.player[FindClosest(new Vector2(x * 16, y * 16), 1, 1)].RollLuck(range);
	}

	public static float GetClosestRollBadLuck(Vector2 position, int range)
	{
		return Main.player[FindClosest(position, 1, 1)].RollBadLuck(range);
	}

	public static float GetClosestRollBadLuck(int x, int y, int range)
	{
		return Main.player[FindClosest(new Vector2(x * 16, y * 16), 1, 1)].RollBadLuck(range);
	}

	public int ApplyRapidAttackBonus(int damage, int itemType, bool increaseBonus = false)
	{
		if (!ItemID.Sets.RapidAttackBonusDamage[itemType])
		{
			return damage;
		}
		float num = 0.5f;
		float num2 = 0.12f;
		float num3 = rapidAttackBonus;
		if (num3 > num)
		{
			num3 = num;
		}
		if (increaseBonus)
		{
			rapidAttackBonus += num2;
			if (rapidAttackBonus > num + num2)
			{
				rapidAttackBonus = num + num2;
			}
		}
		return (int)((float)damage * (1f + num3));
	}

	public void ResetEffects()
	{
		IsAllowedToHoldItems = true;
		if (rapidAttackBonus > 0f)
		{
			rapidAttackBonus -= 0.005f;
			if (rapidAttackBonus < 0f)
			{
				rapidAttackBonus = 0f;
			}
		}
		if (extraAccessory && (Main.expertMode || Main.gameMenu))
		{
			extraAccessorySlots = 1;
		}
		else
		{
			extraAccessorySlots = 0;
		}
		if (shimmering)
		{
			shimmerTransparency += 0.015f;
			if (shimmerTransparency > 0.8f)
			{
				shimmerTransparency = 0.8f;
			}
		}
		else if (shimmerTransparency > 0f)
		{
			if (shimmerTransparency == 0.8f)
			{
				SoundEngine.PlaySound(19, (int)position.X, (int)position.Y, 3);
			}
			shimmerTransparency -= 0.015f;
			if (shimmerTransparency < 0f)
			{
				shimmerTransparency = 0f;
			}
		}
		shimmering = false;
		fairyBoots = false;
		hellfireTreads = false;
		moonLordLegs = false;
		deadMansSweater = false;
		flowerBoots = false;
		arcticDivingGear = false;
		noBuilding = false;
		strongBees = false;
		armorPenetration = 0;
		meleeArmorPenetration = 0;
		ashWoodBonus = false;
		shroomiteStealth = false;
		statDefense = 0;
		accWatch = 0;
		accCompass = 0;
		accDepthMeter = 0;
		accDivingHelm = false;
		canFloatInWater = false;
		lifeRegen = 0;
		manaCost = 1f;
		meleeSpeed = 1f;
		meleeDamage = 1f;
		rangedDamage = 1f;
		rangedMultDamage = 1f;
		magicDamage = 1f;
		minionDamage = 1f;
		summonerWeaponSpeedBonus = 0f;
		meleeCrit = 4;
		rangedCrit = 4;
		magicCrit = 4;
		hasFootball = false;
		drawingFootball = false;
		minionKB = 0f;
		moveSpeed = 1f;
		boneArmor = false;
		honey = false;
		frostArmor = false;
		rocketBoots = 0;
		vanityRocketBoots = 0;
		fireWalk = false;
		noKnockback = false;
		jumpBoost = false;
		frogLegJumpBoost = false;
		skyStoneEffects = false;
		noFallDmg = false;
		accFlipper = false;
		deadCellsPotionStation = false;
		spawnMax = false;
		spaceGun = false;
		killGuide = false;
		killClothier = false;
		lavaImmune = false;
		gills = false;
		slowFall = false;
		findTreasure = false;
		biomeSight = false;
		invis = false;
		nightVision = false;
		enemySpawns = false;
		hasTitaniumStormBuff = false;
		thorns = 0f;
		aggro = 0;
		waterWalk = false;
		waterWalk2 = false;
		detectCreature = false;
		gravControl = false;
		if (forcedGravity > 0)
		{
			forcedGravity--;
		}
		honeyCombItem = null;
		gravControl2 = false;
		statLifeMax2 = statLifeMax;
		statManaMax2 = statManaMax;
		chloroAmmoCost80 = false;
		huntressAmmoCost90 = false;
		ammoCost80 = false;
		ammoCost75 = false;
		manaRegenBuff = false;
		hasCreditsSceneMusicBox = false;
		arrowDamage = 1f;
		arrowDamageAdditiveStack = 0f;
		bulletDamage = 1f;
		rocketDamage = 1f;
		coolWhipBuff = false;
		cobWhipBuff = false;
		yoraiz0rEye = 0;
		yoraiz0rDarkness = false;
		hasFloatingTube = false;
		hasUnicornHorn = false;
		hasAngelHalo = false;
		hasRainbowCursor = false;
		leinforsHair = false;
		overrideFishingBobber = -1;
		suspiciouslookingTentacle = false;
		crimsonHeart = false;
		lightOrb = false;
		blueFairy = false;
		redFairy = false;
		greenFairy = false;
		wisp = false;
		bunny = false;
		turtle = false;
		eater = false;
		trident = false;
		skeletron = false;
		hornet = false;
		zephyrfish = false;
		tiki = false;
		lizard = false;
		parrot = false;
		sapling = false;
		cSapling = false;
		truffle = false;
		stressBall = false;
		selectedKite = -1;
		staffOfRegrowthBonus = false;
		yoyoGlove = false;
		magicString = false;
		counterWeight = 0;
		vanityCounterWeight = 0;
		stringColor = 0;
		yoyoString = false;
		shadowDodge = false;
		palladiumRegen = false;
		chaosState = false;
		onHitDodge = false;
		onHitRegen = false;
		onHitPetal = false;
		iceBarrier = false;
		onHitTitaniumStorm = false;
		maxMinions = 1;
		maxTurrets = 1;
		ammoBox = false;
		ammoPotion = false;
		penguin = false;
		sporeSac = false;
		shinyStone = false;
		empressBrooch = false;
		volatileGelatin = false;
		hasMagiluminescence = false;
		shadowArmor = false;
		dontStarveShader = Main.onlyDontStarveWorld;
		noirShader = false;
		eyebrellaCloud = false;
		stardustMonolithShader = false;
		nebulaMonolithShader = false;
		vortexMonolithShader = false;
		solarMonolithShader = false;
		moonLordMonolithShader = false;
		bloodMoonMonolithShader = false;
		shimmerMonolithShader = false;
		CRTMonolithShader = false;
		retroMonolithShader = false;
		musicBox = -1;
		dd2Accessory = false;
		magicLantern = false;
		rabid = false;
		sunflower = false;
		wellFed = false;
		inferno = false;
		hasDeadCellsDownDash = false;
		manaMagnet = false;
		lifeMagnet = false;
		treasureMagnet = false;
		chiselSpeed = false;
		lifeForce = false;
		dangerSense = false;
		endurance = 0f;
		whipRangeMultiplier = 1f;
		whipUseTimeMultiplier = 1f;
		calmed = false;
		beetleOrbs = 0;
		beetleBuff = false;
		miniMinotaur = false;
		goldRing = false;
		solarShields = 0;
		GoingDownWithGrapple = false;
		fishingSkill = 0;
		cratePotion = false;
		sonarPotion = false;
		accTackleBox = false;
		accFishingBobber = false;
		accFishingLine = false;
		accLavaFishing = false;
		accFishFinder = false;
		accWeatherRadio = false;
		accThirdEye = false;
		InfoAccMechShowWires = false;
		accJarOfSouls = false;
		accCalendar = false;
		accStopwatch = false;
		accOreFinder = false;
		accCritterGuide = false;
		accDreamCatcher = false;
		wallSpeed = 1f;
		tileSpeed = 1f;
		autoPaint = false;
		autoActuator = false;
		petFlagKingSlimePet = false;
		petFlagEyeOfCthulhuPet = false;
		petFlagEaterOfWorldsPet = false;
		petFlagBrainOfCthulhuPet = false;
		petFlagSkeletronPet = false;
		petFlagQueenBeePet = false;
		petFlagDestroyerPet = false;
		petFlagTwinsPet = false;
		petFlagSkeletronPrimePet = false;
		petFlagPlanteraPet = false;
		petFlagGolemPet = false;
		petFlagDukeFishronPet = false;
		petFlagLunaticCultistPet = false;
		petFlagMoonLordPet = false;
		petFlagFairyQueenPet = false;
		petFlagPumpkingPet = false;
		petFlagEverscreamPet = false;
		petFlagIceQueenPet = false;
		petFlagMartianPet = false;
		petFlagDD2OgrePet = false;
		petFlagDD2BetsyPet = false;
		petFlagQueenSlimePet = false;
		petFlagVoltBunny = false;
		petFlagShadowMimic = false;
		petFlagBabyWerewolf = false;
		petFlagDynamiteKitten = false;
		petFlagPlantero = false;
		petFlagBabyRedPanda = false;
		petFlagLilHarpy = false;
		petFlagFennecFox = false;
		petFlagGlitteryButterfly = false;
		petFlagBabyImp = false;
		petFlagBabyShark = false;
		petFlagUpbeatStar = false;
		petFlagDD2Gato = false;
		petFlagDD2Dragon = false;
		petFlagDD2Ghost = false;
		petFlagBerniePet = false;
		petFlagGlommerPet = false;
		petFlagDeerclopsPet = false;
		petFlagPigPet = false;
		petFlagChesterPet = false;
		petFlagJunimoPet = false;
		petFlagBlueChickenPet = false;
		petFlagSpiffo = false;
		petFlagCaveling = false;
		petFlagDirtiestBlock = false;
		petFlagBoulderPet = false;
		petFlagRainbowBoulderPet = false;
		petFlagDeadCellsSwarmBiter = false;
		petFlagPufferfish = false;
		petFlagAxeFairyPet = false;
		petFlagChillet = false;
		petFlagChilletIgnis = false;
		companionCube = false;
		petFlagSugarGlider = false;
		babyFaceMonster = false;
		manaSick = false;
		puppy = false;
		grinch = false;
		blackCat = false;
		spider = false;
		squashling = false;
		magicCuffs = false;
		coldDash = false;
		desertDash = false;
		desertBoots = false;
		sailDash = false;
		cordage = false;
		magicQuiver = false;
		shimmerImmune = false;
		hasMoltenQuiver = false;
		magmaStone = false;
		hasRaisableShield = false;
		lavaRose = false;
		eyeSpring = false;
		snowman = false;
		scope = false;
		panic = false;
		brainOfConfusionItem = null;
		dino = false;
		crystalLeaf = false;
		pygmy = false;
		raven = false;
		slime = false;
		hornetMinion = false;
		impMinion = false;
		twinsMinion = false;
		spiderMinion = false;
		pirateMinion = false;
		sharknadoMinion = false;
		stardustMinion = false;
		batsOfLight = false;
		babyBird = false;
		stormTiger = false;
		flinxMinion = false;
		abigailMinion = false;
		deadCellsMushroomBoiMinion = false;
		palworldCattivaMinion = false;
		palworldFoxsparksMinion = false;
		smolstar = false;
		empressBlade = false;
		stardustGuardian = false;
		stardustDragon = false;
		UFOMinion = false;
		DeadlySphereMinion = false;
		chilled = false;
		tipsy = false;
		dazed = false;
		frozen = false;
		stoned = false;
		webbed = false;
		ichor = false;
		manaRegenBonus = 0;
		manaRegenDelayBonus = 0f;
		carpet = false;
		iceSkate = false;
		dashType = 0;
		spikedBoots = 0;
		blackBelt = false;
		lavaMax = 0;
		archery = false;
		poisoned = false;
		venom = false;
		blind = false;
		blackout = false;
		onFire = false;
		dripping = false;
		hungry = false;
		heartyMeal = false;
		starving = false;
		drippingSlime = false;
		drippingSparkleSlime = false;
		burned = false;
		suffocating = false;
		onFire2 = false;
		onFire3 = false;
		onFrostBurn = false;
		onFrostBurn2 = false;
		frostBurn = false;
		noItems = false;
		cursed = false;
		blockRange = 0;
		pickSpeed = 1f;
		wereWolf = false;
		rulerGrid = false;
		rulerLine = true;
		bleed = false;
		confused = false;
		witheredArmor = false;
		witheredWeapon = false;
		parryDamageBuff = false;
		slowOgreSpit = false;
		wings = 0;
		wingsLogic = 0;
		wingTimeMax = 0;
		brokenArmor = false;
		silence = false;
		slow = false;
		gross = false;
		tongued = false;
		kbGlove = false;
		autoReuseGlove = false;
		meleeScaleGlove = false;
		remoteVisionForDrone = false;
		kbBuff = false;
		starCloakItem = null;
		starCloakItem_manaCloakOverrideItem = null;
		starCloakItem_starVeilOverrideItem = null;
		starCloakItem_beeCloakOverrideItem = null;
		longInvince = false;
		pStone = false;
		manaFlower = false;
		crimsonRegen = false;
		ghostHeal = false;
		ghostHurt = false;
		turtleArmor = false;
		turtleThorns = false;
		cactusThorns = false;
		spiderArmor = false;
		anglerSetSpawnReduction = false;
		vampireBurningInSunlight = false;
		loveStruck = false;
		stinky = false;
		dryadWard = false;
		resistCold = false;
		electrified = false;
		moonLeech = false;
		headcovered = false;
		vortexDebuff = false;
		windPushed = false;
		ballistaPanic = false;
		vampireFrog = false;
		CanSeeInvisibleBlocks = false;
		setVortex = (setNebula = (setStardust = false));
		setChlorophyte = false;
		setForbidden = false;
		setHuntressT3 = false;
		setSquireT3 = false;
		setMonkT3 = false;
		setApprenticeT3 = false;
		setHuntressT2 = false;
		setSquireT2 = false;
		setMonkT2 = false;
		setApprenticeT2 = false;
		setForbiddenCooldownLocked = false;
		nebulaLevelDamage = (nebulaLevelLife = (nebulaLevelMana = 0));
		ignoreWater = false;
		lavaVision = false;
		meleeEnchant = 0;
		discountEquipped = false;
		hasLuckyCoin = false;
		boneGloveItem = null;
		hasLuck_LuckyCoin = false;
		hasLuck_LuckyHorseshoe = false;
		hasLuck_LuckyClover = false;
		hasLuck_RavenFeather = false;
		hasLuck_WiltedClover = false;
		hasJumpOption_Cloud = false;
		hasJumpOption_Sail = false;
		hasJumpOption_Sandstorm = false;
		hasJumpOption_Blizzard = false;
		hasJumpOption_Fart = false;
		hasJumpOption_Unicorn = false;
		hasJumpOption_Santank = false;
		hasJumpOption_WallOfFleshGoat = false;
		hasJumpOption_Basilisk = false;
		defendedByPaladin = false;
		hasPaladinShield = false;
		hasLucyTheAxe = false;
		preventAllItemPickups = false;
		dontHurtCritters = false;
		dontHurtNature = false;
		portableStoolInfo.Reset();
		ResizeHitbox();
		autoJump = false;
		justJumped = false;
		jumpSpeedBoost = 0f;
		extraFall = 0;
		creativeGodMode = false;
		if (phantasmTime > 0)
		{
			phantasmTime--;
		}
		if (brainOfConfusionDodgeAnimationCounter > 0)
		{
			brainOfConfusionDodgeAnimationCounter--;
		}
		if (wireOperationsCooldown > 0)
		{
			wireOperationsCooldown--;
		}
		if (releaseUseItem)
		{
			ActuationRodLock = false;
		}
		for (int i = 0; i < npcTypeNoAggro.Length; i++)
		{
			npcTypeNoAggro[i] = false;
		}
		ResetProjectileCaches();
		if (whoAmI == Main.myPlayer && !isDisplayDollOrInanimate)
		{
			equipmentBasedLuckBonus = 0f;
			luckPotion = 0;
			tileRangeX = 5;
			tileRangeY = 4;
			if (Main.IsJourneyMode)
			{
				CreativePowers.FarPlacementRangePower power = CreativePowerManager.Instance.GetPower<CreativePowers.FarPlacementRangePower>();
				if (power.GetIsUnlocked() && power.IsEnabledForPlayer(whoAmI))
				{
					tileRangeX *= 2;
					tileRangeY *= 2;
					tileRangeX += 8;
					tileRangeY += 8;
				}
			}
		}
		MinecartSettings = Minecart.Customization.Default;
		if (!isDisplayDollOrInanimate)
		{
			mount.CheckMountBuff(this);
		}
	}

	private void UpdateLadyBugLuckTime()
	{
		if (ladyBugLuckTimeLeft > 0)
		{
			ladyBugLuckTimeLeft -= Main.dayRate;
			if (ladyBugLuckTimeLeft < 0)
			{
				ladyBugLuckTimeLeft = 0;
			}
		}
		else if (ladyBugLuckTimeLeft < 0)
		{
			ladyBugLuckTimeLeft += Main.dayRate;
			if (ladyBugLuckTimeLeft > 0)
			{
				ladyBugLuckTimeLeft = 0;
			}
		}
	}

	public void UpdateImmunity()
	{
		if (immune)
		{
			immuneTime--;
			if (immuneTime <= 0)
			{
				immune = false;
				immuneNoBlink = false;
			}
			if (immuneNoBlink)
			{
				immuneAlpha = 0;
			}
			else
			{
				immuneAlpha += immuneAlphaDirection * 50;
				if (immuneAlpha <= 50)
				{
					immuneAlphaDirection = 1;
				}
				else if (immuneAlpha >= 205)
				{
					immuneAlphaDirection = -1;
				}
			}
		}
		else
		{
			immuneAlpha = 0;
		}
		for (int i = 0; i < hurtCooldowns.Length; i++)
		{
			if (hurtCooldowns[i] > 0)
			{
				hurtCooldowns[i]--;
			}
		}
	}

	private void TryToPoop()
	{
		if (whoAmI != Main.myPlayer || !wellFed)
		{
			return;
		}
		int num = 600;
		if (tipsy)
		{
			num /= 3;
		}
		if (Main.rand.Next(num) != 0)
		{
			return;
		}
		int num2 = 3;
		int num3 = FindBuffIndex(207);
		if (num3 == -1)
		{
			num2 = 2;
			num3 = FindBuffIndex(206);
		}
		if (num3 == -1)
		{
			num2 = 1;
			num3 = FindBuffIndex(26);
		}
		if (num3 != -1)
		{
			int num4 = buffTime[num3];
			DelBuff(num3);
			int num5 = Utils.Clamp(num4 / 3600 * num2, num2, 999);
			if (RollOnlyBadLuckExtreme(10) == 0)
			{
				num5 = (int)((double)num5 * 1.2);
			}
			Vector2 mountedCenter = MountedCenter;
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.Digestion, new ParticleOrchestraSettings
			{
				PositionInWorld = mountedCenter,
				MovementVector = new Vector2(-direction, 0f)
			}, whoAmI);
			int num6 = Item.NewItem(GetItemSource_Misc(ItemSourceID.Digesting), mountedCenter, Vector2.Zero, 5395, num5, noBroadcast: false, 0, noGrabDelay: true);
			if (Main.netMode == 0)
			{
				Main.item[num6].noGrabDelay = 100;
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendData(21, -1, -1, null, num6);
			}
		}
	}

	public void UpdateLifeRegen()
	{
		bool flag = false;
		if (shinyStone && IsConsideredStandingStill && itemAnimation == 0)
		{
			flag = true;
		}
		if (poisoned)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 4;
		}
		if (venom)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 30;
		}
		if (onFire)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			if (Main.vampireSeed)
			{
				lifeRegen -= 100;
				if (drippingSlime)
				{
					lifeRegen -= 100;
				}
			}
			else
			{
				lifeRegen -= 8;
				if (drippingSlime)
				{
					lifeRegen -= 8;
				}
			}
		}
		if (onFire3)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 8;
			if (drippingSlime)
			{
				lifeRegen -= 8;
			}
		}
		if (onFrostBurn)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 16;
			if (drippingSlime)
			{
				lifeRegen -= 16;
			}
		}
		if (onFrostBurn2)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 16;
			if (drippingSlime)
			{
				lifeRegen -= 16;
			}
		}
		if (onFire2)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 24;
			if (drippingSlime)
			{
				lifeRegen -= 24;
			}
		}
		if (burned)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 60;
			if (drippingSlime)
			{
				lifeRegen -= 60;
			}
			moveSpeed *= 0.5f;
		}
		if (suffocating)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 40;
		}
		if (electrified)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 8;
			if (controlLeft || controlRight)
			{
				lifeRegen -= 32;
			}
		}
		if (tongued && Main.expertMode)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			lifeRegenTime = 0f;
			lifeRegen -= 100;
		}
		if (honey && lifeRegen < 0)
		{
			lifeRegen += 4;
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
		}
		if (lifeRegen < 0 && nebulaLevelLife > 0)
		{
			lifeRegen = 0;
		}
		if (flag && lifeRegen < 0)
		{
			lifeRegen /= 2;
		}
		lifeRegenTime += 1f;
		if (usedAegisCrystal)
		{
			lifeRegenTime += 0.2f;
		}
		if (crimsonRegen)
		{
			lifeRegenTime += 1f;
		}
		if (soulDrain > 0)
		{
			lifeRegenTime += 2f;
		}
		if (flag)
		{
			if (lifeRegenTime > 90f && lifeRegenTime < 1800f)
			{
				lifeRegenTime = 1800f;
			}
			lifeRegenTime += 4f;
			lifeRegen += 4;
		}
		if (honey)
		{
			lifeRegenTime += 2f;
			lifeRegen += 2;
		}
		if (starving)
		{
			if (lifeRegen > 0)
			{
				lifeRegen = 0;
			}
			if (lifeRegenCount > 0)
			{
				lifeRegenCount = 0;
			}
			if (lifeRegenTime > 0f)
			{
				lifeRegenTime = 0f;
			}
			int num = 3000;
			int num2 = 120 * statLifeMax2 / num;
			if (num2 < 4)
			{
				num2 = 4;
			}
			lifeRegen = -num2;
		}
		if (soulDrain > 0)
		{
			int num3 = (5 + soulDrain) / 2;
			lifeRegenTime += num3;
			lifeRegen += num3;
		}
		if (heartyMeal)
		{
			int num4 = 3 * 120 / 60;
			lifeRegen += num4;
		}
		if (whoAmI == Main.myPlayer && SceneMetrics.HasCampfire)
		{
			lifeRegen++;
		}
		if (whoAmI == Main.myPlayer && SceneMetrics.HasHeartLantern)
		{
			lifeRegen += 2;
		}
		if (bleed)
		{
			lifeRegenTime = 0f;
		}
		float num5 = 0f;
		if (lifeRegenTime >= 300f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 600f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 900f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 1200f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 1500f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 1800f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 2400f)
		{
			num5 += 1f;
		}
		if (lifeRegenTime >= 3000f)
		{
			num5 += 1f;
		}
		if (flag)
		{
			float num6 = lifeRegenTime - 3000f;
			num6 /= 300f;
			if (num6 > 0f)
			{
				if (num6 > 30f)
				{
					num6 = 30f;
				}
				num5 += num6;
			}
		}
		else if (lifeRegenTime >= 3600f)
		{
			num5 += 1f;
			lifeRegenTime = 3600f;
		}
		if (sitting.isSitting || sleeping.isSleeping)
		{
			lifeRegenTime += 3f;
			num5 *= 1.3f;
		}
		if (sitting.isSitting && sitting.details.IsAToilet)
		{
			TryToPoop();
		}
		num5 = ((velocity.X != 0f && grappling[0] < 0) ? (num5 * 0.5f) : (num5 * 1.25f));
		if (crimsonRegen)
		{
			num5 *= 1.5f;
		}
		if (shinyStone)
		{
			num5 *= 1.1f;
		}
		if (whoAmI == Main.myPlayer && SceneMetrics.HasCampfire)
		{
			num5 *= 1.1f;
		}
		if (Main.expertMode && !wellFed)
		{
			num5 = ((!shinyStone) ? (num5 / 2f) : (num5 * 0.75f));
		}
		if (rabid)
		{
			num5 = ((!shinyStone) ? (num5 / 2f) : (num5 * 0.75f));
		}
		float num7 = (float)statLifeMax2 / 400f * 0.85f + 0.15f;
		num5 *= num7;
		lifeRegen += (int)Math.Round(num5);
		lifeRegenCount += lifeRegen;
		if (palladiumRegen)
		{
			lifeRegenCount += 4;
		}
		if (flag && lifeRegen > 0 && statLife < statLifeMax2)
		{
			lifeRegenCount++;
			if (flag && ((float)Main.rand.Next(30000) < lifeRegenTime || Main.rand.Next(30) == 0))
			{
				int num8 = Dust.NewDust(position, width, height, 55, 0f, 0f, 200, default(Color), 0.5f);
				Main.dust[num8].noGravity = true;
				Main.dust[num8].velocity *= 0.75f;
				Main.dust[num8].fadeIn = 1.3f;
				Vector2 vector = new Vector2(Main.rand.Next(-100, 101), Main.rand.Next(-100, 101));
				vector.Normalize();
				vector *= (float)Main.rand.Next(50, 100) * 0.04f;
				Main.dust[num8].velocity = vector;
				vector.Normalize();
				vector *= 34f;
				Main.dust[num8].position = base.Center - vector;
			}
		}
		while (lifeRegenCount >= 120)
		{
			lifeRegenCount -= 120;
			if (statLife < statLifeMax2)
			{
				statLife++;
				if (crimsonRegen)
				{
					for (int i = 0; i < 10; i++)
					{
						int num9 = Dust.NewDust(position, width, height, 5, 0f, 0f, 175, default(Color), 1.75f);
						Main.dust[num9].noGravity = true;
						Main.dust[num9].velocity *= 0.75f;
						int num10 = Main.rand.Next(-40, 41);
						int num11 = Main.rand.Next(-40, 41);
						Main.dust[num9].position.X += num10;
						Main.dust[num9].position.Y += num11;
						Main.dust[num9].velocity.X = (float)(-num10) * 0.075f;
						Main.dust[num9].velocity.Y = (float)(-num11) * 0.075f;
					}
				}
			}
			if (statLife > statLifeMax2)
			{
				statLife = statLifeMax2;
			}
		}
		if (burned || suffocating || (tongued && Main.expertMode))
		{
			while (lifeRegenCount <= -600)
			{
				lifeRegenCount += 600;
				HurtLifeRegen(5);
				if (statLife <= 0 && whoAmI == Main.myPlayer)
				{
					if (suffocating)
					{
						KillMe(PlayerDeathReason.ByOther(7), 10.0, 0);
					}
					else if (tongued)
					{
						KillMe(PlayerDeathReason.ByOther(12), 10.0, 0);
					}
					else
					{
						KillMe(PlayerDeathReason.ByOther(8), 10.0, 0);
					}
				}
			}
			return;
		}
		if (starving)
		{
			int num12 = statLifeMax2 / 50;
			if (num12 < 2)
			{
				num12 = 2;
			}
			int dmg = ((ZoneDesert || ZoneSnow) ? (num12 * 2) : num12);
			int num13 = 120 * num12;
			while (lifeRegenCount <= -num13)
			{
				lifeRegenCount += num13;
				HurtLifeRegen(dmg);
				if (statLife <= 0 && whoAmI == Main.myPlayer)
				{
					KillMe(PlayerDeathReason.ByOther(18), 10.0, 0);
				}
			}
			return;
		}
		while (lifeRegenCount <= -120)
		{
			int num14 = Math.Min(lifeRegenCount / -120, 4);
			lifeRegenCount += 120 * num14;
			HurtLifeRegen(num14);
			if (statLife <= 0 && whoAmI == Main.myPlayer)
			{
				if (vampireBurningInSunlight)
				{
					KillMe(PlayerDeathReason.ByOther(22), 10.0, 0);
				}
				else if (poisoned || venom)
				{
					KillMe(PlayerDeathReason.ByOther(9), 10.0, 0);
				}
				else if (electrified)
				{
					KillMe(PlayerDeathReason.ByOther(10), 10.0, 0);
				}
				else
				{
					KillMe(PlayerDeathReason.ByOther(8), 10.0, 0);
				}
			}
		}
	}

	private void HurtLifeRegen(int dmg)
	{
		statLife -= dmg;
		CombatText.NewText(new Rectangle((int)position.X, (int)position.Y, width, height), CombatText.LifeRegen, dmg, dramatic: false, dot: true);
		SetOrRequestSpectating(-1);
	}

	public void UpdateManaRegen()
	{
		if (nebulaLevelMana > 0)
		{
			int num = 6;
			nebulaManaCounter += nebulaLevelMana;
			if (nebulaManaCounter >= num)
			{
				nebulaManaCounter -= num;
				statMana++;
				if (statMana >= statManaMax2)
				{
					statMana = statManaMax2;
				}
			}
		}
		else
		{
			nebulaManaCounter = 0;
		}
		if (manaRegenDelay > 0f)
		{
			manaRegenDelay -= 1f;
			manaRegenDelay -= manaRegenDelayBonus;
			if (IsConsideredStandingStill || grappling[0] >= 0 || manaRegenBuff)
			{
				manaRegenDelay -= 1f;
			}
			if (usedArcaneCrystal)
			{
				manaRegenDelay -= 0.05f;
			}
		}
		if (manaRegenBuff && manaRegenDelay > 20f)
		{
			manaRegenDelay = 20f;
		}
		if (manaRegenDelay <= 0f)
		{
			manaRegenDelay = 0f;
			manaRegen = statManaMax2 / 3 + 1 + manaRegenBonus;
			if (IsConsideredStandingStill || grappling[0] >= 0 || manaRegenBuff)
			{
				manaRegen += statManaMax2 / 3;
			}
			if (usedArcaneCrystal)
			{
				manaRegen += statManaMax2 / 50;
			}
			float num2 = (float)statMana / (float)statManaMax2 * 0.8f + 0.2f;
			if (manaRegenBuff)
			{
				num2 = 1f;
			}
			manaRegen = (int)((double)((float)manaRegen * num2) * 1.15);
		}
		else
		{
			manaRegen = 0;
		}
		manaRegenCount += manaRegen;
		while (manaRegenCount >= 120)
		{
			bool flag = false;
			manaRegenCount -= 120;
			if (statMana < statManaMax2)
			{
				statMana++;
				flag = true;
			}
			if (statMana < statManaMax2)
			{
				continue;
			}
			if (whoAmI == Main.myPlayer && flag)
			{
				SoundEngine.PlaySound(25);
				for (int i = 0; i < 5; i++)
				{
					int num3 = Dust.NewDust(position, width, height, 45, 0f, 0f, 255, default(Color), (float)Main.rand.Next(20, 26) * 0.1f);
					Main.dust[num3].noLight = true;
					Main.dust[num3].noGravity = true;
					Main.dust[num3].velocity *= 0.5f;
				}
			}
			statMana = statManaMax2;
		}
	}

	public void UpdateJumpHeight()
	{
		if (mount.Active)
		{
			jumpHeight = mount.JumpHeight(velocity.X);
			jumpSpeed = mount.JumpSpeed(velocity.X);
		}
		else
		{
			if (jumpBoost)
			{
				jumpHeight = Math.Max(jumpHeight, 20);
				jumpSpeed = Math.Max(jumpSpeed, 6.51f);
			}
			if (empressBrooch)
			{
				jumpSpeedBoost += 1.8f;
			}
			if (frogLegJumpBoost)
			{
				jumpSpeedBoost += 2.4f;
				extraFall += 15;
			}
			if (moonLordLegs)
			{
				jumpSpeedBoost += 1.8f;
				extraFall += 10;
				jumpHeight++;
			}
			if (wereWolf)
			{
				jumpHeight += 2;
				jumpSpeed += 0.2f;
			}
			if (portableStoolInfo.IsInUse)
			{
				jumpHeight += 5;
			}
			jumpSpeed += jumpSpeedBoost;
		}
		if (sticky)
		{
			jumpHeight /= 10;
			jumpSpeed /= 5f;
		}
		if (dazed)
		{
			jumpHeight /= 5;
			jumpSpeed /= 2f;
		}
	}

	public void FindPulley()
	{
		if (portableStoolInfo.IsInUse || (!controlUp && !controlDown))
		{
			return;
		}
		int num = (int)(position.X + (float)(width / 2)) / 16;
		int num2 = (int)(position.Y - 8f) / 16;
		if (!WorldGen.IsRope(num, num2))
		{
			return;
		}
		float num3 = position.Y;
		if (Main.tile[num, num2 - 1] == null)
		{
			Main.tile[num, num2 - 1] = new Tile();
		}
		if (Main.tile[num, num2 + 1] == null)
		{
			Main.tile[num, num2 + 1] = new Tile();
		}
		if ((!Main.tile[num, num2 - 1].active() || !Main.tileRope[Main.tile[num, num2 - 1].type]) && (!Main.tile[num, num2 + 1].active() || !Main.tileRope[Main.tile[num, num2 + 1].type]))
		{
			num3 = num2 * 16 + 22;
		}
		float num4 = num * 16 + 8 - width / 2 + 6 * direction;
		int num5 = num * 16 + 8 - width / 2 + 6;
		int num6 = num * 16 + 8 - width / 2;
		int num7 = num * 16 + 8 - width / 2 + -6;
		int num8 = 1;
		float num9 = Math.Abs(position.X - (float)num5);
		if (Math.Abs(position.X - (float)num6) < num9)
		{
			num8 = 2;
			num9 = Math.Abs(position.X - (float)num6);
		}
		if (Math.Abs(position.X - (float)num7) < num9)
		{
			num8 = 3;
			num9 = Math.Abs(position.X - (float)num7);
		}
		if (num8 == 1)
		{
			num4 = num5;
			pulleyDir = 2;
			direction = 1;
		}
		if (num8 == 2)
		{
			num4 = num6;
			pulleyDir = 1;
		}
		if (num8 == 3)
		{
			num4 = num7;
			pulleyDir = 2;
			direction = -1;
		}
		if (!Collision.SolidCollision(new Vector2(num4, position.Y), width, height))
		{
			if (whoAmI == Main.myPlayer)
			{
				Main.cameraX = Main.cameraX + position.X - num4;
			}
			pulley = true;
			position.X = num4;
			gfxOffY = position.Y - num3;
			stepSpeed = 2.5f;
			position.Y = num3;
			velocity.X = 0f;
			return;
		}
		num4 = num5;
		pulleyDir = 2;
		direction = 1;
		if (!Collision.SolidCollision(new Vector2(num4, position.Y), width, height))
		{
			if (whoAmI == Main.myPlayer)
			{
				Main.cameraX = Main.cameraX + position.X - num4;
			}
			pulley = true;
			position.X = num4;
			gfxOffY = position.Y - num3;
			stepSpeed = 2.5f;
			position.Y = num3;
			velocity.X = 0f;
			return;
		}
		num4 = num7;
		pulleyDir = 2;
		direction = -1;
		if (!Collision.SolidCollision(new Vector2(num4, position.Y), width, height))
		{
			if (whoAmI == Main.myPlayer)
			{
				Main.cameraX = Main.cameraX + position.X - num4;
			}
			pulley = true;
			position.X = num4;
			gfxOffY = position.Y - num3;
			stepSpeed = 2.5f;
			position.Y = num3;
			velocity.X = 0f;
		}
	}

	public bool CanBePushedByWind()
	{
		bool flag = controlLeft || controlRight;
		if (isLockedToATile)
		{
			return false;
		}
		if (mount.Active)
		{
			if (mount.Type >= 0 && MountID.Sets.IsRollerSkates[mount.Type])
			{
				return false;
			}
			if (velocity.Y == 0f && flag)
			{
				return false;
			}
		}
		return true;
	}

	public void HorizontalMovement()
	{
		if (chilled)
		{
			accRunSpeed = maxRunSpeed;
		}
		bool flag = controlLeft || controlRight;
		float num = (accRunSpeed + maxRunSpeed) / 2f;
		float num2 = 0f;
		bool flag2 = false;
		if (flag && mount.Active && mount.Type == 43 && velocity.Y == 0f && !controlJump)
		{
			SoundEngine.PlaySound(SoundID.Item168, base.Center);
			float num3 = jumpSpeed * gravDir * 0.5f;
			if (num3 < 2f)
			{
				num3 = 2f;
			}
			num3 += 0.01f;
			velocity.Y = 0f - num3;
			jump = jumpHeight;
			fullRotation = 0f;
			return;
		}
		if (windPushed && CanBePushedByWind())
		{
			num2 = (float)Math.Sign(Main.windSpeedCurrent) * 0.06f;
			if (Math.Abs(Main.windSpeedCurrent) > 0.5f)
			{
				num2 *= 1.37f;
			}
			if (velocity.Y != 0f)
			{
				num2 *= 1.5f;
			}
			if (flag)
			{
				num2 *= 0.8f;
				float num4 = 0.072f;
				num2 = MathHelper.Clamp(num2, 0f - num4, num4);
			}
			flag2 = true;
			if (Math.Sign(direction) != Math.Sign(num2))
			{
				num -= Math.Abs(num2) * 40f;
			}
		}
		if (trackBoost != 0f)
		{
			velocity.X += trackBoost;
			trackBoost = 0f;
			if (velocity.X < 0f)
			{
				if (velocity.X < 0f - maxRunSpeed)
				{
					velocity.X = 0f - maxRunSpeed;
				}
			}
			else if (velocity.X > maxRunSpeed)
			{
				velocity.X = maxRunSpeed;
			}
		}
		int num5 = controlRight.ToInt() - controlLeft.ToInt();
		if (num5 != 0)
		{
			bool flag3 = (itemAnimation == 0 || inventory[selectedItem].useTurn) && mount.AllowDirectionChange && !sandStorm;
			if (mount.Active && mount.Cart)
			{
				flag3 &= Math.Sign(velocity.X) == num5;
			}
			if (flag3)
			{
				ChangeDir(num5);
			}
		}
		if (controlLeft && velocity.X > 0f - maxRunSpeed && dashDelay >= 0)
		{
			if (!mount.Active || !mount.Cart || velocity.Y == 0f)
			{
				if (velocity.X > runSlowdown)
				{
					velocity.X -= runSlowdown;
				}
				velocity.X -= runAcceleration;
			}
			if (onWrongGround)
			{
				if (velocity.X < 0f - runSlowdown)
				{
					velocity.X += runSlowdown;
				}
				else
				{
					velocity.X = 0f;
				}
			}
			if (mount.Active && mount.AnyTrackRider && !onWrongGround && onTrack && itemAnimation == 0 && velocity.Y == 0f && velocity.X >= 0f)
			{
				SoundEngine.PlaySound(SoundID.Item55, (int)position.X + width / 2, (int)position.Y + height / 2);
				DelegateMethods.Minecart.rotation = fullRotation;
				DelegateMethods.Minecart.rotationOrigin = fullRotationOrigin;
				if ((double)Math.Abs(velocity.X) > (double)maxRunSpeed * 0.66)
				{
					if (Main.rand.Next(2) == 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position + velocity * 0.66f, width, height, 1, MinecartSettings);
					}
					if (Main.rand.Next(2) == 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position + velocity * 0.33f, width, height, 1, MinecartSettings);
					}
					if (Main.rand.Next(2) == 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 1, MinecartSettings);
					}
				}
				else if ((double)Math.Abs(velocity.X) > (double)maxRunSpeed * 0.33)
				{
					if (Main.rand.Next(3) != 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position + velocity * 0.5f, width, height, 1, MinecartSettings);
					}
					if (Main.rand.Next(3) != 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 1, MinecartSettings);
					}
				}
				else
				{
					Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 1, MinecartSettings);
				}
			}
		}
		else if (controlRight && velocity.X < maxRunSpeed && dashDelay >= 0)
		{
			if (!mount.Active || !mount.Cart || velocity.Y == 0f)
			{
				if (velocity.X < 0f - runSlowdown)
				{
					velocity.X += runSlowdown;
				}
				velocity.X += runAcceleration;
			}
			if (onWrongGround)
			{
				if (velocity.X > runSlowdown)
				{
					velocity.X -= runSlowdown;
				}
				else
				{
					velocity.X = 0f;
				}
			}
			if (mount.Active && mount.AnyTrackRider && !onWrongGround && onTrack && itemAnimation == 0 && velocity.Y == 0f && velocity.X <= 0f)
			{
				SoundEngine.PlaySound(SoundID.Item55, (int)position.X + width / 2, (int)position.Y + height / 2);
				DelegateMethods.Minecart.rotation = fullRotation;
				DelegateMethods.Minecart.rotationOrigin = fullRotationOrigin;
				if ((double)Math.Abs(velocity.X) > (double)maxRunSpeed * 0.66)
				{
					if (Main.rand.Next(2) == 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position + velocity * 0.66f, width, height, 1, MinecartSettings);
					}
					if (Main.rand.Next(2) == 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position + velocity * 0.33f, width, height, 1, MinecartSettings);
					}
					if (Main.rand.Next(2) == 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 1, MinecartSettings);
					}
				}
				else if ((double)Math.Abs(velocity.X) > (double)maxRunSpeed * 0.33)
				{
					if (Main.rand.Next(3) != 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position + velocity * 0.5f, width, height, 1, MinecartSettings);
					}
					if (Main.rand.Next(3) != 0)
					{
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 1, MinecartSettings);
					}
				}
				else
				{
					Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 1, MinecartSettings);
				}
			}
		}
		else if (controlLeft && velocity.X > 0f - accRunSpeed && dashDelay >= 0 && !slow && !burned)
		{
			if (velocity.Y == 0f || wingsLogic > 0 || mount.CanFly(this))
			{
				if (velocity.X > runSlowdown)
				{
					velocity.X -= runSlowdown;
				}
				velocity.X -= runAcceleration * 0.2f;
				if (wingsLogic > 0)
				{
					velocity.X -= runAcceleration * 0.2f;
				}
			}
			if (onWrongGround)
			{
				if (velocity.X < runSlowdown)
				{
					velocity.X += runSlowdown;
				}
				else
				{
					velocity.X = 0f;
				}
			}
			if (velocity.X < 0f - num && velocity.Y == 0f && !mount.Active)
			{
				SpawnFastRunParticles();
			}
		}
		else if (controlRight && velocity.X < accRunSpeed && dashDelay >= 0 && !slow && !burned)
		{
			if (velocity.Y == 0f || wingsLogic > 0 || mount.CanFly(this))
			{
				if (velocity.X < 0f - runSlowdown)
				{
					velocity.X += runSlowdown;
				}
				velocity.X += runAcceleration * 0.2f;
				if (wingsLogic > 0)
				{
					velocity.X += runAcceleration * 0.2f;
				}
			}
			if (onWrongGround)
			{
				if (velocity.X > runSlowdown)
				{
					velocity.X -= runSlowdown;
				}
				else
				{
					velocity.X = 0f;
				}
			}
			if (velocity.X > num && velocity.Y == 0f && !mount.Active)
			{
				SpawnFastRunParticles();
			}
		}
		else if (mount.Active && mount.Cart && Math.Abs(velocity.X) >= 1f)
		{
			if (onWrongGround)
			{
				if (velocity.X > 0f)
				{
					if (velocity.X > runSlowdown)
					{
						velocity.X -= runSlowdown;
					}
					else
					{
						velocity.X = 0f;
					}
				}
				else if (velocity.X < 0f)
				{
					if (velocity.X < 0f - runSlowdown)
					{
						velocity.X += runSlowdown;
					}
					else
					{
						velocity.X = 0f;
					}
				}
			}
			if (velocity.X > maxRunSpeed)
			{
				velocity.X = maxRunSpeed;
			}
			if (velocity.X < 0f - maxRunSpeed)
			{
				velocity.X = 0f - maxRunSpeed;
			}
		}
		else if (velocity.Y == 0f)
		{
			if (velocity.X > runSlowdown)
			{
				velocity.X -= runSlowdown;
			}
			else if (velocity.X < 0f - runSlowdown)
			{
				velocity.X += runSlowdown;
			}
			else
			{
				velocity.X = 0f;
			}
		}
		else if (!PortalPhysicsEnabled)
		{
			if ((double)velocity.X > (double)runSlowdown * 0.5)
			{
				velocity.X -= runSlowdown * 0.5f;
			}
			else if ((double)velocity.X < (double)(0f - runSlowdown) * 0.5)
			{
				velocity.X += runSlowdown * 0.5f;
			}
			else
			{
				velocity.X = 0f;
			}
		}
		if (flag2)
		{
			if (num2 < 0f && velocity.X > num2)
			{
				velocity.X += num2;
				if (velocity.X < num2)
				{
					velocity.X = num2;
				}
			}
			if (num2 > 0f && velocity.X < num2)
			{
				velocity.X += num2;
				if (velocity.X > num2)
				{
					velocity.X = num2;
				}
			}
		}
		bool flag4 = mount.Type == 40 || mount.Type == 41 || mount.Type == 42;
		if (mount.Active && (mount.Type == 10 || mount.Type == 47 || flag4) && Math.Abs(velocity.X) > mount.DashSpeed - mount.RunSpeed / 2f)
		{
			Rectangle rect = getRect();
			if (direction == 1)
			{
				rect.Offset(width - 1, 0);
			}
			rect.Width = 2;
			rect.Inflate(6, 12);
			int num6 = 60;
			if (flag4)
			{
				num6 = 30;
			}
			float damage = (float)num6 * minionDamage;
			float knockback = 10f;
			if (flag4)
			{
				knockback = 7f;
			}
			int nPCImmuneTime = 30;
			int playerImmuneTime = 6;
			CollideWithNPCs(rect, damage, knockback, nPCImmuneTime, playerImmuneTime);
		}
		if (mount.Active && mount.Type == 44 && Math.Abs(velocity.X) > mount.DashSpeed - mount.RunSpeed / 4f)
		{
			Rectangle rect2 = getRect();
			if (direction == 1)
			{
				rect2.Offset(width - 1, 0);
			}
			rect2.Width = 2;
			rect2.Inflate(6, 12);
			float damage2 = 100f * minionDamage;
			float knockback2 = 12f;
			int nPCImmuneTime2 = 30;
			int playerImmuneTime2 = 6;
			CollideWithNPCs(rect2, damage2, knockback2, nPCImmuneTime2, playerImmuneTime2);
		}
		if (mount.Active && mount.Type == 45 && Math.Abs(velocity.X) > mount.DashSpeed * 0.9f)
		{
			Rectangle rect3 = getRect();
			if (direction == 1)
			{
				rect3.Offset(width - 1, 0);
			}
			rect3.Width = 2;
			rect3.Inflate(6, 12);
			float damage3 = 120f * minionDamage;
			float knockback3 = 12f;
			int nPCImmuneTime3 = 30;
			int playerImmuneTime3 = 6;
			CollideWithNPCs(rect3, damage3, knockback3, nPCImmuneTime3, playerImmuneTime3);
		}
		if (mount.Active && mount.Type == 14 && Math.Abs(velocity.X) > mount.RunSpeed / 2f)
		{
			Rectangle rect4 = getRect();
			if (direction == 1)
			{
				rect4.Offset(width - 1, 0);
			}
			rect4.Width = 2;
			rect4.Inflate(6, 12);
			float damage4 = 90f * minionDamage;
			float knockback4 = 10f;
			int nPCImmuneTime4 = 30;
			int playerImmuneTime4 = 6;
			CollideWithNPCs(rect4, damage4, knockback4, nPCImmuneTime4, playerImmuneTime4);
		}
		if (mount.Active && mount.Type == 17 && Math.Abs(velocity.X) > mount.RunSpeed / 2f)
		{
			Rectangle rect5 = getRect();
			if (direction == 1)
			{
				rect5.Offset(width - 1, 0);
			}
			rect5.Width = 2;
			rect5.Inflate(6, 12);
			float damage5 = 40f * minionDamage;
			float knockback5 = 10f;
			int nPCImmuneTime5 = 30;
			int playerImmuneTime5 = 12;
			CollideWithNPCs(rect5, damage5, knockback5, nPCImmuneTime5, playerImmuneTime5);
		}
		TryUsingDiggerCart();
		if (HeldItem.type == 4049 && whoAmI == Main.myPlayer)
		{
			MowTheLawn();
		}
	}

	private void TryUsingDiggerCart()
	{
		if (whoAmI == Main.myPlayer && mount.Active && mount.Type == 39 && velocity.Y == 0f)
		{
			int num = 12;
			int num2 = 20;
			Vector2 vector = new Vector2(0f, gravDir * 10f);
			Vector2 trackWorldPosition = RotatedRelativePoint(base.Center + new Vector2(num * direction, gravDir * (float)num2));
			trackWorldPosition += vector;
			Tile tileSafely = Framing.GetTileSafely(trackWorldPosition);
			if (!tileSafely.active() || tileSafely.type != 314)
			{
				trackWorldPosition = RotatedRelativePoint(base.Center + new Vector2((float)(num * direction) * 0.5f, gravDir * (float)num2));
				trackWorldPosition += vector;
			}
			int digDirectionY = controlDown.ToInt() - controlUp.ToInt();
			if (controlUp.ToInt() + controlDown.ToInt() + controlLeft.ToInt() + controlRight.ToInt() > 0)
			{
				MinecartDiggerHelper.Instance.TryDigging(this, trackWorldPosition, direction, digDirectionY);
			}
		}
	}

	private void SpawnFastRunParticles()
	{
		int num = 0;
		if (gravDir == -1f)
		{
			num -= height;
		}
		if (runSoundDelay == 0 && velocity.Y == 0f)
		{
			SoundEngine.PlaySound(hermesStepSound.SoundType, (int)position.X, (int)position.Y, hermesStepSound.SoundStyle);
			runSoundDelay = hermesStepSound.IntendedCooldown;
		}
		if (wings == 3 || vanityRocketBoots == 6)
		{
			int num2 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)height + (float)num), width + 8, 4, 186, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 50, default(Color), 1.5f);
			Main.dust[num2].velocity *= 0.025f;
			Main.dust[num2].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			num2 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)height + (float)num), width + 8, 4, 186, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 50, default(Color), 1.5f);
			Main.dust[num2].velocity *= 0.2f;
			Main.dust[num2].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		else if (sailDash)
		{
			for (int i = 0; i < 4; i++)
			{
				int num3 = Dust.NewDust(new Vector2(position.X - 4f, position.Y), width + 8, height, 253, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 100, default(Color), 1.5f);
				Main.dust[num3].noGravity = true;
				Main.dust[num3].velocity.X = Main.dust[num3].velocity.X * 0.2f;
				Main.dust[num3].velocity.Y = Main.dust[num3].velocity.Y * 0.2f;
				Main.dust[num3].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
				Main.dust[num3].scale += (float)Main.rand.Next(-5, 3) * 0.1f;
				Vector2 vector = new Vector2(Main.rand.Next(-100, 101), Main.rand.Next(-100, 101));
				vector.Normalize();
				vector *= (float)Main.rand.Next(81) * 0.1f;
			}
		}
		else if (desertDash)
		{
			Dust dust = Dust.NewDustDirect(new Vector2(position.X - 4f, position.Y + (float)height + (float)num), width + 8, 4, 32, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f);
			dust.velocity *= 0.2f;
			dust.velocity.Y -= gravDir * 2f;
			dust.shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
		}
		else if (coldDash)
		{
			for (int j = 0; j < 2; j++)
			{
				int num4 = ((j != 0) ? Dust.NewDust(new Vector2(position.X + (float)(width / 2), position.Y + (float)height + gfxOffY), width / 2, 6, 76, 0f, 0f, 0, default(Color), 1.35f) : Dust.NewDust(new Vector2(position.X, position.Y + (float)height + gfxOffY), width / 2, 6, 76, 0f, 0f, 0, default(Color), 1.35f));
				Main.dust[num4].scale *= 1f + (float)Main.rand.Next(20, 40) * 0.01f;
				Main.dust[num4].noGravity = true;
				Main.dust[num4].noLight = true;
				Main.dust[num4].velocity *= 0.001f;
				Main.dust[num4].velocity.Y -= 0.003f;
				Main.dust[num4].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
			}
		}
		else if (fairyBoots)
		{
			int type = Main.rand.NextFromList(new short[6] { 61, 61, 61, 242, 64, 63 });
			int alpha = 0;
			for (int k = 1; k < 3; k++)
			{
				float scale = 1.5f;
				if (k == 2)
				{
					scale = 1f;
				}
				int num5 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)height + (float)num), width + 8, 4, type, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, alpha, default(Color), scale);
				Main.dust[num5].velocity *= 1.5f;
				if (k == 2)
				{
					Main.dust[num5].position += Main.dust[num5].velocity;
				}
				Main.dust[num5].noGravity = true;
				Main.dust[num5].noLightEmittence = true;
				Main.dust[num5].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
			}
		}
		else if (hellfireTreads)
		{
			int num6 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)height + (float)num), width + 8, 4, 6, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 50, default(Color), 2f);
			Main.dust[num6].velocity.X = Main.dust[num6].velocity.X * 0.2f;
			Main.dust[num6].velocity.Y = -1.5f - Main.rand.NextFloat() * 0.5f;
			Main.dust[num6].fadeIn = 0.5f;
			Main.dust[num6].noGravity = true;
			Main.dust[num6].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
		}
		else
		{
			int num7 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)height + (float)num), width + 8, 4, 16, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 50, default(Color), 1.5f);
			Main.dust[num7].velocity.X = Main.dust[num7].velocity.X * 0.2f;
			Main.dust[num7].velocity.Y = Main.dust[num7].velocity.Y * 0.2f;
			Main.dust[num7].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
		}
	}

	private void MowTheLawn()
	{
		if (miscCounter % 2 != 0 || velocity.Y != 0f || grappling[0] != -1 || itemAnimation < 1)
		{
			return;
		}
		Vector2 vector = MountedCenter + new Vector2(direction * 38, (BaseHeight / 2f + 4f) * gravDir);
		if (mount.Active)
		{
			if (mount.Type >= 0 && MountID.Sets.DontHoldItems[mount.Type])
			{
				return;
			}
			if (mount.Type == 54)
			{
				vector += new Vector2(4f, 0f) * Directions;
			}
		}
		float num = 1f - (float)itemAnimation / (float)itemAnimationMax;
		num *= 2f;
		num = ((!(num < 1f)) ? (num - 1f) : (1f - num));
		Vector2 value = vector + new Vector2(direction * -16, gravDir * -4f);
		Vector2 value2 = vector + new Vector2(direction * -6, gravDir * -4f);
		Dust dust = Dust.NewDustDirect(Vector2.Lerp(value, value2, num), 0, 0, 31, 0f, (0f - gravDir) * 0.25f, 127);
		dust.scale = 0.9f;
		dust.position -= new Vector2(4f);
		if (dust.velocity.Y > 0f)
		{
			dust.velocity.Y *= -1f;
		}
		dust.velocity *= 0.25f;
		Rectangle rectangle = Utils.CenteredRectangle(vector, new Vector2(8f, 20f));
		if (velocity.X * (float)direction > 0f || velocity.Y * gravDir > 0f)
		{
			Rectangle myRect = rectangle;
			myRect.Height -= 4;
			myRect.Y += 2;
			float damage = 8f;
			float knockback = 2f;
			int nPCImmuneTime = 12;
			int playerImmuneTime = 6;
			CollideWithNPCs(myRect, damage, knockback, nPCImmuneTime, playerImmuneTime);
		}
		rectangle.X -= direction * 10;
		if (whoAmI == Main.myPlayer)
		{
			bool[] shouldIgnore = ItemCheck_GetTileCutIgnoreList(HeldItem);
			ItemCheck_CutTiles(HeldItem, rectangle, shouldIgnore, cutExtraTiles: true);
			MowGrassTile(vector);
			if (!WorldGen.SolidTile(Framing.GetTileSafely(vector.ToTileCoordinates())))
			{
				MowGrassTile(vector + new Vector2(0f, 16f * gravDir));
			}
		}
	}

	private void MowGrassTile(Vector2 thePos)
	{
		Point point = thePos.ToTileCoordinates();
		Tile tile = Main.tile[point.X, point.Y];
		if (tile == null || !WorldGen.CanKillTile(point.X, point.Y, WorldGen.SpecialKillTileContext.MowingTheGrass))
		{
			return;
		}
		ushort num = 0;
		switch (tile.type)
		{
		case 2:
			num = 477;
			break;
		case 109:
			num = 492;
			break;
		}
		if (num != 0)
		{
			int num2 = WorldGen.KillTile_GetTileDustAmount(fail: true, tile);
			for (int i = 0; i < num2; i++)
			{
				WorldGen.KillTile_MakeTileDust(point.X, point.Y, tile);
			}
			tile.type = num;
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, point.X, point.Y);
			}
		}
	}

	public int CollideWithNPCs(Rectangle myRect, float Damage, float Knockback, int NPCImmuneTime, int PlayerImmuneTime)
	{
		int num = 0;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (!nPC.active || nPC.dontTakeDamage || nPC.friendly || nPC.immune[whoAmI] != 0 || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC))
			{
				continue;
			}
			Rectangle rect = nPC.getRect();
			if (myRect.Intersects(rect) && (nPC.noTileCollide || Collision.CanHit(position, width, height, nPC.position, nPC.width, nPC.height)))
			{
				int num2 = direction;
				if (velocity.X < 0f)
				{
					num2 = -1;
				}
				if (velocity.X > 0f)
				{
					num2 = 1;
				}
				if (whoAmI == Main.myPlayer)
				{
					ApplyDamageToNPC(nPC, (int)Damage, Knockback, num2, crit: false);
				}
				nPC.immune[whoAmI] = NPCImmuneTime;
				GiveImmuneTimeForCollisionAttack(PlayerImmuneTime);
				num++;
				break;
			}
		}
		return num;
	}

	public void ApplyDamageToNPC(NPC npc, int damage, float knockback, int direction, bool crit)
	{
		if (GetBannerBuffEffect(npc, out var effect))
		{
			damage = (int)((float)damage * effect.DamageDealt.Sample(Main.Difficulty));
		}
		OnHit(npc.Center.X, npc.Center.Y, npc);
		damage += npc.checkArmorPenetration(GetArmorPenetration(melee: false), 0f);
		NPCKillAttempt attempt = new NPCKillAttempt(npc);
		int dmg = (int)npc.StrikeNPC(damage, knockback, direction, crit, noEffect: false, fromNet: false, whoAmI);
		if (accDreamCatcher)
		{
			addDPS(dmg);
		}
		if (Main.netMode != 0)
		{
			NetMessage.SendData(28, -1, -1, null, npc.whoAmI, damage, knockback, direction, crit.ToInt());
		}
		int num = BannerSystem.NPCtoBanner(npc.BannerID());
		if (num >= 0)
		{
			lastCreatureHit = num;
		}
		if (attempt.DidNPCDie())
		{
			OnKillNPC(ref attempt, null);
		}
	}

	public void OnKillNPC(ref NPCKillAttempt attempt, object externalKillingBlowSource)
	{
		if (Main.myPlayer == whoAmI)
		{
			if (externalKillingBlowSource is Item { type: 5096 })
			{
				AddBuff(336, 420);
			}
			if (externalKillingBlowSource is Projectile projectile && ProjectileID.Sets.IsAGravestone[projectile.type] && ContentSamples.NpcsByNetId.TryGetValue(attempt.netId, out var value) && value.townNPC)
			{
				AchievementsHelper.NotifyProgressionEvent(36);
			}
		}
	}

	public bool GetBannerBuffEffect(NPC npc, out ItemID.BannerEffect effect)
	{
		return GetBannerBuffEffect(BannerSystem.NPCtoBanner(npc.BannerID()), out effect);
	}

	public bool GetBannerBuffEffect(int bannerType, out ItemID.BannerEffect effect)
	{
		effect = default(ItemID.BannerEffect);
		if (bannerType <= 0 || !HasNPCBannerBuff(bannerType))
		{
			return false;
		}
		effect = ItemID.Sets.BannerStrength[BannerSystem.BannerToItem(bannerType)];
		return true;
	}

	public void GiveImmuneTimeForCollisionAttack(int time)
	{
		if (_timeSinceLastImmuneGet <= 20)
		{
			_immuneStrikes++;
		}
		else
		{
			_immuneStrikes = 1;
		}
		_timeSinceLastImmuneGet = 0;
		if (_immuneStrikes < 3 && (!immune || immuneTime <= time))
		{
			immune = true;
			immuneNoBlink = true;
			immuneTime = time;
		}
	}

	public bool CanNPCBeHitByPlayerOrPlayerProjectile(NPC npc, Projectile projectile = null)
	{
		bool flag = dontHurtCritters || (projectile != null && (projectile.minion || ProjectileID.Sets.MinionShot[projectile.type] || projectile.sentry || ProjectileID.Sets.SentryShot[projectile.type]));
		if (projectile != null && projectile.trap)
		{
			flag = false;
		}
		if (npc.IsCritterThatIsHostileToPlayers())
		{
			flag = false;
		}
		if (NPCID.Sets.CountsAsCritter[npc.type] && flag)
		{
			return false;
		}
		return true;
	}

	public void JumpMovement()
	{
		if (mount.Active && mount.IsConsideredASlimeMount && wetSlime == 0 && velocity.Y > 0f)
		{
			Rectangle rect = getRect();
			rect.Offset(0, height - 1);
			rect.Height = 2;
			rect.Inflate(12, 6);
			for (int i = 0; i < Main.maxNPCs; i++)
			{
				NPC nPC = Main.npc[i];
				if (!nPC.active || nPC.dontTakeDamage || nPC.friendly || nPC.immune[whoAmI] != 0 || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC))
				{
					continue;
				}
				Rectangle rect2 = nPC.getRect();
				if (rect.Intersects(rect2) && (nPC.noTileCollide || Collision.CanHit(position, width, height, nPC.position, nPC.width, nPC.height)))
				{
					float num = 40f * minionDamage;
					float knockback = 5f;
					int num2 = direction;
					if (velocity.X < 0f)
					{
						num2 = -1;
					}
					if (velocity.X > 0f)
					{
						num2 = 1;
					}
					if (whoAmI == Main.myPlayer)
					{
						ApplyDamageToNPC(nPC, (int)num, knockback, num2, crit: false);
					}
					nPC.immune[whoAmI] = 10;
					velocity.Y = -10f;
					GiveImmuneTimeForCollisionAttack(6);
					break;
				}
			}
		}
		if (isPerformingJump_DownDash && velocity.Y > 0f)
		{
			Rectangle rect3 = getRect();
			rect3.Offset(0, height - 1);
			rect3.Height = 2;
			rect3.Inflate(12, 6);
			for (int j = 0; j < Main.maxNPCs; j++)
			{
				NPC nPC2 = Main.npc[j];
				if (!nPC2.active || nPC2.dontTakeDamage || nPC2.friendly || nPC2.immune[whoAmI] != 0 || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC2))
				{
					continue;
				}
				Rectangle rect4 = nPC2.getRect();
				if (rect3.Intersects(rect4) && (nPC2.noTileCollide || Collision.CanHit(position, width, height, nPC2.position, nPC2.width, nPC2.height)))
				{
					float num3 = 40f * minionDamage;
					float knockback2 = 5f;
					int num4 = direction;
					if (velocity.X < 0f)
					{
						num4 = -1;
					}
					if (velocity.X > 0f)
					{
						num4 = 1;
					}
					if (whoAmI == Main.myPlayer)
					{
						ApplyDamageToNPC(nPC2, (int)num3, knockback2, num4, crit: false);
					}
					nPC2.immune[whoAmI] = 10;
					GiveImmuneTimeForCollisionAttack(6);
					break;
				}
			}
		}
		if (mount.Active && mount.Type == 17 && velocity.Y > 0f)
		{
			Rectangle rect5 = getRect();
			rect5.Offset(0, height - 1);
			rect5.Height = 2;
			rect5.Inflate(12, 6);
			for (int k = 0; k < Main.maxNPCs; k++)
			{
				NPC nPC3 = Main.npc[k];
				if (!nPC3.active || nPC3.dontTakeDamage || nPC3.friendly || nPC3.immune[whoAmI] != 0 || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC3))
				{
					continue;
				}
				Rectangle rect6 = nPC3.getRect();
				if (rect5.Intersects(rect6) && (nPC3.noTileCollide || Collision.CanHit(position, width, height, nPC3.position, nPC3.width, nPC3.height)))
				{
					float num5 = 40f;
					float knockback3 = 5f;
					int num6 = direction;
					if (velocity.X < 0f)
					{
						num6 = -1;
					}
					if (velocity.X > 0f)
					{
						num6 = 1;
					}
					if (whoAmI == Main.myPlayer)
					{
						ApplyDamageToNPC(nPC3, (int)num5, knockback3, num6, crit: false);
					}
					nPC3.immune[whoAmI] = 12;
					GiveImmuneTimeForCollisionAttack(12);
					break;
				}
			}
		}
		if (controlJump)
		{
			if (sliding)
			{
				autoJump = false;
			}
			bool flag = false;
			bool flag2 = wet && accFlipper;
			bool flag3 = !mount.Active || !mount.Cart;
			if (mount.Active && mount.IsConsideredASlimeMount && wetSlime > 0)
			{
				wetSlime = 0;
				flag = true;
			}
			if (mount.Active && mount.Type == 43 && releaseJump && velocity.Y != 0f)
			{
				isPerformingPogostickTricks = true;
			}
			if (jump > 0)
			{
				if (velocity.Y == 0f)
				{
					jump = 0;
				}
				else
				{
					velocity.Y = (0f - jumpSpeed) * gravDir;
					if (merman && (!mount.Active || !mount.Cart))
					{
						if (swimTime <= 10)
						{
							swimTime = 30;
						}
					}
					else
					{
						jump--;
					}
				}
			}
			else if ((sliding || velocity.Y == 0f || flag || canJumpAgain_Cloud || canJumpAgain_Sandstorm || canJumpAgain_Blizzard || canJumpAgain_Fart || canJumpAgain_Sail || canJumpAgain_Unicorn || canJumpAgain_Santank || canJumpAgain_WallOfFleshGoat || canJumpAgain_Basilisk || (flag2 && flag3) || (hasDeadCellsDownDash && controlDown && velocity.Y != 0f && !isPerformingJump_DownDash && !mount.Active)) && (releaseJump || (autoJump && (velocity.Y == 0f || sliding))))
			{
				if (mount.Active && MountID.Sets.Cart[mount.Type])
				{
					position.Y -= 0.001f;
				}
				if (sliding || velocity.Y == 0f)
				{
					justJumped = true;
				}
				bool flag4 = false;
				if (wet && accFlipper)
				{
					if (swimTime == 0)
					{
						swimTime = 30;
					}
					flag4 = true;
				}
				bool flag5 = false;
				bool flag6 = false;
				bool flag7 = false;
				bool flag8 = false;
				bool flag9 = false;
				bool flag10 = false;
				bool flag11 = false;
				bool flag12 = false;
				bool flag13 = false;
				if (!flag2 && !flag)
				{
					if (canJumpAgain_Basilisk)
					{
						flag12 = true;
						canJumpAgain_Basilisk = false;
					}
					else if (canJumpAgain_WallOfFleshGoat)
					{
						flag11 = true;
						canJumpAgain_WallOfFleshGoat = false;
					}
					else if (canJumpAgain_Santank)
					{
						flag10 = true;
						canJumpAgain_Santank = false;
					}
					else if (canJumpAgain_Unicorn)
					{
						flag9 = true;
						canJumpAgain_Unicorn = false;
					}
					else if (hasDeadCellsDownDash && controlDown && !isPerformingJump_DownDash && velocity.Y != 0f && !mount.Active)
					{
						flag13 = true;
					}
					else if (canJumpAgain_Sandstorm)
					{
						flag5 = true;
						canJumpAgain_Sandstorm = false;
					}
					else if (canJumpAgain_Blizzard)
					{
						flag6 = true;
						canJumpAgain_Blizzard = false;
					}
					else if (canJumpAgain_Fart)
					{
						canJumpAgain_Fart = false;
						flag7 = true;
					}
					else if (canJumpAgain_Sail)
					{
						canJumpAgain_Sail = false;
						flag8 = true;
					}
					else
					{
						canJumpAgain_Cloud = false;
					}
				}
				canRocket = false;
				rocketRelease = false;
				if (!onTrack)
				{
					fullRotation = 0f;
				}
				if (velocity.Y == 0f || sliding || (autoJump && justJumped))
				{
					RefreshDoubleJumps();
				}
				isPerformingJump_DownDash = flag13;
				if (velocity.Y == 0f || flag4 || sliding || flag)
				{
					if (mount.Active && mount.Type == 43)
					{
						SoundEngine.PlaySound(SoundID.Item168, base.Center);
					}
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = jumpHeight;
					if (portableStoolInfo.IsInUse)
					{
						portableStoolInfo.IsInUse = false;
						position.Y -= portableStoolInfo.HeightBoost;
						if (Main.myPlayer == whoAmI)
						{
							Main.cameraY += portableStoolInfo.HeightBoost;
						}
					}
					if (sliding)
					{
						velocity.X = 3 * -slideDir;
					}
				}
				else if (flag13)
				{
					velocity.Y = 16f * gravDir;
				}
				else if (flag5)
				{
					isPerformingJump_Sandstorm = true;
					_ = height;
					_ = gravDir;
					_ = -1f;
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = jumpHeight * 3;
				}
				else if (flag6)
				{
					isPerformingJump_Blizzard = true;
					_ = height;
					_ = gravDir;
					_ = -1f;
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = (int)((double)jumpHeight * 1.5);
				}
				else if (flag8)
				{
					isPerformingJump_Sail = true;
					int num7 = height;
					if (gravDir == -1f)
					{
						num7 = 0;
					}
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = (int)((double)jumpHeight * 1.25);
					for (int l = 0; l < 30; l++)
					{
						int num8 = Dust.NewDust(new Vector2(position.X, position.Y + (float)num7), width, 12, 253, velocity.X * 0.3f, velocity.Y * 0.3f, 100, default(Color), 1.5f);
						if (l % 2 == 0)
						{
							Main.dust[num8].velocity.X += (float)Main.rand.Next(30, 71) * 0.1f;
						}
						else
						{
							Main.dust[num8].velocity.X -= (float)Main.rand.Next(30, 71) * 0.1f;
						}
						Main.dust[num8].velocity.Y += (float)Main.rand.Next(-10, 31) * 0.1f;
						Main.dust[num8].noGravity = true;
						Main.dust[num8].scale += (float)Main.rand.Next(-10, 41) * 0.01f;
						Main.dust[num8].velocity *= Main.dust[num8].scale * 0.7f;
						Vector2 vector = new Vector2(Main.rand.Next(-100, 101), Main.rand.Next(-100, 101));
						vector.Normalize();
						vector *= (float)Main.rand.Next(81) * 0.1f;
					}
				}
				else if (flag7)
				{
					isPerformingJump_Fart = true;
					int num9 = height;
					if (gravDir == -1f)
					{
						num9 = 0;
					}
					SoundEngine.PlaySound(SoundID.Item16, position);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = jumpHeight * 2;
					for (int m = 0; m < 10; m++)
					{
						int num10 = Dust.NewDust(new Vector2(position.X - 34f, position.Y + (float)num9 - 16f), 102, 32, 188, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 100, default(Color), 1.5f);
						Main.dust[num10].velocity.X = Main.dust[num10].velocity.X * 0.5f - velocity.X * 0.1f;
						Main.dust[num10].velocity.Y = Main.dust[num10].velocity.Y * 0.5f - velocity.Y * 0.3f;
					}
					int num11 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 16f, position.Y + (float)num9 - 16f), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(435, 438));
					Main.gore[num11].velocity.X = Main.gore[num11].velocity.X * 0.1f - velocity.X * 0.1f;
					Main.gore[num11].velocity.Y = Main.gore[num11].velocity.Y * 0.1f - velocity.Y * 0.05f;
					num11 = Gore.NewGore(new Vector2(position.X - 36f, position.Y + (float)num9 - 16f), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(435, 438));
					Main.gore[num11].velocity.X = Main.gore[num11].velocity.X * 0.1f - velocity.X * 0.1f;
					Main.gore[num11].velocity.Y = Main.gore[num11].velocity.Y * 0.1f - velocity.Y * 0.05f;
					num11 = Gore.NewGore(new Vector2(position.X + (float)width + 4f, position.Y + (float)num9 - 16f), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(435, 438));
					Main.gore[num11].velocity.X = Main.gore[num11].velocity.X * 0.1f - velocity.X * 0.1f;
					Main.gore[num11].velocity.Y = Main.gore[num11].velocity.Y * 0.1f - velocity.Y * 0.05f;
				}
				else if (flag9)
				{
					isPerformingJump_Unicorn = true;
					_ = height;
					_ = gravDir;
					_ = -1f;
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = jumpHeight * 2;
					Vector2 center = base.Center;
					Vector2 vector2 = new Vector2(50f, 20f);
					float num12 = (float)Math.PI * 2f * Main.rand.NextFloat();
					for (int n = 0; n < 5; n++)
					{
						for (float num13 = 0f; num13 < 14f; num13 += 1f)
						{
							Dust obj = Main.dust[Dust.NewDust(center, 0, 0, Utils.SelectRandom<int>(Main.rand, 176, 177, 179))];
							Vector2 vector3 = Vector2.UnitY.RotatedBy(num13 * ((float)Math.PI * 2f) / 14f + num12);
							vector3 *= 0.2f * (float)n;
							obj.position = center + vector3 * vector2;
							obj.velocity = vector3 + new Vector2(0f, gravDir * 4f);
							obj.noGravity = true;
							obj.scale = 1f + Main.rand.NextFloat() * 0.8f;
							obj.fadeIn = Main.rand.NextFloat() * 2f;
							obj.shader = GameShaders.Armor.GetSecondaryShader(cMount, this);
						}
					}
				}
				else if (flag11)
				{
					isPerformingJump_WallOfFleshGoat = true;
					_ = height;
					_ = gravDir;
					_ = -1f;
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = jumpHeight * 2;
					Vector2 center2 = base.Center;
					Vector2 vector4 = new Vector2(50f, 20f);
					float num14 = (float)Math.PI * 2f * Main.rand.NextFloat();
					for (int num15 = 0; num15 < 5; num15++)
					{
						for (float num16 = 0f; num16 < 14f; num16 += 1f)
						{
							Dust obj2 = Main.dust[Dust.NewDust(center2, 0, 0, 6)];
							Vector2 vector5 = Vector2.UnitY.RotatedBy(num16 * ((float)Math.PI * 2f) / 14f + num14);
							vector5 *= 0.2f * (float)num15;
							obj2.position = center2 + vector5 * vector4;
							obj2.velocity = vector5 + new Vector2(0f, gravDir * 4f);
							obj2.noGravity = true;
							obj2.scale = 1f + Main.rand.NextFloat() * 0.8f;
							obj2.fadeIn = Main.rand.NextFloat() * 2f;
							obj2.shader = GameShaders.Armor.GetSecondaryShader(cMount, this);
						}
					}
				}
				else if (flag12)
				{
					isPerformingJump_Basilisk = true;
					_ = height;
					_ = gravDir;
					_ = -1f;
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = (int)((double)jumpHeight * 0.75);
					Vector2 center3 = base.Center;
					Vector2 vector6 = new Vector2(50f, 20f);
					float num17 = (float)Math.PI * 2f * Main.rand.NextFloat();
					for (int num18 = 0; num18 < 5; num18++)
					{
						for (float num19 = 0f; num19 < 14f; num19 += 1f)
						{
							Dust obj3 = Main.dust[Dust.NewDust(center3, 0, 0, 31)];
							Vector2 vector7 = Vector2.UnitY.RotatedBy(num19 * ((float)Math.PI * 2f) / 14f + num17);
							vector7 *= 0.2f * (float)num18;
							obj3.position = center3 + vector7 * vector6;
							obj3.velocity = vector7 + new Vector2(0f, gravDir * 4f);
							obj3.noGravity = true;
							obj3.scale = 1f + Main.rand.NextFloat() * 0.8f;
							obj3.fadeIn = Main.rand.NextFloat() * 2f;
							obj3.shader = GameShaders.Armor.GetSecondaryShader(cMount, this);
						}
					}
				}
				else if (flag10)
				{
					isPerformingJump_Santank = true;
					int num20 = height;
					if (gravDir == -1f)
					{
						num20 = 0;
					}
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = jumpHeight * 2;
					for (int num21 = 0; num21 < 15; num21++)
					{
						int num22 = Dust.NewDust(new Vector2(position.X - 34f, position.Y + (float)num20 - 16f), 102, 32, 4, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 100, new Color(250, 230, 230, 150), 1.5f);
						Main.dust[num22].velocity.X = Main.dust[num22].velocity.X * 0.5f - velocity.X * 0.1f;
						Main.dust[num22].velocity.Y = Main.dust[num22].velocity.Y * 0.5f - velocity.Y * 0.3f;
						Main.dust[num22].noGravity = true;
						num22 = Dust.NewDust(new Vector2(position.X - 34f, position.Y + (float)num20 - 16f), 102, 32, 6, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 20, default(Color), 1.5f);
						Main.dust[num22].velocity.Y -= 1f;
						if (num21 % 2 == 0)
						{
							Main.dust[num22].fadeIn = Main.rand.NextFloat() * 2f;
						}
					}
					float y = base.Bottom.Y - 22f;
					for (int num23 = 0; num23 < 3; num23++)
					{
						Vector2 vector8 = base.Center;
						switch (num23)
						{
						case 0:
							vector8 = new Vector2(base.Center.X - 16f, y);
							break;
						case 1:
							vector8 = new Vector2(position.X - 36f, y);
							break;
						case 2:
							vector8 = new Vector2(base.Right.X + 4f, y);
							break;
						}
						int num24 = Gore.NewGore(vector8, new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(61, 63));
						Main.gore[num24].velocity *= 0.1f;
						Main.gore[num24].velocity.X -= velocity.X * 0.1f;
						Main.gore[num24].velocity.Y -= velocity.Y * 0.05f;
						Main.gore[num24].velocity += Main.rand.NextVector2Circular(1f, 1f) * 0.5f;
					}
				}
				else
				{
					isPerformingJump_Cloud = true;
					int num25 = height;
					if (gravDir == -1f)
					{
						num25 = 0;
					}
					SoundEngine.PlaySound(16, (int)position.X, (int)position.Y);
					velocity.Y = (0f - jumpSpeed) * gravDir;
					jump = (int)((double)jumpHeight * 0.75);
					for (int num26 = 0; num26 < 10; num26++)
					{
						int num27 = Dust.NewDust(new Vector2(position.X - 34f, position.Y + (float)num25 - 16f), 102, 32, 16, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 100, default(Color), 1.5f);
						Main.dust[num27].velocity.X = Main.dust[num27].velocity.X * 0.5f - velocity.X * 0.1f;
						Main.dust[num27].velocity.Y = Main.dust[num27].velocity.Y * 0.5f - velocity.Y * 0.3f;
					}
					int num28 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 16f, position.Y + (float)num25 - 16f), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(11, 14));
					Main.gore[num28].velocity.X = Main.gore[num28].velocity.X * 0.1f - velocity.X * 0.1f;
					Main.gore[num28].velocity.Y = Main.gore[num28].velocity.Y * 0.1f - velocity.Y * 0.05f;
					num28 = Gore.NewGore(new Vector2(position.X - 36f, position.Y + (float)num25 - 16f), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(11, 14));
					Main.gore[num28].velocity.X = Main.gore[num28].velocity.X * 0.1f - velocity.X * 0.1f;
					Main.gore[num28].velocity.Y = Main.gore[num28].velocity.Y * 0.1f - velocity.Y * 0.05f;
					num28 = Gore.NewGore(new Vector2(position.X + (float)width + 4f, position.Y + (float)num25 - 16f), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(11, 14));
					Main.gore[num28].velocity.X = Main.gore[num28].velocity.X * 0.1f - velocity.X * 0.1f;
					Main.gore[num28].velocity.Y = Main.gore[num28].velocity.Y * 0.1f - velocity.Y * 0.05f;
				}
			}
			releaseJump = false;
		}
		else
		{
			jump = 0;
			releaseJump = true;
			rocketRelease = true;
		}
	}

	public void DashMovement()
	{
		if (mount.Active && (mount.Type == 62 || mount.Type == 63))
		{
			dashType = 6;
		}
		if (dashDelay == 0)
		{
			dash = dashType;
		}
		if (dash == 0)
		{
			dashTime = 0;
			dashDelay = 0;
		}
		if (dash == 2 && eocDash > 0)
		{
			if (eocHit < 0)
			{
				Rectangle victimHitbox = new Rectangle((int)((double)position.X + (double)velocity.X * 0.5 - 4.0), (int)((double)position.Y + (double)velocity.Y * 0.5 - 4.0), width + 8, height + 8);
				for (int i = 0; i < Main.maxNPCs; i++)
				{
					NPC nPC = Main.npc[i];
					if (!nPC.active || nPC.dontTakeDamage || nPC.friendly || (nPC.aiStyle == 112 && !(nPC.ai[2] <= 1f)) || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC))
					{
						continue;
					}
					Rectangle npcRect = nPC.getRect();
					if (nPC.type == 668)
					{
						int specialHitSetter = 1;
						float damageMultiplier = 1f;
						NPC.GetMeleeCollisionData(victimHitbox, i, ref specialHitSetter, ref damageMultiplier, ref npcRect);
					}
					if (victimHitbox.Intersects(npcRect) && (nPC.noTileCollide || CanHit(nPC)))
					{
						float num = 30f * meleeDamage;
						float num2 = 9f;
						bool crit = false;
						if (kbGlove)
						{
							num2 *= 2f;
						}
						if (kbBuff)
						{
							num2 *= 1.5f;
						}
						if (Main.rand.Next(100) < meleeCrit)
						{
							crit = true;
						}
						int num3 = direction;
						if (velocity.X < 0f)
						{
							num3 = -1;
						}
						if (velocity.X > 0f)
						{
							num3 = 1;
						}
						if (whoAmI == Main.myPlayer)
						{
							ApplyDamageToNPC(nPC, (int)num, num2, num3, crit);
						}
						eocDash = 10;
						dashDelay = 30;
						velocity.X = -num3 * 9;
						velocity.Y = -4f;
						GiveImmuneTimeForCollisionAttack(4);
						eocHit = i;
					}
				}
			}
			else if ((!controlLeft || !(velocity.X < 0f)) && (!controlRight || !(velocity.X > 0f)))
			{
				velocity.X *= 0.95f;
			}
		}
		if (dash == 3 && dashDelay < 0 && whoAmI == Main.myPlayer)
		{
			Rectangle victimHitbox2 = new Rectangle((int)((double)position.X + (double)velocity.X * 0.5 - 4.0), (int)((double)position.Y + (double)velocity.Y * 0.5 - 4.0), width + 8, height + 8);
			for (int j = 0; j < Main.maxNPCs; j++)
			{
				NPC nPC2 = Main.npc[j];
				if (!nPC2.active || nPC2.dontTakeDamage || nPC2.friendly || nPC2.immune[whoAmI] > 0 || (nPC2.aiStyle == 112 && !(nPC2.ai[2] <= 1f)) || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC2))
				{
					continue;
				}
				Rectangle npcRect2 = nPC2.getRect();
				if (nPC2.type == 668)
				{
					int specialHitSetter2 = 1;
					float damageMultiplier2 = 1f;
					NPC.GetMeleeCollisionData(victimHitbox2, j, ref specialHitSetter2, ref damageMultiplier2, ref npcRect2);
				}
				if (victimHitbox2.Intersects(npcRect2) && (nPC2.noTileCollide || CanHit(nPC2)))
				{
					if (!solarDashConsumedFlare)
					{
						solarDashConsumedFlare = true;
						ConsumeSolarFlare();
					}
					float num4 = 150f * meleeDamage;
					float num5 = 9f;
					bool crit2 = false;
					if (kbGlove)
					{
						num5 *= 2f;
					}
					if (kbBuff)
					{
						num5 *= 1.5f;
					}
					if (Main.rand.Next(100) < meleeCrit)
					{
						crit2 = true;
					}
					int num6 = direction;
					if (velocity.X < 0f)
					{
						num6 = -1;
					}
					if (velocity.X > 0f)
					{
						num6 = 1;
					}
					if (whoAmI == Main.myPlayer)
					{
						ApplyDamageToNPC(nPC2, (int)num4, num5, num6, crit2);
						int num7 = Projectile.NewProjectile(GetProjectileSource_OnHit(nPC2, 2), base.Center.X, base.Center.Y, 0f, 0f, 608, (int)num4, 15f, Main.myPlayer);
						Main.projectile[num7].Kill();
					}
					nPC2.immune[whoAmI] = 6;
					GiveImmuneTimeForCollisionAttack(4);
				}
			}
		}
		if (dash == 6 && dashDelay < 0 && whoAmI == Main.myPlayer)
		{
			Rectangle victimHitbox3 = new Rectangle((int)((double)position.X + (double)velocity.X * 0.5 - 4.0), (int)((double)position.Y + (double)velocity.Y * 0.5 - 4.0), width + 8, height + 8);
			for (int k = 0; k < Main.maxNPCs; k++)
			{
				NPC nPC3 = Main.npc[k];
				if (!nPC3.active || nPC3.dontTakeDamage || nPC3.friendly || nPC3.immune[whoAmI] > 0 || (nPC3.aiStyle == 112 && !(nPC3.ai[2] <= 1f)) || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC3))
				{
					continue;
				}
				Rectangle npcRect3 = nPC3.getRect();
				if (nPC3.type == 668)
				{
					int specialHitSetter3 = 1;
					float damageMultiplier3 = 1f;
					NPC.GetMeleeCollisionData(victimHitbox3, k, ref specialHitSetter3, ref damageMultiplier3, ref npcRect3);
				}
				if (victimHitbox3.Intersects(npcRect3) && (nPC3.noTileCollide || CanHit(nPC3)))
				{
					float num8 = 32f * minionDamage;
					float num9 = 6f;
					bool crit3 = false;
					if (kbGlove)
					{
						num9 *= 2f;
					}
					if (kbBuff)
					{
						num9 *= 1.5f;
					}
					int num10 = direction;
					if (velocity.X < 0f)
					{
						num10 = -1;
					}
					if (velocity.X > 0f)
					{
						num10 = 1;
					}
					if (whoAmI == Main.myPlayer)
					{
						ApplyDamageToNPC(nPC3, (int)num8, num9, num10, crit3);
					}
					nPC3.immune[whoAmI] = 6;
					GiveImmuneTimeForCollisionAttack(10);
				}
			}
		}
		if (mount.Active && !MountID.Sets.CanDash[mount.Type] && eocDash > 0)
		{
			eocDash = 0;
		}
		if (dashDelay > 0)
		{
			if (eocDash > 0)
			{
				eocDash--;
			}
			if (eocDash == 0)
			{
				eocHit = -1;
			}
			dashDelay--;
		}
		else if (dashDelay < 0)
		{
			StopVanityActions();
			float num11 = 12f;
			float num12 = 0.992f;
			float num13 = Math.Max(accRunSpeed, maxRunSpeed);
			float num14 = 0.96f;
			int num15 = 20;
			float num16 = height / 42;
			Mount.MountDelegatesData.AdjustDashDustMethod adjustDashDustMethod = (mount.Active ? mount.Delegations.DashDust : null);
			if (dash == 1)
			{
				float num17 = 4f * num16;
				int num18 = (int)(16f * num16);
				for (int l = 0; l < 2; l++)
				{
					int num19 = ((velocity.Y != 0f) ? Dust.NewDust(new Vector2(position.X, position.Y + (float)(height / 2) - num17 * 2f), width, num18, 31, 0f, 0f, 100, default(Color), 1.4f) : Dust.NewDust(new Vector2(position.X, position.Y + (float)height - num17), width, num18 / 2, 31, 0f, 0f, 100, default(Color), 1.4f));
					Main.dust[num19].velocity *= 0.1f;
					Main.dust[num19].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					adjustDashDustMethod?.Invoke(this, l, Main.dust[num19]);
				}
			}
			else if (dash == 2)
			{
				float num20 = 4f * num16;
				int num21 = (int)(16f * num16);
				for (int m = 0; m < 0; m++)
				{
					int num22 = ((velocity.Y != 0f) ? Dust.NewDust(new Vector2(position.X, position.Y + (float)(height / 2) - 8f), width, num21, 31, 0f, 0f, 100, default(Color), 1.4f) : Dust.NewDust(new Vector2(position.X, position.Y + (float)height - num20), width, num21 / 2, 31, 0f, 0f, 100, default(Color), 1.4f));
					Main.dust[num22].velocity *= 0.1f;
					Main.dust[num22].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					adjustDashDustMethod?.Invoke(this, m, Main.dust[num22]);
				}
				num12 = 0.985f;
				num14 = 0.94f;
				num15 = 30;
			}
			else if (dash == 3)
			{
				float num23 = 4f * num16;
				int num24 = (int)(8f * num16);
				for (int n = 0; n < 4; n++)
				{
					int num25 = Dust.NewDust(new Vector2(position.X, position.Y + num23), width, height - num24, 6, 0f, 0f, 100, default(Color), 1.7f);
					Main.dust[num25].velocity *= 0.1f;
					Main.dust[num25].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					Main.dust[num25].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
					Main.dust[num25].noGravity = true;
					if (Main.rand.Next(2) == 0)
					{
						Main.dust[num25].fadeIn = 0.5f;
					}
					adjustDashDustMethod?.Invoke(this, n, Main.dust[num25]);
				}
				num11 = 14f;
				num12 = 0.985f;
				num14 = 0.94f;
				num15 = 20;
			}
			else if (dash == 4)
			{
				float num26 = 4f * num16;
				int num27 = (int)(8f * num16);
				for (int num28 = 0; num28 < 2; num28++)
				{
					int num29 = Dust.NewDust(new Vector2(position.X, position.Y + num26), width, height - num27, 229, 0f, 0f, 100, default(Color), 1.2f);
					Main.dust[num29].velocity *= 0.1f;
					Main.dust[num29].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					Main.dust[num29].noGravity = true;
					if (Main.rand.Next(2) == 0)
					{
						Main.dust[num29].fadeIn = 0.3f;
					}
					adjustDashDustMethod?.Invoke(this, num28, Main.dust[num29]);
				}
				num12 = 0.985f;
				num14 = 0.94f;
				num15 = 20;
			}
			if (dash == 5)
			{
				float num30 = 4f * num16;
				int num31 = (int)(16f * num16);
				for (int num32 = 0; num32 < 2; num32++)
				{
					int type = Main.rand.NextFromList(new short[3] { 68, 69, 70 });
					int num33 = ((velocity.Y != 0f) ? Dust.NewDust(new Vector2(position.X, position.Y + (float)(height / 2) - num30 * 2f), width, num31, type, 0f, 0f, 100) : Dust.NewDust(new Vector2(position.X, position.Y + (float)height - num30), width, num31 / 2, type, 0f, 0f, 100));
					Main.dust[num33].velocity *= 0.2f;
					Main.dust[num33].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					Main.dust[num33].fadeIn = 0.5f + (float)Main.rand.Next(20) * 0.01f;
					Main.dust[num33].noGravity = true;
					Main.dust[num33].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
					adjustDashDustMethod?.Invoke(this, num32, Main.dust[num33]);
				}
			}
			if (dash == 6)
			{
				num15 = 10;
				if (Math.Sign(velocity.X) != direction)
				{
					dashDelay = num15;
					velocity.X *= 0.3f;
				}
				Vector3 rgb = ((mount.Type == 63) ? new Vector3(0.6f, 0.3f, 0.1f) : new Vector3(0.5f, 0.1f, 0.6f));
				Lighting.AddLight(base.Center, rgb);
				for (int num34 = 0; num34 < 8; num34++)
				{
					int type2 = 306;
					int num35 = Dust.NewDust(new Vector2(position.X + (float)(direction * 80), position.Y + 12f), width, height - 20, type2, 0f, 0f, 100);
					Main.dust[num35].velocity *= 1.5f;
					Main.dust[num35].scale *= 1f + (float)Main.rand.Next(40) * 0.01f;
					Main.dust[num35].fadeIn = 0.5f + (float)Main.rand.Next(20) * 0.01f;
					Main.dust[num35].noGravity = true;
					Main.dust[num35].shader = GameShaders.Armor.GetSecondaryShader(cMount, this);
					Main.dust[num35].velocity.X += (float)direction * 1.5f;
					float num36 = Main.rand.NextFloat();
					Main.dust[num35].color = Color.Lerp(new Color(0.9f, 0.7f, 1f), Color.White, num36 * num36 * num36);
					if (mount.Type == 63)
					{
						Main.dust[num35].color = Color.Lerp(new Color(1f, 0.7f, 0.5f), Color.White, num36 * num36 * num36);
					}
					adjustDashDustMethod?.Invoke(this, num34, Main.dust[num35]);
				}
			}
			if (dash <= 0)
			{
				return;
			}
			doorHelper.AllowOpeningDoorsByVelocityAloneForATime(num15 * 3);
			vortexStealthActive = false;
			if (velocity.X > num11 || velocity.X < 0f - num11)
			{
				velocity.X *= num12;
				return;
			}
			if (velocity.X > num13 || velocity.X < 0f - num13)
			{
				velocity.X *= num14;
				return;
			}
			dashDelay = num15;
			if (velocity.X < 0f)
			{
				velocity.X = 0f - num13;
			}
			else if (velocity.X > 0f)
			{
				velocity.X = num13;
			}
		}
		else
		{
			if (dash <= 0 || (mount.Active && !MountID.Sets.CanDash[mount.Type]))
			{
				return;
			}
			if (dash == 1)
			{
				DoCommonDashHandle(out var dir, out var dashing);
				if (dashing)
				{
					velocity.X = 16.9f * (float)dir;
					Point point = (base.Center + new Vector2(dir * width / 2 + 2, gravDir * (float)(-height) / 2f + gravDir * 2f)).ToTileCoordinates();
					Point point2 = (base.Center + new Vector2(dir * width / 2 + 2, 0f)).ToTileCoordinates();
					if (WorldGen.SolidOrSlopedTile(point.X, point.Y) || WorldGen.SolidOrSlopedTile(point2.X, point2.Y))
					{
						velocity.X /= 2f;
					}
					dashDelay = -1;
					for (int num37 = 0; num37 < 20; num37++)
					{
						int num38 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 31, 0f, 0f, 100, default(Color), 2f);
						Main.dust[num38].position.X += Main.rand.Next(-5, 6);
						Main.dust[num38].position.Y += Main.rand.Next(-5, 6);
						Main.dust[num38].velocity *= 0.2f;
						Main.dust[num38].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					}
					int num39 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 34f), default(Vector2), Main.rand.Next(61, 64));
					Main.gore[num39].velocity.X = (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.gore[num39].velocity.Y = (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.gore[num39].velocity *= 0.4f;
					num39 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 14f), default(Vector2), Main.rand.Next(61, 64));
					Main.gore[num39].velocity.X = (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.gore[num39].velocity.Y = (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.gore[num39].velocity *= 0.4f;
				}
			}
			else if (dash == 2)
			{
				DoCommonDashHandle(out var dir2, out var dashing2);
				if (dashing2)
				{
					velocity.X = 14.5f * (float)dir2;
					Point point3 = (base.Center + new Vector2(dir2 * width / 2 + 2, gravDir * (float)(-height) / 2f + gravDir * 2f)).ToTileCoordinates();
					Point point4 = (base.Center + new Vector2(dir2 * width / 2 + 2, 0f)).ToTileCoordinates();
					if (WorldGen.SolidOrSlopedTile(point3.X, point3.Y) || WorldGen.SolidOrSlopedTile(point4.X, point4.Y))
					{
						velocity.X /= 2f;
					}
					dashDelay = -1;
					eocDash = 15;
					for (int num40 = 0; num40 < 0; num40++)
					{
						int num41 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 31, 0f, 0f, 100, default(Color), 2f);
						Main.dust[num41].position.X += Main.rand.Next(-5, 6);
						Main.dust[num41].position.Y += Main.rand.Next(-5, 6);
						Main.dust[num41].velocity *= 0.2f;
						Main.dust[num41].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
					}
				}
			}
			else if (dash == 3)
			{
				DoCommonDashHandle(out var dir3, out var dashing3, SolarDashStart);
				if (dashing3)
				{
					velocity.X = 21.9f * (float)dir3;
					Point point5 = (base.Center + new Vector2(dir3 * width / 2 + 2, gravDir * (float)(-height) / 2f + gravDir * 2f)).ToTileCoordinates();
					Point point6 = (base.Center + new Vector2(dir3 * width / 2 + 2, 0f)).ToTileCoordinates();
					if (WorldGen.SolidOrSlopedTile(point5.X, point5.Y) || WorldGen.SolidOrSlopedTile(point6.X, point6.Y))
					{
						velocity.X /= 2f;
					}
					dashDelay = -1;
					for (int num42 = 0; num42 < 20; num42++)
					{
						int num43 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 6, 0f, 0f, 100, default(Color), 2f);
						Main.dust[num43].position.X += Main.rand.Next(-5, 6);
						Main.dust[num43].position.Y += Main.rand.Next(-5, 6);
						Main.dust[num43].velocity *= 0.2f;
						Main.dust[num43].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
						Main.dust[num43].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
						Main.dust[num43].noGravity = true;
						Main.dust[num43].fadeIn = 0.5f;
					}
				}
			}
			if (dash == 5)
			{
				DoCommonDashHandle(out var dir4, out var dashing4);
				if (dashing4)
				{
					velocity.X = 16.9f * (float)dir4;
					Point point7 = (base.Center + new Vector2(dir4 * width / 2 + 2, gravDir * (float)(-height) / 2f + gravDir * 2f)).ToTileCoordinates();
					Point point8 = (base.Center + new Vector2(dir4 * width / 2 + 2, 0f)).ToTileCoordinates();
					if (WorldGen.SolidOrSlopedTile(point7.X, point7.Y) || WorldGen.SolidOrSlopedTile(point8.X, point8.Y))
					{
						velocity.X /= 2f;
					}
					dashDelay = -1;
					for (int num44 = 0; num44 < 20; num44++)
					{
						int type3 = Main.rand.NextFromList(new short[3] { 68, 69, 70 });
						int num45 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, type3, 0f, 0f, 100, default(Color), 1.5f);
						Main.dust[num45].position.X += Main.rand.Next(-5, 6);
						Main.dust[num45].position.Y += Main.rand.Next(-5, 6);
						Main.dust[num45].velocity = DirectionTo(Main.dust[num45].position) * 2f;
						Main.dust[num45].scale *= 1f + (float)Main.rand.Next(20) * 0.01f;
						Main.dust[num45].fadeIn = 0.5f + (float)Main.rand.Next(20) * 0.01f;
						Main.dust[num45].noGravity = true;
						Main.dust[num45].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
					}
				}
			}
			if (dash != 6)
			{
				return;
			}
			DoCommonDashHandle(out var dir5, out var dashing5);
			if (dashing5)
			{
				if (velocity.Y == 0f)
				{
					velocity.Y = -4f;
				}
				velocity.X = 16f * (float)dir5;
				if (velocity.Y > 0f)
				{
					velocity.Y /= 2f;
				}
				Point point9 = (base.Center + new Vector2(dir5 * width / 2 + 2, gravDir * (float)(-height) / 2f + gravDir * 2f)).ToTileCoordinates();
				Point point10 = (base.Center + new Vector2(dir5 * width / 2 + 2, 0f)).ToTileCoordinates();
				if (WorldGen.SolidOrSlopedTile(point9.X, point9.Y) || WorldGen.SolidOrSlopedTile(point10.X, point10.Y))
				{
					velocity.X /= 2f;
				}
				dashDelay = -1;
			}
		}
	}

	private void SolarDashStart(int dashDirection)
	{
		solarDashing = true;
		solarDashConsumedFlare = false;
	}

	private void DoCommonDashHandle(out int dir, out bool dashing, DashStartAction dashStartAction = null)
	{
		dir = 0;
		dashing = false;
		if (dashTime > 0)
		{
			dashTime--;
		}
		if (dashTime < 0)
		{
			dashTime++;
		}
		if (controlRight && releaseRight)
		{
			if (dashTime > 0)
			{
				dir = 1;
				dashing = true;
				dashTime = 0;
				timeSinceLastDashStarted = 0;
				dashStartAction?.Invoke(dir);
			}
			else
			{
				dashTime = 15;
			}
		}
		else if (controlLeft && releaseLeft)
		{
			if (dashTime < 0)
			{
				dir = -1;
				dashing = true;
				dashTime = 0;
				timeSinceLastDashStarted = 0;
				dashStartAction?.Invoke(dir);
			}
			else
			{
				dashTime = -15;
			}
		}
	}

	public void WallClimbMovement()
	{
		bool flag = mount.Active && mount.Type == 55;
		if (!flag)
		{
			return;
		}
		sliding = false;
		if (slideDir == 0 || ((!controlLeft || slideDir != -1) && (!controlRight || slideDir != 1)))
		{
			return;
		}
		bool flag2 = false;
		float num = position.X;
		if (slideDir == 1)
		{
			num += (float)width;
		}
		num += (float)slideDir;
		float num2 = position.Y + (float)height + 1f;
		if (gravDir < 0f)
		{
			num2 = position.Y - 1f;
		}
		num /= 16f;
		num2 /= 16f;
		if (WorldGen.SolidTile((int)num, (int)num2))
		{
			flag2 = true;
		}
		bool flag3 = (controlDown && gravDir == -1f) || (controlUp && gravDir == 1f);
		bool flag4 = (controlDown && gravDir == 1f) || (controlUp && gravDir == -1f);
		if (spikedBoots >= 2)
		{
			if (!flag2 || (!(flag3 || flag4) && (!(velocity.Y > 0f) || gravDir != 1f) && (!(velocity.Y < gravity) || gravDir != -1f)))
			{
				return;
			}
			float num3 = gravity;
			if (slowFall)
			{
				num3 = ((!TryingToHoverUp) ? (gravity / 3f * gravDir) : (gravity / 10f * gravDir));
			}
			fallStart = (int)(position.Y / 16f);
			if (flag3)
			{
				velocity.Y = -3f * gravDir;
				if (!flag || !WorldGen.SolidTile((base.Center + new Vector2(0f, velocity.Y).SafeNormalize(Vector2.Zero) * 10f).ToTileCoordinates()))
				{
					int num4 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)((width / 2 - 4) * slideDir), position.Y + (float)(height / 2) + (float)(height / 2 - 4) * gravDir), 8, 8, 31);
					if (slideDir < 0)
					{
						Main.dust[num4].position.X -= 10f;
					}
					if (gravDir < 0f)
					{
						Main.dust[num4].position.Y -= 12f;
					}
					Main.dust[num4].velocity *= 0.1f;
					Main.dust[num4].scale *= 1.2f;
					Main.dust[num4].noGravity = true;
					Main.dust[num4].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
					if (flag)
					{
						Main.dust[num4].scale *= 0.5f;
					}
				}
			}
			else if (flag4)
			{
				velocity.Y = 4f * gravDir;
				if (!flag || !WorldGen.SolidTile((base.Center + new Vector2(0f, velocity.Y).SafeNormalize(Vector2.Zero) * 10f).ToTileCoordinates()))
				{
					int num5 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)((width / 2 - 4) * slideDir), position.Y + (float)(height / 2) + (float)(height / 2 - 4) * gravDir), 8, 8, 31);
					if (slideDir < 0)
					{
						Main.dust[num5].position.X -= 10f;
					}
					if (gravDir < 0f)
					{
						Main.dust[num5].position.Y -= 12f;
					}
					Main.dust[num5].velocity *= 0.1f;
					Main.dust[num5].scale *= 1.2f;
					Main.dust[num5].noGravity = true;
					Main.dust[num5].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
					if (flag)
					{
						Main.dust[num5].scale *= 0.5f;
					}
				}
			}
			else if (gravDir == -1f)
			{
				velocity.Y = (0f - num3 + 1E-05f) * gravDir;
			}
			else
			{
				velocity.Y = (0f - num3 + 1E-05f) * gravDir;
			}
			sliding = true;
		}
		else
		{
			if (!flag2 || (!(flag3 || flag4) && (!(velocity.Y > 0.5f) || gravDir != 1f) && (!(velocity.Y < -0.5f) || gravDir != -1f)))
			{
				return;
			}
			fallStart = (int)(position.Y / 16f);
			if (controlUp)
			{
				velocity.Y = -2f * gravDir;
			}
			else if (controlDown)
			{
				velocity.Y = 4f * gravDir;
			}
			else
			{
				velocity.Y = 0.5f * gravDir;
			}
			sliding = true;
			if (!flag || !WorldGen.SolidTile((base.Center + new Vector2(0f, velocity.Y).SafeNormalize(Vector2.Zero) * 10f).ToTileCoordinates()))
			{
				int num6 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)((width / 2 - 4) * slideDir), position.Y + (float)(height / 2) + (float)(height / 2 - 4) * gravDir), 8, 8, 31);
				if (slideDir < 0)
				{
					Main.dust[num6].position.X -= 10f;
				}
				if (gravDir < 0f)
				{
					Main.dust[num6].position.Y -= 12f;
				}
				Main.dust[num6].velocity *= 0.1f;
				Main.dust[num6].scale *= 1.2f;
				Main.dust[num6].noGravity = true;
				Main.dust[num6].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
				if (flag)
				{
					Main.dust[num6].scale *= 0.5f;
				}
			}
		}
	}

	public void WallslideMovement()
	{
		sliding = false;
		if (slideDir == 0 || spikedBoots <= 0 || mount.Active || ((!controlLeft || slideDir != -1) && (!controlRight || slideDir != 1)))
		{
			return;
		}
		bool flag = false;
		float num = position.X;
		if (slideDir == 1)
		{
			num += (float)width;
		}
		num += (float)slideDir;
		float num2 = position.Y + (float)height + 1f;
		if (gravDir < 0f)
		{
			num2 = position.Y - 1f;
		}
		num /= 16f;
		num2 /= 16f;
		if (WorldGen.SolidTile((int)num, (int)num2) && WorldGen.SolidTile((int)num, (int)num2 - 1))
		{
			flag = true;
		}
		if (spikedBoots >= 2)
		{
			if (!flag || ((!(velocity.Y > 0f) || gravDir != 1f) && (!(velocity.Y < gravity) || gravDir != -1f)))
			{
				return;
			}
			float num3 = gravity;
			if (slowFall)
			{
				num3 = ((!TryingToHoverUp) ? (gravity / 3f * gravDir) : (gravity / 10f * gravDir));
			}
			fallStart = (int)(position.Y / 16f);
			if ((controlDown && gravDir == 1f) || (controlUp && gravDir == -1f))
			{
				velocity.Y = 4f * gravDir;
				int num4 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)((width / 2 - 4) * slideDir), position.Y + (float)(height / 2) + (float)(height / 2 - 4) * gravDir), 8, 8, 31);
				if (slideDir < 0)
				{
					Main.dust[num4].position.X -= 10f;
				}
				if (gravDir < 0f)
				{
					Main.dust[num4].position.Y -= 12f;
				}
				Main.dust[num4].velocity *= 0.1f;
				Main.dust[num4].scale *= 1.2f;
				Main.dust[num4].noGravity = true;
				Main.dust[num4].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
			}
			else if (gravDir == -1f)
			{
				velocity.Y = (0f - num3 + 1E-05f) * gravDir;
			}
			else
			{
				velocity.Y = (0f - num3 + 1E-05f) * gravDir;
			}
			sliding = true;
		}
		else if ((flag && (double)velocity.Y > 0.5 && gravDir == 1f) || ((double)velocity.Y < -0.5 && gravDir == -1f))
		{
			fallStart = (int)(position.Y / 16f);
			if (controlDown)
			{
				velocity.Y = 4f * gravDir;
			}
			else
			{
				velocity.Y = 0.5f * gravDir;
			}
			sliding = true;
			int num5 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)((width / 2 - 4) * slideDir), position.Y + (float)(height / 2) + (float)(height / 2 - 4) * gravDir), 8, 8, 31);
			if (slideDir < 0)
			{
				Main.dust[num5].position.X -= 10f;
			}
			if (gravDir < 0f)
			{
				Main.dust[num5].position.Y -= 12f;
			}
			Main.dust[num5].velocity *= 0.1f;
			Main.dust[num5].scale *= 1.2f;
			Main.dust[num5].noGravity = true;
			Main.dust[num5].shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
		}
	}

	public void CarpetMovement()
	{
		bool flag = false;
		if (grappling[0] == -1 && carpet && !canJumpAgain_Cloud && !canJumpAgain_Sandstorm && !canJumpAgain_Blizzard && !canJumpAgain_Fart && !canJumpAgain_Sail && !canJumpAgain_Unicorn && !canJumpAgain_Santank && !canJumpAgain_WallOfFleshGoat && !canJumpAgain_Basilisk && jump == 0 && velocity.Y != 0f && rocketTime == 0 && wingTime == 0f && !mount.Active)
		{
			if (controlJump && canCarpet)
			{
				canCarpet = false;
				carpetTime = 300;
			}
			if (carpetTime > 0 && controlJump)
			{
				fallStart = (int)(position.Y / 16f);
				flag = true;
				carpetTime--;
				float num = gravity;
				if (gravDir == 1f && velocity.Y > 0f - num)
				{
					velocity.Y = 0f - (num + 1E-06f);
				}
				else if (gravDir == -1f && velocity.Y < num)
				{
					velocity.Y = num + 1E-06f;
				}
				carpetFrameCounter += 1f + Math.Abs(velocity.X * 0.5f);
				if (carpetFrameCounter > 8f)
				{
					carpetFrameCounter = 0f;
					carpetFrame++;
				}
				if (carpetFrame < 0)
				{
					carpetFrame = 0;
				}
				if (carpetFrame > 5)
				{
					carpetFrame = 0;
				}
			}
		}
		if (!flag)
		{
			carpetFrame = -1;
		}
		else
		{
			slowFall = false;
		}
	}

	public void DoubleJumpVisuals()
	{
		if (isPerformingJump_Cloud && hasJumpOption_Cloud && !canJumpAgain_Cloud && (canJumpAgain_Sandstorm || !hasJumpOption_Sandstorm) && ((gravDir == 1f && velocity.Y < 0f) || (gravDir == -1f && velocity.Y > 0f)))
		{
			int num = height;
			if (gravDir == -1f)
			{
				num = -6;
			}
			int num2 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)num), width + 8, 4, 16, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 100, default(Color), 1.5f);
			Main.dust[num2].velocity.X = Main.dust[num2].velocity.X * 0.5f - velocity.X * 0.1f;
			Main.dust[num2].velocity.Y = Main.dust[num2].velocity.Y * 0.5f - velocity.Y * 0.3f;
		}
		if (isPerformingJump_Sandstorm && hasJumpOption_Sandstorm && !canJumpAgain_Sandstorm && ((gravDir == 1f && velocity.Y < 0f) || (gravDir == -1f && velocity.Y > 0f)))
		{
			int num3 = height;
			if (gravDir == -1f)
			{
				num3 = -6;
			}
			float num4 = ((float)jump / 75f + 1f) / 2f;
			for (int i = 0; i < 3; i++)
			{
				int num5 = Dust.NewDust(new Vector2(position.X, position.Y + (float)(num3 / 2)), width, 32, 124, velocity.X * 0.3f, velocity.Y * 0.3f, 150, default(Color), 1f * num4);
				Main.dust[num5].velocity *= 0.5f * num4;
				Main.dust[num5].fadeIn = 1.5f * num4;
			}
			sandStorm = true;
			if (miscCounter % 3 == 0)
			{
				int num6 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 18f, position.Y + (float)(num3 / 2)), new Vector2(0f - velocity.X, 0f - velocity.Y), Main.rand.Next(220, 223), num4);
				Main.gore[num6].velocity = velocity * 0.3f * num4;
				Main.gore[num6].alpha = 100;
			}
		}
		if (isPerformingJump_Fart && hasJumpOption_Fart && !canJumpAgain_Fart && ((gravDir == 1f && velocity.Y < 0f) || (gravDir == -1f && velocity.Y > 0f)))
		{
			int num7 = height;
			if (gravDir == -1f)
			{
				num7 = -6;
			}
			int num8 = Dust.NewDust(new Vector2(position.X - 4f, position.Y + (float)num7), width + 8, 4, 188, (0f - velocity.X) * 0.5f, velocity.Y * 0.5f, 100, default(Color), 1.5f);
			Main.dust[num8].velocity.X = Main.dust[num8].velocity.X * 0.5f - velocity.X * 0.1f;
			Main.dust[num8].velocity.Y = Main.dust[num8].velocity.Y * 0.5f - velocity.Y * 0.3f;
			Main.dust[num8].velocity *= 0.5f;
		}
		if (isPerformingJump_Unicorn && hasJumpOption_Unicorn && !canJumpAgain_Unicorn && ((gravDir == 1f && velocity.Y < 0f) || (gravDir == -1f && velocity.Y > 0f)))
		{
			Dust obj = Main.dust[Dust.NewDust(position, width, height, Utils.SelectRandom<int>(Main.rand, 176, 177, 179))];
			obj.velocity = Vector2.Zero;
			obj.noGravity = true;
			obj.scale = 0.5f + Main.rand.NextFloat() * 0.8f;
			obj.fadeIn = 1f + Main.rand.NextFloat() * 2f;
			obj.shader = GameShaders.Armor.GetSecondaryShader(cMount, this);
		}
		if (isPerformingJump_Sail && hasJumpOption_Sail && !canJumpAgain_Sail && ((gravDir == 1f && velocity.Y < 1f) || (gravDir == -1f && velocity.Y > 1f)))
		{
			int num9 = 1;
			if (jump > 0)
			{
				num9 = 2;
			}
			int num10 = height - 6;
			if (gravDir == -1f)
			{
				num10 = 6;
			}
			for (int j = 0; j < num9; j++)
			{
				int num11 = Dust.NewDust(new Vector2(position.X, position.Y + (float)num10), width, 12, 253, velocity.X * 0.3f, velocity.Y * 0.3f, 100, default(Color), 1.5f);
				Main.dust[num11].scale += (float)Main.rand.Next(-5, 3) * 0.1f;
				if (jump <= 0)
				{
					Main.dust[num11].scale *= 0.8f;
				}
				else
				{
					Main.dust[num11].velocity -= velocity / 5f;
				}
				Main.dust[num11].noGravity = true;
				Vector2 vector = new Vector2(Main.rand.Next(-100, 101), Main.rand.Next(-100, 101));
				vector.Normalize();
				vector *= (float)Main.rand.Next(81) * 0.1f;
			}
		}
		if (!isPerformingJump_Blizzard || !hasJumpOption_Blizzard || canJumpAgain_Blizzard || ((gravDir != 1f || !(velocity.Y < 0f)) && (gravDir != -1f || !(velocity.Y > 0f))))
		{
			return;
		}
		int num12 = height - 6;
		if (gravDir == -1f)
		{
			num12 = 6;
		}
		for (int k = 0; k < 2; k++)
		{
			int num13 = Dust.NewDust(new Vector2(position.X, position.Y + (float)num12), width, 12, 76, velocity.X * 0.3f, velocity.Y * 0.3f);
			Main.dust[num13].velocity *= 0.1f;
			if (k == 0)
			{
				Main.dust[num13].velocity += velocity * 0.03f;
			}
			else
			{
				Main.dust[num13].velocity -= velocity * 0.03f;
			}
			Main.dust[num13].velocity -= velocity * 0.1f;
			Main.dust[num13].noGravity = true;
			Main.dust[num13].noLight = true;
		}
		for (int l = 0; l < 3; l++)
		{
			int num14 = Dust.NewDust(new Vector2(position.X, position.Y + (float)num12), width, 12, 76, velocity.X * 0.3f, velocity.Y * 0.3f);
			Main.dust[num14].fadeIn = 1.5f;
			Main.dust[num14].velocity *= 0.6f;
			Main.dust[num14].velocity += velocity * 0.8f;
			Main.dust[num14].noGravity = true;
			Main.dust[num14].noLight = true;
		}
		for (int m = 0; m < 3; m++)
		{
			int num15 = Dust.NewDust(new Vector2(position.X, position.Y + (float)num12), width, 12, 76, velocity.X * 0.3f, velocity.Y * 0.3f);
			Main.dust[num15].fadeIn = 1.5f;
			Main.dust[num15].velocity *= 0.6f;
			Main.dust[num15].velocity -= velocity * 0.8f;
			Main.dust[num15].noGravity = true;
			Main.dust[num15].noLight = true;
		}
	}

	public void WingMovement()
	{
		if (wingsLogic == 4 && TryingToHoverUp)
		{
			velocity.Y -= 0.2f * gravDir;
			if (gravDir == 1f)
			{
				if (velocity.Y > 0f)
				{
					velocity.Y -= 1f;
				}
				else if (velocity.Y > 0f - jumpSpeed)
				{
					velocity.Y -= 0.2f;
				}
				if (velocity.Y < (0f - jumpSpeed) * 3f)
				{
					velocity.Y = (0f - jumpSpeed) * 3f;
				}
			}
			else
			{
				if (velocity.Y < 0f)
				{
					velocity.Y += 1f;
				}
				else if (velocity.Y < jumpSpeed)
				{
					velocity.Y += 0.2f;
				}
				if (velocity.Y > jumpSpeed * 3f)
				{
					velocity.Y = jumpSpeed * 3f;
				}
			}
			wingTime -= 2f;
		}
		else
		{
			float num = 0.1f;
			float num2 = 0.5f;
			float num3 = 1.5f;
			float num4 = 0.5f;
			float num5 = 0.1f;
			if (wingsLogic == 26)
			{
				num2 = 0.75f;
				num5 = 0.15f;
				num4 = 1f;
				num3 = 2.5f;
				num = 0.125f;
			}
			if (wingsLogic == 8 || wingsLogic == 11 || wingsLogic == 24 || wingsLogic == 27 || wingsLogic == 22)
			{
				num3 = 1.66f;
			}
			if (wingsLogic == 21 || wingsLogic == 12 || wingsLogic == 20 || wingsLogic == 23)
			{
				num3 = 1.805f;
			}
			if (wingsLogic == 37)
			{
				num2 = 0.75f;
				num5 = 0.15f;
				num4 = 1f;
				num3 = 2.5f;
				num = 0.125f;
			}
			if (wingsLogic == 44)
			{
				num2 = 0.85f;
				num5 = 0.15f;
				num4 = 1f;
				num3 = 2.75f;
				num = 0.125f;
				if (TryingToHoverUp)
				{
					velocity.Y -= 0.4f * gravDir;
					if (gravDir == 1f)
					{
						if (velocity.Y > 0f)
						{
							velocity.Y -= 1f;
						}
						else if (velocity.Y > 0f - jumpSpeed)
						{
							velocity.Y -= 0.2f;
						}
						if (velocity.Y < (0f - jumpSpeed) * 3f)
						{
							velocity.Y = (0f - jumpSpeed) * 3f;
						}
					}
					else
					{
						if (velocity.Y < 0f)
						{
							velocity.Y += 1f;
						}
						else if (velocity.Y < jumpSpeed)
						{
							velocity.Y += 0.2f;
						}
						if (velocity.Y > jumpSpeed * 3f)
						{
							velocity.Y = jumpSpeed * 3f;
						}
					}
				}
				if (TryingToHoverDown && !controlJump && velocity.Y != 0f)
				{
					velocity.Y += 0.4f;
				}
			}
			if (wingsLogic == 45)
			{
				num2 = 0.95f;
				num5 = 0.15f;
				num4 = 1f;
				num3 = 4.5f;
				if (TryingToHoverUp)
				{
					velocity.Y -= 0.4f * gravDir;
					if (gravDir == 1f)
					{
						if (velocity.Y > 0f)
						{
							velocity.Y -= 1f;
						}
						else if (velocity.Y > 0f - jumpSpeed)
						{
							velocity.Y -= 0.2f;
						}
						if (velocity.Y < (0f - jumpSpeed) * 3f)
						{
							velocity.Y = (0f - jumpSpeed) * 3f;
						}
					}
					else
					{
						if (velocity.Y < 0f)
						{
							velocity.Y += 1f;
						}
						else if (velocity.Y < jumpSpeed)
						{
							velocity.Y += 0.2f;
						}
						if (velocity.Y > jumpSpeed * 3f)
						{
							velocity.Y = jumpSpeed * 3f;
						}
					}
				}
				if (TryingToHoverDown && !controlJump && velocity.Y != 0f)
				{
					velocity.Y += 0.4f;
				}
			}
			if (wingsLogic == 29 || wingsLogic == 32)
			{
				num2 = 0.85f;
				num5 = 0.15f;
				num4 = 1f;
				num3 = 3f;
				num = 0.135f;
			}
			if (wingsLogic == 30 || wingsLogic == 31)
			{
				num4 = 1f;
				num3 = 2.45f;
				if (!TryingToHoverDown)
				{
					num = 0.15f;
				}
			}
			velocity.Y -= num * gravDir;
			if (gravDir == 1f)
			{
				if (velocity.Y > 0f)
				{
					velocity.Y -= num2;
				}
				else if (velocity.Y > (0f - jumpSpeed) * num4)
				{
					velocity.Y -= num5;
				}
				if (velocity.Y < (0f - jumpSpeed) * num3)
				{
					velocity.Y = (0f - jumpSpeed) * num3;
				}
			}
			else
			{
				if (velocity.Y < 0f)
				{
					velocity.Y += num2;
				}
				else if (velocity.Y < jumpSpeed * num4)
				{
					velocity.Y += num5;
				}
				if (velocity.Y > jumpSpeed * num3)
				{
					velocity.Y = jumpSpeed * num3;
				}
			}
			if ((wingsLogic == 22 || wingsLogic == 28 || wingsLogic == 30 || wingsLogic == 31 || wingsLogic == 37 || wingsLogic == 45) && TryingToHoverDown && !controlLeft && !controlRight)
			{
				wingTime -= 0.5f;
			}
			else
			{
				wingTime -= 1f;
			}
		}
		if (empressBrooch && wingTime != 0f)
		{
			wingTime = wingTimeMax;
		}
	}

	public void MoonLeechRope()
	{
		int num = -1;
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].active && Main.projectile[i].type == 456 && Main.projectile[i].ai[1] == (float)whoAmI)
			{
				num = i;
				break;
			}
		}
		if (num != -1 && !(Main.projectile[num].ai[0] < 0f))
		{
			Projectile projectile = Main.projectile[num];
			Vector2 vector = new Vector2(0f, 216f);
			Vector2 value = Main.npc[(int)Math.Abs(projectile.ai[0]) - 1].Center - base.Center + vector;
			if (value.Length() > 200f)
			{
				Vector2 vector2 = Vector2.Normalize(value);
				position += vector2 * (value.Length() - 200f);
			}
		}
	}

	public void WOFTongue()
	{
		if (Main.wofNPCIndex < 0 || !Main.npc[Main.wofNPCIndex].active)
		{
			return;
		}
		float num = Main.npc[Main.wofNPCIndex].position.X + 40f;
		if (Main.npc[Main.wofNPCIndex].direction > 0)
		{
			num -= 96f;
		}
		if (position.X + (float)width > num && position.X < num + 140f && gross)
		{
			noKnockback = false;
			int attackDamage_ScaledByDifficulty = Main.npc[Main.wofNPCIndex].GetAttackDamage_ScaledByDifficulty(50f);
			Hurt(PlayerDeathReason.LegacyDefault(), attackDamage_ScaledByDifficulty, Main.npc[Main.wofNPCIndex].direction);
		}
		if (!gross && position.Y > (float)((Main.maxTilesY - 250) * 16) && position.X > num - (float)Main.MaxWorldViewSize.X && position.X < num + (float)Main.MaxWorldViewSize.X)
		{
			AddBuff(37, 10);
			SoundEngine.PlaySound(4, (int)Main.npc[Main.wofNPCIndex].position.X, (int)Main.npc[Main.wofNPCIndex].position.Y, 10);
		}
		if (gross)
		{
			if (position.Y < (float)(Main.UnderworldLayer * 16))
			{
				AddBuff(38, 10);
			}
			if (Main.npc[Main.wofNPCIndex].direction < 0)
			{
				if (position.X + (float)(width / 2) > Main.npc[Main.wofNPCIndex].position.X + (float)(Main.npc[Main.wofNPCIndex].width / 2) + 40f)
				{
					AddBuff(38, 10);
				}
			}
			else if (position.X + (float)(width / 2) < Main.npc[Main.wofNPCIndex].position.X + (float)(Main.npc[Main.wofNPCIndex].width / 2) - 40f)
			{
				AddBuff(38, 10);
			}
		}
		if (!tongued)
		{
			return;
		}
		controlHook = false;
		controlUseItem = false;
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].active && Main.projectile[i].owner == Main.myPlayer && Main.projectile[i].aiStyle == 7)
			{
				Main.projectile[i].Kill();
			}
		}
		Vector2 center = base.Center;
		float num2 = Main.npc[Main.wofNPCIndex].position.X + (float)(Main.npc[Main.wofNPCIndex].width / 2) - center.X;
		float num3 = Main.npc[Main.wofNPCIndex].position.Y + (float)(Main.npc[Main.wofNPCIndex].height / 2) - center.Y;
		if ((float)Math.Sqrt(num2 * num2 + num3 * num3) > 3000f)
		{
			KillMe(PlayerDeathReason.ByOther(11), 1000.0, 0);
		}
		else if (Main.npc[Main.wofNPCIndex].position.X < 608f || Main.npc[Main.wofNPCIndex].position.X > (float)((Main.maxTilesX - 38) * 16))
		{
			KillMe(PlayerDeathReason.ByOther(12), 1000.0, 0);
		}
	}

	public void StatusFromNPC(NPC npc)
	{
		if (Main.expertMode && ((npc.type == 266 && Main.rand.Next(3) == 0) || npc.type == 267))
		{
			int num = Main.rand.Next(9);
			if (num == 2 || num == 4)
			{
				num = Main.rand.Next(9);
			}
			float num2 = (float)Main.rand.Next(75, 150) * 0.01f;
			switch (num)
			{
			case 0:
				AddBuff(20, (int)(60f * num2 * 3.5f));
				break;
			case 1:
				AddBuff(22, (int)(60f * num2 * 2f));
				break;
			case 2:
				AddBuff(23, (int)(60f * num2 * 0.5f));
				break;
			case 3:
				AddBuff(30, (int)(60f * num2 * 10f));
				break;
			case 4:
				AddBuff(31, (int)(60f * num2 * 1f));
				break;
			case 5:
				AddBuff(32, (int)(60f * num2 * 3.5f));
				break;
			case 6:
				AddBuff(33, (int)(60f * num2 * 7.5f));
				break;
			case 7:
				AddBuff(35, (int)(60f * num2 * 1f));
				break;
			case 8:
				AddBuff(36, (int)((double)(60f * num2) * 6.5));
				break;
			}
		}
		if (NPCID.Sets.SlimeCanContainItems[npc.type] && npc.ai[1] > 0f)
		{
			if (npc.ai[1] == 364f || npc.ai[1] == 1104f || npc.ai[1] == 365f || npc.ai[1] == 1105f || npc.ai[1] == 366f || npc.ai[1] == 1106f)
			{
				int num3 = Main.rand.Next(7);
				if (num3 == 0)
				{
					num3 = 31;
				}
				if (num3 == 1)
				{
					num3 = 35;
				}
				if (num3 == 2)
				{
					num3 = 23;
				}
				if (num3 == 3)
				{
					num3 = 32;
				}
				if (num3 == 4)
				{
					num3 = 80;
				}
				if (num3 == 5)
				{
					num3 = 33;
				}
				if (num3 == 6)
				{
					num3 = 36;
				}
				AddBuff(num3, Main.rand.Next(60, 301));
				return;
			}
			if (npc.ai[1] == 3f)
			{
				AddBuff(156, Main.rand.Next(30, 60));
			}
			else if (npc.ai[1] == 150f)
			{
				AddBuff(149, Main.rand.Next(30, 60));
			}
			else if (npc.ai[1] == 147f)
			{
				AddBuff(30, Main.rand.Next(600, 1200));
			}
			else if (npc.ai[1] == 8f && Main.getGoodWorld)
			{
				AddBuff(24, Main.rand.Next(180, 300));
			}
			else if (npc.ai[1] == 5395f)
			{
				int num4 = Main.rand.Next(300, 600);
				AddBuff(120, num4);
				if (Main.expertMode)
				{
					num4 /= 2;
				}
				AddBuff(20, num4);
			}
			else if (npc.ai[1] == 174f)
			{
				AddBuff(67, Main.rand.Next(60, 180));
			}
			else if (npc.ai[1] == 1103f)
			{
				AddBuff(44, Main.rand.Next(180, 360));
			}
			else if (npc.ai[1] == 593f)
			{
				AddBuff(44, Main.rand.Next(180, 360));
			}
			else if (npc.ai[1] == 3347f)
			{
				AddBuff(23, Main.rand.Next(60, 300));
			}
		}
		if (npc.type == 530 || npc.type == 531)
		{
			AddBuff(70, Main.rand.Next(240, 241));
		}
		if (npc.type == 159 || npc.type == 158)
		{
			AddBuff(30, Main.rand.Next(600, 1200));
		}
		if (npc.type == 525)
		{
			AddBuff(39, 240);
		}
		if (npc.type == 526)
		{
			AddBuff(69, 420);
		}
		if (npc.type == 527)
		{
			AddBuff(31, 840);
		}
		if (Main.expertMode && (npc.type == 49 || npc.type == 93 || npc.type == 51 || npc.type == 152 || npc.type == 634) && Main.rand.Next(10) == 0)
		{
			AddBuff(148, Main.rand.Next(1800, 5400));
		}
		if (Main.expertMode && npc.type == 222)
		{
			AddBuff(20, Main.rand.Next(60, 240));
		}
		if (Main.expertMode && (npc.type == 210 || npc.type == 211))
		{
			AddBuff(20, Main.rand.Next(60, 180));
		}
		if (Main.expertMode && npc.type == 35)
		{
			AddBuff(30, Main.rand.Next(360, 600));
		}
		if (Main.expertMode && npc.type == 36 && Main.rand.Next(2) == 0)
		{
			AddBuff(32, Main.rand.Next(30, 60));
		}
		if (npc.type >= 269 && npc.type <= 272)
		{
			if (Main.rand.Next(3) == 0)
			{
				AddBuff(30, 1200);
			}
			else if (Main.rand.Next(3) == 0)
			{
				AddBuff(32, 300);
			}
		}
		if (npc.type >= 273 && npc.type <= 276 && Main.rand.Next(2) == 0)
		{
			AddBuff(36, 600);
		}
		if (npc.type >= 277 && npc.type <= 280)
		{
			AddBuff(24, 600);
		}
		if (npc.type == 371)
		{
			AddBuff(103, 60 * Main.rand.Next(3, 8));
		}
		if (npc.type == 370 && Main.expertMode)
		{
			int num5 = Utils.SelectRandom<int>(Main.rand, 0, 148, 30);
			if (num5 != 0)
			{
				AddBuff(num5, 60 * Main.rand.Next(6, 21));
			}
		}
		if (((npc.type == 1 && npc.netID == -6) || npc.type == 81 || npc.type == 79 || npc.type == 183 || npc.type == 630) && Main.rand.Next(4) == 0)
		{
			AddBuff(22, 900);
		}
		if ((npc.type == 23 || npc.type == 25) && Main.rand.Next(3) == 0)
		{
			AddBuff(24, 420);
		}
		if ((npc.type == 34 || npc.type == 83 || npc.type == 84 || npc.type == 179 || npc.type == 289) && Main.rand.Next(3) == 0)
		{
			AddBuff(23, 240);
		}
		if ((npc.type == 104 || npc.type == 102) && Main.rand.Next(5) == 0)
		{
			AddBuff(30, 2700);
		}
		if (npc.type == 75 && Main.rand.Next(10) == 0)
		{
			AddBuff(35, 420);
		}
		if ((npc.type == 163 || npc.type == 238 || npc.type == 236 || npc.type == 237) && Main.rand.Next(10) == 0)
		{
			AddBuff(70, 240);
		}
		if ((npc.type == 79 || npc.type == 103 || npc.type == 630) && Main.rand.Next(5) == 0)
		{
			AddBuff(35, 420);
		}
		if ((npc.type == 75 || npc.type == 78 || npc.type == 82) && Main.rand.Next(8) == 0)
		{
			AddBuff(32, 900);
		}
		if ((npc.type == 93 || npc.type == 109 || npc.type == 80) && Main.rand.Next(14) == 0)
		{
			AddBuff(31, 300);
		}
		if (npc.type >= 305 && npc.type <= 314 && Main.rand.Next(10) == 0)
		{
			AddBuff(33, 3600);
		}
		if (npc.type == 77 && Main.rand.Next(6) == 0)
		{
			AddBuff(36, 7200);
		}
		if (npc.type == 112 && Main.rand.Next(20) == 0)
		{
			AddBuff(33, 18000);
		}
		if (npc.type == 182 && Main.rand.Next(25) == 0)
		{
			AddBuff(33, 7200);
		}
		if (npc.type == 141 && Main.rand.Next(2) == 0)
		{
			AddBuff(20, 600);
		}
		if (npc.type == 147 && !frozen && Main.rand.Next(12) == 0)
		{
			AddBuff(46, 600);
		}
		if (npc.type == 150)
		{
			if (Main.rand.Next(2) == 0)
			{
				AddBuff(46, 900);
			}
			if (!frozen && Main.rand.Next(35) == 0)
			{
				AddBuff(47, 60);
			}
			else if (!frozen && Main.expertMode && Main.rand.Next(35) == 0)
			{
				AddBuff(47, 60);
			}
		}
		if (npc.type == 184)
		{
			AddBuff(46, 1200);
			if (!frozen && Main.rand.Next(15) == 0)
			{
				AddBuff(47, 60);
			}
			else if (!frozen && Main.expertMode && Main.rand.Next(25) == 0)
			{
				AddBuff(47, 60);
			}
		}
	}

	public void GrappleMovement()
	{
		if (grappling[0] < 0)
		{
			return;
		}
		StopVanityActions();
		if (Main.myPlayer == whoAmI && mount.Active && !MountID.Sets.CanUseHooks[mount.Type])
		{
			mount.TryDismount(this);
		}
		canCarpet = true;
		carpetFrame = -1;
		wingFrame = 1;
		bool flag = velocity.Length() < 2f;
		bool flag2 = wet && (double)velocity.Y > -0.02 && (double)velocity.Y < 0.02;
		if (flag2 || flag || velocity.Y == 0f)
		{
			wingFrame = 0;
		}
		if (wings == 4)
		{
			wingFrame = 3;
		}
		if (wings == 30)
		{
			wingFrame = 0;
		}
		RefreshMovementAbilities();
		rocketFrame = false;
		canRocket = false;
		rocketRelease = false;
		fallStart = (int)(position.Y / 16f);
		int num = -1;
		for (int i = 0; i < grapCount; i++)
		{
			if (Main.projectile[grappling[i]].type == 403)
			{
				num = i;
			}
		}
		GetGrapplingForces(base.Center, out var preferredPlayerDirectionToSet, out var preferedPlayerVelocityX, out var preferedPlayerVelocityY);
		if (preferedPlayerVelocityY > 0f)
		{
			GoingDownWithGrapple = true;
		}
		bool flag3 = preferedPlayerVelocityY > 0f && velocity.Y == 0f;
		velocity.X = preferedPlayerVelocityX;
		velocity.Y = preferedPlayerVelocityY;
		if (num != -1)
		{
			Projectile projectile = Main.projectile[grappling[num]];
			if (projectile.position.X < position.X + (float)width && projectile.position.X + (float)projectile.width >= position.X && projectile.position.Y < position.Y + (float)height && projectile.position.Y + (float)projectile.height >= position.Y)
			{
				int num2 = (int)(projectile.position.X + (float)(projectile.width / 2)) / 16;
				int num3 = (int)(projectile.position.Y + (float)(projectile.height / 2)) / 16;
				velocity = Vector2.Zero;
				if (Main.tile[num2, num3].type == 314)
				{
					Vector2 Position = default(Vector2);
					Position.X = projectile.position.X + (float)(projectile.width / 2) - (float)(width / 2);
					Position.Y = projectile.position.Y + (float)(projectile.height / 2) - (float)(height / 2);
					RemoveAllGrapplingHooks();
					int num4 = 13;
					if (miscEquips[2].stack > 0 && miscEquips[2].mountType >= 0 && MountID.Sets.Cart[miscEquips[2].mountType] && (!miscEquips[2].expertOnly || Main.expertMode))
					{
						num4 = miscEquips[2].mountType;
					}
					int num5 = height + Mount.GetHeightBoost(num4);
					if (Minecart.GetOnTrack(num2, num3, ref Position, width, num5, MinecartSettings) && !Collision.SolidCollision(Position, width, num5 - 20))
					{
						position = Position;
						DelegateMethods.Minecart.rotation = fullRotation;
						DelegateMethods.Minecart.rotationOrigin = fullRotationOrigin;
						mount.SetMount(num4, this);
						Minecart.WheelSparks(mount.Delegations.MinecartDust, position, width, height, 25, MinecartSettings);
					}
				}
			}
		}
		if (itemAnimation == 0)
		{
			if (velocity.X == 0f && preferredPlayerDirectionToSet.HasValue)
			{
				ChangeDir(preferredPlayerDirectionToSet.Value);
			}
			if (velocity.X > 0f)
			{
				ChangeDir(1);
			}
			if (velocity.X < 0f)
			{
				ChangeDir(-1);
			}
		}
		if (controlJump)
		{
			if (releaseJump)
			{
				bool flag4 = flag2 || flag;
				if (controlDown)
				{
					flag4 = false;
				}
				if (flag3 && !controlUp)
				{
					flag4 = false;
				}
				if (flag4)
				{
					velocity.Y = 0f - jumpSpeed;
					jump = jumpHeight;
					releaseJump = false;
				}
				else
				{
					velocity.Y += 0.01f;
					releaseJump = false;
				}
				RefreshDoubleJumps();
				RemoveAllGrapplingHooks();
			}
		}
		else
		{
			releaseJump = true;
		}
	}

	public void DoQueenSlimeHookTeleport(Vector2 targetPosition)
	{
		int num = 150;
		Vector2 vector = position;
		Vector2 vector2 = velocity;
		for (int i = 0; i < num; i++)
		{
			vector2 = (vector + base.Size / 2f).DirectionTo(targetPosition).SafeNormalize(Vector2.Zero) * 12f;
			Vector2 vector3 = TileCollision(vector, vector2, fallThrough: true, ignorePlats: true);
			vector += vector3;
		}
		int num2 = 10;
		_ = vector - position;
		Teleport(vector, num2);
		NetMessage.SendData(65, -1, -1, null, 0, whoAmI, vector.X, vector.Y, num2);
	}

	private void GetGrapplingForces(Vector2 fromPosition, out int? preferredPlayerDirectionToSet, out float preferedPlayerVelocityX, out float preferedPlayerVelocityY)
	{
		float num = 0f;
		float num2 = 0f;
		preferredPlayerDirectionToSet = null;
		int num3 = 0;
		for (int i = 0; i < grapCount; i++)
		{
			Projectile projectile = Main.projectile[grappling[i]];
			if (projectile.ai[0] != 2f || projectile.position.HasNaNs())
			{
				continue;
			}
			num += projectile.position.X + (float)(projectile.width / 2);
			num2 += projectile.position.Y + (float)(projectile.height / 2);
			num3++;
			if (projectile.type == 446)
			{
				Vector2 vector = new Vector2(controlRight.ToInt() - controlLeft.ToInt(), (float)(controlDown.ToInt() - controlUp.ToInt()) * gravDir);
				if (vector != Vector2.Zero)
				{
					vector.Normalize();
				}
				vector *= 100f;
				Vector2 vec = Vector2.Normalize(base.Center - projectile.Center + vector);
				if (vec.HasNaNs())
				{
					vec = -Vector2.UnitY;
				}
				float num4 = 200f;
				num += vec.X * num4;
				num2 += vec.Y * num4;
			}
			else if (projectile.type == 652)
			{
				Vector2 vector2 = new Vector2(controlRight.ToInt() - controlLeft.ToInt(), (float)(controlDown.ToInt() - controlUp.ToInt()) * gravDir).SafeNormalize(Vector2.Zero);
				Vector2 vector3 = projectile.Center - base.Center;
				Vector2 vector4 = vector3.SafeNormalize(Vector2.Zero);
				Vector2 value = Vector2.Zero;
				if (vector2 != Vector2.Zero)
				{
					value = vector4 * Vector2.Dot(vector4, vector2);
				}
				float num5 = 6f;
				if (Vector2.Dot(value, vector3) < 0f && vector3.Length() >= 600f)
				{
					num5 = 0f;
				}
				num += 0f - vector3.X + value.X * num5;
				num2 += 0f - vector3.Y + value.Y * num5;
			}
			else if (projectile.type == 865)
			{
				Vector2 vector5 = (projectile.rotation - (float)Math.PI / 2f).ToRotationVector2().SafeNormalize(Vector2.UnitY);
				Vector2 vector6 = -vector5 * 28f;
				num += vector6.X;
				num2 += vector6.Y;
				if (vector5.X != 0f)
				{
					preferredPlayerDirectionToSet = Math.Sign(vector5.X);
				}
			}
		}
		if (num3 == 0)
		{
			preferedPlayerVelocityX = velocity.X;
			preferedPlayerVelocityY = velocity.Y;
			return;
		}
		float num6 = num / (float)num3;
		float num7 = num2 / (float)num3;
		Vector2 vector7 = fromPosition;
		preferedPlayerVelocityX = num6 - vector7.X;
		preferedPlayerVelocityY = num7 - vector7.Y;
		float num8 = (float)Math.Sqrt(preferedPlayerVelocityX * preferedPlayerVelocityX + preferedPlayerVelocityY * preferedPlayerVelocityY);
		float num9 = 11f;
		if (Main.projectile[grappling[0]].type == 315)
		{
			num9 = 14f;
		}
		if (Main.projectile[grappling[0]].type == 487)
		{
			num9 = 12f;
		}
		if (Main.projectile[grappling[0]].type >= 646 && Main.projectile[grappling[0]].type <= 649)
		{
			num9 = 16f;
		}
		float num10 = num8;
		num10 = ((!(num8 > num9)) ? 1f : (num9 / num8));
		preferedPlayerVelocityX *= num10;
		preferedPlayerVelocityY *= num10;
	}

	private void RefreshMovementAbilities(bool doubleJumps = true)
	{
		wingTime = wingTimeMax;
		rocketTime = rocketTimeMax;
		rocketDelay = 0;
		if (doubleJumps)
		{
			RefreshDoubleJumps();
		}
	}

	private void RefreshDoubleJumps()
	{
		isPerformingJump_DownDash = false;
		if (hasJumpOption_Cloud)
		{
			canJumpAgain_Cloud = true;
		}
		if (hasJumpOption_Sandstorm)
		{
			canJumpAgain_Sandstorm = true;
		}
		if (hasJumpOption_Blizzard)
		{
			canJumpAgain_Blizzard = true;
		}
		if (hasJumpOption_Fart)
		{
			canJumpAgain_Fart = true;
		}
		if (hasJumpOption_Sail)
		{
			canJumpAgain_Sail = true;
		}
		if (hasJumpOption_Unicorn)
		{
			canJumpAgain_Unicorn = true;
		}
		if (hasJumpOption_Santank)
		{
			canJumpAgain_Santank = true;
		}
		if (hasJumpOption_WallOfFleshGoat)
		{
			canJumpAgain_WallOfFleshGoat = true;
		}
		if (hasJumpOption_Basilisk)
		{
			canJumpAgain_Basilisk = true;
		}
	}

	public void StickyMovement()
	{
		if (shimmering)
		{
			return;
		}
		bool flag = false;
		bool flag2 = false;
		if (mount.Active && mount.Type > 0 && MountID.Sets.Cart[mount.Type] && Math.Abs(velocity.X) > 5f)
		{
			flag = true;
		}
		if ((mount.Active && mount.Type == 56) || mount.Type == 61)
		{
			flag2 = true;
		}
		int num = width / 2;
		int num2 = height / 2;
		new Vector2(position.X + (float)(width / 2) - (float)(num / 2), position.Y + (float)(height / 2) - (float)(num2 / 2));
		Vector2 vector = new Vector2(0f, gravDir * 0.01f);
		Vector2 vector2 = Collision.StickyTiles(position - vector, velocity, width, height);
		if (vector2.Y != -1f && vector2.X != -1f)
		{
			int num3 = (int)vector2.X;
			int num4 = (int)vector2.Y;
			int type = Main.tile[num3, num4].type;
			if (whoAmI == Main.myPlayer && type == 51 && (velocity.X != 0f || velocity.Y != 0f))
			{
				stickyBreak++;
				int minValue = 20;
				int maxValue = 100;
				if (flag2)
				{
					minValue = 80;
					maxValue = 300;
				}
				if (stickyBreak > Main.rand.Next(minValue, maxValue) || flag)
				{
					stickyBreak = 0;
					WorldGen.KillTile(num3, num4);
					if (Main.netMode == 1 && !Main.tile[num3, num4].active() && Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, num3, num4);
					}
				}
			}
			if (flag)
			{
				return;
			}
			fallStart = (int)(position.Y / 16f);
			if (type != 229)
			{
				jump = 0;
			}
			if (flag2)
			{
				velocity *= 0.5f;
				if (velocity.Length() < 0.0025f)
				{
					velocity = velocity.SafeNormalize(Vector2.Zero) * 0.0025f;
				}
			}
			else
			{
				if (velocity.X > 1f)
				{
					velocity.X = 1f;
				}
				if (velocity.X < -1f)
				{
					velocity.X = -1f;
				}
				if ((double)velocity.X > 0.75 || (double)velocity.X < -0.75)
				{
					velocity.X *= 0.85f;
				}
				else
				{
					velocity.X *= 0.6f;
				}
				if (gravDir == -1f)
				{
					if (velocity.Y < -1f)
					{
						velocity.Y = -1f;
					}
					if (velocity.Y > 5f)
					{
						velocity.Y = 5f;
					}
					if (velocity.Y > 0f)
					{
						velocity.Y *= 0.96f;
					}
					else
					{
						velocity.Y *= 0.3f;
					}
				}
				else
				{
					if (velocity.Y > 1f)
					{
						velocity.Y = 1f;
					}
					if (velocity.Y < -5f)
					{
						velocity.Y = -5f;
					}
					if (velocity.Y < 0f)
					{
						velocity.Y *= 0.96f;
					}
					else
					{
						velocity.Y *= 0.3f;
					}
				}
			}
			if (type != 229 || Main.rand.Next(5) != 0 || (!((double)velocity.Y > 0.15) && !(velocity.Y < 0f)))
			{
				return;
			}
			if ((float)(num3 * 16) < position.X + (float)(width / 2))
			{
				int num5 = Dust.NewDust(new Vector2(position.X - 4f, num4 * 16), 4, 16, 153, 0f, 0f, 50);
				Main.dust[num5].scale += (float)Main.rand.Next(0, 6) * 0.1f;
				Main.dust[num5].velocity *= 0.1f;
				Main.dust[num5].noGravity = true;
			}
			else
			{
				int num6 = Dust.NewDust(new Vector2(position.X + (float)width - 2f, num4 * 16), 4, 16, 153, 0f, 0f, 50);
				Main.dust[num6].scale += (float)Main.rand.Next(0, 6) * 0.1f;
				Main.dust[num6].velocity *= 0.1f;
				Main.dust[num6].noGravity = true;
			}
			if (Main.tile[num3, num4 + 1] != null && Main.tile[num3, num4 + 1].type == 229 && position.Y + (float)height > (float)((num4 + 1) * 16))
			{
				if ((float)(num3 * 16) < position.X + (float)(width / 2))
				{
					int num7 = Dust.NewDust(new Vector2(position.X - 4f, num4 * 16 + 16), 4, 16, 153, 0f, 0f, 50);
					Main.dust[num7].scale += (float)Main.rand.Next(0, 6) * 0.1f;
					Main.dust[num7].velocity *= 0.1f;
					Main.dust[num7].noGravity = true;
				}
				else
				{
					int num8 = Dust.NewDust(new Vector2(position.X + (float)width - 2f, num4 * 16 + 16), 4, 16, 153, 0f, 0f, 50);
					Main.dust[num8].scale += (float)Main.rand.Next(0, 6) * 0.1f;
					Main.dust[num8].velocity *= 0.1f;
					Main.dust[num8].noGravity = true;
				}
			}
			if (Main.tile[num3, num4 + 2] != null && Main.tile[num3, num4 + 2].type == 229 && position.Y + (float)height > (float)((num4 + 2) * 16))
			{
				if ((float)(num3 * 16) < position.X + (float)(width / 2))
				{
					int num9 = Dust.NewDust(new Vector2(position.X - 4f, num4 * 16 + 32), 4, 16, 153, 0f, 0f, 50);
					Main.dust[num9].scale += (float)Main.rand.Next(0, 6) * 0.1f;
					Main.dust[num9].velocity *= 0.1f;
					Main.dust[num9].noGravity = true;
				}
				else
				{
					int num10 = Dust.NewDust(new Vector2(position.X + (float)width - 2f, num4 * 16 + 32), 4, 16, 153, 0f, 0f, 50);
					Main.dust[num10].scale += (float)Main.rand.Next(0, 6) * 0.1f;
					Main.dust[num10].velocity *= 0.1f;
					Main.dust[num10].noGravity = true;
				}
			}
		}
		else
		{
			stickyBreak = 0;
		}
	}

	public bool HasLockedInventory()
	{
		if (!IsStackingItems())
		{
			return Main.LocalPlayerHasPendingInventoryActions();
		}
		return true;
	}

	public bool IsLockedFromCrafting()
	{
		return IsStackingItems();
	}

	public bool IsStackingItems()
	{
		for (int i = 0; i < inventoryChestStack.Length; i++)
		{
			if (inventoryChestStack[i])
			{
				if (inventory[i].type != 0 && inventory[i].stack != 0)
				{
					return true;
				}
				inventoryChestStack[i] = false;
			}
		}
		if (disableVoidBag >= 0)
		{
			return true;
		}
		return false;
	}

	public void LockNetSlot(int slot)
	{
		if (slot >= PlayerItemSlotID.Bank4_0)
		{
			disableVoidBag = slot - PlayerItemSlotID.Bank4_0;
		}
		else
		{
			inventoryChestStack[slot] = true;
		}
	}

	public void UpdateNearbyInteractibleProjectilesList()
	{
		List<int> projectilesToInteractWith = _projectilesToInteractWith;
		projectilesToInteractWith.Clear();
		if (!Main.CurrentFrameFlags.HadAnActiveInteractibleProjectile)
		{
			return;
		}
		Vector2 compareSpot = base.Center;
		for (int i = 0; i < 1000; i++)
		{
			Projectile proj = Main.projectile[i];
			if (IsProjectileInteractibleAndInInteractionRange(proj, ref compareSpot))
			{
				projectilesToInteractWith.Add(i);
			}
		}
	}

	public bool IsProjectileInteractibleAndInInteractionRange(Projectile proj, ref Vector2 compareSpot)
	{
		if (!proj.active)
		{
			return false;
		}
		if (!proj.IsInteractible())
		{
			return false;
		}
		Point point = proj.Hitbox.ClosestPointInRect(compareSpot).ToTileCoordinates();
		if (!IsInTileInteractionRange(point.X, point.Y, TileReachCheckSettings.Simple))
		{
			return false;
		}
		return true;
	}

	public bool useVoidBag()
	{
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].stack > 0 && inventory[i].type == 4131)
			{
				return true;
			}
		}
		return false;
	}

	public void QuickStackAllChests()
	{
		if (!HasLockedInventory())
		{
			bool smartStack = Settings.StackToChestsPreferredMode == Settings.StackToNearbyChestsMode.SmartStackToNearbyChests;
			QuickStacking.QuickStackToNearbyInventories(this, smartStack);
		}
	}

	public void CheckDrowning()
	{
		bool flag = Collision.DrownCollision(position, width, height, gravDir);
		if (armor[0].type == 250 || armor[0].type == 4275)
		{
			flag = true;
		}
		if (hasBreathingReed && itemAnimation == 0)
		{
			try
			{
				int num = (int)((position.X + (float)(width / 2) + (float)(6 * direction)) / 16f);
				int num2 = 0;
				if (gravDir == -1f)
				{
					num2 = height;
				}
				int num3 = (int)((position.Y + (float)num2 - 44f * gravDir) / 16f);
				if (Main.tile[num, num3] != null && Main.tile[num, num3].liquid < 128)
				{
					if (Main.tile[num, num3] == null)
					{
						Main.tile[num, num3] = new Tile();
					}
					if (!Main.tile[num, num3].active() || !Main.tileSolid[Main.tile[num, num3].type] || Main.tileSolidTop[Main.tile[num, num3].type])
					{
						flag = false;
					}
				}
			}
			catch
			{
			}
		}
		if (gills)
		{
			flag = Main.getGoodWorld && !flag;
		}
		if (shimmering)
		{
			flag = false;
		}
		if (mount.Active && mount.Type == 4)
		{
			flag = false;
		}
		if (Main.myPlayer == whoAmI)
		{
			if (accMerman)
			{
				if (flag)
				{
					merman = true;
				}
				flag = false;
			}
			if (flag)
			{
				breathCD++;
				if (breathCD >= breathCDMax)
				{
					breathCD = 0;
					breath--;
					if (breath == 0)
					{
						SoundEngine.PlaySound(23);
					}
					if (breath <= 0)
					{
						lifeRegenTime = 0f;
						breath = 0;
						statLife -= 2;
						SetOrRequestSpectating(-1);
						if (statLife <= 0)
						{
							statLife = 0;
							KillMe(PlayerDeathReason.ByOther(1), 10.0, 0);
						}
					}
				}
			}
			else
			{
				breath += 3;
				if (breath > breathMax)
				{
					breath = breathMax;
				}
				breathCD = 0;
			}
		}
		if (!flag || Main.rand.Next(20) != 0 || lavaWet || honeyWet)
		{
			return;
		}
		int num4 = 0;
		if (gravDir == -1f)
		{
			num4 += height - 12;
		}
		Vector2 vector = new Vector2(position.X + (float)(12 * direction), position.Y + (float)num4 + 4f * gravDir);
		if (hasBreathingReed)
		{
			vector += new Vector2(-2 * direction, -58f * gravDir);
		}
		if (mount.Active && MouthPosition.HasValue)
		{
			if (mount.Type == 52)
			{
				vector = MouthPosition.Value + new Vector2(-6f, 0f);
				if (hasBreathingReed)
				{
					vector += new Vector2(0f, -60f) * Directions;
				}
			}
			if (mount.Type == 54)
			{
				vector = MouthPosition.Value + new Vector2(-6f, -2f);
				if (hasBreathingReed)
				{
					vector += new Vector2(-14f, -58f) * Directions;
				}
			}
		}
		Dust.NewDust(vector, width - 8, 8, 34, 0f, 0f, 0, default(Color), 1.2f);
	}

	public void CheckCrackedBrickBreak()
	{
		if (shimmering || !WorldGen.InWorld((int)(base.Center.X / 16f), (int)(base.Center.Y / 16f), 10))
		{
			return;
		}
		bool flag = false;
		if ((float)Main.rand.Next(2, 12) < Math.Abs(velocity.X))
		{
			flag = true;
		}
		if ((float)Main.rand.Next(2, 12) < velocity.Y)
		{
			flag = true;
		}
		if (flag && velocity.Y < 1f)
		{
			Point point = (base.Bottom + Vector2.UnitY).ToTileCoordinates();
			Point point2 = (base.BottomLeft + Vector2.UnitY).ToTileCoordinates();
			Point point3 = (base.BottomRight + Vector2.UnitY).ToTileCoordinates();
			if ((WorldGen.SolidTileAllowBottomSlope(point.X, point.Y) && !TileID.Sets.CrackedBricks[Main.tile[point.X, point.Y].type]) || (WorldGen.SolidTileAllowBottomSlope(point2.X, point2.Y) && !TileID.Sets.CrackedBricks[Main.tile[point2.X, point2.Y].type]) || (WorldGen.SolidTileAllowBottomSlope(point3.X, point3.Y) && !TileID.Sets.CrackedBricks[Main.tile[point3.X, point3.Y].type]))
			{
				flag = false;
			}
		}
		if (!flag)
		{
			return;
		}
		Vector2 vector = position + velocity;
		flag = false;
		int num = (int)(vector.X / 16f);
		int num2 = (int)((vector.X + (float)width) / 16f);
		int num3 = (int)((position.Y + (float)height + 1f) / 16f);
		Rectangle rect = getRect();
		rect.Inflate(1, 1);
		for (int i = num; i <= num2; i++)
		{
			for (int j = num3; j <= num3 + 1 && WorldGen.InWorld(i, j) && Main.tile[i, j] != null; j++)
			{
				if (Main.tile[i, j].nactive() && !WorldGen.SolidTile(i, j - 1) && TileID.Sets.CrackedBricks[Main.tile[i, j].type] && new Rectangle(i * 16, j * 16, 16, 16).Intersects(rect))
				{
					flag = true;
					if (velocity.Y > 1f)
					{
						velocity.Y = 1f;
					}
					NetMessage.SendData(13, -1, -1, null, whoAmI);
				}
			}
		}
		if (!flag)
		{
			return;
		}
		num = (int)((vector.X - 16f - 8f) / 16f);
		num2 = (int)((vector.X + (float)width + 16f + 8f) / 16f);
		for (int k = num; k <= num2; k++)
		{
			for (int l = num3; l <= num3 + 2; l++)
			{
				if (Main.tile[k, l].nactive() && !WorldGen.SolidTile(k, l - 1) && TileID.Sets.CrackedBricks[Main.tile[k, l].type])
				{
					WorldGen.KillTile(k, l);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 20, k, l);
					}
				}
			}
		}
	}

	public void CheckIceBreak()
	{
		if (!(velocity.Y > 7f))
		{
			return;
		}
		Vector2 vector = position + velocity;
		int num = (int)(vector.X / 16f);
		int num2 = (int)((vector.X + (float)width) / 16f);
		int num3 = (int)((position.Y + (float)height + 1f) / 16f);
		for (int i = num; i <= num2; i++)
		{
			for (int j = num3; j <= num3 + 1 && Main.tile[i, j] != null; j++)
			{
				if (Main.tile[i, j].nactive() && Main.tile[i, j].type == 162 && !WorldGen.SolidTile(i, j - 1))
				{
					WorldGen.KillTile(i, j);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, i, j);
					}
				}
			}
		}
	}

	public void SlopeDownMovement()
	{
		sloping = false;
		if (!mount.Active || mount.Type != 48)
		{
			float y = velocity.Y;
			Vector4 vector = Collision.WalkDownSlope(position, velocity, width, height, gravity * gravDir);
			position.X = vector.X;
			position.Y = vector.Y;
			velocity.X = vector.Z;
			velocity.Y = vector.W;
			if (velocity.Y != y)
			{
				sloping = true;
			}
		}
	}

	public void WetCollision(bool fallThrough, bool ignorePlats, float movementSpeed)
	{
		Vector2 vector = velocity;
		velocity = TileCollision(position, velocity, fallThrough, ignorePlats);
		Vector2 vector2 = velocity * movementSpeed;
		if (velocity.X != vector.X)
		{
			vector2.X = velocity.X;
		}
		if (velocity.Y != vector.Y)
		{
			vector2.Y = velocity.Y;
		}
		position += vector2;
		TryFloatingInFluid();
	}

	private void TryFloatingInFluid()
	{
		if (!ShouldFloatInWater || (shimmerWet && !shimmerImmune))
		{
			return;
		}
		if (whoAmI == Main.myPlayer && sitting.isSitting)
		{
			sitting.SitUp(this);
		}
		if (Collision.GetWaterLine(base.Center.ToTileCoordinates(), out var waterLineHeight))
		{
			float num = base.Center.Y;
			if (mount.Active && mount.Type == 37)
			{
				num -= 6f;
			}
			float num2 = num + 8f;
			if (num2 + velocity.Y < waterLineHeight)
			{
				return;
			}
			if (num > waterLineHeight)
			{
				velocity.Y -= 0.4f;
				if (velocity.Y < -6f)
				{
					velocity.Y = -6f;
				}
				return;
			}
			velocity.Y = waterLineHeight - num2;
			if (velocity.Y < -3f)
			{
				velocity.Y = -3f;
			}
			if (velocity.Y == 0f)
			{
				velocity.Y = float.Epsilon;
			}
		}
		else
		{
			velocity.Y -= 0.4f;
		}
	}

	public void DryCollision(bool fallThrough, bool ignorePlats)
	{
		float val = 16f;
		val = Math.Min(val, (float)width - 0.5f);
		val = Math.Min(val, (float)height - 0.5f);
		if (velocity.Length() > val)
		{
			Vector2 vector = TileCollision(position, velocity, fallThrough, ignorePlats);
			float num = velocity.Length();
			Vector2 vector2 = Vector2.Normalize(velocity);
			if (vector.Y == 0f)
			{
				vector2.Y = 0f;
			}
			Vector2 zero = Vector2.Zero;
			bool flag = mount.Type == 7 || mount.Type == 8 || mount.Type == 12 || mount.Type == 44 || mount.Type == 49;
			_ = Vector2.Zero;
			while (num > 0f)
			{
				float num2 = num;
				if (num2 > val)
				{
					num2 = val;
				}
				num -= num2;
				Vector2 vector3 = vector2 * num2;
				velocity = vector3;
				SlopeDownMovement();
				vector3 = velocity;
				if (velocity.Y == gravity && (!mount.Active || (!mount.Cart && mount.Type != 48 && !flag)))
				{
					Collision.StepDown(ref position, ref vector3, width, height, ref stepSpeed, ref gfxOffY, (int)gravDir, waterWalk || waterWalk2);
				}
				if (gravDir == -1f)
				{
					if ((carpetFrame != -1 || velocity.Y <= gravity) && !controlUp)
					{
						Collision.StepUp(ref position, ref vector3, width, height, ref stepSpeed, ref gfxOffY, (int)gravDir, controlUp);
					}
				}
				else if (flag || ((carpetFrame != -1 || velocity.Y >= gravity) && !controlDown && !mount.Cart))
				{
					Collision.StepUp(ref position, ref vector3, width, height, ref stepSpeed, ref gfxOffY, (int)gravDir, controlUp);
				}
				Vector2 vector4 = TileCollision(position, vector3, fallThrough, ignorePlats);
				if (Collision.up && gravDir == 1f)
				{
					jump = 0;
				}
				if (waterWalk || waterWalk2)
				{
					Vector2 vector5 = velocity;
					vector4 = Collision.WaterCollision(position, vector4, width, height, fallThrough, fall2: false, waterWalk);
					if (vector5 != velocity)
					{
						fallStart = (int)(position.Y / 16f);
					}
				}
				position += vector4;
				bool falling = false;
				if (vector4.Y > gravity)
				{
					falling = true;
				}
				if (vector4.Y < 0f - gravity)
				{
					falling = true;
				}
				velocity = vector4;
				UpdateTouchingTiles();
				TryBouncingBlocks(falling);
				TryLandingOnDetonator();
				SlopingCollision(fallThrough, ignorePlats);
				Collision.StepConveyorBelt(this, gravDir);
				vector4 = velocity;
				zero += vector4;
			}
			velocity = zero;
			return;
		}
		velocity = TileCollision(position, velocity, fallThrough, ignorePlats);
		if (Collision.up && gravDir == 1f)
		{
			jump = 0;
		}
		if (waterWalk || waterWalk2)
		{
			Vector2 vector6 = velocity;
			velocity = Collision.WaterCollision(position, velocity, width, height, fallThrough, fall2: false, waterWalk);
			if (vector6 != velocity)
			{
				fallStart = (int)(position.Y / 16f);
			}
		}
		position += velocity;
	}

	public Vector2 TileCollision(Vector2 position, Vector2 velocity, bool fallThrough, bool ignorePlats)
	{
		int num = height;
		if (onTrack)
		{
			num -= 10;
		}
		bool flag = width <= 16 || num <= 16;
		return Collision.TileCollision(position, velocity, width, num, fallThrough, ignorePlats, (int)gravDir, ignoreDoors: false, ignoreAetheriumPlatforms: false, !flag);
	}

	private bool TouchBlockSurfaceCenter(int x, int y, Tile tile, out int exitNormalX, out int exitNormalY, out Vector2 surfaceCenter)
	{
		exitNormalX = (exitNormalY = 0);
		Vector2 vector = new Vector2(x * 16, y * 16);
		Vector2 vector2 = new Vector2(vector.X + 16f, vector.Y);
		Vector2 vector3 = new Vector2(vector.X, vector.Y + 16f);
		Vector2 vector4 = new Vector2(vector.X + 16f, vector.Y + 16f);
		int num = 0;
		int num2 = 0;
		switch (tile.blockType())
		{
		case 1:
			vector.Y += 8f;
			vector2.Y += 8f;
			break;
		case 3:
			vector.Y += 16f;
			num = -1;
			break;
		case 2:
			vector2.Y += 16f;
			num = 1;
			break;
		case 5:
			vector3.Y -= 16f;
			num2 = -1;
			break;
		case 4:
			vector4.Y -= 16f;
			num2 = 1;
			break;
		}
		Vector2 vector5 = new Vector2(0.0001f);
		_ = position - vector5;
		_ = base.Size + vector5 * 2f;
		Rectangle hitbox = base.Hitbox;
		surfaceCenter = Vector2.Lerp(vector, vector2, 0.5f);
		float num3 = 4f;
		if (hitbox.Distance(surfaceCenter) <= num3)
		{
			exitNormalX = num;
			exitNormalY = -1;
			return true;
		}
		surfaceCenter = Vector2.Lerp(vector3, vector4, 0.5f);
		if (hitbox.Distance(surfaceCenter) <= num3)
		{
			exitNormalX = num2;
			exitNormalY = 1;
			return true;
		}
		if (vector != vector3)
		{
			surfaceCenter = Vector2.Lerp(vector, vector3, 0.5f);
			if (hitbox.Distance(surfaceCenter) <= num3)
			{
				exitNormalX = -1;
				exitNormalY = 0;
				return true;
			}
		}
		if (vector2 != vector4)
		{
			surfaceCenter = Vector2.Lerp(vector2, vector4, 0.5f);
			if (hitbox.Distance(surfaceCenter) <= num3)
			{
				exitNormalX = 1;
				exitNormalY = 0;
				return true;
			}
		}
		return false;
	}

	public void SlopingCollision(bool fallThrough, bool ignorePlats)
	{
		if (ignorePlats || controlDown || grappling[0] >= 0 || gravDir == -1f)
		{
			stairFall = true;
		}
		Vector4 vector = Collision.SlopeCollision(position, velocity, width, height, gravity, stairFall);
		if (Collision.stairFall)
		{
			stairFall = true;
		}
		else if (!fallThrough)
		{
			stairFall = false;
		}
		if (Collision.stair && Math.Abs(vector.Y - position.Y) > 8f + Math.Abs(velocity.X))
		{
			gfxOffY -= vector.Y - position.Y;
			stepSpeed = 4f;
		}
		_ = velocity;
		position.X = vector.X;
		position.Y = vector.Y;
		velocity.X = vector.Z;
		velocity.Y = vector.W;
		if (gravDir == -1f && velocity.Y == 0.0101f)
		{
			velocity.Y = 0f;
		}
	}

	public void FloorVisuals(bool Falling)
	{
		int num = (int)((position.X + (float)(width / 2)) / 16f);
		int num2 = (int)((position.Y + (float)height) / 16f);
		if (gravDir == -1f)
		{
			num2 = (int)(position.Y - 0.1f) / 16;
		}
		Tile floorTile = GetFloorTile(num, num2);
		int num3 = -1;
		if (floorTile != null)
		{
			num3 = floorTile.type;
		}
		if (num3 <= -1)
		{
			ResetFloorFlags();
			return;
		}
		sticky = num3 == 229;
		slippy = TileID.Sets.IceSkateSlippery[num3];
		slippy2 = num3 == 197;
		powerrun = num3 == 198;
		runningOnSand = TileID.Sets.Conversion.Sand[num3] || TileID.Sets.Conversion.Sandstone[num3] || TileID.Sets.Conversion.HardenedSand[num3];
		if ((num3 == 666 || num3 == 712) && whoAmI == Main.myPlayer)
		{
			AddBuff(120, 180);
		}
		if (Main.tile[num - 1, num2].slope() != 0 || Main.tile[num, num2].slope() != 0 || Main.tile[num + 1, num2].slope() != 0)
		{
			num3 = -1;
		}
		if (!wet && !mount.Cart)
		{
			MakeFloorDust(Falling, num3, floorTile.frameX, floorTile.frameY, floorTile.color());
		}
	}

	public void ResetFloorFlags()
	{
		slippy = false;
		slippy2 = false;
		sticky = false;
		powerrun = false;
		runningOnSand = false;
	}

	public static Tile GetFloorTile(int x, int y)
	{
		Tile result = null;
		if (Main.tile[x - 1, y] == null)
		{
			Main.tile[x - 1, y] = new Tile();
		}
		if (Main.tile[x + 1, y] == null)
		{
			Main.tile[x + 1, y] = new Tile();
		}
		if (Main.tile[x, y] == null)
		{
			Main.tile[x, y] = new Tile();
		}
		if (Main.tile[x, y].nactive() && Main.tileSolid[Main.tile[x, y].type])
		{
			result = Main.tile[x, y];
		}
		else if (Main.tile[x - 1, y].nactive() && Main.tileSolid[Main.tile[x - 1, y].type])
		{
			result = Main.tile[x - 1, y];
		}
		else if (Main.tile[x + 1, y].nactive() && Main.tileSolid[Main.tile[x + 1, y].type])
		{
			result = Main.tile[x + 1, y];
		}
		return result;
	}

	public static int GetFloorTileType(int x, int y)
	{
		return ((int?)GetFloorTile(x, y)?.type) ?? (-1);
	}

	private void MakeFloorDust(bool Falling, int type, int frameX, int frameY, int paintColor)
	{
		if (type == 659 || type == 667)
		{
			bool flag = true;
			if (!Falling)
			{
				float num = Math.Abs(velocity.X) / 3f;
				if ((float)Main.rand.Next(100) > num * 50f)
				{
					flag = false;
				}
			}
			if (!flag)
			{
				return;
			}
			Vector2 positionInWorld = new Vector2(position.X, position.Y + (float)height - 2f) + new Vector2((float)width * Main.rand.NextFloat(), 6f * Main.rand.NextFloat());
			Vector2 movementVector = Main.rand.NextVector2Circular(0.8f, 0.8f);
			if (movementVector.Y > 0f)
			{
				movementVector.Y *= -1f;
			}
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.ShimmerBlock, new ParticleOrchestraSettings
			{
				PositionInWorld = positionInWorld,
				MovementVector = movementVector
			}, whoAmI);
		}
		bool flag2 = type == 19 && frameY / 18 == 49;
		if (!(type == 147 || type == 25 || type == 53 || type == 189 || flag2) && type != 0 && type != 123 && type != 57 && type != 112 && type != 116 && type != 196 && type != 193 && type != 195 && type != 197 && type != 199 && type != 229 && type != 234 && type != 371 && type != 460 && type != 666 && type != 712 && type != 717 && type != 718 && type != 719)
		{
			return;
		}
		int num2 = 1;
		if (Falling)
		{
			num2 = 20;
			if (type == 666 || type == 712)
			{
				SoundEngine.PlaySound(SoundID.Item177, (int)base.Center.X, (int)base.Bottom.Y);
			}
		}
		for (int i = 0; i < num2; i++)
		{
			bool flag3 = true;
			int num3 = 76;
			if (type == 666 || type == 712)
			{
				if (paintColor != 0)
				{
					break;
				}
				num3 = 322;
			}
			if (type == 32)
			{
				num3 = 32;
			}
			if (type == 189 || flag2)
			{
				num3 = 16;
			}
			if (type == 717)
			{
				num3 = 326;
			}
			if (type == 718)
			{
				num3 = 327;
			}
			if (type == 719)
			{
				num3 = 328;
			}
			if (type == 0)
			{
				num3 = 0;
			}
			if (type == 123)
			{
				num3 = 53;
			}
			if (type == 57)
			{
				num3 = 36;
			}
			if (type == 112)
			{
				num3 = 14;
			}
			if (type == 234)
			{
				num3 = 122;
			}
			if (type == 116)
			{
				num3 = 51;
			}
			if (type == 196)
			{
				num3 = 108;
			}
			if (type == 193)
			{
				num3 = 4;
			}
			if (type == 195 || type == 199)
			{
				num3 = 5;
			}
			if (type == 197)
			{
				num3 = 4;
			}
			if (type == 229)
			{
				num3 = 153;
			}
			if (type == 371)
			{
				num3 = 243;
			}
			if (type == 460)
			{
				num3 = 108;
			}
			if (type == 25)
			{
				num3 = 37;
			}
			if (num3 == 32 && Main.rand.Next(2) == 0)
			{
				flag3 = false;
			}
			if (num3 == 14 && Main.rand.Next(2) == 0)
			{
				flag3 = false;
			}
			if (num3 == 51 && Main.rand.Next(2) == 0)
			{
				flag3 = false;
			}
			if (num3 == 36 && Main.rand.Next(2) == 0)
			{
				flag3 = false;
			}
			if (num3 == 0 && Main.rand.Next(3) != 0)
			{
				flag3 = false;
			}
			if (num3 == 53 && Main.rand.Next(3) != 0)
			{
				flag3 = false;
			}
			Color newColor = default(Color);
			if (type == 193)
			{
				newColor = new Color(30, 100, 255, 100);
			}
			if (type == 197)
			{
				newColor = new Color(97, 200, 255, 100);
			}
			if (type == 460)
			{
				newColor = new Color(100, 150, 130, 100);
			}
			if (!Falling)
			{
				float num4 = Math.Abs(velocity.X) / 3f;
				if ((float)Main.rand.Next(100) > num4 * 100f)
				{
					flag3 = false;
				}
			}
			if (!flag3)
			{
				continue;
			}
			float num5 = velocity.X;
			if (num5 > 6f)
			{
				num5 = 6f;
			}
			if (num5 < -6f)
			{
				num5 = -6f;
			}
			if (!(CanSpawnWalkingEffects() || Falling))
			{
				continue;
			}
			int num6 = Dust.NewDust(new Vector2(position.X, position.Y + (float)height - 2f), width, 6, num3, 0f, 0f, 50, newColor);
			if (gravDir == -1f)
			{
				Main.dust[num6].position.Y -= height + 4;
			}
			if (num3 == 76)
			{
				Main.dust[num6].scale += (float)Main.rand.Next(3) * 0.1f;
				Main.dust[num6].noLight = true;
			}
			if (num3 == 16 || num3 == 108 || num3 == 153 || num3 == 326 || num3 == 327 || num3 == 328)
			{
				Main.dust[num6].scale += (float)Main.rand.Next(6) * 0.1f;
			}
			if (num3 == 37)
			{
				Main.dust[num6].scale += 0.25f;
				Main.dust[num6].alpha = 50;
			}
			if (num3 == 5)
			{
				Main.dust[num6].scale += (float)Main.rand.Next(2, 8) * 0.1f;
			}
			Main.dust[num6].noGravity = true;
			if (num3 == 322)
			{
				if (Main.rand.Next(4) == 0)
				{
					Main.dust[num6].noGravity = false;
					Main.dust[num6].scale *= 1.1f;
				}
				else
				{
					Main.dust[num6].scale *= 1.2f;
				}
			}
			if (num2 > 1)
			{
				Main.dust[num6].velocity.X *= 1.2f;
				Main.dust[num6].velocity.Y *= 0.8f;
				Main.dust[num6].velocity.Y -= 1f;
				Main.dust[num6].velocity *= 0.8f;
				Main.dust[num6].scale += (float)Main.rand.Next(3) * 0.1f;
				Main.dust[num6].velocity.X = (Main.dust[num6].position.X - (position.X + (float)(width / 2))) * 0.2f;
				if (Main.dust[num6].velocity.Y > 0f)
				{
					Main.dust[num6].velocity.Y *= -1f;
				}
				Main.dust[num6].velocity.X += num5 * 0.3f;
			}
			else
			{
				Main.dust[num6].velocity *= 0.2f;
			}
			Main.dust[num6].position.X -= num5 * 1f;
			if (gravDir == -1f)
			{
				Main.dust[num6].velocity.Y *= -1f;
			}
		}
	}

	public void BordersMovement()
	{
		if (DebugOptions.noLimits)
		{
			return;
		}
		int num = 640;
		float num2 = Main.leftWorld + (float)num;
		if (position.X < num2)
		{
			Main.cameraX = 0f;
			position.X = num2;
			velocity.X = 0f;
		}
		float num3 = Main.rightWorld - (float)num - (float)width;
		if (position.X > num3)
		{
			Main.cameraX = 0f;
			position.X = num3;
			velocity.X = 0f;
		}
		if (position.Y < Main.topWorld + (float)num)
		{
			Main.cameraY = 0f;
			if (Main.remixWorld || forcedGravity > 0)
			{
				if (position.Y < Main.topWorld + (float)num - (float)height && !dead)
				{
					KillMe(PlayerDeathReason.ByOther(19), 10.0, 0);
					if (whoAmI == Main.myPlayer)
					{
						AchievementsHelper.NotifyProgressionEvent(44);
					}
				}
				int num4 = num / 2;
				if (position.Y < Main.topWorld + (float)num4)
				{
					position.Y = Main.topWorld + (float)num4;
					if (velocity.Y < 0f)
					{
						velocity.Y = 0f;
					}
					gravDir = 1f;
				}
			}
			else
			{
				position.Y = Main.topWorld + (float)num;
				if (velocity.Y < 0.11f)
				{
					velocity.Y = 0.11f;
				}
				gravDir = 1f;
			}
			AchievementsHelper.HandleSpecialEvent(this, 11);
		}
		if (position.Y > Main.bottomWorld - (float)num)
		{
			if (!dead)
			{
				KillMe(PlayerDeathReason.ByOther(21), 10.0, 0);
			}
			Main.cameraY = 0f;
			position.Y = Main.bottomWorld - (float)num;
			velocity.Y = 0f;
		}
		bool flag = false;
		if (creativeGodMode)
		{
			flag = true;
		}
		if (flag && position.Y > Main.bottomWorld - (float)num - (float)height)
		{
			Main.cameraY = 0f;
			position.Y = Main.bottomWorld - (float)num - (float)height;
			velocity.Y = 0f;
		}
		if (position.Y > Main.bottomWorld - (float)num - 118f - (float)height)
		{
			AchievementsHelper.HandleSpecialEvent(this, 10);
		}
	}

	public void CollectTaxes()
	{
		int num = Item.buyPrice(0, 0, 0, 50);
		int num2 = Item.buyPrice(0, 25);
		if (Main.tenthAnniversaryWorld)
		{
			num2 *= 2;
			num *= 2;
		}
		if (!NPC.taxCollector || taxMoney >= num2)
		{
			return;
		}
		int num3 = 0;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			if (Main.npc[i].active && !Main.npc[i].homeless && !NPCID.Sets.IsTownPet[Main.npc[i].type] && NPC.TypeToDefaultHeadIndex(Main.npc[i].type) > 0)
			{
				num3++;
			}
		}
		taxMoney += num * num3;
		if (taxMoney > num2)
		{
			taxMoney = num2;
		}
	}

	public void GamepadEnableGrappleCooldown()
	{
		_quickGrappleCooldown = 3;
	}

	public void TryInterruptingItemUsage()
	{
		bool flag = false;
		if (heldProj > -1 && Main.projectile[heldProj].IsInterruptible(this))
		{
			flag = true;
		}
		if (!flag)
		{
			return;
		}
		bool flag2 = false;
		if (PlayerInput.Triggers.Current.Hotbar1)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar2)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar3)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar4)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar5)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar6)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar7)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar8)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar9)
		{
			flag2 = true;
		}
		if (PlayerInput.Triggers.Current.Hotbar10)
		{
			flag2 = true;
		}
		bool flag3 = Main.hairWindow;
		if (flag3)
		{
			int y = Main.screenHeight / 2 + 60;
			flag3 = new Rectangle(Main.screenWidth / 2 - TextureAssets.HairStyleBack.Width() / 2, y, TextureAssets.HairStyleBack.Width(), TextureAssets.HairStyleBack.Height()).Contains(Main.MouseScreen.ToPoint());
		}
		if (!Main.mapFullscreen && !CaptureManager.Instance.Active && !flag3 && !Main.playerInventory)
		{
			int num = PlayerInput.Triggers.Current.HotbarPlus.ToInt() - PlayerInput.Triggers.Current.HotbarMinus.ToInt();
			if (PlayerInput.CurrentProfile.HotbarRadialHoldTimeRequired != -1)
			{
				num = PlayerInput.Triggers.JustReleased.HotbarPlus.ToInt() - PlayerInput.Triggers.JustReleased.HotbarMinus.ToInt();
			}
			if (PlayerInput.Triggers.Current.HotbarScrollCD != 0)
			{
				num = 0;
			}
			if (!Main.inFancyUI && !Main.ingameOptionsWindow)
			{
				num += PlayerInput.ScrollWheelDelta / -120;
			}
			if (num != 0)
			{
				num = ClampHotbarOffset(num);
				_ = selectedItem + num;
				flag2 = true;
			}
		}
		if (flag2 && heldProj > -1)
		{
			Main.projectile[heldProj].Interrupt(this);
		}
	}

	private bool CanMoveForwardOnRope(int dir, int x, int y)
	{
		int num = x + dir;
		if (Main.tile[num, y] != null && Main.tile[num, y].active() && Main.tileRope[Main.tile[num, y].type])
		{
			int num2 = num * 16 + 8 - width / 2;
			float y2 = position.Y;
			y2 = y * 16 + 22;
			if ((!Main.tile[num, y - 1].active() || !Main.tileRope[Main.tile[num, y - 1].type]) && (!Main.tile[num, y + 1].active() || !Main.tileRope[Main.tile[num, y + 1].type]))
			{
				y2 = y * 16 + 22;
			}
			if (Collision.SolidCollision(new Vector2(num2, y2), width, height))
			{
				return false;
			}
			return true;
		}
		return false;
	}

	public void UpdateHairDyeDust()
	{
		if (Main.netMode != 2 && !Main.gamePaused && !dead && !ghost && !stoned && !frozen && hairDye == ContentSamples.DyeShaderIDs.TeamDyeShaderIndex)
		{
			if (Main.rand.Next(45) == 0)
			{
				int type = Main.rand.Next(139, 143);
				int num = Dust.NewDust(position, width, 8, type, 0f, 0f, 0, default(Color), 1.2f);
				Main.dust[num].velocity.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.X += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.Y -= 1f;
				Main.dust[num].scale *= 0.7f + (float)Main.rand.Next(-30, 31) * 0.01f;
				Main.dust[num].velocity += velocity * 0.2f;
			}
			if (Main.rand.Next(225) == 0)
			{
				int type2 = Main.rand.Next(276, 283);
				int num2 = Gore.NewGore(new Vector2(position.X + (float)Main.rand.Next(width), position.Y + (float)Main.rand.Next(8)), velocity, type2);
				Main.gore[num2].velocity.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].velocity.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].scale *= 1f + (float)Main.rand.Next(-20, 21) * 0.01f;
				Main.gore[num2].velocity.X += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].velocity.Y -= 1f;
				Main.gore[num2].velocity += velocity * 0.2f;
			}
		}
	}

	private void DoDeadCellsBeheadedParticles()
	{
		if (Main.netMode != 2 && !Main.gamePaused && !dead && !ghost && !stoned && !frozen && head == 282 && !sitting.isSitting && !sleeping.isSleeping && (!mount.Active || mount.Type < 0 || !MountID.Sets.PlayerIsHidden[mount.Type]))
		{
			Vector2 vector = MountedTop + new Vector2(0f, 8f * gravDir + gfxOffY + Utils.Remap(Math.Abs(velocity.X), 0f, 3f, 0f, -4f) * gravDir);
			if (fullRotation != 0f)
			{
				vector = vector.RotatedBy(fullRotation, position + fullRotationOrigin);
			}
			Vector2 vector2 = velocity;
			if (fullRotation != 0f && mount.Active && mount.AnyTrackRider)
			{
				vector2 = vector2.RotatedBy(fullRotation, Vector2.Zero);
			}
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.DeadCellsBeheadedEffect, new ParticleOrchestraSettings
			{
				PositionInWorld = vector,
				MovementVector = vector2
			}, whoAmI);
		}
	}

	public bool TryingToUseItem()
	{
		if (whoAmI != Main.myPlayer)
		{
			return false;
		}
		if (mouseInterface || !controlUseItem)
		{
			return false;
		}
		if (itemAnimation == 0 && !Main.mouseLeftRelease)
		{
			return false;
		}
		if (HeldItem.useStyle == 0)
		{
			return false;
		}
		return ItemCheck_CanUse(HeldItem, ignoreCursed: true);
	}

	public float GetAutoDoorVelocityContribution()
	{
		float num = velocity.X;
		if (mount.Active && mount.Type >= 0 && MountID.Sets.IsRollerSkates[mount.Type] && Math.Abs(num) < 3f)
		{
			num = 3f * (float)Math.Sign(num);
		}
		return num;
	}

	public void Update(int i)
	{
		if (i == Main.myPlayer && Main.netMode != 2)
		{
			LockOnHelper.Update();
		}
		if (i == Main.myPlayer && Main.dontStarveWorld)
		{
			DontStarveDarknessDamageDealer.Update(this);
		}
		if (Main.LocalPlayerHasPendingInventoryActions())
		{
			LockGamepadTileInteractions();
		}
		maxFallSpeed = 10f;
		gravity = defaultGravity;
		jumpHeight = 15;
		jumpSpeed = 5.01f;
		maxRunSpeed = 3f;
		runAcceleration = 0.08f;
		runSlowdown = 0.2f;
		accRunSpeed = maxRunSpeed;
		if (!mount.Active || !mount.Cart)
		{
			onWrongGround = false;
		}
		heldProj = -1;
		instantMovementAccumulatedThisFrame = Vector2.Zero;
		if (PortalPhysicsEnabled)
		{
			maxFallSpeed = 35f;
		}
		if (!shimmering && wet && isPerformingJump_DownDash)
		{
			gravity *= 0.85f;
			maxFallSpeed *= 0.85f;
		}
		else if (shimmerWet || shimmering)
		{
			if (shimmering)
			{
				gravity *= 0.9f;
				maxFallSpeed *= 0.9f;
			}
			else
			{
				gravity = 0.15f;
				jumpHeight = 23;
				jumpSpeed = 5.51f;
			}
		}
		else if (wet)
		{
			if (honeyWet)
			{
				gravity = 0.1f;
				maxFallSpeed = 3f;
			}
			else if (merman)
			{
				gravity = 0.3f;
				maxFallSpeed = 7f;
			}
			else if (trident && !lavaWet)
			{
				gravity = 0.25f;
				maxFallSpeed = 6f;
				jumpHeight = 25;
				jumpSpeed = 5.51f;
				if (controlUp)
				{
					gravity = 0.1f;
					maxFallSpeed = 2f;
				}
			}
			else
			{
				gravity = 0.2f;
				maxFallSpeed = 5f;
				jumpHeight = 30;
				jumpSpeed = 6.01f;
			}
		}
		if (vortexDebuff)
		{
			gravity = 0f;
		}
		maxFallSpeed += 0.01f;
		bool flag = false;
		if (Main.myPlayer == i)
		{
			if (Main.mapFullscreen)
			{
				GamepadEnableGrappleCooldown();
			}
			else if (_quickGrappleCooldown > 0)
			{
				_quickGrappleCooldown--;
			}
			TileObject.objectPreview.Reset();
			if (DD2Event.DownedInvasionAnyDifficulty)
			{
				downedDD2EventAnyDifficulty = true;
			}
			autoReuseAllWeapons = Main.SettingsEnabled_AutoReuseAllItems;
		}
		if (emoteTime > 0)
		{
			emoteTime--;
		}
		if (ghostDmg > 0f)
		{
			ghostDmg -= 6.6666665f;
		}
		if (ghostDmg < 0f)
		{
			ghostDmg = 0f;
		}
		if (Main.expertMode)
		{
			if (lifeSteal < 70f)
			{
				lifeSteal += 0.5f;
			}
			if (lifeSteal > 70f)
			{
				lifeSteal = 70f;
			}
		}
		else
		{
			if (lifeSteal < 80f)
			{
				lifeSteal += 0.6f;
			}
			if (lifeSteal > 80f)
			{
				lifeSteal = 80f;
			}
		}
		ResizeHitbox();
		if (mount.Active && mount.Type == 0)
		{
			int num = (int)(position.X + (float)(width / 2)) / 16;
			int j = (int)(position.Y + (float)(height / 2) - 14f) / 16;
			Lighting.AddLight(num, j, 0.5f, 0.2f, 0.05f);
			Lighting.AddLight(num + direction, j, 0.5f, 0.2f, 0.05f);
			Lighting.AddLight(num + direction * 2, j, 0.5f, 0.2f, 0.05f);
		}
		outOfRange = false;
		if (whoAmI != Main.myPlayer)
		{
			int num2 = (int)(position.X + (float)(width / 2)) / 16;
			int num3 = (int)(position.Y + (float)(height / 2)) / 16;
			if (!WorldGen.InWorld(num2, num3, 4))
			{
				flag = true;
			}
			else if (Main.tile[num2, num3] == null)
			{
				flag = true;
			}
			else if (Main.tile[num2 - 3, num3] == null)
			{
				flag = true;
			}
			else if (Main.tile[num2 + 3, num3] == null)
			{
				flag = true;
			}
			else if (Main.tile[num2, num3 - 3] == null)
			{
				flag = true;
			}
			else if (Main.tile[num2, num3 + 3] == null)
			{
				flag = true;
			}
			if (flag)
			{
				outOfRange = true;
				numMinions = 0;
				slotsMinions = 0f;
				itemAnimation = 0;
				netOffset = Vector2.Zero;
				UpdateBuffs(i);
				PlayerFrame();
			}
		}
		if (tankPet >= 0)
		{
			if (!tankPetReset)
			{
				tankPetReset = true;
			}
			else
			{
				tankPet = -1;
			}
		}
		if (i == Main.myPlayer)
		{
			IsVoidVaultEnabled = HasItem(4131);
		}
		if (chatOverhead.timeLeft > 0)
		{
			chatOverhead.timeLeft--;
		}
		if (snowBallLauncherInteractionCooldown > 0)
		{
			snowBallLauncherInteractionCooldown--;
		}
		environmentBuffImmunityTimer = Math.Max(0, environmentBuffImmunityTimer - 1);
		if (flag)
		{
			return;
		}
		TagEffectState.Update();
		IntentionGuesser.Update(this);
		UpdateHairDyeDust();
		UpdateMiscCounter();
		infernoCounter++;
		if (infernoCounter >= 180)
		{
			infernoCounter = 0;
		}
		timeSinceLastDashStarted++;
		if (timeSinceLastDashStarted >= 300)
		{
			timeSinceLastDashStarted = 300;
		}
		if (isPerformingJump_DownDash && mount.Active)
		{
			isPerformingJump_DownDash = false;
		}
		if (isPerformingJump_DownDash)
		{
			downDashTime++;
		}
		else
		{
			downDashTime = 0;
		}
		_framesLeftEligibleForDeadmansChestDeathAchievement--;
		if (_framesLeftEligibleForDeadmansChestDeathAchievement < 0)
		{
			_framesLeftEligibleForDeadmansChestDeathAchievement = 0;
		}
		if (titaniumStormCooldown > 0)
		{
			titaniumStormCooldown--;
		}
		if (starCloakCooldown > 0)
		{
			starCloakCooldown--;
			if (Main.rand.Next(5) == 0)
			{
				for (int k = 0; k < 2; k++)
				{
					Dust dust = Dust.NewDustDirect(position, width, height, 45, 0f, 0f, 255, default(Color), (float)Main.rand.Next(20, 26) * 0.1f);
					dust.noLight = true;
					dust.noGravity = true;
					dust.velocity *= 0.5f;
					dust.velocity.X = 0f;
					dust.velocity.Y -= 0.5f;
				}
			}
			if (starCloakCooldown == 0)
			{
				SoundEngine.PlaySound(25);
			}
		}
		_timeSinceLastImmuneGet++;
		if (_timeSinceLastImmuneGet >= 10000)
		{
			_timeSinceLastImmuneGet = 10000;
		}
		float num4 = (float)Main.maxTilesX / 4200f;
		num4 *= num4;
		float num5 = (float)((double)(position.Y / 16f - (60f + 10f * num4)) / (Main.worldSurface / 6.0));
		if (Main.remixWorld)
		{
			num5 = (float)((double)(position.Y / 16f - (60f + 10f * num4)) / (Main.worldSurface / 1.0));
		}
		if (Main.remixWorld)
		{
			if ((double)num5 < 0.1)
			{
				num5 = 0.1f;
			}
		}
		else if ((double)num5 < 0.25)
		{
			num5 = 0.25f;
		}
		if (num5 > 1f)
		{
			num5 = 1f;
		}
		gravity *= num5;
		maxRegenDelay = (1f - (float)statMana / (float)statManaMax2) * 60f * 4f + 45f;
		maxRegenDelay *= 0.7f;
		UpdateSocialShadow();
		UpdateTeleportVisuals();
		whoAmI = i;
		if (whoAmI == Main.myPlayer)
		{
			if (!DD2Event.Ongoing)
			{
				PurgeDD2EnergyCrystals();
			}
			TryPortalJumping();
			if (whoAmI == Main.myPlayer)
			{
				doorHelper.Update(this);
			}
		}
		if (runSoundDelay > 0)
		{
			runSoundDelay--;
		}
		if (attackCD > 0)
		{
			attackCD--;
		}
		if (itemAnimation == 0)
		{
			attackCD = 0;
		}
		if (potionDelay > 0)
		{
			potionDelay--;
		}
		if (i == Main.myPlayer)
		{
			UpdateFailedDismount();
			if (trashItem.type >= 1522 && trashItem.type <= 1527)
			{
				trashItem.SetDefaults(0);
			}
			if (trashItem.type == 3643)
			{
				trashItem.SetDefaults(0);
			}
			UpdateBiomes();
			UpdateMinionTarget();
		}
		if (Main.netMode == 2 && spectating >= 0 && !CanSpectate(spectating))
		{
			SpectateNextClosestPlayer();
		}
		if (ghost)
		{
			Ghost();
			return;
		}
		if (dead)
		{
			UpdateDead();
			ResetProjectileCaches();
			UpdateProjectileCaches(i);
			return;
		}
		TrySpawningFaelings();
		if (i == Main.myPlayer && hasLucyTheAxe)
		{
			LucyAxeMessage.TryPlayingIdleMessage();
		}
		if (velocity.Y == 0f)
		{
			mount.FatigueRecovery();
		}
		if (i == Main.myPlayer && !isControlledByFilm)
		{
			ResetControls();
			if (Main.hasFocus)
			{
				if (!Main.drawingPlayerChat && !Main.editSign && !Main.editChest && !Main.blockInput)
				{
					PlayerInput.Triggers.Current.CopyInto(this);
					LocalInputCache = new PlayerInputSyncCache(this);
					if (Main.mapFullscreen)
					{
						if (controlUp)
						{
							Main.PanTargetMapFullscreen = false;
							Main.mapFullscreenPos.Y -= 1f * (16f / Main.mapFullscreenScale);
						}
						if (controlDown)
						{
							Main.PanTargetMapFullscreen = false;
							Main.mapFullscreenPos.Y += 1f * (16f / Main.mapFullscreenScale);
						}
						if (controlLeft)
						{
							Main.PanTargetMapFullscreen = false;
							Main.mapFullscreenPos.X -= 1f * (16f / Main.mapFullscreenScale);
						}
						if (controlRight)
						{
							Main.PanTargetMapFullscreen = false;
							Main.mapFullscreenPos.X += 1f * (16f / Main.mapFullscreenScale);
						}
						controlUp = false;
						controlLeft = false;
						controlDown = false;
						controlRight = false;
						controlJump = false;
						controlUseItem = false;
						controlUseTile = false;
						controlThrow = false;
						controlHook = false;
						controlTorch = false;
						controlSmart = false;
						controlMount = false;
					}
					if (spectating >= 0)
					{
						HandleSpectatingControls();
						controlUp = false;
						controlLeft = false;
						controlDown = false;
						controlRight = false;
						controlJump = false;
					}
					if (isOperatingAnotherEntity)
					{
						controlUp = (controlDown = (controlLeft = (controlRight = (controlJump = false))));
					}
					if (controlQuickHeal)
					{
						if (releaseQuickHeal)
						{
							QuickHeal();
						}
						releaseQuickHeal = false;
					}
					else
					{
						releaseQuickHeal = true;
					}
					if (controlQuickMana)
					{
						if (releaseQuickMana)
						{
							QuickMana();
						}
						releaseQuickMana = false;
					}
					else
					{
						releaseQuickMana = true;
					}
					if (controlCreativeMenu)
					{
						if (releaseCreativeMenu)
						{
							ToggleCreativeMenu();
						}
						releaseCreativeMenu = false;
					}
					else
					{
						releaseCreativeMenu = true;
					}
					if (controlLeft && controlRight)
					{
						controlLeft = false;
						controlRight = false;
					}
					if (PlayerInput.UsingGamepad || !mouseInterface || !ItemSlot.Options.DisableLeftShiftTrashCan)
					{
						if (PlayerInput.SteamDeckIsUsed && PlayerInput.SettingsForUI.CurrentCursorMode == CursorMode.Mouse)
						{
							TryToToggleSmartCursor(ref Main.SmartCursorWanted_Mouse);
						}
						else if (PlayerInput.UsingGamepad)
						{
							TryToToggleSmartCursor(ref Main.SmartCursorWanted_GamePad);
						}
						else
						{
							TryToToggleSmartCursor(ref Main.SmartCursorWanted_Mouse);
						}
					}
					if (controlSmart)
					{
						releaseSmart = false;
					}
					else
					{
						releaseSmart = true;
					}
					if (controlMount)
					{
						if (releaseMount)
						{
							QuickMount();
						}
						releaseMount = false;
					}
					else
					{
						releaseMount = true;
					}
					if (Main.mapFullscreen)
					{
						if (mapZoomIn)
						{
							Main.mapFullscreenScale *= 1.05f;
						}
						if (mapZoomOut)
						{
							Main.mapFullscreenScale *= 0.95f;
						}
					}
					else
					{
						if (Main.mapStyle == 1)
						{
							if (mapZoomIn)
							{
								Main.mapMinimapScale *= 1.025f;
							}
							if (mapZoomOut)
							{
								Main.mapMinimapScale *= 0.975f;
							}
							if (mapAlphaUp)
							{
								Main.mapMinimapAlpha += 0.015f;
							}
							if (mapAlphaDown)
							{
								Main.mapMinimapAlpha -= 0.015f;
							}
						}
						else if (Main.mapStyle == 2)
						{
							if (mapZoomIn)
							{
								Main.mapOverlayScale *= 1.05f;
							}
							if (mapZoomOut)
							{
								Main.mapOverlayScale *= 0.95f;
							}
							if (mapAlphaUp)
							{
								Main.mapOverlayAlpha += 0.015f;
							}
							if (mapAlphaDown)
							{
								Main.mapOverlayAlpha -= 0.015f;
							}
						}
						if (mapStyle)
						{
							if (releaseMapStyle)
							{
								SoundEngine.PlaySound(12);
								Main.mapStyle++;
								if (Main.mapStyle > 2)
								{
									Main.mapStyle = 0;
								}
							}
							releaseMapStyle = false;
						}
						else
						{
							releaseMapStyle = true;
						}
					}
					if (mapFullScreen)
					{
						if (releaseMapFullscreen)
						{
							if (Main.mapFullscreen)
							{
								SoundEngine.PlaySound(11);
								Main.mapFullscreen = false;
							}
							else if (!PlayerInput.UsingGamepad || (!Main.playerInventory && !Main.ingameOptionsWindow && !Main.LocalPlayer.dead))
							{
								TryOpeningFullscreenMap();
							}
						}
						releaseMapFullscreen = false;
					}
					else
					{
						releaseMapFullscreen = true;
					}
				}
				else if (!PlayerInput.UsingGamepad && !Main.editSign && !Main.editChest && !Main.blockInput)
				{
					PlayerInput.Triggers.Current.CopyIntoDuringChat(this);
				}
				if (TryingToUseItem() && mount.Active && HeldItem.mountType != mount.Type)
				{
					mount.TryEarlyDismount(this);
				}
				if (confused)
				{
					bool flag2 = controlLeft;
					bool flag3 = controlUp;
					controlLeft = controlRight;
					controlRight = flag2;
					controlUp = controlRight;
					controlDown = flag3;
				}
				else if (cartFlip)
				{
					if (controlRight || controlLeft)
					{
						bool flag4 = controlLeft;
						controlLeft = controlRight;
						controlRight = flag4;
					}
					else
					{
						cartFlip = false;
					}
				}
				for (int l = 0; l < doubleTapCardinalTimer.Length; l++)
				{
					doubleTapCardinalTimer[l]--;
					if (doubleTapCardinalTimer[l] < 0)
					{
						doubleTapCardinalTimer[l] = 0;
					}
				}
				for (int m = 0; m < 4; m++)
				{
					bool flag5 = false;
					bool flag6 = false;
					switch (m)
					{
					case 0:
						flag5 = controlDown && releaseDown;
						flag6 = controlDown;
						break;
					case 1:
						flag5 = controlUp && releaseUp;
						flag6 = controlUp;
						break;
					case 2:
						flag5 = controlRight && releaseRight;
						flag6 = controlRight;
						break;
					case 3:
						flag5 = controlLeft && releaseLeft;
						flag6 = controlLeft;
						break;
					}
					if (flag5)
					{
						if (doubleTapCardinalTimer[m] > 0)
						{
							KeyDoubleTap(m);
						}
						else
						{
							doubleTapCardinalTimer[m] = 15;
						}
					}
					if (flag6)
					{
						holdDownCardinalTimer[m]++;
						KeyHoldDown(m, holdDownCardinalTimer[m]);
					}
					else
					{
						holdDownCardinalTimer[m] = 0;
					}
				}
				controlDownHold = holdDownCardinalTimer[0] >= 45;
				if (controlInv)
				{
					if (releaseInventory)
					{
						ToggleInv();
					}
					releaseInventory = false;
				}
				else
				{
					releaseInventory = true;
				}
				if (delayUseItem)
				{
					if (stressBall)
					{
						delayUseItem = false;
						controlUseItem = false;
					}
					else
					{
						if (!controlUseItem)
						{
							delayUseItem = false;
						}
						controlUseItem = false;
					}
				}
				if (changeItem >= 0)
				{
					selectedItemState.Select(changeItem);
					changeItem = -1;
				}
				int num6 = -1;
				if (!Main.drawingPlayerChat && !Main.editSign && !Main.editChest)
				{
					if (PlayerInput.Triggers.Current.Hotbar1)
					{
						num6 = 0;
					}
					if (PlayerInput.Triggers.Current.Hotbar2)
					{
						num6 = 1;
					}
					if (PlayerInput.Triggers.Current.Hotbar3)
					{
						num6 = 2;
					}
					if (PlayerInput.Triggers.Current.Hotbar4)
					{
						num6 = 3;
					}
					if (PlayerInput.Triggers.Current.Hotbar5)
					{
						num6 = 4;
					}
					if (PlayerInput.Triggers.Current.Hotbar6)
					{
						num6 = 5;
					}
					if (PlayerInput.Triggers.Current.Hotbar7)
					{
						num6 = 6;
					}
					if (PlayerInput.Triggers.Current.Hotbar8)
					{
						num6 = 7;
					}
					if (PlayerInput.Triggers.Current.Hotbar9)
					{
						num6 = 8;
					}
					if (PlayerInput.Triggers.Current.Hotbar10)
					{
						num6 = 9;
					}
					DpadRadial.ChangeSelection(-1);
					DpadRadial.Update();
					if (DpadRadial.SelectedBinding >= 0)
					{
						num6 = DpadRadial.SelectedItem;
					}
					CircularRadial.ChangeSelection(-1);
					CircularRadial.Update();
					if (CircularRadial.SelectedBinding >= 0)
					{
						num6 = CircularRadial.SelectedItem;
					}
					else if (selectedItemState.LastNonOverridenSelection < 10)
					{
						CircularRadial.ChangeSelection(selectedItemState.LastNonOverridenSelection);
					}
					QuicksRadial.Update();
					if (QuicksRadial.SelectedBinding != -1 && PlayerInput.Triggers.JustReleased.RadialQuickbar && !PlayerInput.MiscSettingsTEMP.HotbarRadialShouldBeUsed)
					{
						switch (QuicksRadial.SelectedBinding)
						{
						case 0:
							QuickMount();
							break;
						case 1:
							QuickHeal();
							break;
						case 2:
							QuickBuff();
							break;
						case 3:
							QuickMana();
							break;
						}
					}
					if (num6 == selectedItem && num6 >= 10 && !selectedItemState.HasActiveOverride)
					{
						num6 = selectedItemState.Hotbar;
					}
					if (num6 >= 0)
					{
						selectedItemState.Select(num6);
					}
				}
				if (num6 >= 0 && CaptureManager.Instance.Active)
				{
					CaptureManager.Instance.Active = false;
				}
				bool flag7 = Main.hairWindow;
				if (flag7)
				{
					PlayerInput.SetZoom_UI();
					int y = Main.screenHeight / 2 + 60;
					flag7 = new Rectangle(Main.screenWidth / 2 - TextureAssets.HairStyleBack.Width() / 2, y, TextureAssets.HairStyleBack.Width(), TextureAssets.HairStyleBack.Height()).Contains(Main.MouseScreen.ToPoint());
					PlayerInput.SetZoom_World();
				}
				if (Main.mapFullscreen)
				{
					float num7 = PlayerInput.ScrollWheelDelta / 120;
					if (PlayerInput.UsingGamepad)
					{
						num7 += (float)(PlayerInput.Triggers.Current.HotbarPlus.ToInt() - PlayerInput.Triggers.Current.HotbarMinus.ToInt()) * 0.1f;
					}
					Main.mapFullscreenScale *= 1f + num7 * 0.3f;
				}
				else if (CaptureManager.Instance.Active)
				{
					CaptureManager.Instance.Scrolling();
				}
				else if (!flag7)
				{
					if (Main.playerInventory)
					{
						Main.DoScrollingInInventory();
					}
					else
					{
						HandleHotbarControls();
					}
				}
				if (itemAnimation == 0 && ItemTimeIsZero && reuseDelay == 0)
				{
					dropItemCheck();
				}
			}
			selectedItemState.Update();
			if (stoned != lastStoned)
			{
				if (whoAmI == Main.myPlayer && stoned)
				{
					int damage = (int)(20.0 * (double)GameDifficultyData.EnemyDamageMultiplier.Sample(Main.Difficulty));
					Hurt(PlayerDeathReason.ByOther(5), damage, 0);
				}
				SoundEngine.PlaySound(0, (int)position.X, (int)position.Y);
				for (int n = 0; n < 20; n++)
				{
					int num8 = Dust.NewDust(position, width, height, 1);
					if (Main.rand.Next(2) == 0)
					{
						Main.dust[num8].noGravity = true;
					}
				}
			}
			lastStoned = stoned;
			if (frozen || webbed || stoned)
			{
				controlJump = false;
				controlDown = false;
				controlLeft = false;
				controlRight = false;
				controlUp = false;
				controlUseItem = false;
				controlUseTile = false;
				controlThrow = false;
				gravDir = 1f;
			}
			if (!controlThrow)
			{
				releaseThrow = true;
			}
			else
			{
				releaseThrow = false;
			}
			if (controlDown && releaseDown)
			{
				if (tryKeepingHoveringUp)
				{
					tryKeepingHoveringUp = false;
				}
				else
				{
					tryKeepingHoveringDown = true;
				}
			}
			if (controlUp && releaseUp)
			{
				if (tryKeepingHoveringDown)
				{
					tryKeepingHoveringDown = false;
				}
				else
				{
					tryKeepingHoveringUp = true;
				}
			}
			if (velocity.Y == 0f)
			{
				tryKeepingHoveringUp = false;
				tryKeepingHoveringDown = false;
			}
			if (Settings.HoverControl == Settings.HoverControlMode.Hold)
			{
				tryKeepingHoveringUp = false;
				tryKeepingHoveringDown = false;
			}
			TrySyncingInput();
			UpdateNearbyCraftingTiles();
			HandleBeingInChestRange();
			tileEntityAnchor.GetTileEntity()?.OnPlayerUpdate(this);
		}
		if (i == Main.myPlayer)
		{
			if (velocity.Y <= 0f)
			{
				fallStart2 = (int)(position.Y / 16f);
			}
			if (velocity.Y == 0f)
			{
				int num9 = 25;
				num9 += extraFall;
				if (mount.Active)
				{
					num9 += mount.ExtraFall;
				}
				int num10 = (int)(position.Y / 16f) - fallStart;
				if (mount.CanFly(this))
				{
					num10 = 0;
				}
				if (mount.AnyTrackRider && Minecart.OnTrack(position, width, height, MinecartSettings))
				{
					num10 = 0;
				}
				if (mount.Type == 1)
				{
					num10 = 0;
				}
				if (isPerformingJump_DownDash)
				{
					num10 = 0;
					DoDeadCellsGroundPoundEffect();
				}
				if (num10 > 0 || (gravDir == -1f && num10 < 0))
				{
					int num11 = (int)(position.X / 16f);
					int num12 = (int)((position.X + (float)width) / 16f);
					int num13 = (int)((position.Y + (float)height + 1f) / 16f);
					if (gravDir == -1f)
					{
						num13 = (int)((position.Y - 1f) / 16f);
					}
					for (int num14 = num11; num14 <= num12; num14++)
					{
						Tile tile = Main.tile[num14, num13];
						if (tile != null && tile.active())
						{
							bool flag8 = tile.type == 19 && tile.frameY / 18 == 49;
							if (TileID.Sets.Clouds[tile.type] || tile.type == 666 || flag8)
							{
								num10 = 0;
								break;
							}
						}
					}
				}
				bool flag9 = false;
				for (int num15 = 3; num15 < 10; num15++)
				{
					if (armor[num15].stack > 0 && armor[num15].wingSlot > -1)
					{
						flag9 = true;
					}
				}
				if (stoned)
				{
					int num16 = (int)(((float)num10 * gravDir - 2f) * 20f);
					if (num16 > 0)
					{
						Hurt(PlayerDeathReason.ByOther(5), num16, 0);
						immune = false;
						if (!dead && statLife <= statLifeMax2 / 10)
						{
							AchievementsHelper.HandleSpecialEvent(this, 8);
						}
					}
				}
				else if (((gravDir == 1f && num10 > num9) || (gravDir == -1f && num10 < -num9)) && !noFallDmg && !flag9)
				{
					immune = false;
					int num17 = (int)((float)num10 * gravDir - (float)num9) * 10;
					if (mount.Active)
					{
						num17 = (int)((float)num17 * mount.FallDamage);
					}
					if (num17 > 0)
					{
						Hurt(PlayerDeathReason.ByOther(0), num17, 0);
						if (!dead && statLife <= statLifeMax2 / 10)
						{
							AchievementsHelper.HandleSpecialEvent(this, 8);
						}
					}
				}
				fallStart = (int)(position.Y / 16f);
			}
			if (jump > 0 || rocketDelay > 0 || wet || slowFall || (double)num5 < 0.8 || tongued)
			{
				fallStart = (int)(position.Y / 16f);
			}
		}
		ChestChangeEvents();
		if (mouseInterface)
		{
			delayUseItem = true;
		}
		tileTargetX = (int)(((float)Main.mouseX + Main.screenPosition.X) / 16f);
		tileTargetY = (int)(((float)Main.mouseY + Main.screenPosition.Y) / 16f);
		if (gravDir == -1f)
		{
			tileTargetY = (int)((Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY) / 16f);
		}
		if (tileTargetX >= Main.maxTilesX - 5)
		{
			tileTargetX = Main.maxTilesX - 5;
		}
		if (tileTargetY >= Main.maxTilesY - 5)
		{
			tileTargetY = Main.maxTilesY - 5;
		}
		if (tileTargetX < 5)
		{
			tileTargetX = 5;
		}
		if (tileTargetY < 5)
		{
			tileTargetY = 5;
		}
		if (Main.tile[tileTargetX - 1, tileTargetY] == null)
		{
			Main.tile[tileTargetX - 1, tileTargetY] = new Tile();
		}
		if (Main.tile[tileTargetX + 1, tileTargetY] == null)
		{
			Main.tile[tileTargetX + 1, tileTargetY] = new Tile();
		}
		if (Main.tile[tileTargetX, tileTargetY] == null)
		{
			Main.tile[tileTargetX, tileTargetY] = new Tile();
		}
		if (inventory[selectedItem].axe > 0 && !Main.tile[tileTargetX, tileTargetY].active() && inventory[selectedItem].createWall <= 0 && (inventory[selectedItem].hammer <= 0 || inventory[selectedItem].axe != 0))
		{
			if (Main.tile[tileTargetX - 1, tileTargetY].active() && Main.tile[tileTargetX - 1, tileTargetY].type == 323)
			{
				if (Main.tile[tileTargetX - 1, tileTargetY].frameY > 4)
				{
					tileTargetX--;
				}
			}
			else if (Main.tile[tileTargetX + 1, tileTargetY].active() && Main.tile[tileTargetX + 1, tileTargetY].type == 323 && Main.tile[tileTargetX + 1, tileTargetY].frameY < -4)
			{
				tileTargetX++;
			}
		}
		Update_AdjustTileTargetForDisplayJars(i);
		if (i == Main.myPlayer)
		{
			UpdateNearbyInteractibleProjectilesList();
		}
		try
		{
			if (whoAmI == Main.myPlayer && Main.instance.IsActive && !Main.IsCameraTrackingObject)
			{
				SmartCursorHelper.SmartCursorLookup(this);
				SmartInteractLookup();
			}
		}
		catch
		{
			Main.SmartCursorWanted_GamePad = false;
			Main.SmartCursorWanted_Mouse = false;
		}
		UpdateParticles();
		UpdateImmunity();
		if (petalTimer > 0)
		{
			petalTimer--;
		}
		if (shadowDodgeTimer > 0)
		{
			shadowDodgeTimer--;
		}
		if (boneGloveTimer > 0)
		{
			boneGloveTimer--;
		}
		if (crystalLeafCooldown > 0)
		{
			crystalLeafCooldown--;
		}
		if (jump > 0 || velocity.Y != 0f)
		{
			ResetFloorFlags();
		}
		bool flag10 = pStone;
		potionDelayTime = Item.potionDelay;
		restorationDelayTime = Item.restorationDelay;
		mushroomDelayTime = Item.mushroomDelay;
		if (pStone)
		{
			potionDelayTime = (int)((float)potionDelayTime * PhilosopherStoneDurationMultiplier);
			restorationDelayTime = (int)((float)restorationDelayTime * PhilosopherStoneDurationMultiplier);
			mushroomDelayTime = (int)((float)mushroomDelayTime * PhilosopherStoneDurationMultiplier);
		}
		if (yoraiz0rEye > 0)
		{
			Yoraiz0rEye();
		}
		ResetEffects();
		UpdateDyes();
		if (CreativePowerManager.Instance.GetPower<CreativePowers.GodmodePower>().IsEnabledForPlayer(whoAmI))
		{
			creativeGodMode = true;
		}
		if (IsConsideredStandingStill && (itemAnimation == 0 || ItemID.Sets.IsAKite[HeldItem.type]) && !controlUp && !controlDown && !controlLeft && !controlRight && !controlJump && !controlTorch)
		{
			afkCounter++;
			afkCounterForKiting++;
		}
		else
		{
			afkCounter = 0;
			afkCounterForKiting = 0;
		}
		if (i == whoAmI && !Main.mouseItem.IsAir)
		{
			afkCounterForKiting = 0;
		}
		if (petting.isPetting || sitting.isSitting || sleeping.isSleeping)
		{
			afkCounterForKiting = 0;
		}
		meleeCrit += inventory[selectedItem].crit;
		magicCrit += inventory[selectedItem].crit;
		rangedCrit += inventory[selectedItem].crit;
		if (whoAmI == Main.myPlayer)
		{
			if (SceneMetrics.ZoneWaterCandle)
			{
				AddBuff(86, 2);
			}
			if (SceneMetrics.ZonePeaceCandle)
			{
				AddBuff(157, 2);
			}
			if (SceneMetrics.ZoneShadowCandle)
			{
				AddBuff(350, 2);
			}
			if (SceneMetrics.HasCampfire)
			{
				AddBuff(87, 2);
			}
			if (SceneMetrics.HasCatBast)
			{
				AddBuff(215, 2);
			}
			if (SceneMetrics.HasStarInBottle)
			{
				AddBuff(158, 2);
			}
			if (SceneMetrics.HasHeartLantern)
			{
				AddBuff(89, 2);
			}
			if (SceneMetrics.HasSunflower)
			{
				AddBuff(146, 2);
			}
			if (SceneMetrics.hasBanner)
			{
				AddBuff(147, 2);
			}
			if (!behindBackWall && ZoneSandstorm)
			{
				AddBuff(194, 2);
			}
		}
		for (int num18 = 0; num18 < BuffID.Count; num18++)
		{
			buffImmune[num18] = false;
		}
		UpdateProjectileCaches(i);
		UpdateBuffs(i);
		if (whoAmI == Main.myPlayer)
		{
			if (!onFire && !poisoned)
			{
				trapDebuffSource = false;
			}
			UpdatePet(i);
			UpdatePetLight(i);
			isOperatingAnotherEntity = ownedProjectileCounts[1020] > 0 || ownedProjectileCounts[1105] > 0;
		}
		bool flag11 = wet && !lavaWet && (!mount.Active || !mount.IsConsideredASlimeMount);
		if (accMerman && flag11)
		{
			releaseJump = true;
			wings = 0;
			merman = true;
			accFlipper = true;
			AddBuff(34, 2);
		}
		else
		{
			merman = false;
		}
		if (!flag11 && forceWerewolf)
		{
			forceMerman = false;
		}
		if (forceMerman && flag11)
		{
			wings = 0;
		}
		accMerman = false;
		hideMerman = false;
		forceMerman = false;
		if (wolfAcc && !merman && !Main.dayTime && !wereWolf)
		{
			AddBuff(28, 60);
		}
		wolfAcc = false;
		hideWolf = false;
		forceWerewolf = false;
		if (whoAmI == Main.myPlayer)
		{
			for (int num19 = 0; num19 < maxBuffs; num19++)
			{
				if (buffType[num19] > 0 && buffTime[num19] <= 0)
				{
					DelBuff(num19);
				}
			}
		}
		beetleDefense = false;
		beetleOffense = false;
		setSolar = false;
		head = armor[0].headSlot;
		body = armor[1].bodySlot;
		legs = armor[2].legSlot;
		ResetVisibleAccessories();
		if (MountFishronSpecialCounter > 0f)
		{
			MountFishronSpecialCounter -= 1f;
		}
		if (_portalPhysicsTime > 0)
		{
			_portalPhysicsTime--;
		}
		UpdateEquips(i);
		UpdateSunScorch();
		DoUnbreakableWallScan(force: true);
		if (Main.npcShop <= 0)
		{
			discountAvailable = discountEquipped;
		}
		if (flag10 != pStone)
		{
			AdjustRemainingPotionSickness();
		}
		UpdatePermanentBoosters();
		UpdateLuck();
		shimmerUnstuckHelper.Update(this);
		UpdatePortableStoolUsage();
		if (velocity.Y == 0f || controlJump)
		{
			portalPhysicsFlag = false;
		}
		if (inventory[selectedItem].type == 3384 || portalPhysicsFlag)
		{
			_portalPhysicsTime = 30;
		}
		if (mount.Active)
		{
			mount.UpdateEffects(this);
		}
		gemCount++;
		if (gemCount >= 10)
		{
			gem = -1;
			ownedLargeGems = (byte)0;
			gemCount = 0;
			for (int num20 = 0; num20 <= 58; num20++)
			{
				if (inventory[num20].type == 0 || inventory[num20].stack == 0)
				{
					inventory[num20].TurnToAir();
				}
				if (inventory[num20].type >= 1522 && inventory[num20].type <= 1527)
				{
					gem = inventory[num20].type - 1522;
					ownedLargeGems[gem] = true;
				}
				if (inventory[num20].type == 3643)
				{
					gem = 6;
					ownedLargeGems[gem] = true;
				}
			}
		}
		UpdateArmorLights();
		UpdateArmorSets(i);
		if (i == Main.myPlayer)
		{
			int num21 = ((armor[10].headSlot >= 0) ? armor[10].headSlot : armor[0].headSlot);
			int num22 = ((armor[11].bodySlot >= 0) ? armor[11].bodySlot : armor[1].bodySlot);
			int num23 = ((armor[12].legSlot >= 0) ? armor[12].legSlot : armor[2].legSlot);
			if (num21 == 12 && !Main.remixWorld && !Main.IsItRaining && Main.dayTime && Main.time >= 3600.0 && Main.time <= 50400.0 && (double)position.Y < Main.worldSurface * 16.0)
			{
				AchievementsHelper.NotifyProgressionEvent(38);
			}
			if (NPC.combatBookWasUsed && NPC.combatBookVolumeTwoWasUsed)
			{
				AchievementsHelper.NotifyProgressionEvent(40);
			}
			if (num21 == 187 && num22 == 249 && num23 == 217)
			{
				AchievementsHelper.NotifyProgressionEvent(41);
			}
			AchievementsHelper.CheckResearchAchievement();
		}
		if (shadowDodge && !onHitDodge)
		{
			ClearBuff(59);
		}
		if (maxTurretsOld != maxTurrets)
		{
			UpdateMaxTurrets();
			maxTurretsOld = maxTurrets;
		}
		if (shieldRaised)
		{
			statDefense += 20;
		}
		if ((merman || forceMerman) && flag11)
		{
			wings = 0;
		}
		if (invis)
		{
			if (itemAnimation == 0 && aggro > -750)
			{
				aggro = -750;
			}
			else if (aggro > -250)
			{
				aggro = -250;
			}
		}
		if (inventory[selectedItem].type == 3106)
		{
			if (itemAnimation > 0)
			{
				stealthTimer = 15;
				if (stealth > 0f)
				{
					stealth += 0.1f;
				}
			}
			else if ((double)velocity.X > -0.1 && (double)velocity.X < 0.1 && (double)velocity.Y > -0.1 && (double)velocity.Y < 0.1 && !mount.Active)
			{
				if (stealthTimer == 0 && stealth > 0f)
				{
					stealth -= 0.02f;
					if ((double)stealth <= 0.0)
					{
						stealth = 0f;
						if (Main.netMode == 1)
						{
							NetMessage.SendData(84, -1, -1, null, whoAmI);
						}
					}
				}
			}
			else
			{
				if (stealth > 0f)
				{
					stealth += 0.1f;
				}
				if (mount.Active)
				{
					stealth = 1f;
				}
			}
			if (stealth > 1f)
			{
				stealth = 1f;
			}
			meleeDamage += (1f - stealth) * 3f;
			meleeCrit += (int)((1f - stealth) * 30f);
			if (meleeCrit > 100)
			{
				meleeCrit = 100;
			}
			aggro -= (int)((1f - stealth) * 750f);
			if (stealthTimer > 0)
			{
				stealthTimer--;
			}
		}
		else if (shroomiteStealth)
		{
			if (itemAnimation > 0)
			{
				stealthTimer = 5;
			}
			if ((double)velocity.X > -0.1 && (double)velocity.X < 0.1 && (double)velocity.Y > -0.1 && (double)velocity.Y < 0.1 && !mount.Active)
			{
				if (stealthTimer == 0 && stealth > 0f)
				{
					stealth -= 0.015f;
					if ((double)stealth <= 0.0)
					{
						stealth = 0f;
						if (Main.netMode == 1)
						{
							NetMessage.SendData(84, -1, -1, null, whoAmI);
						}
					}
				}
			}
			else
			{
				float num24 = Math.Abs(velocity.X) + Math.Abs(velocity.Y);
				stealth += num24 * 0.0075f;
				if (stealth > 1f)
				{
					stealth = 1f;
				}
				if (mount.Active)
				{
					stealth = 1f;
				}
			}
			rangedDamage += (1f - stealth) * 0.6f;
			rangedCrit += (int)((1f - stealth) * 10f);
			aggro -= (int)((1f - stealth) * 750f);
			if (stealthTimer > 0)
			{
				stealthTimer--;
			}
		}
		else if (setVortex)
		{
			bool flag12 = false;
			if (vortexStealthActive)
			{
				float num25 = stealth;
				stealth -= 0.04f;
				if (stealth < 0f)
				{
					stealth = 0f;
				}
				else
				{
					flag12 = true;
				}
				if (stealth == 0f && num25 != stealth && Main.netMode == 1)
				{
					NetMessage.SendData(84, -1, -1, null, whoAmI);
				}
				rangedDamage += (1f - stealth) * 0.8f;
				rangedCrit += (int)((1f - stealth) * 20f);
				aggro -= (int)((1f - stealth) * 1200f);
				accRunSpeed *= 0.3f;
				maxRunSpeed *= 0.3f;
				if (mount.Active)
				{
					vortexStealthActive = false;
				}
			}
			else
			{
				float num26 = stealth;
				stealth += 0.04f;
				if (stealth > 1f)
				{
					stealth = 1f;
				}
				else
				{
					flag12 = true;
				}
				if (stealth == 1f && num26 != stealth && Main.netMode == 1)
				{
					NetMessage.SendData(84, -1, -1, null, whoAmI);
				}
			}
			if (flag12)
			{
				if (Main.rand.Next(2) == 0)
				{
					Vector2 vector = Vector2.UnitY.RotatedByRandom(6.2831854820251465);
					Dust obj2 = Main.dust[Dust.NewDust(base.Center - vector * 30f, 0, 0, 229)];
					obj2.noGravity = true;
					obj2.position = base.Center - vector * Main.rand.Next(5, 11);
					obj2.velocity = vector.RotatedBy(1.5707963705062866) * 4f;
					obj2.scale = 0.5f + Main.rand.NextFloat();
					obj2.fadeIn = 0.5f;
				}
				if (Main.rand.Next(2) == 0)
				{
					Vector2 vector2 = Vector2.UnitY.RotatedByRandom(6.2831854820251465);
					Dust obj3 = Main.dust[Dust.NewDust(base.Center - vector2 * 30f, 0, 0, 240)];
					obj3.noGravity = true;
					obj3.position = base.Center - vector2 * 12f;
					obj3.velocity = vector2.RotatedBy(-1.5707963705062866) * 2f;
					obj3.scale = 0.5f + Main.rand.NextFloat();
					obj3.fadeIn = 0.5f;
				}
			}
		}
		else
		{
			stealth = 1f;
		}
		if (manaSick)
		{
			magicDamage *= 1f - manaSickReduction;
		}
		float num27 = meleeSpeed - 1f;
		num27 *= ItemID.Sets.BonusMeleeSpeedMultiplier[inventory[selectedItem].type];
		meleeSpeed = 1f + num27;
		if (tileSpeed > 3f)
		{
			tileSpeed = 3f;
		}
		tileSpeed = 1f / tileSpeed;
		if (wallSpeed > 3f)
		{
			wallSpeed = 3f;
		}
		wallSpeed = 1f / wallSpeed;
		if (statManaMax2 > 400)
		{
			statManaMax2 = 400;
		}
		if (statDefense < 0)
		{
			statDefense = 0;
		}
		if (slowOgreSpit)
		{
			moveSpeed /= 3f;
			if (velocity.Y == 0f && Math.Abs(velocity.X) > 1f)
			{
				velocity.X /= 2f;
			}
		}
		else if (dazed)
		{
			moveSpeed /= 3f;
		}
		else if (slow)
		{
			moveSpeed /= 2f;
		}
		else if (chilled)
		{
			moveSpeed *= 0.75f;
		}
		if (shieldRaised)
		{
			moveSpeed /= 3f;
			if (velocity.Y == 0f && Math.Abs(velocity.X) > 3f)
			{
				velocity.X /= 2f;
			}
		}
		if (DD2Event.Ongoing)
		{
			DD2Event.FindArenaHitbox();
			if (DD2Event.ShouldBlockBuilding(base.Center))
			{
				noBuilding = true;
				AddBuff(199, 3);
			}
		}
		if ((double)pickSpeed < 0.3)
		{
			pickSpeed = 0.3f;
		}
		CapAttackSpeeds();
		UpdateLifeRegen();
		soulDrain = 0;
		UpdateManaRegen();
		if (manaRegenCount < 0)
		{
			manaRegenCount = 0;
		}
		if (statMana > statManaMax2)
		{
			statMana = statManaMax2;
		}
		runAcceleration *= moveSpeed;
		maxRunSpeed *= moveSpeed;
		UpdateJumpHeight();
		for (int num28 = 0; num28 < maxBuffs; num28++)
		{
			if (buffType[num28] > 0 && buffTime[num28] > 0 && buffImmune[buffType[num28]])
			{
				DelBuff(num28);
			}
		}
		if (brokenArmor)
		{
			statDefense /= 2;
		}
		if (witheredArmor)
		{
			statDefense /= 2;
		}
		if (witheredWeapon)
		{
			meleeDamage *= 0.5f;
			rangedDamage *= 0.5f;
			magicDamage *= 0.5f;
			minionDamage *= 0.5f;
			rangedMultDamage *= 0.5f;
		}
		lastTileRangeX = tileRangeX;
		lastTileRangeY = tileRangeY;
		if (mount.Active)
		{
			movementAbilitiesCache.CopyFrom(this);
		}
		else
		{
			movementAbilitiesCache.PasteInto(this);
		}
		if (mount.Active && mount.BlockExtraJumps)
		{
			canJumpAgain_Cloud = false;
			canJumpAgain_Sandstorm = false;
			canJumpAgain_Blizzard = false;
			canJumpAgain_Fart = false;
			canJumpAgain_Sail = false;
			canJumpAgain_Unicorn = false;
			canJumpAgain_Santank = false;
			canJumpAgain_WallOfFleshGoat = false;
			canJumpAgain_Basilisk = false;
		}
		else if (velocity.Y == 0f || sliding)
		{
			RefreshDoubleJumps();
		}
		else
		{
			if (!hasJumpOption_Cloud)
			{
				canJumpAgain_Cloud = false;
			}
			if (!hasJumpOption_Sandstorm)
			{
				canJumpAgain_Sandstorm = false;
			}
			if (!hasJumpOption_Blizzard)
			{
				canJumpAgain_Blizzard = false;
			}
			if (!hasJumpOption_Fart)
			{
				canJumpAgain_Fart = false;
			}
			if (!hasJumpOption_Sail)
			{
				canJumpAgain_Sail = false;
			}
			if (!hasJumpOption_Unicorn)
			{
				canJumpAgain_Unicorn = false;
			}
			if (!hasJumpOption_Santank)
			{
				canJumpAgain_Santank = false;
			}
			if (!hasJumpOption_WallOfFleshGoat)
			{
				canJumpAgain_WallOfFleshGoat = false;
			}
			if (!hasJumpOption_Basilisk)
			{
				canJumpAgain_Basilisk = false;
			}
		}
		if (!carpet)
		{
			canCarpet = false;
			carpetFrame = -1;
		}
		else if (velocity.Y == 0f || sliding)
		{
			canCarpet = true;
			carpetTime = 0;
			carpetFrame = -1;
			carpetFrameCounter = 0f;
		}
		if (gravDir == -1f)
		{
			canCarpet = false;
		}
		if (ropeCount > 0)
		{
			ropeCount--;
		}
		if (!pulley && !frozen && !webbed && !stoned && !controlJump && gravDir == 1f && ropeCount == 0 && grappling[0] == -1 && !tongued && !mount.Active)
		{
			FindPulley();
		}
		UpdatePettingAnimal();
		sitting.UpdateSitting(this);
		sleeping.UpdateState(this);
		eyeHelper.Update(this);
		if (pulley)
		{
			if (mount.Active)
			{
				pulley = false;
			}
			sandStorm = false;
			CancelAllJumpVisualEffects();
			int num29 = (int)(position.X + (float)(width / 2)) / 16;
			int num30 = (int)(position.Y - 8f) / 16;
			bool flag13 = false;
			if (pulleyDir == 0)
			{
				pulleyDir = 1;
			}
			if (pulleyDir == 1)
			{
				if (direction == -1 && controlLeft && (releaseLeft || leftTimer == 0))
				{
					pulleyDir = 2;
					flag13 = true;
				}
				else if ((direction == 1 && controlRight && releaseRight) || rightTimer == 0)
				{
					pulleyDir = 2;
					flag13 = true;
				}
				else
				{
					if (direction == 1 && controlLeft)
					{
						direction = -1;
						flag13 = true;
					}
					if (direction == -1 && controlRight)
					{
						direction = 1;
						flag13 = true;
					}
				}
			}
			else if (pulleyDir == 2)
			{
				if (direction == 1 && controlLeft)
				{
					flag13 = true;
					if (!Collision.SolidCollision(new Vector2(num29 * 16 + 8 - width / 2, position.Y), width, height))
					{
						pulleyDir = 1;
						direction = -1;
						flag13 = true;
					}
				}
				if (direction == -1 && controlRight)
				{
					flag13 = true;
					if (!Collision.SolidCollision(new Vector2(num29 * 16 + 8 - width / 2, position.Y), width, height))
					{
						pulleyDir = 1;
						direction = 1;
						flag13 = true;
					}
				}
			}
			int num31 = 1;
			if (controlLeft)
			{
				num31 = -1;
			}
			bool flag14 = CanMoveForwardOnRope(num31, num29, num30);
			if (controlLeft && direction == -1 && flag14)
			{
				instantMovementAccumulatedThisFrame.X += -1f;
			}
			if (controlRight && direction == 1 && flag14)
			{
				instantMovementAccumulatedThisFrame.X += 1f;
			}
			bool flag15 = false;
			if (!flag13 && ((controlLeft && (releaseLeft || leftTimer == 0)) || (controlRight && (releaseRight || rightTimer == 0))))
			{
				int num32 = num29 + num31;
				if (WorldGen.IsRope(num32, num30))
				{
					pulleyDir = 1;
					direction = num31;
					int num33 = num32 * 16 + 8 - width / 2;
					float y2 = position.Y;
					y2 = num30 * 16 + 22;
					if (Main.tile[num32, num30 - 1] == null)
					{
						Main.tile[num32, num30 - 1] = new Tile();
					}
					if (Main.tile[num32, num30 + 1] == null)
					{
						Main.tile[num32, num30 + 1] = new Tile();
					}
					if (WorldGen.IsRope(num32, num30 - 1) || WorldGen.IsRope(num32, num30 + 1))
					{
						y2 = num30 * 16 + 22;
					}
					if (Collision.SolidCollision(new Vector2(num33, y2), width, height))
					{
						pulleyDir = 2;
						direction = -num31;
						num33 = ((direction != 1) ? (num32 * 16 + 8 - width / 2 + -6) : (num32 * 16 + 8 - width / 2 + 6));
					}
					if (i == Main.myPlayer)
					{
						Main.cameraX = Main.cameraX + position.X - (float)num33;
					}
					position.X = num33;
					gfxOffY = position.Y - y2;
					position.Y = y2;
					flag15 = true;
				}
			}
			if (!flag15 && !flag13 && !controlUp && ((controlLeft && releaseLeft) || (controlRight && releaseRight)))
			{
				pulley = false;
				if (controlLeft && velocity.X == 0f)
				{
					velocity.X = -1f;
				}
				if (controlRight && velocity.X == 0f)
				{
					velocity.X = 1f;
				}
			}
			if (velocity.X != 0f)
			{
				pulley = false;
			}
			if (Main.tile[num29, num30] == null)
			{
				Main.tile[num29, num30] = new Tile();
			}
			if (!WorldGen.IsRope(num29, num30))
			{
				pulley = false;
			}
			if (gravDir != 1f)
			{
				pulley = false;
			}
			if (frozen || webbed || stoned)
			{
				pulley = false;
			}
			if (!pulley)
			{
				velocity.Y -= gravity;
			}
			if (controlJump)
			{
				pulley = false;
				jump = jumpHeight;
				velocity.Y = 0f - jumpSpeed;
			}
		}
		if (grapCount > 0)
		{
			pulley = false;
		}
		if (NPC.brainOfGravity >= 0 && NPC.brainOfGravity < Main.maxNPCs && Vector2.Distance(base.Center, Main.npc[NPC.brainOfGravity].Center) < 4000f)
		{
			forcedGravity = 10;
		}
		if (forcedGravity > 0)
		{
			gravDir = -1f;
		}
		if (pulley)
		{
			fallStart = (int)position.Y / 16;
			wingFrame = 0;
			if (wings == 4)
			{
				wingFrame = 3;
			}
			int num34 = (int)(position.X + (float)(width / 2)) / 16;
			int num35 = (int)(position.Y - 16f) / 16;
			int num36 = (int)(position.Y - 8f) / 16;
			bool flag16 = true;
			bool flag17 = false;
			if (WorldGen.IsRope(num34, num36 - 1) || WorldGen.IsRope(num34, num36 + 1))
			{
				flag17 = true;
			}
			if (Main.tile[num34, num35] == null)
			{
				Main.tile[num34, num35] = new Tile();
			}
			if (!WorldGen.IsRope(num34, num35))
			{
				flag16 = false;
				if (velocity.Y < 0f)
				{
					velocity.Y = 0f;
				}
			}
			if (flag17)
			{
				if (controlUp && flag16)
				{
					float x = position.X;
					float y3 = position.Y - Math.Abs(velocity.Y) - 2f;
					if (Collision.SolidCollision(new Vector2(x, y3), width, height))
					{
						x = num34 * 16 + 8 - width / 2 + 6;
						if (!Collision.SolidCollision(new Vector2(x, y3), width, (int)((float)height + Math.Abs(velocity.Y) + 2f)))
						{
							if (i == Main.myPlayer)
							{
								Main.cameraX = Main.cameraX + position.X - x;
							}
							pulleyDir = 2;
							direction = 1;
							position.X = x;
							velocity.X = 0f;
						}
						else
						{
							x = num34 * 16 + 8 - width / 2 + -6;
							if (!Collision.SolidCollision(new Vector2(x, y3), width, (int)((float)height + Math.Abs(velocity.Y) + 2f)))
							{
								if (i == Main.myPlayer)
								{
									Main.cameraX = Main.cameraX + position.X - x;
								}
								pulleyDir = 2;
								direction = -1;
								position.X = x;
								velocity.X = 0f;
							}
						}
					}
					if (velocity.Y > 0f)
					{
						velocity.Y *= 0.7f;
					}
					if (velocity.Y > -3f)
					{
						velocity.Y -= 0.2f;
					}
					else
					{
						velocity.Y -= 0.02f;
					}
					if (velocity.Y < -8f)
					{
						velocity.Y = -8f;
					}
				}
				else if (controlDown)
				{
					float x2 = position.X;
					float y4 = position.Y;
					if (Collision.SolidCollision(new Vector2(x2, y4), width, (int)((float)height + Math.Abs(velocity.Y) + 2f)))
					{
						x2 = num34 * 16 + 8 - width / 2 + 6;
						if (!Collision.SolidCollision(new Vector2(x2, y4), width, (int)((float)height + Math.Abs(velocity.Y) + 2f)))
						{
							if (i == Main.myPlayer)
							{
								Main.cameraX = Main.cameraX + position.X - x2;
							}
							pulleyDir = 2;
							direction = 1;
							position.X = x2;
							velocity.X = 0f;
						}
						else
						{
							x2 = num34 * 16 + 8 - width / 2 + -6;
							if (!Collision.SolidCollision(new Vector2(x2, y4), width, (int)((float)height + Math.Abs(velocity.Y) + 2f)))
							{
								if (i == Main.myPlayer)
								{
									Main.cameraX = Main.cameraX + position.X - x2;
								}
								pulleyDir = 2;
								direction = -1;
								position.X = x2;
								velocity.X = 0f;
							}
						}
					}
					if (velocity.Y < 0f)
					{
						velocity.Y *= 0.7f;
					}
					if (velocity.Y < 3f)
					{
						velocity.Y += 0.2f;
					}
					else
					{
						velocity.Y += 0.1f;
					}
					if (velocity.Y > maxFallSpeed)
					{
						velocity.Y = maxFallSpeed;
					}
				}
				else
				{
					velocity.Y *= 0.7f;
					if ((double)velocity.Y > -0.1 && (double)velocity.Y < 0.1)
					{
						velocity.Y = 0f;
					}
				}
			}
			else if (controlDown)
			{
				ropeCount = 10;
				pulley = false;
				velocity.Y = 1f;
			}
			else
			{
				velocity.Y = 0f;
				position.Y = num35 * 16 + 22;
			}
			float num37 = num34 * 16 + 8 - width / 2;
			if (pulleyDir == 1)
			{
				num37 = num34 * 16 + 8 - width / 2;
			}
			if (pulleyDir == 2)
			{
				num37 = num34 * 16 + 8 - width / 2 + 6 * direction;
			}
			if (i == Main.myPlayer)
			{
				Main.cameraX += position.X - num37;
				Main.cameraX = MathHelper.Clamp(Main.cameraX, -32f, 32f);
			}
			position.X = num37;
			pulleyFrameCounter += Math.Abs(velocity.Y * 0.75f);
			if (velocity.Y != 0f)
			{
				pulleyFrameCounter += 0.75f;
			}
			if (pulleyFrameCounter > 10f)
			{
				pulleyFrame++;
				pulleyFrameCounter = 0f;
			}
			if (pulleyFrame > 1)
			{
				pulleyFrame = 0;
			}
			canCarpet = true;
			carpetFrame = -1;
			wingTime = wingTimeMax;
			rocketTime = rocketTimeMax;
			rocketDelay = 0;
			rocketFrame = false;
			canRocket = false;
			rocketRelease = false;
			DashMovement();
			UpdateControlHolds();
		}
		else if (grappling[0] == -1 && !tongued)
		{
			if (wingsLogic > 0 && velocity.Y != 0f && !merman && mount.CanUseWings)
			{
				WingAirLogicTweaks();
			}
			if (empressBrooch)
			{
				runAcceleration *= 1.75f;
			}
			if (hasMagiluminescence && velocity.Y == 0f)
			{
				runAcceleration *= 1.75f;
				maxRunSpeed *= 1.15f;
				accRunSpeed *= 1.15f;
				runSlowdown *= 1.75f;
			}
			if (shadowArmor)
			{
				runAcceleration *= 1.75f;
				maxRunSpeed *= 1.15f;
				accRunSpeed *= 1.15f;
				runSlowdown *= 1.75f;
			}
			if (mount.Active && mount.Type == 43 && velocity.Y != 0f)
			{
				runSlowdown = 0f;
			}
			if (sticky)
			{
				maxRunSpeed *= 0.25f;
				runAcceleration *= 0.25f;
				runSlowdown *= 2f;
				if (velocity.X > maxRunSpeed)
				{
					velocity.X = maxRunSpeed;
				}
				if (velocity.X < 0f - maxRunSpeed)
				{
					velocity.X = 0f - maxRunSpeed;
				}
			}
			else if (powerrun)
			{
				maxRunSpeed *= 3.5f;
				runAcceleration *= 1f;
				runSlowdown *= 2f;
			}
			else if (runningOnSand && desertBoots)
			{
				float num38 = 1.75f;
				maxRunSpeed *= num38;
				accRunSpeed *= num38;
				runAcceleration *= num38;
				runSlowdown *= num38;
			}
			else if (slippy2)
			{
				runAcceleration *= 0.6f;
				runSlowdown = 0f;
				if (iceSkate)
				{
					runAcceleration *= 3.5f;
					maxRunSpeed *= 1.25f;
				}
			}
			else if (slippy)
			{
				runAcceleration *= 0.7f;
				if (iceSkate)
				{
					runAcceleration *= 3.5f;
					maxRunSpeed *= 1.25f;
				}
				else
				{
					runSlowdown *= 0.1f;
				}
			}
			if (sandStorm)
			{
				runAcceleration *= 1.5f;
				maxRunSpeed *= 2f;
			}
			if (isPerformingJump_Blizzard && hasJumpOption_Blizzard)
			{
				runAcceleration *= 3f;
				maxRunSpeed *= 1.5f;
			}
			if (isPerformingJump_Fart && hasJumpOption_Fart)
			{
				runAcceleration *= 3f;
				maxRunSpeed *= 1.75f;
			}
			if (isPerformingJump_Unicorn && hasJumpOption_Unicorn)
			{
				runAcceleration *= 3f;
				maxRunSpeed *= 1.5f;
			}
			if (isPerformingJump_Santank && hasJumpOption_Santank)
			{
				runAcceleration *= 3f;
				maxRunSpeed *= 1.5f;
			}
			if (isPerformingJump_WallOfFleshGoat && hasJumpOption_WallOfFleshGoat)
			{
				runAcceleration *= 3f;
				maxRunSpeed *= 1.5f;
			}
			if (isPerformingJump_Basilisk && hasJumpOption_Basilisk)
			{
				runAcceleration *= 3f;
				maxRunSpeed *= 1.5f;
			}
			if (isPerformingJump_Sail && hasJumpOption_Sail)
			{
				runAcceleration *= 1.5f;
				maxRunSpeed *= 1.25f;
			}
			if (carpetFrame != -1)
			{
				runAcceleration *= 1.25f;
				maxRunSpeed *= 1.5f;
			}
			if (inventory[selectedItem].type == 3106 && stealth < 1f)
			{
				float num39 = maxRunSpeed / 2f * (1f - stealth);
				maxRunSpeed -= num39;
				accRunSpeed = maxRunSpeed;
			}
			if (mount.Active)
			{
				if (!mount.CanUseWings)
				{
					runSlowdown = 0.2f;
				}
				rocketBoots = 0;
				vanityRocketBoots = 0;
				if (!mount.CanUseWings)
				{
					wings = 0;
					wingsLogic = 0;
				}
				if (mount.CanUseWings && wingsLogic > 0 && velocity.Y != 0f)
				{
					maxRunSpeed = Math.Max(maxRunSpeed, mount.RunSpeed);
					accRunSpeed = Math.Max(accRunSpeed, mount.DashSpeed);
					runAcceleration = Math.Max(runAcceleration, mount.Acceleration);
				}
				else
				{
					maxRunSpeed = mount.RunSpeed;
					accRunSpeed = mount.DashSpeed;
					runAcceleration = mount.Acceleration;
				}
				if (mount.Type == 12 && !MountFishronSpecial)
				{
					runAcceleration /= 2f;
					maxRunSpeed /= 2f;
				}
				if (MountID.Sets.IsRollerSkates[mount.Type])
				{
					RollerSkateMovement();
				}
				mount.AbilityRecovery();
				if (mount.Cart && velocity.Y == 0f)
				{
					if (!Minecart.OnTrack(position, width, height, MinecartSettings))
					{
						fullRotation = 0f;
						onWrongGround = true;
						runSlowdown = 0.2f;
						if ((controlLeft && releaseLeft) || (controlRight && releaseRight))
						{
							mount.TryDismount(this);
						}
					}
					else
					{
						runSlowdown = runAcceleration;
						onWrongGround = false;
					}
				}
				if (mount.Type == 8)
				{
					mount.UpdateDrill(this, controlUp, controlDown);
				}
			}
			HorizontalMovement();
			bool flag18 = !mount.Active;
			if (forcedGravity > 0)
			{
				gravDir = -1f;
			}
			else if (gravControl && flag18)
			{
				if (controlUp && releaseUp)
				{
					if (gravDir == 1f)
					{
						gravDir = -1f;
						fallStart = (int)(position.Y / 16f);
						jump = 0;
						SoundEngine.PlaySound(SoundID.Item8, position);
					}
					else
					{
						gravDir = 1f;
						fallStart = (int)(position.Y / 16f);
						jump = 0;
						SoundEngine.PlaySound(SoundID.Item8, position);
					}
				}
			}
			else if (gravControl2 && flag18)
			{
				if (controlUp && releaseUp)
				{
					if (gravDir == 1f)
					{
						gravDir = -1f;
						fallStart = (int)(position.Y / 16f);
						jump = 0;
						SoundEngine.PlaySound(SoundID.Item8, position);
					}
					else
					{
						gravDir = 1f;
						fallStart = (int)(position.Y / 16f);
						jump = 0;
						SoundEngine.PlaySound(SoundID.Item8, position);
					}
				}
			}
			else
			{
				gravDir = 1f;
			}
			if (velocity.Y == 0f && mount.Active && mount.CanHover() && controlUp && releaseUp)
			{
				velocity.Y = 0f - (mount.Acceleration + gravity + 0.001f);
			}
			UpdateControlHolds();
			sandStorm = false;
			JumpMovement();
			if (wingsLogic == 0)
			{
				wingTime = 0f;
			}
			if (rocketBoots == 0)
			{
				rocketTime = 0;
			}
			if (jump == 0)
			{
				CancelAllJumpVisualEffects(includeDownDash: false);
			}
			DashMovement();
			if (mount.Active && mount.Type == 55)
			{
				WallClimbMovement();
			}
			else
			{
				WallslideMovement();
			}
			CarpetMovement();
			DoubleJumpVisuals();
			if (wingsLogic > 0 || mount.Active)
			{
				sandStorm = false;
			}
			if (((gravDir == 1f && velocity.Y > 0f - jumpSpeed) || (gravDir == -1f && velocity.Y < jumpSpeed)) && velocity.Y != 0f)
			{
				canRocket = true;
			}
			bool flag19 = false;
			if (((velocity.Y == 0f || sliding) && releaseJump) || (autoJump && justJumped))
			{
				wingTime = wingTimeMax;
				mount.ResetFlightTime(this);
			}
			if (wingsLogic > 0 && controlJump)
			{
				fullRotation = 0f;
			}
			if (wingsLogic > 0 && controlJump && wingTime > 0f && jump == 0 && velocity.Y != 0f)
			{
				flag19 = true;
			}
			if ((wingsLogic == 22 || wingsLogic == 28 || wingsLogic == 30 || wingsLogic == 32 || wingsLogic == 29 || wingsLogic == 33 || wingsLogic == 35 || wingsLogic == 37 || wingsLogic == 45) && controlJump && TryingToHoverDown && wingTime > 0f)
			{
				flag19 = true;
			}
			bool flag20 = isPerformingJump_DownDash;
			if (flag20)
			{
				flag19 = false;
			}
			if (frozen || webbed || stoned)
			{
				if (mount.Active)
				{
					mount.TryDismount(this);
				}
				velocity.Y += gravity;
				if (velocity.Y > maxFallSpeed)
				{
					velocity.Y = maxFallSpeed;
				}
				sandStorm = false;
				CancelAllJumpVisualEffects();
			}
			else
			{
				if (flag19)
				{
					WingAirVisuals();
					WingMovement();
				}
				WingFrame(flag19);
				if (velocity.Y == 0f)
				{
					cartRampTime = 0;
				}
				if (wingsLogic > 0 && rocketBoots != 0 && velocity.Y != 0f && rocketTime != 0)
				{
					int num40 = 6;
					int num41 = rocketTime * num40;
					wingTime += num41;
					if (wingTime > (float)(wingTimeMax + num41))
					{
						wingTime = wingTimeMax + num41;
					}
					rocketTime = 0;
				}
				if (flag19 && wings != 4 && wings != 22 && wings != 0 && wings != 24 && wings != 28 && wings != 30 && wings != 33 && wings != 45)
				{
					bool flag21 = wingFrame == 3;
					if (wings == 43 || wings == 44)
					{
						flag21 = wingFrame == 4;
					}
					if (wings == 49)
					{
						flag21 = wingFrame == 5;
					}
					if (flag21)
					{
						if (!flapSound)
						{
							SoundEngine.PlaySound(SoundID.Item32, position);
						}
						flapSound = true;
					}
					else
					{
						flapSound = false;
					}
				}
				if (velocity.Y == 0f || sliding || (autoJump && justJumped))
				{
					rocketTime = rocketTimeMax;
				}
				if (empressBrooch)
				{
					rocketTime = rocketTimeMax;
				}
				if ((wingTime == 0f || wingsLogic == 0) && rocketBoots != 0 && controlJump && rocketDelay == 0 && canRocket && rocketRelease && CanUseBootFlyingAbilities)
				{
					if (rocketTime > 0)
					{
						rocketTime--;
						rocketDelay = 10;
						if (rocketDelay2 <= 0)
						{
							if (rocketBoots == 1)
							{
								rocketDelay2 = 30;
							}
							else if (rocketBoots == 2 || rocketBoots == 5 || rocketBoots == 3 || rocketBoots == 4)
							{
								rocketDelay2 = 15;
							}
						}
						if (rocketSoundDelay <= 0)
						{
							if (vanityRocketBoots == 1 || vanityRocketBoots == 5)
							{
								rocketSoundDelay = 30;
								SoundEngine.PlaySound(SoundID.Item13, position);
							}
							else if (vanityRocketBoots == 2 || vanityRocketBoots == 3 || vanityRocketBoots == 4 || vanityRocketBoots == 6)
							{
								rocketSoundDelay = 15;
								SoundEngine.PlaySound(SoundID.Item24, position);
							}
						}
					}
					else
					{
						canRocket = false;
					}
				}
				if (rocketSoundDelay > 0)
				{
					rocketSoundDelay--;
				}
				if (rocketDelay2 > 0)
				{
					rocketDelay2--;
				}
				if (rocketDelay == 0)
				{
					rocketFrame = false;
				}
				if (rocketDelay > 0)
				{
					rocketFrame = true;
					RocketBootVisuals();
					if (rocketDelay == 0)
					{
						releaseJump = true;
					}
					rocketDelay--;
					velocity.Y -= 0.1f * gravDir;
					if (gravDir == 1f)
					{
						if (velocity.Y > 0f)
						{
							velocity.Y -= 0.5f;
						}
						else if ((double)velocity.Y > (double)(0f - jumpSpeed) * 0.5)
						{
							velocity.Y -= 0.1f;
						}
						if (velocity.Y < (0f - jumpSpeed) * 1.5f)
						{
							velocity.Y = (0f - jumpSpeed) * 1.5f;
						}
					}
					else
					{
						if (velocity.Y < 0f)
						{
							velocity.Y += 0.5f;
						}
						else if ((double)velocity.Y < (double)jumpSpeed * 0.5)
						{
							velocity.Y += 0.1f;
						}
						if (velocity.Y > jumpSpeed * 1.5f)
						{
							velocity.Y = jumpSpeed * 1.5f;
						}
					}
				}
				else if (!flag19)
				{
					if (mount.CanHover())
					{
						mount.Hover(this);
					}
					else if (mount.CanFly(this) && controlJump && jump == 0)
					{
						if (mount.Flight())
						{
							if (TryingToHoverDown)
							{
								velocity.Y *= 0.9f;
								if (velocity.Y > -1f && (double)velocity.Y < 0.5)
								{
									velocity.Y = 1E-05f;
								}
							}
							else
							{
								float num42 = 0.1f;
								float num43 = jumpSpeed;
								if (mount.Type == 50)
								{
									num43 *= 0.5f;
								}
								if (mount.Type == 56 || mount.Type == 61)
								{
									num43 /= 1.5f;
								}
								if (mount.Type == 54 && wingsLogic > 0)
								{
									WingStats wingStats = GetWingStats(wingsLogic);
									num43 = wingStats.AccRunSpeedOverride / 1.5f;
									num42 *= wingStats.AccRunAccelerationMult;
								}
								if (velocity.Y > 0f)
								{
									velocity.Y -= num42 * 5f;
								}
								else if (velocity.Y > (0f - num43) * 1.5f)
								{
									velocity.Y -= num42;
								}
								if (velocity.Y < (0f - num43) * 1.5f)
								{
									velocity.Y = (0f - num43) * 1.5f;
								}
							}
						}
						else
						{
							velocity.Y += gravity / 3f * gravDir;
							if (gravDir == 1f)
							{
								if (velocity.Y > maxFallSpeed / 3f && !TryingToHoverDown)
								{
									velocity.Y = maxFallSpeed / 3f;
								}
							}
							else if (velocity.Y < (0f - maxFallSpeed) / 3f && !TryingToHoverUp)
							{
								velocity.Y = (0f - maxFallSpeed) / 3f;
							}
						}
					}
					else if (slowFall && !TryingToHoverDown && !flag20)
					{
						if (TryingToHoverUp)
						{
							gravity = gravity / 10f * gravDir;
						}
						else
						{
							gravity = gravity / 3f * gravDir;
						}
						velocity.Y += gravity;
					}
					else if (wingsLogic > 0 && controlJump && velocity.Y > 0f && !flag20)
					{
						bool noLightEmittence = wingsLogic != wings;
						fallStart = (int)(position.Y / 16f);
						if (velocity.Y > 0f)
						{
							if (wings == 10 && Main.rand.Next(3) == 0)
							{
								int num44 = 4;
								if (direction == 1)
								{
									num44 = -40;
								}
								int num45 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num44, position.Y + (float)(height / 2) - 15f), 30, 30, 76, 0f, 0f, 50, default(Color), 0.6f);
								Main.dust[num45].fadeIn = 1.1f;
								Main.dust[num45].noGravity = true;
								Main.dust[num45].noLight = true;
								Main.dust[num45].velocity *= 0.3f;
								Main.dust[num45].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
							}
							if (wings == 34 && ShouldDrawWingsThatAreAlwaysAnimated() && Main.rand.Next(3) == 0)
							{
								int num46 = 4;
								if (direction == 1)
								{
									num46 = -40;
								}
								int num47 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num46, position.Y + (float)(height / 2) - 15f), 30, 30, 261, 0f, 0f, 50, default(Color), 0.6f);
								Main.dust[num47].fadeIn = 1.1f;
								Main.dust[num47].noGravity = true;
								Main.dust[num47].noLight = true;
								Main.dust[num47].noLightEmittence = noLightEmittence;
								Main.dust[num47].velocity *= 0.3f;
								Main.dust[num47].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
							}
							if (wings == 51 && Main.rand.Next(5) == 0)
							{
								int num48 = 4;
								if (direction == 1)
								{
									num48 = -40;
								}
								int num49 = Dust.NewDust(newColor: new Color(230, 130, 55), Position: new Vector2(position.X + (float)(width / 2) + (float)num48, position.Y + (float)(height / 2) - 15f), Width: 30, Height: 30, Type: 261, SpeedX: 0f, SpeedY: 0f, Alpha: 50, Scale: 0.6f);
								Main.dust[num49].fadeIn = 1.1f;
								Main.dust[num49].noGravity = true;
								Main.dust[num49].noLight = true;
								Main.dust[num49].noLightEmittence = noLightEmittence;
								Main.dust[num49].velocity *= 0.3f;
								Main.dust[num49].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
							}
							if (wings == 40)
							{
								ShouldDrawWingsThatAreAlwaysAnimated();
							}
							if (wings == 44)
							{
								ShouldDrawWingsThatAreAlwaysAnimated();
							}
							if (wings == 9 && Main.rand.Next(3) == 0)
							{
								int num50 = 8;
								if (direction == 1)
								{
									num50 = -40;
								}
								int num51 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num50, position.Y + (float)(height / 2) - 15f), 30, 30, 6, 0f, 0f, 200, default(Color), 2f);
								Main.dust[num51].noGravity = true;
								Main.dust[num51].velocity *= 0.3f;
								Main.dust[num51].noLightEmittence = noLightEmittence;
								Main.dust[num51].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
							}
							if (wings == 29 && Main.rand.Next(3) == 0)
							{
								int num52 = 8;
								if (direction == 1)
								{
									num52 = -40;
								}
								int num53 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num52, position.Y + (float)(height / 2) - 15f), 30, 30, 6, 0f, 0f, 100, default(Color), 2.4f);
								Main.dust[num53].noGravity = true;
								Main.dust[num53].velocity *= 0.3f;
								Main.dust[num53].noLightEmittence = noLightEmittence;
								if (Main.rand.Next(10) == 0)
								{
									Main.dust[num53].fadeIn = 2f;
								}
								Main.dust[num53].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
							}
							if (wings == 6)
							{
								if (Main.rand.Next(10) == 0)
								{
									int num54 = 4;
									if (direction == 1)
									{
										num54 = -40;
									}
									int num55 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num54, position.Y + (float)(height / 2) - 12f), 30, 20, 55, 0f, 0f, 200);
									Main.dust[num55].noLightEmittence = noLightEmittence;
									Main.dust[num55].velocity *= 0.3f;
									Main.dust[num55].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
								}
							}
							else if (wings == 5 && Main.rand.Next(6) == 0)
							{
								int num56 = 6;
								if (direction == 1)
								{
									num56 = -30;
								}
								int num57 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num56, position.Y), 18, height, 58, 0f, 0f, 255, default(Color), 1.2f);
								Main.dust[num57].velocity *= 0.3f;
								Main.dust[num57].noLightEmittence = noLightEmittence;
								Main.dust[num57].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
							}
							if (wings == 4)
							{
								rocketDelay2--;
								if (rocketDelay2 <= 0)
								{
									SoundEngine.PlaySound(SoundID.Item13, position);
									rocketDelay2 = 60;
								}
								int type = 6;
								float scale = 1.5f;
								int alpha = 100;
								float x3 = position.X + (float)(width / 2) + 16f;
								if (direction > 0)
								{
									x3 = position.X + (float)(width / 2) - 26f;
								}
								float num58 = position.Y + (float)height - 18f;
								if (Main.rand.Next(2) == 1)
								{
									x3 = position.X + (float)(width / 2) + 8f;
									if (direction > 0)
									{
										x3 = position.X + (float)(width / 2) - 20f;
									}
									num58 += 6f;
								}
								int num59 = Dust.NewDust(new Vector2(x3, num58), 8, 8, type, 0f, 0f, alpha, default(Color), scale);
								Main.dust[num59].velocity.X *= 0.3f;
								Main.dust[num59].velocity.Y += 10f;
								Main.dust[num59].noGravity = true;
								Main.dust[num59].noLightEmittence = noLightEmittence;
								Main.dust[num59].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
								wingFrameCounter++;
								if (wingFrameCounter > 4)
								{
									wingFrame++;
									wingFrameCounter = 0;
									if (wingFrame >= 3)
									{
										wingFrame = 0;
									}
								}
							}
							else if (wings != 22 && wings != 28)
							{
								if (wings == 30)
								{
									wingFrameCounter++;
									int num60 = 5;
									if (wingFrameCounter >= num60 * 3)
									{
										wingFrameCounter = 0;
									}
									wingFrame = 1 + wingFrameCounter / num60;
								}
								else if (wings == 34)
								{
									wingFrameCounter++;
									int num61 = 7;
									if (wingFrameCounter >= num61 * 6)
									{
										wingFrameCounter = 0;
									}
									wingFrame = wingFrameCounter / num61;
								}
								else if (wings != 51 && wings != 47)
								{
									if (wings == 48)
									{
										wingFrame = 3;
									}
									else if (wings != 45)
									{
										if (wings == 40)
										{
											wingFrame = 0;
										}
										else if (wings == 44)
										{
											wingFrame = 2;
										}
										else if (wings == 39)
										{
											wingFrameCounter++;
											int num62 = 12;
											if (wingFrameCounter >= num62 * 6)
											{
												wingFrameCounter = 0;
											}
											wingFrame = wingFrameCounter / num62;
										}
										else if (wings == 26)
										{
											int num63 = 6;
											if (direction == 1)
											{
												num63 = -30;
											}
											int num64 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num63, position.Y), 18, height, 217, 0f, 0f, 100, default(Color), 1.4f);
											Main.dust[num64].noGravity = true;
											Main.dust[num64].noLight = true;
											Main.dust[num64].velocity /= 4f;
											Main.dust[num64].velocity -= velocity;
											Main.dust[num64].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
											if (Main.rand.Next(2) == 0)
											{
												num63 = -24;
												if (direction == 1)
												{
													num63 = 12;
												}
												float num65 = position.Y;
												if (gravDir == -1f)
												{
													num65 += (float)(height / 2);
												}
												num64 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num63, num65), 12, height / 2, 217, 0f, 0f, 100, default(Color), 1.4f);
												Main.dust[num64].noGravity = true;
												Main.dust[num64].noLight = true;
												Main.dust[num64].velocity /= 4f;
												Main.dust[num64].velocity -= velocity;
												Main.dust[num64].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
											}
											wingFrame = 2;
										}
										else if (wings == 37)
										{
											Color color = Color.Lerp(Color.Black, Color.White, Main.rand.NextFloat());
											int num66 = 6;
											if (direction == 1)
											{
												num66 = -30;
											}
											int num67 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num66, position.Y), 24, height, Utils.SelectRandom<int>(Main.rand, 31, 31, 31), 0f, 0f, 100, default(Color), 0.7f);
											Main.dust[num67].noGravity = true;
											Main.dust[num67].noLight = true;
											Main.dust[num67].velocity /= 4f;
											Main.dust[num67].velocity -= velocity;
											Main.dust[num67].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
											if (Main.dust[num67].type == 55)
											{
												Main.dust[num67].color = color;
											}
											if (Main.rand.Next(3) == 0)
											{
												num66 = -24;
												if (direction == 1)
												{
													num66 = 12;
												}
												float num68 = position.Y;
												if (gravDir == -1f)
												{
													num68 += (float)(height / 2);
												}
												num67 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num66, num68), 12, height / 2, Utils.SelectRandom<int>(Main.rand, 31, 31, 31), 0f, 0f, 140, default(Color), 0.7f);
												Main.dust[num67].noGravity = true;
												Main.dust[num67].noLight = true;
												Main.dust[num67].velocity /= 4f;
												Main.dust[num67].velocity -= velocity;
												Main.dust[num67].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
												if (Main.dust[num67].type == 55)
												{
													Main.dust[num67].color = color;
												}
											}
											wingFrame = 2;
										}
										else if (wings != 24)
										{
											if (wings == 43)
											{
												wingFrame = 1;
											}
											else if (wings != 49 && wings != 50)
											{
												if (wings == 12)
												{
													wingFrame = 3;
												}
												else
												{
													wingFrame = 2;
												}
											}
										}
									}
								}
							}
						}
						velocity.Y += gravity / 3f * gravDir;
						if (gravDir == 1f)
						{
							if (velocity.Y > maxFallSpeed / 3f && !TryingToHoverDown)
							{
								velocity.Y = maxFallSpeed / 3f;
							}
						}
						else if (velocity.Y < (0f - maxFallSpeed) / 3f && !TryingToHoverUp)
						{
							velocity.Y = (0f - maxFallSpeed) / 3f;
						}
					}
					else if (cartRampTime <= 0)
					{
						velocity.Y += gravity * gravDir;
					}
					else
					{
						cartRampTime--;
					}
				}
				if (!mount.Active || mount.Type != 5)
				{
					if (gravDir == 1f)
					{
						if (velocity.Y > maxFallSpeed)
						{
							velocity.Y = maxFallSpeed;
						}
						if (slowFall && velocity.Y > maxFallSpeed / 3f && !TryingToHoverDown)
						{
							velocity.Y = maxFallSpeed / 3f;
						}
						if (slowFall && velocity.Y > maxFallSpeed / 5f && TryingToHoverUp)
						{
							velocity.Y = maxFallSpeed / 10f;
						}
					}
					else
					{
						if (velocity.Y < 0f - maxFallSpeed)
						{
							velocity.Y = 0f - maxFallSpeed;
						}
						if (slowFall && velocity.Y < (0f - maxFallSpeed) / 3f && !TryingToHoverDown)
						{
							velocity.Y = (0f - maxFallSpeed) / 3f;
						}
						if (slowFall && velocity.Y < (0f - maxFallSpeed) / 5f && TryingToHoverUp)
						{
							velocity.Y = (0f - maxFallSpeed) / 10f;
						}
					}
				}
			}
		}
		else
		{
			UpdateControlHolds();
		}
		if (!mount.CanUseWings)
		{
			wingFrame = 0;
		}
		bool canUseWingAbilities = CanUseWingAbilities;
		if ((wingsLogic == 22 || wingsLogic == 28 || wingsLogic == 30 || wingsLogic == 31 || wingsLogic == 33 || wingsLogic == 35 || wingsLogic == 37 || wingsLogic == 45) && TryingToHoverDown && controlJump && wingTime > 0f && canUseWingAbilities)
		{
			float num69 = 0.9f;
			if (wingsLogic == 45)
			{
				num69 = 0.8f;
			}
			velocity.Y *= num69;
			if (velocity.Y > -2f && velocity.Y < 1f)
			{
				velocity.Y = 1E-05f;
			}
		}
		if (wingsLogic == 37 && TryingToHoverDown && controlJump && wingTime > 0f && canUseWingAbilities)
		{
			velocity.Y *= 0.92f;
			if (velocity.Y > -2f && velocity.Y < 1f)
			{
				velocity.Y = 1E-05f;
			}
		}
		if (!dead)
		{
			GrabItems(i);
		}
		LookForTileInteractions();
		if (tongued)
		{
			StopVanityActions();
			bool flag22 = false;
			if (Main.wofNPCIndex >= 0)
			{
				NPC nPC = Main.npc[Main.wofNPCIndex];
				float num70 = nPC.Center.X + (float)(nPC.direction * 200);
				float y5 = nPC.Center.Y;
				Vector2 center = base.Center;
				float num71 = num70 - center.X;
				float num72 = y5 - center.Y;
				float num73 = (float)Math.Sqrt(num71 * num71 + num72 * num72);
				float num74 = 11f;
				if (Main.expertMode)
				{
					float value = 22f;
					float amount = Math.Min(1f, nPC.velocity.Length() / 5f);
					num74 = MathHelper.Lerp(num74, value, amount);
				}
				float num75 = num73;
				if (num73 > num74)
				{
					num75 = num74 / num73;
				}
				else
				{
					num75 = 1f;
					flag22 = true;
				}
				num71 *= num75;
				num72 *= num75;
				velocity.X = num71;
				velocity.Y = num72;
			}
			else
			{
				flag22 = true;
			}
			if (flag22 && Main.myPlayer == whoAmI)
			{
				for (int num76 = 0; num76 < maxBuffs; num76++)
				{
					if (buffType[num76] == 38)
					{
						DelBuff(num76);
					}
				}
			}
		}
		if (Main.myPlayer == whoAmI)
		{
			WOFTongue();
			if (controlHook)
			{
				if (releaseHook)
				{
					QuickGrapple();
				}
				releaseHook = false;
			}
			else
			{
				releaseHook = true;
			}
			if (talkNPC >= 0)
			{
				Rectangle worldRegion = TileReachCheckSettings.Simple.GetWorldRegion(this);
				Rectangle value2 = new Rectangle((int)Main.npc[talkNPC].position.X, (int)Main.npc[talkNPC].position.Y, Main.npc[talkNPC].width, Main.npc[talkNPC].height);
				if (!worldRegion.Intersects(value2) || chest != -1 || !Main.npc[talkNPC].active || tileEntityAnchor.InUse)
				{
					if (chest == -1)
					{
						SoundEngine.PlaySound(11);
					}
					SetTalkNPC(-1);
					Main.npcChatCornerItem = 0;
					Main.npcChatText = "";
				}
			}
			if (this.sign >= 0)
			{
				Rectangle worldRegion2 = TileReachCheckSettings.Simple.GetWorldRegion(this);
				try
				{
					Sign sign = Main.sign[this.sign];
					if (sign == null || !new Rectangle(sign.x * 16, sign.y * 16, 32, 32).Intersects(worldRegion2))
					{
						CloseSign();
					}
				}
				catch
				{
					CloseSign();
				}
			}
			if (Main.editSign)
			{
				if (this.sign == -1)
				{
					Main.editSign = false;
				}
				else
				{
					Main.InputTextSign();
				}
			}
			else if (Main.editChest)
			{
				Main.InputTextChest();
				if (Main.player[Main.myPlayer].chest == -1)
				{
					Main.editChest = false;
				}
			}
			if (mount.Active && mount.Cart && velocity.Length() > 4f)
			{
				Rectangle rectangle = new Rectangle((int)position.X, (int)position.Y, width, height);
				if (velocity.X < -1f)
				{
					rectangle.X -= 15;
				}
				if (velocity.X > 1f)
				{
					rectangle.Width += 15;
				}
				if (velocity.X < -10f)
				{
					rectangle.X -= 10;
				}
				if (velocity.X > 10f)
				{
					rectangle.Width += 10;
				}
				if (velocity.Y < -1f)
				{
					rectangle.Y -= 10;
				}
				if (velocity.Y > 1f)
				{
					rectangle.Height += 10;
				}
				for (int num77 = 0; num77 < Main.maxNPCs; num77++)
				{
					if (Main.npc[num77].active && !Main.npc[num77].dontTakeDamage && !Main.npc[num77].friendly && Main.npc[num77].immune[i] == 0 && CanNPCBeHitByPlayerOrPlayerProjectile(Main.npc[num77]) && rectangle.Intersects(new Rectangle((int)Main.npc[num77].position.X, (int)Main.npc[num77].position.Y, Main.npc[num77].width, Main.npc[num77].height)))
					{
						float num78 = meleeCrit;
						if (num78 < (float)rangedCrit)
						{
							num78 = rangedCrit;
						}
						if (num78 < (float)magicCrit)
						{
							num78 = magicCrit;
						}
						bool crit = false;
						if ((float)Main.rand.Next(1, 101) <= num78)
						{
							crit = true;
						}
						float currentSpeed = velocity.Length() / maxRunSpeed;
						GetMinecartDamage(currentSpeed, out var damage2, out var knockback);
						int num79 = 1;
						if (velocity.X < 0f)
						{
							num79 = -1;
						}
						if (Main.npc[num77].knockBackResist < 1f && Main.npc[num77].knockBackResist > 0f)
						{
							knockback /= Main.npc[num77].knockBackResist;
						}
						if (whoAmI == Main.myPlayer)
						{
							ApplyDamageToNPC(Main.npc[num77], damage2, knockback, num79, crit);
						}
						Main.npc[num77].immune[i] = 30;
						if (!Main.npc[num77].active)
						{
							AchievementsHelper.HandleSpecialEvent(this, 9);
						}
					}
				}
			}
			Update_NPCCollision();
			if (!shimmering)
			{
				Collision.HurtTile hurtTile = GetHurtTile();
				if (hurtTile.type >= 0)
				{
					ApplyTouchDamage(hurtTile.type, hurtTile.x, hurtTile.y);
				}
			}
			TryToShimmerUnstuck();
		}
		if (controlRight)
		{
			releaseRight = false;
		}
		else
		{
			releaseRight = true;
			rightTimer = 7;
		}
		if (controlLeft)
		{
			releaseLeft = false;
		}
		else
		{
			releaseLeft = true;
			leftTimer = 7;
		}
		releaseDown = !controlDown;
		if (rightTimer > 0)
		{
			rightTimer--;
		}
		else if (controlRight)
		{
			rightTimer = 7;
		}
		if (leftTimer > 0)
		{
			leftTimer--;
		}
		else if (controlLeft)
		{
			leftTimer = 7;
		}
		GrappleMovement();
		StickyMovement();
		CheckDrowning();
		if (gravDir == -1f)
		{
			waterWalk = false;
			waterWalk2 = false;
		}
		bool flag23 = wet;
		bool flag24 = lavaWet;
		int num80 = height;
		if (waterWalk)
		{
			num80 -= 6;
		}
		bool flag25 = false;
		if (!shimmering)
		{
			flag25 = Collision.LavaCollision(position, width, num80);
		}
		if (flag25)
		{
			if (!lavaImmune && Main.myPlayer == i && hurtCooldowns[ImmunityCooldownID.Lava] <= 0)
			{
				if (lavaTime > 0)
				{
					lavaTime--;
				}
				else
				{
					int num81 = 80;
					int num82 = 420;
					if (Main.remixWorld)
					{
						num81 = 200;
						num82 = 630;
					}
					if (!ashWoodBonus || !lavaRose)
					{
						if (ashWoodBonus)
						{
							if (Main.remixWorld)
							{
								num81 = 145;
							}
							num81 /= 2;
							num82 -= 210;
						}
						if (lavaRose)
						{
							num81 -= 45;
							num82 -= 210;
						}
						if (num81 > 0)
						{
							Hurt(PlayerDeathReason.ByOther(2), num81, 0, pvp: false, quiet: false, Crit: false, ImmunityCooldownID.Lava);
						}
						if (num82 > 0)
						{
							AddBuff(24, num82);
						}
					}
				}
			}
			lavaWet = true;
		}
		else
		{
			lavaWet = false;
			if (lavaTime < lavaMax)
			{
				lavaTime++;
			}
		}
		if (lavaTime > lavaMax)
		{
			lavaTime = lavaMax;
		}
		if (waterWalk2 && !waterWalk)
		{
			num80 -= 6;
		}
		bool num83 = Collision.WetCollision(position, width, height);
		bool flag26 = Collision.honey;
		bool shimmer = Collision.shimmer;
		if (shimmer)
		{
			shimmerWet = true;
			if (whoAmI == Main.myPlayer && !shimmerImmune && !shimmerUnstuckHelper.ShouldUnstuck)
			{
				int num84 = (int)(base.Center.X / 16f);
				int num85 = (int)((position.Y + 1f) / 16f);
				if (Main.tile[num84, num85] != null && Main.tile[num84, num85].shimmer() && Main.tile[num84, num85].liquid >= 0 && position.Y / 16f < (float)Main.UnderworldLayer)
				{
					AddBuff(353, 60);
				}
			}
		}
		if (flag26 && !shimmering)
		{
			AddBuff(48, 1800);
			honeyWet = true;
		}
		if (num83)
		{
			if ((onFire || onFire3) && !lavaWet)
			{
				for (int num86 = 0; num86 < maxBuffs; num86++)
				{
					int num87 = buffType[num86];
					if (num87 == 24 || num87 == 323)
					{
						DelBuff(num86);
					}
				}
			}
			if (stinky)
			{
				for (int num88 = 0; num88 < maxBuffs; num88++)
				{
					if (buffType[num88] == 120)
					{
						DelBuff(num88);
					}
				}
			}
			if (!wet)
			{
				if (wetCount == 0)
				{
					wetCount = 10;
					if (!shimmering)
					{
						if (!flag25)
						{
							if (shimmerWet)
							{
								for (int num89 = 0; num89 < 50; num89++)
								{
									int num90 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2)), width + 12, 24, 308);
									Main.dust[num90].velocity.Y -= 4f;
									Main.dust[num90].velocity.X *= 2.5f;
									Main.dust[num90].scale = 0.8f;
									Main.dust[num90].noGravity = true;
									switch (Main.rand.Next(6))
									{
									case 0:
										Main.dust[num90].color = new Color(255, 255, 210);
										break;
									case 1:
										Main.dust[num90].color = new Color(190, 245, 255);
										break;
									case 2:
										Main.dust[num90].color = new Color(255, 150, 255);
										break;
									default:
										Main.dust[num90].color = new Color(190, 175, 255);
										break;
									}
								}
								SoundEngine.PlaySound(19, (int)position.X, (int)position.Y, 2);
							}
							else if (honeyWet)
							{
								for (int num91 = 0; num91 < 20; num91++)
								{
									int num92 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2) - 8f), width + 12, 24, 152);
									Main.dust[num92].velocity.Y -= 1f;
									Main.dust[num92].velocity.X *= 2.5f;
									Main.dust[num92].scale = 1.3f;
									Main.dust[num92].alpha = 100;
									Main.dust[num92].noGravity = true;
								}
								SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
							}
							else
							{
								for (int num93 = 0; num93 < 50; num93++)
								{
									int num94 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2) - 8f), width + 12, 24, Dust.dustWater());
									Main.dust[num94].velocity.Y -= 3f;
									Main.dust[num94].velocity.X *= 2.5f;
									Main.dust[num94].scale = 0.8f;
									Main.dust[num94].alpha = 100;
									Main.dust[num94].noGravity = true;
								}
								SoundEngine.PlaySound(19, (int)position.X, (int)position.Y, 0);
							}
						}
						else
						{
							for (int num95 = 0; num95 < 20; num95++)
							{
								int num96 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2) - 8f), width + 12, 24, 35);
								Main.dust[num96].velocity.Y -= 1.5f;
								Main.dust[num96].velocity.X *= 2.5f;
								Main.dust[num96].scale = 1.3f;
								Main.dust[num96].alpha = 100;
								Main.dust[num96].noGravity = true;
							}
							SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
						}
					}
				}
				wet = true;
				if (ShouldFloatInWater)
				{
					velocity.Y /= 2f;
					if (velocity.Y > 3f)
					{
						velocity.Y = 3f;
					}
				}
			}
		}
		else if (wet)
		{
			wet = false;
			if (jump > jumpHeight / 5 && wetSlime == 0)
			{
				jump = jumpHeight / 5;
			}
			if (wetCount == 0)
			{
				wetCount = 10;
				if (!shimmering)
				{
					if (!flag24)
					{
						if (shimmerWet)
						{
							for (int num97 = 0; num97 < 50; num97++)
							{
								int num98 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2)), width + 12, 24, 308);
								Main.dust[num98].velocity.Y -= 4f;
								Main.dust[num98].velocity.X *= 2.5f;
								Main.dust[num98].scale = 0.75f;
								Main.dust[num98].noGravity = true;
								switch (Main.rand.Next(6))
								{
								case 0:
									Main.dust[num98].color = new Color(255, 255, 210);
									break;
								case 1:
									Main.dust[num98].color = new Color(190, 245, 255);
									break;
								case 2:
									Main.dust[num98].color = new Color(255, 150, 255);
									break;
								default:
									Main.dust[num98].color = new Color(190, 175, 255);
									break;
								}
							}
							SoundEngine.PlaySound(19, (int)position.X, (int)position.Y, 3);
						}
						else if (honeyWet)
						{
							for (int num99 = 0; num99 < 20; num99++)
							{
								int num100 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2) - 8f), width + 12, 24, 152);
								Main.dust[num100].velocity.Y -= 1f;
								Main.dust[num100].velocity.X *= 2.5f;
								Main.dust[num100].scale = 1.3f;
								Main.dust[num100].alpha = 100;
								Main.dust[num100].noGravity = true;
							}
							SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
						}
						else
						{
							for (int num101 = 0; num101 < 50; num101++)
							{
								int num102 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2)), width + 12, 24, Dust.dustWater());
								Main.dust[num102].velocity.Y -= 4f;
								Main.dust[num102].velocity.X *= 2.5f;
								Main.dust[num102].scale = 0.8f;
								Main.dust[num102].alpha = 100;
								Main.dust[num102].noGravity = true;
							}
							SoundEngine.PlaySound(19, (int)position.X, (int)position.Y, 0);
						}
					}
					else
					{
						for (int num103 = 0; num103 < 20; num103++)
						{
							int num104 = Dust.NewDust(new Vector2(position.X - 6f, position.Y + (float)(height / 2) - 8f), width + 12, 24, 35);
							Main.dust[num104].velocity.Y -= 1.5f;
							Main.dust[num104].velocity.X *= 2.5f;
							Main.dust[num104].scale = 1.3f;
							Main.dust[num104].alpha = 100;
							Main.dust[num104].noGravity = true;
						}
						SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
					}
				}
			}
		}
		if (!flag26)
		{
			honeyWet = false;
		}
		if (!shimmer)
		{
			shimmerWet = false;
		}
		if (!wet)
		{
			lavaWet = false;
			honeyWet = false;
			shimmerWet = false;
		}
		if (wetCount > 0)
		{
			wetCount--;
		}
		if (wetSlime > 0)
		{
			wetSlime--;
		}
		if (mount.Active)
		{
			if (dripping && mount.Type == 56 && whoAmI == Main.myPlayer)
			{
				mount.TryDismount(this);
			}
			if (wet)
			{
				switch (mount.Type)
				{
				case 5:
				case 7:
				case 56:
					if (whoAmI == Main.myPlayer)
					{
						mount.TryDismount(this);
					}
					break;
				case 3:
				case 50:
					wetSlime = 30;
					if (velocity.Y > 2f)
					{
						velocity.Y *= 0.9f;
					}
					velocity.Y -= 0.5f;
					if (velocity.Y < -4f)
					{
						velocity.Y = -4f;
					}
					break;
				}
			}
		}
		if (Main.expertMode && ZoneSnow && wet && !lavaWet && !honeyWet && !arcticDivingGear && environmentBuffImmunityTimer == 0)
		{
			AddBuff(46, 150);
		}
		float num105 = 1f + Math.Abs(velocity.X) / 3f;
		if (gfxOffY > 0f)
		{
			gfxOffY -= num105 * stepSpeed;
			if (gfxOffY < 0f)
			{
				gfxOffY = 0f;
			}
		}
		else if (gfxOffY < 0f)
		{
			gfxOffY += num105 * stepSpeed;
			if (gfxOffY > 0f)
			{
				gfxOffY = 0f;
			}
		}
		if (gfxOffY > 32f)
		{
			gfxOffY = 32f;
		}
		if (gfxOffY < -32f)
		{
			gfxOffY = -32f;
		}
		if (!wet && flag23 && mount.Type == 49 && controlJump && velocity.Y < -4f)
		{
			velocity.Y *= 2f;
			velocity.X *= 2f;
			velocity.X = Utils.Clamp(velocity.X, -24f, 24f);
		}
		if (Main.myPlayer == i)
		{
			if (!iceSkate)
			{
				CheckIceBreak();
			}
			CheckCrackedBrickBreak();
		}
		if (!shimmering)
		{
			SlopeDownMovement();
			bool flag27 = mount.Type == 7 || mount.Type == 8 || mount.Type == 12 || mount.Type == 44 || mount.Type == 49;
			bool flag28 = mount.Type == 48;
			if (!mount.Active)
			{
				flag27 = false;
				flag28 = false;
			}
			if (velocity.Y == gravity && !IsRidingTracks && !flag28 && !flag27)
			{
				Collision.StepDown(ref position, ref velocity, width, height, ref stepSpeed, ref gfxOffY, (int)gravDir, waterWalk || waterWalk2);
			}
			if (gravDir == -1f)
			{
				if ((carpetFrame != -1 || velocity.Y <= gravity) && !controlUp)
				{
					Collision.StepUp(ref position, ref velocity, width, height, ref stepSpeed, ref gfxOffY, (int)gravDir, controlUp);
				}
			}
			else if ((carpetFrame != -1 || velocity.Y >= gravity) && !controlDown && !IsRidingTracks && !flag27 && grappling[0] == -1)
			{
				Collision.StepUp(ref position, ref velocity, width, height, ref stepSpeed, ref gfxOffY, (int)gravDir, controlUp);
			}
		}
		oldPosition = position;
		oldDirection = direction;
		bool falling = false;
		if (velocity.Y > gravity)
		{
			falling = true;
		}
		if (velocity.Y < 0f - gravity)
		{
			falling = true;
		}
		Vector2 vector3 = velocity;
		int num106 = slideDir;
		slideDir = 0;
		bool flag29 = false;
		bool fallThrough = controlDown;
		flag29 |= mount.Active && mount.Type == 55 && num106 != 0;
		if ((gravDir == -1f) | (mount.Active && (mount.Cart || mount.Type == 12 || mount.Type == 7 || mount.Type == 8 || mount.Type == 23 || mount.Type == 44 || mount.Type == 48)) | GoingDownWithGrapple | pulley)
		{
			flag29 = true;
			fallThrough = true;
		}
		bool flag30 = onTrack;
		onTrack = false;
		bool flag31 = false;
		if (mount.Active && mount.AnyTrackRider)
		{
			fartKartCloudDelay = Math.Max(0, fartKartCloudDelay - 1);
			float num107 = ((ignoreWater || merman) ? 1f : (shimmerWet ? 0.25f : (honeyWet ? 0.25f : ((!wet) ? 1f : 0.5f))));
			Vector2 vector4 = position;
			Vector2 vector5 = velocity;
			velocity *= num107;
			DelegateMethods.Minecart.rotation = fullRotation;
			DelegateMethods.Minecart.rotationOrigin = fullRotationOrigin;
			BitsByte bitsByte = Minecart.TrackCollision(this, ref position, ref velocity, ref lastBoost, width, height, controlDown, controlUp, fallStart2, trackOnly: false, mount.Delegations);
			velocity /= num107;
			if (!mount.Cart && !bitsByte[2] && !bitsByte[0] && !bitsByte[4] && !bitsByte[5])
			{
				position = vector4;
				velocity = vector5;
			}
			if (bitsByte[0])
			{
				onTrack = true;
				gfxOffY = Minecart.TrackRotation(this, ref fullRotation, position + velocity, width, height, controlDown, controlUp, mount.Delegations);
				fullRotationOrigin = new Vector2(width / 2, height);
			}
			if (flag30 && !onTrack)
			{
				mount.Delegations.MinecartJumpingSound(this, position, width, height);
			}
			if (bitsByte[1])
			{
				if (controlLeft || controlRight)
				{
					if (cartFlip)
					{
						cartFlip = false;
					}
					else
					{
						cartFlip = true;
					}
				}
				if (velocity.X > 0f)
				{
					direction = 1;
				}
				else if (velocity.X < 0f)
				{
					direction = -1;
				}
				mount.Delegations.MinecartBumperSound(this, position, width, height);
			}
			if (bitsByte[3] && whoAmI == Main.myPlayer)
			{
				flag31 = true;
			}
			if (bitsByte[2])
			{
				cartRampTime = (int)(Math.Min(1f, Math.Abs(velocity.X) / mount.RunSpeed) * 20f);
			}
			if (bitsByte[4])
			{
				trackBoost -= 4f;
			}
			if (bitsByte[5])
			{
				trackBoost += 4f;
			}
		}
		bool flag32 = whoAmI == Main.myPlayer && !mount.Active;
		Vector2 vector6 = position;
		if (vortexDebuff)
		{
			velocity.Y = velocity.Y * 0.8f + (float)Math.Cos(base.Center.X % 120f / 120f * ((float)Math.PI * 2f)) * 5f * 0.2f;
		}
		float num108 = 0.5f;
		float num109 = 0.5f;
		float movementSpeed = 0.25f;
		float num110 = 0.375f;
		UpdateNetOffset(fallThrough, flag29);
		if (tongued)
		{
			position += velocity;
			flag32 = false;
		}
		else if (shimmering)
		{
			position += velocity * num110;
		}
		else
		{
			if (shimmerWet)
			{
				WetCollision(fallThrough, flag29, num110);
			}
			else if (honeyWet && !ignoreWater)
			{
				WetCollision(fallThrough, flag29, movementSpeed);
			}
			else if (wet && !merman && !ignoreWater && !trident)
			{
				WetCollision(fallThrough, flag29, lavaWet ? num109 : num108);
			}
			else
			{
				DryCollision(fallThrough, flag29);
				if (mount.Active && mount.IsConsideredASlimeMount && velocity.Y != 0f && !SlimeDontHyperJump)
				{
					Vector2 vector7 = velocity;
					velocity.X = 0f;
					DryCollision(fallThrough, flag29);
					velocity.X = vector7.X;
				}
				if (mount.Active && mount.Type == 43 && velocity.Y != 0f)
				{
					Vector2 vector8 = velocity;
					velocity.X = 0f;
					DryCollision(fallThrough, flag29);
					velocity.X = vector8.X;
				}
			}
			if (isPerformingJump_DownDash && velocity.Y != 0f)
			{
				Vector2 vector9 = velocity;
				velocity.X = 0f;
				DryCollision(fallThrough, flag29);
				velocity.X = vector9.X;
			}
		}
		UpdateTouchingTiles();
		TryBouncingBlocks(falling);
		TryLandingOnDetonator();
		if (!shimmering && !tongued)
		{
			SlopingCollision(fallThrough, flag29);
			if (!isLockedToATile)
			{
				Collision.StepConveyorBelt(this, gravDir);
			}
		}
		if (flag32 && velocity.Y == 0f)
		{
			AchievementsHelper.HandleRunning(Math.Abs(position.X - vector6.X));
		}
		if (flag31)
		{
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			Minecart.HitTrackSwitch(new Vector2(position.X, position.Y), width, height, MinecartSettings);
		}
		if (vector3.X != velocity.X)
		{
			if (vector3.X < 0f)
			{
				slideDir = -1;
			}
			else if (vector3.X > 0f)
			{
				slideDir = 1;
			}
		}
		if (gravDir == 1f && Collision.up)
		{
			velocity.Y = 0.01f;
			if (!merman)
			{
				jump = 0;
			}
		}
		else if (gravDir == -1f && Collision.down)
		{
			velocity.Y = -0.01f;
			if (!merman)
			{
				jump = 0;
			}
		}
		if (velocity.Y == 0f && grappling[0] == -1)
		{
			FloorVisuals(falling);
		}
		if (whoAmI == Main.myPlayer && !shimmering)
		{
			Collision.SwitchTiles(position, width, height, oldPosition, 5);
		}
		PressurePlateHelper.UpdatePlayerPosition(this);
		BordersMovement();
		numMinions = 0;
		slotsMinions = 0f;
		if (Main.netMode != 2 && mount.Type != 8)
		{
			ItemCheck_ManageRightClickFeatures();
		}
		ItemCheckWrapped(i);
		PlayerFrame();
		DoDeadCellsBeheadedParticles();
		if (mount.Type == 8)
		{
			mount.UseDrill(this);
		}
		if (statLife > statLifeMax2)
		{
			statLife = statLifeMax2;
		}
		if (statMana > statManaMax2)
		{
			statMana = statManaMax2;
		}
		grappling[0] = -1;
		grapCount = 0;
		UpdateReleaseUseTile();
		UpdateAdvancedShadows();
		if ((Main.netMode != 2 && whoAmI == Main.myPlayer) || whoAmI == Main.LocalPlayer.spectating)
		{
			ActiveSections.CheckSection(position);
		}
		if (DebugOptions.ShowSections && whoAmI == Main.myPlayer)
		{
			Point point = new Point(Netplay.GetSectionX((int)position.X >> 4), Netplay.GetSectionY((int)position.Y >> 4));
			DebugLineDraw.World.AddRectangle(new Vector2(point.X * 200 * 16, point.Y * 150 * 16), new Vector2((point.X + 1) * 200 * 16, (point.Y + 1) * 150 * 16), Color.Yellow);
		}
	}

	private void Update_AdjustTileTargetForDisplayJars(int i)
	{
		if (i != Main.myPlayer || !TEDeadCellsDisplayJar.FitsJar(inventory[selectedItem]) || Main.tile[tileTargetX, tileTargetY].active() || !controlUseTile)
		{
			return;
		}
		int num = 1;
		for (int j = -num; j <= num; j++)
		{
			int num2 = j + tileTargetX;
			for (int k = -num; k <= num; k++)
			{
				int num3 = k + tileTargetY;
				Tile tile = Main.tile[num2, num3];
				if (tile.active() && tile.type == 698 && tile.frameY % 36 != 0 && new Vector2(tileTargetX, tileTargetY).Distance(new Vector2(num2, num3)) <= 1.2f)
				{
					tileTargetX = num2;
					tileTargetY = num3;
					return;
				}
			}
		}
	}

	public void UpdateNearbyCraftingTiles()
	{
		if (Main.playerInventory)
		{
			AdjTiles();
		}
	}

	private void RollerSkateMovement()
	{
		bool flag = grappling[0] >= 0;
		if (controlRight.ToInt() - controlLeft.ToInt() == 0 && !flag)
		{
			float amount = 0.3f;
			float num = 1.5f;
			float num2 = 6.5f;
			int num3 = 10;
			if (HeldItem.createTile >= 0 || HeldItem.tileWand > 0)
			{
				num3 = HeldItem.useTime;
			}
			int num4 = (int)((float)num3 * tileSpeed);
			float num5 = 16f;
			float num6 = Math.Max(num, num5 / (float)num4);
			if (Math.Abs(velocity.X) < num)
			{
				velocity.X = MathHelper.Lerp(velocity.X, 0f, amount);
				if (Math.Abs(velocity.X) < 0.03f)
				{
					velocity.X = 0f;
				}
			}
			else if (Math.Abs(velocity.X) < num2)
			{
				float value = (float)Math.Sign(velocity.X) * num6;
				velocity.X = MathHelper.Lerp(velocity.X, value, amount);
			}
		}
		if (powerrun)
		{
			maxRunSpeed *= 2.25f;
			runAcceleration *= 1f;
			runSlowdown *= 1.6f;
		}
		float num7 = Math.Max(maxRunSpeed, accRunSpeed);
		runSlowdown = Utils.Clamp(Math.Abs(velocity.X) - num7, 0f, runSlowdown);
		if (velocity.Y == 0f && !onTrack)
		{
			fullRotation = 0f;
		}
	}

	private void UpdateParticles()
	{
		if (!(velocity == Vector2.Zero))
		{
			Vector2 bottom = base.Bottom;
			Vector2 v = bottom - Main.screenPosition;
			if (new Rectangle(0, 0, Main.screenWidth, Main.screenHeight).Contains(v.ToPoint()))
			{
				ParticleOrchestrator.RepelAt(bottom, height / 2, wet);
			}
		}
	}

	private void UpdateSunScorchValues()
	{
		int num = 6;
		if (dead)
		{
			vampireBurningInSunlight = false;
			num = 2;
		}
		sunScorchCounter = Utils.Clamp(sunScorchCounter + (vampireBurningInSunlight ? 1 : (-num)), 0, 300);
		float lerpValue = Utils.GetLerpValue(0f, 120f, sunScorchCounter, clamped: true);
		ActiveSound activeSound = SoundEngine.GetActiveSound(_sizzleAudioHandle);
		if (activeSound == null && lerpValue != 0f)
		{
			_sizzleAudioHandle = SoundEngine.PlayTrackedLoopedSound(overrides: new SoundPlayOverrides
			{
				Volume = lerpValue
			}, style: SoundID.VampireSizzle, position: base.Center, loopingCondition: new VampireSizzleTracker(whoAmI).IsActiveAndInGame);
			activeSound = SoundEngine.GetActiveSound(_sizzleAudioHandle);
		}
		if (activeSound != null)
		{
			activeSound.Volume = lerpValue;
			activeSound.Position = base.Center;
		}
	}

	private void DoUnbreakableWallScan(bool force = false)
	{
		if (!Main.dualDungeonsSeed || Main.netMode == 1)
		{
			return;
		}
		Vector2 center = base.Center;
		if (force || --_unbreakableWallScanCooldown <= 0 || !(Vector2.Distance(center, _unbreakableWallScanLastPosition) < (float)UnbreakableWallRescanDistance))
		{
			bool flag = insideUnbreakableWalls;
			insideUnbreakableWalls = UnbreakableWallScan.InsideUnbreakableWalls(center.ToTileCoordinates());
			_unbreakableWallScanCooldown = UnbreakableWallRescanPeriod;
			_unbreakableWallScanLastPosition = center;
			if (insideUnbreakableWalls != flag && Main.netMode == 2)
			{
				UnbreakableWallScan.NetModule.BroadcastChange(this);
			}
		}
	}

	private void UpdateSunScorch()
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		VampireSeedSunlightExposure();
		int num = sunScorchCounter;
		UpdateSunScorchValues();
		if (!vampireBurningInSunlight || sunScorchCounter < 120)
		{
			return;
		}
		if (num < 120)
		{
			int num2 = head;
			int num3 = body;
			int num4 = legs;
			PlayerFrame();
			if (head == 124 && body == 85 && legs == 72)
			{
				AchievementsHelper.NotifyProgressionEvent(33);
			}
			head = num2;
			body = num3;
			legs = num4;
		}
		Array.Clear(buffImmune, 0, BuffID.Count);
		if (!onFire)
		{
			ParticleOrchestraSettings settings = new ParticleOrchestraSettings
			{
				PositionInWorld = base.Center
			};
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.VampireOnFire, settings, whoAmI);
		}
		AddBuff(24, 3);
		AddBuff(23, 3);
		AddBuff(32, 3);
		if (mount.Active)
		{
			mount.TryDismount(this);
		}
		wingsLogic = 0;
		rocketBoots = 0;
	}

	private void VampireSeedSunlightExposure()
	{
		int num = (int)base.Center.X / 16;
		int num2 = (int)(base.Bottom.Y - 1f) / 16;
		if (!Main.vampireSeed)
		{
			return;
		}
		float num3 = 0.5f;
		bool flag = (double)num2 < Main.worldSurface && Main.dayTime && !Main.raining && !Main.eclipse && !ZoneGraveyard && !ZoneGlowshroom;
		if (flag && SceneMetrics.MoonLordSkyIntensity.HasValue && SceneMetrics.MoonLordSkyIntensity.Value > num3)
		{
			flag = false;
		}
		if (!flag || wet)
		{
			return;
		}
		bool flag2 = inventory[selectedItem].type == 946 || inventory[selectedItem].type == 4707;
		if (mount.Active && mount.Type == 56)
		{
			flag2 = false;
		}
		if (flag2)
		{
			return;
		}
		int num4 = 15;
		while (num4 > 0)
		{
			Tile tile = Main.tile[num, num2];
			if (tile == null)
			{
				break;
			}
			if (tile.wall == 0 || tile.wall == 21 || tile.wall == 318 || (!Main.ShouldShowInvisibleBlocksAndWalls() && tile.invisibleWall()))
			{
				vampireBurningInSunlight = true;
				break;
			}
			num4--;
			num2--;
			if (WorldGen.SolidTile3(num, num2) && tile.type != 54 && (!tile.invisibleBlock() || Main.ShouldShowInvisibleBlocksAndWalls()) && (tile.type != 541 || Main.ShouldShowInvisibleBlocksAndWalls()))
			{
				break;
			}
		}
	}

	private void UpdateNetOffset(bool fallThrough, bool ignorePlats)
	{
		if (DebugOptions.FakeNetOffset != Vector2.Zero)
		{
			netOffset = DebugOptions.FakeNetOffset;
			return;
		}
		float num = 0.1f;
		float num2 = 2f;
		float num3 = netOffset.Length();
		if (num3 < num2)
		{
			netOffset = Vector2.Zero;
			return;
		}
		if (!ghost)
		{
			Vector2 vector = TileCollision(position + netOffset, velocity, fallThrough, ignorePlats);
			if (vector != velocity)
			{
				Vector2 value = velocity - vector;
				float num4 = Vector2.Dot(value, netOffset);
				if (num4 >= 1f)
				{
					float num5 = value.LengthSquared() * num3 / num4;
					num2 = Math.Max(num2, num5 * 1.0001f);
				}
			}
		}
		float maxAmountAllowedToMove = Math.Max(num2, num3 * num);
		netOffset = netOffset.MoveTowards(Vector2.Zero, maxAmountAllowedToMove);
		if (netOffset != Vector2.Zero && DebugOptions.ShowNetOffsetDust)
		{
			Dust.QuickDust(position + netOffset, Color.Green).scale = 0.5f;
		}
	}

	public static void ResetNetOffsets()
	{
		for (int i = 0; i < 255; i++)
		{
			Main.player[i].netOffset = Vector2.Zero;
		}
	}

	public void ChestChangeEvents()
	{
		if (Main.netMode != 1)
		{
			if (chest == -1 && lastChest >= 0 && Main.chest[lastChest] != null)
			{
				int x = Main.chest[lastChest].x;
				int y = Main.chest[lastChest].y;
				NPC.BigMimicSummonCheck(x, y, this);
			}
			if (lastChest != chest && chest >= 0 && Main.chest[chest] != null)
			{
				int x2 = Main.chest[chest].x;
				int y2 = Main.chest[chest].y;
				Projectile.GasTrapCheck(x2, y2, this);
				ItemSlot.forceClearGlowsOnChest = true;
			}
			lastChest = chest;
		}
	}

	private void DoDeadCellsGroundPoundEffect()
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		float num = 128f;
		int damage = 30;
		float knockback = 10f;
		bool crit = false;
		bool flag = 32 * downDashTime > 300;
		if (flag)
		{
			crit = true;
			num = 176f;
			knockback = 20f;
		}
		ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.DeadCellsDownDashExplosion, new ParticleOrchestraSettings
		{
			PositionInWorld = base.Center + new Vector2(0f, height / 2 - 4) * gravDir,
			UniqueInfoPiece = (flag ? 1 : 0),
			MovementVector = new Vector2(num, gravDir)
		});
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (nPC.active && !nPC.friendly && !nPC.dontTakeDamage && CanNPCBeHitByPlayerOrPlayerProjectile(nPC))
			{
				Vector2 vector = nPC.Center - base.Center;
				if (!(vector.Length() > num))
				{
					int num2 = ((vector.X > 0f) ? 1 : (-1));
					ApplyDamageToNPC(nPC, damage, knockback, num2, crit);
				}
			}
		}
	}

	private void TryToToggleSmartCursor(ref bool smartCursorWanted)
	{
		if (Main.cSmartCursorModeIsToggleAndNotHold)
		{
			if (controlSmart && releaseSmart)
			{
				SoundEngine.PlaySound(12);
				smartCursorWanted = !smartCursorWanted;
			}
			return;
		}
		if (controlSmart && releaseSmart)
		{
			SoundEngine.PlaySound(12);
		}
		if (SmartCursorSettings.SmartCursorHoldCanReleaseMidUse)
		{
			smartCursorWanted = controlSmart;
		}
		else if (smartCursorWanted)
		{
			if (!controlSmart && !controlUseItem)
			{
				smartCursorWanted = false;
			}
		}
		else
		{
			smartCursorWanted = controlSmart;
		}
	}

	private void TryToShimmerUnstuck()
	{
		timeShimmering = Utils.Clamp(timeShimmering + (shimmering ? 1 : (-10)), 0, 7200);
		bool flag = timeShimmering >= 3600;
		if (LocalInputCache.PressingAnyInput && timeShimmering >= 1200)
		{
			flag = true;
		}
		if (flag)
		{
			ShimmerUnstuck();
		}
	}

	private void ShimmerUnstuck()
	{
		timeShimmering = 0;
		Vector2? vector = TryFindingShimmerFreeSpot();
		if (vector.HasValue)
		{
			velocity = new Vector2(0f, 0.0001f);
			Teleport(vector.Value + new Vector2(0f, -2f), 12);
			shimmering = false;
			shimmerWet = false;
			wet = false;
			ClearBuff(353);
			ParticleOrchestrator.BroadcastOrRequestParticleSpawn(ParticleOrchestraType.ShimmerTownNPC, new ParticleOrchestraSettings
			{
				PositionInWorld = base.Bottom
			});
		}
		else
		{
			if (Collision.WetCollision(position, width, height) && Collision.shimmer)
			{
				shimmerUnstuckHelper.StartUnstuck();
			}
			ClearBuff(353);
			ParticleOrchestrator.BroadcastOrRequestParticleSpawn(ParticleOrchestraType.ShimmerTownNPC, new ParticleOrchestraSettings
			{
				PositionInWorld = base.Bottom
			});
		}
	}

	private Vector2? TryFindingShimmerFreeSpot()
	{
		Point point = base.Top.ToTileCoordinates();
		int num = 60;
		Vector2? result = null;
		bool allowSolidTop = true;
		for (int i = 1; i < num; i += 2)
		{
			Vector2? vector = ShimmerHelper.FindSpotWithoutShimmer(this, point.X, point.Y, i, allowSolidTop);
			if (vector.HasValue)
			{
				result = vector.Value;
				break;
			}
		}
		FindSpawn();
		if (!CheckSpawn(SpawnX, SpawnY))
		{
			SpawnX = -1;
			SpawnY = -1;
		}
		if (!result.HasValue && SpawnX != -1 && SpawnY != -1)
		{
			for (int j = 1; j < num; j += 2)
			{
				Vector2? vector2 = ShimmerHelper.FindSpotWithoutShimmer(this, SpawnX, SpawnY, j, allowSolidTop);
				if (vector2.HasValue)
				{
					result = vector2.Value;
					break;
				}
			}
		}
		if (!result.HasValue)
		{
			for (int k = 1; k < num; k += 2)
			{
				Vector2? vector3 = ShimmerHelper.FindSpotWithoutShimmer(this, Main.spawnTileX, Main.spawnTileY, k, allowSolidTop);
				if (vector3.HasValue)
				{
					result = vector3.Value;
					break;
				}
			}
		}
		return result;
	}

	private void AdjustRemainingPotionSickness()
	{
		if (whoAmI == Main.myPlayer)
		{
			int num = FindBuffIndex(21);
			if (num != -1)
			{
				float num2 = buffTime[num];
				float philosopherStoneDurationMultiplier = PhilosopherStoneDurationMultiplier;
				num2 = ((!pStone) ? (num2 / philosopherStoneDurationMultiplier) : (num2 * philosopherStoneDurationMultiplier));
				buffTime[num] = (int)num2;
			}
		}
	}

	private Collision.HurtTile GetHurtTile()
	{
		Collision.HurtTile result = Collision.HurtTiles(position, width, (!mount.Active || !mount.Cart) ? height : (height - 16), this);
		if (result.type >= 0)
		{
			return result;
		}
		foreach (Point touchedTile in TouchedTiles)
		{
			Tile tile = Main.tile[touchedTile.X, touchedTile.Y];
			if (tile != null && tile.active() && tile.nactive() && !TileID.Sets.Suffocate[tile.type] && Collision.CanTileHurt(tile.type, touchedTile.X, touchedTile.Y, this))
			{
				return new Collision.HurtTile
				{
					type = tile.type,
					x = touchedTile.X,
					y = touchedTile.Y
				};
			}
		}
		return result;
	}

	private void ApplyTouchDamage(int tileId, int x, int y)
	{
		if (TileID.Sets.TouchDamageHot[tileId])
		{
			AddBuff(67, 20);
		}
		if (TileID.Sets.Suffocate[tileId])
		{
			if (suffocateDelay < 5)
			{
				suffocateDelay++;
			}
			else
			{
				AddBuff(68, 1);
			}
		}
		else
		{
			suffocateDelay = 0;
		}
		if (TileID.Sets.TouchDamageBleeding[tileId])
		{
			AddBuff(30, Main.rand.Next(600, 1200));
		}
		int num = TileID.Sets.TouchDamageImmediate[tileId];
		if (num > 0)
		{
			num = Main.DamageVar(num, 0f - luck);
			Hurt(PlayerDeathReason.ByOther(3), num, 0, pvp: false, quiet: false, Crit: false, ImmunityCooldownID.TileContactDamage);
		}
		if (TileID.Sets.TouchDamageDestroyTile[tileId])
		{
			WorldGen.KillTile(x, y);
			if (Main.netMode == 1 && !Main.tile[x, y].active())
			{
				NetMessage.SendData(17, -1, -1, null, 4, x, y);
			}
		}
	}

	private void CapAttackSpeeds()
	{
		float num = meleeSpeed;
		meleeSpeed = TurnAttackSpeedToUseTimeMultiplier(num);
		summonerWeaponSpeedBonus = TurnAttackSpeedToUseTimeMultiplier(num + summonerWeaponSpeedBonus);
	}

	private float TurnAttackSpeedToUseTimeMultiplier(float speed)
	{
		if (speed > 3f)
		{
			speed = 3f;
		}
		if (speed != 0f)
		{
			speed = 1f / speed;
		}
		return speed;
	}

	public void UpdateLuck()
	{
		UpdateLuckFactors();
		RecalculateLuck();
		if (luckNeedsSync && whoAmI == Main.myPlayer)
		{
			luckNeedsSync = false;
			NetMessage.SendData(134, -1, -1, null, whoAmI);
		}
	}

	private void ResetControls()
	{
		controlUp = false;
		controlLeft = false;
		controlDown = false;
		controlRight = false;
		controlJump = false;
		controlUseItem = false;
		controlUseTile = false;
		controlThrow = false;
		controlInv = false;
		controlHook = false;
		controlTorch = false;
		controlSmart = false;
		controlMount = false;
		controlQuickHeal = false;
		controlQuickMana = false;
		controlCreativeMenu = false;
		controlQuickBuff = false;
		mapStyle = false;
		mapAlphaDown = false;
		mapAlphaUp = false;
		mapFullScreen = false;
		mapZoomIn = false;
		mapZoomOut = false;
	}

	private void UpdateControlHolds()
	{
		if (whoAmI == Main.myPlayer && HeldItem.GetFlexibleTileWand() != null)
		{
			if (controlUp && releaseUp)
			{
				FlexibleWandCycleOffset--;
			}
			if (controlDown && releaseDown)
			{
				FlexibleWandCycleOffset++;
			}
		}
		if (controlUp)
		{
			releaseUp = false;
		}
		else
		{
			releaseUp = true;
		}
	}

	public void TryOpeningFullscreenMap()
	{
		if (Main.mapEnabled)
		{
			Main.playerInventory = false;
			CloseSign(quiet: true);
			SetTalkNPC(-1);
			Main.npcChatCornerItem = 0;
			SoundEngine.PlaySound(10);
			Main.mapFullscreenScale = 2.5f;
			Main.MapPylonTile = new Point16(-1, -1);
			Main.mapFullscreen = true;
			Main.resetMapFull = true;
			Main.buffString = string.Empty;
			releaseInventory = false;
		}
	}

	public void UpdateLuckFactors()
	{
		UpdateLadyBugLuckTime();
		UpdateCoinLuck();
		if (whoAmI == Main.myPlayer)
		{
			float num = torchLuck;
			TryRecalculatingTorchLuck();
			if (torchLuck != num)
			{
				luckNeedsSync = true;
			}
			UpdateBrokenMirrorLuck();
		}
	}

	public void RecalculateLuck()
	{
		luck = GetLadyBugLuck() * 0.2f + torchLuck * 0.2f;
		luck += (float)(int)luckPotion * 0.1f;
		luck += (float)(int)kiteLuckLevel * 0.1f / 3f;
		if (usedGalaxyPearl)
		{
			luck += 0.03f;
		}
		if (LanternNight.LanternsUp)
		{
			luck += 0.3f;
		}
		if (HasGardenGnomeNearby)
		{
			luck += 0.2f;
		}
		if (stinky)
		{
			luck -= 0.25f;
		}
		luck += equipmentBasedLuckBonus;
		luck += CalculateCoinLuck();
		if (brokenMirrorBadLuck)
		{
			luck -= 0.25f;
		}
	}

	private void UpdateBrokenMirrorLuck()
	{
		bool flag = brokenMirrorBadLuck;
		if (brokenMirrorBadLuckTime > 0)
		{
			brokenMirrorBadLuck = true;
			brokenMirrorBadLuckTime -= Main.dayRate;
			if (brokenMirrorBadLuckTime < 0)
			{
				brokenMirrorBadLuckTime = 0;
			}
		}
		else
		{
			brokenMirrorBadLuck = false;
		}
		if (brokenMirrorBadLuck != flag)
		{
			luckNeedsSync = true;
		}
	}

	public static int GetMouseScrollDelta()
	{
		return PlayerInput.ScrollWheelDelta / 120;
	}

	private void UpdatePortableStoolUsage()
	{
		bool flag = portableStoolInfo.HasAStool && controlUp && !gravControl && !mount.Active && velocity.X == 0f && velocity.Y == 0f && !pulley && grappling[0] == -1;
		if (flag)
		{
			flag = CanFitSpace(portableStoolInfo.HeightBoost);
		}
		if (flag)
		{
			portableStoolInfo.IsInUse = true;
			ResizeHitbox();
		}
	}

	private void ResizeHitbox()
	{
		position.Y += height;
		width = 20;
		height = 42 + HeightOffsetBoost;
		if (mount.Active)
		{
			Mount.MountDelegatesData.OverrideSizeMethod playerSize = mount.Delegations.PlayerSize;
			if (playerSize != null && playerSize(this, out var size) && size.HasValue)
			{
				width = (int)size.Value.X;
				height = (int)size.Value.Y;
			}
		}
		position.Y -= height;
	}

	private void UpdateReleaseUseTile()
	{
		bool flag = !tileInteractAttempted;
		if (_lockTileInteractionsTimer > 0 && !releaseUseTile)
		{
			flag = false;
		}
		if (mouseInterface)
		{
			flag = false;
		}
		releaseUseTile = flag;
		if (_lockTileInteractionsTimer > 0)
		{
			_lockTileInteractionsTimer--;
		}
	}

	private void GetMinecartDamage(float currentSpeed, out int damage, out float knockback)
	{
		switch (mount.Type)
		{
		default:
			damage = Main.DamageVar(25f + 55f * currentSpeed, luck);
			break;
		case 11:
		case 15:
		case 16:
		case 18:
		case 19:
		case 20:
		case 21:
		case 22:
		case 24:
		case 25:
		case 26:
		case 27:
		case 28:
		case 29:
		case 30:
		case 31:
		case 32:
		case 33:
		case 34:
		case 35:
		case 36:
		case 38:
		case 39:
		case 51:
		case 53:
			damage = Main.DamageVar(25f + 55f * currentSpeed, luck);
			break;
		case 13:
			damage = Main.DamageVar(15f + 30f * currentSpeed, luck);
			break;
		}
		if (UsingSuperCart)
		{
			damage = Main.DamageVar(50f + 100f * currentSpeed, luck);
		}
		knockback = 10f + 40f * currentSpeed;
		if (Main.hardMode)
		{
			damage = (int)((double)damage * 1.5);
		}
		if (Main.expertMode)
		{
			damage = (int)((double)damage * 1.5);
		}
	}

	public void UpdateMiscCounter()
	{
		miscCounter++;
		if (miscCounter >= 300)
		{
			miscCounter = 0;
		}
	}

	private void WingAirLogicTweaks()
	{
		WingStats wingStats = GetWingStats(wingsLogic);
		bool flag = TryingToHoverDown && controlJump && wingTime > 0f && !isPerformingJump_DownDash;
		if (wingStats.HasDownHoverStats && flag)
		{
			if (wingStats.DownHoverSpeedOverride != -1f)
			{
				accRunSpeed = wingStats.DownHoverSpeedOverride;
			}
			runAcceleration *= wingStats.DownHoverAccelerationMult;
		}
		else
		{
			if (wingStats.AccRunSpeedOverride != -1f && wingStats.AccRunSpeedOverride > accRunSpeed)
			{
				accRunSpeed = wingStats.AccRunSpeedOverride;
			}
			runAcceleration *= wingStats.AccRunAccelerationMult;
		}
		if (wingsLogic == 45 && (float)timeSinceLastDashStarted >= 60f)
		{
			runSlowdown *= 6f;
		}
	}

	private void RocketBootVisuals()
	{
		if (vanityRocketBoots == 0)
		{
			return;
		}
		int num = height;
		if (gravDir == -1f)
		{
			num = 4;
		}
		for (int i = 0; i < 2; i++)
		{
			int num2 = ((i == 0) ? 2 : (-2));
			Vector2 vector = position + netOffset;
			Rectangle r = ((i != 0) ? new Rectangle((int)vector.X + width - 4, (int)vector.Y + num - 10, 8, 8) : new Rectangle((int)vector.X - 4, (int)vector.Y + num - 10, 8, 8));
			if (direction == -1)
			{
				r.X -= 4;
			}
			int type = 6;
			float scale = 2.5f;
			int alpha = 100;
			float num3 = 1f;
			Vector2 vector2 = new Vector2((float)(-num2) - velocity.X * 0.3f, 2f * gravDir - velocity.Y * 0.3f);
			Dust dust;
			switch (vanityRocketBoots)
			{
			case 5:
				type = 6;
				scale = 2.5f;
				break;
			case 1:
				if (socialShadowRocketBoots)
				{
					type = 27;
					scale = 1.5f;
				}
				break;
			case 3:
				type = 76;
				scale = 1f;
				alpha = 20;
				break;
			case 6:
				type = 186;
				scale = 1.5f;
				alpha = 20;
				break;
			case 2:
				if (fairyBoots)
				{
					type = Main.rand.NextFromList(new short[6] { 61, 61, 61, 242, 64, 63 });
					scale = 2f;
					alpha = 120;
				}
				else
				{
					type = 16;
					scale = 1.5f;
					alpha = 20;
				}
				break;
			case 4:
			{
				int num4 = Main.rand.Next(6);
				if (cShoe > 0)
				{
					num4 = 2;
				}
				r.Y += 2 * (int)gravDir;
				if (num4 == 0 || num4 == 1)
				{
					dust = Dust.NewDustDirect(r.TopLeft(), r.Width, r.Height, 278, 0f, 0f, 100, Color.Lerp(Color.LimeGreen, Color.White, Main.rand.NextFloat() * 0.3f));
					dust.shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
					dust.scale = 0.66f;
					dust.noGravity = true;
					dust.velocity *= 0.25f;
					dust.velocity -= velocity * 0.5f;
					dust.velocity += vector2 * 0.5f;
					dust.position += dust.velocity * 4f;
					if (Main.rand.Next(5) == 0)
					{
						dust.fadeIn = 0.8f;
					}
					continue;
				}
				type = 107;
				alpha = 100;
				scale = 0.7f;
				num3 = 0.5f;
				break;
			}
			}
			dust = Dust.NewDustDirect(r.TopLeft(), r.Width, r.Height, type, 0f, 0f, alpha, default(Color), scale);
			dust.shader = GameShaders.Armor.GetSecondaryShader(cShoe, this);
			dust.velocity += vector2;
			dust.velocity *= num3;
			switch (vanityRocketBoots)
			{
			case 5:
				dust.noGravity = true;
				break;
			case 1:
				dust.noGravity = true;
				break;
			case 2:
				dust.velocity *= 0.1f;
				break;
			case 6:
				dust.velocity *= 0.1f;
				break;
			case 3:
				dust.velocity *= 0.05f;
				dust.velocity.Y += 0.15f;
				dust.noLight = true;
				if (Main.rand.Next(2) == 0)
				{
					dust.noGravity = true;
					dust.scale = 1.75f;
				}
				break;
			}
			if (fairyBoots)
			{
				dust.noGravity = true;
				dust.noLightEmittence = true;
			}
		}
	}

	public void GetWingsFunctionalityForVisuals(int wingsToUse, out bool canHover, out bool canHoverBoostHorizontally, out bool canBoost)
	{
		canHover = wingsToUse == 22 || wingsToUse == 30 || wingsToUse == 31 || wingsToUse == 28 || wingsToUse == 33 || wingsToUse == 35 || wingsToUse == 44 || wingsToUse == 45;
		canHoverBoostHorizontally = GetWingStats(wingsToUse).DownHoverSpeedOverride != -1f;
		canBoost = wingsToUse == 44 || wingsToUse == 45;
	}

	public void WingFrame(bool wingFlap)
	{
		bool flag = wingsLogic != wings;
		if (wings == 4)
		{
			if (wingFlap || jump > 0)
			{
				rocketDelay2--;
				if (rocketDelay2 <= 0)
				{
					SoundEngine.PlaySound(SoundID.Item13, position);
					rocketDelay2 = 60;
				}
				int num = 2;
				if (TryingToHoverUp)
				{
					num = 4;
				}
				for (int i = 0; i < num; i++)
				{
					int type = 6;
					if (head == 41)
					{
						_ = body;
						_ = 24;
					}
					float scale = 1.75f;
					int alpha = 100;
					float x = position.X + (float)(width / 2) + 16f;
					if (direction > 0)
					{
						x = position.X + (float)(width / 2) - 26f;
					}
					float num2 = position.Y + (float)height - 18f;
					if (i == 1 || i == 3)
					{
						x = position.X + (float)(width / 2) + 8f;
						if (direction > 0)
						{
							x = position.X + (float)(width / 2) - 20f;
						}
						num2 += 6f;
					}
					if (i > 1)
					{
						num2 += velocity.Y;
					}
					int num3 = Dust.NewDust(new Vector2(x, num2), 8, 8, type, 0f, 0f, alpha, default(Color), scale);
					Main.dust[num3].velocity.X *= 0.1f;
					Main.dust[num3].velocity.Y = Main.dust[num3].velocity.Y * 1f + 2f * gravDir - velocity.Y * 0.3f;
					Main.dust[num3].noGravity = true;
					Main.dust[num3].noLightEmittence = flag;
					Main.dust[num3].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
					if (num == 4)
					{
						Main.dust[num3].velocity.Y += 6f;
					}
				}
				wingFrameCounter++;
				if (wingFrameCounter > 4)
				{
					wingFrame++;
					wingFrameCounter = 0;
					if (wingFrame >= 3)
					{
						wingFrame = 0;
					}
				}
			}
			else if (!controlJump || velocity.Y == 0f)
			{
				wingFrame = 3;
			}
			return;
		}
		if (wings == 28 && ShouldDrawWingsThatAreAlwaysAnimated())
		{
			if (!flag && velocity.Y != 0f)
			{
				Lighting.AddLight(base.Bottom, 0.3f, 0.1f, 0.4f);
			}
			return;
		}
		if (wings == 22)
		{
			if (!controlJump)
			{
				wingFrame = 0;
				wingFrameCounter = 0;
			}
			else if (wingTime > 0f)
			{
				if (TryingToHoverDown)
				{
					if (velocity.X != 0f)
					{
						wingFrameCounter++;
						int num4 = 2;
						if (wingFrameCounter < num4)
						{
							wingFrame = 1;
							return;
						}
						if (wingFrameCounter < num4 * 2)
						{
							wingFrame = 2;
							return;
						}
						if (wingFrameCounter < num4 * 3)
						{
							wingFrame = 3;
							return;
						}
						if (wingFrameCounter < num4 * 4 - 1)
						{
							wingFrame = 2;
							return;
						}
						wingFrame = 2;
						wingFrameCounter = 0;
					}
					else
					{
						wingFrameCounter++;
						int num5 = 6;
						if (wingFrameCounter < num5)
						{
							wingFrame = 4;
							return;
						}
						if (wingFrameCounter < num5 * 2)
						{
							wingFrame = 5;
							return;
						}
						if (wingFrameCounter < num5 * 3 - 1)
						{
							wingFrame = 4;
							return;
						}
						wingFrame = 4;
						wingFrameCounter = 0;
					}
				}
				else
				{
					wingFrameCounter++;
					int num6 = 2;
					if (wingFrameCounter < num6)
					{
						wingFrame = 4;
						return;
					}
					if (wingFrameCounter < num6 * 2)
					{
						wingFrame = 5;
						return;
					}
					if (wingFrameCounter < num6 * 3)
					{
						wingFrame = 6;
						return;
					}
					if (wingFrameCounter < num6 * 4 - 1)
					{
						wingFrame = 5;
						return;
					}
					wingFrame = 5;
					wingFrameCounter = 0;
				}
			}
			else
			{
				wingFrameCounter++;
				int num7 = 6;
				if (wingFrameCounter < num7)
				{
					wingFrame = 4;
					return;
				}
				if (wingFrameCounter < num7 * 2)
				{
					wingFrame = 5;
					return;
				}
				if (wingFrameCounter < num7 * 3 - 1)
				{
					wingFrame = 4;
					return;
				}
				wingFrame = 4;
				wingFrameCounter = 0;
			}
			return;
		}
		if (wings == 12)
		{
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				int num8 = 5;
				if (wingFrameCounter < num8)
				{
					wingFrame = 1;
					return;
				}
				if (wingFrameCounter < num8 * 2)
				{
					wingFrame = 2;
					return;
				}
				if (wingFrameCounter < num8 * 3)
				{
					wingFrame = 3;
					return;
				}
				if (wingFrameCounter < num8 * 4 - 1)
				{
					wingFrame = 2;
					return;
				}
				wingFrame = 2;
				wingFrameCounter = 0;
			}
			else if (velocity.Y != 0f)
			{
				wingFrame = 2;
			}
			else
			{
				wingFrame = 0;
			}
			return;
		}
		if (wings == 24)
		{
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				int num9 = 1;
				if (wingFrameCounter < num9)
				{
					wingFrame = 1;
					return;
				}
				if (wingFrameCounter < num9 * 2)
				{
					wingFrame = 2;
					return;
				}
				if (wingFrameCounter < num9 * 3)
				{
					wingFrame = 3;
					return;
				}
				wingFrame = 2;
				if (wingFrameCounter >= num9 * 4 - 1)
				{
					wingFrameCounter = 0;
				}
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrameCounter++;
					int num10 = 3;
					if (wingFrameCounter < num10)
					{
						wingFrame = 1;
						return;
					}
					if (wingFrameCounter < num10 * 2)
					{
						wingFrame = 2;
						return;
					}
					if (wingFrameCounter < num10 * 3)
					{
						wingFrame = 3;
						return;
					}
					wingFrame = 2;
					if (wingFrameCounter >= num10 * 4 - 1)
					{
						wingFrameCounter = 0;
					}
				}
				else if (wingTime == 0f)
				{
					wingFrame = 0;
				}
				else
				{
					wingFrame = 1;
				}
			}
			else
			{
				wingFrame = 0;
			}
			return;
		}
		if (wings == 30)
		{
			bool flag2 = false;
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				int num11 = 2;
				if (wingFrameCounter >= num11 * 3)
				{
					wingFrameCounter = 0;
				}
				wingFrame = 1 + wingFrameCounter / num11;
				flag2 = true;
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrameCounter++;
					int num12 = 2;
					if (wingFrameCounter >= num12 * 3)
					{
						wingFrameCounter = 0;
					}
					wingFrame = 1 + wingFrameCounter / num12;
					flag2 = true;
				}
				else if (wingTime == 0f)
				{
					wingFrame = 0;
				}
				else
				{
					wingFrame = 0;
				}
			}
			else
			{
				wingFrame = 0;
			}
			if (!flag2)
			{
				return;
			}
			for (int j = 0; j < 4; j++)
			{
				if (Main.rand.Next(4) == 0)
				{
					Vector2 vector = (-0.74539816f + (float)Math.PI / 8f * (float)j + 0.03f * (float)j).ToRotationVector2() * new Vector2(-direction * 20, 20f);
					Dust dust = Main.dust[Dust.NewDust(base.Center, 0, 0, 229, 0f, 0f, 100, Color.White, 0.8f)];
					dust.noGravity = true;
					dust.noLightEmittence = flag;
					dust.position = base.Center + vector;
					dust.velocity = DirectionTo(dust.position) * 2f;
					if (Main.rand.Next(10) != 0)
					{
						dust.customData = this;
					}
					else
					{
						dust.fadeIn = 0.5f;
					}
					dust.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				}
			}
			for (int k = 0; k < 4; k++)
			{
				if (Main.rand.Next(8) == 0)
				{
					Vector2 vector2 = (-0.7053982f + (float)Math.PI / 8f * (float)k + 0.03f * (float)k).ToRotationVector2() * new Vector2(direction * 20, 24f) + new Vector2((float)(-direction) * 16f, 0f);
					Dust dust2 = Main.dust[Dust.NewDust(base.Center, 0, 0, 229, 0f, 0f, 100, Color.White, 0.5f)];
					dust2.noGravity = true;
					dust2.noLightEmittence = flag;
					dust2.position = base.Center + vector2;
					dust2.velocity = Vector2.Normalize(dust2.position - base.Center - new Vector2((float)(-direction) * 16f, 0f)) * 2f;
					dust2.position += dust2.velocity * 5f;
					if (Main.rand.Next(10) != 0)
					{
						dust2.customData = this;
					}
					else
					{
						dust2.fadeIn = 0.5f;
					}
					dust2.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				}
			}
			return;
		}
		if (wings == 34 && ShouldDrawWingsThatAreAlwaysAnimated())
		{
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				int num13 = 4;
				if (wingFrameCounter >= num13 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = wingFrameCounter / num13;
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrameCounter++;
					int num14 = 9;
					if (wingFrameCounter >= num14 * 6)
					{
						wingFrameCounter = 0;
					}
					wingFrame = wingFrameCounter / num14;
				}
				else
				{
					wingFrameCounter++;
					int num15 = 6;
					if (wingFrameCounter >= num15 * 6)
					{
						wingFrameCounter = 0;
					}
					wingFrame = wingFrameCounter / num15;
				}
			}
			else
			{
				wingFrameCounter++;
				int num16 = 4;
				if (wingFrameCounter >= num16 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = wingFrameCounter / num16;
			}
			return;
		}
		if (wings == 51)
		{
			int num17 = 2;
			int num18 = 8;
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				int num19 = 4;
				if (wingFrameCounter >= num19 * num18)
				{
					wingFrameCounter = num19 * num17;
				}
				wingFrame = wingFrameCounter / num19;
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrameCounter++;
					int num20 = 6;
					if (wingFrameCounter >= num20 * num18)
					{
						wingFrameCounter = num20 * num17;
					}
					wingFrame = wingFrameCounter / num20;
				}
				else
				{
					wingFrameCounter++;
					int num21 = 8;
					if (wingFrameCounter >= num21 * num18)
					{
						wingFrameCounter = num21 * num17;
					}
					wingFrame = wingFrameCounter / num21;
				}
			}
			else
			{
				wingFrame = 0;
				wingFrameCounter = 0;
			}
			return;
		}
		if (wings == 47)
		{
			bool canHover = false;
			bool canHoverBoostHorizontally = false;
			bool canBoost = false;
			GetWingsFunctionalityForVisuals(wingsLogic, out canHover, out canHoverBoostHorizontally, out canBoost);
			bool flag3 = false;
			bool flag4 = true;
			int num22 = 0;
			if (wingFlap)
			{
				num22 = ((velocity.Y * gravDir > 0f) ? 2 : ((canBoost && TryingToHoverUp) ? 3 : ((!canHover || !TryingToHoverDown) ? 4 : ((!canHoverBoostHorizontally || (!controlLeft && !controlRight)) ? 6 : 4))));
			}
			else if (velocity.Y != 0f)
			{
				num22 = 6;
				if (velocity.Y * gravDir > 0f)
				{
					flag3 = controlJump && !isPerformingJump_DownDash;
					if (flag3)
					{
						num22 = 3;
						if (wingFrame == 1)
						{
							flag4 = false;
						}
					}
					else if (wingFrame == 2)
					{
						flag4 = false;
					}
				}
			}
			else
			{
				flag4 = false;
				wingFrame = 0;
			}
			bool justSwitched = false;
			if (flag4)
			{
				if (wingFrame == 0)
				{
					wingFrame = 2;
				}
				wingFrameCounter++;
				if (wingFrameCounter >= num22)
				{
					justSwitched = true;
					wingFrameCounter = 0;
					if (wingFrame == 1)
					{
						wingFrame = 10;
					}
					else if (wingFrame == 3 && flag3)
					{
						wingFrame = 1;
					}
					else if (++wingFrame > 10)
					{
						wingFrame = 2;
					}
				}
			}
			else
			{
				wingFrameCounter = 0;
			}
			ChickenBonesWingDust(flag, justSwitched);
			return;
		}
		if (wings == 49)
		{
			bool canHover2 = false;
			bool canHoverBoostHorizontally2 = false;
			bool canBoost2 = false;
			GetWingsFunctionalityForVisuals(wingsLogic, out canHover2, out canHoverBoostHorizontally2, out canBoost2);
			bool flag5 = false;
			bool flag6 = true;
			int num23 = 0;
			if (wingFlap)
			{
				num23 = ((velocity.Y * gravDir > 0f) ? 2 : ((canBoost2 && TryingToHoverUp) ? 3 : ((!canHover2 || !TryingToHoverDown) ? 4 : ((!canHoverBoostHorizontally2 || (!controlLeft && !controlRight)) ? 6 : 4))));
			}
			else if (velocity.Y != 0f)
			{
				num23 = 6;
				if (velocity.Y * gravDir > 0f)
				{
					flag5 = controlJump && !isPerformingJump_DownDash;
					if (flag5)
					{
						num23 = 3;
						if (wingFrame == 1)
						{
							flag6 = false;
						}
					}
					else if (wingFrame == 2)
					{
						flag6 = false;
					}
				}
			}
			else
			{
				flag6 = false;
				wingFrame = 0;
			}
			bool justSwitched2 = false;
			if (flag6)
			{
				if (wingFrame == 0)
				{
					wingFrame = 2;
				}
				wingFrameCounter++;
				if (wingFrameCounter >= num23)
				{
					justSwitched2 = true;
					wingFrameCounter = 0;
					if (wingFrame == 1)
					{
						wingFrame = 10;
					}
					else if (wingFrame == 3 && flag5)
					{
						wingFrame = 1;
					}
					else if (++wingFrame > 10)
					{
						wingFrame = 2;
					}
				}
			}
			else
			{
				wingFrameCounter = 0;
			}
			HeroicisWingDust(flag, justSwitched2);
			return;
		}
		if (wings == 50)
		{
			bool canHover3 = false;
			bool canHoverBoostHorizontally3 = false;
			bool canBoost3 = false;
			GetWingsFunctionalityForVisuals(wingsLogic, out canHover3, out canHoverBoostHorizontally3, out canBoost3);
			bool flag7 = false;
			bool flag8 = true;
			int num24 = 0;
			if (wingFlap)
			{
				num24 = ((velocity.Y * gravDir > 0f) ? 2 : ((canBoost3 && TryingToHoverUp) ? 3 : ((!canHover3 || !TryingToHoverDown) ? 4 : ((!canHoverBoostHorizontally3 || (!controlLeft && !controlRight)) ? 6 : 4))));
			}
			else if (velocity.Y != 0f)
			{
				num24 = 5;
				if (velocity.Y * gravDir > 0f)
				{
					flag7 = controlJump && !isPerformingJump_DownDash;
					if (flag7)
					{
						num24 = 3;
						if (wingFrame == 1)
						{
							flag8 = false;
						}
					}
					else if (wingFrame == 2)
					{
						flag8 = false;
					}
				}
			}
			else
			{
				flag8 = false;
				wingFrame = 0;
			}
			bool justSwitched3 = false;
			if (flag8)
			{
				if (wingFrame == 0)
				{
					wingFrame = 2;
				}
				wingFrameCounter++;
				if (wingFrameCounter >= num24)
				{
					justSwitched3 = true;
					wingFrameCounter = 0;
					if (wingFrame == 1)
					{
						wingFrame = 3;
					}
					else if (wingFrame == 2 && flag7)
					{
						wingFrame = 1;
					}
					else if (++wingFrame > 9)
					{
						wingFrame = 2;
					}
				}
			}
			else
			{
				wingFrameCounter = 0;
			}
			KazzymodusWingDust(flag, justSwitched3);
			return;
		}
		if (wings == 45 && ShouldDrawWingsThatAreAlwaysAnimated())
		{
			if (wingTime > 0f)
			{
				rocketDelay2--;
				if (rocketDelay2 <= 0)
				{
					SoundEngine.PlaySound(SoundID.Item24, position);
					rocketDelay2 = 30;
				}
			}
			if (velocity.Y == 0f)
			{
				wingFrameCounter = 0;
				wingFrame = 0;
			}
			else
			{
				wingFrameCounter++;
				int num25 = 3;
				if (wingTime == 0f)
				{
					num25 = 5;
				}
				if (wingFrameCounter >= num25 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = wingFrameCounter / num25;
			}
			if (Main.netMode != 2 && Main.rand.Next(8) == 0)
			{
				Rectangle r = Utils.CenteredRectangle(Main.ReverseGravitySupport(base.Bottom - Main.screenPosition) + Main.screenPosition, new Vector2(40f, 24f));
				Dust dust3 = Dust.NewDustDirect(r.TopLeft(), r.Width, r.Height, 43, 0f, 0f, 0, Color.White * 0.5f, 0.2f);
				dust3.fadeIn = 0.4f;
				dust3.velocity += velocity;
				dust3.velocity *= 0.35f;
				dust3.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			}
			return;
		}
		if (wings == 44 && ShouldDrawWingsThatAreAlwaysAnimated())
		{
			int num26 = 5;
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				if (wingFrameCounter >= num26 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = 1 + wingFrameCounter / num26;
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrame = 2;
				}
				else if (ShouldFloatInWater && wet)
				{
					wingFrame = 0;
				}
				else
				{
					wingFrame = 3;
				}
			}
			else
			{
				wingFrameCounter++;
				if (wingFrameCounter >= num26 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = 1 + wingFrameCounter / num26;
			}
			return;
		}
		if (wings == 39 && ShouldDrawWingsThatAreAlwaysAnimated())
		{
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				int num27 = 4;
				if (wingFrameCounter >= num27 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = wingFrameCounter / num27;
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrameCounter++;
					int num28 = 9;
					if (wingFrameCounter >= num28 * 6)
					{
						wingFrameCounter = 0;
					}
					wingFrame = wingFrameCounter / num28;
				}
				else
				{
					wingFrameCounter++;
					int num29 = 6;
					if (wingFrameCounter >= num29 * 6)
					{
						wingFrameCounter = 0;
					}
					wingFrame = wingFrameCounter / num29;
				}
			}
			else
			{
				wingFrameCounter++;
				int num30 = 4;
				if (wingFrameCounter >= num30 * 6)
				{
					wingFrameCounter = 0;
				}
				wingFrame = wingFrameCounter / num30;
			}
			int num31 = 1;
			if (wingFrame == 3)
			{
				num31 = 5;
			}
			if (velocity.Y == 0f)
			{
				num31 = 0;
			}
			Rectangle r2 = Utils.CenteredRectangle((gravDir == 1f) ? (base.Bottom + new Vector2(0f, -10f)) : (base.Top + new Vector2(0f, 10f)), new Vector2(50f, 20f));
			for (int l = 0; l < num31; l++)
			{
				Dust dust4 = Dust.NewDustDirect(r2.TopLeft(), r2.Width, r2.Height, 31, 0f, 0f, 0, Color.Black);
				dust4.scale = 0.7f;
				dust4.velocity *= 0.4f;
				dust4.velocity.Y += gravDir * 0.5f;
				dust4.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			}
			return;
		}
		if (wings == 33)
		{
			bool flag9 = false;
			if (wingFlap || jump > 0)
			{
				flag9 = true;
			}
			else if (velocity.Y != 0f && controlJump)
			{
				flag9 = true;
			}
			if (!flag9)
			{
				return;
			}
			Color newColor = Main.hslToRgb(Main.rgbToHsl(eyeColor).X, 1f, 0.5f);
			int num32 = ((direction != 1) ? (-4) : 0);
			int num33 = ((gravDir == 1f) ? height : 0);
			for (int m = 0; m < 2; m++)
			{
				Dust dust5 = Main.dust[Dust.NewDust(position, width, height, 182, velocity.X, velocity.Y, 127, newColor)];
				dust5.noGravity = true;
				dust5.fadeIn = 1f;
				dust5.scale = 1f;
				dust5.noLight = true;
				dust5.noLightEmittence = flag;
				dust5.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				switch (m)
				{
				case 0:
					dust5.position = new Vector2(position.X + (float)num32, position.Y + (float)num33);
					dust5.velocity.X = dust5.velocity.X * 1f - 2f - velocity.X * 0.3f;
					dust5.velocity.Y = dust5.velocity.Y * 1f + 2f * gravDir - velocity.Y * 0.3f;
					break;
				case 1:
					dust5.position = new Vector2(position.X + (float)width + (float)num32, position.Y + (float)num33);
					dust5.velocity.X = dust5.velocity.X * 1f + 2f - velocity.X * 0.3f;
					dust5.velocity.Y = dust5.velocity.Y * 1f + 2f * gravDir - velocity.Y * 0.3f;
					break;
				}
				if (dust5.dustIndex != 6000)
				{
					Dust dust6 = Dust.CloneDust(dust5);
					dust6.scale *= 0.65f;
					dust6.fadeIn *= 0.65f;
					dust6.color = new Color(255, 255, 255, 255);
					dust5.noLight = true;
					dust5.noLightEmittence = flag;
					dust5.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				}
			}
			return;
		}
		if (wings == 38)
		{
			bool flag10 = false;
			if (wingFlap || jump > 0)
			{
				wingFrameCounter++;
				if (wingFrameCounter >= 32)
				{
					wingFrameCounter = 0;
				}
				wingFrame = 1 + wingFrameCounter / 8;
				if (wingFrame == 4)
				{
					wingFrame = 2;
				}
				flag10 = true;
			}
			else if (velocity.Y != 0f)
			{
				if (controlJump)
				{
					wingFrameCounter++;
					if (wingFrameCounter >= 32)
					{
						wingFrameCounter = 0;
					}
					wingFrame = 1 + wingFrameCounter / 8;
					if (wingFrame == 4)
					{
						wingFrame = 2;
					}
					flag10 = true;
				}
				else
				{
					wingFrame = 0;
				}
			}
			else
			{
				wingFrame = 0;
			}
			if (!flag10)
			{
				return;
			}
			Vector2 vector3 = new Vector2(direction, gravDir);
			Vector2 value = velocity * 0.5f;
			int type2 = 267;
			int num34 = miscCounter * direction;
			for (int n = 0; n < 3; n++)
			{
				Vector2 vector4 = Vector2.Zero;
				switch (n)
				{
				case 1:
					vector4 = velocity * -0.33f;
					break;
				case 2:
					vector4 = velocity * -0.66f;
					break;
				}
				Vector2 vector5 = new Vector2(-39f, 6f) * vector3 + new Vector2(2f, 0f).RotatedBy((float)num34 / -15f * ((float)Math.PI * 2f));
				Dust dust7 = Dust.NewDustPerfect(base.Center + vector5 + vector4, type2, value, 0, underShirtColor);
				dust7.noGravity = true;
				dust7.noLight = true;
				dust7.noLightEmittence = flag;
				dust7.scale = 0.47f;
				dust7.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				vector5 = new Vector2(-23f, 2f) * vector3 + new Vector2(2f, 0f).RotatedBy((float)num34 / -15f * ((float)Math.PI * 2f));
				Dust dust8 = Dust.NewDustPerfect(base.Center + vector5 + vector4, type2, value, 0, underShirtColor);
				dust8.noGravity = true;
				dust8.noLight = true;
				dust8.noLightEmittence = flag;
				dust8.scale = 0.35f;
				dust8.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				vector5 = new Vector2(-31f, -6f) * vector3 + new Vector2(2f, 0f).RotatedBy((float)num34 / -20f * ((float)Math.PI * 2f));
				Dust dust9 = Dust.NewDustPerfect(base.Center + vector5 + vector4, type2, value, 0, underShirtColor);
				dust9.noGravity = true;
				dust9.noLight = true;
				dust9.noLightEmittence = flag;
				dust9.scale = 0.49f;
				dust9.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			}
			return;
		}
		int num35 = 4;
		int num36 = 4;
		int num37 = 0;
		int num38 = 0;
		int num39 = 1;
		if (wings == 43)
		{
			num36 = 7;
			num37 = 1;
			num35 = 3;
		}
		if (wings == 48)
		{
			num36 = 8;
			num37 = 0;
			num35 = 2;
		}
		if (wings == 32)
		{
			num35 = 3;
		}
		if (wingFlap || jump > 0)
		{
			wingFrameCounter++;
			if (wingFrameCounter > num35)
			{
				wingFrame++;
				wingFrameCounter = 0;
				if (wingFrame >= num36)
				{
					wingFrame = num37;
				}
			}
		}
		else if (velocity.Y != 0f)
		{
			wingFrame = num39;
			if (wings == 32)
			{
				wingFrame = 3;
			}
			if (wings == 43)
			{
				wingFrame = 2;
				if (ShouldFloatInWater && wet)
				{
					wingFrame = num38;
				}
			}
			if (wings == 49)
			{
				wingFrame = 1;
				if (ShouldFloatInWater && wet)
				{
					wingFrame = num38;
				}
			}
			if (wings == 29 && Main.rand.Next(5) == 0)
			{
				int num40 = 4;
				if (direction == 1)
				{
					num40 = -40;
				}
				int num41 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num40, position.Y + (float)(height / 2) - 15f), 30, 30, 6, 0f, 0f, 100, default(Color), 2.4f);
				Main.dust[num41].noGravity = true;
				Main.dust[num41].noLightEmittence = flag;
				Main.dust[num41].velocity *= 0.3f;
				if (Main.rand.Next(10) == 0)
				{
					Main.dust[num41].fadeIn = 2f;
				}
				Main.dust[num41].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			}
		}
		else
		{
			wingFrame = num38;
		}
	}

	private void ChickenBonesWingDust(bool noDustLight, bool justSwitched)
	{
		if (Main.netMode == 2 || wingFrame == 0)
		{
			return;
		}
		float num = 0f;
		switch (wingFrame)
		{
		case 1:
			num = 0f;
			break;
		case 2:
			num = 0f;
			break;
		case 3:
			num = 0.5f;
			break;
		case 4:
			num = 1f;
			break;
		case 5:
			num = 1f;
			break;
		case 6:
			num = 0.5f;
			break;
		case 7:
			num = 0f;
			break;
		case 8:
			num = -0.5f;
			break;
		case 9:
			num = -1f;
			break;
		case 10:
			num = -0.5f;
			break;
		}
		Color newColor = new Color(50, 120, 255, 200);
		float num2 = 1.1f;
		float fadeIn = 0f;
		float num3 = 0.25f;
		if (justSwitched && wingFrame == 6 && controlJump)
		{
			for (int i = 0; i < 8; i++)
			{
				Point p = new Point(10, 10);
				Vector2 vector = ((i < 4) ? new Vector2(-25 * direction, 20f * gravDir) : new Vector2(-5 * direction, 20f * gravDir));
				Dust dust = Dust.NewDustDirect(base.Center - p.ToVector2() / 2f + vector, p.X, p.Y, 264, 0f, 0f, 0, newColor, num2 * (1f + num3 * Main.rand.NextFloatDirection()));
				float x = (dust.position - base.Center - vector).X;
				dust.position.Y += x * 2f;
				dust.noGravity = true;
				dust.noLightEmittence = noDustLight;
				dust.noLight = true;
				dust.fadeIn = fadeIn;
				dust.velocity = new Vector2(x * 0.5f, 3f);
				dust.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				dust.customData = this;
			}
		}
		if (Main.rand.Next(6) == 0)
		{
			Point p2 = new Point(30, 50);
			Vector2 vector2 = new Vector2(-30 * direction, 0f);
			Dust dust2 = Dust.NewDustDirect(base.Center - p2.ToVector2() / 2f + vector2, p2.X, p2.Y, 264, 0f, 0f, 0, newColor, num2 * (1f + num3 * Main.rand.NextFloatDirection()));
			dust2.noGravity = true;
			dust2.noLightEmittence = noDustLight;
			dust2.noLight = true;
			dust2.velocity *= 0.1f;
			dust2.fadeIn = fadeIn;
			dust2.velocity.Y += num * 2f;
			dust2.position.Y += num * 2f;
			dust2.velocity += velocity * 0.3f * Main.rand.NextFloat();
			dust2.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			dust2.customData = this;
		}
	}

	private void HeroicisWingDust(bool noDustLight, bool justSwitched)
	{
		if (Main.netMode == 2 || wingFrame == 0)
		{
			return;
		}
		float num = 0f;
		switch (wingFrame)
		{
		case 1:
			num = 0f;
			break;
		case 2:
			num = 0f;
			break;
		case 3:
			num = 0.5f;
			break;
		case 4:
			num = 1f;
			break;
		case 5:
			num = 1f;
			break;
		case 6:
			num = 0.5f;
			break;
		case 7:
			num = 0f;
			break;
		case 8:
			num = -0.5f;
			break;
		case 9:
			num = -1f;
			break;
		case 10:
			num = -0.5f;
			break;
		}
		Color newColor = new Color(255, 255, 255, 200);
		float num2 = 0.6f;
		float fadeIn = 0f;
		float num3 = 0.45f;
		float z = Main.rgbToHsl(Lighting.GetColor(MountedCenter.ToTileCoordinates())).Z;
		z = Utils.Remap(z, 0.2f, 0.4f, 0f, 1f);
		if (justSwitched && wingFrame == 6 && controlJump)
		{
			for (int i = 0; i < 8; i++)
			{
				if (!(z < Main.rand.NextFloat()))
				{
					Point p = new Point(10, 5);
					Vector2 vector = ((i < 4) ? new Vector2(-20 * direction, 15f * gravDir) : new Vector2(-10 * direction, 15f * gravDir));
					Dust dust = Dust.NewDustDirect(base.Center - p.ToVector2() / 2f + vector, p.X, p.Y, 264, 0f, 0f, 0, newColor, num2 * (1f + num3 * Main.rand.NextFloatDirection()));
					float x = (dust.position - base.Center - vector).X;
					dust.position.Y += x * 2f;
					dust.noGravity = true;
					dust.noLightEmittence = noDustLight;
					dust.noLight = true;
					dust.fadeIn = fadeIn;
					dust.velocity = new Vector2(x * 0.5f, 2f);
					dust.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
					dust.customData = this;
				}
			}
		}
		if (Main.rand.Next(6) == 0 && z >= Main.rand.NextFloat())
		{
			Point p2 = new Point(30, 40);
			Vector2 vector2 = new Vector2(-30 * direction, 0f);
			Dust dust2 = Dust.NewDustDirect(base.Center - p2.ToVector2() / 2f + vector2, p2.X, p2.Y, 264, 0f, 0f, 0, newColor, num2 * (1f + num3 * Main.rand.NextFloatDirection()));
			dust2.noGravity = true;
			dust2.noLightEmittence = noDustLight;
			dust2.noLight = true;
			dust2.velocity *= 0.1f;
			dust2.fadeIn = fadeIn;
			dust2.velocity.Y += num * 1.5f;
			dust2.position.Y += num * 2f;
			dust2.velocity += velocity * 0.3f * Main.rand.NextFloat();
			dust2.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			dust2.customData = this;
		}
	}

	private void KazzymodusWingDust(bool noDustLight, bool justSwitched)
	{
		if (Main.netMode == 2 || wingFrame == 0)
		{
			return;
		}
		Color newColor = new Color(50, 120, 255, 200);
		if (justSwitched && wingFrame == 1)
		{
			float y = -20f * gravDir;
			Point p = new Point(30, 10);
			for (int i = 0; i < 16; i++)
			{
				int num = ((i < 4) ? (-25 * direction) : (-5 * direction));
				Vector2 vector = base.Center + new Vector2(num, y) - p.ToVector2() / 2f;
				float num2 = 1.2f;
				Dust dust = Dust.NewDustDirect(vector, p.X, p.Y, 6, 0f, 0f, 100, newColor, num2);
				dust.velocity.X = Main.rand.NextFloatDirection() * 5f;
				dust.velocity.Y = Main.rand.NextFloatDirection() * 2f;
				dust.fadeIn = num2;
				dust.noGravity = true;
				dust.noLightEmittence = noDustLight;
				dust.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			}
		}
		if (Main.rand.Next(4) == 0)
		{
			bool flag = Main.rand.Next(2) == 0;
			Point p2 = new Point(25, 20);
			int num3 = direction * (flag ? (-30) : 10);
			float y2 = gravDir * (float)((wingFrame == 1) ? (-25) : (-5));
			Vector2 vector2 = base.Center + new Vector2(num3, y2) - p2.ToVector2() / 2f;
			float num4 = 1.2f;
			Dust dust2 = Dust.NewDustDirect(vector2, p2.X, p2.Y, 6, 0f, 0f, 100, newColor, num4);
			dust2.velocity.X = Main.rand.NextFloatDirection() * 2.5f;
			dust2.velocity.Y = Main.rand.NextFloat() * 3f;
			dust2.fadeIn = num4;
			dust2.noGravity = true;
			dust2.noLightEmittence = noDustLight;
			dust2.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
	}

	public bool ShouldDrawWingsThatAreAlwaysAnimated(bool ignoreMounts = false)
	{
		if (velocity.Y != 0f && grappling[0] <= -1 && (!wet || !ShouldFloatInWater))
		{
			if (!ignoreMounts)
			{
				return mount.CanUseWings;
			}
			return true;
		}
		return false;
	}

	private void WingAirVisuals()
	{
		bool noLightEmittence = wingsLogic != wings;
		if (wings == 10 && Main.rand.Next(2) == 0)
		{
			int num = 4;
			if (direction == 1)
			{
				num = -40;
			}
			int num2 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num, position.Y + (float)(height / 2) - 15f), 30, 30, 76, 0f, 0f, 50, default(Color), 0.6f);
			Main.dust[num2].fadeIn = 1.1f;
			Main.dust[num2].noGravity = true;
			Main.dust[num2].noLight = true;
			Main.dust[num2].velocity *= 0.3f;
			Main.dust[num2].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (wings == 34 && Main.rand.Next(2) == 0)
		{
			int num3 = 4;
			if (direction == 1)
			{
				num3 = -40;
			}
			int num4 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num3, position.Y + (float)(height / 2) - 15f), 30, 30, 261, 0f, 0f, 50, default(Color), 0.6f);
			Main.dust[num4].fadeIn = 1.1f;
			Main.dust[num4].noGravity = true;
			Main.dust[num4].noLight = true;
			Main.dust[num4].noLightEmittence = noLightEmittence;
			Main.dust[num4].velocity *= 0.3f;
			Main.dust[num4].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (wings == 51 && Main.rand.Next(2) == 0)
		{
			int num5 = 4;
			if (direction == 1)
			{
				num5 = -40;
			}
			int num6 = Dust.NewDust(newColor: new Color(230, 130, 55), Position: new Vector2(position.X + (float)(width / 2) + (float)num5, position.Y + (float)(height / 2) - 15f), Width: 30, Height: 30, Type: 261, SpeedX: 0f, SpeedY: 0f, Alpha: 50, Scale: 0.6f);
			Main.dust[num6].fadeIn = 1.1f;
			Main.dust[num6].noGravity = true;
			Main.dust[num6].noLight = true;
			Main.dust[num6].noLightEmittence = noLightEmittence;
			Main.dust[num6].velocity *= 0.3f;
			Main.dust[num6].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		_ = wings;
		_ = 47;
		_ = wings;
		_ = 50;
		_ = wings;
		_ = 40;
		_ = wings;
		_ = 44;
		if (wings == 9 && Main.rand.Next(2) == 0)
		{
			int num7 = 4;
			if (direction == 1)
			{
				num7 = -40;
			}
			int num8 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num7, position.Y + (float)(height / 2) - 15f), 30, 30, 6, 0f, 0f, 200, default(Color), 2f);
			Main.dust[num8].noGravity = true;
			Main.dust[num8].noLightEmittence = noLightEmittence;
			Main.dust[num8].velocity *= 0.3f;
			Main.dust[num8].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (wings == 6 && Main.rand.Next(4) == 0)
		{
			int num9 = 4;
			if (direction == 1)
			{
				num9 = -40;
			}
			int num10 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num9, position.Y + (float)(height / 2) - 15f), 30, 30, 55, 0f, 0f, 200);
			Main.dust[num10].velocity *= 0.3f;
			Main.dust[num10].noLightEmittence = noLightEmittence;
			Main.dust[num10].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (wings == 5 && Main.rand.Next(3) == 0)
		{
			int num11 = 6;
			if (direction == 1)
			{
				num11 = -30;
			}
			int num12 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num11, position.Y), 18, height, 58, 0f, 0f, 255, default(Color), 1.2f);
			Main.dust[num12].noLightEmittence = noLightEmittence;
			Main.dust[num12].velocity *= 0.3f;
			Main.dust[num12].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (wings == 26)
		{
			int num13 = 6;
			if (direction == 1)
			{
				num13 = -30;
			}
			int num14 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num13, position.Y), 18, height, 217, 0f, 0f, 100, default(Color), 1.4f);
			Main.dust[num14].noGravity = true;
			Main.dust[num14].noLight = true;
			Main.dust[num14].velocity /= 4f;
			Main.dust[num14].velocity -= velocity;
			Main.dust[num14].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			if (Main.rand.Next(2) == 0)
			{
				num13 = -24;
				if (direction == 1)
				{
					num13 = 12;
				}
				float num15 = position.Y;
				if (gravDir == -1f)
				{
					num15 += (float)(height / 2);
				}
				num14 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num13, num15), 12, height / 2, 217, 0f, 0f, 100, default(Color), 1.4f);
				Main.dust[num14].noGravity = true;
				Main.dust[num14].noLight = true;
				Main.dust[num14].velocity /= 4f;
				Main.dust[num14].velocity -= velocity;
				Main.dust[num14].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			}
		}
		if (wings == 37)
		{
			int num16 = 6;
			if (direction == 1)
			{
				num16 = -30;
			}
			Dust dust = Dust.NewDustDirect(new Vector2(position.X + (float)(width / 2) + (float)num16, position.Y), 24, height, Utils.SelectRandom<int>(Main.rand, 31, 31, 31), 0f, 0f, 100);
			dust.noGravity = true;
			dust.noLight = true;
			dust.velocity /= 4f;
			dust.velocity -= velocity / 2f;
			dust.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
			if (dust.type == 55)
			{
				dust.noGravity = true;
				dust.velocity *= 2f;
				dust.color = Color.Red;
			}
			if (Main.rand.Next(3) == 0)
			{
				num16 = -24;
				if (direction == 1)
				{
					num16 = 12;
				}
				float num17 = position.Y;
				if (gravDir == -1f)
				{
					num17 += (float)(height / 2);
				}
				dust = Dust.NewDustDirect(new Vector2(position.X + (float)(width / 2) + (float)num16, num17), 16, height / 2, Utils.SelectRandom<int>(Main.rand, 31, 31, 31), 0f, 0f, 100);
				dust.noGravity = true;
				dust.noLight = true;
				dust.velocity /= 4f;
				dust.velocity -= velocity / 2f;
				dust.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
				if (dust.type == 55)
				{
					dust.noGravity = true;
					dust.velocity *= 2f;
					dust.color = Color.Red;
				}
			}
		}
		if (wings == 29 && Main.rand.Next(3) == 0)
		{
			int num18 = 4;
			if (direction == 1)
			{
				num18 = -40;
			}
			int num19 = Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num18, position.Y + (float)(height / 2) - 15f), 30, 30, 6, 0f, 0f, 100, default(Color), 2.4f);
			Main.dust[num19].noGravity = true;
			Main.dust[num19].velocity *= 0.3f;
			Main.dust[num19].noLightEmittence = noLightEmittence;
			if (Main.rand.Next(10) == 0)
			{
				Main.dust[num19].fadeIn = 2f;
			}
			Main.dust[num19].shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (wings != 31)
		{
			return;
		}
		if (Main.rand.Next(6) == 0)
		{
			int num20 = 4;
			if (direction == 1)
			{
				num20 = -40;
			}
			Dust obj = Main.dust[Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num20, position.Y + (float)(height / 2) - 15f), 30, 30, 86)];
			obj.noGravity = true;
			obj.scale = 1f;
			obj.fadeIn = 1.2f;
			obj.velocity *= 0.2f;
			obj.noLight = true;
			obj.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (Main.rand.Next(3) == 0)
		{
			int num21 = 4;
			if (direction == 1)
			{
				num21 = -40;
			}
			Dust obj2 = Main.dust[Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num21, position.Y + (float)(height / 2) - 15f), 30, 30, 240)];
			obj2.noGravity = true;
			obj2.scale = 1.2f;
			obj2.velocity *= 0.2f;
			obj2.alpha = 200;
			obj2.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (Main.rand.Next(2) != 0)
		{
			return;
		}
		if (Main.rand.Next(6) == 0)
		{
			int num22 = -24;
			if (direction == 1)
			{
				num22 = 12;
			}
			float num23 = position.Y;
			if (gravDir == -1f)
			{
				num23 += (float)(height / 2);
			}
			Dust obj3 = Main.dust[Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num22, num23), 12, height / 2, 86)];
			obj3.noGravity = true;
			obj3.scale = 1f;
			obj3.fadeIn = 1.2f;
			obj3.velocity *= 0.2f;
			obj3.noLight = true;
			obj3.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
		if (Main.rand.Next(3) == 0)
		{
			int num22 = -24;
			if (direction == 1)
			{
				num22 = 12;
			}
			float num24 = position.Y;
			if (gravDir == -1f)
			{
				num24 += (float)(height / 2);
			}
			Dust obj4 = Main.dust[Dust.NewDust(new Vector2(position.X + (float)(width / 2) + (float)num22, num24), 12, height / 2, 240)];
			obj4.noGravity = true;
			obj4.scale = 1.2f;
			obj4.velocity *= 0.2f;
			obj4.alpha = 200;
			obj4.shader = GameShaders.Armor.GetSecondaryShader(cWings, this);
		}
	}

	private void HandleBeingInChestRange()
	{
		if (chest != -1)
		{
			if (chest != -2)
			{
				piggyBankProjTracker.Clear();
			}
			if (chest != -5)
			{
				voidLensChest.Clear();
			}
			bool flag = false;
			int projectileLocalIndex = piggyBankProjTracker.ProjectileLocalIndex;
			if (projectileLocalIndex >= 0)
			{
				flag = true;
				if (!Main.projectile[projectileLocalIndex].active || (Main.projectile[projectileLocalIndex].type != 525 && Main.projectile[projectileLocalIndex].type != 960))
				{
					Main.PlayInteractiveProjectileOpenCloseSound(Main.projectile[projectileLocalIndex].type, open: false);
					chest = -1;
				}
				else
				{
					Vector2 vector = Main.projectile[projectileLocalIndex].Hitbox.ClosestPointInRect(base.Center);
					chestX = (int)vector.X / 16;
					chestY = (int)vector.Y / 16;
					if (!IsInTileInteractionRange(chestX, chestY, TileReachCheckSettings.Simple))
					{
						if (chest != -1)
						{
							Main.PlayInteractiveProjectileOpenCloseSound(Main.projectile[projectileLocalIndex].type, open: false);
						}
						chest = -1;
					}
				}
			}
			int projectileLocalIndex2 = voidLensChest.ProjectileLocalIndex;
			if (projectileLocalIndex2 >= 0)
			{
				flag = true;
				if (!Main.projectile[projectileLocalIndex2].active || Main.projectile[projectileLocalIndex2].type != 734)
				{
					SoundEngine.PlaySound(SoundID.Item130);
					chest = -1;
				}
				else
				{
					Vector2 vector2 = Main.projectile[projectileLocalIndex2].Hitbox.ClosestPointInRect(base.Center);
					chestX = (int)vector2.X / 16;
					chestY = (int)vector2.Y / 16;
					if (!IsInTileInteractionRange(chestX, chestY, TileReachCheckSettings.Simple))
					{
						if (chest != -1)
						{
							SoundEngine.PlaySound(SoundID.Item130);
						}
						chest = -1;
					}
				}
			}
			if (flag)
			{
				return;
			}
			if (!IsInInteractionRangeToMultiTileHitbox(chestX, chestY))
			{
				if (chest != -1)
				{
					SoundEngine.PlaySound(11);
				}
				chest = -1;
			}
			else if (!Main.tile[chestX, chestY].active())
			{
				SoundEngine.PlaySound(11);
				chest = -1;
			}
		}
		else
		{
			piggyBankProjTracker.Clear();
			voidLensChest.Clear();
		}
	}

	public bool IsInInteractionRangeToMultiTileHitbox(int chestPointX, int chestPointY)
	{
		Rectangle r = Rectangle.Empty;
		Tile tile = Main.tile[chestPointX, chestPointY];
		if (tile.type == 463 || tile.type == 491)
		{
			r = new Rectangle(chestPointX * 16 - 16, chestPointY * 16 - 32, 48, 64);
		}
		if (TileID.Sets.BasicChest[tile.type] || tile.type == 97)
		{
			r = new Rectangle(chestPointX * 16, chestPointY * 16, 32, 32);
		}
		if (tile.type == 88)
		{
			r = new Rectangle(chestPointX * 16, chestPointY * 16, 48, 32);
		}
		if (tile.type == 29)
		{
			r = new Rectangle(chestPointX * 16, chestPointY * 16, 32, 16);
		}
		r.Inflate(-1, -1);
		Point point = r.ClosestPointInRect(base.Center).ToTileCoordinates();
		chestPointX = point.X;
		chestPointY = point.Y;
		return IsInTileInteractionRange(chestPointX, chestPointY, TileReachCheckSettings.Simple);
	}

	public void ResetVisibleAccessories()
	{
		handon = -1;
		handoff = -1;
		back = -1;
		front = -1;
		shoe = -1;
		waist = -1;
		shield = -1;
		neck = -1;
		face = -1;
		balloon = -1;
		backpack = -1;
		tail = -1;
		faceHead = -1;
		faceFlower = -1;
		faceMask = -1;
		balloonFront = -1;
		beard = -1;
		coat = -1;
		voiceOverride = 0;
	}

	public void UpdateArmorLights()
	{
		if (vortexStealthActive)
		{
			return;
		}
		float num = 0f;
		float num2 = 0f;
		float num3 = 0f;
		switch (head)
		{
		case 11:
			num = 0.92f;
			num2 = 0.8f;
			num3 = 0.65f;
			break;
		case 216:
			num = 0.7f;
			num2 = 0.95f;
			num3 = 0.82f;
			break;
		case 285:
			num = 1f;
			num2 = 0.88f;
			num3 = 0.73f;
			break;
		case 169:
			num = 0f;
			num2 = 0.36f;
			num3 = 0.4f;
			break;
		case 170:
			num = 0.4f;
			num2 = 0.16f;
			num3 = 0.36f;
			break;
		case 171:
			num = 0.5f;
			num2 = 0.25f;
			num3 = 0.05f;
			break;
		case 189:
			num = 0.9f;
			num2 = 0.9f;
			num3 = 0.7f;
			break;
		case 178:
			num = 0.1f;
			num2 = 0.2f;
			num3 = 0.3f;
			break;
		case 211:
			num = 0.2f;
			num2 = 0.4f;
			num3 = 0.8f;
			break;
		}
		float num4 = 0f;
		float num5 = 0f;
		float num6 = 0f;
		switch (body)
		{
		case 175:
			num4 = 0f;
			num5 = 0.36f;
			num6 = 0.4f;
			break;
		case 176:
			num4 = 0.4f;
			num5 = 0.16f;
			num6 = 0.36f;
			break;
		case 177:
			num4 = 0.5f;
			num5 = 0.25f;
			num6 = 0.05f;
			break;
		case 190:
			num = 0.9f;
			num2 = 0.9f;
			num3 = 0.7f;
			break;
		case 205:
			num4 = 0.2f;
			num5 = 0.4f;
			num6 = 0.8f;
			break;
		}
		float num7 = 0f;
		float num8 = 0f;
		float num9 = 0f;
		switch (legs)
		{
		case 110:
			num7 = 0f;
			num8 = 0.36f;
			num9 = 0.4f;
			break;
		case 111:
			num7 = 0.4f;
			num8 = 0.16f;
			num9 = 0.36f;
			break;
		case 112:
			num7 = 0.5f;
			num8 = 0.25f;
			num9 = 0.05f;
			break;
		case 130:
			num = 0.9f;
			num2 = 0.9f;
			num3 = 0.7f;
			break;
		}
		if (num != 0f || num2 != 0f || num3 != 0f)
		{
			float num10 = 1f;
			if (num == num4 && num2 == num5 && num3 == num6)
			{
				num10 += 0.5f;
			}
			if (num == num7 && num2 == num8 && num3 == num9)
			{
				num10 += 0.5f;
			}
			Vector2 spinningpoint = new Vector2(width / 2 + 8 * direction, 2f);
			if (fullRotation != 0f)
			{
				spinningpoint = spinningpoint.RotatedBy(fullRotation, fullRotationOrigin);
			}
			int i = (int)(position.X + spinningpoint.X) / 16;
			int j = (int)(position.Y + spinningpoint.Y) / 16;
			Lighting.AddLight(i, j, num * num10, num2 * num10, num3 * num10);
		}
		if (num4 != 0f || num5 != 0f || num6 != 0f)
		{
			float num11 = 1f;
			if (num4 == num && num5 == num2 && num6 == num3)
			{
				num11 += 0.5f;
			}
			if (num4 == num7 && num5 == num8 && num6 == num9)
			{
				num11 += 0.5f;
			}
			Vector2 spinningpoint2 = new Vector2(width / 2 + 8, height / 2);
			if (fullRotation != 0f)
			{
				spinningpoint2 = spinningpoint2.RotatedBy(fullRotation, fullRotationOrigin);
			}
			int i2 = (int)(position.X + spinningpoint2.X) / 16;
			int j2 = (int)(position.Y + spinningpoint2.Y) / 16;
			Lighting.AddLight(i2, j2, num4 * num11, num5 * num11, num6 * num11);
		}
		if (num7 != 0f || num8 != 0f || num9 != 0f)
		{
			float num12 = 1f;
			if (num7 == num4 && num8 == num5 && num9 == num6)
			{
				num12 += 0.5f;
			}
			if (num7 == num && num8 == num2 && num9 == num3)
			{
				num12 += 0.5f;
			}
			Vector2 spinningpoint3 = new Vector2(width / 2 + 8 * direction, (float)height * 0.75f);
			if (fullRotation != 0f)
			{
				spinningpoint3 = spinningpoint3.RotatedBy(fullRotation, fullRotationOrigin);
			}
			int i3 = (int)(position.X + spinningpoint3.X) / 16;
			int j3 = (int)(position.Y + spinningpoint3.Y) / 16;
			Lighting.AddLight(i3, j3, num7 * num12, num8 * num12, num9 * num12);
		}
	}

	public void Update_NPCCollision()
	{
		if (creativeGodMode)
		{
			return;
		}
		Rectangle rectangle = new Rectangle((int)position.X, (int)position.Y, width, height);
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			if (!Main.npc[i].active || Main.npc[i].friendly || Main.npc[i].damage <= 0)
			{
				continue;
			}
			int specialHitSetter = ImmunityCooldownID.General;
			switch (Main.npc[i].type)
			{
			case 396:
			case 397:
			case 398:
			case 400:
			case 401:
				specialHitSetter = ImmunityCooldownID.BossNoCheese;
				break;
			case 636:
				specialHitSetter = ImmunityCooldownID.BossNoCheese;
				if (Main.npc[i].ai[0] == 0f || Main.npc[i].ai[0] == 10f)
				{
					continue;
				}
				break;
			}
			if ((specialHitSetter == ImmunityCooldownID.General && immune) || (dash == 2 && i == eocHit && eocDash > 0) || npcTypeNoAggro[Main.npc[i].type])
			{
				continue;
			}
			float damageMultiplier = 1f;
			Main.npc[i].position += Main.npc[i].netOffset;
			Rectangle npcRect = new Rectangle((int)Main.npc[i].position.X, (int)Main.npc[i].position.Y, Main.npc[i].width, Main.npc[i].height);
			NPC.GetMeleeCollisionData(rectangle, i, ref specialHitSetter, ref damageMultiplier, ref npcRect);
			if (rectangle.Intersects(npcRect))
			{
				if (Main.npc[i].type == 1 && Main.npc[i].ai[1] == 1125f)
				{
					AddBuff(48, 1800);
					Main.npc[i].position -= Main.npc[i].netOffset;
					continue;
				}
				bool flag = true;
				bool flag2 = false;
				bool num = CanParryAgainst(rectangle, npcRect, Main.npc[i].velocity);
				float num2 = thorns;
				float knockback = 10f;
				if (turtleThorns)
				{
					num2 = 2f;
				}
				if (num)
				{
					num2 = 2f;
					knockback = 5f;
					flag = false;
					flag2 = true;
				}
				int num3 = -1;
				if (Main.npc[i].position.X + (float)(Main.npc[i].width / 2) < position.X + (float)(width / 2))
				{
					num3 = 1;
				}
				int num4 = Main.DamageVar((float)Main.npc[i].damage * damageMultiplier, 0f - luck);
				if (GetBannerBuffEffect(Main.npc[i], out var effect))
				{
					num4 = (int)((float)num4 * effect.DamageReceived.Sample(Main.Difficulty));
				}
				bool flag3 = !immune;
				if (specialHitSetter >= 0)
				{
					flag3 = hurtCooldowns[specialHitSetter] == 0;
				}
				if (whoAmI == Main.myPlayer && num2 > 0f && flag3 && !Main.npc[i].dontTakeDamage)
				{
					int num5 = (int)((float)num4 * num2);
					if (num5 > 1000)
					{
						num5 = 1000;
					}
					ApplyDamageToNPC(Main.npc[i], num5, knockback, -num3, crit: false);
				}
				if (whoAmI == Main.myPlayer && cactusThorns && flag3 && !Main.npc[i].dontTakeDamage)
				{
					int damage = 15;
					if (Main.masterMode)
					{
						damage = 45;
					}
					else if (Main.expertMode)
					{
						damage = 30;
					}
					ApplyDamageToNPC(Main.npc[i], damage, knockback, -num3, crit: false);
				}
				if (resistCold && Main.npc[i].coldDamage)
				{
					num4 = (int)((float)num4 * 0.7f);
				}
				if (flag && Hurt(dodgeable: Main.npc[i].IsDamageDodgeable(), damageSource: PlayerDeathReason.ByNPC(i), Damage: num4, hitDirection: num3, pvp: false, quiet: false, Crit: false, cooldownCounter: specialHitSetter) > 0.0 && !dead && !flag2)
				{
					StatusFromNPC(Main.npc[i]);
				}
				if (num)
				{
					GiveImmuneTimeForCollisionAttack(longInvince ? 60 : 30);
					AddBuff(198, 300);
				}
			}
			Main.npc[i].position -= Main.npc[i].netOffset;
		}
	}

	public bool CanParryAgainst(Rectangle blockingPlayerRect, Rectangle enemyRect, Vector2 enemyVelocity)
	{
		if (shieldParryTimeLeft > 0 && Math.Sign(enemyRect.Center.X - blockingPlayerRect.Center.X) == direction && enemyVelocity != Vector2.Zero)
		{
			return !immune;
		}
		return false;
	}

	private void PurgeDD2EnergyCrystals()
	{
		if (trashItem.type == 3822)
		{
			trashItem.TurnToAir();
		}
		if (Main.myPlayer == whoAmI && Main.mouseItem.type == 3822)
		{
			Main.mouseItem.TurnToAir();
		}
		for (int i = 0; i < 59; i++)
		{
			Item item = inventory[i];
			if (item.stack > 0 && item.type == 3822)
			{
				item.TurnToAir();
			}
		}
		if (this.chest == -2)
		{
			Chest chest = bank;
			for (int j = 0; j < chest.maxItems; j++)
			{
				if (chest.item[j].stack > 0 && chest.item[j].type == 3822)
				{
					chest.item[j].TurnToAir();
				}
			}
		}
		if (this.chest == -4)
		{
			Chest chest2 = bank3;
			for (int k = 0; k < chest2.maxItems; k++)
			{
				if (chest2.item[k].stack > 0 && chest2.item[k].type == 3822)
				{
					chest2.item[k].TurnToAir();
				}
			}
		}
		if (this.chest == -5)
		{
			Chest chest3 = bank4;
			for (int l = 0; l < chest3.maxItems; l++)
			{
				if (chest3.item[l].stack > 0 && chest3.item[l].type == 3822)
				{
					chest3.item[l].TurnToAir();
				}
			}
		}
		if (this.chest == -3)
		{
			Chest chest4 = bank2;
			for (int m = 0; m < chest4.maxItems; m++)
			{
				if (chest4.item[m].stack > 0 && chest4.item[m].type == 3822)
				{
					chest4.item[m].TurnToAir();
				}
			}
		}
		if (this.chest <= -1)
		{
			return;
		}
		Chest chest5 = Main.chest[this.chest];
		for (int n = 0; n < chest5.maxItems; n++)
		{
			if (chest5.item[n].stack > 0 && chest5.item[n].type == 3822)
			{
				chest5.item[n].TurnToAir();
				if (Main.netMode == 1)
				{
					NetMessage.SendData(32, -1, -1, null, this.chest, n);
				}
			}
		}
	}

	public void ItemCheck_ManageRightClickFeatures()
	{
		bool flag = selectedItem != 58 && controlUseTile && Main.myPlayer == whoAmI && !tileInteractionHappened && releaseUseItem && !controlUseItem && !mouseInterface && !CaptureManager.Instance.Active && (!Main.mouseRightRelease || !Main.HoveringAnInteractable) && !Main.LocalPlayerHasPendingInventoryActions();
		bool flag2 = flag;
		if (!ItemID.Sets.ItemsThatAllowRepeatedRightClick[inventory[selectedItem].type] && !Main.mouseRightRelease)
		{
			flag2 = false;
		}
		if (flag2 && altFunctionUse == 0 && itemTime == 0 && itemAnimation == 0)
		{
			int num = -1;
			int type = 7;
			switch (inventory[selectedItem].type)
			{
			case 5324:
				num = 5329;
				type = 22;
				break;
			case 5329:
				num = 5330;
				type = 22;
				break;
			case 5330:
				num = 5324;
				type = 22;
				break;
			case 4346:
				num = 5391;
				type = 22;
				break;
			case 5391:
				num = 4346;
				type = 22;
				break;
			case 5325:
				num = 4131;
				break;
			case 4131:
				num = 5325;
				break;
			case 5323:
				num = 5455;
				break;
			case 5455:
				num = 5323;
				break;
			case 4767:
				num = 5453;
				break;
			case 5453:
				num = 4767;
				break;
			case 5309:
				num = 5454;
				break;
			case 5454:
				num = 5309;
				break;
			case 5358:
				num = 5360;
				type = 22;
				break;
			case 5360:
				num = 5361;
				type = 22;
				break;
			case 5361:
				num = 5359;
				type = 22;
				break;
			case 5359:
				num = 5358;
				type = 22;
				break;
			case 5437:
				num = 5358;
				type = 22;
				break;
			case 2611:
				num = 5526;
				break;
			case 5526:
				num = 2611;
				break;
			}
			if (num != -1)
			{
				releaseUseTile = false;
				Main.mouseRightRelease = false;
				SoundEngine.PlaySound(type);
				inventory[selectedItem].ChangeItemType(num);
			}
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].type == 3384)
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].type == 3858)
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].type == 4673)
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].type == 5667)
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].type == 3852 && itemAnimation == 0)
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].shoot > 0 && ProjectileID.Sets.TurretFeature[inventory[selectedItem].shoot])
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].shoot > 0 && ProjectileID.Sets.MinionTargettingFeature[inventory[selectedItem].shoot])
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].shoot > 0 && ItemID.Sets.IsAKite[inventory[selectedItem].type] && (inventory[selectedItem].holdStyle == 1 || ItemID.Sets.PlaceTileOnAltUse[inventory[selectedItem].type]))
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (flag2 && altFunctionUse == 0 && inventory[selectedItem].makeNPC > 0 && itemAnimation == 0 && ItemID.Sets.PlaceTileOnAltUse[inventory[selectedItem].type])
		{
			altFunctionUse = 1;
			controlUseItem = true;
		}
		if (!controlUseItem && altFunctionUse == 1)
		{
			altFunctionUse = 0;
		}
		if (TryingToUseItem() && mount.Active && Mount.DismountsOnItemUse(mount.Type) && HeldItem.mountType != mount.Type)
		{
			mount.TryEarlyDismount(this);
			if (mount.Active)
			{
				controlUseItem = false;
			}
		}
		ItemCheck_ManageRightClickFeatures_ShieldRaise(flag);
	}

	public void ItemCheck_ManageRightClickFeatures_ShieldRaise(bool theGeneralCheck)
	{
		bool mouseRight = PlayerInput.Triggers.JustPressed.MouseRight;
		if (whoAmI != Main.myPlayer)
		{
			mouseRight = shieldRaised;
			theGeneralCheck = shieldRaised;
		}
		bool shouldGuard = false;
		bool flag = inventory[selectedItem].type == 3823 || inventory[selectedItem].type == 4760;
		if (theGeneralCheck && flag && hasRaisableShield && !mount.Active && (itemAnimation == 0 || mouseRight))
		{
			shouldGuard = true;
		}
		if (shield_parry_cooldown > 0)
		{
			shield_parry_cooldown--;
			if (shield_parry_cooldown == 0)
			{
				SoundEngine.PlaySound(25, base.Center);
				for (int i = 0; i < 10; i++)
				{
					int num = Dust.NewDust(base.Center + new Vector2(direction * 6 + ((direction == -1) ? (-10) : 0), -14f), 10, 16, 45, 0f, 0f, 255, new Color(255, 100, 0, 127), (float)Main.rand.Next(10, 16) * 0.1f);
					Main.dust[num].noLight = true;
					Main.dust[num].noGravity = true;
					Main.dust[num].velocity *= 0.5f;
				}
			}
		}
		if (shieldParryTimeLeft > 0 && ++shieldParryTimeLeft > 20)
		{
			shieldParryTimeLeft = 0;
		}
		TryTogglingShield(shouldGuard);
	}

	public void TryTogglingShield(bool shouldGuard)
	{
		if (shouldGuard == shieldRaised)
		{
			return;
		}
		shieldRaised = shouldGuard;
		if (shieldRaised)
		{
			if (shield_parry_cooldown == 0)
			{
				shieldParryTimeLeft = 1;
			}
			itemAnimation = 0;
			itemTime = 0;
			reuseDelay = 0;
		}
		else
		{
			shield_parry_cooldown = 15;
			shieldParryTimeLeft = 0;
			ApplyAttackCooldown(20);
		}
	}

	private void HandleHotbarControls()
	{
		int num = 0;
		int num2 = PlayerInput.Triggers.Current.HotbarPlus.ToInt() - PlayerInput.Triggers.Current.HotbarMinus.ToInt();
		if (PlayerInput.CurrentProfile.HotbarAllowsRadial && num2 != 0 && PlayerInput.Triggers.Current.HotbarHoldTime > PlayerInput.CurrentProfile.HotbarRadialHoldTimeRequired && PlayerInput.CurrentProfile.HotbarRadialHoldTimeRequired != -1)
		{
			PlayerInput.MiscSettingsTEMP.HotbarRadialShouldBeUsed = true;
			PlayerInput.Triggers.Current.HotbarScrollCD = 2;
		}
		if (PlayerInput.CurrentProfile.HotbarRadialHoldTimeRequired != -1)
		{
			num2 = PlayerInput.Triggers.JustReleased.HotbarPlus.ToInt() - PlayerInput.Triggers.JustReleased.HotbarMinus.ToInt();
			if (PlayerInput.Triggers.Current.HotbarScrollCD == 1 && num2 != 0)
			{
				num2 = 0;
			}
		}
		if (PlayerInput.Triggers.Current.HotbarScrollCD == 0 && num2 != 0)
		{
			num += num2;
			PlayerInput.Triggers.Current.HotbarScrollCD = 8;
		}
		if (!Main.inFancyUI && !Main.ingameOptionsWindow)
		{
			num += PlayerInput.ScrollWheelDelta / -120;
		}
		if (num != 0)
		{
			selectedItemState.Select(ClampHotbarOffset(selectedItemState.Hotbar + num));
		}
	}

	private void ItemCheckWrapped(int i)
	{
		int num;
		if (!controlLeft && !controlRight && !controlUp && !controlDown && PlayerInput.UsingGamepad && Main.SmartCursorIsUsed)
		{
			num = ((PlayerInput.GamepadThumbstickRight.Length() < 0.05f) ? 1 : 0);
			if (num != 0)
			{
				ForceForwardCursor(state: true);
			}
		}
		else
		{
			num = 0;
		}
		int num2;
		if (PlayerInput.smartSelectPointer.ShouldBeUsed())
		{
			num2 = ((!Main.SmartCursorIsUsed) ? 1 : 0);
			if (num2 != 0)
			{
				ForceSmartSelectCursor(state: true);
			}
		}
		else
		{
			num2 = 0;
		}
		LockOnHelper.SetUP();
		if (Main.ignoreErrors)
		{
			ItemCheck();
		}
		else
		{
			ItemCheck();
		}
		LockOnHelper.SetDOWN();
		if (num2 != 0)
		{
			ForceSmartSelectCursor(state: false);
		}
		if (num != 0)
		{
			ForceForwardCursor(state: false);
		}
		if (itemAnimation == 0)
		{
			lastVisualizedSelectedItem = HeldItem.Clone();
		}
	}

	private void ForceForwardCursor(bool state)
	{
		if (state != _forceForwardCursor)
		{
			_forceForwardCursor = state;
			if (state)
			{
				_inputMouseCoordsForward = new Point(PlayerInput.MouseX, PlayerInput.MouseY);
				_mainMouseCoordsForward = new Point(Main.mouseX, Main.mouseY);
				Point point = (base.Center - Main.screenPosition + new Vector2(direction * 200, 0f)).ToPoint();
				Main.mouseX = (PlayerInput.MouseX = point.X);
				Main.mouseY = (PlayerInput.MouseY = point.Y);
			}
			else
			{
				PlayerInput.MouseX = _inputMouseCoordsForward.X;
				PlayerInput.MouseY = _inputMouseCoordsForward.Y;
				Main.mouseX = _mainMouseCoordsForward.X;
				Main.mouseY = _mainMouseCoordsForward.Y;
			}
		}
	}

	private void ForceSmartSelectCursor(bool state)
	{
		if (state != _forceSmartSelectCursor)
		{
			_forceSmartSelectCursor = state;
			if (state)
			{
				_inputMouseCoordsSmartSelect = new Point(PlayerInput.MouseX, PlayerInput.MouseY);
				_mainMouseCoordsSmartSelect = new Point(Main.mouseX, Main.mouseY);
				_tileTargetSmartSelect = new Point(tileTargetX, tileTargetY);
				Point p = PlayerInput.smartSelectPointer.GetPointerPosition().ToPoint();
				Main.mouseX = (PlayerInput.MouseX = p.X);
				Main.mouseY = (PlayerInput.MouseY = p.Y);
				Point point = (p.ToVector2() + Main.screenPosition).ToTileCoordinates();
				tileTargetX = point.X;
				tileTargetY = point.Y;
			}
			else
			{
				PlayerInput.MouseX = _inputMouseCoordsSmartSelect.X;
				PlayerInput.MouseY = _inputMouseCoordsSmartSelect.Y;
				Main.mouseX = _mainMouseCoordsSmartSelect.X;
				Main.mouseY = _mainMouseCoordsSmartSelect.Y;
				tileTargetX = _tileTargetSmartSelect.X;
				tileTargetY = _tileTargetSmartSelect.Y;
			}
		}
	}

	private static int ClampHotbarOffset(int Offset)
	{
		while (Offset > 9)
		{
			Offset -= 10;
		}
		while (Offset < 0)
		{
			Offset += 10;
		}
		return Offset;
	}

	public List<int> GetListOfProjectilesToInteractWithHack()
	{
		return _projectilesToInteractWith;
	}

	public void LockGamepadTileInteractions()
	{
		releaseUseTile = false;
		_lockTileInteractionsTimer = 3;
		PlayerInput.LockGamepadTileUseButton = true;
	}

	public void LookForTileInteractions()
	{
		hoveredChestIndex = -1;
		extractinateHover = false;
		if (Main.netMode == 2 || Main.myPlayer != whoAmI || Main.mapFullscreen || Main.InGameUI.CurrentState == Main.BestiaryUI)
		{
			return;
		}
		int smartInteractX = tileTargetX;
		int smartInteractY = tileTargetY;
		if (Main.SmartInteractShowingGenuine && Main.SmartInteractNPC == -1 && Main.SmartInteractProj == -1)
		{
			smartInteractX = Main.SmartInteractX;
			smartInteractY = Main.SmartInteractY;
		}
		bool flag = controlUseTile;
		if (PlayerInput.UsingGamepad && Main.HoveringOverAnNPC)
		{
			flag = false;
		}
		if (Main.gamePaused)
		{
			flag = false;
		}
		if (releaseUseTile)
		{
			tileInteractionHappened = false;
		}
		tileInteractAttempted = flag;
		if (tileInteractAttempted && releaseUseTile)
		{
			if (Main.instance.currentNPCShowingChatBubble > -1 && (talkNPC == -1 || !Main.npcChatRelease))
			{
				tileInteractAttempted = true;
				releaseUseTile = false;
			}
			if (Main.HasInteractibleObjectThatIsNotATile)
			{
				tileInteractAttempted = true;
				releaseUseTile = false;
			}
		}
		if (IsInTileInteractionRange(smartInteractX, smartInteractY, TileReachCheckSettings.Simple))
		{
			TileInteractionsCheckLongDistance(tileTargetX, tileTargetY);
			TileInteractionsCheck(smartInteractX, smartInteractY);
		}
		else
		{
			TileInteractionsCheckLongDistance(smartInteractX, smartInteractY);
		}
		TryInteractingWithMinecartTrackInNearbyArea(smartInteractX, smartInteractY);
	}

	private void TryInteractingWithMinecartTrackInNearbyArea(int selectedTargetX, int selectedTargetY)
	{
		if (!botherWithUnaimedMinecartTracks || tileInteractionHappened || Main.SmartInteractShowingGenuine || Main.SmartInteractNPC != -1 || Main.SmartInteractProj != -1 || !WorldGen.InWorld(selectedTargetX, selectedTargetY, 10) || gravDir != 1f)
		{
			return;
		}
		int num = 2;
		for (int i = selectedTargetX - num; i <= selectedTargetX + num; i++)
		{
			for (int j = selectedTargetY - num; j <= selectedTargetY + num; j++)
			{
				if (!IsInTileInteractionRange(i, j, TileReachCheckSettings.Simple))
				{
					continue;
				}
				Tile tile = Main.tile[i, j];
				if (tile == null)
				{
					continue;
				}
				if (tile.active() && tile.type == 314)
				{
					if (!cursorItemIconEnabled)
					{
						noThrow = 2;
						cursorItemIconEnabled = true;
						cursorItemIconID = 2343;
					}
					if (tileInteractAttempted)
					{
						TileInteractionsCheck(i, j);
					}
				}
				if (tileInteractionHappened)
				{
					return;
				}
			}
		}
	}

	public bool InTileEntityInteractionRange(int interactX, int interactY, int tileSizeX, int tileSizeY, TileReachCheckSettings settings)
	{
		_ = Main.tile[interactX, interactY];
		Rectangle r = new Rectangle(interactX * 16, interactY * 16, 16 * tileSizeX, 16 * tileSizeY);
		r.Inflate(-1, -1);
		Point point = r.ClosestPointInRect(base.Center).ToTileCoordinates();
		interactX = point.X;
		interactY = point.Y;
		return IsInTileInteractionRange(interactX, interactY, settings);
	}

	public bool IsInTileInteractionRange(int targetX, int targetY, TileReachCheckSettings settings, int TB = 0)
	{
		settings.GetTileRegion(this, out var LX, out var LY, out var HX, out var HY, TB);
		return Collision.InTileBounds(targetX, targetY, LX, LY, HX, HY);
	}

	public void TileInteractionsCheck(int myX, int myY)
	{
		if (Main.tile[myX, myY] == null)
		{
			Main.tile[myX, myY] = new Tile();
		}
		if (Main.tile[myX, myY].active())
		{
			TileInteractionsMouseOver(myX, myY);
			TileInteractionsUse(myX, myY);
		}
	}

	private void TileInteractionsCheckLongDistance(int myX, int myY)
	{
		if (!WorldGen.InWorld(myX, myY, 10) || Main.tile[myX, myY] == null || !Main.tile[myX, myY].active())
		{
			return;
		}
		if (TileID.Sets.BasicChest[Main.tile[myX, myY].type])
		{
			TileInteractionsMouseOver_Containers(myX, myY);
			if (cursorItemIconText == "")
			{
				cursorItemIconEnabled = false;
				cursorItemIconID = 0;
			}
		}
		if (Main.tile[myX, myY].type == 88)
		{
			Tile tile = Main.tile[myX, myY];
			int num = myY;
			int x = myX - tile.frameX % 54 / 18;
			if (tile.frameY % 36 != 0)
			{
				num--;
			}
			int num2 = Chest.FindChest(x, num);
			cursorItemIconID = -1;
			if (num2 < 0)
			{
				cursorItemIconText = Lang.dresserType[0].Value;
			}
			else
			{
				if (Main.chest[num2].name != "")
				{
					cursorItemIconText = Main.chest[num2].name;
				}
				else
				{
					cursorItemIconText = Lang.dresserType[tile.frameX / 54].Value;
				}
				if (cursorItemIconText == Lang.dresserType[tile.frameX / 54].Value)
				{
					cursorItemIconID = Chest.dresserTypeToIcon[tile.frameX / 54];
					cursorItemIconText = "";
				}
			}
			noThrow = 2;
			cursorItemIconEnabled = true;
			if (cursorItemIconText == "")
			{
				cursorItemIconEnabled = false;
				cursorItemIconID = 0;
			}
		}
		if (Main.tileSign[Main.tile[myX, myY].type])
		{
			noThrow = 2;
			int num3 = Main.tile[myX, myY].frameX / 18;
			int num4 = Main.tile[myX, myY].frameY / 18;
			num3 %= 2;
			int num5 = myX - num3;
			int num6 = myY - num4;
			Main.signBubble = true;
			Main.signX = num5 * 16 + 16;
			Main.signY = num6 * 16;
			int num7 = Sign.ReadSign(num5, num6, CreateIfMissing: false);
			if (num7 != -1 && tileTargetX >= num5 && tileTargetY >= num6 && tileTargetX <= num5 + 1 && tileTargetY <= num6 + 1)
			{
				Main.signHover = num7;
				cursorItemIconEnabled = false;
				cursorItemIconID = -1;
			}
		}
	}

	private void TileInteractionsUse(int myX, int myY)
	{
		if (WiresUI.Open || ownedProjectileCounts[651] > 0)
		{
			return;
		}
		bool flag = releaseUseTile;
		if (!tileInteractAttempted)
		{
			return;
		}
		bool flag2 = false;
		if (Main.tile[myX, myY].type == 212 && snowBallLauncherInteractionCooldown <= 0)
		{
			flag2 = true;
			snowBallLauncherInteractionCooldown = 7;
			SoundEngine.PlaySound(SoundID.Item11, position);
			int num = Main.tile[myX, myY].frameX / 18;
			int num2 = 0;
			while (num >= 3)
			{
				num2++;
				num -= 3;
			}
			num = myX - num;
			int num3;
			for (num3 = Main.tile[myX, myY].frameY / 18; num3 >= 3; num3 -= 3)
			{
			}
			num3 = myY - num3;
			float num4 = 12f + (float)Main.rand.Next(450) * 0.01f;
			float num5 = Main.rand.Next(85, 105);
			float num6 = Main.rand.Next(-35, 11);
			int type = 166;
			int damage = 35;
			float knockBack = 3.5f;
			Vector2 vector = new Vector2((num + 2) * 16 - 8, (num3 + 2) * 16 - 8 - 4);
			if (num2 == 0)
			{
				num5 *= -1f;
				vector.X -= 14f;
				vector.X -= 2f;
			}
			else
			{
				vector.X += 14f;
			}
			float num7 = num5;
			float num8 = num6;
			float num9 = (float)Math.Sqrt(num7 * num7 + num8 * num8);
			num9 = num4 / num9;
			num7 *= num9;
			num8 *= num9;
			int num10 = Projectile.NewProjectile(GetProjectileSource_TileInteraction(num, num3), vector.X, vector.Y, num7, num8, type, damage, knockBack, Main.myPlayer, -Main.rand.Next(0, 16));
			Main.projectile[num10].originatedFromActivableTile = true;
		}
		if (flag)
		{
			Tile tile = Main.tile[myX, myY];
			if (Main.tile[myX, myY].type == 132 || Main.tile[myX, myY].type == 136 || Main.tile[myX, myY].type == 144)
			{
				flag2 = true;
				Wiring.HitSwitch(myX, myY);
				NetMessage.SendData(59, -1, -1, null, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 597)
			{
				flag2 = true;
				TryOpeningFullscreenMap();
				int num11 = myX;
				int num12 = myY;
				Tile tileSafely = Framing.GetTileSafely(myX, myY);
				num11 -= tileSafely.frameX / 18 % 3;
				num12 -= tileSafely.frameY / 18 % 4;
				Main.MapPylonTile = new Point16(num11, num12);
				Rectangle rect = new Rectangle(Main.MapPylonTile.X, Main.MapPylonTile.Y, 0, 0);
				List<TeleportPylonInfo> pylons = Main.PylonSystem.Pylons;
				for (int i = 0; i < pylons.Count; i++)
				{
					TeleportPylonInfo info = pylons[i];
					if (TeleportPylonsMapLayer.IsRevealed(info))
					{
						rect = rect.Including(info.PositionInTiles);
					}
				}
				rect.Inflate(20, 20);
				Main.PanTargetMapFullscreen = false;
				Main.resetMapFull = false;
				Main.mapFullscreenPos.X = rect.Center.X;
				Main.mapFullscreenPos.Y = rect.Center.Y;
				float num13 = (float)(Main.screenWidth - 40) / (float)rect.Width;
				float num14 = (float)(Main.screenHeight - 40) / (float)rect.Height;
				if (Main.mapFullscreenScale > num13)
				{
					Main.mapFullscreenScale = num13;
				}
				if (Main.mapFullscreenScale > num14)
				{
					Main.mapFullscreenScale = num14;
				}
			}
			else if (Main.tile[myX, myY].type == 441 || Main.tile[myX, myY].type == 468)
			{
				flag2 = true;
				int num15;
				for (num15 = Main.tile[myX, myY].frameX / 18; num15 > 1; num15 -= 2)
				{
				}
				num15 = myX - num15;
				int num16 = myY - Main.tile[myX, myY].frameY / 18;
				Animation.NewTemporaryAnimation(2, Main.tile[myX, myY].type, num15, num16);
				NetMessage.SendTemporaryAnimation(-1, 2, Main.tile[myX, myY].type, num15, num16);
				Wiring.HitSwitch(myX, myY);
				NetMessage.SendData(59, -1, -1, null, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 139)
			{
				flag2 = true;
				SoundEngine.PlaySound(28, myX * 16, myY * 16, 0);
				WorldGen.SwitchMB(myX, myY);
			}
			else if (TileID.Sets.Campfires[tile.type])
			{
				flag2 = true;
				SoundEngine.PlaySound(28, myX * 16, myY * 16, 0);
				int num17 = 3;
				int num18 = 2;
				int num19 = tile.frameX % (num17 * 18) / 18;
				int num20 = tile.frameY % (num18 * 18) / 18;
				int num21 = myX - num19;
				int num22 = myY - num20;
				if (WorldGen.ValidateTileSquareIsActiveAndOfType(num21, num22, num17, num18, tile.type))
				{
					short num23 = 36;
					if (Main.tile[num21, num22].frameY >= 36)
					{
						num23 = -36;
					}
					for (int j = num21; j < num21 + 3; j++)
					{
						for (int k = num22; k < num22 + 2; k++)
						{
							Tile tile2 = Main.tile[j, k];
							if (tile2.active() && tile2.type == tile.type)
							{
								tile2.frameY += num23;
							}
						}
					}
					NetMessage.SendTileSquare(-1, num21, num22, num17, num18);
				}
			}
			else if (Main.tile[myX, myY].type == 207)
			{
				flag2 = true;
				SoundEngine.PlaySound(28, myX * 16, myY * 16, 0);
				WorldGen.SwitchFountain(myX, myY);
			}
			else if (Main.tile[myX, myY].type == 410 || Main.tile[myX, myY].type == 480 || Main.tile[myX, myY].type == 509 || Main.tile[myX, myY].type == 657 || Main.tile[myX, myY].type == 658 || Main.tile[myX, myY].type == 720 || Main.tile[myX, myY].type == 721 || Main.tile[myX, myY].type == 725 || Main.tile[myX, myY].type == 733)
			{
				flag2 = true;
				SoundEngine.PlaySound(28, myX * 16, myY * 16, 0);
				GamepadEnableGrappleCooldown();
				WorldGen.SwitchMonolith(myX, myY);
			}
			else if (Main.tile[myX, myY].type == 455)
			{
				flag2 = true;
				SoundEngine.PlaySound(28, myX * 16, myY * 16, 0);
				GamepadEnableGrappleCooldown();
				BirthdayParty.ToggleManualParty();
			}
			else if (Main.tile[myX, myY].type == 216)
			{
				flag2 = true;
				WorldGen.LaunchRocket(myX, myY, fromWiring: false);
			}
			else if (Main.tile[myX, myY].type == 386 || Main.tile[myX, myY].type == 387)
			{
				flag2 = true;
				bool flag3 = Main.tile[myX, myY].type == 387;
				int num24 = WorldGen.ShiftTrapdoor(myX, myY, (float)(myY * 16) > base.Center.Y).ToInt();
				if (num24 == 0)
				{
					num24 = -WorldGen.ShiftTrapdoor(myX, myY, (float)(myY * 16) <= base.Center.Y).ToInt();
				}
				if (num24 != 0)
				{
					NetMessage.SendData(19, -1, -1, null, 2 + (!flag3).ToInt(), myX, myY, num24 * Math.Sign((float)(myY * 16) - base.Center.Y));
				}
			}
			else if (Main.tile[myX, myY].type == 388 || Main.tile[myX, myY].type == 389)
			{
				flag2 = true;
				bool flag4 = Main.tile[myX, myY].type == 389;
				if (WorldGen.ShiftTallGate(myX, myY, flag4))
				{
					NetMessage.SendData(19, -1, -1, null, 4 + flag4.ToInt(), myX, myY);
				}
			}
			else if (Main.tile[myX, myY].type == 15 || Main.tile[myX, myY].type == 497)
			{
				if (IsWithinSnappngRangeToTile(myX, myY, 40))
				{
					flag2 = true;
					GamepadEnableGrappleCooldown();
					sitting.SitDown(this, myX, myY);
				}
			}
			else if (Main.tile[myX, myY].type == 89 || Main.tile[myX, myY].type == 102 || Main.tile[myX, myY].type == 487)
			{
				if (IsWithinSnappngRangeToTile(myX, myY, 40))
				{
					flag2 = true;
					GamepadEnableGrappleCooldown();
					sitting.SitDown(this, myX, myY);
				}
			}
			else if (Main.tile[myX, myY].type == 335)
			{
				flag2 = true;
				WorldGen.LaunchRocketSmall(myX, myY, fromWiring: false);
			}
			else if (Main.tile[myX, myY].type == 411 && Main.tile[myX, myY].frameX < 36)
			{
				flag2 = true;
				Wiring.HitSwitch(myX, myY);
				NetMessage.SendData(59, -1, -1, null, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 494)
			{
				flag2 = true;
				for (int l = 0; l < 1000; l++)
				{
					if (ProjectileID.Sets.IsAGolfBall[Main.projectile[l].type] && Main.projectile[l].owner == whoAmI)
					{
						Main.projectile[l].Kill();
					}
				}
				GetPreferredGolfBallToUse(out var projType);
				Projectile.NewProjectile(GetProjectileSource_TileInteraction(myX, myY), (float)(myX * 16) + 8.5f, myY * 16 + 6, 0f, 0f, projType, 0, 0f, whoAmI, 0f, -1f);
			}
			else if (Main.tile[myX, myY].type == 338)
			{
				flag2 = true;
				int num25 = myY;
				if (Main.tile[myX, num25].frameY == 18)
				{
					num25--;
				}
				bool flag5 = false;
				for (int m = 0; m < 1000; m++)
				{
					if (Main.projectile[m].active && Main.projectile[m].aiStyle == 73 && Main.projectile[m].ai[0] == (float)myX && Main.projectile[m].ai[1] == (float)num25)
					{
						flag5 = true;
						break;
					}
				}
				if (!flag5)
				{
					int num26 = Projectile.NewProjectile(GetProjectileSource_TileInteraction(myX, num25), myX * 16 + 8, num25 * 16 + 2, 0f, 0f, 419 + Main.rand.Next(4), 0, 0f, whoAmI, myX, num25);
					Main.projectile[num26].originatedFromActivableTile = true;
				}
			}
			else if (Main.tile[myX, myY].type == 33 || Main.tile[myX, myY].type == 49 || Main.tile[myX, myY].type == 372 || Main.tile[myX, myY].type == 174 || Main.tile[myX, myY].type == 646)
			{
				short num27 = 18;
				Tile tile3 = Main.tile[myX, myY];
				if (tile3.frameX > 0)
				{
					num27 = -18;
				}
				tile3.frameX += num27;
				NetMessage.SendTileSquare(-1, myX, myY);
				flag2 = true;
				GamepadEnableGrappleCooldown();
			}
			else if (TileID.Sets.Torches[Main.tile[myX, myY].type] || (Main.tile[myX, myY].type == 50 && Main.tile[myX, myY].frameX == 90))
			{
				WorldGen.KillTile(myX, myY);
				if (Main.netMode == 1)
				{
					NetMessage.SendData(17, -1, -1, null, 0, myX, myY);
				}
				flag2 = true;
				GamepadEnableGrappleCooldown();
			}
			else if (Main.tile[myX, myY].type == 466)
			{
				flag2 = true;
				GamepadEnableGrappleCooldown();
				int num28 = myY;
				Tile tileSafely2 = Framing.GetTileSafely(myX, myY);
				if (tileSafely2.frameY == 0)
				{
					num28 += 3;
				}
				if (tileSafely2.frameY == 18)
				{
					num28 += 2;
				}
				if (tileSafely2.frameY == 36)
				{
					num28++;
				}
				if (DD2Event.Ongoing)
				{
					DD2Event.RequestToSkipWaitTime(myX, myY);
				}
				else
				{
					bool flag6 = !DD2Event.Ongoing && !NPC.AnyNPCs(548) && !Main.pumpkinMoon && !Main.snowMoon;
					if (flag6)
					{
						flag6 = HasItemInInventoryOrOpenVoidBag(3828);
					}
					if (flag6)
					{
						flag6 = !DD2Event.WouldFailSpawningHere(myX, num28);
						if (!flag6)
						{
							DD2Event.FailureMessage(-1);
						}
					}
					if (flag6)
					{
						flag6 = ConsumeItem(3828, reverseOrder: true, includeVoidBag: true);
					}
					if (flag6)
					{
						DD2Event.SummonCrystal(myX, num28, whoAmI);
					}
				}
			}
			else if (Main.tile[myX, myY].type == 334 && !UsingOrReusingItem)
			{
				flag2 = true;
				if (ItemFitsWeaponRack(inventory[selectedItem]))
				{
					GamepadEnableGrappleCooldown();
					PlaceWeapon(myX, myY);
				}
				else
				{
					int num29 = myX;
					int num30 = myY;
					if (Main.tile[myX, myY].frameY == 0)
					{
						num30++;
					}
					if (Main.tile[myX, myY].frameY == 36)
					{
						num30--;
					}
					int frameX = Main.tile[myX, num30].frameX;
					int num31 = Main.tile[myX, num30].frameX;
					int num32 = 0;
					while (num31 >= 5000)
					{
						num31 -= 5000;
						num32++;
					}
					if (num32 != 0)
					{
						num31 = (num32 - 1) * 18;
					}
					num31 %= 54;
					if (num31 == 18)
					{
						frameX = Main.tile[myX - 1, num30].frameX;
						num29--;
					}
					if (num31 == 36)
					{
						frameX = Main.tile[myX - 2, num30].frameX;
						num29 -= 2;
					}
					if (frameX >= 5000)
					{
						GamepadEnableGrappleCooldown();
						WorldGen.KillTile(myX, num30, fail: true);
						if (Main.netMode == 1)
						{
							NetMessage.SendData(17, -1, -1, null, 0, myX, num30, 1f);
						}
					}
				}
			}
			else if (Main.tile[myX, myY].type == 440)
			{
				flag2 = true;
				int num33 = Main.tile[myX, myY].frameX / 54;
				int num34 = Main.tile[myX, myY].frameY / 54;
				_ = Main.tile[myX, myY].frameX % 54 / 18;
				_ = Main.tile[myX, myY].frameY % 54 / 18;
				int num35 = -1;
				switch (num33)
				{
				case 0:
					num35 = 1526;
					break;
				case 1:
					num35 = 1524;
					break;
				case 2:
					num35 = 1525;
					break;
				case 3:
					num35 = 1523;
					break;
				case 4:
					num35 = 1522;
					break;
				case 5:
					num35 = 1527;
					break;
				case 6:
					num35 = 3643;
					break;
				}
				if (num35 != -1)
				{
					if (num34 == 0 && HasItem(num35) && selectedItem != 58)
					{
						GamepadEnableGrappleCooldown();
						if (Main.netMode != 1)
						{
							ConsumeItem(num35);
							WorldGen.ToggleGemLock(myX, myY, on: true);
						}
						else
						{
							ConsumeItem(num35);
							NetMessage.SendData(105, -1, -1, null, myX, myY, 1f);
						}
					}
					else if (num34 == 1)
					{
						GamepadEnableGrappleCooldown();
						if (Main.netMode != 1)
						{
							WorldGen.ToggleGemLock(myX, myY, on: false);
						}
						else
						{
							NetMessage.SendData(105, -1, -1, null, myX, myY);
						}
					}
				}
			}
			else if (Main.tile[myX, myY].type == 395 && !UsingOrReusingItem)
			{
				flag2 = true;
				TEItemFrame.OnPlayerInteraction(this, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 698 && !UsingOrReusingItem)
			{
				flag2 = true;
				TEDeadCellsDisplayJar.OnPlayerInteraction(this, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 520)
			{
				flag2 = true;
				TEFoodPlatter.OnPlayerInteraction(this, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 471)
			{
				flag2 = true;
				TEWeaponsRack.OnPlayerInteraction(this, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 470)
			{
				flag2 = true;
				TEDisplayDoll.OnPlayerInteraction(this, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 475)
			{
				flag2 = true;
				TEHatRack.OnPlayerInteraction(this, myX, myY);
			}
			else if (Main.tile[myX, myY].type == 125)
			{
				flag2 = true;
				AddBuff(29, 108000);
				SoundEngine.PlaySound(SoundID.Item4, position);
			}
			else if (Main.tile[myX, myY].type == 621)
			{
				flag2 = true;
				AddBuff(192, 7200);
				SoundEngine.PlaySound(SoundID.Item2, position);
			}
			else if (Main.tile[myX, myY].type == 464)
			{
				flag2 = true;
				AddBuff(348, 108000);
				SoundEngine.PlaySound(SoundID.Item4, position);
			}
			else if (Main.tile[myX, myY].type == 699)
			{
				flag2 = true;
				AddBuff(366, 108000);
				SoundEngine.PlaySound(SoundID.Item179, position);
			}
			else if (Main.tile[myX, myY].type == 377)
			{
				flag2 = true;
				AddBuff(159, 108000);
				SoundEngine.PlaySound(SoundID.Item37, position);
			}
			else if (Main.tile[myX, myY].type == 354)
			{
				flag2 = true;
				AddBuff(150, 108000);
				SoundEngine.PlaySound(SoundID.Item4, position);
			}
			else if (Main.tile[myX, myY].type == 287)
			{
				flag2 = true;
				AddBuff(93, 108000);
				SoundEngine.PlaySound(SoundID.Item149, position);
			}
			else if (Main.tile[myX, myY].type == 356)
			{
				flag2 = true;
				if (!Main.fastForwardTimeToDawn && (Main.netMode == 1 || Main.sundialCooldown == 0))
				{
					Main.Sundialing();
					SoundEngine.PlaySound(SoundID.Item4, position);
				}
			}
			else if (Main.tile[myX, myY].type == 663)
			{
				flag2 = true;
				if (!Main.fastForwardTimeToDusk && (Main.netMode == 1 || Main.moondialCooldown == 0))
				{
					Main.Moondialing();
					SoundEngine.PlaySound(SoundID.Item4, position);
				}
			}
			else if (Main.tile[myX, myY].type == 79)
			{
				flag2 = true;
				int num36 = myX;
				int num37 = myY;
				num36 += Main.tile[myX, myY].frameX / 18 * -1;
				if (Main.tile[myX, myY].frameX >= 72)
				{
					num36 += 4;
					num36++;
				}
				else
				{
					num36 += 2;
				}
				int num38 = Main.tile[myX, myY].frameY / 18;
				int num39 = 0;
				while (num38 > 1)
				{
					num38 -= 2;
					num39++;
				}
				num37 -= num38;
				num37 += 2;
				if (!IsHoveringOverABottomSideOfABed(myX, myY))
				{
					if (IsWithinSnappngRangeToTile(myX, myY, 96))
					{
						flag2 = true;
						GamepadEnableGrappleCooldown();
						sleeping.StartSleeping(this, myX, myY);
					}
				}
				else
				{
					FindSpawn();
					if (SpawnX == num36 && SpawnY == num37)
					{
						RemoveSpawn();
						Main.NewText(Language.GetTextValue("Game.SpawnPointRemoved"), byte.MaxValue, 240, 20);
					}
					else if (CheckSpawn(num36, num37))
					{
						ChangeSpawn(num36, num37);
						Main.NewText(Language.GetTextValue("Game.SpawnPointSet"), byte.MaxValue, 240, 20);
					}
				}
			}
			else if (Main.tileSign[Main.tile[myX, myY].type])
			{
				flag2 = true;
				bool flag7 = true;
				if (sign >= 0 && Sign.ReadSign(myX, myY, CreateIfMissing: false) == sign)
				{
					CloseSign();
					flag7 = false;
				}
				if (flag7)
				{
					if (Main.netMode == 0)
					{
						OpenSign(Sign.ReadSign(myX, myY));
					}
					else
					{
						int num40 = Main.tile[myX, myY].frameX / 18;
						int num41 = Main.tile[myX, myY].frameY / 18;
						while (num40 > 1)
						{
							num40 -= 2;
						}
						int num42 = myX - num40;
						int num43 = myY - num41;
						if (Main.tileSign[Main.tile[num42, num43].type])
						{
							NetMessage.SendData(46, -1, -1, null, num42, num43);
						}
					}
				}
			}
			else if (Main.tile[myX, myY].type == 104)
			{
				flag2 = true;
				string textValue = Language.GetTextValue("GameUI.TimeAtMorning");
				double num44 = Main.time;
				if (!Main.dayTime)
				{
					num44 += 54000.0;
				}
				num44 = num44 / 86400.0 * 24.0;
				double num45 = 7.5;
				num44 = num44 - num45 - 12.0;
				if (num44 < 0.0)
				{
					num44 += 24.0;
				}
				if (num44 >= 12.0)
				{
					textValue = Language.GetTextValue("GameUI.TimePastMorning");
				}
				int num46 = (int)num44;
				double num47 = (int)((num44 - (double)num46) * 60.0);
				string text = string.Concat(num47);
				if (num47 < 10.0)
				{
					text = "0" + text;
				}
				if (num46 > 12)
				{
					num46 -= 12;
				}
				if (num46 == 0)
				{
					num46 = 12;
				}
				Main.NewText(Language.GetTextValue("Game.Time", num46 + ":" + text + " " + textValue), byte.MaxValue, 240, 20);
			}
			else if (Main.tile[myX, myY].type == 237)
			{
				flag2 = true;
				bool flag8 = false;
				if (!NPC.AnyNPCs(245) && Main.hardMode && NPC.downedPlantBoss)
				{
					for (int n = 0; n < 58; n++)
					{
						if (inventory[n].type == 1293)
						{
							inventory[n].stack--;
							if (inventory[n].stack <= 0)
							{
								inventory[n].SetDefaults(0);
							}
							flag8 = true;
							break;
						}
					}
				}
				if (flag8)
				{
					SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
					if (Main.netMode != 1)
					{
						NPC.SpawnOnPlayer(whoAmI, 245);
					}
					else
					{
						NetMessage.SendData(61, -1, -1, null, whoAmI, 245f);
					}
				}
			}
			else if (Main.tile[myX, myY].type == 10)
			{
				flag2 = true;
				if (WorldGen.IsLockedDoor(myX, myY))
				{
					int num48 = 1141;
					bool flag9 = false;
					for (int num49 = 0; num49 < 58; num49++)
					{
						if (inventory[num49].type == num48 && inventory[num49].stack > 0)
						{
							flag9 = true;
							inventory[num49].stack--;
							if (inventory[num49].stack <= 0)
							{
								inventory[num49] = new Item();
							}
							WorldGen.UnlockDoor(myX, myY);
							if (Main.netMode == 1)
							{
								NetMessage.SendData(52, -1, -1, null, whoAmI, 2f, myX, myY);
							}
							break;
						}
					}
					if (!flag9 && useVoidBag())
					{
						for (int num50 = 0; num50 < bank4.maxItems; num50++)
						{
							if (bank4.item[num50].type == num48 && bank4.item[num50].stack > 0)
							{
								bank4.item[num50].stack--;
								if (bank4.item[num50].stack <= 0)
								{
									bank4.item[num50] = new Item();
								}
								WorldGen.UnlockDoor(myX, myY);
								if (Main.netMode == 1)
								{
									NetMessage.SendData(52, -1, -1, null, whoAmI, 2f, myX, myY);
								}
								break;
							}
						}
					}
				}
				else
				{
					WorldGen.OpenDoor(myX, myY, direction);
					if (Main.tile[myX, myY].type != 10)
					{
						NetMessage.SendData(19, -1, -1, null, 0, myX, myY, direction);
					}
					else
					{
						WorldGen.OpenDoor(myX, myY, -direction);
						if (Main.tile[myX, myY].type != 10)
						{
							NetMessage.SendData(19, -1, -1, null, 0, myX, myY, -direction);
						}
					}
				}
			}
			else if (Main.tile[myX, myY].type == 11)
			{
				flag2 = true;
				if (WorldGen.CloseDoor(myX, myY))
				{
					NetMessage.SendData(19, -1, -1, null, 1, myX, myY, direction);
				}
			}
			else if (Main.tile[myX, myY].type == 88)
			{
				flag2 = true;
				int num51 = Main.tile[myX, myY].frameX / 18;
				num51 %= 3;
				num51 = myX - num51;
				int num52 = myY - Main.tile[myX, myY].frameY / 18;
				if (Main.tile[myX, myY].frameY == 0)
				{
					Main.CancelClothesWindow(quiet: true);
					Main.mouseRightRelease = false;
					CloseSign();
					SetTalkNPC(-1);
					Main.npcChatCornerItem = 0;
					Main.npcChatText = "";
					if (Main.editChest)
					{
						SoundEngine.PlaySound(12);
						Main.editChest = false;
						Main.npcChatText = string.Empty;
					}
					if (editedChestName)
					{
						NetMessage.SendData(33, -1, -1, NetworkText.FromLiteral(Main.chest[chest].name), chest, 1f);
						editedChestName = false;
					}
					if (Main.netMode == 1)
					{
						if (num51 == chestX && num52 == chestY && chest != -1)
						{
							chest = -1;
							SoundEngine.PlaySound(11);
						}
						else
						{
							NetMessage.SendData(31, -1, -1, null, num51, num52);
							Main.stackSplit = 600;
						}
					}
					else
					{
						piggyBankProjTracker.Clear();
						voidLensChest.Clear();
						int num53 = Chest.FindChest(num51, num52);
						if (num53 != -1)
						{
							Main.stackSplit = 600;
							if (num53 == chest)
							{
								chest = -1;
								SoundEngine.PlaySound(11);
							}
							else if (num53 != chest && chest == -1)
							{
								OpenChest(num51, num52, num53);
								SoundEngine.PlaySound(10);
							}
							else
							{
								OpenChest(num51, num52, num53);
								SoundEngine.PlaySound(12);
							}
						}
					}
				}
				else
				{
					Main.playerInventory = false;
					chest = -1;
					SetTalkNPC(-1);
					Main.npcChatCornerItem = 0;
					Main.npcChatText = "";
					Main.interactedDresserTopLeftX = num51;
					Main.interactedDresserTopLeftY = num52;
					Main.OpenClothesWindow();
				}
			}
			else if (Main.tile[myX, myY].type == 209)
			{
				flag2 = true;
				Tile tile4 = Main.tile[myX, myY];
				int num54 = tile4.frameX % 72 / 18;
				int num55 = tile4.frameY % 54 / 18;
				int num56 = myX - num54;
				int num57 = myY - num55;
				int num58 = tile4.frameY / 54;
				int num59 = tile4.frameX / 72;
				int num60 = -1;
				if (num54 == 1 || num54 == 2)
				{
					num60 = num55;
				}
				int num61 = 0;
				if (num54 == 3 || (num54 == 2 && num59 != 3 && num59 != 4))
				{
					num61 = -54;
				}
				if (num54 == 0 || (num54 == 1 && num59 != 3 && num59 != 4))
				{
					num61 = 54;
				}
				if (num58 >= 8 && num61 > 0)
				{
					num61 = 0;
				}
				if (num58 == 0 && num61 < 0)
				{
					num61 = 0;
				}
				bool flag10 = false;
				if (num61 != 0)
				{
					for (int num62 = num56; num62 < num56 + 4; num62++)
					{
						for (int num63 = num57; num63 < num57 + 3; num63++)
						{
							Main.tile[num62, num63].frameY = (short)(Main.tile[num62, num63].frameY + num61);
						}
					}
					flag10 = true;
				}
				if ((num59 == 3 || num59 == 4) && (num60 == 1 || num60 == 0))
				{
					num61 = ((num59 == 3) ? 72 : (-72));
					for (int num64 = num56; num64 < num56 + 4; num64++)
					{
						for (int num65 = num57; num65 < num57 + 3; num65++)
						{
							Main.tile[num64, num65].frameX = (short)(Main.tile[num64, num65].frameX + num61);
						}
					}
					flag10 = true;
				}
				if (flag10)
				{
					NetMessage.SendTileSquare(-1, num56, num57, 4, 3);
				}
				if (num60 != -1)
				{
					bool flag11 = false;
					if ((num59 == 3 || num59 == 4) && num60 == 2)
					{
						flag11 = true;
					}
					if (flag11)
					{
						WorldGen.ShootFromCannon(num56, num57, num58, num59 + 1, 0, 0f, whoAmI, fromWire: false);
					}
				}
			}
			else if (Main.tile[myX, myY].type == 510 || Main.tile[myX, myY].type == 511)
			{
				flag2 = true;
				Tile tile5 = Main.tile[myX, myY];
				int num66 = tile5.frameX % 36 / 18;
				int num67 = tile5.frameY % 36 / 18;
				int num68 = myX - num66;
				int num69 = myY - num67;
				int num70 = tile5.frameY / 36;
				_ = tile5.frameX / 36;
				int num71 = 0;
				if (num66 == 0)
				{
					num71 = -36;
				}
				if (num66 == 1)
				{
					num71 = 36;
				}
				if (num70 >= 7 && num71 > 0)
				{
					num71 = -252;
				}
				if (num70 == 0 && num71 < 0)
				{
					num71 = 252;
				}
				bool flag12 = false;
				if (num71 != 0)
				{
					for (int num72 = num68; num72 < num68 + 2; num72++)
					{
						for (int num73 = num69; num73 < num69 + 2; num73++)
						{
							Main.tile[num72, num73].frameY = (short)(Main.tile[num72, num73].frameY + num71);
						}
					}
					flag12 = true;
				}
				if (flag12)
				{
					NetMessage.SendTileSquare(-1, num68, num69, 2, 2);
				}
			}
			else if (TileID.Sets.BasicChest[Main.tile[myX, myY].type] || Main.tile[myX, myY].type == 29 || Main.tile[myX, myY].type == 97 || Main.tile[myX, myY].type == 463 || Main.tile[myX, myY].type == 491)
			{
				flag2 = true;
				Main.mouseRightRelease = false;
				int num74 = 0;
				int num75;
				for (num75 = Main.tile[myX, myY].frameX / 18; num75 > 1; num75 -= 2)
				{
				}
				num75 = myX - num75;
				int num76 = myY - Main.tile[myX, myY].frameY / 18;
				if (Main.tile[myX, myY].type == 29)
				{
					num74 = 1;
				}
				else if (Main.tile[myX, myY].type == 97)
				{
					num74 = 2;
				}
				else if (Main.tile[myX, myY].type == 463)
				{
					num74 = 3;
					num75 = ((Main.tile[myX, myY].frameX != 36) ? (num75 + 1) : (num75 - 1));
					num76 += 2;
				}
				else if (Main.tile[myX, myY].type == 491)
				{
					num74 = 4;
					num75 = ((Main.tile[myX, myY].frameX != 36) ? (num75 + 1) : (num75 - 1));
					num76 += 2;
				}
				CloseSign();
				SetTalkNPC(-1);
				Main.npcChatCornerItem = 0;
				Main.npcChatText = "";
				if (Main.editChest)
				{
					SoundEngine.PlaySound(12);
					Main.editChest = false;
					Main.npcChatText = string.Empty;
				}
				if (editedChestName)
				{
					NetMessage.SendData(33, -1, -1, NetworkText.FromLiteral(Main.chest[chest].name), chest, 1f);
					editedChestName = false;
				}
				bool flag13 = Chest.IsLocked(Main.tile[num75, num76]);
				if (Main.netMode == 1 && num74 == 0 && !flag13)
				{
					if (num75 == chestX && num76 == chestY && chest != -1)
					{
						chest = -1;
						SoundEngine.PlaySound(11);
					}
					else
					{
						if (WorldGen.IsChestRigged(num75, num76))
						{
							_framesLeftEligibleForDeadmansChestDeathAchievement = 600;
						}
						NetMessage.SendData(31, -1, -1, null, num75, num76);
						Main.stackSplit = 600;
					}
				}
				else
				{
					int num77 = -1;
					switch (num74)
					{
					case 1:
						num77 = -2;
						break;
					case 2:
						num77 = -3;
						break;
					case 3:
						num77 = -4;
						break;
					case 4:
						if (disableVoidBag < 0)
						{
							num77 = -5;
						}
						break;
					default:
					{
						bool flag14 = false;
						if (Chest.IsLocked(num75, num76))
						{
							int type2 = Main.tile[num75, num76].type;
							int num78 = 327;
							switch (type2)
							{
							case 21:
								if (Main.tile[num75, num76].frameX >= 144 && Main.tile[num75, num76].frameX <= 178)
								{
									num78 = 329;
								}
								if (Main.tile[num75, num76].frameX >= 828 && Main.tile[num75, num76].frameX <= 1006)
								{
									int num80 = Main.tile[num75, num76].frameX / 18;
									int num81 = 0;
									while (num80 >= 2)
									{
										num80 -= 2;
										num81++;
									}
									num81 -= 23;
									num78 = 1533 + num81;
								}
								break;
							case 467:
							{
								int num79 = Main.tile[num75, num76].frameX / 36;
								if (num79 == 13)
								{
									num78 = 4714;
								}
								break;
							}
							}
							flag14 = true;
							bool flag15 = false;
							bool flag16 = num78 != 329;
							for (int num82 = 0; num82 < 58; num82++)
							{
								if (inventory[num82].type != num78 || inventory[num82].stack <= 0 || !Chest.Unlock(num75, num76))
								{
									continue;
								}
								flag15 = true;
								if (flag16)
								{
									inventory[num82].stack--;
									if (inventory[num82].stack <= 0)
									{
										inventory[num82] = new Item();
									}
								}
								if (Main.netMode == 1)
								{
									NetMessage.SendData(52, -1, -1, null, whoAmI, 1f, num75, num76);
								}
							}
							if (!flag15 && useVoidBag())
							{
								for (int num83 = 0; num83 < bank4.maxItems; num83++)
								{
									if (bank4.item[num83].type != num78 || bank4.item[num83].stack <= 0 || !Chest.Unlock(num75, num76))
									{
										continue;
									}
									if (num78 != 329)
									{
										bank4.item[num83].stack--;
										if (bank4.item[num83].stack <= 0)
										{
											bank4.item[num83] = new Item();
										}
									}
									if (Main.netMode == 1)
									{
										NetMessage.SendData(52, -1, -1, null, whoAmI, 1f, num75, num76);
									}
								}
							}
						}
						if (!flag14)
						{
							num77 = Chest.FindChest(num75, num76);
						}
						break;
					}
					}
					if (num77 != -1)
					{
						Main.stackSplit = 600;
						bool num84 = WorldGen.IsChestRigged(num75, num76);
						if (num77 == chest)
						{
							chest = -1;
							SoundEngine.PlaySound(11);
						}
						else if (num77 != chest && chest == -1)
						{
							OpenChest(num75, num76, num77);
							SoundEngine.PlaySound(10);
							if (Main.tile[num75, num76].frameX >= 36 && Main.tile[num75, num76].frameX < 72)
							{
								AchievementsHelper.HandleSpecialEvent(this, 16);
							}
						}
						else
						{
							OpenChest(num75, num76, num77);
							SoundEngine.PlaySound(12);
						}
						if (num84)
						{
							Wiring.HitSwitch(myX, myY);
							NetMessage.SendData(59, -1, -1, null, myX, myY);
							_framesLeftEligibleForDeadmansChestDeathAchievement = 600;
						}
					}
				}
			}
			else if (Main.tile[myX, myY].type == 314 && gravDir == 1f)
			{
				flag2 = true;
				bool flag17 = true;
				if (mount.Active)
				{
					if (mount.Cart)
					{
						flag17 = false;
					}
					mount.TryDismount(this);
				}
				if (flag17)
				{
					LaunchMinecartHook(myX, myY);
				}
			}
			NewCraftingUI.RecipeFilter craftingFilterForTile = GetCraftingFilterForTile(myX, myY);
			if (craftingFilterForTile != null)
			{
				flag2 = true;
				AdjTiles();
				NewCraftingUI.OpenCloseFilter(craftingFilterForTile);
			}
		}
		if (flag2)
		{
			tileInteractionHappened = true;
		}
	}

	private static NewCraftingUI.RecipeFilter GetCraftingFilterForTile(int myX, int myY)
	{
		ushort type = Main.tile[myX, myY].type;
		if (TileID.Sets.DoesNotOpenCraftingMenuOnInteract[type])
		{
			return null;
		}
		if (Recipe.TileUsedInRecipes[type])
		{
			int baseOption = 0;
			MapHelper.GetTileBaseOption(myX, myY, type, Main.tile[myX, myY], ref baseOption);
			return new NewCraftingUI.CraftStationRecipeFilter(type, baseOption);
		}
		if (TileID.Sets.CountsAsWaterForCrafting[type])
		{
			int baseOption2 = 0;
			MapHelper.GetTileBaseOption(myX, myY, type, Main.tile[myX, myY], ref baseOption2);
			return new NewCraftingUI.WaterSourceRecipeFilter(type, baseOption2);
		}
		return null;
	}

	private static bool IsHoveringOverABottomSideOfABed(int myX, int myY)
	{
		short frameX = Main.tile[myX, myY].frameX;
		bool flag = frameX / 72 == 1;
		bool flag2 = frameX % 72 < 36;
		if (flag)
		{
			flag2 = !flag2;
		}
		return flag2;
	}

	public void PetMount(PlayerPettingInfo info)
	{
		if (petting.isPetting)
		{
			StopPettingAnimal();
			return;
		}
		petting = info;
		petting.isPetting = true;
		if (whoAmI == Main.myPlayer)
		{
			AchievementsHelper.HandleSpecialEvent(this, 21);
		}
		int type = info.type;
		if ((uint)(type - 62) <= 1u)
		{
			SoundEngine.PlaySound(SoundID.PalChilletJoy, base.Center);
		}
	}

	public void PetAnimal(PlayerPettingInfo info)
	{
		if (!info.TryGetTarget(out var target))
		{
			return;
		}
		Vector2 vector = base.Bottom;
		if (target != null)
		{
			vector = (target.Bottom + info.offsetFromPet).Floor();
			Vector2 offset = vector - base.Bottom;
			if (!CanSnapToPosition(offset) || !WorldGen.SolidTileAllowBottomSlope((int)vector.X / 16, (int)vector.Y / 16))
			{
				return;
			}
		}
		if (petting.isPetting && base.Bottom == vector)
		{
			StopPettingAnimal();
			return;
		}
		StopVanityActions();
		RemoveAllGrapplingHooks();
		if (!info.mount && mount.Active)
		{
			mount.TryDismount(this);
		}
		base.Bottom = vector;
		int num = Math.Sign(0f - info.offsetFromPet.X);
		if (num == 0)
		{
			num = direction;
		}
		ChangeDir(num);
		velocity = Vector2.Zero;
		gravDir = 1f;
		petting = info;
		petting.isPetting = true;
		if (whoAmI == Main.myPlayer)
		{
			AchievementsHelper.HandleSpecialEvent(this, 21);
		}
	}

	public bool CanSnapToPosition(Vector2 offset)
	{
		bool flag = !Collision.SolidCollision(position + offset, width, height);
		if (flag && mount.Active)
		{
			Mount.MountDelegatesData.OverrideSizeMethod playerSize = mount.Delegations.PlayerSize;
			if (playerSize != null && playerSize(this, out var size) && size.HasValue)
			{
				Vector2 value = size.Value;
				if (value.X < 20f || value.Y < 42f)
				{
					flag = CanFitInSpaceWithSize(DefaultSize, offset);
				}
			}
		}
		if (!flag)
		{
			return false;
		}
		bool canSnapToPosition = Collision.CanHit(position, width, height, position + offset, width, height);
		if (!canSnapToPosition)
		{
			TryAllowingSnappingToPosition(ref canSnapToPosition, position, position + offset);
			if (!canSnapToPosition)
			{
				int num = Math.Sign(offset.X);
				if (num != 0)
				{
					Vector2 vector = new Vector2(num * width, 0f);
					if (TileCollision(position, vector, fallThrough: true, ignorePlats: true) == vector)
					{
						TryAllowingSnappingToPosition(ref canSnapToPosition, position + vector, position + offset);
					}
				}
			}
		}
		return canSnapToPosition;
	}

	private void TryAllowingSnappingToPosition(ref bool canSnapToPosition, Vector2 pos1, Vector2 pos2)
	{
		Vector2 vector = new Vector2(width - 2, 0f);
		canSnapToPosition = Collision.CanHit(pos1 + vector, 2, height, pos2, 2, height);
		if (!canSnapToPosition)
		{
			canSnapToPosition = Collision.CanHit(pos1 + vector, 2, height, pos2 + vector, 2, height);
		}
		if (!canSnapToPosition)
		{
			canSnapToPosition = Collision.CanHit(pos1, 2, height, pos2, 2, height);
		}
		if (!canSnapToPosition)
		{
			canSnapToPosition = Collision.CanHit(pos1, 2, height, pos2 + vector, 2, height);
		}
	}

	public void StopVanityActions(bool multiplayerBroadcast = true)
	{
		StopPettingAnimal();
		sitting.SitUp(this, multiplayerBroadcast);
		sleeping.StopSleeping(this, multiplayerBroadcast);
	}

	public void StopPettingAnimal()
	{
		petting.isPetting = false;
	}

	private void UpdatePettingAnimal()
	{
		if (!petting.isPetting)
		{
			return;
		}
		if (!petting.TryGetTarget(out var target) || (target is NPC && talkNPC != petting.npc) || (target != null && base.Bottom.Distance(target.Bottom + petting.offsetFromPet) > 2f))
		{
			StopPettingAnimal();
			return;
		}
		int num = Math.Sign(0f - petting.offsetFromPet.X);
		if (petting.mount)
		{
			num = direction;
		}
		if (controlLeft || controlRight || controlUp || controlDown || controlJump || pulley || (mount.Active && !petting.mount) || num != direction)
		{
			StopPettingAnimal();
		}
	}

	public Chest GetCurrentContainer()
	{
		return chest switch
		{
			-1 => null, 
			-2 => bank, 
			-3 => bank2, 
			-4 => bank3, 
			-5 => bank4, 
			_ => Main.chest[chest], 
		};
	}

	private void OpenChest(int x, int y, int newChest)
	{
		chest = newChest;
		if (chest != -1 && Main.myPlayer == whoAmI)
		{
			Chest currentContainer = GetCurrentContainer();
			if (currentContainer != null)
			{
				ItemSlot.SetGlowForChest(currentContainer);
			}
		}
		NewCraftingUI.Close(quiet: true);
		Main.playerInventory = true;
		UILinkPointNavigator.ForceMovementCooldown(PlayerInput.CurrentProfile.InventoryMoveCD);
		if (PlayerInput.GrappleAndInteractAreShared)
		{
			PlayerInput.Triggers.JustPressed.Grapple = false;
		}
		Main.PipsUseGrid = false;
		chestX = x;
		chestY = y;
	}

	public void CloseSign(bool quiet = false)
	{
		if (sign > -1)
		{
			sign = -1;
			Main.editSign = false;
			Main.npcChatText = string.Empty;
			if (!quiet)
			{
				SoundEngine.PlaySound(11);
			}
		}
	}

	public void OpenSign(int s)
	{
		IngameUIWindows.CloseAll(quiet: true);
		if (s >= 0)
		{
			SoundEngine.PlaySound(10);
			sign = s;
			Main.npcChatText = Main.sign[s].text;
		}
	}

	private void LaunchMinecartHook(int myX, int myY)
	{
		Vector2 vector = new Vector2((float)Main.mouseX + Main.screenPosition.X, (float)Main.mouseY + Main.screenPosition.Y);
		vector = new Vector2(myX * 16 + 8, myY * 16 + 8);
		RemoveAllGrapplingHooks();
		Projectile.NewProjectile(GetProjectileSource_TileInteraction(myX, myY), vector.X, vector.Y, 0f, 0f, 403, 0, 0f, whoAmI);
		releaseHook = false;
	}

	public void RemoveAllGrapplingHooks()
	{
		ClearGrapplingBlacklist();
		grappling[0] = -1;
		grapCount = 0;
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].active && Main.projectile[i].owner == whoAmI && Main.projectile[i].aiStyle == 7)
			{
				Main.projectile[i].Kill();
			}
		}
	}

	public void RemoveAllFishingBobbers()
	{
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].active && Main.projectile[i].owner == whoAmI && Main.projectile[i].bobber)
			{
				Main.projectile[i].Kill();
			}
		}
	}

	private void TileInteractionsMouseOver(int myX, int myY)
	{
		if (myX != tileTargetX || myY != tileTargetY)
		{
			return;
		}
		if (Main.tile[myX, myY].type == 79)
		{
			if (!IsHoveringOverABottomSideOfABed(myX, myY))
			{
				if (IsWithinSnappngRangeToTile(myX, myY, 96))
				{
					noThrow = 2;
					cursorItemIconEnabled = true;
					cursorItemIconID = 5013;
				}
			}
			else
			{
				noThrow = 2;
				cursorItemIconEnabled = true;
				int style = Main.tile[myX, myY].frameY / 36;
				cursorItemIconID = WorldGen.GetItemDrop_Beds(style);
			}
		}
		if (Main.tile[myX, myY].type == 597)
		{
			int pylonStyleFromTile = TETeleportationPylon.GetPylonStyleFromTile(Main.tile[myX, myY]);
			int pylonItemTypeFromTileStyle = TETeleportationPylon.GetPylonItemTypeFromTileStyle(pylonStyleFromTile);
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = pylonItemTypeFromTileStyle;
			if (pylonStyleFromTile == 1)
			{
				cursorItemIconID = 4875;
			}
			if (pylonStyleFromTile == 2)
			{
				cursorItemIconID = 4916;
			}
			if (pylonStyleFromTile == 3)
			{
				cursorItemIconID = 4917;
			}
			if (pylonStyleFromTile == 4)
			{
				cursorItemIconID = 4918;
			}
			if (pylonStyleFromTile == 5)
			{
				cursorItemIconID = 4919;
			}
			if (pylonStyleFromTile == 6)
			{
				cursorItemIconID = 4920;
			}
			if (pylonStyleFromTile == 7)
			{
				cursorItemIconID = 4921;
			}
			if (pylonStyleFromTile == 8)
			{
				cursorItemIconID = 4951;
			}
			if (pylonStyleFromTile == 9)
			{
				cursorItemIconID = 5652;
			}
			if (pylonStyleFromTile == 10)
			{
				cursorItemIconID = 5653;
			}
		}
		if (Main.tile[myX, myY].type == 621)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3750;
		}
		if (Main.tile[myX, myY].type == 464)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3814;
		}
		if (Main.tile[myX, myY].type == 699)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5482;
		}
		if (Main.tile[myX, myY].type == 33)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int style2 = Main.tile[myX, myY].frameY / 22;
			cursorItemIconID = WorldGen.GetItemDrop_Candles(style2);
		}
		if (Main.tile[myX, myY].type == 21)
		{
			TileInteractionsMouseOver_Containers(myX, myY);
		}
		if (Main.tile[myX, myY].type == 467)
		{
			TileInteractionsMouseOver_Containers(myX, myY);
		}
		if (Main.tile[myX, myY].type == 441)
		{
			noThrow = 2;
			Tile tile = Main.tile[myX, myY];
			int num = myX;
			int num2 = myY;
			if (tile.frameX % 36 != 0)
			{
				num--;
			}
			if (tile.frameY % 36 != 0)
			{
				num2--;
			}
			int chestIcon = WorldGen.GetChestIcon(tile.frameX / 36, containers2: false);
			if (chestIcon != 0)
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = chestIcon;
			}
		}
		if (Main.tile[myX, myY].type == 468)
		{
			noThrow = 2;
			Tile tile2 = Main.tile[myX, myY];
			int num3 = myX;
			int num4 = myY;
			if (tile2.frameX % 36 != 0)
			{
				num3--;
			}
			if (tile2.frameY % 36 != 0)
			{
				num4--;
			}
			int chestIcon2 = WorldGen.GetChestIcon(tile2.frameX / 36, containers2: true);
			if (chestIcon2 != 0)
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = chestIcon2;
			}
		}
		if (Main.tile[myX, myY].type == 88)
		{
			Tile tile3 = Main.tile[myX, myY];
			int num5 = myY;
			int x = myX - tile3.frameX % 54 / 18;
			if (tile3.frameY % 36 != 0)
			{
				num5--;
			}
			int num6 = Chest.FindChest(x, num5);
			cursorItemIconID = -1;
			if (num6 < 0)
			{
				cursorItemIconText = Lang.dresserType[0].Value;
			}
			else
			{
				if (Main.chest[num6].name != "")
				{
					cursorItemIconText = Main.chest[num6].name;
				}
				else
				{
					cursorItemIconText = Lang.dresserType[tile3.frameX / 54].Value;
				}
				if (cursorItemIconText == Lang.dresserType[tile3.frameX / 54].Value)
				{
					cursorItemIconID = Chest.dresserTypeToIcon[tile3.frameX / 54];
					cursorItemIconText = "";
				}
			}
			noThrow = 2;
			cursorItemIconEnabled = true;
			if (Main.tile[myX, myY].frameY > 0)
			{
				cursorItemIconID = 269;
				cursorItemIconText = "";
			}
		}
		if (Main.tile[myX, myY].type == 10 || Main.tile[myX, myY].type == 11)
		{
			Tile tile4 = Main.tile[myX, myY];
			noThrow = 2;
			int num7 = tile4.frameY;
			int num8 = 0;
			while (num7 >= 54)
			{
				num7 -= 54;
				num8++;
			}
			if (tile4.type == 10)
			{
				num8 += 36 * (tile4.frameX / 54);
			}
			if (tile4.type == 11)
			{
				num8 += 36 * (tile4.frameX / 72);
			}
			int num9 = WorldGen.GetDoorItem(num8);
			if (num8 == 11)
			{
				num9 = 1141;
			}
			if (num9 != 0)
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = num9;
			}
		}
		if (Main.tile[myX, myY].type == 104)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int style3 = Main.tile[myX, myY].frameX / 36;
			cursorItemIconID = WorldGen.GetItemDrop_Clocks(style3);
		}
		if (Main.tile[myX, myY].type == 356)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3064;
		}
		if (Main.tile[myX, myY].type == 663)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5381;
		}
		if (Main.tile[myX, myY].type == 377)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3198;
		}
		if (Main.tile[myX, myY].type == 209)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			if (Main.tile[myX, myY].frameX < 72)
			{
				cursorItemIconID = 928;
			}
			else if (Main.tile[myX, myY].frameX < 144)
			{
				cursorItemIconID = 1337;
			}
			else if (Main.tile[myX, myY].frameX < 216)
			{
				cursorItemIconID = 3369;
			}
			else if (Main.tile[myX, myY].frameX < 360)
			{
				cursorItemIconID = 3664;
			}
			int num10;
			for (num10 = Main.tile[myX, myY].frameX / 18; num10 >= 4; num10 -= 4)
			{
			}
			if (num10 < 2)
			{
				cursorItemIconReversed = true;
			}
			else
			{
				cursorItemIconReversed = false;
			}
		}
		if (Main.tile[myX, myY].type == 216)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num11 = Main.tile[myX, myY].frameY;
			int num12 = 0;
			while (num11 >= 40)
			{
				num11 -= 40;
				num12++;
			}
			cursorItemIconID = 970 + num12;
		}
		if (Main.tile[myX, myY].type == 387 || Main.tile[myX, myY].type == 386)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int x2 = 0;
			int y = 0;
			WorldGen.GetTopLeftAndStyles(ref x2, ref y, 2, 1 + (Main.tile[myX, myY].type == 386).ToInt(), 18, 18);
			cursorItemIconID = 3239;
		}
		if (Main.tile[myX, myY].type == 389 || Main.tile[myX, myY].type == 388)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3240;
		}
		if (Main.tile[myX, myY].type == 335)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2700;
		}
		if (Main.tile[myX, myY].type == 15 && IsWithinSnappngRangeToTile(myX, myY, 40))
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = WorldGen.GetItemDrop_Chair(Main.tile[myX, myY].frameY / 40);
			if (Main.tile[myX, myY].frameX / 18 < 1)
			{
				cursorItemIconReversed = true;
			}
		}
		if (Main.tile[myX, myY].type == 102 && IsWithinSnappngRangeToTile(myX, myY, 40))
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 355;
		}
		if (Main.tile[myX, myY].type == 89 && IsWithinSnappngRangeToTile(myX, myY, 40))
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = WorldGen.GetItemDrop_Benches(Main.tile[myX, myY].frameX / 54);
		}
		if (Main.tile[myX, myY].type == 487 && IsWithinSnappngRangeToTile(myX, myY, 40))
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = WorldGen.GetItemDrop_PicnicTables(Main.tile[myX, myY].frameX / 72);
		}
		if (Main.tile[myX, myY].type == 497 && IsWithinSnappngRangeToTile(myX, myY, 40))
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = WorldGen.GetItemDrop_Toilet(Main.tile[myX, myY].frameY / 40);
			if (Main.tile[myX, myY].frameX / 18 < 1)
			{
				cursorItemIconReversed = true;
			}
		}
		if (Main.tile[myX, myY].type == 410)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3536 + Math.Min(Main.tile[myX, myY].frameX / 36, 3);
		}
		if (Main.tile[myX, myY].type == 480)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4054;
		}
		if (Main.tile[myX, myY].type == 509)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4318;
		}
		if (Main.tile[myX, myY].type == 657)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5345;
		}
		if (Main.tile[myX, myY].type == 658)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5347;
		}
		if (Main.tile[myX, myY].type == 720)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5598;
		}
		if (Main.tile[myX, myY].type == 721)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5599;
		}
		if (Main.tile[myX, myY].type == 725)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5655;
		}
		if (Main.tile[myX, myY].type == 733)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5113;
		}
		if (Main.tile[myX, myY].type == 463)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3813;
		}
		if (Main.tile[myX, myY].type == 491)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4076;
		}
		if (Main.tile[myX, myY].type == 494)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4089;
		}
		if (Main.tile[myX, myY].type == 411 && Main.tile[myX, myY].frameX < 36)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3545;
		}
		if (Main.tile[myX, myY].type == 338)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2738;
		}
		if (Main.tile[myX, myY].type == 455)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3747;
		}
		if ((Main.tile[myX, myY].type == 219 || Main.tile[myX, myY].type == 642) && ItemID.Sets.CanBeExtractinated[inventory[selectedItem].type])
		{
			extractinateHover = true;
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = inventory[selectedItem].type;
		}
		if (Main.tile[myX, myY].type == 212)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 949;
		}
		if (Main.tile[myX, myY].type == 314 && gravDir == 1f)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2343;
		}
		if (Main.tile[myX, myY].type == 215)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num13 = Main.tile[myX, myY].frameX / 54;
			switch (num13)
			{
			case 0:
				cursorItemIconID = 966;
				break;
			case 14:
				cursorItemIconID = 5299;
				break;
			case 15:
				cursorItemIconID = 5357;
				break;
			case 8:
			case 9:
			case 10:
			case 11:
			case 12:
			case 13:
				cursorItemIconID = 4689 + num13 - 8;
				break;
			default:
				switch (num13)
				{
				case 7:
					cursorItemIconID = 3724;
					break;
				case 6:
					cursorItemIconID = 3723;
					break;
				case 5:
					cursorItemIconID = 3050;
					break;
				default:
					cursorItemIconID = 3046 + num13 - 1;
					break;
				}
				break;
			}
		}
		if (Main.tile[myX, myY].type == 4)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num14 = Main.tile[myX, myY].frameY / 22;
			switch (num14)
			{
			case 0:
				cursorItemIconID = 8;
				break;
			case 8:
				cursorItemIconID = 523;
				break;
			case 9:
				cursorItemIconID = 974;
				break;
			case 10:
				cursorItemIconID = 1245;
				break;
			case 11:
				cursorItemIconID = 1333;
				break;
			case 12:
				cursorItemIconID = 2274;
				break;
			case 13:
				cursorItemIconID = 3004;
				break;
			case 14:
				cursorItemIconID = 3045;
				break;
			case 15:
				cursorItemIconID = 3114;
				break;
			case 16:
				cursorItemIconID = 4383;
				break;
			case 17:
				cursorItemIconID = 4384;
				break;
			case 18:
				cursorItemIconID = 4385;
				break;
			case 19:
				cursorItemIconID = 4386;
				break;
			case 20:
				cursorItemIconID = 4387;
				break;
			case 21:
				cursorItemIconID = 4388;
				break;
			case 22:
				cursorItemIconID = 5293;
				break;
			case 23:
				cursorItemIconID = 5353;
				break;
			default:
				cursorItemIconID = 426 + num14;
				break;
			}
		}
		if (Main.tile[myX, myY].type == 13)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int style4 = Main.tile[myX, myY].frameX / 18;
			cursorItemIconID = WorldGen.GetItemDrop_Bottles(style4);
		}
		if (Main.tile[myX, myY].type == 29)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 87;
		}
		if (Main.tile[myX, myY].type == 97)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 346;
		}
		if (Main.tile[myX, myY].type == 510)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4319;
			int num15;
			for (num15 = Main.tile[myX, myY].frameX / 18; num15 >= 2; num15 -= 2)
			{
			}
			if (num15 == 0)
			{
				cursorItemIconReversed = true;
			}
			else
			{
				cursorItemIconReversed = false;
			}
		}
		if (Main.tile[myX, myY].type == 511)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4320;
			int num16;
			for (num16 = Main.tile[myX, myY].frameX / 18; num16 >= 2; num16 -= 2)
			{
			}
			if (num16 == 0)
			{
				cursorItemIconReversed = true;
			}
			else
			{
				cursorItemIconReversed = false;
			}
		}
		if (Main.tile[myX, myY].type == 49)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 148;
		}
		if (Main.tile[myX, myY].type == 372)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3117;
		}
		if (Main.tile[myX, myY].type == 646)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5322;
		}
		if (Main.tile[myX, myY].type == 174)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 713;
		}
		if (Main.tile[myX, myY].type == 50)
		{
			noThrow = 2;
			if (Main.tile[myX, myY].frameX == 90)
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = 165;
			}
		}
		if (Main.tile[myX, myY].type == 139)
		{
			noThrow = 2;
			int num17 = 0;
			for (int num18 = Main.tile[myX, myY].frameY / 18; num18 >= 2; num18 -= 2)
			{
				num17++;
			}
			cursorItemIconEnabled = true;
			cursorItemIconID = WorldGen.GetItemDrop_MusicBoxes(num17);
		}
		if (Main.tile[myX, myY].type == 207)
		{
			noThrow = 2;
			int num19 = 0;
			for (int num20 = Main.tile[myX, myY].frameX / 18; num20 >= 2; num20 -= 2)
			{
				num19++;
			}
			cursorItemIconEnabled = true;
			switch (num19)
			{
			case 0:
				cursorItemIconID = 909;
				break;
			case 1:
				cursorItemIconID = 910;
				break;
			case 2:
				cursorItemIconID = 940;
				break;
			case 3:
				cursorItemIconID = 941;
				break;
			case 4:
				cursorItemIconID = 942;
				break;
			case 5:
				cursorItemIconID = 943;
				break;
			case 6:
				cursorItemIconID = 944;
				break;
			case 7:
				cursorItemIconID = 945;
				break;
			case 8:
				cursorItemIconID = 4922;
				break;
			case 9:
				cursorItemIconID = 4417;
				break;
			}
		}
		if (Main.tileSign[Main.tile[myX, myY].type])
		{
			noThrow = 2;
			int num21 = Main.tile[myX, myY].frameX / 18;
			int num22 = Main.tile[myX, myY].frameY / 18;
			num21 %= 2;
			int num23 = myX - num21;
			int num24 = myY - num22;
			Main.signBubble = true;
			Main.signX = num23 * 16 + 16;
			Main.signY = num24 * 16;
			int num25 = Sign.ReadSign(num23, num24, CreateIfMissing: false);
			if (num25 != -1)
			{
				Main.signHover = num25;
			}
			if (num25 != -1)
			{
				Main.signHover = num25;
				cursorItemIconEnabled = false;
				cursorItemIconID = -1;
			}
		}
		if (Main.tile[myX, myY].type == 237)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 1293;
		}
		if (Main.tile[myX, myY].type == 466)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3828;
		}
		if (Main.tile[myX, myY].type == 125)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 487;
		}
		if (Main.tile[myX, myY].type == 354)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2999;
		}
		if (Main.tile[myX, myY].type == 287)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2177;
		}
		if (Main.tile[myX, myY].type == 132)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 513;
		}
		if (Main.tile[myX, myY].type == 136)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 538;
		}
		if (Main.tile[myX, myY].type == 144)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num26 = Main.tile[myX, myY].frameX / 18;
			if (num26 < 3)
			{
				cursorItemIconID = 583 + num26;
			}
			else
			{
				cursorItemIconID = 4484 + (num26 - 3);
			}
		}
		if (Main.tile[myX, myY].type == 440)
		{
			int num27 = Main.tile[myX, myY].frameX / 54;
			int num28 = Main.tile[myX, myY].frameY / 54;
			int num29 = -1;
			switch (num27)
			{
			case 0:
				num29 = 1526;
				break;
			case 1:
				num29 = 1524;
				break;
			case 2:
				num29 = 1525;
				break;
			case 3:
				num29 = 1523;
				break;
			case 4:
				num29 = 1522;
				break;
			case 5:
				num29 = 1527;
				break;
			case 6:
				num29 = 3643;
				break;
			}
			if (num29 != -1 && (num28 == 1 || HasItem(num29)))
			{
				noThrow = 2;
				cursorItemIconEnabled = true;
				cursorItemIconID = num29;
			}
		}
		else if (Main.tile[myX, myY].type == 470)
		{
			noThrow = 2;
			int num30 = Main.tile[myX, myY].frameX % 136 / 34;
			if (num30 < 2)
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = 498;
			}
			else if (num30 < 4)
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = 1989;
			}
		}
		else if (Main.tile[myX, myY].type == 475)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3977;
		}
		else if (Main.tile[myX, myY].type == 520)
		{
			noThrow = 2;
			if (TileEntity.TryGetAt<TEFoodPlatter>(myX, myY, out var result))
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = result.item.type;
			}
		}
		else if (Main.tile[myX, myY].type == 395)
		{
			noThrow = 2;
			int num31 = myX;
			int num32 = myY;
			int num33 = Main.tile[myX, myY].frameX;
			int num34 = Main.tile[myX, myY].frameY;
			while (num34 > 0)
			{
				num34 -= 18;
				num32--;
			}
			while (num33 >= 36)
			{
				num33 -= 36;
			}
			while (num33 > 0)
			{
				num33 -= 18;
				num31--;
			}
			if (TileEntity.TryGetAt<TEItemFrame>(num31, num32, out var result2))
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = result2.item.type;
			}
		}
		else if (Main.tile[myX, myY].type == 698)
		{
			noThrow = 2;
			int num35 = myY;
			_ = Main.tile[myX, myY].frameX;
			int num36 = Main.tile[myX, myY].frameY;
			while (num36 > 0)
			{
				num36 -= 18;
				num35--;
			}
			if (TileEntity.TryGetAt<TEDeadCellsDisplayJar>(myX, num35, out var result3))
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = result3.item.type;
			}
		}
		else if (Main.tile[myX, myY].type == 471)
		{
			noThrow = 2;
			int num37 = myX;
			int num38 = myY;
			int num39 = Main.tile[myX, myY].frameX;
			int num40 = Main.tile[myX, myY].frameY;
			while (num40 > 0)
			{
				num40 -= 18;
				num38--;
			}
			while (num39 >= 54)
			{
				num39 -= 54;
			}
			while (num39 > 0)
			{
				num39 -= 18;
				num37--;
			}
			if (TileEntity.TryGetAt<TEWeaponsRack>(num37, num38, out var result4))
			{
				cursorItemIconEnabled = true;
				cursorItemIconID = result4.item.type;
			}
		}
		else if (Main.tile[myX, myY].type == 334)
		{
			noThrow = 2;
		}
		else if (Main.tile[myX, myY].type == 16)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num41 = Main.tile[myX, myY].frameX / 18 >> 1;
			cursorItemIconID = ((num41 == 0) ? 35 : 716);
		}
		else if (Main.tile[myX, myY].type == 17)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 33;
		}
		else if (Main.tile[myX, myY].type == 18)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int style5 = Main.tile[myX, myY].frameX / 18 >> 1;
			cursorItemIconID = WorldGen.GetItemDrop_Workbenches(style5);
		}
		else if (Main.tile[myX, myY].type == 26)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num42 = Main.tile[myX, myY].frameX / 18;
			int num43 = 0;
			while (num42 > 2)
			{
				num42 -= 3;
				num43++;
			}
			cursorItemIconID = ((num43 == 0) ? 6135 : 6136);
		}
		else if (Main.tile[myX, myY].type == 77)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 221;
		}
		else if (Main.tile[myX, myY].type == 86)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 332;
		}
		else if (Main.tile[myX, myY].type == 94)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 352;
		}
		else if (Main.tile[myX, myY].type == 96)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num44 = Main.tile[myX, myY].frameX / 18;
			int num45 = 0;
			while (num44 > 1)
			{
				num44 -= 2;
				num45++;
			}
			cursorItemIconID = ((num45 == 0) ? 345 : 1791);
		}
		else if (Main.tile[myX, myY].type == 101)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num46 = Main.tile[myX, myY].frameX / 18;
			int num47 = 0;
			while (num46 >= 3)
			{
				num46 -= 3;
				num47++;
			}
			cursorItemIconID = WorldGen.GetItemDrop_Bookcases(num47);
		}
		else if (Main.tile[myX, myY].type == 106)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 363;
		}
		else if (Main.tile[myX, myY].type == 114)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 398;
		}
		else if (Main.tile[myX, myY].type == 133)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num48 = Main.tile[myX, myY].frameX / 18;
			int num49 = 0;
			while (num48 > 2)
			{
				num48 -= 3;
				num49++;
			}
			cursorItemIconID = ((num49 == 0) ? 524 : 1221);
		}
		else if (Main.tile[myX, myY].type == 134)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int num50 = Main.tile[myX, myY].frameX / 18 >> 1;
			cursorItemIconID = ((num50 == 0) ? 525 : 1220);
		}
		else if (Main.tile[myX, myY].type == 217)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 995;
		}
		else if (Main.tile[myX, myY].type == 218)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 996;
		}
		else if (Main.tile[myX, myY].type == 220)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 998;
		}
		else if (Main.tile[myX, myY].type == 228)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 1120;
		}
		else if (Main.tile[myX, myY].type == 243)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 1430;
		}
		else if (Main.tile[myX, myY].type == 247)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 1551;
		}
		else if (Main.tile[myX, myY].type == 283)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2172;
		}
		else if (Main.tile[myX, myY].type == 300)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2192;
		}
		else if (Main.tile[myX, myY].type == 301)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2193;
		}
		else if (Main.tile[myX, myY].type == 302)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2194;
		}
		else if (Main.tile[myX, myY].type == 303)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2195;
		}
		else if (Main.tile[myX, myY].type == 304)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2196;
		}
		else if (Main.tile[myX, myY].type == 305)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2197;
		}
		else if (Main.tile[myX, myY].type == 306)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2198;
		}
		else if (Main.tile[myX, myY].type == 307)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2203;
		}
		else if (Main.tile[myX, myY].type == 308)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 2204;
		}
		else if (Main.tile[myX, myY].type == 412)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3549;
		}
		else if (Main.tile[myX, myY].type == 499)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 4142;
		}
		else if (Main.tile[myX, myY].type == 622)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 5008;
		}
		else if (Main.tile[myX, myY].type == 172)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			int style6 = Main.tile[myX, myY].frameY / 38;
			cursorItemIconID = WorldGen.GetItemDrop_Sinks(style6);
		}
		else if (Main.tile[myX, myY].type == 355)
		{
			noThrow = 2;
			cursorItemIconEnabled = true;
			cursorItemIconID = 3000;
		}
		if (PlayerInput.UsingGamepad && cursorItemIconText.Length == 0)
		{
			cursorItemIconEnabled = false;
			cursorItemIconID = 0;
		}
	}

	public Color ChatColor()
	{
		return difficulty switch
		{
			1 => Main.mcColor, 
			2 => Main.hcColor, 
			_ => Color.White, 
		};
	}

	private void TileInteractionsMouseOver_Containers(int myX, int myY)
	{
		LocalizedText[] array = Lang.chestType;
		Tile tile = Main.tile[myX, myY];
		if (tile.type == 467)
		{
			array = Lang.chestType2;
		}
		int num = myX;
		int num2 = myY;
		if (tile.frameX % 36 != 0)
		{
			num--;
		}
		if (tile.frameY % 36 != 0)
		{
			num2--;
		}
		int num3 = Chest.FindChest(num, num2);
		cursorItemIconID = -1;
		int num4 = tile.frameX / 36;
		bool flag = num4 >= 0 && num4 < array.Length;
		int num5 = 0;
		string text = ((!flag) ? null : array[num4].Value);
		if (num3 < 0)
		{
			cursorItemIconText = array[0].Value;
			cursorItemIconEnabled = true;
		}
		else
		{
			if (Main.chest[num3].name != "")
			{
				cursorItemIconText = Main.chest[num3].name;
				cursorItemIconEnabled = true;
			}
			else if (flag)
			{
				cursorItemIconText = text;
				cursorItemIconEnabled = true;
			}
			if (flag && text != null && cursorItemIconText == text)
			{
				num5 = WorldGen.GetChestIcon(num4, tile.type == 467);
				cursorItemIconText = "";
			}
		}
		noThrow = 2;
		if (num5 > 0)
		{
			if (num5 == 3988)
			{
				num5 = 306;
			}
			cursorItemIconID = num5;
			cursorItemIconEnabled = true;
		}
		hoveredChestIndex = num3;
	}

	private void TryLandingOnDetonator()
	{
		if (whoAmI == Main.myPlayer && velocity.Y >= 3f)
		{
			Point point = (base.Bottom + new Vector2(0f, 0.01f)).ToTileCoordinates();
			Tile tileSafely = Framing.GetTileSafely(point.X, point.Y);
			if (tileSafely.active() && tileSafely.type == 411 && tileSafely.frameY == 0 && tileSafely.frameX < 36)
			{
				Wiring.HitSwitch(point.X, point.Y);
				NetMessage.SendData(59, -1, -1, null, point.X, point.Y);
			}
		}
	}

	private void TryBouncingBlocks(bool Falling)
	{
		bool num = !wet && !shimmering && (velocity.Y >= 5f || velocity.Y <= -5f);
		bool flag = false;
		bool flag2 = false;
		float num2 = 1f;
		if (!num)
		{
			return;
		}
		bool flag3 = false;
		int num3 = 0;
		foreach (Point touchedTile in TouchedTiles)
		{
			Tile tile = Main.tile[touchedTile.X, touchedTile.Y];
			if (tile != null && tile.active() && tile.nactive() && (flag || Main.tileBouncy[tile.type]))
			{
				flag3 = true;
				num3 = touchedTile.Y;
				break;
			}
		}
		if (!flag3)
		{
			return;
		}
		velocity.Y *= -0.8f;
		if (controlJump)
		{
			velocity.Y = MathHelper.Clamp(velocity.Y, -13f, 13f);
		}
		position.Y = num3 * 16 - ((velocity.Y < 0f) ? height : (-16));
		FloorVisuals(Falling);
		if (flag2)
		{
			Vector2 vector = (fullRotation - (float)Math.PI / 2f).ToRotationVector2();
			if (vector.Y > 0f)
			{
				vector.Y *= -1f;
			}
			vector.Y = vector.Y * 0.5f + -0.5f;
			float num4 = 0f - vector.Y;
			if (num4 < 0f)
			{
				num4 = 0f;
			}
			float num5 = num4 * 1.5f + 1f;
			float value = Math.Abs(velocity.Y) * num5 * num2;
			value = MathHelper.Clamp(value, 2f, 16f);
			velocity = vector * value;
			float num6 = 20f;
			Vector2 vector2 = base.Center + (fullRotation + (float)Math.PI / 2f).ToRotationVector2() * num6;
			vector2 = base.Bottom;
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.Keybrand, new ParticleOrchestraSettings
			{
				PositionInWorld = vector2
			}, whoAmI);
		}
		velocity.Y = MathHelper.Clamp(velocity.Y, -20f, 20f);
		if (velocity.Y * gravDir < 0f)
		{
			fallStart = (int)position.Y / 16;
		}
	}

	public bool CanAcceptItemIntoInventory(WorldItem item)
	{
		return CanAcceptItemIntoInventory(item.inner);
	}

	public bool CanAcceptItemIntoInventory(Item item)
	{
		if (preventAllItemPickups)
		{
			return ItemID.Sets.IgnoresEncumberingStone[item.type];
		}
		return true;
	}

	private void GrabItems(int i)
	{
		for (int j = 0; j < 400; j++)
		{
			WorldItem worldItem = Main.item[j];
			if (!worldItem.active || worldItem.shimmerTime != 0f || worldItem.noGrabDelay != 0 || worldItem.playerIndexTheItemIsReservedFor != i || !CanAcceptItemIntoInventory(worldItem) || (worldItem.shimmered && !((double)worldItem.velocity.Length() < 0.2)))
			{
				continue;
			}
			int itemGrabRange = GetItemGrabRange(worldItem);
			Rectangle hitbox = worldItem.Hitbox;
			if (base.Hitbox.Intersects(hitbox))
			{
				if (i == Main.myPlayer && (inventory[selectedItem].type != 0 || itemAnimation <= 0))
				{
					PickupItem(worldItem);
				}
			}
			else
			{
				if (!new Rectangle((int)position.X - itemGrabRange, (int)position.Y - itemGrabRange, width + itemGrabRange * 2, height + itemGrabRange * 2).Intersects(hitbox))
				{
					continue;
				}
				ItemSpaceStatus status = ItemSpace(worldItem);
				if (CanPullItem(worldItem, status))
				{
					worldItem.shimmered = false;
					worldItem.beingGrabbed = true;
					bool flag = false;
					if (difficulty == 3 && CreativePowerManager.Instance.GetPower<CreativePowers.FarPlacementRangePower>().IsEnabledForPlayer(whoAmI))
					{
						flag = true;
					}
					if (manaMagnet && (worldItem.type == 184 || worldItem.type == 1735 || worldItem.type == 1868))
					{
						PullItem_Pickup(worldItem, 12f, 5);
					}
					else if (lifeMagnet && (worldItem.type == 58 || worldItem.type == 1734 || worldItem.type == 1867))
					{
						PullItem_Pickup(worldItem, 15f, 5);
					}
					else if (ItemID.Sets.NebulaPickup[worldItem.type])
					{
						PullItem_Pickup(worldItem, 12f, 5);
					}
					else if (status.ItemIsGoingToVoidVault)
					{
						PullItem_ToVoidVault(worldItem);
					}
					else if (goldRing && worldItem.IsACoin)
					{
						PullItem_Pickup(worldItem, 12f, 5);
					}
					else if (flag)
					{
						PullItem_Pickup(worldItem, 7f, 1);
					}
					else
					{
						PullItem_Common(worldItem, 0.75f);
					}
				}
			}
		}
	}

	private void PullItem_ToVoidVault(WorldItem itemToPickUp)
	{
		PullItem_Pickup(itemToPickUp, 12f, 5);
	}

	private void PullItem_Common(WorldItem itemToPickUp, float xPullSpeed)
	{
		if ((double)position.X + (double)width * 0.5 > (double)itemToPickUp.position.X + (double)itemToPickUp.width * 0.5)
		{
			if (itemToPickUp.velocity.X < itemGrabSpeedMax + velocity.X)
			{
				itemToPickUp.velocity.X += itemGrabSpeed;
			}
			if (itemToPickUp.velocity.X < 0f)
			{
				itemToPickUp.velocity.X += itemGrabSpeed * xPullSpeed;
			}
		}
		else
		{
			if (itemToPickUp.velocity.X > 0f - itemGrabSpeedMax + velocity.X)
			{
				itemToPickUp.velocity.X -= itemGrabSpeed;
			}
			if (itemToPickUp.velocity.X > 0f)
			{
				itemToPickUp.velocity.X -= itemGrabSpeed * xPullSpeed;
			}
		}
		if ((double)position.Y + (double)height * 0.5 > (double)itemToPickUp.position.Y + (double)itemToPickUp.height * 0.5)
		{
			if (itemToPickUp.velocity.Y < itemGrabSpeedMax)
			{
				itemToPickUp.velocity.Y += itemGrabSpeed;
			}
			if (itemToPickUp.velocity.Y < 0f)
			{
				itemToPickUp.velocity.Y += itemGrabSpeed * xPullSpeed;
			}
		}
		else
		{
			if (itemToPickUp.velocity.Y > 0f - itemGrabSpeedMax)
			{
				itemToPickUp.velocity.Y -= itemGrabSpeed;
			}
			if (itemToPickUp.velocity.Y > 0f)
			{
				itemToPickUp.velocity.Y -= itemGrabSpeed * xPullSpeed;
			}
		}
	}

	private void PullItem_Pickup(WorldItem itemToPickUp, float speed, int acc)
	{
		Vector2 vector = new Vector2(itemToPickUp.position.X + (float)(itemToPickUp.width / 2), itemToPickUp.position.Y + (float)(itemToPickUp.height / 2));
		float num = base.Center.X - vector.X;
		float num2 = base.Center.Y - vector.Y;
		float num3 = (float)Math.Sqrt(num * num + num2 * num2);
		num3 = speed / num3;
		num *= num3;
		num2 *= num3;
		itemToPickUp.velocity.X = (itemToPickUp.velocity.X * (float)(acc - 1) + num) / (float)acc;
		itemToPickUp.velocity.Y = (itemToPickUp.velocity.Y * (float)(acc - 1) + num2) / (float)acc;
	}

	private void PickupItem(WorldItem itemToPickUp)
	{
		if (ItemID.Sets.NebulaPickup[itemToPickUp.type])
		{
			SoundEngine.PlaySound(7, (int)position.X, (int)position.Y);
			int num = itemToPickUp.buffType;
			itemToPickUp.ClearOut();
			if (Main.netMode == 1)
			{
				NetMessage.SendData(102, -1, -1, null, whoAmI, num, base.Center.X, base.Center.Y);
			}
			else
			{
				NebulaLevelup(num);
			}
		}
		else if (itemToPickUp.type == 58 || itemToPickUp.type == 1734 || itemToPickUp.type == 1867)
		{
			SoundEngine.PlaySound(7);
			Heal(20);
			itemToPickUp.ClearOut();
		}
		else if (itemToPickUp.type == 184 || itemToPickUp.type == 1735 || itemToPickUp.type == 1868)
		{
			SoundEngine.PlaySound(7);
			statMana += 100;
			if (Main.myPlayer == whoAmI)
			{
				ManaEffect(100);
			}
			if (statMana > statManaMax2)
			{
				statMana = statManaMax2;
			}
			itemToPickUp.ClearOut();
		}
		else if (itemToPickUp.type == 4143)
		{
			SoundEngine.PlaySound(7);
			statMana += 50;
			if (Main.myPlayer == whoAmI)
			{
				ManaEffect(50);
			}
			if (statMana > statManaMax2)
			{
				statMana = statManaMax2;
			}
			itemToPickUp.ClearOut();
		}
		else
		{
			int stack = itemToPickUp.stack;
			Item item = GetItem(itemToPickUp, GetItemSettings.PickupItemFromWorld);
			itemToPickUp.OverrideWith(item);
			if (item.stack == stack)
			{
				return;
			}
		}
		if (Main.netMode == 1)
		{
			NetMessage.SendData(21, -1, -1, null, itemToPickUp.whoAmI);
		}
	}

	public void Heal(int amount)
	{
		statLife += amount;
		if (Main.myPlayer == whoAmI)
		{
			HealEffect(amount);
		}
		if (statLife > statLifeMax2)
		{
			statLife = statLifeMax2;
		}
	}

	public int GetItemGrabRange(WorldItem item)
	{
		return GetItemGrabRange(item.inner);
	}

	public int GetItemGrabRange(Item item)
	{
		int num = defaultItemGrabRange;
		if (goldRing && item.IsACoin)
		{
			num += Item.coinGrabRange;
		}
		if (manaMagnet && (item.type == 184 || item.type == 1735 || item.type == 1868))
		{
			num += Item.manaGrabRange;
		}
		if (item.type == 4143)
		{
			num += Item.manaGrabRange;
		}
		if (lifeMagnet && (item.type == 58 || item.type == 1734 || item.type == 1867))
		{
			num += Item.lifeGrabRange;
		}
		if (treasureMagnet)
		{
			num += Item.treasureGrabRange;
		}
		if (item.type == 3822)
		{
			num += 50;
		}
		if (ItemID.Sets.NebulaPickup[item.type])
		{
			num += 100;
		}
		if (difficulty == 3 && CreativePowerManager.Instance.GetPower<CreativePowers.FarPlacementRangePower>().IsEnabledForPlayer(whoAmI))
		{
			num += 240;
		}
		return num;
	}

	public bool SellItem(Item item, int stack = -1)
	{
		GetItemExpectedPrice(item, out var calcForSelling, out var calcForBuying);
		if (calcForSelling <= 0)
		{
			return false;
		}
		if (stack == -1)
		{
			stack = item.stack;
		}
		Item[] array = new Item[58];
		for (int i = 0; i < 58; i++)
		{
			array[i] = inventory[i].Clone();
		}
		long num = calcForSelling / 5;
		if (num < 1)
		{
			num = 1L;
		}
		long num2 = num;
		num *= stack;
		int amount = Main.shopSellbackHelper.GetAmount(item);
		if (amount > 0)
		{
			num += (-num2 + calcForBuying) * Math.Min(amount, item.stack);
		}
		bool flag = false;
		while (num >= 1000000 && !flag)
		{
			int num3 = -1;
			for (int num4 = 53; num4 >= 0; num4--)
			{
				if (num3 == -1 && (inventory[num4].type == 0 || inventory[num4].stack == 0))
				{
					num3 = num4;
				}
				while (inventory[num4].type == 74 && inventory[num4].stack < inventory[num4].maxStack && num >= 1000000)
				{
					inventory[num4].stack++;
					num -= 1000000;
					DoCoins(num4);
					if (inventory[num4].stack == 0 && num3 == -1)
					{
						num3 = num4;
					}
				}
			}
			if (num >= 1000000)
			{
				if (num3 == -1)
				{
					flag = true;
					continue;
				}
				inventory[num3].SetDefaults(74);
				num -= 1000000;
			}
		}
		while (num >= 10000 && !flag)
		{
			int num5 = -1;
			for (int num6 = 53; num6 >= 0; num6--)
			{
				if (num5 == -1 && (inventory[num6].type == 0 || inventory[num6].stack == 0))
				{
					num5 = num6;
				}
				while (inventory[num6].type == 73 && inventory[num6].stack < inventory[num6].maxStack && num >= 10000)
				{
					inventory[num6].stack++;
					num -= 10000;
					DoCoins(num6);
					if (inventory[num6].stack == 0 && num5 == -1)
					{
						num5 = num6;
					}
				}
			}
			if (num >= 10000)
			{
				if (num5 == -1)
				{
					flag = true;
					continue;
				}
				inventory[num5].SetDefaults(73);
				num -= 10000;
			}
		}
		while (num >= 100 && !flag)
		{
			int num7 = -1;
			for (int num8 = 53; num8 >= 0; num8--)
			{
				if (num7 == -1 && (inventory[num8].type == 0 || inventory[num8].stack == 0))
				{
					num7 = num8;
				}
				while (inventory[num8].type == 72 && inventory[num8].stack < inventory[num8].maxStack && num >= 100)
				{
					inventory[num8].stack++;
					num -= 100;
					DoCoins(num8);
					if (inventory[num8].stack == 0 && num7 == -1)
					{
						num7 = num8;
					}
				}
			}
			if (num >= 100)
			{
				if (num7 == -1)
				{
					flag = true;
					continue;
				}
				inventory[num7].SetDefaults(72);
				num -= 100;
			}
		}
		while (num >= 1 && !flag)
		{
			int num9 = -1;
			for (int num10 = 53; num10 >= 0; num10--)
			{
				if (num9 == -1 && (inventory[num10].type == 0 || inventory[num10].stack == 0))
				{
					num9 = num10;
				}
				while (inventory[num10].type == 71 && inventory[num10].stack < inventory[num10].maxStack && num >= 1)
				{
					inventory[num10].stack++;
					num--;
					DoCoins(num10);
					if (inventory[num10].stack == 0 && num9 == -1)
					{
						num9 = num10;
					}
				}
			}
			if (num >= 1)
			{
				if (num9 == -1)
				{
					flag = true;
					continue;
				}
				inventory[num9].SetDefaults(71);
				num--;
			}
		}
		if (flag)
		{
			for (int j = 0; j < 58; j++)
			{
				inventory[j] = array[j];
			}
			return false;
		}
		return true;
	}

	public void RefreshItems(bool onlyIfVariantChanged = true)
	{
		if (onlyIfVariantChanged && whoAmI == Main.myPlayer)
		{
			Recipe.UpdateItemVariants();
		}
		RefreshItems(inventory, onlyIfVariantChanged);
		RefreshItems(armor, onlyIfVariantChanged);
		RefreshItems(dye, onlyIfVariantChanged);
		RefreshItems(miscEquips, onlyIfVariantChanged);
		RefreshItems(miscDyes, onlyIfVariantChanged);
		RefreshItems(bank.item, onlyIfVariantChanged);
		RefreshItems(bank2.item, onlyIfVariantChanged);
		RefreshItems(bank3.item, onlyIfVariantChanged);
		RefreshItems(bank4.item, onlyIfVariantChanged);
		RefreshItems(_temporaryItemSlots, onlyIfVariantChanged);
		RefreshItems(_pendingRefunds, onlyIfVariantChanged);
	}

	private void RefreshItems(Item[] array, bool onlyIfVariantChanged)
	{
		for (int i = 0; i < array.Length; i++)
		{
			array[i]?.Refresh(onlyIfVariantChanged);
		}
	}

	public void GetItemExpectedPrice(Item item, out long calcForSelling, out long calcForBuying)
	{
		if (item.shopSpecialCurrency != -1)
		{
			CustomCurrencyManager.GetPrices(item, out calcForSelling, out calcForBuying);
			return;
		}
		int storeValue = item.GetStoreValue();
		calcForSelling = storeValue;
		calcForBuying = storeValue;
		if (discountAvailable)
		{
			if (!item.buyOnce)
			{
				calcForBuying = (int)((float)calcForBuying * 0.8f);
			}
			if (item.isAShopItem)
			{
				calcForSelling = calcForBuying;
			}
		}
		if (item.buyOnce)
		{
			calcForBuying = (int)Math.Round((float)calcForBuying / currentShoppingSettings.PriceAdjustment);
			calcForSelling = (int)Math.Round((float)calcForSelling / currentShoppingSettings.PriceAdjustment);
		}
		else
		{
			calcForBuying = (int)Math.Round((float)calcForBuying * currentShoppingSettings.PriceAdjustment);
			calcForSelling = (int)Math.Round((float)calcForSelling / currentShoppingSettings.PriceAdjustment);
		}
		if (item.buyOnce)
		{
			calcForBuying /= 5L;
			if (storeValue != 0 && calcForBuying < 1)
			{
				calcForBuying = 1L;
			}
		}
	}

	public bool BuyItem(long price, int customCurrency = -1)
	{
		if (customCurrency != -1)
		{
			return CustomCurrencyManager.BuyItem(this, price, customCurrency);
		}
		bool overFlowing;
		long num = Utils.CoinsCount(out overFlowing, inventory, 58, 57, 56, 55, 54);
		long num2 = Utils.CoinsCount(out overFlowing, bank.item);
		long num3 = Utils.CoinsCount(out overFlowing, bank2.item);
		long num4 = Utils.CoinsCount(out overFlowing, bank3.item);
		long num5 = Utils.CoinsCount(out overFlowing, bank4.item);
		if (Utils.CoinsCombineStacks(out overFlowing, num, num2, num3, num4, num5) < price)
		{
			return false;
		}
		List<Item[]> list = new List<Item[]>();
		Dictionary<int, List<int>> dictionary = new Dictionary<int, List<int>>();
		List<Point> list2 = new List<Point>();
		List<Point> list3 = new List<Point>();
		List<Point> list4 = new List<Point>();
		List<Point> list5 = new List<Point>();
		List<Point> list6 = new List<Point>();
		List<Point> list7 = new List<Point>();
		list.Add(inventory);
		list.Add(bank.item);
		list.Add(bank2.item);
		list.Add(bank3.item);
		list.Add(bank4.item);
		for (int i = 0; i < list.Count; i++)
		{
			dictionary[i] = new List<int>();
		}
		dictionary[0] = new List<int> { 58, 57, 56, 55, 54 };
		for (int j = 0; j < list.Count; j++)
		{
			for (int k = 0; k < list[j].Length; k++)
			{
				if (!dictionary[j].Contains(k) && list[j][k].IsACoin)
				{
					list3.Add(new Point(j, k));
				}
			}
		}
		int num6 = 0;
		for (int num7 = list[num6].Length - 1; num7 >= 0; num7--)
		{
			if (!dictionary[num6].Contains(num7) && (list[num6][num7].type == 0 || list[num6][num7].stack == 0))
			{
				list2.Add(new Point(num6, num7));
			}
		}
		num6 = 1;
		for (int num8 = list[num6].Length - 1; num8 >= 0; num8--)
		{
			if (!dictionary[num6].Contains(num8) && (list[num6][num8].type == 0 || list[num6][num8].stack == 0))
			{
				list4.Add(new Point(num6, num8));
			}
		}
		num6 = 2;
		for (int num9 = list[num6].Length - 1; num9 >= 0; num9--)
		{
			if (!dictionary[num6].Contains(num9) && (list[num6][num9].type == 0 || list[num6][num9].stack == 0))
			{
				list5.Add(new Point(num6, num9));
			}
		}
		num6 = 3;
		for (int num10 = list[num6].Length - 1; num10 >= 0; num10--)
		{
			if (!dictionary[num6].Contains(num10) && (list[num6][num10].type == 0 || list[num6][num10].stack == 0))
			{
				list6.Add(new Point(num6, num10));
			}
		}
		num6 = 4;
		for (int num11 = list[num6].Length - 1; num11 >= 0; num11--)
		{
			if (!dictionary[num6].Contains(num11) && (list[num6][num11].type == 0 || list[num6][num11].stack == 0))
			{
				list7.Add(new Point(num6, num11));
			}
		}
		if (TryPurchasing(price, list, list3, list2, list4, list5, list6, list7))
		{
			return false;
		}
		return true;
	}

	private static bool TryPurchasing(long price, List<Item[]> inv, List<Point> slotCoins, List<Point> slotsEmpty, List<Point> slotEmptyBank, List<Point> slotEmptyBank2, List<Point> slotEmptyBank3, List<Point> slotEmptyBank4)
	{
		long num = price;
		Dictionary<Point, Item> dictionary = new Dictionary<Point, Item>();
		bool result = false;
		while (num > 0)
		{
			long num2 = 1000000L;
			for (int i = 0; i < 4; i++)
			{
				if (num >= num2)
				{
					foreach (Point slotCoin in slotCoins)
					{
						if (inv[slotCoin.X][slotCoin.Y].type == 74 - i)
						{
							long num3 = num / num2;
							dictionary[slotCoin] = inv[slotCoin.X][slotCoin.Y].Clone();
							if (num3 < inv[slotCoin.X][slotCoin.Y].stack)
							{
								inv[slotCoin.X][slotCoin.Y].stack -= (int)num3;
							}
							else
							{
								inv[slotCoin.X][slotCoin.Y].SetDefaults(0);
								slotsEmpty.Add(slotCoin);
							}
							num -= num2 * (dictionary[slotCoin].stack - inv[slotCoin.X][slotCoin.Y].stack);
						}
					}
				}
				num2 /= 100;
			}
			if (num <= 0)
			{
				continue;
			}
			if (slotsEmpty.Count > 0)
			{
				slotsEmpty.Sort(DelegateMethods.CompareYReverse);
				Point item = new Point(-1, -1);
				for (int j = 0; j < inv.Count; j++)
				{
					num2 = 10000L;
					for (int k = 0; k < 3; k++)
					{
						if (num >= num2)
						{
							foreach (Point slotCoin2 in slotCoins)
							{
								if (slotCoin2.X == j && inv[slotCoin2.X][slotCoin2.Y].type == 74 - k && inv[slotCoin2.X][slotCoin2.Y].stack >= 1)
								{
									List<Point> list = slotsEmpty;
									if (j == 1 && slotEmptyBank.Count > 0)
									{
										list = slotEmptyBank;
									}
									if (j == 2 && slotEmptyBank2.Count > 0)
									{
										list = slotEmptyBank2;
									}
									if (j == 3 && slotEmptyBank3.Count > 0)
									{
										list = slotEmptyBank3;
									}
									if (j == 4 && slotEmptyBank4.Count > 0)
									{
										list = slotEmptyBank4;
									}
									if (--inv[slotCoin2.X][slotCoin2.Y].stack <= 0)
									{
										inv[slotCoin2.X][slotCoin2.Y].SetDefaults(0);
										list.Add(slotCoin2);
									}
									dictionary[list[0]] = inv[list[0].X][list[0].Y].Clone();
									inv[list[0].X][list[0].Y].SetDefaults(73 - k);
									inv[list[0].X][list[0].Y].stack = 100;
									item = list[0];
									list.RemoveAt(0);
									break;
								}
							}
						}
						if (item.X != -1 || item.Y != -1)
						{
							break;
						}
						num2 /= 100;
					}
					for (int l = 0; l < 2; l++)
					{
						if (item.X != -1 || item.Y != -1)
						{
							continue;
						}
						foreach (Point slotCoin3 in slotCoins)
						{
							if (slotCoin3.X == j && inv[slotCoin3.X][slotCoin3.Y].type == 73 + l && inv[slotCoin3.X][slotCoin3.Y].stack >= 1)
							{
								List<Point> list2 = slotsEmpty;
								if (j == 1 && slotEmptyBank.Count > 0)
								{
									list2 = slotEmptyBank;
								}
								if (j == 2 && slotEmptyBank2.Count > 0)
								{
									list2 = slotEmptyBank2;
								}
								if (j == 3 && slotEmptyBank3.Count > 0)
								{
									list2 = slotEmptyBank3;
								}
								if (j == 4 && slotEmptyBank4.Count > 0)
								{
									list2 = slotEmptyBank4;
								}
								if (--inv[slotCoin3.X][slotCoin3.Y].stack <= 0)
								{
									inv[slotCoin3.X][slotCoin3.Y].SetDefaults(0);
									list2.Add(slotCoin3);
								}
								dictionary[list2[0]] = inv[list2[0].X][list2[0].Y].Clone();
								inv[list2[0].X][list2[0].Y].SetDefaults(72 + l);
								inv[list2[0].X][list2[0].Y].stack = 100;
								item = list2[0];
								list2.RemoveAt(0);
								break;
							}
						}
					}
					if (item.X != -1 && item.Y != -1)
					{
						slotCoins.Add(item);
						break;
					}
				}
				slotsEmpty.Sort(DelegateMethods.CompareYReverse);
				slotEmptyBank.Sort(DelegateMethods.CompareYReverse);
				slotEmptyBank2.Sort(DelegateMethods.CompareYReverse);
				slotEmptyBank3.Sort(DelegateMethods.CompareYReverse);
				slotEmptyBank4.Sort(DelegateMethods.CompareYReverse);
				continue;
			}
			foreach (KeyValuePair<Point, Item> item2 in dictionary)
			{
				inv[item2.Key.X][item2.Key.Y] = item2.Value.Clone();
			}
			result = true;
			break;
		}
		return result;
	}

	public void SetAdjTile(int tileType)
	{
		adjTile[tileType] = true;
		if (tileType == 355 || tileType == 699)
		{
			alchemyTable = true;
		}
		List<int> list = Recipe.TileCountsAs[tileType];
		if (list == null)
		{
			return;
		}
		foreach (int item in list)
		{
			SetAdjTile(item);
		}
	}

	public void AdjTiles()
	{
		Array.Clear(adjTile, 0, adjTile.Length);
		oldAdjWaterSource = adjWaterSource;
		adjWaterSource = false;
		oldAdjHoney = adjHoney;
		adjHoney = false;
		oldAdjLava = adjLava;
		adjLava = false;
		alchemyTable = false;
		Rectangle tileRegion = TileReachCheckSettings.Simple.GetTileRegion(this, ateArtisanBread ? 4 : 0);
		tileRegion = WorldUtils.ClampToWorld(tileRegion);
		for (int i = tileRegion.Left; i <= tileRegion.Right; i++)
		{
			for (int j = tileRegion.Top; j <= tileRegion.Bottom; j++)
			{
				Tile tile = Main.tile[i, j];
				if (tile.active())
				{
					SetAdjTile(tile.type);
					if (TileID.Sets.CountsAsWaterForCrafting[tile.type])
					{
						adjWaterSource = true;
					}
				}
				if (tile.liquid > 200 && tile.liquidType() == 0)
				{
					adjWaterSource = true;
				}
				if (tile.liquid > 200 && tile.liquidType() == 2)
				{
					adjHoney = true;
				}
				if (tile.liquid > 200 && tile.liquidType() == 1)
				{
					adjLava = true;
				}
			}
		}
	}

	public bool IsTileTypeInInteractionRange(int targetTileType, TileReachCheckSettings settings)
	{
		settings.GetRanges(out var _, out var _);
		settings.GetTileRegion(this, out var LX, out var LY, out var HX, out var HY);
		LX = Utils.Clamp(LX, 0, Main.maxTilesX - 1);
		HX = Utils.Clamp(HX, 0, Main.maxTilesX - 1);
		LY = Utils.Clamp(LY, 0, Main.maxTilesY - 1);
		HY = Utils.Clamp(HY, 0, Main.maxTilesY - 1);
		for (int i = LX; i <= HX; i++)
		{
			for (int j = LY; j <= HY; j++)
			{
				Tile tile = Main.tile[i, j];
				if (tile != null && tile.active() && tile.type == targetTileType)
				{
					return true;
				}
			}
		}
		return false;
	}

	public void DisplayDollUpdate()
	{
		if (!Main.gamePaused)
		{
			UpdateMiscCounter();
		}
	}

	public bool IsColorfulDye(int dye)
	{
		if (dye > 0)
		{
			return ItemID.Sets.ColorfulDyeValues[dye];
		}
		return false;
	}

	public bool ShouldDrawFootball()
	{
		bool result = hasFootball && !pulley && !compositeBackArm.enabled;
		if (HeldItem.type == 4743 && itemAnimation > 0)
		{
			result = false;
		}
		return result;
	}

	public bool CanSpawnWalkingEffects()
	{
		return Math.Abs(velocity.X) + Math.Abs(velocity.Y) > 1f;
	}

	public void PlayerFrame()
	{
		if (swimTime > 0)
		{
			swimTime--;
			if (!wet)
			{
				swimTime = 0;
			}
		}
		head = armor[0].headSlot;
		body = armor[1].bodySlot;
		legs = armor[2].legSlot;
		if (armor[10].headSlot >= 0)
		{
			head = armor[10].headSlot;
		}
		if (armor[11].bodySlot >= 0)
		{
			body = armor[11].bodySlot;
		}
		if (armor[12].legSlot >= 0)
		{
			legs = armor[12].legSlot;
		}
		if (!dead)
		{
			UpdateVisibleAccessories();
		}
		wearsRobe = false;
		bool somethingSpecial = false;
		int num = SetMatch(new SetMatchRequest
		{
			Player = this,
			Head = head,
			Body = body,
			Legs = legs,
			Male = Male,
			ArmorSlotRequested = 1
		}, ref wearsRobe);
		if (num != -1)
		{
			legs = num;
		}
		num = SetMatch(new SetMatchRequest
		{
			Player = this,
			Head = head,
			Body = body,
			Legs = legs,
			Male = Male,
			ArmorSlotRequested = 2
		}, ref somethingSpecial);
		if (num != -1)
		{
			legs = num;
		}
		num = SetMatch(new SetMatchRequest
		{
			Player = this,
			Head = head,
			Body = body,
			Legs = legs,
			Male = Male,
			ArmorSlotRequested = 0
		}, ref somethingSpecial);
		if (num != -1)
		{
			head = num;
		}
		if (body == 93)
		{
			shield = 0;
			handoff = 0;
		}
		if (body > 0 && ArmorIDs.Body.Sets.DisableHandOnAndOffAccDraw[body])
		{
			handon = 0;
			handoff = 0;
		}
		if (body > 0 && waist > 0 && ArmorIDs.Body.Sets.DisableBeltAccDraw[body] && ArmorIDs.Waist.Sets.IsABelt[waist])
		{
			waist = 0;
		}
		bool flag = false;
		bool flag2 = false;
		if (!dead && body >= 0)
		{
			sbyte b = (sbyte)(Male ? ArmorIDs.Body.Sets.IncludedCapeBack : ArmorIDs.Body.Sets.IncludedCapeBackFemale)[body];
			if (b != -1)
			{
				if (ArmorIDs.Back.Sets.DrawInBackpackLayer[b])
				{
					backpack = b;
					cBackpack = cBody;
				}
				else if (ArmorIDs.Back.Sets.DrawInTailLayer[b])
				{
					tail = b;
					cTail = cBody;
				}
				else if (back == -1)
				{
					back = b;
					cBack = cBody;
				}
			}
			sbyte b2 = (sbyte)ArmorIDs.Body.Sets.IncludedCapeFront[body];
			if (b2 != -1 && front == -1)
			{
				flag = true;
				front = b2;
				cFront = cBody;
			}
			ArmorIDs.Body.Sets.IncludeCapeFrontAndBackInfo includeCapeFrontAndBackInfo = ArmorIDs.Body.Sets.IncludeCapeFrontAndBack[body];
			if (!includeCapeFrontAndBackInfo.Invalid && back == -1 && front == -1)
			{
				flag = true;
				front = includeCapeFrontAndBackInfo.frontCape;
				cFront = cBody;
				sbyte backCape = includeCapeFrontAndBackInfo.backCape;
				if (ArmorIDs.Back.Sets.DrawInBackpackLayer[backCape])
				{
					backpack = backCape;
					cBackpack = cBody;
				}
				else if (ArmorIDs.Back.Sets.DrawInTailLayer[backCape])
				{
					tail = backCape;
					cTail = cBody;
				}
				else if (!sitting.isSitting)
				{
					flag2 = true;
					back = backCape;
					cBack = cBody;
				}
			}
		}
		if (back == 38 && wings == 48 && ShouldDrawWingsThatAreAlwaysAnimated())
		{
			back = -1;
		}
		if (legs == 67)
		{
			shoe = 0;
		}
		if (legs == 140)
		{
			shoe = 0;
		}
		bool flag3 = false;
		if ((wereWolf || forceWerewolf) && !hideWolf)
		{
			head = 38;
			body = 21;
			legs = 20;
			if (flag)
			{
				front = -1;
			}
			if (flag2)
			{
				back = -1;
			}
			flag3 = true;
		}
		bool flag4 = wet && !lavaWet && (!mount.Active || !mount.IsConsideredASlimeMount);
		if (merman || forceMerman)
		{
			if (!hideMerman)
			{
				head = 39;
				body = 22;
				legs = 21;
				if (flag)
				{
					front = -1;
				}
				if (flag2)
				{
					back = -1;
				}
				flag3 = true;
			}
			if (flag4)
			{
				wings = 0;
			}
		}
		socialShadowRocketBoots = false;
		socialIgnoreLight = false;
		socialGhost = false;
		armorEffectDrawShadow = false;
		armorEffectDrawShadowSubtle = false;
		armorEffectDrawOutlines = false;
		armorEffectDrawShadowLokis = false;
		armorEffectDrawShadowBasilisk = false;
		armorEffectDrawOutlinesForbidden = false;
		armorEffectDrawShadowEOCShield = false;
		if (!isDisplayDollOrInanimate)
		{
			if (head == 101 && body == 66 && legs == 55)
			{
				socialGhost = true;
			}
			if (head == 156 && body == 66 && legs == 55)
			{
				socialGhost = true;
			}
			SetArmorEffectVisuals(this);
		}
		hermesStepSound.SoundType = 17;
		hermesStepSound.SoundStyle = -1;
		hermesStepSound.IntendedCooldown = 9;
		if (head == 99 && body == 65 && legs == 54)
		{
			turtleArmor = true;
		}
		if (head == 162 && body == 170 && legs == 105)
		{
			spiderArmor = true;
		}
		ApplyArmorSoundAndDustChanges();
		if (legs == 140)
		{
			hermesStepSound.SoundType = 2;
			hermesStepSound.SoundStyle = 24;
			hermesStepSound.IntendedCooldown = 6;
		}
		if (flag3)
		{
			face = -1;
			faceFlower = -1;
			faceMask = -1;
			faceHead = -1;
		}
		if (head > 0 && face > 0 && (head != 287 || face != 23))
		{
			if (ArmorIDs.Face.Sets.OverrideHelmet[face])
			{
				head = -1;
				faceHead = -1;
			}
			else if (!ArmorIDs.Face.Sets.DrawInFaceUnderHairLayer[face])
			{
				face = -1;
			}
		}
		if (head > 0 && faceHead > 0 && ArmorIDs.Head.Sets.UseAltFaceHeadDraw[head])
		{
			sbyte b3 = (sbyte)ArmorIDs.Face.Sets.AltFaceHead[faceHead];
			if (b3 > 0)
			{
				faceHead = b3;
			}
		}
		if (webbed || frozen || stoned || (Main.gamePaused && !Main.gameMenu))
		{
			return;
		}
		if (head == 267 && body == 236 && (legs == 219 || legs == 220) && miscCounter % 15 == 0 && Main.rand.Next(3) == 0)
		{
			Vector2 center = base.Center;
			float num2 = 1f + Main.rand.NextFloat() * 0.5f;
			if (Main.rand.Next(2) == 0)
			{
				num2 *= -1f;
			}
			center += new Vector2(num2 * -25f, -8f);
			Dust obj = Main.dust[Dust.NewDust(center, 2, 2, 304, 0f, 0f, 100)];
			obj.rotation = Main.rand.NextFloat() * ((float)Math.PI * 2f);
			obj.alpha = 254;
			obj.velocity.X = num2 * 0.2f;
			obj.noGravity = true;
			obj.customData = this;
			obj.shader = GameShaders.Armor.GetSecondaryShader(cBody, this);
		}
		if (!isDisplayDollOrInanimate)
		{
			if (((body == 68 && legs == 57 && head == 106) || (body == 74 && legs == 63 && head == 106)) && Main.rand.Next(10) == 0)
			{
				int num3 = Dust.NewDust(new Vector2(position.X - velocity.X * 2f, position.Y - 2f - velocity.Y * 2f), width, height, 43, 0f, 0f, 100, new Color(255, 0, 255), 0.3f);
				Main.dust[num3].fadeIn = 0.8f;
				Main.dust[num3].noGravity = true;
				Main.dust[num3].velocity *= 2f;
				Main.dust[num3].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
			}
			if (wings == 27 && wingsLogic == wings)
			{
				float num4 = 0.4f * stealth;
				Lighting.AddLight((int)base.Center.X / 16, (int)base.Center.Y / 16, num4, num4 * 0.9f, num4 * 0.2f);
			}
			if (head == 5 && body == 5 && legs == 5)
			{
				socialShadowRocketBoots = true;
			}
			if (head == 5 && body == 5 && legs == 5 && Main.rand.Next(10) == 0)
			{
				int num5 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 14, 0f, 0f, 200, default(Color), 1.2f);
				Main.dust[num5].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
			}
			if (head == 76 && body == 49 && legs == 45)
			{
				socialShadowRocketBoots = true;
			}
			if (head == 74 && body == 48 && legs == 44)
			{
				socialShadowRocketBoots = true;
			}
			if (head == 74 && body == 48 && legs == 44 && Main.rand.Next(10) == 0)
			{
				int num6 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 14, 0f, 0f, 200, default(Color), 1.2f);
				Main.dust[num6].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
			}
			if (head == 57 && body == 37 && legs == 35)
			{
				int maxValue = 10;
				if (CanSpawnWalkingEffects())
				{
					maxValue = 2;
				}
				if (Main.rand.Next(maxValue) == 0)
				{
					int num7 = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 115, 0f, 0f, 140, default(Color), 0.75f);
					Main.dust[num7].noGravity = true;
					Main.dust[num7].fadeIn = 1.5f;
					Main.dust[num7].velocity *= 0.3f;
					Main.dust[num7].velocity += velocity * 0.2f;
					Main.dust[num7].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
			}
			if (head == 6 && body == 6 && legs == 6 && CanSpawnWalkingEffects() && !rocketFrame)
			{
				for (int i = 0; i < 2; i++)
				{
					int num8 = Dust.NewDust(new Vector2(position.X - velocity.X * 2f, position.Y - 2f - velocity.Y * 2f), width, height, 6, 0f, 0f, 100, default(Color), 2f);
					Main.dust[num8].noGravity = true;
					Main.dust[num8].noLight = true;
					Main.dust[num8].velocity.X -= velocity.X * 0.5f;
					Main.dust[num8].velocity.Y -= velocity.Y * 0.5f;
					Main.dust[num8].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
			}
			if (head == 8 && body == 8 && legs == 8 && CanSpawnWalkingEffects())
			{
				int num9 = Dust.NewDust(new Vector2(position.X - velocity.X * 2f, position.Y - 2f - velocity.Y * 2f), width, height, 40, 0f, 0f, 50, default(Color), 1.4f);
				Main.dust[num9].noGravity = true;
				Main.dust[num9].velocity.X = velocity.X * 0.25f;
				Main.dust[num9].velocity.Y = velocity.Y * 0.25f;
				Main.dust[num9].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
			}
			if (head == 9 && body == 9 && legs == 9 && CanSpawnWalkingEffects() && !rocketFrame)
			{
				for (int j = 0; j < 2; j++)
				{
					int num10 = Dust.NewDust(new Vector2(position.X - velocity.X * 2f, position.Y - 2f - velocity.Y * 2f), width, height, 6, 0f, 0f, 100, default(Color), 2f);
					Main.dust[num10].noGravity = true;
					Main.dust[num10].noLight = true;
					Main.dust[num10].velocity.X -= velocity.X * 0.5f;
					Main.dust[num10].velocity.Y -= velocity.Y * 0.5f;
					Main.dust[num10].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
			}
			if (body == 18 && legs == 17 && (head == 32 || head == 33 || head == 34) && Main.rand.Next(10) == 0)
			{
				int num11 = Dust.NewDust(new Vector2(position.X - velocity.X * 2f, position.Y - 2f - velocity.Y * 2f), width, height, 43, 0f, 0f, 100, default(Color), 0.3f);
				Main.dust[num11].fadeIn = 0.8f;
				Main.dust[num11].velocity *= 0f;
				Main.dust[num11].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
			}
			if ((body == 24 || body == 229) && (legs == 23 || legs == 212) && (head == 43 || head == 41 || head == 42 || head == 254 || head == 255 || head == 256 || head == 257 || head == 258) && CanSpawnWalkingEffects() && velocity.Y != 0f && Main.rand.Next(10) == 0)
			{
				int num12 = Dust.NewDust(new Vector2(position.X - velocity.X * 2f, position.Y - 2f - velocity.Y * 2f), width, height, 43, 0f, 0f, 100, default(Color), 0.3f);
				Main.dust[num12].fadeIn = 0.8f;
				Main.dust[num12].velocity *= 0f;
				Main.dust[num12].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
			}
			if (body == 36 && head == 56 && CanSpawnWalkingEffects() && velocity.Y == 0f)
			{
				for (int k = 0; k < 2; k++)
				{
					int num13 = Dust.NewDust(new Vector2(position.X, position.Y + (float)((gravDir == 1f) ? (height - 2) : (-4))), width, 6, 106, 0f, 0f, 100, default(Color), 0.1f);
					Main.dust[num13].fadeIn = 1f;
					Main.dust[num13].noGravity = true;
					Main.dust[num13].velocity *= 0.2f;
					Main.dust[num13].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
			}
			if (body == 27 && head == 46 && legs == 26 && CanSpawnWalkingEffects() && velocity.Y == 0f && miscCounter % 2 == 0)
			{
				for (int l = 0; l < 2; l++)
				{
					int num14 = ((l != 0) ? Dust.NewDust(new Vector2(position.X + (float)(width / 2), position.Y + (float)height + gfxOffY), width / 2, 6, 76, 0f, 0f, 0, default(Color), 1.35f) : Dust.NewDust(new Vector2(position.X, position.Y + (float)height + gfxOffY), width / 2, 6, 76, 0f, 0f, 0, default(Color), 1.35f));
					Main.dust[num14].scale *= 1f + (float)Main.rand.Next(20, 40) * 0.01f;
					Main.dust[num14].noGravity = true;
					Main.dust[num14].noLight = true;
					Main.dust[num14].velocity *= 0.001f;
					Main.dust[num14].velocity.Y -= 0.003f;
					Main.dust[num14].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
			}
		}
		drawingFootball = false;
		if (ShouldDrawFootball())
		{
			SetCompositeArmBack(enabled: true, CompositeArmStretchAmount.Full, (float)Math.PI / 10f * (float)direction * -1f);
			drawingFootball = true;
		}
		Item.GetDrawHitbox(HeldItem.type, this);
		bool flag5 = CanVisuallyHoldItem(HeldItem);
		bool flag6 = HeldItem.useStyle != 10 && HeldItem.useStyle != 14 && HeldItem.useStyle != 15;
		bool flag7 = false;
		if (mount.Active)
		{
			if (!MountID.Sets.DoesNotOverrideLegFrames[mount.Type])
			{
				flag7 = true;
				legFrameCounter = 0.0;
				legFrame.Y = legFrame.Height * 6;
				if (mount.Type == 23 || mount.Type == 45 || mount.Type == 48)
				{
					ref Rectangle reference = ref legFrame;
					_ = legFrame;
					reference.Y = 0;
				}
			}
			if (velocity.Y != 0f && mount.RunningGraceTime <= 0)
			{
				if (mount.FlyTime > 0 && jump == 0 && controlJump && !mount.CanHover())
				{
					if (mount.Type == 0)
					{
						if (direction > 0)
						{
							if (Main.rand.Next(4) == 0)
							{
								int num15 = Dust.NewDust(new Vector2(base.Center.X - 22f, position.Y + (float)height - 6f), 20, 10, 64, velocity.X * 0.25f, velocity.Y * 0.25f, 255);
								Main.dust[num15].velocity *= 0.1f;
								Main.dust[num15].noLight = true;
							}
							if (Main.rand.Next(4) == 0)
							{
								int num16 = Dust.NewDust(new Vector2(base.Center.X + 12f, position.Y + (float)height - 6f), 20, 10, 64, velocity.X * 0.25f, velocity.Y * 0.25f, 255);
								Main.dust[num16].velocity *= 0.1f;
								Main.dust[num16].noLight = true;
							}
						}
						else
						{
							if (Main.rand.Next(4) == 0)
							{
								int num17 = Dust.NewDust(new Vector2(base.Center.X - 32f, position.Y + (float)height - 6f), 20, 10, 64, velocity.X * 0.25f, velocity.Y * 0.25f, 255);
								Main.dust[num17].velocity *= 0.1f;
								Main.dust[num17].noLight = true;
							}
							if (Main.rand.Next(4) == 0)
							{
								int num18 = Dust.NewDust(new Vector2(base.Center.X + 2f, position.Y + (float)height - 6f), 20, 10, 64, velocity.X * 0.25f, velocity.Y * 0.25f, 255);
								Main.dust[num18].velocity *= 0.1f;
								Main.dust[num18].noLight = true;
							}
						}
					}
					mount.TryBeginningFlight(this, 3);
					mount.UpdateFrame(this, 3, velocity);
					mount.TryLanding(this);
				}
				else if (wet)
				{
					mount.UpdateFrame(this, 4, velocity);
				}
				else
				{
					mount.TryBeginningFlight(this, 2);
					mount.UpdateFrame(this, 2, velocity);
					mount.TryLanding(this);
				}
			}
			else
			{
				mount.UpdateFrame(this, mount.GetIntendedGroundedFrame(this), velocity);
			}
		}
		if (!flag7 && legs != 140)
		{
			if (swimTime > 0)
			{
				legFrameCounter += 2.0;
				while (legFrameCounter > 8.0)
				{
					legFrameCounter -= 8.0;
					legFrame.Y += legFrame.Height;
				}
				if (legFrame.Y < legFrame.Height * 7)
				{
					legFrame.Y = legFrame.Height * 19;
				}
				else if (legFrame.Y > legFrame.Height * 19)
				{
					legFrame.Y = legFrame.Height * 7;
				}
			}
			else if (velocity.Y != 0f || grappling[0] > -1)
			{
				legFrameCounter = 0.0;
				legFrame.Y = legFrame.Height * 5;
				if ((wings == 22 || wings == 28 || wings == 45) && ShouldDrawWingsThatAreAlwaysAnimated())
				{
					legFrame.Y = 0;
				}
			}
			else if (velocity.X != 0f)
			{
				bool flag8 = mount.Type >= 0 && MountID.Sets.IsRollerSkates[mount.Type];
				if ((slippy || slippy2 || windPushed || flag8) && !controlLeft && !controlRight)
				{
					legFrameCounter = 0.0;
					ref Rectangle reference2 = ref legFrame;
					_ = legFrame;
					reference2.Y = 0;
				}
				else
				{
					double num19 = (double)Math.Abs(velocity.X) * 1.3;
					if (flag8 && Math.Abs(velocity.X) >= maxRunSpeed)
					{
						num19 = 2.0;
					}
					legFrameCounter += num19;
					while (legFrameCounter > 8.0)
					{
						legFrameCounter -= 8.0;
						legFrame.Y += legFrame.Height;
					}
					if (legFrame.Y < legFrame.Height * 7)
					{
						legFrame.Y = legFrame.Height * 19;
					}
					else if (legFrame.Y > legFrame.Height * 19)
					{
						legFrame.Y = legFrame.Height * 7;
					}
				}
			}
			else
			{
				legFrameCounter = 0.0;
				ref Rectangle reference3 = ref legFrame;
				_ = legFrame;
				reference3.Y = 0;
			}
		}
		if (carpetFrame >= 0)
		{
			legFrameCounter = 0.0;
			ref Rectangle reference4 = ref legFrame;
			_ = legFrame;
			reference4.Y = 0;
		}
		if (sandStorm)
		{
			if (grappling[0] >= 0)
			{
				sandStorm = false;
			}
			if (miscCounter % 4 == 0 && itemAnimation == 0)
			{
				ChangeDir(direction * -1);
			}
			legFrameCounter = 0.0;
			ref Rectangle reference5 = ref legFrame;
			_ = legFrame;
			reference5.Y = 0;
		}
		else if (itemAnimation > 0 && flag6)
		{
			if (inventory[selectedItem].useStyle == 1 || inventory[selectedItem].type == 0)
			{
				if ((double)itemAnimation < (double)itemAnimationMax * 0.333)
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
				else if ((double)itemAnimation < (double)itemAnimationMax * 0.666)
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height;
				}
			}
			else if (inventory[selectedItem].useStyle == 7)
			{
				if ((double)itemAnimation > (double)itemAnimationMax * 0.5)
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
			}
			else if (inventory[selectedItem].useStyle == 2)
			{
				bodyFrame.Y = bodyFrame.Height * 3;
			}
			else if (inventory[selectedItem].useStyle == 11)
			{
				if ((double)itemAnimation > (double)itemAnimationMax * 0.5)
				{
					bodyFrame.Y = bodyFrame.Height * 4;
				}
				else if ((double)itemAnimation > (double)itemAnimationMax * 0.15)
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
			}
			else if (inventory[selectedItem].useStyle == 9)
			{
				bodyFrame.Y = 0;
			}
			else if (inventory[selectedItem].useStyle == 6)
			{
				float num20 = 1f - (float)itemAnimation / (float)itemAnimationMax;
				num20 *= 6f;
				if (num20 > 1f)
				{
					num20 = 1f;
				}
				if (num20 >= 0.5f)
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
			}
			else if (inventory[selectedItem].useStyle == 3)
			{
				if ((double)itemAnimation > (double)itemAnimationMax * 0.666)
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
			}
			else if (inventory[selectedItem].useStyle == 4)
			{
				bodyFrame.Y = bodyFrame.Height * 2;
			}
			else if (inventory[selectedItem].useStyle == 8)
			{
				bodyFrame.Y = 0;
			}
			else if (inventory[selectedItem].useStyle == 12)
			{
				bodyFrame.Y = bodyFrame.Height * 3;
			}
			else if (inventory[selectedItem].useStyle == 13)
			{
				if ((double)itemAnimation < (double)itemAnimationMax * 0.333)
				{
					bodyFrame.Y = bodyFrame.Height * 3;
				}
				else if ((double)itemAnimation < (double)itemAnimationMax * 0.666)
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height;
				}
			}
			else if (inventory[selectedItem].useStyle == 5)
			{
				if (inventory[selectedItem].type == 281 || inventory[selectedItem].type == 986)
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
				else
				{
					float num21 = itemRotation * (float)direction;
					bodyFrame.Y = bodyFrame.Height * 3;
					if ((double)num21 < -0.75)
					{
						bodyFrame.Y = bodyFrame.Height * 2;
						if (gravDir == -1f)
						{
							bodyFrame.Y = bodyFrame.Height * 4;
						}
					}
					if ((double)num21 > 0.6)
					{
						bodyFrame.Y = bodyFrame.Height * 4;
						if (gravDir == -1f)
						{
							bodyFrame.Y = bodyFrame.Height * 2;
						}
					}
				}
			}
		}
		else if (pulley)
		{
			if (pulleyDir == 2)
			{
				bodyFrame.Y = bodyFrame.Height;
			}
			else
			{
				bodyFrame.Y = bodyFrame.Height * 2;
			}
		}
		else if (flag5 && inventory[selectedItem].holdStyle == 1 && (!wet || !inventory[selectedItem].noWet) && (!happyFunTorchTime || inventory[selectedItem].createTile != 4))
		{
			bodyFrame.Y = bodyFrame.Height * 3;
		}
		else if (flag5 && inventory[selectedItem].holdStyle == 2 && (!wet || !inventory[selectedItem].noWet))
		{
			bodyFrame.Y = bodyFrame.Height * 2;
		}
		else if (flag5 && inventory[selectedItem].holdStyle == 3)
		{
			bodyFrame.Y = bodyFrame.Height * 3;
		}
		else if (flag5 && inventory[selectedItem].holdStyle == 5)
		{
			bodyFrame.Y = bodyFrame.Height * 3;
		}
		else if (flag5 && inventory[selectedItem].holdStyle == 7)
		{
			bodyFrame.Y = bodyFrame.Height * 11;
		}
		else if (flag5 && inventory[selectedItem].holdStyle == 4 && velocity.Y == 0f && gravDir == 1f)
		{
			ref Rectangle reference6 = ref bodyFrame;
			_ = bodyFrame;
			reference6.Y = 0;
		}
		else if (shieldRaised)
		{
			bodyFrame.Y = bodyFrame.Height * 10;
		}
		else if (mount.Active && !MountID.Sets.DoesNotOverrideBodyFrames[mount.Type])
		{
			bodyFrameCounter = 0.0;
			bodyFrame.Y = bodyFrame.Height * mount.BodyFrame;
		}
		else if (grappling[0] >= 0)
		{
			sandStorm = false;
			CancelAllJumpVisualEffects();
			Vector2 vector = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
			float num22 = 0f;
			float num23 = 0f;
			for (int m = 0; m < grapCount; m++)
			{
				num22 += Main.projectile[grappling[m]].position.X + (float)(Main.projectile[grappling[m]].width / 2);
				num23 += Main.projectile[grappling[m]].position.Y + (float)(Main.projectile[grappling[m]].height / 2);
			}
			num22 /= (float)grapCount;
			num23 /= (float)grapCount;
			num22 -= vector.X;
			num23 -= vector.Y;
			if (num23 < 0f && Math.Abs(num23) > Math.Abs(num22))
			{
				bodyFrame.Y = bodyFrame.Height * 2;
				if (gravDir == -1f)
				{
					bodyFrame.Y = bodyFrame.Height * 4;
				}
			}
			else if (num23 > 0f && Math.Abs(num23) > Math.Abs(num22))
			{
				bodyFrame.Y = bodyFrame.Height * 4;
				if (gravDir == -1f)
				{
					bodyFrame.Y = bodyFrame.Height * 2;
				}
			}
			else
			{
				bodyFrame.Y = bodyFrame.Height * 3;
			}
		}
		else if (wet && ShouldFloatInWater)
		{
			bodyFrame.Y = bodyFrame.Height * 10;
		}
		else if (swimTime > 0)
		{
			if (swimTime > 20)
			{
				ref Rectangle reference7 = ref bodyFrame;
				_ = bodyFrame;
				reference7.Y = 0;
			}
			else if (swimTime > 10)
			{
				bodyFrame.Y = bodyFrame.Height * 5;
			}
			else
			{
				ref Rectangle reference8 = ref bodyFrame;
				_ = bodyFrame;
				reference8.Y = 0;
			}
		}
		else if (velocity.Y != 0f)
		{
			if (sliding)
			{
				bodyFrame.Y = bodyFrame.Height * 3;
			}
			else if (sandStorm || carpetFrame >= 0)
			{
				bodyFrame.Y = bodyFrame.Height * 6;
			}
			else if (eocDash > 0)
			{
				bodyFrame.Y = bodyFrame.Height * 6;
			}
			else if (wings > 0)
			{
				if (wings == 22 || wings == 28 || wings == 45)
				{
					bodyFrame.Y = 0;
				}
				else if (velocity.Y > 0f)
				{
					if (controlJump)
					{
						bodyFrame.Y = bodyFrame.Height * 6;
					}
					else
					{
						bodyFrame.Y = bodyFrame.Height * 5;
					}
				}
				else
				{
					bodyFrame.Y = bodyFrame.Height * 6;
				}
			}
			else
			{
				bodyFrame.Y = bodyFrame.Height * 5;
			}
			bodyFrameCounter = 0.0;
		}
		else if (velocity.X != 0f)
		{
			if (legs == 140)
			{
				bodyFrameCounter += Math.Abs(velocity.X) * 0.5f;
				while (bodyFrameCounter > 8.0)
				{
					bodyFrameCounter -= 8.0;
					bodyFrame.Y += bodyFrame.Height;
				}
				if (bodyFrame.Y < bodyFrame.Height * 7)
				{
					bodyFrame.Y = bodyFrame.Height * 19;
				}
				else if (bodyFrame.Y > bodyFrame.Height * 19)
				{
					bodyFrame.Y = bodyFrame.Height * 7;
				}
			}
			else
			{
				bodyFrameCounter += (double)Math.Abs(velocity.X) * 1.5;
				bodyFrame.Y = legFrame.Y;
			}
		}
		else
		{
			bodyFrameCounter = 0.0;
			ref Rectangle reference9 = ref bodyFrame;
			_ = bodyFrame;
			reference9.Y = 0;
		}
		if (legs == 140)
		{
			legFrameCounter = 0.0;
			legFrame.Y = legFrame.Height * (velocity.Y != 0f).ToInt();
			int num24 = bodyFrame.Y / bodyFrame.Height;
			if (Main.OffsetsPlayerHeadgear[num24].Y == 0f)
			{
				legFrame.Y = legFrame.Height * 7;
			}
			if (wings == 22 || wings == 28)
			{
				legFrame.Y = 0;
			}
		}
		if (legs == 217 && (sitting.isSitting || sleeping.isSleeping))
		{
			legFrameCounter = 0.0;
			legFrame.Y = legFrame.Height * 5;
		}
		if (head == 259 && !skipAnimatingValuesInPlayerFrame)
		{
			rabbitOrderFrame.Update();
		}
	}

	private void CancelAllJumpVisualEffects(bool includeDownDash = true)
	{
		if (includeDownDash)
		{
			isPerformingJump_DownDash = false;
		}
		isPerformingJump_Cloud = false;
		isPerformingJump_Sandstorm = false;
		isPerformingJump_Blizzard = false;
		isPerformingJump_Fart = false;
		isPerformingJump_Sail = false;
		isPerformingJump_Unicorn = false;
		isPerformingJump_Santank = false;
	}

	private void CancelAllBootRunVisualEffects()
	{
		sailDash = false;
		coldDash = false;
		desertDash = false;
		fairyBoots = false;
		hellfireTreads = false;
	}

	private void UpdateFishingBobber(Item item)
	{
		switch (item.type)
		{
		case 5139:
			overrideFishingBobber = 986;
			break;
		case 5140:
			overrideFishingBobber = 987;
			break;
		case 5141:
			overrideFishingBobber = 988;
			break;
		case 5142:
			overrideFishingBobber = 989;
			break;
		case 5143:
			overrideFishingBobber = 990;
			break;
		case 5144:
			overrideFishingBobber = 991;
			break;
		case 5145:
			overrideFishingBobber = 992;
			break;
		case 5146:
			overrideFishingBobber = 993;
			break;
		}
	}

	private void UpdateBootVisualEffects(Item item)
	{
		switch (item.type)
		{
		case 128:
			vanityRocketBoots = 1;
			break;
		case 54:
			CancelAllBootRunVisualEffects();
			break;
		case 405:
		case 898:
			CancelAllBootRunVisualEffects();
			vanityRocketBoots = 2;
			break;
		case 4874:
			CancelAllBootRunVisualEffects();
			vanityRocketBoots = 5;
			hellfireTreads = true;
			break;
		case 1862:
			CancelAllBootRunVisualEffects();
			vanityRocketBoots = 3;
			break;
		case 5000:
			CancelAllBootRunVisualEffects();
			vanityRocketBoots = 4;
			break;
		case 3200:
		case 3990:
			CancelAllBootRunVisualEffects();
			sailDash = true;
			break;
		case 1579:
			CancelAllBootRunVisualEffects();
			coldDash = true;
			break;
		case 4055:
			CancelAllBootRunVisualEffects();
			desertDash = true;
			break;
		case 3993:
			CancelAllBootRunVisualEffects();
			fairyBoots = true;
			vanityRocketBoots = 2;
			break;
		}
	}

	private void UpdateVisibleAccessories()
	{
		for (int i = 3; i < 10; i++)
		{
			if (!IsItemSlotUnlockedAndUsable(i))
			{
				continue;
			}
			Item item = armor[i];
			if (eocDash > 0 && shield == -1 && item.shieldSlot != -1)
			{
				shield = item.shieldSlot;
				if (cShieldFallback != -1)
				{
					cShield = cShieldFallback;
				}
			}
			if (shieldRaised && shield == -1 && item.shieldSlot != -1)
			{
				shield = item.shieldSlot;
				if (cShieldFallback != -1)
				{
					cShield = cShieldFallback;
				}
			}
			if (ItemIsVisuallyIncompatible(item))
			{
				continue;
			}
			if (item.wingSlot > 0)
			{
				if (hideVisibleAccessory[i] && (velocity.Y == 0f || mount.Active))
				{
					continue;
				}
				wings = item.wingSlot;
			}
			if (!hideVisibleAccessory[i])
			{
				UpdateVisibleAccessory(i, item);
			}
		}
		for (int j = 13; j < 20; j++)
		{
			if (IsItemSlotUnlockedAndUsable(j))
			{
				Item item2 = armor[j];
				if (!ItemIsVisuallyIncompatible(item2))
				{
					UpdateVisibleAccessory(j, item2);
				}
			}
		}
		int type = HeldItem.type;
		if (type == 4760 && ownedProjectileCounts[866] < 1)
		{
			shield = 9;
			cShield = 0;
		}
		if (mount.Active)
		{
			switch (mount.Type)
			{
			case 57:
				shoe = 27;
				cShoe = cMount;
				break;
			case 58:
				shoe = 28;
				cShoe = cMount;
				break;
			case 59:
				shoe = 29;
				cShoe = cMount;
				break;
			case 60:
				shoe = 30;
				cShoe = cMount;
				break;
			}
		}
	}

	private bool ItemIsVisuallyIncompatible(Item item)
	{
		if (compositeBackArm.enabled && item.shieldSlot > 0)
		{
			return true;
		}
		if (item.shieldSlot > 0 && ItemID.Sets.IsFood[HeldItem.type])
		{
			return true;
		}
		if (body == 96 && item.backSlot > 0 && item.backSlot < ArmorIDs.Back.Count && ArmorIDs.Back.Sets.DrawInTailLayer[item.backSlot])
		{
			return true;
		}
		if (legs > 0 && ArmorIDs.Legs.Sets.IncompatibleWithFrogLeg[legs] && item.shoeSlot == 15)
		{
			return true;
		}
		if (item.balloonSlot == 18 && (body == 93 || body == 83))
		{
			return true;
		}
		return false;
	}

	private bool IsVisibleCapeBad(int accFrontSlot)
	{
		if ((uint)(accFrontSlot - 1) <= 4u || accFrontSlot == 8)
		{
			return true;
		}
		return false;
	}

	private void UpdateVisibleAccessory(int itemSlot, Item item)
	{
		if (item.type == 5540 || item.type == 5541)
		{
			stringColor = 29;
		}
		if (item.stringColor > 0)
		{
			stringColor = item.stringColor;
		}
		if (item.handOnSlot > 0)
		{
			handon = item.handOnSlot;
		}
		if (item.handOffSlot > 0)
		{
			handoff = item.handOffSlot;
		}
		if (item.backSlot > 0)
		{
			if (ArmorIDs.Back.Sets.DrawInBackpackLayer[item.backSlot])
			{
				backpack = item.backSlot;
			}
			else if (ArmorIDs.Back.Sets.DrawInTailLayer[item.backSlot])
			{
				tail = item.backSlot;
			}
			else
			{
				back = item.backSlot;
				front = -1;
			}
		}
		if (item.frontSlot > 0)
		{
			front = item.frontSlot;
		}
		if (sitting.isSitting)
		{
			back = -1;
		}
		if (item.shoeSlot > 0)
		{
			shoe = item.shoeSlot;
			if (!Male && ArmorIDs.Shoe.Sets.MaleToFemaleID[shoe] > 0)
			{
				shoe = (sbyte)ArmorIDs.Shoe.Sets.MaleToFemaleID[shoe];
			}
		}
		if (item.waistSlot > 0)
		{
			waist = item.waistSlot;
		}
		if (item.shieldSlot > 0)
		{
			shield = item.shieldSlot;
		}
		if (item.neckSlot > 0)
		{
			neck = item.neckSlot;
		}
		if (item.faceSlot > 0)
		{
			if (ArmorIDs.Face.Sets.DrawInFaceHeadLayer[item.faceSlot])
			{
				faceHead = item.faceSlot;
			}
			else if (ArmorIDs.Face.Sets.DrawInFaceMaskLayer[item.faceSlot])
			{
				faceMask = item.faceSlot;
			}
			else if (ArmorIDs.Face.Sets.DrawInFaceFlowerLayer[item.faceSlot])
			{
				faceFlower = item.faceSlot;
			}
			else
			{
				face = item.faceSlot;
			}
		}
		if (item.balloonSlot > 0)
		{
			if (ArmorIDs.Balloon.Sets.DrawInFrontOfBackArmLayer[item.balloonSlot])
			{
				balloonFront = item.balloonSlot;
			}
			else
			{
				balloon = item.balloonSlot;
			}
		}
		if (item.beardSlot > 0)
		{
			beard = item.beardSlot;
		}
		if (item.wingSlot > 0)
		{
			wings = item.wingSlot;
		}
		if (item.type == 3580)
		{
			yoraiz0rEye = itemSlot - 2;
		}
		if (item.type == 3581)
		{
			yoraiz0rDarkness = true;
		}
		if (item.type == 3929)
		{
			leinforsHair = true;
		}
		if (item.type == 4404)
		{
			hasFloatingTube = true;
		}
		if (item.type == 4563)
		{
			hasUnicornHorn = true;
		}
		if (item.type == 1987)
		{
			hasAngelHalo = true;
		}
		if (item.type == 5075)
		{
			hasRainbowCursor = true;
		}
		if (item.type == 5587)
		{
			coat = 251;
		}
	}

	public void SetArmorEffectVisuals(Player drawPlayer)
	{
		if (drawPlayer.head == 111 && drawPlayer.body == 73 && drawPlayer.legs == 62)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.head == 134 && drawPlayer.body == 95 && drawPlayer.legs == 79)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.head == 107 && drawPlayer.body == 69 && drawPlayer.legs == 58)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 108 && drawPlayer.body == 70 && drawPlayer.legs == 59)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 109 && drawPlayer.body == 71 && drawPlayer.legs == 60)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 110 && drawPlayer.body == 72 && drawPlayer.legs == 61)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 193 && drawPlayer.body == 194 && drawPlayer.legs == 134)
		{
			armorEffectDrawShadowSubtle = true;
			armorEffectDrawShadowLokis = true;
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.mount.Active && drawPlayer.mount.Type == 3 && drawPlayer.velocity.Y != 0f && !drawPlayer.SlimeDontHyperJump)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.mount.Active && drawPlayer.mount.Type == 10 && Math.Abs(drawPlayer.velocity.X) > drawPlayer.mount.DashSpeed - drawPlayer.mount.RunSpeed / 2f)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.mount.Active && drawPlayer.mount.Type == 44 && Math.Abs(drawPlayer.velocity.X) > drawPlayer.mount.DashSpeed - drawPlayer.mount.RunSpeed / 4f)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.mount.Active && drawPlayer.mount.Type == 45 && Math.Abs(drawPlayer.velocity.X) > drawPlayer.mount.DashSpeed * 0.9f)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.mount.Active && drawPlayer.mount.Type == 14 && Math.Abs(drawPlayer.velocity.X) > drawPlayer.mount.RunSpeed / 2f)
		{
			armorEffectDrawShadowBasilisk = true;
		}
		if (drawPlayer.mount.Active && drawPlayer.mount.Type == 48)
		{
			armorEffectDrawOutlines = true;
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.isPerformingJump_DownDash)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.body == 67 && drawPlayer.legs == 56 && drawPlayer.head >= 103 && drawPlayer.head <= 105)
		{
			armorEffectDrawShadow = true;
		}
		if ((drawPlayer.head == 80 || drawPlayer.head == 79 || drawPlayer.head == 78 || drawPlayer.head == 283) && drawPlayer.body == 51 && drawPlayer.legs == 47)
		{
			armorEffectDrawShadowSubtle = true;
		}
		if (drawPlayer.head == 200 && drawPlayer.body == 198 && drawPlayer.legs == 142)
		{
			armorEffectDrawShadowLokis = true;
			armorEffectDrawOutlinesForbidden = true;
		}
		if (drawPlayer.head == 171 && drawPlayer.body == 177 && drawPlayer.legs == 112)
		{
			armorEffectDrawShadow = true;
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.head == 169 && drawPlayer.body == 175 && drawPlayer.legs == 110)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 170 && drawPlayer.body == 176 && drawPlayer.legs == 111)
		{
			armorEffectDrawShadowLokis = true;
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.body == 209 && drawPlayer.legs == 159)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.eocDash > 0)
		{
			armorEffectDrawShadowEOCShield = true;
		}
		else if (drawPlayer.dashDelay < 0)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 5 && drawPlayer.body == 5 && drawPlayer.legs == 5)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 74 && drawPlayer.body == 48 && drawPlayer.legs == 44)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 76 && drawPlayer.body == 49 && drawPlayer.legs == 45)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 7 && drawPlayer.body == 7 && drawPlayer.legs == 7)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 22 && drawPlayer.body == 14 && drawPlayer.legs == 14)
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.dye[0].dye == 30 && drawPlayer.dye[1].dye == 30 && drawPlayer.dye[2].dye == 30 && drawPlayer.head == 4 && drawPlayer.body == 27 && drawPlayer.legs == 26)
		{
			armorEffectDrawShadow = true;
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.head == 189 && drawPlayer.body == 190 && drawPlayer.legs == 130)
		{
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.body == 17 && drawPlayer.legs == 16 && (drawPlayer.head == 29 || drawPlayer.head == 30 || drawPlayer.head == 31))
		{
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.body == 19 && drawPlayer.legs == 18 && (drawPlayer.head == 35 || drawPlayer.head == 36 || drawPlayer.head == 37))
		{
			armorEffectDrawOutlines = true;
		}
		if ((drawPlayer.body == 24 || drawPlayer.body == 229) && (drawPlayer.legs == 23 || drawPlayer.legs == 212) && (drawPlayer.head == 43 || drawPlayer.head == 41 || drawPlayer.head == 42 || drawPlayer.head == 254 || drawPlayer.head == 255 || drawPlayer.head == 256 || drawPlayer.head == 257 || drawPlayer.head == 258))
		{
			armorEffectDrawOutlines = true;
			armorEffectDrawShadow = true;
		}
		if (drawPlayer.head == 157 && drawPlayer.legs == 98 && drawPlayer.body != 105)
		{
			_ = drawPlayer.body;
			_ = 106;
		}
		if (drawPlayer.body == 36 && drawPlayer.head == 56)
		{
			armorEffectDrawOutlines = true;
		}
		if (drawPlayer.head == 267)
		{
			yoraiz0rDarkness = true;
		}
		if (drawPlayer.stoned || drawPlayer.stealth != 1f)
		{
			armorEffectDrawOutlines = false;
			armorEffectDrawShadow = false;
			armorEffectDrawShadowSubtle = false;
		}
	}

	public static int SetMatch(SetMatchRequest request, ref bool somethingSpecial)
	{
		int armorSlotRequested = request.ArmorSlotRequested;
		int num = -1;
		bool male = request.Male;
		num = armorSlotRequested switch
		{
			1 => request.Body, 
			2 => request.Legs, 
			_ => request.Head, 
		};
		int num2 = -1;
		if (armorSlotRequested == 0 && num == 201)
		{
			num2 = ((!request.Player.mount.Active || request.Player.mount.Type != 54) ? (male ? 201 : 202) : 201);
		}
		if (armorSlotRequested == 1)
		{
			bool flag = true;
			switch (num)
			{
			case 15:
				num2 = 88;
				break;
			case 36:
				num2 = 89;
				break;
			case 41:
				num2 = 97;
				break;
			case 42:
				num2 = 90;
				break;
			case 58:
				num2 = 91;
				break;
			case 59:
				num2 = 92;
				break;
			case 60:
				num2 = 93;
				break;
			case 61:
				num2 = 94;
				break;
			case 62:
				num2 = 95;
				break;
			case 63:
				num2 = 96;
				break;
			case 77:
				num2 = 121;
				break;
			case 165:
				num2 = ((!male) ? 99 : 118);
				break;
			case 166:
				flag = false;
				num2 = ((!male) ? 100 : 119);
				break;
			case 167:
				num2 = (male ? 101 : 102);
				break;
			case 180:
				num2 = 115;
				break;
			case 181:
				num2 = 116;
				break;
			case 183:
				num2 = (male ? 136 : 123);
				break;
			case 191:
				num2 = 131;
				break;
			case 93:
				num2 = 165;
				break;
			case 90:
				num2 = 166;
				break;
			case 88:
				num2 = 168;
				break;
			case 81:
				if (request.Legs == -1 || request.Legs == 0)
				{
					num2 = 169;
				}
				break;
			case 213:
				num2 = 187;
				break;
			case 215:
				num2 = 189;
				break;
			case 219:
				num2 = 196;
				break;
			case 221:
				num2 = 199;
				break;
			case 223:
				num2 = 204;
				break;
			case 231:
				num2 = 214;
				break;
			case 232:
				num2 = 215;
				break;
			case 233:
				num2 = 216;
				break;
			case 241:
				num2 = 229;
				break;
			case 256:
				num2 = 244;
				break;
			}
			if (num2 != -1)
			{
				somethingSpecial = flag;
			}
		}
		if (armorSlotRequested == 2)
		{
			switch (num)
			{
			case 83:
				if (male)
				{
					num2 = 117;
				}
				break;
			case 84:
				if (male)
				{
					num2 = 120;
				}
				break;
			case 132:
				if (male)
				{
					num2 = 135;
				}
				break;
			case 57:
				if (male)
				{
					num2 = 137;
				}
				break;
			case 180:
				if (!male)
				{
					num2 = 179;
				}
				break;
			case 184:
				if (!male)
				{
					num2 = 183;
				}
				break;
			case 146:
				num2 = (male ? 146 : 147);
				break;
			case 154:
				num2 = (male ? 155 : 154);
				break;
			case 158:
				if (male)
				{
					num2 = 157;
				}
				break;
			case 191:
				if (!male)
				{
					num2 = 192;
				}
				break;
			case 193:
				if (!male)
				{
					num2 = 194;
				}
				break;
			case 197:
				if (!male)
				{
					num2 = 198;
				}
				break;
			case 203:
				if (!male)
				{
					num2 = 202;
				}
				break;
			case 208:
				if (!male)
				{
					num2 = 207;
				}
				break;
			case 219:
				if (!male)
				{
					num2 = 220;
				}
				break;
			case 232:
				if (!male)
				{
					num2 = 233;
				}
				break;
			case 236:
				if (!male)
				{
					num2 = 248;
				}
				break;
			case 249:
				if (!male)
				{
					num2 = 250;
				}
				break;
			}
		}
		return num2;
	}

	public void Teleport(Vector2 newPos, int Style = 0, int extraInfo = 0)
	{
		try
		{
			_funkytownAchievementCheckCooldown = 100;
			environmentBuffImmunityTimer = 4;
			if (Style != 10)
			{
				RemoveAllGrapplingHooks();
			}
			StopVanityActions();
			if (shimmering || shimmerWet)
			{
				shimmering = false;
				shimmerWet = false;
				wet = false;
				ClearBuff(353);
			}
			int extraInfo2 = 0;
			if (Style == 4)
			{
				extraInfo2 = lastPortalColorIndex;
			}
			if (Style == 9)
			{
				lastTeleportPylonStyleUsed = extraInfo;
				extraInfo2 = lastTeleportPylonStyleUsed;
			}
			float num = MathHelper.Clamp(1f - teleportTime * 0.99f, 0.01f, 1f);
			Vector2 vector = position;
			Main.TeleportEffect(getRect(), Style, extraInfo2, num, TeleportationSide.Entry, newPos);
			PressurePlateHelper.UpdatePlayerPosition(this);
			position = newPos;
			netOffset = Vector2.Zero;
			SetOrRequestSpectating(-1);
			DoUnbreakableWallScan();
			if (Style == 8)
			{
				SoundEngine.PlaySound(SoundID.Item6, vector);
				SoundEngine.PlaySound(SoundID.Item6, newPos);
			}
			fallStart = (int)(position.Y / 16f);
			if (whoAmI == Main.myPlayer)
			{
				int lerpSpeedupDelay = 0;
				if (Style == 1)
				{
					lerpSpeedupDelay = 10;
				}
				Main.StartCameraTransitionForPlayerTeleport(vector, 0.1f, lerpSpeedupDelay);
				UpdateBiomesIfMovedEnoughForBlackFade(vector);
				if (num > 0.1f || Style != 0)
				{
					if (Main.mapTime < 5)
					{
						Main.mapTime = 5;
					}
					Main.maxQ = true;
					Main.renderNow = true;
				}
			}
			if (Style == 4)
			{
				lastPortalColorIndex = extraInfo;
				extraInfo2 = lastPortalColorIndex;
				portalPhysicsFlag = true;
				gravity = 0f;
			}
			PressurePlateHelper.UpdatePlayerPosition(this);
			ResetAdvancedShadows();
			for (int i = 0; i < 3; i++)
			{
				UpdateSocialShadow();
			}
			oldPosition = position + BlehOldPositionFixer;
			Main.TeleportEffect(getRect(), Style, extraInfo2, num, TeleportationSide.Exit, vector);
			teleportTime = 1f;
			teleportStyle = Style;
		}
		catch
		{
		}
	}

	public void DoPotionOfReturnTeleportationAndSetTheComebackPoint()
	{
		RemoveAllGrapplingHooks();
		PotionOfReturnOriginalUsePosition = base.Bottom;
		bool flag = immune;
		int num = immuneTime;
		StopVanityActions(multiplayerBroadcast: false);
		Spawn(PlayerSpawnContext.RecallFromItem);
		PotionOfReturnHomePosition = base.Bottom;
		NetMessage.SendData(13, -1, whoAmI, null, whoAmI);
		immune = flag;
		immuneTime = num;
	}

	public void DoPotionOfReturnReturnToOriginalUsePosition()
	{
		if (PotionOfReturnOriginalUsePosition.HasValue)
		{
			Vector2 newPos = PotionOfReturnOriginalUsePosition.Value + base.Size * new Vector2(-0.5f, -1f);
			int num = 8;
			Teleport(newPos, num);
			NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos.X, newPos.Y, num);
			PotionOfReturnOriginalUsePosition = null;
			PotionOfReturnHomePosition = null;
		}
	}

	public void AutoFinchStaff()
	{
		int num = FindItem(4281);
		if (num != -1)
		{
			Item item = inventory[num];
			AddBuff(item.buffType, 3600);
		}
	}

	public void Spawn(PlayerSpawnContext context)
	{
		Main.LocalPlayer.creativeInterface = false;
		_funkytownAchievementCheckCooldown = 100;
		bool flag = false;
		if (context == PlayerSpawnContext.SpawningIntoWorld)
		{
			if (Main.netMode == 0 && unlockedBiomeTorches)
			{
				NPC nPC = new NPC();
				nPC.SetDefaults(664);
				Main.BestiaryTracker.Kills.RegisterKill(nPC);
			}
			if (dead)
			{
				AdjustRespawnTimerForWorldJoining(this);
				if (dead)
				{
					flag = true;
				}
			}
		}
		StopVanityActions();
		if (whoAmI == Main.myPlayer)
		{
			Main.NotifyOfEvent(GameNotificationType.SpawnOrDeath);
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.cameraX = 0f;
			Main.cameraY = 0f;
			if (Main.mapTime < 5)
			{
				Main.mapTime = 5;
			}
			Main.instantBGTransitionCounter = 10;
			FindSpawn();
			if (!CheckSpawn(SpawnX, SpawnY))
			{
				SpawnX = -1;
				SpawnY = -1;
			}
			Main.maxQ = true;
		}
		if (Main.netMode == 1 && whoAmI == Main.myPlayer)
		{
			NetMessage.SendData(12, -1, -1, null, Main.myPlayer, (int)(byte)context);
		}
		headPosition = Vector2.Zero;
		bodyPosition = Vector2.Zero;
		legPosition = Vector2.Zero;
		headRotation = 0f;
		bodyRotation = 0f;
		legRotation = 0f;
		rabbitOrderFrame.Reset();
		lavaTime = lavaMax;
		lavaOpacity = 1f;
		insideUnbreakableWalls = false;
		DoUnbreakableWallScan();
		if (!flag)
		{
			if (statLife <= 0)
			{
				int num = statLifeMax2 / 2;
				statLife = 100;
				if (num > statLife)
				{
					statLife = num;
				}
				breath = breathMax;
				if (spawnMax)
				{
					statLife = statLifeMax2;
					statMana = statManaMax2;
				}
			}
			immune = true;
			dead = false;
			deadTime = 0;
			immuneTime = 0;
		}
		active = true;
		Vector2 spectatingCameraPosition = SpectatingCameraPosition;
		spectating = -1;
		if (SpawnX >= 0 && SpawnY >= 0)
		{
			_ = SpawnX;
			_ = SpawnY;
			Spawn_SetPosition(SpawnX, SpawnY);
		}
		else if (Main.teamBasedSpawnsSeed)
		{
			Spawn_SetPositionAtTeamSpawn(context);
		}
		else
		{
			Spawn_SetPositionAtWorldSpawn();
		}
		wet = false;
		wetCount = 0;
		lavaWet = false;
		netOffset = Vector2.Zero;
		fallStart = (int)(position.Y / 16f);
		fallStart2 = fallStart;
		velocity.X = 0f;
		velocity.Y = 0f;
		ResetAdvancedShadows();
		for (int i = 0; i < 3; i++)
		{
			UpdateSocialShadow();
		}
		oldPosition = position + BlehOldPositionFixer;
		SetTalkNPC(-1);
		if (whoAmI == Main.myPlayer)
		{
			Main.npcChatCornerItem = 0;
		}
		if (!flag)
		{
			if (pvpDeath)
			{
				pvpDeath = false;
				immuneTime = 300;
				statLife = statLifeMax;
			}
			else if (context == PlayerSpawnContext.ReviveFromDeath)
			{
				immuneTime = 180;
			}
			else
			{
				immuneTime = 60;
			}
			if (immuneTime > 0 && !hostile)
			{
				immuneNoBlink = true;
			}
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.StartCameraTransitionForPlayerTeleport(spectatingCameraPosition, 0.1f, 0);
			UpdateBiomesIfMovedEnoughForBlackFade(spectatingCameraPosition);
			if (Main.netMode == 1 && context == PlayerSpawnContext.SpawningIntoWorld)
			{
				Netplay.AddCurrentServerToRecentList();
			}
		}
		if (flag)
		{
			immuneAlpha = 255;
		}
		if (whoAmI == Main.myPlayer && context == PlayerSpawnContext.ReviveFromDeath && difficulty == 3)
		{
			AutoFinchStaff();
		}
		if (whoAmI == Main.myPlayer && context == PlayerSpawnContext.SpawningIntoWorld)
		{
			Main.ReleaseHostAndPlayProcess();
			RefreshItems();
			SetPlayerDataToOutOfClassFields();
			ProcessPendingRefunds();
			Main.LocalGolfState.SetScoreTime();
			Main.ActivePlayerFileData.StartPlayTimer();
			ContentSamples.FixItemsUsingPlayerColours();
			Hooks.EnterWorld(whoAmI);
		}
		if (whoAmI == Main.myPlayer)
		{
			_localMinionRespawner.RestoreMinionsFor(this);
		}
	}

	public bool Spawn_GetPositionAtWorldSpawn(ref int floorX, ref int floorY)
	{
		return Spawn_GetPositionAtSpawn(Main.spawnTileX, Main.spawnTileY, ref floorX, ref floorY);
	}

	public bool Spawn_GetPositionAtSpawn(int spawnX, int spawnY, ref int floorX, ref int floorY)
	{
		int num = spawnY;
		if (!Spawn_IsAreaValidSpawn(spawnX, num))
		{
			bool flag = false;
			if (!flag)
			{
				for (int i = 0; i < 30; i++)
				{
					if (Spawn_IsAreaValidSpawn(spawnX, num - i))
					{
						num -= i;
						flag = true;
						break;
					}
				}
			}
			if (!flag)
			{
				for (int j = 0; j < 30; j++)
				{
					if (Spawn_IsAreaValidSpawn(spawnX, num + j))
					{
						num += j;
						flag = true;
						break;
					}
				}
			}
			if (flag)
			{
				floorX = spawnX;
				floorY = num;
				return true;
			}
			return true;
		}
		num = Spawn_DescendFromDefaultSpace(spawnX, num);
		floorX = spawnX;
		floorY = num;
		return false;
	}

	private void Spawn_SetPositionAtWorldSpawn()
	{
		int floorX = Main.spawnTileX;
		int floorY = Main.spawnTileY;
		bool num = Spawn_GetPositionAtWorldSpawn(ref floorX, ref floorY);
		Spawn_SetPosition(floorX, floorY);
		if (num && !Spawn_IsAreaValidSpawn(floorX, floorY))
		{
			Spawn_ForceClearArea(floorX, floorY);
		}
	}

	public static int Spawn_DescendFromDefaultSpace(int x, int y)
	{
		for (int i = 0; i < 50; i++)
		{
			bool flag = false;
			bool flag2 = false;
			bool flag3 = false;
			for (int j = -1; j <= 1; j++)
			{
				int num = x + j;
				int num2 = y + i;
				if (!WorldGen.InWorld(num, num2, 5) || Main.tile[num, num2] == null || Main.tile[num, num2 - 1] == null)
				{
					continue;
				}
				Tile tile = Main.tile[num, num2];
				_ = Main.tile[num, num2 - 1];
				if (tile.nactive() && ((Main.tileSolid[tile.type] && !Main.tileSolidTop[tile.type]) || TileID.Sets.Platforms[tile.type] || tile.type == 380) && tile.type != 379)
				{
					switch (j)
					{
					case -1:
						flag = true;
						break;
					case 1:
						flag3 = true;
						break;
					default:
						flag2 = true;
						break;
					}
				}
			}
			if (flag2 && (flag || flag3))
			{
				y += i;
				break;
			}
		}
		return y;
	}

	public static void Spawn_ForceClearArea(int floorX, int floorY)
	{
		for (int i = floorX - 1; i < floorX + 2; i++)
		{
			for (int j = floorY - 3; j < floorY; j++)
			{
				if (WorldGen.InWorld(i, j) && Main.tile[i, j] != null)
				{
					if (Main.tile[i, j].nactive() && Main.tileSolid[Main.tile[i, j].type] && !Main.tileSolidTop[Main.tile[i, j].type])
					{
						WorldGen.KillTile(i, j);
					}
					if (Main.tile[i, j].liquid > 0)
					{
						Main.tile[i, j].lava(lava: false);
						Main.tile[i, j].liquid = 0;
						WorldGen.SquareTileFrame(i, j);
					}
				}
			}
		}
	}

	public static bool Spawn_IsAreaValidSpawn(int floorX, int floorY, bool generatingSpawn = false)
	{
		for (int i = floorX - 1; i < floorX + 2; i++)
		{
			for (int j = floorY - 3; j < floorY; j++)
			{
				if (WorldGen.InWorld(i, j) && Main.tile[i, j] != null)
				{
					Tile tile = Main.tile[i, j];
					if (tile.nactive() && Main.tileSolid[tile.type] && !Main.tileSolidTop[tile.type])
					{
						return false;
					}
					if (tile.liquid > 0)
					{
						return false;
					}
					if (generatingSpawn && Main.dualDungeonsSeed && ((tile.active() && DungeonUtils.IsConsideredDungeonTile(tile.type, allDungeons: true)) || DungeonUtils.IsConsideredDungeonWall(tile.wall, allDungeons: true)))
					{
						return false;
					}
				}
			}
		}
		return true;
	}

	private void Spawn_SetPosition(int floorX, int floorY)
	{
		position.X = floorX * 16 + 8 - width / 2;
		position.Y = floorY * 16 - height;
	}

	private void Spawn_SetPositionAtTeamSpawn(PlayerSpawnContext context)
	{
		if (!Main.teamBasedSpawnsSeed)
		{
			return;
		}
		Point spawnPoint = Point.Zero;
		if (ExtraSpawnPointManager.TryGetExtraSpawnPointForTeam(team, out spawnPoint))
		{
			int floorX = spawnPoint.X;
			int floorY = spawnPoint.Y;
			bool num = Spawn_GetPositionAtSpawn(spawnPoint.X, spawnPoint.Y, ref floorX, ref floorY);
			Spawn_SetPosition(floorX, floorY);
			if (num && !Spawn_IsAreaValidSpawn(floorX, floorY))
			{
				Spawn_ForceClearArea(floorX, floorY);
			}
		}
	}

	public void SetImmuneTimeForAllTypes(int time)
	{
		immune = true;
		immuneTime = time;
		for (int i = 0; i < hurtCooldowns.Length; i++)
		{
			hurtCooldowns[i] = time;
		}
	}

	public void ShadowDodge()
	{
		SetImmuneTimeForAllTypes(longInvince ? 120 : 80);
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffTime[i] > 0 && buffType[i] == 59)
			{
				DelBuff(i);
			}
		}
		PutHallowedArmorSetBonusOnCooldown();
		NetMessage.SendData(62, -1, -1, null, whoAmI, 2f);
	}

	private void PutHallowedArmorSetBonusOnCooldown()
	{
		shadowDodgeTimer = 1800;
	}

	public void BrainOfConfusionDodge()
	{
		SetImmuneTimeForAllTypes(longInvince ? 120 : 80);
		brainOfConfusionDodgeAnimationCounter = 300;
		if (whoAmI == Main.myPlayer)
		{
			AddBuff(321, 240);
			NetMessage.SendData(62, -1, -1, null, whoAmI, 4f);
		}
	}

	public void NinjaDodge()
	{
		SetImmuneTimeForAllTypes(longInvince ? 120 : 80);
		for (int i = 0; i < 100; i++)
		{
			int num = Dust.NewDust(new Vector2(position.X, position.Y), width, height, 31, 0f, 0f, 100, default(Color), 2f);
			Main.dust[num].position.X += Main.rand.Next(-20, 21);
			Main.dust[num].position.Y += Main.rand.Next(-20, 21);
			Main.dust[num].velocity *= 0.4f;
			Main.dust[num].scale *= 1f + (float)Main.rand.Next(40) * 0.01f;
			Main.dust[num].shader = GameShaders.Armor.GetSecondaryShader(cWaist, this);
			if (Main.rand.Next(2) == 0)
			{
				Main.dust[num].scale *= 1f + (float)Main.rand.Next(40) * 0.01f;
				Main.dust[num].noGravity = true;
			}
		}
		int num2 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 24f), default(Vector2), Main.rand.Next(61, 64));
		Main.gore[num2].scale = 1.5f;
		Main.gore[num2].velocity.X = (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity.Y = (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity *= 0.4f;
		num2 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 24f), default(Vector2), Main.rand.Next(61, 64));
		Main.gore[num2].scale = 1.5f;
		Main.gore[num2].velocity.X = 1.5f + (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity.Y = 1.5f + (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity *= 0.4f;
		num2 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 24f), default(Vector2), Main.rand.Next(61, 64));
		Main.gore[num2].scale = 1.5f;
		Main.gore[num2].velocity.X = -1.5f - (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity.Y = 1.5f + (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity *= 0.4f;
		num2 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 24f), default(Vector2), Main.rand.Next(61, 64));
		Main.gore[num2].scale = 1.5f;
		Main.gore[num2].velocity.X = 1.5f + (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity.Y = -1.5f - (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity *= 0.4f;
		num2 = Gore.NewGore(new Vector2(position.X + (float)(width / 2) - 24f, position.Y + (float)(height / 2) - 24f), default(Vector2), Main.rand.Next(61, 64));
		Main.gore[num2].scale = 1.5f;
		Main.gore[num2].velocity.X = -1.5f - (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity.Y = -1.5f - (float)Main.rand.Next(-50, 51) * 0.01f;
		Main.gore[num2].velocity *= 0.4f;
		if (whoAmI == Main.myPlayer)
		{
			NetMessage.SendData(62, -1, -1, null, whoAmI, 1f);
		}
	}

	public void ApplyArmorSoundAndDustChanges()
	{
		int num = armor[0].headSlot;
		int num2 = armor[1].bodySlot;
		int num3 = armor[2].legSlot;
		if (armor[10].headSlot >= 0)
		{
			num = armor[10].headSlot;
		}
		if (armor[11].bodySlot >= 0)
		{
			num2 = armor[11].bodySlot;
		}
		if (armor[12].legSlot >= 0)
		{
			num3 = armor[12].legSlot;
		}
		if ((wereWolf || forceWerewolf) && !hideWolf)
		{
			num3 = 20;
			num2 = 21;
			num = 38;
		}
		if ((num == 75 || num == 7) && num2 == 7 && num3 == 7)
		{
			boneArmor = true;
		}
		if (num2 == 27 && num == 46 && num3 == 26)
		{
			frostArmor = true;
		}
	}

	public bool CanDefendWithPaladinsShield(int otherPlayerTeam)
	{
		if (active && !dead && hasPaladinShield && team > 0 && team == otherPlayerTeam)
		{
			return (float)statLife > (float)statLifeMax2 * 0.25f;
		}
		return false;
	}

	public double Hurt(PlayerDeathReason damageSource, int Damage, int hitDirection, bool pvp = false, bool quiet = false, bool Crit = false, int cooldownCounter = -1, bool dodgeable = true)
	{
		if (shimmering && AllowShimmerDodge(damageSource, cooldownCounter, dodgeable))
		{
			return 0.0;
		}
		if (creativeGodMode)
		{
			return 0.0;
		}
		SetOrRequestSpectating(-1);
		bool flag = ((cooldownCounter == ImmunityCooldownID.General) ? (!immune) : (hurtCooldowns[cooldownCounter] <= 0));
		bool flag2 = whoAmI != Main.myPlayer && !pvp;
		if (!flag && !ImmunityCooldownID.Sets.ImmuneTimerOnlyLimitsEffects[cooldownCounter] && !flag2)
		{
			return 0.0;
		}
		if (whoAmI == Main.myPlayer && dodgeable)
		{
			if (blackBelt && Main.rand.Next(10) == 0)
			{
				NinjaDodge();
				return 0.0;
			}
			if (brainOfConfusionItem != null && !brainOfConfusionItem.IsAir && Main.rand.Next(6) == 0 && FindBuffIndex(321) == -1)
			{
				BrainOfConfusionDodge();
				return 0.0;
			}
			if (shadowDodge)
			{
				ShadowDodge();
				return 0.0;
			}
		}
		if (whoAmI == Main.myPlayer && panic)
		{
			AddBuff(63, 480);
		}
		if (whoAmI == Main.myPlayer && setSquireT2)
		{
			AddBuff(205, 300);
		}
		stealth = 1f;
		int num = Damage;
		double num2 = Main.CalculateDamagePlayersTake(num, statDefense);
		if (Crit)
		{
			num *= 2;
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.NotifyOfEvent(GameNotificationType.Damage);
			if (hasFootball)
			{
				for (int i = 0; i < 59; i++)
				{
					if (inventory[i].stack > 0 && inventory[i].type == 4743)
					{
						Projectile.NewProjectile(GetProjectileSource_Misc(12), base.Center, new Vector2(-hitDirection * 4, -6f), 861, 0, 0f, whoAmI, 0f, 1f, inventory[i].stack);
						inventory[i].SetDefaults(0);
						if (i == 58)
						{
							Main.mouseItem = new Item();
						}
					}
				}
			}
		}
		if (inventory[selectedItem].type == 4790 || inventory[selectedItem].type == 4788 || inventory[selectedItem].type == 4789)
		{
			for (int j = 0; j < 1000; j++)
			{
				if (Main.projectile[j].active && Main.projectile[j].owner == whoAmI && (Main.projectile[j].type == 879 || Main.projectile[j].type == 877 || Main.projectile[j].type == 878))
				{
					Main.projectile[j].active = false;
				}
			}
		}
		if (invis)
		{
			int num3 = FindBuffIndex(10);
			if (num3 != -1 && buffTime[num3] > 1)
			{
				int num4 = 3600;
				buffTime[num3] = Math.Max(1, Math.Min(buffTime[num3], buffTime[num3] - num4));
			}
		}
		if (magicCuffs)
		{
			int num5 = num;
			statMana += num5;
			if (statMana > statManaMax2)
			{
				statMana = statManaMax2;
			}
			if (Main.myPlayer == whoAmI)
			{
				ManaEffect(num5);
			}
		}
		num2 = (int)((double)(1f - endurance) * num2);
		if (ImmunityCooldownID.Sets.Counter[cooldownCounter] && ConsumeSolarFlare())
		{
			float num6 = 0.2f;
			num2 = (int)((double)(1f - num6) * num2);
			if (whoAmI == Main.myPlayer)
			{
				IEntitySource spawnSource = GetProjectileSource_SetBonus(1);
				Entity entity = null;
				if (damageSource.TryGetCausingEntity(out entity))
				{
					spawnSource = GetProjectileSource_OnHurt(entity, 1);
				}
				int num7 = Projectile.NewProjectile(spawnSource, base.Center.X, base.Center.Y, 0f, 0f, 608, (int)(150f * meleeDamage), 15f, Main.myPlayer);
				Main.projectile[num7].netUpdate = true;
				Main.projectile[num7].Kill();
			}
		}
		if (beetleDefense && beetleOrbs > 0)
		{
			float num8 = 0.15f * (float)beetleOrbs;
			num2 = (int)((double)(1f - num8) * num2);
			beetleOrbs--;
			for (int k = 0; k < maxBuffs; k++)
			{
				if (buffType[k] >= 95 && buffType[k] <= 97)
				{
					DelBuff(k);
				}
			}
			if (beetleOrbs > 0)
			{
				AddBuff(95 + beetleOrbs - 1, 5);
			}
			beetleCounter = 0f;
		}
		if (defendedByPaladin && ImmunityCooldownID.Sets.TeamDamageShare[cooldownCounter] && num2 >= 4.0 && Damage < 9999)
		{
			Player player = null;
			float num9 = float.MaxValue;
			for (int l = 0; l < 255; l++)
			{
				Player player2 = Main.player[l];
				if (l != whoAmI && player2.CanDefendWithPaladinsShield(team))
				{
					float num10 = player2.Distance(base.Center);
					if (num10 < num9)
					{
						player = player2;
						num9 = num10;
					}
				}
			}
			int damage = (int)(num2 * 0.25);
			if (player != null)
			{
				num2 = (int)(num2 * 0.75);
			}
			if (player == Main.LocalPlayer && num9 < PaladinsShieldRange)
			{
				Main.LocalPlayer.Hurt(PlayerDeathReason.ByOther(20), damage, 0, pvp: false, quiet: false, Crit: false, ImmunityCooldownID.PaladinsShield, dodgeable: false);
			}
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.PaladinsShieldHit, new ParticleOrchestraSettings
			{
				PositionInWorld = new Vector2(whoAmI, player.whoAmI)
			});
		}
		if (Main.netMode == 1 && whoAmI == Main.myPlayer && !quiet)
		{
			if (!noKnockback && hitDirection != 0 && (!mount.Active || !mount.Cart))
			{
				NetMessage.SendData(13, -1, -1, null, whoAmI);
			}
			NetMessage.SendData(16, -1, -1, null, whoAmI);
			NetMessage.SendPlayerHurt(whoAmI, damageSource, Damage, hitDirection, Crit, pvp, cooldownCounter);
		}
		if (num2 < 1.0)
		{
			num2 = 1.0;
		}
		Color color = (Crit ? CombatText.DamagedFriendlyCrit : CombatText.DamagedFriendly);
		CombatText.NewText(new Rectangle((int)position.X, (int)position.Y, width, height), color, (int)num2, Crit);
		statLife -= (int)num2;
		int num11 = (pvp ? 8 : ((num2 != 1.0) ? (longInvince ? 80 : 40) : (longInvince ? 40 : 20)));
		if (cooldownCounter == ImmunityCooldownID.General)
		{
			immune = true;
			immuneTime = num11;
		}
		else if (hurtCooldowns[cooldownCounter] == 0 || flag2)
		{
			hurtCooldowns[cooldownCounter] = num11;
		}
		lifeRegenTime = 0f;
		int? sourceProjectileType = damageSource.SourceProjectileType;
		if (sourceProjectileType.HasValue && ProjectileID.Sets.DismountsPlayersOnHit.IndexInRange(sourceProjectileType.Value) && ProjectileID.Sets.DismountsPlayersOnHit[sourceProjectileType.Value])
		{
			mount.TryDismount(this);
		}
		if (whoAmI == Main.myPlayer && ImmunityCooldownID.Sets.Retaliate[cooldownCounter] && flag)
		{
			if (brainOfConfusionItem != null && !brainOfConfusionItem.IsAir)
			{
				for (int m = 0; m < Main.maxNPCs; m++)
				{
					if (!Main.npc[m].active || Main.npc[m].friendly)
					{
						continue;
					}
					int num12 = 300;
					num12 += (int)num2 * 2;
					if (Main.rand.Next(500) < num12)
					{
						float num13 = (Main.npc[m].Center - base.Center).Length();
						float num14 = Main.rand.Next(200 + (int)num2 / 2, 301 + (int)num2 * 2);
						if (num14 > 500f)
						{
							num14 = 500f + (num14 - 500f) * 0.75f;
						}
						if (num14 > 700f)
						{
							num14 = 700f + (num14 - 700f) * 0.5f;
						}
						if (num14 > 900f)
						{
							num14 = 900f + (num14 - 900f) * 0.25f;
						}
						if (num13 < num14)
						{
							float num15 = Main.rand.Next(90 + (int)num2 / 3, 300 + (int)num2 / 2);
							Main.npc[m].AddBuff(31, (int)num15);
						}
					}
				}
				Projectile.NewProjectile(GetProjectileSource_Accessory(brainOfConfusionItem), base.Center.X + (float)Main.rand.Next(-40, 40), base.Center.Y - (float)Main.rand.Next(20, 60), velocity.X * 0.3f, velocity.Y * 0.3f, 565, 0, 0f, whoAmI);
			}
			if (starCloakItem != null && !starCloakItem.IsAir)
			{
				for (int n = 0; n < 3; n++)
				{
					float x = position.X + (float)Main.rand.Next(-400, 400);
					float y = position.Y - (float)Main.rand.Next(500, 800);
					Vector2 vector = new Vector2(x, y);
					float num16 = position.X + (float)(width / 2) - vector.X;
					float num17 = position.Y + (float)(height / 2) - vector.Y;
					num16 += (float)Main.rand.Next(-100, 101);
					float num18 = (float)Math.Sqrt(num16 * num16 + num17 * num17);
					num18 = 23f / num18;
					num16 *= num18;
					num17 *= num18;
					int type = 726;
					Item item = starCloakItem;
					if (starCloakItem_starVeilOverrideItem != null)
					{
						item = starCloakItem_starVeilOverrideItem;
						type = 725;
					}
					if (starCloakItem_beeCloakOverrideItem != null)
					{
						item = starCloakItem_beeCloakOverrideItem;
						type = 724;
					}
					if (starCloakItem_manaCloakOverrideItem != null)
					{
						item = starCloakItem_manaCloakOverrideItem;
						type = 723;
					}
					int num19 = 75;
					if (Main.masterMode)
					{
						num19 *= 3;
					}
					else if (Main.expertMode)
					{
						num19 *= 2;
					}
					Projectile.NewProjectile(GetProjectileSource_Accessory(item), x, y, num16, num17, type, num19, 5f, whoAmI, 0f, position.Y);
				}
			}
			if (honeyCombItem != null && !honeyCombItem.IsAir)
			{
				int num20 = 1;
				if (Main.rand.Next(3) == 0)
				{
					num20++;
				}
				if (Main.rand.Next(3) == 0)
				{
					num20++;
				}
				if (strongBees && Main.rand.Next(3) == 0)
				{
					num20++;
				}
				float num21 = 13f;
				if (strongBees)
				{
					num21 = 18f;
				}
				if (Main.masterMode)
				{
					num21 *= 2f;
				}
				else if (Main.expertMode)
				{
					num21 *= 1.5f;
				}
				IEntitySource projectileSource_Accessory = GetProjectileSource_Accessory(honeyCombItem);
				for (int num22 = 0; num22 < num20; num22++)
				{
					float speedX = (float)Main.rand.Next(-35, 36) * 0.02f;
					float speedY = (float)Main.rand.Next(-35, 36) * 0.02f;
					Projectile.NewProjectile(projectileSource_Accessory, position.X, position.Y, speedX, speedY, beeType(), beeDamage((int)num21), beeKB(0f), Main.myPlayer);
				}
				AddBuff(48, 300);
			}
		}
		StopVanityActions();
		if (!noKnockback && hitDirection != 0 && (!mount.Active || !mount.Cart))
		{
			velocity.X = 4.5f * (float)hitDirection;
			velocity.Y = -3.5f;
			fallStart = (int)(position.Y / 16f);
		}
		PlayHurtSound();
		eyeHelper.BlinkBecausePlayerGotHurt();
		if (statLife > 0)
		{
			double num23 = num2 / (double)statLifeMax2 * 100.0;
			float num24 = 2 * hitDirection;
			float num25 = 0f;
			for (int num26 = 0; (double)num26 < num23; num26++)
			{
				if (stoned)
				{
					Dust.NewDust(position, width, height, 1, num24 + (float)hitDirection * num25 * Main.rand.NextFloat(), -2f);
				}
				else if (frostArmor)
				{
					int num27 = Dust.NewDust(position, width, height, 135, num24 + (float)hitDirection * num25 * Main.rand.NextFloat(), -2f);
					Main.dust[num27].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
				else if (boneArmor)
				{
					int num28 = Dust.NewDust(position, width, height, 26, num24 + (float)hitDirection * num25 * Main.rand.NextFloat(), -2f);
					Main.dust[num28].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				}
				else
				{
					Dust.NewDust(position, width, height, 5, num24 + (float)hitDirection * num25 * Main.rand.NextFloat(), -2f);
				}
			}
		}
		else
		{
			statLife = 0;
			if (whoAmI == Main.myPlayer)
			{
				KillMe(damageSource, num2, hitDirection, pvp);
			}
		}
		if (pvp)
		{
			num2 = Main.CalculateDamagePlayersTakeInPVP(num, statDefense);
		}
		return num2;
	}

	public void PlayHurtSound()
	{
		Vector2 vector = position;
		if (whoAmI == Main.myPlayer)
		{
			vector = new Vector2(-1f, -1f);
		}
		if (stoned)
		{
			SoundEngine.PlaySound(0, vector);
			return;
		}
		switch (voiceOverride)
		{
		case 1:
			SoundEngine.PlaySound(1, vector);
			return;
		case 2:
			SoundEngine.PlaySound(20, vector);
			return;
		case 3:
			SoundEngine.PlaySound(SoundID.DSTMaleHurt, vector);
			return;
		case 4:
			SoundEngine.PlaySound(SoundID.DSTFemaleHurt, vector);
			return;
		case 20:
			SoundEngine.PlaySound(SoundID.DefaultPlayerHurt, vector);
			return;
		case 5:
			SoundEngine.PlaySound(SoundID.BellHurt, vector);
			return;
		case 6:
			if (Main.rand.Next(5) == 0)
			{
				SoundEngine.PlaySound(SoundID.ChickenHurtRare, vector);
			}
			else
			{
				SoundEngine.PlaySound(SoundID.ChickenHurt, vector);
			}
			return;
		case 7:
			SoundEngine.PlaySound(SoundID.FrogHurt, vector);
			return;
		case 8:
			SoundEngine.PlaySound(SoundID.GoatHurt, vector);
			return;
		case 9:
			SoundEngine.PlaySound(SoundID.RetroHurt, vector);
			return;
		case 10:
			SoundEngine.PlaySound(SoundID.CatHurt, vector);
			return;
		case 11:
			SoundEngine.PlaySound(SoundID.DogHurt, vector);
			return;
		case 12:
			SoundEngine.PlaySound(SoundID.TurkeyHurt, vector);
			return;
		case 13:
			SoundEngine.PlaySound(SoundID.GoblinHurt, vector);
			return;
		case 14:
			SoundEngine.PlaySound(SoundID.CrowHurt, vector);
			return;
		case 15:
			SoundEngine.PlaySound(SoundID.BalloonHurt, vector);
			return;
		case 16:
			SoundEngine.PlaySound(SoundID.UndeadHurt, vector);
			return;
		case 17:
			SoundEngine.PlaySound(SoundID.VampireHurt, vector);
			return;
		case 18:
			SoundEngine.PlaySound(SoundID.FairyHurt, vector);
			return;
		case 19:
			SoundEngine.PlaySound(SoundID.Item16, vector);
			return;
		}
		if (mount.Active)
		{
			if (mount.Type == 52)
			{
				SoundEngine.PlaySound(3, vector, 6);
				return;
			}
			if (mount.Type == 54)
			{
				SoundEngine.PlaySound(3, vector, 47);
				return;
			}
			if (mount.Type == 55)
			{
				SoundEngine.PlaySound(4, vector, 4);
				return;
			}
			if (mount.Type == 56)
			{
				SoundEngine.PlaySound(4, vector, 4);
				return;
			}
			if (mount.Type == 61)
			{
				SoundEngine.PlaySound(3, vector, 5);
				return;
			}
		}
		if ((wereWolf || forceWerewolf) && !hideWolf)
		{
			SoundEngine.PlaySound(3, vector, 6);
			return;
		}
		if (frostArmor)
		{
			SoundEngine.PlaySound(SoundID.Item27, vector);
			return;
		}
		if (boneArmor)
		{
			SoundEngine.PlaySound(3, vector, 2);
			return;
		}
		if (Main.dontStarveWorld && !Main.remixWorld)
		{
			SoundEngine.PlaySound(Male ? SoundID.DSTMaleHurt : SoundID.DSTFemaleHurt, vector);
			return;
		}
		float num = 0.7f;
		float pitchOffset = Utils.Remap(voicePitchOffset, -1f, 1f, 0f - num, num);
		switch (voiceVariant)
		{
		case 1:
			SoundEngine.PlaySound(1, vector, 1, pitchOffset);
			break;
		case 2:
			SoundEngine.PlaySound(20, vector, 1, pitchOffset);
			break;
		case 3:
			SoundEngine.PlaySound(SoundID.DefaultPlayerHurt, vector, pitchOffset);
			break;
		}
	}

	private void PlayDeathSound()
	{
		switch (voiceOverride)
		{
		case 1:
		case 2:
			SoundEngine.PlaySound(5, position);
			return;
		case 3:
			SoundEngine.PlaySound(SoundID.DSTMaleHurt, position);
			return;
		case 4:
			SoundEngine.PlaySound(SoundID.DSTFemaleHurt, position);
			return;
		case 5:
			SoundEngine.PlaySound(SoundID.BellHurt, position);
			return;
		case 9:
			SoundEngine.PlaySound(SoundID.RetroDeath, position);
			return;
		case 15:
			SoundEngine.PlaySound(SoundID.BalloonDeath, position);
			return;
		}
		if (Main.dontStarveWorld || Main.tenthAnniversaryWorld)
		{
			SoundEngine.PlaySound(Male ? SoundID.DSTMaleHurt : SoundID.DSTFemaleHurt, position);
		}
		else
		{
			SoundEngine.PlaySound(5, position);
		}
	}

	private static bool AllowShimmerDodge(PlayerDeathReason damageSource, int cooldownCounter, bool dodgeable)
	{
		if (!dodgeable)
		{
			return false;
		}
		if (cooldownCounter == 1)
		{
			return false;
		}
		Entity entity = null;
		if (!damageSource.TryGetCausingEntity(out entity))
		{
			return true;
		}
		if (entity is NPC { active: not false } nPC && (nPC.boss || NPC.GetNPCInvasionGroup(nPC.type) != 0 || NPCID.Sets.CanHitPastShimmer[nPC.type]))
		{
			return false;
		}
		if (entity is Projectile { active: not false } projectile && ProjectileID.Sets.CanHitPastShimmer[projectile.type])
		{
			return false;
		}
		return true;
	}

	public void HardcoreDeathPenalty()
	{
		if (Main.surviveHardcoreDeath)
		{
			statLifeMax = Math.Max(statLifeMax - 60, 0);
			if (statLifeMax > 0)
			{
				AchievementsHelper.NotifyProgressionEvent(35);
				return;
			}
		}
		KillMeForGood();
	}

	public void KillMeForGood()
	{
		PlayerFileData activePlayerFileData = Main.ActivePlayerFileData;
		if (!activePlayerFileData.ServerSideCharacter)
		{
			bool isCloudSave = activePlayerFileData.IsCloudSave;
			if (FileUtilities.Exists(Main.playerPathName, isCloudSave))
			{
				FileUtilities.Delete(Main.playerPathName, isCloudSave);
			}
			if (FileUtilities.Exists(Main.playerPathName + ".bak", isCloudSave))
			{
				FileUtilities.Delete(Main.playerPathName + ".bak", isCloudSave);
			}
			Main.ActivePlayerFileData = new PlayerFileData();
		}
	}

	public void KillMe(PlayerDeathReason damageSource, double dmg, int hitDirection, bool pvp = false)
	{
		if (creativeGodMode || (DebugOptions.PracticeMode && DebugUtils.PracticeModeReset(this, damageSource)) || dead)
		{
			return;
		}
		if (whoAmI == Main.myPlayer)
		{
			_localMinionRespawner.CollectMinionsFor(this);
		}
		StopVanityActions();
		if (pvp)
		{
			pvpDeath = true;
		}
		if (trapDebuffSource)
		{
			AchievementsHelper.HandleSpecialEvent(this, 4);
		}
		if (Main.myPlayer == whoAmI && _framesLeftEligibleForDeadmansChestDeathAchievement > 0)
		{
			AchievementsHelper.HandleSpecialEvent(this, 23);
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.NotifyOfEvent(GameNotificationType.SpawnOrDeath);
		}
		if (whoAmI != Main.myPlayer && team == Main.LocalPlayer.team && damageSource.SourceProjectileType.HasValue && ProjectileID.Sets.IsAGravestone[damageSource.SourceProjectileType.Value])
		{
			AchievementsHelper.NotifyProgressionEvent(36);
		}
		if (pvpDeath)
		{
			numberOfDeathsPVP++;
		}
		else
		{
			numberOfDeathsPVE++;
		}
		lastDeathPostion = base.Center;
		lastDeathTime = DateTime.Now;
		showLastDeath = true;
		bool overFlowing;
		long coinsOwned = Utils.CoinsCount(out overFlowing, inventory);
		if (Main.myPlayer == whoAmI)
		{
			lostCoins = coinsOwned;
			lostCoinString = Main.ValueToCoins(lostCoins);
		}
		if (Main.myPlayer == whoAmI)
		{
			EndOngoingTorchGodEvent();
		}
		if (Main.myPlayer == whoAmI)
		{
			Main.mapFullscreen = false;
		}
		DropItems(difficulty == 0 || difficulty == 3);
		if (Main.myPlayer == whoAmI && difficulty == 2)
		{
			HardcoreDeathPenalty();
		}
		PlayDeathSound();
		if (Main.tenthAnniversaryWorld)
		{
			for (int i = 0; i < 85; i++)
			{
				int type = Main.rand.Next(139, 143);
				int num = Dust.NewDust(new Vector2(position.X, position.Y), width, height, type, 0f, -10f, 0, default(Color), 1.2f);
				Main.dust[num].velocity.X += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.dust[num].velocity.X += (float)Main.rand.Next(-50, 51) * 0.05f;
				Main.dust[num].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.05f;
				Main.dust[num].scale *= 1f + (float)Main.rand.Next(-30, 31) * 0.01f;
			}
			for (int j = 0; j < 40; j++)
			{
				int type2 = Main.rand.Next(276, 283);
				int num2 = Gore.NewGore(position, new Vector2(0f, -10f), type2);
				Main.gore[num2].velocity.X += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].velocity.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].velocity.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
				Main.gore[num2].scale *= 1f + (float)Main.rand.Next(-20, 21) * 0.01f;
				Main.gore[num2].velocity.X += (float)Main.rand.Next(-50, 51) * 0.05f;
				Main.gore[num2].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.05f;
			}
		}
		headVelocity.Y = (float)Main.rand.Next(-40, -10) * 0.1f;
		bodyVelocity.Y = (float)Main.rand.Next(-40, -10) * 0.1f;
		legVelocity.Y = (float)Main.rand.Next(-40, -10) * 0.1f;
		headVelocity.X = (float)Main.rand.Next(-20, 21) * 0.1f + (float)(2 * hitDirection);
		bodyVelocity.X = (float)Main.rand.Next(-20, 21) * 0.1f + (float)(2 * hitDirection);
		legVelocity.X = (float)Main.rand.Next(-20, 21) * 0.1f + (float)(2 * hitDirection);
		if (stoned)
		{
			headPosition = Vector2.Zero;
			bodyPosition = Vector2.Zero;
			legPosition = Vector2.Zero;
		}
		KillMe_DustExplosion(damageSource, hitDirection);
		mount.Dismount(this);
		dead = true;
		SetOrRequestSpectating(-1);
		respawnTimer = GetRespawnTime(pvp);
		immuneAlpha = 0;
		if (!ChildSafety.Disabled)
		{
			immuneAlpha = 255;
		}
		palladiumRegen = false;
		iceBarrier = false;
		crystalLeaf = false;
		NetworkText deathText = damageSource.GetDeathText(name);
		if (Main.netMode == 2)
		{
			ChatHelper.BroadcastChatMessage(deathText, new Color(225, 25, 25));
		}
		else if (Main.netMode == 0)
		{
			Main.NewText(deathText.ToString(), 225, 25, 25);
		}
		if (Main.netMode == 1 && whoAmI == Main.myPlayer)
		{
			NetMessage.SendPlayerDeath(whoAmI, damageSource, (int)dmg, hitDirection, pvp);
		}
		if (difficulty == 0 || difficulty == 3)
		{
			if (pvp)
			{
				lostCoins = 0L;
			}
			else
			{
				lostCoins = DropCoins();
			}
			lostCoinString = Main.ValueToCoins(lostCoins);
		}
		if (!inventory[58].IsAir)
		{
			inventory[58] = GetItem(inventory[58], GetItemSettings.ReturnItemFromSlot);
		}
		if (whoAmI == Main.myPlayer)
		{
			Main.mouseItem = inventory[58];
		}
		DropTombstone(coinsOwned, deathText, hitDirection);
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		try
		{
			WorldGen.saveToonWhilePlaying();
		}
		catch
		{
		}
	}

	private void KillMe_DustExplosion(PlayerDeathReason damageSource, int hitDirection)
	{
		int num = 100;
		float num2 = 1f;
		float num3 = 1f;
		int num4 = 0;
		for (int i = 0; i < num; i++)
		{
			if (stoned)
			{
				Dust.NewDust(position, width, height, 1, 2 * hitDirection, -2f);
				continue;
			}
			if (frostArmor)
			{
				int num5 = Dust.NewDust(position, width, height, 135, 2 * hitDirection, -2f);
				Main.dust[num5].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				continue;
			}
			if (boneArmor)
			{
				int num6 = Dust.NewDust(position, width, height, 26, 2 * hitDirection, -2f);
				Main.dust[num6].shader = GameShaders.Armor.GetSecondaryShader(ArmorSetDye(), this);
				continue;
			}
			int num7 = Dust.NewDust(position, width, height, 5, 2 * hitDirection, -2f);
			Main.dust[num7].velocity *= num2;
			Main.dust[num7].scale *= num3;
			Main.dust[num7].fadeIn *= num4;
		}
	}

	private int GetRespawnTime(bool pvp)
	{
		int num = 600;
		bool flag = false;
		if (Main.netMode != 0 && !pvp)
		{
			for (int i = 0; i < Main.maxNPCs; i++)
			{
				NPC nPC = Main.npc[i];
				if (nPC.active && nPC.type != 395 && (nPC.boss || nPC.type == 13 || nPC.type == 14 || nPC.type == 15) && Math.Abs(base.Center.X - Main.npc[i].Center.X) + Math.Abs(base.Center.Y - Main.npc[i].Center.Y) < 4000f)
				{
					flag = true;
					break;
				}
			}
		}
		if (flag)
		{
			num += 600;
		}
		if (Main.expertMode)
		{
			num = (int)((double)num * 1.5);
		}
		if (flag && Main.getGoodWorld && Main.netMode != 0)
		{
			bool flag2 = false;
			for (int j = 0; j < 255; j++)
			{
				if (j != whoAmI && Main.player[j].active)
				{
					flag2 = true;
					break;
				}
			}
			if (flag2)
			{
				num *= 2;
			}
		}
		return num;
	}

	public void DropTombstone(long coinsOwned, NetworkText deathText, int hitDirection)
	{
		if (Main.netMode != 1)
		{
			float num;
			for (num = (float)Main.rand.Next(-35, 36) * 0.1f; num < 2f && num > -2f; num += (float)Main.rand.Next(-30, 31) * 0.1f)
			{
			}
			int num2 = Main.rand.Next(6);
			if (coinsOwned <= 100000)
			{
				num2 = ((num2 != 0) ? (200 + num2) : 43);
			}
			else
			{
				num2 = Main.rand.Next(5);
				num2 += 527;
			}
			IEntitySource projectileSource_Misc = GetProjectileSource_Misc(9);
			int damage = 0;
			int num3 = 0;
			if (Main.getGoodWorld)
			{
				damage = 70;
				num3 = 10;
			}
			int num4 = whoAmI;
			int num5 = ((!Main.getGoodWorld) ? Projectile.NewProjectile(projectileSource_Misc, position.X + (float)(width / 2), position.Y + (float)(height / 2), (float)Main.rand.Next(10, 30) * 0.1f * (float)hitDirection + num, (float)Main.rand.Next(-40, -20) * 0.1f, num2, damage, num3, Main.myPlayer, num4) : Projectile.NewProjectile(projectileSource_Misc, position.X + (float)(width / 2), position.Y + (float)(height / 2), ((float)Main.rand.Next(10, 30) * 0.1f * (float)hitDirection + num) * 1.5f, (float)Main.rand.Next(-40, -20) * 0.1f * 1.5f, num2, damage, num3, Main.myPlayer, num4));
			DateTime now = DateTime.Now;
			string text = now.ToString("D");
			if (GameCulture.FromCultureName(GameCulture.CultureName.English).IsActive)
			{
				text = now.ToString("MMMM d, yyy");
			}
			string miscText = deathText.ToString() + "\n" + text;
			Main.projectile[num5].miscText = miscText;
		}
	}

	public bool CanPullItem(WorldItem item, ItemSpaceStatus status)
	{
		if (status.CanTakeItem)
		{
			return CanAcceptItemIntoInventory(item);
		}
		return false;
	}

	public ItemSpaceStatus ItemSpace(WorldItem newItem)
	{
		return ItemSpace(newItem.inner);
	}

	public ItemSpaceStatus ItemSpace(Item newItem)
	{
		if (ItemID.Sets.IsAPickup[newItem.type])
		{
			return new ItemSpaceStatus(CanTakeItem: true);
		}
		if (newItem.uniqueStack && HasItem(newItem.type))
		{
			return new ItemSpaceStatus(CanTakeItem: false);
		}
		int num = 50;
		if (newItem.IsACoin)
		{
			num = 54;
		}
		for (int i = 0; i < num; i++)
		{
			if (CanItemSlotAcceptPickup(inventory[i], newItem))
			{
				return new ItemSpaceStatus(CanTakeItem: true);
			}
		}
		if (newItem.ammo > 0 && !newItem.notAmmo)
		{
			for (int j = 54; j < 58; j++)
			{
				if (CanGoIntoAmmoOnPickup(inventory[j], newItem))
				{
					return new ItemSpaceStatus(CanTakeItem: true);
				}
			}
		}
		for (int k = 54; k < 58; k++)
		{
			if (inventory[k].type > 0 && inventory[k].stack < inventory[k].maxStack && Item.CanStack(newItem, inventory[k]))
			{
				return new ItemSpaceStatus(CanTakeItem: true);
			}
		}
		if (ItemSpaceForCofveve(newItem))
		{
			return new ItemSpaceStatus(CanTakeItem: true, ItemIsGoingToVoidVault: true);
		}
		return new ItemSpaceStatus(CanTakeItem: false);
	}

	public bool ItemSpaceForCofveve(Item newItem)
	{
		if (!IsVoidVaultEnabled)
		{
			return false;
		}
		if (!CanVoidVaultAccept(newItem))
		{
			return false;
		}
		Item[] item = bank4.item;
		for (int i = 0; i < item.Length; i++)
		{
			if (CanItemSlotAcceptPickup(item[i], newItem))
			{
				return true;
			}
		}
		return false;
	}

	public bool CanItemSlotAcceptPickup(Item theSlot, Item theItemToAccept)
	{
		if (theSlot.type == 0)
		{
			return true;
		}
		if (theSlot.favorited && theSlot.OnlyNeedOneInInventory())
		{
			return false;
		}
		if (theSlot.stack < theSlot.maxStack && Item.CanStack(theItemToAccept, theSlot))
		{
			return true;
		}
		return false;
	}

	public bool CanGoIntoAmmoOnPickup(Item theSlot, Item theItemToAccept)
	{
		if (!theItemToAccept.CanFillEmptyAmmoSlot() && theSlot.type == 0)
		{
			return false;
		}
		return CanItemSlotAcceptPickup(theSlot, theItemToAccept);
	}

	public void DoCoins(int i)
	{
		if (inventory[i].stack != 100 || (inventory[i].type != 71 && inventory[i].type != 72 && inventory[i].type != 73))
		{
			return;
		}
		inventory[i].SetDefaults(inventory[i].type + 1);
		for (int j = 0; j < 54; j++)
		{
			if (inventory[j].type == inventory[i].type && j != i && inventory[j].stack < inventory[j].maxStack)
			{
				inventory[j].stack++;
				inventory[i].TurnToAir(fullReset: true);
				DoCoins(j);
			}
		}
	}

	public Item FillAmmo(Item newItem, GetItemSettings settings)
	{
		for (int i = 54; i < 58; i++)
		{
			if (inventory[i].type <= 0 || inventory[i].stack >= inventory[i].maxStack || !Item.CanStack(newItem, inventory[i]))
			{
				continue;
			}
			if (!settings.NoSound)
			{
				SoundEngine.PlaySound(7);
			}
			if (newItem.stack + inventory[i].stack <= inventory[i].maxStack)
			{
				inventory[i].stack += newItem.stack;
				GetItemLogger.Add(inventory, i, 2, newItem.stack);
				if (!settings.NoText)
				{
					PopupText.NewText(PopupTextContext.RegularItemPickup, newItem, base.Center, newItem.stack);
				}
				if (!settings.NoCoinMerge)
				{
					DoCoins(i);
				}
				settings.HandlePostAction(inventory[i]);
				return new Item();
			}
			int num = inventory[i].maxStack - inventory[i].stack;
			newItem.stack -= num;
			GetItemLogger.Add(inventory, i, 2, num);
			if (!settings.NoText)
			{
				PopupText.NewText(PopupTextContext.RegularItemPickup, newItem, base.Center, inventory[i].maxStack - inventory[i].stack);
			}
			inventory[i].stack = inventory[i].maxStack;
			if (!settings.NoCoinMerge)
			{
				DoCoins(i);
			}
			settings.HandlePostAction(inventory[i]);
		}
		if (newItem.CanFillEmptyAmmoSlot())
		{
			for (int j = 54; j < 58; j++)
			{
				if (inventory[j].type == 0)
				{
					inventory[j] = newItem;
					GetItemLogger.Add(inventory, j, 2, newItem.stack);
					if (!settings.NoText)
					{
						PopupText.NewText(PopupTextContext.RegularItemPickup, newItem, base.Center, newItem.stack);
					}
					if (!settings.NoCoinMerge)
					{
						DoCoins(j);
					}
					SoundEngine.PlaySound(7);
					settings.HandlePostAction(inventory[j]);
					return new Item();
				}
			}
		}
		return newItem;
	}

	public Item GetItem(WorldItem newItem, GetItemSettings settings)
	{
		if (newItem.noGrabDelay > 0)
		{
			return newItem.inner;
		}
		return GetItem(newItem.inner, settings);
	}

	public Item GetItem(Item newItem, GetItemSettings settings)
	{
		bool isACoin = newItem.IsACoin;
		Item item = newItem;
		int num = 50;
		int num2 = 0;
		if (newItem.uniqueStack && HasItem(newItem.type))
		{
			return item;
		}
		if (isACoin)
		{
			num2 = -4;
			num = 54;
		}
		if (item.FitsAmmoSlot())
		{
			item = FillAmmo(item, settings);
			if (item.type == 0 || item.stack == 0)
			{
				return new Item();
			}
		}
		for (int i = num2; i < 50; i++)
		{
			int num3 = i;
			if (num3 < 0)
			{
				num3 = 54 + i;
			}
			if (GetItem_FillIntoOccupiedSlot(newItem, settings, item, num3))
			{
				return new Item();
			}
		}
		if (!isACoin && newItem.useStyle != 0)
		{
			for (int j = 0; j < 10; j++)
			{
				if (GetItem_FillEmptyInventorySlot(newItem, settings, item, j))
				{
					return new Item();
				}
			}
		}
		if (newItem.favorited)
		{
			for (int k = 0; k < num; k++)
			{
				if (GetItem_FillEmptyInventorySlot(newItem, settings, item, k))
				{
					return new Item();
				}
			}
		}
		else
		{
			for (int num4 = num - 1; num4 >= 0; num4--)
			{
				if (GetItem_FillEmptyInventorySlot(newItem, settings, item, num4))
				{
					return new Item();
				}
			}
		}
		if (settings.CanGoIntoVoidVault && IsVoidVaultEnabled && CanVoidVaultAccept(newItem) && GetItem_VoidVault(bank4.item, newItem, settings, item))
		{
			return new Item();
		}
		return item;
	}

	private bool GetItem_VoidVault(Item[] inventory, Item newItem, GetItemSettings settings, Item returnItem)
	{
		if (!CanVoidVaultAccept(newItem))
		{
			return false;
		}
		for (int i = 0; i < inventory.Length; i++)
		{
			if (GetItem_FillIntoOccupiedSlot_VoidBag(inventory, newItem, settings, returnItem, i))
			{
				return true;
			}
		}
		for (int j = 0; j < inventory.Length; j++)
		{
			if (GetItem_FillEmptyInventorySlot_VoidBag(inventory, newItem, settings, returnItem, j))
			{
				return true;
			}
		}
		return false;
	}

	private bool CanVoidVaultAccept(Item item)
	{
		if (item.questItem)
		{
			return false;
		}
		int type = item.type;
		if (type == 3822)
		{
			return false;
		}
		return true;
	}

	private bool GetItem_FillIntoOccupiedSlot_VoidBag(Item[] inv, Item newItem, GetItemSettings settings, Item returnItem, int i)
	{
		if (inv[i].type > 0 && inv[i].stack < inv[i].maxStack && Item.CanStack(returnItem, inv[i]))
		{
			if (!settings.NoSound)
			{
				SoundEngine.PlaySound(newItem.IsACoin ? 38 : 7);
			}
			if (returnItem.stack + inv[i].stack <= inv[i].maxStack)
			{
				inv[i].stack += returnItem.stack;
				GetItemLogger.Add(inv, i, 32, returnItem.stack);
				if (!settings.NoText)
				{
					PopupText.NewText(PopupTextContext.ItemPickupToVoidContainer, newItem, base.Center, returnItem.stack, noStack: false, settings.LongText);
				}
				AchievementsHelper.NotifyItemPickup(this, returnItem);
				settings.HandlePostAction(inv[i]);
				return true;
			}
			int num = inv[i].maxStack - inv[i].stack;
			GetItemLogger.Add(inv, i, 32, num);
			AchievementsHelper.NotifyItemPickup(this, returnItem, num);
			returnItem.stack -= num;
			if (!settings.NoText)
			{
				PopupText.NewText(PopupTextContext.ItemPickupToVoidContainer, newItem, base.Center, inv[i].maxStack - inv[i].stack, noStack: false, settings.LongText);
			}
			inv[i].stack = inv[i].maxStack;
			settings.HandlePostAction(inv[i]);
		}
		return false;
	}

	private int GetFittingItemSlotContext(int itemSlot)
	{
		if (itemSlot >= 54)
		{
			return 2;
		}
		if (itemSlot >= 50)
		{
			return 1;
		}
		return 0;
	}

	private bool GetItem_FillIntoOccupiedSlot(Item newItem, GetItemSettings settings, Item returnItem, int i)
	{
		if (inventory[i].type > 0 && inventory[i].stack < inventory[i].maxStack && CanItemSlotAcceptPickup(inventory[i], returnItem))
		{
			if (!settings.NoSound)
			{
				SoundEngine.PlaySound(newItem.IsACoin ? 38 : 7);
			}
			if (returnItem.stack + inventory[i].stack <= inventory[i].maxStack)
			{
				inventory[i].stack += returnItem.stack;
				GetItemLogger.Add(inventory, i, GetFittingItemSlotContext(i), returnItem.stack);
				if (!settings.NoText)
				{
					PopupText.NewText(PopupTextContext.RegularItemPickup, newItem, base.Center, returnItem.stack, noStack: false, settings.LongText);
				}
				if (!settings.NoCoinMerge)
				{
					DoCoins(i);
				}
				AchievementsHelper.NotifyItemPickup(this, returnItem);
				settings.HandlePostAction(inventory[i]);
				return true;
			}
			GetItemLogger.Add(inventory, i, GetFittingItemSlotContext(i), inventory[i].maxStack - inventory[i].stack);
			AchievementsHelper.NotifyItemPickup(this, returnItem, inventory[i].maxStack - inventory[i].stack);
			returnItem.stack -= inventory[i].maxStack - inventory[i].stack;
			if (!settings.NoText)
			{
				PopupText.NewText(PopupTextContext.RegularItemPickup, newItem, base.Center, inventory[i].maxStack - inventory[i].stack, noStack: false, settings.LongText);
			}
			inventory[i].stack = inventory[i].maxStack;
			if (!settings.NoCoinMerge)
			{
				DoCoins(i);
			}
			settings.HandlePostAction(inventory[i]);
		}
		return false;
	}

	private bool GetItem_FillEmptyInventorySlot_VoidBag(Item[] inv, Item newItem, GetItemSettings settings, Item returnItem, int i)
	{
		if (inv[i].type != 0)
		{
			return false;
		}
		if (!settings.NoSound)
		{
			SoundEngine.PlaySound(newItem.IsACoin ? 38 : 7);
		}
		inv[i] = returnItem;
		GetItemLogger.Add(inv, i, 32, returnItem.stack);
		if (!settings.NoText)
		{
			PopupText.NewText(PopupTextContext.ItemPickupToVoidContainer, newItem, base.Center, newItem.stack, noStack: false, settings.LongText);
		}
		if (!settings.NoCoinMerge)
		{
			DoCoins(i);
		}
		AchievementsHelper.NotifyItemPickup(this, returnItem);
		settings.HandlePostAction(inv[i]);
		return true;
	}

	private bool GetItem_FillEmptyInventorySlot(Item newItem, GetItemSettings settings, Item returnItem, int i)
	{
		if (inventory[i].type != 0)
		{
			return false;
		}
		if (!settings.NoSound)
		{
			SoundEngine.PlaySound(newItem.IsACoin ? 38 : 7);
		}
		inventory[i] = returnItem;
		GetItemLogger.Add(inventory, i, GetFittingItemSlotContext(i), returnItem.stack);
		if (!settings.NoText)
		{
			PopupText.NewText(PopupTextContext.RegularItemPickup, newItem, base.Center, newItem.stack, noStack: false, settings.LongText);
		}
		if (!settings.NoCoinMerge)
		{
			DoCoins(i);
		}
		AchievementsHelper.NotifyItemPickup(this, returnItem);
		if (whoAmI == Main.myPlayer && newItem.type == 5095)
		{
			LucyAxeMessage.Create(LucyAxeMessage.MessageSource.PickedUp, base.Top, new Vector2(0f, -7f));
		}
		settings.HandlePostAction(inventory[i]);
		return true;
	}

	public void PlaceThing(bool doPlacementAction, ref ItemCheckContext context)
	{
		if (itemTime == 0)
		{
			dontConsumeWand = false;
		}
		PlaceThing_Paintbrush();
		PlaceThing_PaintRoller();
		PlaceThing_PaintScrapper();
		PlaceThing_CannonBall();
		PlaceThing_XMasTreeTops();
		PlaceThing_ItemInExtractinator(ref context);
		PlaceThing_LockChest();
		if (!noBuilding)
		{
			PlaceThing_Tiles(doPlacementAction);
			PlaceThing_Walls();
		}
	}

	private void PlaceThing_Walls()
	{
		if (inventory[selectedItem].createWall < 0 || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, inventory[selectedItem].tileBoost + blockRange))
		{
			return;
		}
		cursorItemIconEnabled = true;
		if (!ItemTimeIsZero || itemAnimation <= 0 || !controlUseItem || (!Main.tile[tileTargetX + 1, tileTargetY].active() && Main.tile[tileTargetX + 1, tileTargetY].wall <= 0 && !Main.tile[tileTargetX - 1, tileTargetY].active() && Main.tile[tileTargetX - 1, tileTargetY].wall <= 0 && !Main.tile[tileTargetX, tileTargetY + 1].active() && Main.tile[tileTargetX, tileTargetY + 1].wall <= 0 && !Main.tile[tileTargetX, tileTargetY - 1].active() && Main.tile[tileTargetX, tileTargetY - 1].wall <= 0) || Main.tile[tileTargetX, tileTargetY].wall == inventory[selectedItem].createWall)
		{
			return;
		}
		bool flag = true;
		if (TileReplacementEnabled)
		{
			flag = PlaceThing_TryReplacingWalls(flag);
		}
		if (!flag)
		{
			return;
		}
		WorldGen.PlaceWall(tileTargetX, tileTargetY, inventory[selectedItem].createWall);
		if (Main.tile[tileTargetX, tileTargetY].wall == inventory[selectedItem].createWall)
		{
			ApplyItemTime(inventory[selectedItem], wallSpeed);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 3, tileTargetX, tileTargetY, inventory[selectedItem].createWall);
			}
			PlaceThing_Walls_FillEmptySpace();
			if (autoPaint && builderAccStatus[3] == 0)
			{
				TryPainting(tileTargetX, tileTargetY, paintingAWall: true, applyItemAnimation: false);
			}
		}
	}

	private void PlaceThing_Walls_FillEmptySpace()
	{
		if (inventory[selectedItem].stack <= 1)
		{
			return;
		}
		int createWall = inventory[selectedItem].createWall;
		for (int i = 0; i < 4; i++)
		{
			int num = tileTargetX;
			int num2 = tileTargetY;
			if (i == 0)
			{
				num--;
			}
			if (i == 1)
			{
				num++;
			}
			if (i == 2)
			{
				num2--;
			}
			if (i == 3)
			{
				num2++;
			}
			if (Main.tile[num, num2].wall != 0)
			{
				continue;
			}
			int num3 = 0;
			for (int j = 0; j < 4; j++)
			{
				int num4 = num;
				int num5 = num2;
				if (j == 0)
				{
					num4--;
				}
				if (j == 1)
				{
					num4++;
				}
				if (j == 2)
				{
					num5--;
				}
				if (j == 3)
				{
					num5++;
				}
				if (Main.tile[num4, num5].wall == createWall)
				{
					num3++;
				}
			}
			if (num3 != 4)
			{
				continue;
			}
			WorldGen.PlaceWall(num, num2, createWall);
			if (Main.tile[num, num2].wall == createWall)
			{
				inventory[selectedItem].stack--;
				if (inventory[selectedItem].stack == 0)
				{
					inventory[selectedItem].SetDefaults(0);
				}
				if (Main.netMode == 1)
				{
					NetMessage.SendData(17, -1, -1, null, 3, num, num2, createWall);
				}
				if (autoPaint && builderAccStatus[3] == 0)
				{
					TryPainting(num, num2, paintingAWall: true, applyItemAnimation: false);
				}
			}
		}
	}

	private void PlaceThing_Tiles(bool doPlacementAction)
	{
		Item item = inventory[selectedItem];
		int tileToCreate = item.createTile;
		if (tileToCreate < 0 || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, item.tileBoost + blockRange) || !SmartCursorHelper.TileTargetDesired())
		{
			return;
		}
		cursorItemIconEnabled = true;
		bool canUse = doPlacementAction;
		canUse = PlaceThing_Tiles_CheckGamepadTorchUsability(canUse);
		canUse = PlaceThing_Tiles_CheckWandUsability(canUse);
		canUse = PlaceThing_Tiles_CheckRopeUsability(canUse);
		canUse = PlaceThing_Tiles_CheckFlexibleWand(canUse);
		Tile tile = Main.tile[tileTargetX, tileTargetY];
		if (TileReplacementEnabled)
		{
			canUse = PlaceThing_TryReplacingTiles(canUse);
		}
		if (tile.active())
		{
			if (tileToCreate == 23 && tile.type == 59)
			{
				tileToCreate = 661;
			}
			if (tileToCreate == 199 && tile.type == 59)
			{
				tileToCreate = 662;
			}
		}
		if (canUse && ((!tile.active() && !PlaceThing_Tiles_IsBlockedByLava(item.createTile, item.placeStyle, tile)) || PlaceThing_IsReplacableBlock(tile) || tileToCreate == 199 || tileToCreate == 23 || tileToCreate == 662 || tileToCreate == 661 || tileToCreate == 2 || tileToCreate == 109 || tileToCreate == 60 || tileToCreate == 70 || tileToCreate == 633 || Main.tileMoss[tileToCreate]) && ItemTimeIsZero && itemAnimation > 0 && controlUseItem)
		{
			bool? overrideCanPlace = null;
			int? forcedRandom = null;
			TileObject data = default(TileObject);
			FigureOutWhatToPlace(tile, item, out tileToCreate, out var previewPlaceStyle, out overrideCanPlace, out forcedRandom);
			PlaceThing_Tiles_TryPlacing(tileToCreate, overrideCanPlace, forcedRandom, data, previewPlaceStyle);
		}
	}

	public bool PlaceThing_IsReplacableBlock(Tile targetTile)
	{
		if ((!Main.tileCut[targetTile.type] || targetTile.type == 484 || targetTile.type == 711) && (targetTile.type < 373 || targetTile.type > 375) && targetTile.type != 461 && targetTile.type != 709)
		{
			return TileID.Sets.BreakableWhenPlacing[targetTile.type];
		}
		return true;
	}

	private void PlaceThing_Tiles_TryPlacing(int tileToCreate, bool? overrideCanPlace, int? forcedRandom, TileObject data, int placeStyle)
	{
		bool canPlace = false;
		bool newObjectType = false;
		if (overrideCanPlace.HasValue)
		{
			canPlace = overrideCanPlace.Value;
		}
		else if (TileObjectData.CustomPlace(tileToCreate, placeStyle) && tileToCreate != 82 && tileToCreate != 227 && tileToCreate != 4)
		{
			newObjectType = true;
			canPlace = TileObject.CanPlace(tileTargetX, tileTargetY, (ushort)tileToCreate, placeStyle, direction, out data, onlyCheck: false, forcedRandom);
			PlaceThing_Tiles_BlockPlacementIfOverPlayers(ref canPlace, ref data);
			PlaceThing_Tiles_BlockPlacementForRepeatedPigronatas(ref canPlace, ref data);
			PlaceThing_Tiles_BlockPlacementForRepeatedPumpkins(ref canPlace, ref data);
			PlaceThing_Tiles_BlockPlacementForRepeatedCoralAndBeachPiles(ref canPlace, ref data);
			PlaceThing_Tiles_BlockPlacementForRepeatedRainbowBoulders(ref canPlace, ref data);
		}
		else
		{
			canPlace = PlaceThing_Tiles_BlockPlacementForAssortedThings(canPlace);
		}
		if (canPlace)
		{
			PlaceThing_Tiles_PlaceIt(newObjectType, data, tileToCreate);
		}
	}

	private bool ModifyFlexibleWandPlacementInfo(ref int tileType, ref int tileStyle, ref int? forcedRandom)
	{
		FlexibleTileWand flexibleTileWand = HeldItem.GetFlexibleTileWand();
		if (flexibleTileWand == null)
		{
			return true;
		}
		if (whoAmI == Main.myPlayer)
		{
			Point point = new Point(tileTargetX, tileTargetY);
			if (FlexibleWandLastPosition != point)
			{
				FlexibleWandLastPosition = point;
				FlexibleWandRandomSeed = Main.rand.Next();
			}
		}
		if (flexibleTileWand.TryGetPlacementOption(this, FlexibleWandRandomSeed, FlexibleWandCycleOffset, out var option, out var _))
		{
			tileType = option.TileIdToPlace;
			tileStyle = option.TileStyleToPlace;
			forcedRandom = FlexibleWandCycleOffset;
			return true;
		}
		return false;
	}

	private bool PlaceThing_TryReplacingWalls(bool canUse)
	{
		if (canUse && itemAnimation > 0 && ItemTimeIsZero && controlUseItem && PlaceThing_ValidWallForReplacement() && WorldGen.NearFriendlyWall(tileTargetX, tileTargetY) && WorldGen.ReplaceWall(tileTargetX, tileTargetY, (ushort)HeldItem.createWall))
		{
			canUse = false;
			ApplyItemTime(HeldItem, wallSpeed);
			NetMessage.SendData(17, -1, -1, null, 22, tileTargetX, tileTargetY, HeldItem.createWall);
			if (autoPaint && builderAccStatus[3] == 0)
			{
				TryPainting(tileTargetX, tileTargetY, paintingAWall: true, applyItemAnimation: false);
			}
		}
		return canUse;
	}

	private bool PlaceThing_ValidWallForReplacement()
	{
		_ = Main.tile[tileTargetX, tileTargetY];
		if (Main.tile[tileTargetX, tileTargetY].wall > 0)
		{
			return Main.tile[tileTargetX, tileTargetY].wall != 350;
		}
		return false;
	}

	private bool PlaceThing_TryReplacingTiles(bool canUse)
	{
		bool flag = PlaceThing_ValidTileForReplacement();
		if (flag)
		{
			TileObject.objectPreview.Reset();
		}
		if (controlUseItem && canUse && Main.tile[tileTargetX, tileTargetY].active() && itemAnimation > 0 && ItemTimeIsZero && flag)
		{
			Item bestPickaxe = GetBestPickaxe();
			if (bestPickaxe == null)
			{
				return false;
			}
			Tile tile = Main.tile[tileTargetX, tileTargetY];
			_ = tile.type;
			int num = hitReplace.HitObject(tileTargetX, tileTargetY, 1);
			int num2 = GetPickaxeDamage(tileTargetX, tileTargetY, bestPickaxe.pick, num, tile);
			if (Main.getGoodWorld)
			{
				num2 *= 2;
			}
			if (num2 == 0)
			{
				return false;
			}
			if (!WorldGen.IsTileReplacable(tileTargetX, tileTargetY))
			{
				return false;
			}
			if (0 == 0)
			{
				if (hitReplace.AddDamage(num, num2) < 100)
				{
					int num3 = WorldGen.KillTile_GetTileDustAmount(fail: true, tile);
					for (int i = 0; i < num3; i++)
					{
						WorldGen.KillTile_MakeTileDust(tileTargetX, tileTargetY, tile);
					}
					WorldGen.KillTile_PlaySounds(tileTargetX, tileTargetY, fail: true, tile);
					if (HeldItem.consumable)
					{
						HeldItem.stack++;
					}
					dontConsumeWand = true;
					ApplyItemTime(bestPickaxe, pickSpeed);
					SetItemAnimation((int)((float)bestPickaxe.useTime * pickSpeed));
					return false;
				}
				ClearMiningCacheAt(tileTargetX, tileTargetY, 1);
			}
			Vector3[,] tileDataCaches = PlaceThing_Tiles_GetAutoAccessoryCache();
			int type = HeldItem.createTile;
			int style = HeldItem.placeStyle;
			if (UsingBiomeTorches && type == 4)
			{
				BiomeTorchPlaceStyle(ref type, ref style);
			}
			if (UsingBiomeTorches && type == 215)
			{
				BiomeCampfirePlaceStyle(ref type, ref style);
			}
			if (WorldGen.ReplaceTile(tileTargetX, tileTargetY, type, style))
			{
				canUse = false;
				NetMessage.SendData(17, -1, -1, null, 21, tileTargetX, tileTargetY, type, style);
				int num4 = (int)((float)bestPickaxe.useTime * pickSpeed);
				int num5 = (int)((float)HeldItem.useTime * tileSpeed);
				SetItemTime(num4 + num5);
				SetItemAnimation((int)((float)bestPickaxe.useTime * pickSpeed));
				PlaceThing_Tiles_PlaceIt_AutoPaintAndActuate(tileDataCaches, type);
			}
		}
		return canUse;
	}

	private bool PlaceThing_ValidTileForReplacement()
	{
		int type = HeldItem.createTile;
		int style = HeldItem.placeStyle;
		if (UsingBiomeTorches && type == 4)
		{
			BiomeTorchPlaceStyle(ref type, ref style);
		}
		if (UsingBiomeTorches && type == 215)
		{
			BiomeCampfirePlaceStyle(ref type, ref style);
		}
		Tile tile = Main.tile[tileTargetX, tileTargetY];
		if (ItemID.Sets.SortingPriorityRopes[HeldItem.type] != -1)
		{
			return false;
		}
		if (Main.tileMoss[type])
		{
			return false;
		}
		if (TileID.Sets.DoesntPlaceWithTileReplacement[type])
		{
			return false;
		}
		if (TileID.Sets.DoesntGetReplacedWithTileReplacement[tile.type])
		{
			return false;
		}
		if (!PlaceThing_CheckSpecificValidtyCaseForBlockSwap(type, tile.type, tile.liquidType(), tile.liquid))
		{
			return false;
		}
		if (!PlaceThing_CheckPlatformSolidityForBlockSwap(type, tile.type, tileTargetX, tileTargetY))
		{
			return false;
		}
		if (Main.tileCut[tile.type])
		{
			return false;
		}
		if (TileID.Sets.Platforms[tile.type] && tile.type == type)
		{
			return tile.frameY != style * 18;
		}
		if (TileID.Sets.Torches[tile.type])
		{
			if (tile.liquid > 0)
			{
				if (type == 4 && style != 8 && style != 11 && style != 17)
				{
					return false;
				}
				TileObjectData tileData = TileObjectData.GetTileData(type, style);
				if (tileData != null && tileData.WaterPlacement != LiquidPlacement.Allowed)
				{
					return false;
				}
			}
			if (tile.type == type)
			{
				return tile.frameY != style * 22;
			}
		}
		if (TileID.Sets.Campfires[tile.type])
		{
			if (tile.liquid > 0)
			{
				TileObjectData tileData2 = TileObjectData.GetTileData(type, style);
				if (tileData2 != null && tileData2.WaterPlacement != LiquidPlacement.Allowed)
				{
					return false;
				}
			}
			if (tile.type == type)
			{
				return tile.frameX / 54 != style;
			}
		}
		if (TileID.Sets.BasicChest[tile.type] && TileID.Sets.BasicChest[type])
		{
			if (tile.frameX / 36 == style)
			{
				return tile.type != type;
			}
			return true;
		}
		if (TileID.Sets.BasicDresser[tile.type] && TileID.Sets.BasicDresser[type])
		{
			if (tile.frameX / 54 == style)
			{
				return tile.type != type;
			}
			return true;
		}
		bool flag = false;
		if (Main.tileRope[tile.type])
		{
			flag = type == 314 || type == 380 || TileID.Sets.Platforms[type];
			if (!flag)
			{
				return false;
			}
		}
		if (!flag && Main.tileFrameImportant[type] && !TileID.Sets.Platforms[type])
		{
			return false;
		}
		if (Main.tile[tileTargetX, tileTargetY].type == type)
		{
			return false;
		}
		if (Main.tile[tileTargetX, tileTargetY].type == 230 && Main.getGoodWorld)
		{
			return false;
		}
		if (!TileID.Sets.IgnoresTileReplacementDropCheckWhenBeingPlaced[type])
		{
			WorldGen.KillTile_GetItemDrops(tileTargetX, tileTargetY, tile, out var dropItem, out var _, out var _, out var _, out var _);
			if (dropItem == HeldItem.type)
			{
				return false;
			}
		}
		if (!WorldGen.WouldTileReplacementWork((ushort)type, tileTargetX, tileTargetY))
		{
			return false;
		}
		return true;
	}

	private bool PlaceThing_CheckPlatformSolidityForBlockSwap(int tileTypeBeingPlaced, int tileTypeCurrentlyPlaced, int tileX, int tileY)
	{
		if ((TileID.Sets.Platforms[tileTypeCurrentlyPlaced] || tileTypeCurrentlyPlaced == 380) && !TileID.Sets.Platforms[tileTypeBeingPlaced] && tileTypeBeingPlaced != 380)
		{
			Rectangle value = new Rectangle(tileX * 16, tileY * 16, 16, 16);
			if (base.Hitbox.Intersects(value))
			{
				return false;
			}
		}
		return true;
	}

	private bool PlaceThing_CheckSpecificValidtyCaseForBlockSwap(int tileTypeBeingPlaced, int tileTypeCurrentlyPlaced, int liquidTypeCurrentPlaced, int liquidAmountCurrentlyPlaced)
	{
		bool flag = TileID.Sets.Falling[tileTypeBeingPlaced];
		bool flag2 = TileID.Sets.Falling[tileTypeCurrentlyPlaced] && !flag;
		if (flag2)
		{
			Item bestPickaxe = GetBestPickaxe();
			if (bestPickaxe != null && bestPickaxe.pick >= 110)
			{
				flag2 = false;
			}
		}
		if (flag2 && tileTargetY > 0)
		{
			Tile tile = Main.tile[tileTargetX, tileTargetY - 1];
			bool flag3 = false;
			if (tile != null)
			{
				flag3 |= !tile.active();
				flag3 |= tile.active() && !TileID.Sets.Falling[tile.type];
			}
			if (flag3)
			{
				flag2 = false;
			}
		}
		if (flag2)
		{
			return false;
		}
		if ((tileTypeCurrentlyPlaced == 546 || tileTypeCurrentlyPlaced == 557) && liquidAmountCurrentlyPlaced > 0)
		{
			return false;
		}
		return true;
	}

	public Item GetBestPickaxe()
	{
		Item item = null;
		for (int i = 0; i < 50; i++)
		{
			if (inventory[i].stack > 0 && inventory[i].pick > 0 && (item == null || inventory[i].pick > item.pick))
			{
				item = inventory[i];
			}
		}
		return item;
	}

	private TileObject PlaceThing_Tiles_PlaceIt(bool newObjectType, TileObject data, int tileToCreate)
	{
		int style = inventory[selectedItem].placeStyle;
		if (!newObjectType)
		{
			style = PlaceThing_Tiles_PlaceIt_GetLegacyTileStyle(style);
		}
		Vector3[,] tileDataCaches = PlaceThing_Tiles_GetAutoAccessoryCache();
		bool forced = false;
		bool flag;
		if (newObjectType)
		{
			flag = TileObject.Place(data);
			WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
			if (Main.netMode != 1 || !TileID.Sets.IsAContainer[tileToCreate])
			{
				SoundEngine.PlaySound(0, tileTargetX * 16, tileTargetY * 16);
			}
		}
		else
		{
			if (UsingBiomeTorches && tileToCreate == 4 && style == 0)
			{
				BiomeTorchPlaceStyle(ref tileToCreate, ref style);
			}
			flag = WorldGen.PlaceTile(tileTargetX, tileTargetY, tileToCreate, mute: false, forced, whoAmI, style);
		}
		if (flag)
		{
			if (tileToCreate == 20 || tileToCreate == 590 || tileToCreate == 595 || tileToCreate == 615)
			{
				AchievementsHelper.PlantedAcorn();
			}
			ApplyItemTime(inventory[selectedItem], tileSpeed);
			if (newObjectType)
			{
				TileObjectData.CallPostPlacementPlayerHook(tileTargetX, tileTargetY, tileToCreate, style, direction, data.alternate, data);
				if (Main.netMode == 1 && !Main.tileContainer[tileToCreate] && tileToCreate != 423)
				{
					NetMessage.SendObjectPlacement(-1, tileTargetX, tileTargetY, data.type, data.style, data.alternate, data.random, direction);
				}
			}
			else
			{
				NetMessage.SendData(17, -1, -1, null, 1, tileTargetX, tileTargetY, tileToCreate, style);
				PlaceThing_Tiles_PlaceIt_SpinChairs();
				PlaceThing_Tiles_PlaceIt_SpinBedsAndBaths();
			}
			PlaceThing_Tiles_PlaceIt_AdjustPlants();
			PlaceThing_Tiles_PlaceIt_SpinTraps();
			PlaceThing_Tiles_PlaceIt_TriggerLogicLamp();
			PlaceThing_Tiles_PlaceIt_SpinSmartPlatform();
			PlaceThing_Tiles_PlaceIt_ConsumeFlexibleWandMaterial();
			PlaceThing_Tiles_PlaceIt_UnslopeForSolids();
			PlaceThing_Tiles_PlaceIt_KillGrassForSolids();
			PlaceThing_Tiles_PlaceIt_AutoPaintAndActuate(tileDataCaches, tileToCreate);
			if (PlayerInput.UsingGamepad && ItemID.Sets.SingleUseInGamepad[inventory[selectedItem].type] && Main.myPlayer == whoAmI && !Main.SmartCursorIsUsed)
			{
				Main.blockMouse = true;
			}
		}
		return data;
	}

	public void PlaceThing_Tiles_PlaceIt_ConsumeFlexibleWandMaterial()
	{
		FlexibleTileWand flexibleTileWand = inventory[selectedItem].GetFlexibleTileWand();
		if (flexibleTileWand != null && flexibleTileWand.ConsumesAmmoItem && flexibleTileWand.TryGetPlacementOption(this, FlexibleWandRandomSeed, FlexibleWandCycleOffset, out var _, out var itemToConsume))
		{
			itemToConsume.stack--;
			if (itemToConsume.stack <= 0)
			{
				itemToConsume.TurnToAir();
			}
		}
	}

	private void TorchGodsFlavor()
	{
		if (whoAmI != Main.myPlayer || Main.rand.Next(10) != 0)
		{
			return;
		}
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].active && Main.projectile[i].type == 1084 && Main.projectile[i].owner == whoAmI)
			{
				return;
			}
		}
		int style = 0;
		int type = 4;
		BiomeTorchPlaceStyle(ref type, ref style, useWithoutTorchGodsFavor: true);
		int minValue = (int)(base.Center.X - (float)(NPC.sWidth / 2)) / 16;
		int num = (int)(base.Center.X + (float)(NPC.sWidth / 2)) / 16;
		int minValue2 = (int)(base.Center.Y - (float)(NPC.sHeight / 2)) / 16;
		int num2 = (int)(base.Center.Y + (float)(NPC.sHeight / 2)) / 16;
		int num3 = 1000;
		for (int j = 0; j < num3; j++)
		{
			int num4 = Main.rand.Next(minValue, num + 1);
			int num5 = Main.rand.Next(minValue2, num2 + 1);
			if (!WorldGen.InWorld(num4, num5))
			{
				continue;
			}
			Tile tile = Main.tile[num4, num5];
			if (tile != null && tile.active() && tile.type == type && !(ZoneDungeon ^ Main.wallDungeon[tile.wall]))
			{
				int num6 = tile.frameY / 22;
				if (TorchID.Sets.IsABiomeTorch[num6] && num6 != style)
				{
					Vector2 vector = new Vector2((float)num4 - base.Center.X / 16f, (float)num5 - base.Center.Y / 16f);
					vector.Normalize();
					vector *= 1500f;
					Vector2 vector2 = base.Center - vector;
					vector2.X += Main.rand.Next(400, 401);
					vector2.Y += Main.rand.Next(400, 401);
					Vector2 vector3 = new Vector2((float)(num4 * 16 + 8) - vector2.X, (float)(num5 * 16 + 8) - vector2.Y);
					vector3.Normalize();
					vector3 *= 16f;
					Projectile.NewProjectile(GetProjectileSource_Misc(10), vector2, vector3, 1084, 0, 0f, whoAmI, style, num4, num5);
					break;
				}
			}
		}
	}

	public void BiomeTorchPlaceStyle(ref int type, ref int style, bool useWithoutTorchGodsFavor = false)
	{
		if (useWithoutTorchGodsFavor || (UsingBiomeTorches && style == 0))
		{
			if (ZoneShimmer)
			{
				style = 23;
			}
			else if (ZoneDungeon)
			{
				style = 13;
			}
			else if (ZoneLihzhardTemple)
			{
				style = 21;
			}
			else if (position.Y > (float)(Main.UnderworldLayer * 16))
			{
				style = 7;
			}
			else if (ZoneGlowshroom)
			{
				style = 22;
			}
			else if (ZoneHallow)
			{
				style = 20;
			}
			else if (ZoneCorrupt)
			{
				style = 18;
			}
			else if (ZoneCrimson)
			{
				style = 19;
			}
			else if (ZoneSnow)
			{
				style = 9;
			}
			else if (ZoneJungle)
			{
				style = 21;
			}
			else if ((ZoneDesert && (double)position.Y < Main.worldSurface * 16.0) || ZoneUndergroundDesert)
			{
				style = 16;
			}
			else if (ZoneDesert && Main.remixWorld)
			{
				style = 16;
			}
		}
	}

	public int BiomeTorchHoldStyle(int itemType)
	{
		if (!UsingBiomeTorches || itemType != 8)
		{
			return itemType;
		}
		if (ZoneShimmer)
		{
			itemType = 5353;
		}
		else if (ZoneDungeon)
		{
			itemType = 3004;
		}
		else if (ZoneLihzhardTemple)
		{
			itemType = 4388;
		}
		else if (position.Y > (float)(Main.UnderworldLayer * 16))
		{
			itemType = 433;
		}
		else if (ZoneGlowshroom)
		{
			itemType = 5293;
		}
		else if (ZoneHallow)
		{
			itemType = 4387;
		}
		else if (ZoneCorrupt)
		{
			itemType = 4385;
		}
		else if (ZoneCrimson)
		{
			itemType = 4386;
		}
		else if (ZoneSnow)
		{
			itemType = 974;
		}
		else if (ZoneJungle)
		{
			itemType = 4388;
		}
		else if ((ZoneDesert && (double)position.Y < Main.worldSurface * 16.0) || ZoneUndergroundDesert)
		{
			itemType = 4383;
		}
		else if (ZoneDesert && Main.remixWorld)
		{
			itemType = 4383;
		}
		return itemType;
	}

	public void BiomeCampfirePlaceStyle(ref int type, ref int style)
	{
		if (UsingBiomeTorches && style == 0)
		{
			if (ZoneShimmer)
			{
				style = 15;
			}
			else if (ZoneGlowshroom)
			{
				style = 14;
			}
			else if (ZoneLihzhardTemple)
			{
				style = 13;
			}
			else if (ZoneDungeon)
			{
				style = 7;
			}
			else if (position.Y > (float)(Main.UnderworldLayer * 16))
			{
				style = 2;
			}
			else if (ZoneHallow)
			{
				style = 12;
			}
			else if (ZoneCorrupt)
			{
				style = 10;
			}
			else if (ZoneCrimson)
			{
				style = 11;
			}
			else if (ZoneSnow)
			{
				style = 3;
			}
			else if (ZoneJungle)
			{
				style = 13;
			}
			else if ((ZoneDesert && (double)position.Y < Main.worldSurface * 16.0) || ZoneUndergroundDesert)
			{
				style = 8;
			}
			else if (ZoneDesert && Main.remixWorld)
			{
				style = 8;
			}
		}
	}

	public int BiomeCampfireHoldStyle(int itemType)
	{
		if (!UsingBiomeTorches || itemType != 966)
		{
			return itemType;
		}
		if (ZoneShimmer)
		{
			itemType = 5357;
		}
		else if (ZoneGlowshroom)
		{
			itemType = 5299;
		}
		else if (ZoneLihzhardTemple)
		{
			itemType = 4694;
		}
		else if (ZoneDungeon)
		{
			itemType = 3724;
		}
		else if (position.Y > (float)(Main.UnderworldLayer * 16))
		{
			itemType = 3047;
		}
		else if (ZoneHallow)
		{
			itemType = 4693;
		}
		else if (ZoneCorrupt)
		{
			itemType = 4691;
		}
		else if (ZoneCrimson)
		{
			itemType = 4692;
		}
		else if (ZoneSnow)
		{
			itemType = 3048;
		}
		else if (ZoneJungle)
		{
			itemType = 4694;
		}
		else if ((ZoneDesert && (double)position.Y < Main.worldSurface * 16.0) || ZoneUndergroundDesert)
		{
			itemType = 4689;
		}
		else if (ZoneDesert && Main.remixWorld)
		{
			itemType = 4689;
		}
		return itemType;
	}

	private Vector3[,] PlaceThing_Tiles_GetAutoAccessoryCache()
	{
		Vector3[,] array = null;
		if (autoPaint || autoActuator)
		{
			array = new Vector3[11, 11];
			for (int i = 0; i < 11; i++)
			{
				for (int j = 0; j < 11; j++)
				{
					int num = tileTargetX - 5 + i;
					int num2 = tileTargetY - 5 + j;
					Tile tile = Main.tile[num, num2];
					if (Main.tile[num, num2].active())
					{
						array[i, j] = new Vector3((int)tile.type, tile.frameX, tile.frameY);
					}
					else
					{
						array[i, j] = new Vector3(-1f, -1f, -1f);
					}
				}
			}
		}
		return array;
	}

	private int PlaceThing_Tiles_PlaceIt_GetLegacyTileStyle(int style)
	{
		int createTile = inventory[selectedItem].createTile;
		if (createTile == 36)
		{
			style = Main.rand.Next(7);
		}
		if (createTile == 212 && direction > 0)
		{
			style = 1;
		}
		if (createTile == 141)
		{
			style = Main.rand.Next(2);
		}
		if (createTile == 128 || createTile == 269 || createTile == 334)
		{
			style = ((direction >= 0) ? 1 : (-1));
		}
		if (createTile == 241 && inventory[selectedItem].placeStyle == 0)
		{
			style = Main.rand.Next(0, 9);
		}
		if (createTile == 35 && inventory[selectedItem].placeStyle == 0)
		{
			style = Main.rand.Next(9);
		}
		if (createTile == 314 && style == 2 && direction == 1)
		{
			style++;
		}
		if (createTile == 129)
		{
			style = (short)Main.rand.Next(18);
		}
		return style;
	}

	private void PlaceThing_Tiles_PlaceIt_UnslopeForSolids()
	{
		if (inventory[selectedItem].createTile < 0 || !Main.tileSolid[inventory[selectedItem].createTile] || TileID.Sets.Platforms[inventory[selectedItem].createTile])
		{
			return;
		}
		int num = tileTargetX;
		int num2 = tileTargetY + 1;
		if (Main.tile[num, num2] != null && !TileID.Sets.Platforms[Main.tile[num, num2].type] && (Main.tile[num, num2].topSlope() || Main.tile[num, num2].halfBrick()))
		{
			WorldGen.SlopeTile(num, num2);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 14, num, num2);
			}
		}
		num = tileTargetX;
		num2 = tileTargetY - 1;
		if (Main.tile[num, num2] != null && !TileID.Sets.Platforms[Main.tile[num, num2].type] && Main.tile[num, num2].bottomSlope())
		{
			WorldGen.SlopeTile(num, num2);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 14, num, num2);
			}
		}
	}

	private void PlaceThing_Tiles_PlaceIt_KillGrassForSolids()
	{
		if (inventory[selectedItem].createTile < 0 || !Main.tileSolid[inventory[selectedItem].createTile])
		{
			return;
		}
		for (int i = tileTargetX - 1; i <= tileTargetX + 1; i++)
		{
			for (int j = tileTargetY - 1; j <= tileTargetY + 1; j++)
			{
				Tile tile = Main.tile[i, j];
				if (!tile.active() || inventory[selectedItem].createTile == tile.type || (tile.type != 2 && tile.type != 23 && tile.type != 60 && tile.type != 70 && tile.type != 109 && tile.type != 199 && tile.type != 477 && tile.type != 492 && tile.type != 633))
				{
					continue;
				}
				bool flag = true;
				for (int k = i - 1; k <= i + 1; k++)
				{
					for (int l = j - 1; l <= j + 1; l++)
					{
						if (!WorldGen.SolidTile(k, l))
						{
							flag = false;
						}
					}
				}
				if (flag)
				{
					WorldGen.KillTile(i, j, fail: true);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, i, j, 1f);
					}
				}
			}
		}
	}

	private void PlaceThing_Tiles_PlaceIt_AutoPaintAndActuate(Vector3[,] tileDataCaches, int tileToCreate)
	{
		if (!autoPaint && !autoActuator)
		{
			return;
		}
		Tile tile = Main.tile[tileTargetX, tileTargetY];
		int num = 0;
		int num2 = 0;
		int num3 = 11;
		int num4 = 11;
		bool flag = TileID.Sets.Platforms[tile.type];
		bool flag2 = (TileID.Sets.BasicChest[tile.type] && TileID.Sets.BasicChest[tileToCreate]) || (TileID.Sets.BasicChestFake[tile.type] && TileID.Sets.BasicChestFake[tileToCreate]) || (TileID.Sets.BasicDresser[tile.type] && TileID.Sets.BasicDresser[tileToCreate]) || (TileID.Sets.Campfires[tile.type] && TileID.Sets.Campfires[tileToCreate]) || (TileID.Sets.Torches[tile.type] && TileID.Sets.Torches[tileToCreate]);
		bool flag3 = flag2 || (TileID.Sets.Platforms[tile.type] && TileID.Sets.Platforms[tileToCreate]);
		if (!Main.tileFrameImportant[tile.type] || flag)
		{
			num = (num2 = 5);
			num3 = (num4 = 6);
		}
		for (int i = num; i < num3; i++)
		{
			for (int j = num2; j < num4; j++)
			{
				int num5 = tileTargetX - 5 + i;
				int num6 = tileTargetY - 5 + j;
				Tile tile2 = Main.tile[num5, num6];
				if (!tile2.active() || tile2.type != tileToCreate)
				{
					continue;
				}
				Vector3 vector = tileDataCaches[i, j];
				int num7 = (int)vector.X;
				int num8 = (int)vector.Y;
				int num9 = (int)vector.Z;
				if ((!flag3 && tile2.type == num7) || (flag2 && tile2.type == num7 && tile2.frameX == num8 && tile2.frameY == num9))
				{
					continue;
				}
				if (autoPaint && builderAccStatus[3] == 0)
				{
					TryPainting(num5, num6, paintingAWall: false, applyItemAnimation: false);
				}
				if (!autoActuator || builderAccStatus[2] != 0)
				{
					continue;
				}
				bool flag4 = Main.tile[num5, num6].active() && Main.tileSolid[Main.tile[num5, num6].type] && !TileID.Sets.NotReallySolid[Main.tile[num5, num6].type];
				switch (Main.tile[num5, num6].type)
				{
				case 314:
				case 379:
				case 386:
				case 387:
				case 388:
				case 389:
				case 476:
					flag4 = false;
					break;
				}
				if (!flag4)
				{
					continue;
				}
				int num10 = FindItem(849);
				if (num10 > -1 && WorldGen.PlaceActuator(num5, num6))
				{
					NetMessage.SendData(17, -1, -1, null, 8, num5, num6);
					inventory[num10].stack--;
					if (inventory[num10].stack <= 0)
					{
						inventory[num10].SetDefaults(0);
					}
				}
			}
		}
	}

	private void PlaceThing_Tiles_PlaceIt_SpinSmartPlatform()
	{
		if (inventory[selectedItem].createTile < 0 || !TileID.Sets.Platforms[inventory[selectedItem].createTile] || !Main.SmartCursorIsUsed)
		{
			return;
		}
		int num = tileTargetX;
		int num2 = tileTargetY;
		bool flag = true;
		for (int i = -1; i < 2; i++)
		{
			for (int j = -1; j < 2; j++)
			{
				if ((i != 0 || j != 0) && TileID.Sets.Platforms[Main.tile[num + i, num2 + j].type])
				{
					flag = false;
				}
			}
		}
		if (flag)
		{
			return;
		}
		int smartPlatformSlope = GetSmartPlatformSlope(num, num2);
		int num3;
		Tile tile;
		if (smartPlatformSlope != 0)
		{
			WorldGen.SlopeTile(num, num2, smartPlatformSlope, noEffects: true, quiet: false);
			int num4;
			if (smartPlatformSlope == 1)
			{
				num3 = -1;
				num4 = -1;
			}
			else
			{
				num3 = 1;
				num4 = -1;
			}
			tile = Main.tile[num + num3, num2 + num4];
			Tile tile2 = Main.tile[num + num3 + num3, num2 + num4];
			if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() == 0 && (!tile2.active() || !TileID.Sets.Platforms[tile2.type] || !tile2.halfBrick()))
			{
				WorldGen.SlopeTile(num + num3, num2 + num4, smartPlatformSlope, noEffects: false, quiet: false);
				tile = Main.tile[num + 2 * num3, num2 + 2 * num4];
				if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() == 0)
				{
					WorldGen.SlopeTile(num + 2 * num3, num2 + 2 * num4, smartPlatformSlope, noEffects: false, quiet: false);
				}
			}
			if (smartPlatformSlope == 1)
			{
				num3 = 1;
				num4 = 1;
			}
			else
			{
				num3 = -1;
				num4 = 1;
			}
			tile = Main.tile[num + num3, num2 + num4];
			if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() == 0)
			{
				tile = Main.tile[num + num3 + 1, num2 + num4];
				int num5 = 0 | ((tile.active() && TileID.Sets.Platforms[tile.type]) ? 1 : 0);
				tile = Main.tile[num + num3 - 1, num2 + num4];
				if (((uint)num5 | ((tile.active() && TileID.Sets.Platforms[tile.type]) ? 1u : 0u)) == 0)
				{
					WorldGen.SlopeTile(num + num3, num2 + num4, smartPlatformSlope, noEffects: false, quiet: false);
				}
			}
			return;
		}
		num3 = -1;
		tile = Main.tile[num + num3, num2];
		if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() != 0)
		{
			Tile tile3 = Main.tile[num + num3 + ((tile.slope() == 1) ? 1 : (-1)), num2 + 1];
			int num6 = ((tile.slope() != 1) ? 1 : 2);
			if (!tile3.active() || !TileID.Sets.Platforms[tile3.type] || tile3.slope() == num6)
			{
				WorldGen.SlopeTile(num + num3, num2, smartPlatformSlope, noEffects: false, quiet: false);
			}
		}
		num3 = 1;
		tile = Main.tile[num + num3, num2];
		if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() != 0)
		{
			Tile tile4 = Main.tile[num + num3 + ((tile.slope() == 1) ? 1 : (-1)), num2 + 1];
			int num7 = ((tile.slope() != 1) ? 1 : 2);
			if (!tile4.active() || !TileID.Sets.Platforms[tile4.type] || tile4.slope() == num7)
			{
				WorldGen.SlopeTile(num + num3, num2, smartPlatformSlope, noEffects: false, quiet: false);
			}
		}
	}

	public static int GetSmartPlatformSlope(int x, int y)
	{
		int num = 0;
		int num2 = 0;
		Tile tile = Main.tile[x, y - 1];
		bool flag = tile.active() && TileID.Sets.Platforms[tile.type];
		tile = Main.tile[x - 1, y - 1];
		if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() != 2)
		{
			num += ((tile.slope() == 1) ? 2 : ((!flag) ? 1 : 0));
		}
		tile = Main.tile[x + 1, y - 1];
		if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() != 1)
		{
			num2 += ((tile.slope() == 2) ? 2 : ((!flag) ? 1 : 0));
		}
		tile = Main.tile[x, y + 1];
		bool flag2 = tile.active() && TileID.Sets.Platforms[tile.type];
		tile = Main.tile[x - 1, y + 1];
		if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() != 1)
		{
			num2 += ((tile.slope() == 2) ? 2 : ((!flag2) ? 1 : 0));
		}
		tile = Main.tile[x + 1, y + 1];
		if (tile.active() && TileID.Sets.Platforms[tile.type] && tile.slope() != 2)
		{
			num += ((tile.slope() == 1) ? 2 : ((!flag2) ? 1 : 0));
		}
		tile = Main.tile[x - 1, y];
		if (WorldGen.SolidTile(tile))
		{
			num++;
		}
		tile = Main.tile[x + 1, y];
		if (WorldGen.SolidTile(tile))
		{
			num2++;
		}
		int result = 0;
		if (num > num2)
		{
			result = 1;
		}
		if (num2 > num)
		{
			result = 2;
		}
		tile = Main.tile[x - 1, y];
		if (tile.active() && TileID.Sets.Platforms[tile.type])
		{
			result = 0;
		}
		tile = Main.tile[x + 1, y];
		if (tile.active() && TileID.Sets.Platforms[tile.type])
		{
			result = 0;
		}
		return result;
	}

	private void PlaceThing_Tiles_PlaceIt_TriggerLogicLamp()
	{
		if (inventory[selectedItem].createTile == 419)
		{
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 18, tileTargetX, tileTargetY);
			}
			else
			{
				Wiring.PokeLogicGate(tileTargetX, tileTargetY);
			}
		}
	}

	private void PlaceThing_Tiles_PlaceIt_SpinBedsAndBaths()
	{
		if ((inventory[selectedItem].createTile == 79 || inventory[selectedItem].createTile == 90) && Main.netMode == 1)
		{
			NetMessage.SendTileSquare(-1, tileTargetX, tileTargetY, 5);
		}
	}

	private void PlaceThing_Tiles_PlaceIt_SpinChairs()
	{
		if (inventory[selectedItem].createTile == 15)
		{
			if (direction == 1)
			{
				Main.tile[tileTargetX, tileTargetY].frameX += 18;
				Main.tile[tileTargetX, tileTargetY - 1].frameX += 18;
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, tileTargetX - 1, tileTargetY - 1, 3);
			}
		}
	}

	private void PlaceThing_Tiles_PlaceIt_SpinTraps()
	{
		if (inventory[selectedItem].createTile == 137)
		{
			if (direction == 1)
			{
				Main.tile[tileTargetX, tileTargetY].frameX += 18;
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, tileTargetX, tileTargetY);
			}
		}
	}

	private void PlaceThing_Tiles_PlaceIt_AdjustPlants()
	{
		if (inventory[selectedItem].createTile != 3)
		{
			return;
		}
		FlowerPacketInfo flowerPacketInfo = ItemID.Sets.flowerPacketInfo[inventory[selectedItem].type];
		if (flowerPacketInfo == null)
		{
			return;
		}
		List<int> stylesOnPurity = flowerPacketInfo.stylesOnPurity;
		if (stylesOnPurity.Count != 0)
		{
			int num = stylesOnPurity[Main.rand.Next(stylesOnPurity.Count)];
			Main.tile[tileTargetX, tileTargetY].frameX = (short)(num * 18);
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, tileTargetX, tileTargetY);
			}
		}
	}

	private bool PlaceThing_Tiles_PlaceIt_StaffOfRegrowthCheck(bool placed)
	{
		bool flag = inventory[selectedItem].type == 213 || inventory[selectedItem].type == 5295;
		if (flag && !placed && Main.tile[tileTargetX, tileTargetY].type == 1 && Main.tile[tileTargetX, tileTargetY].active())
		{
			int num = 0;
			int num2 = 0;
			Point point = base.Center.ToTileCoordinates();
			Dictionary<ushort, int> dictionary = new Dictionary<ushort, int>();
			WorldUtils.Gen(new Point(point.X - 25, point.Y - 25), new Shapes.Rectangle(50, 50), new Actions.TileScanner(182, 515, 180, 513, 179, 512, 183, 516, 181, 514, 381, 517, 534, 535, 536, 537, 539, 540, 625, 626, 627, 628).Output(dictionary));
			foreach (KeyValuePair<ushort, int> item in dictionary)
			{
				if (item.Value > num2)
				{
					num2 = item.Value;
					num = item.Key;
				}
			}
			switch (num)
			{
			case 515:
				num = 182;
				break;
			case 513:
				num = 180;
				break;
			case 512:
				num = 179;
				break;
			case 516:
				num = 183;
				break;
			case 514:
				num = 181;
				break;
			case 517:
				num = 381;
				break;
			case 535:
				num = 534;
				break;
			case 537:
				num = 536;
				break;
			case 540:
				num = 539;
				break;
			case 626:
				num = 625;
				break;
			case 628:
				num = 627;
				break;
			}
			if (num2 == 0)
			{
				num = Utils.SelectRandom<int>(Main.rand, 182, 180, 179, 183, 181);
			}
			if (num != 0)
			{
				Main.tile[tileTargetX, tileTargetY].type = (ushort)num;
				WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
				NetMessage.SendTileSquare(-1, tileTargetX, tileTargetY);
				placed = true;
			}
		}
		if (flag && !placed && Main.tile[tileTargetX, tileTargetY].type == 38 && Main.tile[tileTargetX, tileTargetY].active())
		{
			int num3 = 0;
			int num4 = 0;
			Point point2 = base.Center.ToTileCoordinates();
			Dictionary<ushort, int> dictionary2 = new Dictionary<ushort, int>();
			WorldUtils.Gen(new Point(point2.X - 25, point2.Y - 25), new Shapes.Rectangle(50, 50), new Actions.TileScanner(182, 515, 180, 513, 179, 512, 183, 516, 181, 514, 381, 517, 534, 535, 536, 537, 539, 540, 625, 626, 627, 628).Output(dictionary2));
			foreach (KeyValuePair<ushort, int> item2 in dictionary2)
			{
				if (item2.Value > num4)
				{
					num4 = item2.Value;
					num3 = item2.Key;
				}
			}
			switch (num3)
			{
			case 182:
				num3 = 515;
				break;
			case 180:
				num3 = 513;
				break;
			case 179:
				num3 = 512;
				break;
			case 183:
				num3 = 516;
				break;
			case 181:
				num3 = 514;
				break;
			case 381:
				num3 = 517;
				break;
			case 534:
				num3 = 535;
				break;
			case 536:
				num3 = 537;
				break;
			case 539:
				num3 = 540;
				break;
			case 625:
				num3 = 626;
				break;
			case 627:
				num3 = 628;
				break;
			}
			if (num4 == 0)
			{
				num3 = Utils.SelectRandom<int>(Main.rand, 515, 513, 512, 516, 514);
			}
			if (num3 != 0)
			{
				Main.tile[tileTargetX, tileTargetY].type = (ushort)num3;
				WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
				NetMessage.SendTileSquare(-1, tileTargetX, tileTargetY);
				placed = true;
			}
		}
		return placed;
	}

	private bool PlaceThing_Tiles_BlockPlacementForAssortedThings(bool canPlace)
	{
		if (HeldItem.type == 213 || HeldItem.type == 5295)
		{
			staffOfRegrowthBonus = true;
		}
		bool flag = staffOfRegrowthBonus;
		if (flag)
		{
			if (Main.tile[tileTargetX, tileTargetY].type == 0 || Main.tile[tileTargetX, tileTargetY].type == 1 || Main.tile[tileTargetX, tileTargetY].type == 38)
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 2 || inventory[selectedItem].createTile == 109)
		{
			if (Main.tile[tileTargetX, tileTargetY].nactive() && Main.tile[tileTargetX, tileTargetY].type == 0)
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile >= 0 && Main.tileMoss[inventory[selectedItem].createTile])
		{
			Tile tile = Main.tile[tileTargetX, tileTargetY];
			if (tile.nactive() && (tile.type == 1 || tile.type == 38))
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 23 || inventory[selectedItem].createTile == 199)
		{
			if (Main.tile[tileTargetX, tileTargetY].nactive())
			{
				if (Main.tile[tileTargetX, tileTargetY].type == 0)
				{
					canPlace = true;
				}
				else if (Main.tile[tileTargetX, tileTargetY].type == 59)
				{
					canPlace = true;
				}
			}
		}
		else if (inventory[selectedItem].createTile == 227)
		{
			canPlace = true;
		}
		else if (TileID.Sets.IsADripTile[inventory[selectedItem].createTile])
		{
			int num = tileTargetX;
			int num2 = tileTargetY - 1;
			if (Main.tile[num, num2].nactive() && Main.tileSolid[Main.tile[num, num2].type] && !Main.tileSolidTop[Main.tile[num, num2].type])
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 60 || inventory[selectedItem].createTile == 70 || inventory[selectedItem].createTile == 661 || inventory[selectedItem].createTile == 662)
		{
			if (Main.tile[tileTargetX, tileTargetY].nactive() && Main.tile[tileTargetX, tileTargetY].type == 59)
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 633)
		{
			if (Main.tile[tileTargetX, tileTargetY].nactive() && Main.tile[tileTargetX, tileTargetY].type == 57)
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 4 || inventory[selectedItem].createTile == 136)
		{
			if (Main.tile[tileTargetX, tileTargetY].wall > 0)
			{
				canPlace = true;
			}
			else
			{
				if (!WorldGen.SolidTileNoAttach(tileTargetX, tileTargetY + 1) && !WorldGen.SolidTileNoAttach(tileTargetX - 1, tileTargetY) && !WorldGen.SolidTileNoAttach(tileTargetX + 1, tileTargetY))
				{
					if (!WorldGen.SolidTileNoAttach(tileTargetX, tileTargetY + 1) && (Main.tile[tileTargetX, tileTargetY + 1].halfBrick() || Main.tile[tileTargetX, tileTargetY + 1].slope() != 0))
					{
						if (!TileID.Sets.Platforms[Main.tile[tileTargetX, tileTargetY + 1].type])
						{
							WorldGen.SlopeTile(tileTargetX, tileTargetY + 1);
							if (Main.netMode == 1)
							{
								NetMessage.SendData(17, -1, -1, null, 14, tileTargetX, tileTargetY + 1);
							}
						}
					}
					else if (!WorldGen.SolidTileNoAttach(tileTargetX, tileTargetY + 1) && !WorldGen.SolidTileNoAttach(tileTargetX - 1, tileTargetY) && (Main.tile[tileTargetX - 1, tileTargetY].halfBrick() || Main.tile[tileTargetX - 1, tileTargetY].slope() != 0))
					{
						if (!TileID.Sets.Platforms[Main.tile[tileTargetX - 1, tileTargetY].type])
						{
							WorldGen.SlopeTile(tileTargetX - 1, tileTargetY);
							if (Main.netMode == 1)
							{
								NetMessage.SendData(17, -1, -1, null, 14, tileTargetX - 1, tileTargetY);
							}
						}
					}
					else if (!WorldGen.SolidTileNoAttach(tileTargetX, tileTargetY + 1) && !WorldGen.SolidTileNoAttach(tileTargetX + 1, tileTargetY) && (Main.tile[tileTargetX + 1, tileTargetY].halfBrick() || Main.tile[tileTargetX + 1, tileTargetY].slope() != 0) && !TileID.Sets.Platforms[Main.tile[tileTargetX + 1, tileTargetY].type])
					{
						WorldGen.SlopeTile(tileTargetX + 1, tileTargetY);
						if (Main.netMode == 1)
						{
							NetMessage.SendData(17, -1, -1, null, 14, tileTargetX + 1, tileTargetY);
						}
					}
				}
				int num3 = Main.tile[tileTargetX, tileTargetY + 1].type;
				if (Main.tile[tileTargetX, tileTargetY].halfBrick())
				{
					num3 = -1;
				}
				int num4 = Main.tile[tileTargetX - 1, tileTargetY].type;
				int num5 = Main.tile[tileTargetX + 1, tileTargetY].type;
				int tree = Main.tile[tileTargetX - 1, tileTargetY - 1].type;
				int tree2 = Main.tile[tileTargetX + 1, tileTargetY - 1].type;
				int tree3 = Main.tile[tileTargetX - 1, tileTargetY - 1].type;
				int tree4 = Main.tile[tileTargetX + 1, tileTargetY + 1].type;
				if (!Main.tile[tileTargetX, tileTargetY + 1].nactive())
				{
					num3 = -1;
				}
				if (!Main.tile[tileTargetX - 1, tileTargetY].nactive())
				{
					num4 = -1;
				}
				if (!Main.tile[tileTargetX + 1, tileTargetY].nactive())
				{
					num5 = -1;
				}
				if (!Main.tile[tileTargetX - 1, tileTargetY - 1].nactive())
				{
					tree = -1;
				}
				if (!Main.tile[tileTargetX + 1, tileTargetY - 1].nactive())
				{
					tree2 = -1;
				}
				if (!Main.tile[tileTargetX - 1, tileTargetY + 1].nactive())
				{
					tree3 = -1;
				}
				if (!Main.tile[tileTargetX + 1, tileTargetY + 1].nactive())
				{
					tree4 = -1;
				}
				if (num3 >= 0 && Main.tileSolid[num3] && (!Main.tileNoAttach[num3] || (num3 >= 0 && TileID.Sets.Platforms[num3])))
				{
					canPlace = true;
				}
				else if ((num4 >= 0 && Main.tileSolid[num4] && !Main.tileNoAttach[num4]) || (WorldGen.IsTreeType(num4) && WorldGen.IsTreeType(tree) && WorldGen.IsTreeType(tree3)) || (num4 >= 0 && TileID.Sets.IsBeam[num4]))
				{
					canPlace = true;
				}
				else if ((num5 >= 0 && Main.tileSolid[num5] && !Main.tileNoAttach[num5]) || (WorldGen.IsTreeType(num5) && WorldGen.IsTreeType(tree2) && WorldGen.IsTreeType(tree4)) || (num5 >= 0 && TileID.Sets.IsBeam[num5]))
				{
					canPlace = true;
				}
			}
		}
		else if (inventory[selectedItem].createTile == 78 || inventory[selectedItem].createTile == 98 || inventory[selectedItem].createTile == 100 || inventory[selectedItem].createTile == 173 || inventory[selectedItem].createTile == 174 || inventory[selectedItem].createTile == 324)
		{
			if (Main.tile[tileTargetX, tileTargetY + 1].nactive() && (Main.tileSolid[Main.tile[tileTargetX, tileTargetY + 1].type] || Main.tileTable[Main.tile[tileTargetX, tileTargetY + 1].type]))
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 419)
		{
			if (Main.tile[tileTargetX, tileTargetY + 1].active() && (Main.tile[tileTargetX, tileTargetY + 1].type == 419 || (inventory[selectedItem].placeStyle != 2 && Main.tile[tileTargetX, tileTargetY + 1].type == 420)))
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 13 || inventory[selectedItem].createTile == 29 || inventory[selectedItem].createTile == 33 || inventory[selectedItem].createTile == 49 || inventory[selectedItem].createTile == 50 || inventory[selectedItem].createTile == 103)
		{
			if (Main.tile[tileTargetX, tileTargetY + 1].nactive() && Main.tileTable[Main.tile[tileTargetX, tileTargetY + 1].type])
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 275 || inventory[selectedItem].createTile == 276 || inventory[selectedItem].createTile == 277)
		{
			canPlace = true;
		}
		else if (inventory[selectedItem].createTile == 51 || inventory[selectedItem].createTile == 697 || inventory[selectedItem].createTile == 330 || inventory[selectedItem].createTile == 331 || inventory[selectedItem].createTile == 332 || inventory[selectedItem].createTile == 333 || inventory[selectedItem].createTile == 336 || inventory[selectedItem].createTile == 340 || inventory[selectedItem].createTile == 342 || inventory[selectedItem].createTile == 341 || inventory[selectedItem].createTile == 343 || inventory[selectedItem].createTile == 344 || inventory[selectedItem].createTile == 379 || inventory[selectedItem].createTile == 351)
		{
			if (Main.tile[tileTargetX + 1, tileTargetY].active() || Main.tile[tileTargetX + 1, tileTargetY].wall > 0 || Main.tile[tileTargetX - 1, tileTargetY].active() || Main.tile[tileTargetX - 1, tileTargetY].wall > 0 || Main.tile[tileTargetX, tileTargetY + 1].active() || Main.tile[tileTargetX, tileTargetY + 1].wall > 0 || Main.tile[tileTargetX, tileTargetY - 1].active() || Main.tile[tileTargetX, tileTargetY - 1].wall > 0)
			{
				canPlace = true;
			}
		}
		else if (inventory[selectedItem].createTile == 314)
		{
			for (int i = tileTargetX - 1; i <= tileTargetX + 1; i++)
			{
				for (int j = tileTargetY - 1; j <= tileTargetY + 1; j++)
				{
					Tile tile2 = Main.tile[i, j];
					if (tile2.active() || tile2.wall > 0)
					{
						canPlace = true;
						break;
					}
				}
			}
		}
		else
		{
			Tile tile3 = Main.tile[tileTargetX - 1, tileTargetY];
			Tile tile4 = Main.tile[tileTargetX + 1, tileTargetY];
			Tile tile5 = Main.tile[tileTargetX, tileTargetY - 1];
			Tile tile6 = Main.tile[tileTargetX, tileTargetY + 1];
			if ((tile4.active() && (Main.tileSolid[tile4.type] || TileID.Sets.IsBeam[tile4.type] || Main.tileRope[tile4.type] || tile4.type == 314)) || tile4.wall > 0 || (tile3.active() && (Main.tileSolid[tile3.type] || TileID.Sets.IsBeam[tile3.type] || Main.tileRope[tile3.type] || tile3.type == 314)) || tile3.wall > 0 || (tile6.active() && (Main.tileSolid[tile6.type] || TileID.Sets.IsBeam[tile6.type] || Main.tileRope[tile6.type] || tile6.type == 314)) || tile6.wall > 0 || (tile5.active() && (Main.tileSolid[tile5.type] || TileID.Sets.IsBeam[tile5.type] || Main.tileRope[tile5.type] || tile5.type == 314)) || tile5.wall > 0)
			{
				canPlace = true;
			}
			else if (Main.tile[tileTargetX, tileTargetY].wall > 0)
			{
				canPlace = true;
			}
		}
		if (flag && Main.tile[tileTargetX, tileTargetY].active())
		{
			int num6 = tileTargetX;
			int num7 = tileTargetY;
			if (Main.tile[num6, num7].type == 3 || Main.tile[num6, num7].type == 73 || Main.tile[num6, num7].type == 84)
			{
				int type = Main.tile[num6, num7].type;
				int herbStyle = Main.tile[num6, num7].frameX / 18;
				WorldGen.KillTile(tileTargetX, tileTargetY);
				if (!Main.tile[tileTargetX, tileTargetY].active())
				{
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, tileTargetX, tileTargetY);
					}
					if (type == 84)
					{
						TryReplantingHerbs(herbStyle);
					}
				}
			}
			else if (Main.tile[num6, num7].type == 83)
			{
				int num8 = Main.tile[num6, num7].frameX / 18;
				if (WorldGen.IsAlchemyPlantHarvestable(num8, num7))
				{
					WorldGen.KillTile(tileTargetX, tileTargetY);
					NetMessage.SendData(17, -1, -1, null, 0, tileTargetX, tileTargetY);
					TryReplantingHerbs(num8);
				}
			}
		}
		if (Main.tileAlch[inventory[selectedItem].createTile])
		{
			canPlace = true;
		}
		bool flag2 = true;
		if (flag && !canPlace)
		{
			flag2 = false;
		}
		if (flag2 && Main.tile[tileTargetX, tileTargetY].active() && (Main.tileCut[Main.tile[tileTargetX, tileTargetY].type] || TileID.Sets.BreakableWhenPlacing[Main.tile[tileTargetX, tileTargetY].type] || TileID.Sets.IsADripTile[Main.tile[tileTargetX, tileTargetY].type]))
		{
			if (Main.tile[tileTargetX, tileTargetY].type != inventory[selectedItem].createTile)
			{
				bool num9 = Main.tile[tileTargetX, tileTargetY + 1].type != 78 && Main.tile[tileTargetX, tileTargetY + 1].type != 380 && Main.tile[tileTargetX, tileTargetY + 1].type != 579;
				bool flag3 = Main.tile[tileTargetX, tileTargetY].type == 3 || Main.tile[tileTargetX, tileTargetY].type == 73;
				bool flag4 = Main.tileAlch[Main.tile[tileTargetX, tileTargetY].type] && WorldGen.IsHarvestableHerbWithSeed(Main.tile[tileTargetX, tileTargetY].type, Main.tile[tileTargetX, tileTargetY].frameX / 18, tileTargetY);
				bool flag5 = Main.tileAlch[inventory[selectedItem].createTile];
				if (num9 || ((flag3 || flag4) && flag5))
				{
					WorldGen.KillTile(tileTargetX, tileTargetY);
					if (!Main.tile[tileTargetX, tileTargetY].active() && Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, tileTargetX, tileTargetY);
					}
				}
				else
				{
					canPlace = false;
				}
			}
			else
			{
				canPlace = false;
			}
		}
		if (!canPlace && inventory[selectedItem].createTile >= 0 && TileID.Sets.Platforms[inventory[selectedItem].createTile])
		{
			for (int k = tileTargetX - 1; k <= tileTargetX + 1; k++)
			{
				for (int l = tileTargetY - 1; l <= tileTargetY + 1; l++)
				{
					if (Main.tile[k, l].active())
					{
						canPlace = true;
						break;
					}
				}
			}
		}
		if (inventory[selectedItem].createTile == 3)
		{
			canPlace = WorldGen.IsFitToPlaceFlowerIn(tileTargetX, tileTargetY, 3);
			if (canPlace)
			{
				WorldGen.KillTile(tileTargetX, tileTargetY);
				if (Main.netMode == 1 && !Main.tile[tileTargetX, tileTargetY].active())
				{
					NetMessage.SendData(17, -1, -1, null, 0, tileTargetX, tileTargetY);
				}
			}
		}
		staffOfRegrowthBonus = false;
		return canPlace;
	}

	private static void PlaceThing_Tiles_BlockPlacementForRepeatedPumpkins(ref bool canPlace, ref TileObject data)
	{
		if (data.type != 254)
		{
			return;
		}
		for (int i = -1; i < 1; i++)
		{
			for (int j = 0; j < 2; j++)
			{
				if (!WorldGen.CanCutTile(tileTargetX + j, tileTargetY + i, TileCuttingContext.TilePlacement))
				{
					canPlace = false;
				}
			}
		}
	}

	private static void PlaceThing_Tiles_BlockPlacementForRepeatedRainbowBoulders(ref bool canPlace, ref TileObject data)
	{
		if (data.type != 711)
		{
			return;
		}
		for (int i = 0; i < 2; i++)
		{
			for (int j = 0; j < 2; j++)
			{
				Tile tile = Main.tile[tileTargetX + i, tileTargetY + j];
				if (tile.active() && tile.type == 711)
				{
					canPlace = false;
				}
			}
		}
	}

	private static void PlaceThing_Tiles_BlockPlacementForRepeatedCoralAndBeachPiles(ref bool canPlace, ref TileObject data)
	{
		if (data.type == 81 || data.type == 324)
		{
			Tile tile = Main.tile[tileTargetX, tileTargetY];
			if (tile.active() && (Main.tileCut[tile.type] || TileID.Sets.BreakableWhenPlacing[tile.type] || TileID.Sets.IsADripTile[tile.type]))
			{
				canPlace = false;
			}
		}
	}

	private static void PlaceThing_Tiles_BlockPlacementForRepeatedPigronatas(ref bool canPlace, ref TileObject data)
	{
		if (data.type != 454)
		{
			return;
		}
		for (int i = -2; i < 2; i++)
		{
			Tile tile = Main.tile[tileTargetX + i, tileTargetY];
			if (tile.active() && tile.type == 454)
			{
				canPlace = false;
			}
		}
	}

	private static void PlaceThing_Tiles_BlockPlacementIfOverPlayers(ref bool canPlace, ref TileObject data)
	{
		int num = 0;
		int num2 = 0;
		int x = 0;
		int y = 0;
		switch (data.type)
		{
		case 138:
		case 664:
		case 711:
		case 712:
		case 713:
		case 714:
		case 715:
		case 716:
			num = 32;
			num2 = 32;
			x = data.xCoord * 16;
			y = data.yCoord * 16;
			break;
		case 484:
			num = 32;
			num2 = 32;
			x = data.xCoord * 16;
			y = data.yCoord * 16;
			break;
		case 235:
			num = 48;
			num2 = 16;
			x = data.xCoord * 16;
			y = data.yCoord * 16;
			break;
		case 476:
			num = 16;
			num2 = 16;
			x = data.xCoord * 16;
			y = data.yCoord * 16;
			break;
		case 387:
			num = 32;
			num2 = 16;
			x = data.xCoord * 16;
			y = data.yCoord * 16;
			break;
		}
		if (num == 0 || num2 == 0)
		{
			return;
		}
		Rectangle value = new Rectangle(x, y, num, num2);
		for (int i = 0; i < 255; i++)
		{
			Player player = Main.player[i];
			if (player.active && !player.dead && !player.ghost && player.Hitbox.Intersects(value))
			{
				canPlace = false;
				break;
			}
		}
	}

	private bool PlaceThing_Tiles_IsBlockedByLava(int createTile, int placeStyle, Tile targetTile)
	{
		bool result = false;
		if (targetTile.liquid > 0 && targetTile.lava())
		{
			if (Main.tileSolid[createTile])
			{
				result = true;
			}
			else if (!TileObjectData.CheckLiquidPlacement(createTile, placeStyle, targetTile))
			{
				result = true;
			}
		}
		return result;
	}

	private bool PlaceThing_Tiles_CheckRopeUsability(bool canUse)
	{
		int num = 5;
		if (Main.tileRope[inventory[selectedItem].createTile] && canUse && Main.tile[tileTargetX, tileTargetY].active() && Main.tileRope[Main.tile[tileTargetX, tileTargetY].type])
		{
			int num2 = 0;
			int num3 = tileTargetY;
			int num4 = tileTargetX;
			bool flag = inventory[selectedItem].createTile == 214;
			while (Main.tile[num4, num3].active() && (Main.tileRope[Main.tile[num4, num3].type] || Main.tile[num4, num3].type == 314 || TileID.Sets.Platforms[Main.tile[num4, num3].type] || Main.tile[num4, num3].type == 380) && num3 < Main.maxTilesY - 5 && (flag || !Main.tile[num4, num3 + 1].lava()))
			{
				if (Main.tile[num4, num3].type == 314 || TileID.Sets.Platforms[Main.tile[num4, num3].type] || Main.tile[num4, num3].type == 380)
				{
					num2++;
					if (num2 > num)
					{
						break;
					}
				}
				else
				{
					num2 = 0;
				}
				num3++;
				if (Main.tile[num4, num3 + 1] == null)
				{
					if (controlUseItem)
					{
						NetMessage.SendData(159, -1, -1, null, num4 / 200, (num3 + 1) / 150);
					}
					return false;
				}
			}
			Tile tile = Main.tile[num4, num3];
			if (!tile.active() || (tile.type >= 0 && tile.type < TileID.Count && (Main.tileCut[tile.type] || TileID.Sets.BreakableWhenPlacing[tile.type])))
			{
				tileTargetY = num3;
			}
		}
		return canUse;
	}

	private bool PlaceThing_Tiles_CheckFlexibleWand(bool canUse)
	{
		FlexibleTileWand.PlacementOption option;
		Item itemToConsume;
		return inventory[selectedItem].GetFlexibleTileWand()?.TryGetPlacementOption(this, FlexibleWandRandomSeed, FlexibleWandCycleOffset, out option, out itemToConsume) ?? canUse;
	}

	public bool TryGetFlexibleWandAvailableUsageCount(Item wandItem, out int amount)
	{
		amount = 0;
		FlexibleTileWand flexibleTileWand = wandItem.GetFlexibleTileWand();
		if (flexibleTileWand == null)
		{
			return false;
		}
		if (!flexibleTileWand.ConsumesAmmoItem)
		{
			return false;
		}
		if (!flexibleTileWand.TryGetPlacementOption(this, FlexibleWandRandomSeed, FlexibleWandCycleOffset, out var _, out var itemToConsume))
		{
			return false;
		}
		amount = CountItem(itemToConsume.type);
		return true;
	}

	private bool PlaceThing_Tiles_CheckWandUsability(bool canUse)
	{
		if (inventory[selectedItem].tileWand > 0)
		{
			int tileWand = inventory[selectedItem].tileWand;
			canUse = false;
			for (int i = 0; i < 58; i++)
			{
				if (tileWand == inventory[i].type && inventory[i].stack > 0)
				{
					canUse = true;
					break;
				}
			}
		}
		return canUse;
	}

	private bool PlaceThing_Tiles_CheckGamepadTorchUsability(bool canUse)
	{
		int createTile = inventory[selectedItem].createTile;
		if (PlayerInput.UsingGamepad && createTile >= 0 && TileID.Sets.Torches[createTile] && Main.SmartCursorIsUsed && !Main.SmartCursorShowing)
		{
			canUse = false;
		}
		return canUse;
	}

	private void PlaceThing_LockChest()
	{
		Tile tile = Main.tile[tileTargetX, tileTargetY];
		Item item = inventory[selectedItem];
		if (!tile.active() || item.type != 5328 || !TileID.Sets.IsAContainer[tile.type] || tile.type == 88 || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, item.tileBoost + blockRange) || !ItemTimeIsZero || itemAnimation <= 0 || !controlUseItem)
		{
			return;
		}
		Tile tileSafely = Framing.GetTileSafely(tileTargetX, tileTargetY);
		int type = tileSafely.type;
		int num = tileSafely.frameX / 36;
		switch (type)
		{
		case 21:
			switch (num)
			{
			default:
				return;
			case 1:
			case 3:
			case 18:
			case 19:
			case 20:
			case 21:
			case 22:
			case 35:
			case 37:
			case 39:
				break;
			}
			break;
		case 467:
			if (num != 12)
			{
				return;
			}
			break;
		}
		if (inventory[selectedItem].stack <= 0)
		{
			return;
		}
		int num2;
		for (num2 = Main.tile[tileTargetX, tileTargetY].frameX / 18; num2 > 1; num2 -= 2)
		{
		}
		num2 = tileTargetX - num2;
		int num3 = tileTargetY - Main.tile[tileTargetX, tileTargetY].frameY / 18;
		if (Chest.Lock(num2, num3))
		{
			inventory[selectedItem].stack--;
			if (inventory[selectedItem].stack <= 0)
			{
				inventory[selectedItem] = new Item();
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendData(52, -1, -1, null, whoAmI, 3f, num2, num3);
			}
		}
	}

	private void PlaceThing_ItemInExtractinator(ref ItemCheckContext context)
	{
		Tile tile = Main.tile[tileTargetX, tileTargetY];
		Item item = inventory[selectedItem];
		if (!tile.active() || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, item.tileBoost + blockRange) || !ItemTimeIsZero || itemAnimation <= 0 || !controlUseItem)
		{
			return;
		}
		float num = 1f;
		if (tile.type == 642)
		{
			num *= 0.33f;
		}
		ItemTrader itemTrader = TryGettingItemTraderFromBlock(tile);
		if (itemTrader != null && itemTrader.TryGetTradeOption(item, out var option))
		{
			SoundEngine.PlaySound(7);
			ApplyItemTime(item, num);
			context.SkipItemConsumption = true;
			item.stack -= option.TakingItemStack;
			if (item.stack <= 0)
			{
				item.TurnToAir();
			}
			DropItemFromExtractinator(option.GivingItemType, option.GivingItemStack);
		}
		else if (ItemID.Sets.ExtractinatorMode[item.type] >= 0 && (tile.type == 219 || tile.type == 642))
		{
			ApplyItemTime(item, num);
			SoundEngine.PlaySound(7);
			int extractType = ItemID.Sets.ExtractinatorMode[item.type];
			ExtractinatorUse(extractType, tile.type);
		}
	}

	private static ItemTrader TryGettingItemTraderFromBlock(Tile targetBlock)
	{
		ItemTrader result = null;
		if (targetBlock.type == 642)
		{
			result = ItemTrader.ChlorophyteExtractinator;
		}
		return result;
	}

	private void PlaceThing_XMasTreeTops()
	{
		if (inventory[selectedItem].type < 1874 || inventory[selectedItem].type > 1905 || !Main.tile[tileTargetX, tileTargetY].active() || Main.tile[tileTargetX, tileTargetY].type != 171 || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, inventory[selectedItem].tileBoost + blockRange) || !ItemTimeIsZero || itemAnimation <= 0 || !controlUseItem)
		{
			return;
		}
		int type = inventory[selectedItem].type;
		if (type >= 1874 && type <= 1877)
		{
			type -= 1873;
			if (WorldGen.checkXmasTreeDrop(tileTargetX, tileTargetY, 0) != type)
			{
				ApplyItemTime(inventory[selectedItem]);
				WorldGen.dropXmasTree(tileTargetX, tileTargetY, 0);
				WorldGen.setXmasTree(tileTargetX, tileTargetY, 0, type);
				int num = tileTargetX;
				int num2 = tileTargetY;
				if (Main.tile[tileTargetX, tileTargetY].frameX < 10)
				{
					num -= Main.tile[tileTargetX, tileTargetY].frameX;
					num2 -= Main.tile[tileTargetX, tileTargetY].frameY;
				}
				NetMessage.SendTileSquare(-1, num, num2);
			}
		}
		else if (type >= 1878 && type <= 1883)
		{
			type -= 1877;
			if (WorldGen.checkXmasTreeDrop(tileTargetX, tileTargetY, 1) != type)
			{
				ApplyItemTime(inventory[selectedItem]);
				WorldGen.dropXmasTree(tileTargetX, tileTargetY, 1);
				WorldGen.setXmasTree(tileTargetX, tileTargetY, 1, type);
				int num3 = tileTargetX;
				int num4 = tileTargetY;
				if (Main.tile[tileTargetX, tileTargetY].frameX < 10)
				{
					num3 -= Main.tile[tileTargetX, tileTargetY].frameX;
					num4 -= Main.tile[tileTargetX, tileTargetY].frameY;
				}
				NetMessage.SendTileSquare(-1, num3, num4);
			}
		}
		else if (type >= 1884 && type <= 1894)
		{
			type -= 1883;
			if (WorldGen.checkXmasTreeDrop(tileTargetX, tileTargetY, 2) != type)
			{
				ApplyItemTime(inventory[selectedItem]);
				WorldGen.dropXmasTree(tileTargetX, tileTargetY, 2);
				WorldGen.setXmasTree(tileTargetX, tileTargetY, 2, type);
				int num5 = tileTargetX;
				int num6 = tileTargetY;
				if (Main.tile[tileTargetX, tileTargetY].frameX < 10)
				{
					num5 -= Main.tile[tileTargetX, tileTargetY].frameX;
					num6 -= Main.tile[tileTargetX, tileTargetY].frameY;
				}
				NetMessage.SendTileSquare(-1, num5, num6);
			}
		}
		else
		{
			if (type < 1895 || type > 1905)
			{
				return;
			}
			type -= 1894;
			if (WorldGen.checkXmasTreeDrop(tileTargetX, tileTargetY, 3) != type)
			{
				ApplyItemTime(inventory[selectedItem]);
				WorldGen.dropXmasTree(tileTargetX, tileTargetY, 3);
				WorldGen.setXmasTree(tileTargetX, tileTargetY, 3, type);
				int num7 = tileTargetX;
				int num8 = tileTargetY;
				if (Main.tile[tileTargetX, tileTargetY].frameX < 10)
				{
					num7 -= Main.tile[tileTargetX, tileTargetY].frameX;
					num8 -= Main.tile[tileTargetX, tileTargetY].frameY;
				}
				NetMessage.SendTileSquare(-1, num7, num8);
			}
		}
	}

	private void PlaceThing_CannonBall()
	{
		if (ItemID.Sets.Torches[inventory[selectedItem].type] && IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, inventory[selectedItem].tileBoost + blockRange))
		{
			int num = tileTargetX;
			int num2 = tileTargetY;
			Tile tile = Main.tile[num, num2];
			if (tile.active() && tile.type == 209 && tile.frameX / 72 < 3)
			{
				ShootFromCannon(num, num2);
			}
		}
	}

	private void PlaceThing_PaintScrapper()
	{
		if (ItemID.Sets.IsPaintScraper[inventory[selectedItem].type] && IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, inventory[selectedItem].tileBoost + blockRange))
		{
			int num = tileTargetX;
			int num2 = tileTargetY;
			if (Main.tile[num, num2] != null)
			{
				PlaceThing_PaintScrapper_TryScrapping(num, num2);
				PlaceThing_PaintScrapper_LongMoss(num, num2);
			}
		}
	}

	private void PlaceThing_PaintScrapper_LongMoss(int x, int y)
	{
		if (Main.tile[x, y].type != 184)
		{
			return;
		}
		cursorItemIconEnabled = true;
		if (!ItemTimeIsZero || itemAnimation <= 0 || !controlUseItem)
		{
			return;
		}
		_ = Main.tile[x, y].type;
		int frameX = Main.tile[x, y].frameX;
		WorldGen.KillTile(x, y);
		if (Main.tile[x, y].active())
		{
			return;
		}
		ApplyItemTime(inventory[selectedItem]);
		if (Main.netMode == 1)
		{
			NetMessage.SendData(17, -1, -1, null, 0, x, y);
		}
		if (Main.rand.Next(9) == 0)
		{
			int type = 4349 + frameX / 22;
			switch (frameX / 22)
			{
			case 6:
				type = 4377;
				break;
			case 7:
				type = 4378;
				break;
			case 8:
				type = 4389;
				break;
			case 9:
				type = 5127;
				break;
			case 10:
				type = 5128;
				break;
			}
			int number = Item.NewItem(WorldGen.GetItemSource_FromTileBreak(x, y), x * 16, y * 16, 16, 16, type);
			NetMessage.SendData(21, -1, -1, null, number, 1f);
		}
	}

	private void PlaceThing_PaintScrapper_TryScrapping(int x, int y)
	{
		Tile tile = Main.tile[x, y];
		if ((0u | ((tile.wall > 0 && (tile.wallColor() > 0 || tile.invisibleWall() || tile.fullbrightWall())) ? 1u : 0u) | ((tile.active() && (tile.color() > 0 || tile.invisibleBlock() || tile.fullbrightBlock())) ? 1u : 0u)) == 0)
		{
			return;
		}
		cursorItemIconEnabled = true;
		if (ItemTimeIsZero && itemAnimation > 0 && controlUseItem)
		{
			if (WorldGen.paintTile(x, y, 0, broadCast: true) || WorldGen.paintCoatTile(x, y, 0, broadcast: true))
			{
				ApplyItemTime(inventory[selectedItem], tileSpeed);
			}
			else if (WorldGen.paintWall(x, y, 0, broadCast: true) || WorldGen.paintCoatWall(x, y, 0, broadcast: true))
			{
				ApplyItemTime(inventory[selectedItem], wallSpeed);
			}
		}
	}

	private void PlaceThing_PaintRoller()
	{
		if ((inventory[selectedItem].type != 1072 && inventory[selectedItem].type != 1544) || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, inventory[selectedItem].tileBoost + blockRange))
		{
			return;
		}
		int num = tileTargetX;
		int num2 = tileTargetY;
		if (Main.tile[num, num2] != null && Main.tile[num, num2].wall > 0)
		{
			cursorItemIconEnabled = true;
			if (ItemTimeIsZero && itemAnimation > 0 && controlUseItem)
			{
				TryPainting(num, num2, paintingAWall: true);
			}
		}
	}

	private void PlaceThing_Paintbrush()
	{
		if ((inventory[selectedItem].type != 1071 && inventory[selectedItem].type != 1543) || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, inventory[selectedItem].tileBoost + blockRange))
		{
			return;
		}
		int num = tileTargetX;
		int num2 = tileTargetY;
		if (Main.tile[num, num2] != null && Main.tile[num, num2].active())
		{
			cursorItemIconEnabled = true;
			if (ItemTimeIsZero && itemAnimation > 0 && controlUseItem)
			{
				TryPainting(num, num2);
			}
		}
	}

	public Item FindPaintOrCoating()
	{
		for (int i = 54; i < 58; i++)
		{
			if (inventory[i].stack > 0 && inventory[i].PaintOrCoating)
			{
				return inventory[i];
			}
		}
		for (int j = 0; j < 58; j++)
		{
			if (inventory[j].stack > 0 && inventory[j].PaintOrCoating)
			{
				return inventory[j];
			}
		}
		return null;
	}

	private void TryPainting(int x, int y, bool paintingAWall = false, bool applyItemAnimation = true)
	{
		Item item = FindPaintOrCoating();
		if (item != null)
		{
			if (item.paintCoating != 0)
			{
				ApplyCoating(x, y, paintingAWall, applyItemAnimation, item);
			}
			if (item.paint != 0)
			{
				ApplyPaint(x, y, paintingAWall, applyItemAnimation, item);
			}
		}
	}

	private void ApplyCoating(int x, int y, bool paintingAWall, bool applyItemAnimation, Item targetItem)
	{
		byte paintCoating = targetItem.paintCoating;
		if (paintingAWall)
		{
			if (WorldGen.paintCoatWall(x, y, paintCoating, broadcast: true))
			{
				targetItem.stack--;
				if (targetItem.stack <= 0)
				{
					targetItem.SetDefaults(0);
				}
				if (applyItemAnimation)
				{
					ApplyItemTime(inventory[selectedItem], wallSpeed);
				}
			}
		}
		else if (WorldGen.paintCoatTile(x, y, paintCoating, broadcast: true))
		{
			targetItem.stack--;
			if (targetItem.stack <= 0)
			{
				targetItem.SetDefaults(0);
			}
			if (applyItemAnimation)
			{
				ApplyItemTime(inventory[selectedItem], tileSpeed);
			}
		}
	}

	private void ApplyPaint(int x, int y, bool paintingAWall, bool applyItemAnimation, Item targetItem)
	{
		byte paint = targetItem.paint;
		if (paintingAWall)
		{
			if (Main.tile[x, y].wallColor() != paint && WorldGen.paintWall(x, y, paint, broadCast: true))
			{
				targetItem.stack--;
				if (targetItem.stack <= 0)
				{
					targetItem.SetDefaults(0);
				}
				if (applyItemAnimation)
				{
					ApplyItemTime(inventory[selectedItem], wallSpeed);
				}
			}
		}
		else if (Main.tile[x, y].color() != paint && WorldGen.paintTile(x, y, paint, broadCast: true))
		{
			targetItem.stack--;
			if (targetItem.stack <= 0)
			{
				targetItem.SetDefaults(0);
			}
			if (applyItemAnimation)
			{
				ApplyItemTime(inventory[selectedItem], tileSpeed);
			}
		}
	}

	private void ShootFromCannon(int x, int y)
	{
		if (cannonCooldown > 0)
		{
			return;
		}
		int num = 0;
		int num2 = Main.tile[x, y].frameX / 72;
		_ = inventory[selectedItem].type;
		num = num2 + 1;
		if (num <= 0 || (num == 2 && !WorldGen.BunnyCannonCanFire()))
		{
			return;
		}
		cursorItemIconEnabled = true;
		if (ItemTimeIsZero && itemAnimation > 0 && controlUseItem)
		{
			int num3 = Main.tile[x, y].frameX / 18;
			int num4 = 0;
			int num5 = 0;
			while (num3 >= 4)
			{
				num4++;
				num3 -= 4;
			}
			num3 = x - num3;
			int num6;
			for (num6 = Main.tile[x, y].frameY / 18; num6 >= 3; num6 -= 3)
			{
				num5++;
			}
			num6 = y - num6;
			cannonCooldown = 20;
			int damage = 0;
			if (num == 1)
			{
				damage = 300;
			}
			if (num == 2)
			{
				damage = 350;
			}
			WorldGen.ShootFromCannon(num3, num6, num5, num, damage, 8f, Main.myPlayer, fromWire: false);
		}
	}

	private void ExtractinatorUse(int extractType, int extractinatorBlockType)
	{
		ExtractinatorHelper.RollExtractinatorDrop(extractType, extractinatorBlockType, out var itemType, out var stack);
		if (itemType > 0)
		{
			DropItemFromExtractinator(itemType, stack);
		}
	}

	private void DropItemFromExtractinator(int itemType, int stack)
	{
		Vector2 vector = Main.ReverseGravitySupport(Main.MouseScreen) + Main.screenPosition;
		if (Main.SmartCursorIsUsed || PlayerInput.UsingGamepad)
		{
			vector = base.Center;
		}
		int number = Item.NewItem(GetItemSource_TileInteraction(tileTargetX, tileTargetY), (int)vector.X, (int)vector.Y, 1, 1, itemType, stack, noBroadcast: false, -1);
		if (Main.netMode == 1)
		{
			NetMessage.SendData(21, -1, -1, null, number, 1f);
		}
	}

	public void ChangeDir(int dir)
	{
		if (dir == direction)
		{
			return;
		}
		if (pulley && pulleyDir == 2)
		{
			int num = (int)(position.X + (float)(width / 2)) / 16 * 16 + 8 - width / 2;
			if (Collision.SolidCollision(new Vector2(num, position.Y), width, height))
			{
				return;
			}
			if (whoAmI == Main.myPlayer)
			{
				Main.cameraX = Main.cameraX + position.X - (float)num;
			}
			pulleyDir = 1;
			position.X = num;
		}
		direction = dir;
		compositeBackArm.rotation *= -1f;
		compositeFrontArm.rotation *= -1f;
		itemRotation *= -1f;
		itemLocation.X = MountedCenter.X + (MountedCenter.X - itemLocation.X);
	}

	public Rectangle getRect()
	{
		return new Rectangle((int)position.X, (int)position.Y, width, height);
	}

	public void HorsemansBlade_SpawnPumpkin(int npcIndex, int dmg, float kb)
	{
		Vector2 center = Main.npc[npcIndex].Center;
		int y = Main.MaxWorldViewSize.Y;
		int x = Main.MaxWorldViewSize.X;
		int num = Main.rand.Next(100, 300);
		int num2 = Main.rand.Next(100, 300);
		num = ((Main.rand.Next(2) != 0) ? (num + (x / 2 - num)) : (num - (x / 2 + num)));
		num2 = ((Main.rand.Next(2) != 0) ? (num2 + (y / 2 - num2)) : (num2 - (y / 2 + num2)));
		num += (int)position.X;
		num2 += (int)position.Y;
		Vector2 vector = new Vector2(num, num2);
		float num3 = center.X - vector.X;
		float num4 = center.Y - vector.Y;
		float num5 = (float)Math.Sqrt(num3 * num3 + num4 * num4);
		num5 = 8f / num5;
		num3 *= num5;
		num4 *= num5;
		Projectile.NewProjectile(GetProjectileSource_Item(HeldItem), num, num2, num3, num4, 321, dmg, kb, whoAmI, npcIndex);
	}

	public void PutItemInInventoryFromItemUsage(int type)
	{
		for (int i = 0; i < 58; i++)
		{
			Item item = inventory[i];
			if (item.stack > 0 && item.type == type && item.stack < item.maxStack)
			{
				item.stack++;
				return;
			}
		}
		if (selectedItem >= 0 && inventory[selectedItem].IsAir)
		{
			inventory[selectedItem].SetDefaults(type);
			return;
		}
		Item item2 = new Item();
		item2.SetDefaults(type);
		GetOrDropItem(item2, GetItemSettings.ItemCreatedFromItemUsage);
	}

	public bool SummonItemCheck(Item item)
	{
		int type = item.type;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (nPC.active && ((type == 43 && nPC.type == 4) || (type == 70 && nPC.type == 13) || ((type == 560) & (nPC.type == 50)) || (type == 544 && nPC.type == 125) || (type == 544 && nPC.type == 126) || (type == 556 && nPC.type == 134) || (type == 557 && nPC.type == 127) || (type == 1133 && nPC.type == 222) || (type == 1331 && nPC.type == 266) || (type == 4988 && nPC.type == 657) || (type == 5120 && nPC.type == 668)))
			{
				return false;
			}
		}
		return true;
	}

	public PlayerFishingConditions GetFishingConditions()
	{
		PlayerFishingConditions result = default(PlayerFishingConditions);
		Fishing_GetBestFishingPole(out result.PolePower, out result.PoleItemType);
		Fishing_GetBait(out result.BaitPower, out result.BaitItemType);
		if (result.BaitItemType == 2673)
		{
			return result;
		}
		if (result.BaitPower == 0 || result.PolePower == 0)
		{
			return result;
		}
		int num = 0;
		if (FindBuffIndex(25) != -1)
		{
			num += 5;
		}
		if (canFloatInWater && wet)
		{
			num += 5;
		}
		if (sitting.TryGetSittingBlock(this, out var _))
		{
			num += 5;
		}
		int num2 = result.BaitPower + result.PolePower + fishingSkill + num;
		result.LevelMultipliers = Fishing_GetPowerMultiplier();
		result.FinalFishingLevel = (int)((float)num2 * result.LevelMultipliers);
		return result;
	}

	private static float Fishing_GetPowerMultiplier()
	{
		float num = 1f;
		if (Main.raining)
		{
			num *= 1.2f;
		}
		if (Main.cloudBGAlpha > 0f)
		{
			num *= 1.1f;
		}
		if (Main.dayTime && (Main.time < 5400.0 || Main.time > 48600.0))
		{
			num *= 1.3f;
		}
		if (Main.dayTime && Main.time > 16200.0 && Main.time < 37800.0)
		{
			num *= 0.8f;
		}
		if (!Main.dayTime && Main.time > 6480.0 && Main.time < 25920.0)
		{
			num *= 0.8f;
		}
		if (Main.moonPhase == 0)
		{
			num *= 1.1f;
		}
		if (Main.moonPhase == 1 || Main.moonPhase == 7)
		{
			num *= 1.05f;
		}
		if (Main.moonPhase == 3 || Main.moonPhase == 5)
		{
			num *= 0.95f;
		}
		if (Main.moonPhase == 4)
		{
			num *= 0.9f;
		}
		if (Main.bloodMoon)
		{
			num *= 1.1f;
		}
		return num;
	}

	private void Fishing_GetBait(out int baitPower, out int baitType)
	{
		baitPower = 0;
		baitType = 0;
		for (int i = 54; i < 58; i++)
		{
			if (inventory[i].stack > 0 && inventory[i].bait > 0)
			{
				baitPower = inventory[i].bait;
				baitType = inventory[i].type;
				break;
			}
		}
		if (baitPower != 0 || baitType != 0)
		{
			return;
		}
		for (int j = 0; j < 50; j++)
		{
			if (inventory[j].stack > 0 && inventory[j].bait > 0)
			{
				baitPower = inventory[j].bait;
				baitType = inventory[j].type;
				break;
			}
		}
	}

	private void Fishing_GetBestFishingPole(out int fishingPolePower, out int fishingPoleType)
	{
		fishingPolePower = inventory[selectedItem].fishingPole;
		fishingPoleType = inventory[selectedItem].type;
		if (fishingPolePower != 0)
		{
			return;
		}
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].fishingPole > fishingPolePower)
			{
				fishingPolePower = inventory[i].fishingPole;
				fishingPoleType = inventory[i].type;
			}
		}
	}

	public bool HasUnityPotion()
	{
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].type == 2997 && inventory[i].stack > 0)
			{
				return true;
			}
		}
		if (useVoidBag())
		{
			for (int j = 0; j < bank4.maxItems; j++)
			{
				if (bank4.item[j].type == 2997 && bank4.item[j].stack > 0)
				{
					return true;
				}
			}
		}
		return false;
	}

	public void TakeUnityPotion()
	{
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].type == 2997 && inventory[i].stack > 0)
			{
				inventory[i].stack--;
				if (inventory[i].stack <= 0)
				{
					inventory[i].SetDefaults(0);
				}
				return;
			}
		}
		if (!useVoidBag())
		{
			return;
		}
		for (int j = 0; j < bank4.maxItems; j++)
		{
			if (bank4.item[j].type == 2997 && bank4.item[j].stack > 0)
			{
				bank4.item[j].stack--;
				if (bank4.item[j].stack <= 0)
				{
					bank4.item[j].SetDefaults(0);
				}
				break;
			}
		}
	}

	public void UnityTeleport(Vector2 telePos)
	{
		int num = 3;
		if (Main.netMode == 0)
		{
			Teleport(telePos, num);
		}
		else
		{
			NetMessage.SendData(65, -1, -1, null, 2, whoAmI, telePos.X, telePos.Y, num);
		}
	}

	private void PayDD2CrystalsBeforeUse(Item item)
	{
		int requiredDD2CrystalsToUse = GetRequiredDD2CrystalsToUse(item);
		for (int i = 0; i < requiredDD2CrystalsToUse; i++)
		{
			ConsumeItem(3822, reverseOrder: true);
		}
	}

	private bool CheckDD2CrystalPaymentLock(Item item)
	{
		if (!DD2Event.Ongoing)
		{
			return true;
		}
		int requiredDD2CrystalsToUse = GetRequiredDD2CrystalsToUse(item);
		return CountItem(3822, requiredDD2CrystalsToUse) >= requiredDD2CrystalsToUse;
	}

	private int GetRequiredDD2CrystalsToUse(Item item)
	{
		switch (item.type)
		{
		case 3818:
		case 3819:
		case 3820:
			return 10;
		case 3824:
		case 3825:
		case 3826:
			return 10;
		case 3832:
		case 3833:
		case 3834:
			return 10;
		case 3829:
		case 3830:
		case 3831:
			return 10;
		default:
			return 0;
		}
	}

	public void SporeSac(Item sourceItem)
	{
		if (Main.myPlayer != whoAmI)
		{
			return;
		}
		int damage = 70;
		float knockBack = 1.5f;
		if (Main.rand.Next(15) != 0)
		{
			return;
		}
		int num = 0;
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].active && Main.projectile[i].owner == whoAmI && (Main.projectile[i].type == 567 || Main.projectile[i].type == 568))
			{
				num++;
			}
		}
		if (Main.rand.Next(15) < num || num >= 10)
		{
			return;
		}
		int num2 = 50;
		int num3 = 24;
		int num4 = 90;
		for (int j = 0; j < num2; j++)
		{
			int num5 = Main.rand.Next(200 - j * 2, 400 + j * 2);
			Vector2 center = base.Center;
			center.X += Main.rand.Next(-num5, num5 + 1);
			center.Y += Main.rand.Next(-num5, num5 + 1);
			if (Collision.SolidCollision(center, num3, num3) || Collision.WetCollision(center, num3, num3))
			{
				continue;
			}
			center.X += num3 / 2;
			center.Y += num3 / 2;
			if (!Collision.CanHit(new Vector2(base.Center.X, position.Y), 1, 1, center, 1, 1) && !Collision.CanHit(new Vector2(base.Center.X, position.Y - 50f), 1, 1, center, 1, 1))
			{
				continue;
			}
			int num6 = (int)center.X / 16;
			int num7 = (int)center.Y / 16;
			bool flag = false;
			if (Main.rand.Next(3) == 0 && Main.tile[num6, num7] != null && Main.tile[num6, num7].wall > 0)
			{
				flag = true;
			}
			else
			{
				center.X -= num4 / 2;
				center.Y -= num4 / 2;
				if (Collision.SolidCollision(center, num4, num4))
				{
					center.X += num4 / 2;
					center.Y += num4 / 2;
					flag = true;
				}
				else if (Main.tile[num6, num7] != null && Main.tile[num6, num7].active() && Main.tile[num6, num7].type == 19)
				{
					flag = true;
				}
			}
			if (!flag)
			{
				continue;
			}
			for (int k = 0; k < 1000; k++)
			{
				if (Main.projectile[k].active && Main.projectile[k].owner == whoAmI && Main.projectile[k].aiStyle == 105 && (center - Main.projectile[k].Center).Length() < 48f)
				{
					flag = false;
					break;
				}
			}
			if (flag && Main.myPlayer == whoAmI)
			{
				Projectile.NewProjectile(GetProjectileSource_Accessory(sourceItem), center.X, center.Y, 0f, 0f, 567 + Main.rand.Next(2), damage, knockBack, whoAmI);
				break;
			}
		}
	}

	public void VolatileGelatin(Item sourceItem)
	{
		if (Main.myPlayer != whoAmI)
		{
			return;
		}
		volatileGelatinCounter++;
		if (volatileGelatinCounter <= 40)
		{
			return;
		}
		volatileGelatinCounter = 0;
		int damage = 65;
		float knockBack = 7f;
		float num = 640f;
		NPC nPC = null;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC2 = Main.npc[i];
			if (nPC2 != null && nPC2.active && nPC2.CanBeChasedBy(this) && Collision.CanHit(this, nPC2))
			{
				float num2 = Vector2.Distance(nPC2.Center, base.Center);
				if (num2 < num)
				{
					num = num2;
					nPC = nPC2;
				}
			}
		}
		if (nPC != null)
		{
			Vector2 v = nPC.Center - base.Center;
			v = v.SafeNormalize(Vector2.Zero) * 12f;
			v.Y -= 1.3f;
			Projectile.NewProjectile(GetProjectileSource_Accessory(sourceItem), base.Center.X, base.Center.Y, v.X, v.Y, 937, damage, knockBack, whoAmI);
		}
	}

	public bool CanHit(Entity ent)
	{
		if (!Collision.CanHit(position, width, height, ent.position, ent.width, ent.height) && !Collision.CanHitLine(base.Center + new Vector2(direction * width / 2, gravDir * (float)(-height) / 3f), 0, 0, ent.Center + new Vector2(0f, -ent.height / 3), 0, 0) && !Collision.CanHitLine(base.Center + new Vector2(direction * width / 2, gravDir * (float)(-height) / 3f), 0, 0, ent.Center, 0, 0))
		{
			return Collision.CanHitLine(base.Center + new Vector2(direction * width / 2, 0f), 0, 0, ent.Center + new Vector2(0f, ent.height / 3), 0, 0);
		}
		return true;
	}

	public Rectangle GetItemDrawFrame(int type)
	{
		if (Main.dedServ)
		{
			return Rectangle.Empty;
		}
		Main.instance.LoadItem(type);
		if (ItemID.Sets.IsFood[type])
		{
			return TextureAssets.Item[type].Frame(1, 3, 0, 1);
		}
		DrawAnimation drawAnimation = Main.itemAnimations[type];
		if (drawAnimation != null)
		{
			int frameCounterOverride = -1;
			if (type == 5644 && whoAmI == Main.myPlayer && !AnyoneToSpectate())
			{
				frameCounterOverride = 0;
			}
			return drawAnimation.GetFrame(TextureAssets.Item[type].Value, frameCounterOverride);
		}
		return TextureAssets.Item[type].Frame();
	}

	public float GetAdjustedItemScale(Item item)
	{
		float scale = item.scale;
		if (item.melee)
		{
			ApplyMeleeScale(ref scale);
		}
		return scale;
	}

	public void ApplyMeleeScale(ref float scale)
	{
		if (meleeScaleGlove)
		{
			scale *= 1.1f;
		}
	}

	public Vector2 ApplyRangeCompensation(float rangeCompensation, Vector2 startPos, Vector2 targetPos)
	{
		Vector2 v = targetPos - startPos;
		Vector2 vector = v.SafeNormalize(Vector2.Zero);
		vector.Y -= 1f;
		float num = v.Length();
		num = (float)Math.Pow(num / 700f, 2.0) * 700f;
		targetPos.Y += vector.Y * num * rangeCompensation * 1f;
		targetPos.X += (0f - vector.X) * num * rangeCompensation * 1f;
		return targetPos;
	}

	public void ItemCheck()
	{
		pendingItemReuse = false;
		if (CCed)
		{
			channel = false;
			itemAnimation = (itemAnimationMax = 0);
			return;
		}
		float heightOffsetHitboxCenter = HeightOffsetHitboxCenter;
		Item item = inventory[selectedItem];
		ItemCheckContext context = default(ItemCheckContext);
		bool flag = false;
		if (Main.myPlayer == whoAmI)
		{
			if (PlayerInput.ShouldFastUseItem)
			{
				controlUseItem = true;
				flag = true;
			}
			if (!cursorItemIconEnabled && item.stack > 0 && item.fishingPole > 0)
			{
				Fishing_GetBait(out var _, out var baitType);
				if (baitType > 0)
				{
					cursorItemIconEnabled = true;
					cursorItemIconID = baitType;
					cursorItemIconPush = 6;
				}
			}
			if (!cursorItemIconEnabled && item.stack > 0 && (item.type == 779 || item.type == 5134))
			{
				for (int i = 54; i < 58; i++)
				{
					if (inventory[i].ammo == item.useAmmo && inventory[i].stack > 0)
					{
						cursorItemIconEnabled = true;
						cursorItemIconID = inventory[i].type;
						cursorItemIconPush = 10;
						break;
					}
				}
				if (!cursorItemIconEnabled)
				{
					for (int j = 0; j < 54; j++)
					{
						if (inventory[j].ammo == item.useAmmo && inventory[j].stack > 0)
						{
							cursorItemIconEnabled = true;
							cursorItemIconID = inventory[j].type;
							cursorItemIconPush = 10;
							break;
						}
					}
				}
			}
		}
		ItemCheck_HandleMount();
		int weaponDamage = GetWeaponDamage(item);
		ItemCheck_AutoReuseLogic(item);
		ItemCheck_HackHoldStyles(item);
		if (itemAnimation < 0)
		{
			itemAnimation = 0;
		}
		if (itemTime < 0)
		{
			itemTime = 0;
		}
		if (itemAnimation == 0 && reuseDelay > 0)
		{
			ApplyReuseDelay();
		}
		UpdatePlacementPreview(item);
		if (itemAnimation == 0 && altFunctionUse == 2)
		{
			altFunctionUse = 0;
		}
		if (item.type == 2269)
		{
			if (itemAnimation > 0 && !controlUseItem)
			{
				itemAnimation--;
				itemTime--;
				if (itemAnimation <= 0)
				{
					itemAnimation = 0;
				}
				if (itemTime < 0)
				{
					itemTime = 0;
				}
				revolverCritChanceBonus++;
			}
			else if (Main.rand.Next(3) == 0)
			{
				revolverCritChanceBonus -= 2;
			}
			item.TryGetPrefixStatMultipliersForItem(item.prefix, out var _, out var _, out var _, out var _, out var _, out var _, out var crt, out var _, out var _, out var _);
			revolverCritChanceBonus = Utils.Clamp(item.crit + revolverCritChanceBonus, crt, 20 + crt) - item.crit;
		}
		else if (Main.rand.Next(3) == 0)
		{
			revolverCritChanceBonus -= 2;
		}
		if (controlUseItem && releaseUseItem && itemAnimation == 0 && item.useStyle != 0 && !selectedItemState.HasBufferedChange)
		{
			if (altFunctionUse == 1)
			{
				altFunctionUse = 2;
			}
			if (item.shoot == 0)
			{
				itemRotation = 0f;
			}
			bool flag2 = ItemCheck_TryStartUse(item);
			if (whoAmI == Main.myPlayer)
			{
				if (flag2 != lastItemUseAttemptSuccess)
				{
					lastItemUseAttemptSuccess = flag2;
					NetMessage.SendData(13, -1, -1, null, whoAmI);
				}
			}
			else
			{
				flag2 &= lastItemUseAttemptSuccess;
			}
			if (item.potion && flag2)
			{
				ApplyPotionDelay(item);
			}
			if (item.mana > 0 && flag2 && whoAmI == Main.myPlayer && item.buffType != 0 && item.buffTime != 0)
			{
				AddBuff(item.buffType, item.buffTime);
			}
			if (item.shoot <= 0 || !ProjectileID.Sets.MinionTargettingFeature[item.shoot] || altFunctionUse != 2)
			{
				ItemCheck_ApplyPetBuffs(item);
			}
			if (whoAmI == Main.myPlayer && gravDir == 1f && item.mountType != -1 && flag2)
			{
				mount.SetMount(item.mountType, this);
			}
			bool flag3 = item.shoot > 0 && ProjectileID.Sets.MinionTargettingFeature[item.shoot] && altFunctionUse == 2;
			bool flag4 = false;
			if (!flag3 && flag2 && whoAmI == Main.myPlayer && item.shoot == 1094 && TryUsingFoxsparksAbility())
			{
				flag4 = true;
			}
			if (!flag4 && !flag3 && flag2 && whoAmI == Main.myPlayer && item.shoot >= 0 && item.shoot < ProjectileID.Count && (ProjectileID.Sets.LightPet[item.shoot] || Main.projPet[item.shoot]))
			{
				FreeUpPetsAndMinions(item);
			}
			if (!flag4 && flag2)
			{
				ItemCheck_StartActualUse(item);
			}
		}
		bool flag5 = controlUseItem;
		if (mount.Active && mount.Type == 8)
		{
			flag5 = controlUseItem || controlUseTile;
		}
		if (ItemID.Sets.IsAKite[item.type])
		{
			flag5 = controlUseTile;
		}
		if (whoAmI == Main.myPlayer && Main.LocalPlayerHasPendingInventoryActions())
		{
			flag5 = false;
		}
		if (selectedItemState.HasBufferedChange)
		{
			flag5 = false;
		}
		if (!flag5)
		{
			channel = false;
		}
		if (itemAnimation > 0)
		{
			if (item.mana > 0)
			{
				ItemCheck_ApplyManaRegenDelay(item);
			}
			itemAnimation--;
			if (itemAnimation == 0 && whoAmI == Main.myPlayer)
			{
				PlayerInput.TryEndingFastUse();
			}
			if (itemAnimation == 0 && reuseDelay == 0 && controlUseItem && releaseUseItem)
			{
				pendingItemReuse = true;
			}
		}
		releaseUseItem = !controlUseItem;
		if (itemTime > 0)
		{
			itemTime--;
			if (ItemTimeIsZero && whoAmI == Main.myPlayer && !JustDroppedAnItem && IsAllowedToHoldItems)
			{
				int type = item.type;
				if (type == 65 || type == 724 || type == 989 || type == 1226)
				{
					EmitMaxManaEffect();
				}
			}
		}
		Rectangle heldItemFrame = AnimatePlayerAndGetItemFrame(heightOffsetHitboxCenter, item);
		if (!JustDroppedAnItem && IsAllowedToHoldItems)
		{
			ItemCheck_EmitHeldItemLight(item);
			ItemCheck_EmitFoodParticles(item);
			ItemCheck_EmitDrinkParticles(item);
			if (whoAmI == Main.myPlayer)
			{
				ItemCheck_OwnerOnlyCode(ref context, item, weaponDamage, heldItemFrame);
			}
			if (ItemTimeIsZero && itemAnimation > 0)
			{
				if (item.hairDye >= 0)
				{
					ApplyItemTime(item);
					if (whoAmI == Main.myPlayer)
					{
						hairDye = (byte)item.hairDye;
						NetMessage.SendData(4, -1, -1, null, whoAmI);
					}
				}
				if (item.healLife > 0 || item.healMana > 0)
				{
					ApplyLifeAndOrMana(item);
					ApplyItemTime(item);
					if (Main.myPlayer == whoAmI && item.type == 126 && breath == 0)
					{
						AchievementsHelper.HandleSpecialEvent(this, 25);
					}
				}
				if (item.buffType > 0)
				{
					if (whoAmI == Main.myPlayer && item.buffType != 90 && item.buffType != 27)
					{
						AddBuff(item.buffType, item.buffTime);
					}
					ApplyItemTime(item);
				}
				if (item.type == 678)
				{
					if (Main.getGoodWorld)
					{
						ApplyItemTime(item);
						if (whoAmI == Main.myPlayer)
						{
							for (int k = 0; k < 3; k++)
							{
								int type2 = 0;
								int time = 108000;
								switch (Main.rand.Next(18))
								{
								case 0:
									type2 = 16;
									break;
								case 1:
									type2 = 111;
									break;
								case 2:
									type2 = 114;
									break;
								case 3:
									type2 = 8;
									break;
								case 4:
									type2 = 105;
									break;
								case 5:
									type2 = 17;
									break;
								case 6:
									type2 = 116;
									break;
								case 7:
									type2 = 5;
									break;
								case 8:
									type2 = 113;
									break;
								case 9:
									type2 = 7;
									break;
								case 10:
									type2 = 6;
									break;
								case 11:
									type2 = 104;
									break;
								case 12:
									type2 = 115;
									break;
								case 13:
									type2 = 2;
									break;
								case 14:
									type2 = 9;
									break;
								case 15:
									type2 = 3;
									break;
								case 16:
									type2 = 117;
									break;
								case 17:
									type2 = 1;
									break;
								}
								AddBuff(type2, time);
							}
						}
					}
					else
					{
						ApplyItemTime(item);
						if (whoAmI == Main.myPlayer)
						{
							AddBuff(20, 216000);
							AddBuff(22, 216000);
							AddBuff(23, 216000);
							AddBuff(24, 216000);
							AddBuff(30, 216000);
							AddBuff(31, 216000);
							AddBuff(32, 216000);
							AddBuff(33, 216000);
							AddBuff(35, 216000);
							AddBuff(36, 216000);
							AddBuff(68, 216000);
						}
					}
				}
			}
			if ((item.type == 50 || item.type == 3124 || item.type == 3199 || item.type == 5358) && itemAnimation > 0)
			{
				if (Main.rand.Next(2) == 0)
				{
					Dust.NewDust(position, width, height, 15, 0f, 0f, 150, default(Color), 1.1f);
				}
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
				}
				else if (itemTime == item.useTime / 2)
				{
					for (int l = 0; l < 70; l++)
					{
						Dust.NewDust(position, width, height, 15, velocity.X * 0.5f, velocity.Y * 0.5f, 150, default(Color), 1.5f);
					}
					RemoveAllGrapplingHooks();
					Spawn(PlayerSpawnContext.RecallFromItem);
					for (int m = 0; m < 70; m++)
					{
						Dust.NewDust(position, width, height, 15, 0f, 0f, 150, default(Color), 1.5f);
					}
				}
			}
			if ((item.type == 4263 || item.type == 5360) && itemAnimation > 0)
			{
				Vector2 vector = Vector2.UnitY.RotatedBy((float)itemAnimation * ((float)Math.PI * 2f) / 30f) * new Vector2(15f, 0f);
				for (int n = 0; n < 2; n++)
				{
					if (Main.rand.Next(3) == 0)
					{
						Dust dust = Dust.NewDustPerfect(base.Bottom + vector, Dust.dustWater());
						dust.velocity.Y *= 0f;
						dust.velocity.Y -= 4.5f;
						dust.velocity.X *= 1.5f;
						dust.scale = 0.8f;
						dust.alpha = 130;
						dust.noGravity = true;
						dust.fadeIn = 1.1f;
					}
				}
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
				}
				else if (itemTime == item.useTime / 2)
				{
					if (Main.netMode == 0)
					{
						MagicConch();
					}
					else if (Main.netMode == 1 && whoAmI == Main.myPlayer)
					{
						NetMessage.SendData(73, -1, -1, null, 1);
					}
				}
			}
			if ((item.type == 4819 || item.type == 5361) && itemAnimation > 0)
			{
				Vector2 vector2 = Vector2.UnitY.RotatedBy((float)itemAnimation * ((float)Math.PI * 2f) / 30f) * new Vector2(15f, 0f);
				for (int num = 0; num < 2; num++)
				{
					if (Main.rand.Next(3) == 0)
					{
						Dust dust2 = Dust.NewDustPerfect(base.Bottom + vector2, 35);
						dust2.velocity.Y *= 0f;
						dust2.velocity.Y -= 4.5f;
						dust2.velocity.X *= 1.5f;
						dust2.scale = 0.8f;
						dust2.alpha = 130;
						dust2.noGravity = true;
						dust2.fadeIn = 1.1f;
					}
				}
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
				}
				else if (itemTime == item.useTime / 2)
				{
					if (Main.netMode == 0)
					{
						DemonConch();
					}
					else if (Main.netMode == 1 && whoAmI == Main.myPlayer)
					{
						NetMessage.SendData(73, -1, -1, null, 2);
					}
				}
			}
			if (item.type == 5359 && itemAnimation > 0)
			{
				if (Main.rand.Next(2) == 0)
				{
					int num2 = Main.rand.Next(4);
					Color color = Color.Green;
					switch (num2)
					{
					case 0:
					case 1:
						color = new Color(100, 255, 100);
						break;
					case 2:
						color = Color.Yellow;
						break;
					case 3:
						color = Color.White;
						break;
					}
					Dust dust3 = Dust.NewDustPerfect(Main.rand.NextVector2FromRectangle(base.Hitbox), 267);
					dust3.noGravity = true;
					dust3.color = color;
					dust3.velocity *= 2f;
					dust3.scale = 0.8f + Main.rand.NextFloat() * 0.6f;
				}
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
				}
				else if (itemTime == item.useTime / 2)
				{
					if (Main.netMode == 0)
					{
						Shellphone_Spawn();
					}
					else if (Main.netMode == 1 && whoAmI == Main.myPlayer)
					{
						NetMessage.SendData(73, -1, -1, null, 3);
					}
				}
			}
			if (item.type == 2350 && itemAnimation > 0)
			{
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
					SoundEngine.PlaySound(SoundID.Item3, position);
					for (int num3 = 0; num3 < 10; num3++)
					{
						Main.dust[Dust.NewDust(position, width, height, 15, velocity.X * 0.2f, velocity.Y * 0.2f, 150, Color.Cyan, 1.2f)].velocity *= 0.5f;
					}
				}
				else if (itemTime == 20)
				{
					SoundEngine.PlaySound(HeldItem.UseSound, position);
					for (int num4 = 0; num4 < 70; num4++)
					{
						Main.dust[Dust.NewDust(position, width, height, 15, velocity.X * 0.2f, velocity.Y * 0.2f, 150, Color.Cyan, 1.2f)].velocity *= 0.5f;
					}
					RemoveAllGrapplingHooks();
					bool flag6 = immune;
					int num5 = immuneTime;
					Spawn(PlayerSpawnContext.RecallFromItem);
					immune = flag6;
					immuneTime = num5;
					for (int num6 = 0; num6 < 70; num6++)
					{
						Main.dust[Dust.NewDust(position, width, height, 15, 0f, 0f, 150, Color.Cyan, 1.2f)].velocity *= 0.5f;
					}
					if (item.stack > 0)
					{
						item.stack--;
					}
				}
			}
			if (item.type == 4870 && itemAnimation > 0)
			{
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
					SoundEngine.PlaySound(SoundID.Item3, position);
					for (int num7 = 0; num7 < 10; num7++)
					{
						Main.dust[Dust.NewDust(position, width, height, 15, velocity.X * 0.2f, velocity.Y * 0.2f, 150, Color.Cyan, 1.2f)].velocity *= 0.5f;
					}
				}
				else if (itemTime == 20)
				{
					SoundEngine.PlaySound(HeldItem.UseSound, position);
					for (int num8 = 0; num8 < 70; num8++)
					{
						Main.dust[Dust.NewDust(position, width, height, 15, velocity.X * 0.2f, velocity.Y * 0.2f, 150, Color.Cyan, 1.2f)].velocity *= 0.5f;
					}
					if (whoAmI == Main.myPlayer)
					{
						DoPotionOfReturnTeleportationAndSetTheComebackPoint();
					}
					for (int num9 = 0; num9 < 70; num9++)
					{
						Main.dust[Dust.NewDust(position, width, height, 15, 0f, 0f, 150, Color.Cyan, 1.2f)].velocity *= 0.5f;
					}
					if (item.stack > 0)
					{
						item.stack--;
					}
				}
			}
			if (item.type == 2351 && itemAnimation > 0)
			{
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
				}
				else if (itemTime == 2)
				{
					if (Main.netMode == 0)
					{
						TeleportationPotion();
					}
					else if (Main.netMode == 1 && whoAmI == Main.myPlayer)
					{
						NetMessage.SendData(73);
					}
					if (item.stack > 0)
					{
						item.stack--;
					}
				}
			}
			if (item.type == 2756 && itemAnimation > 0)
			{
				if (ItemTimeIsZero)
				{
					ApplyItemTime(item);
				}
				else if (itemTime == 2)
				{
					if (whoAmI == Main.myPlayer)
					{
						Male = !Male;
						switch (voiceVariant)
						{
						case 1:
							voiceVariant = 2;
							break;
						case 2:
							voiceVariant = 1;
							break;
						}
						if (Main.netMode == 1)
						{
							NetMessage.SendData(4, -1, -1, null, whoAmI);
						}
					}
					if (item.stack > 0)
					{
						item.stack--;
					}
				}
				else
				{
					float num10 = item.useTime;
					num10 = (num10 - (float)itemTime) / num10;
					float num11 = 44f;
					float num12 = (float)Math.PI * 3f;
					Vector2 vector3 = new Vector2(15f, 0f).RotatedBy(num12 * num10);
					vector3.X *= direction;
					for (int num13 = 0; num13 < 2; num13++)
					{
						int type3 = 221;
						if (num13 == 1)
						{
							vector3.X *= -1f;
							type3 = 219;
						}
						Vector2 vector4 = new Vector2(vector3.X, num11 * (1f - num10) - num11 + (float)(height / 2));
						vector4 += base.Center;
						int num14 = Dust.NewDust(vector4, 0, 0, type3, 0f, 0f, 100);
						Main.dust[num14].position = vector4;
						Main.dust[num14].noGravity = true;
						Main.dust[num14].velocity = Vector2.Zero;
						Main.dust[num14].scale = 1.3f;
						Main.dust[num14].customData = this;
					}
				}
			}
			if (whoAmI == Main.myPlayer)
			{
				if ((itemTimeMax != 0 && itemTime == itemTimeMax) | (!item.IsAir && item.IsNotTheSameAs(lastVisualizedSelectedItem)))
				{
					lastVisualizedSelectedItem = item.Clone();
				}
			}
			else
			{
				lastVisualizedSelectedItem = item.Clone();
			}
			if (whoAmI == Main.myPlayer)
			{
				if (!dontConsumeWand && itemTimeMax != 0 && itemTime == itemTimeMax && item.tileWand > 0)
				{
					int tileWand = item.tileWand;
					for (int num15 = 0; num15 < 58; num15++)
					{
						if (tileWand == inventory[num15].type && inventory[num15].stack > 0)
						{
							inventory[num15].stack--;
							if (inventory[num15].stack <= 0)
							{
								inventory[num15] = new Item();
							}
							break;
						}
					}
				}
				if (itemTimeMax != 0 && itemTime == itemTimeMax && item.consumable && !context.SkipItemConsumption)
				{
					bool flag7 = true;
					if (item.ranged)
					{
						if (huntressAmmoCost90 && Main.rand.Next(10) == 0)
						{
							flag7 = false;
						}
						if (chloroAmmoCost80 && Main.rand.Next(5) == 0)
						{
							flag7 = false;
						}
						if (ammoCost80 && Main.rand.Next(5) == 0)
						{
							flag7 = false;
						}
						if (ammoCost75 && Main.rand.Next(4) == 0)
						{
							flag7 = false;
						}
					}
					if (item.IsACoin)
					{
						flag7 = true;
					}
					if (!CanConsumeConsumableItem(item))
					{
						flag7 = false;
					}
					bool? flag8 = ItemID.Sets.ForceConsumption[item.type];
					if (flag8.HasValue)
					{
						flag7 = flag8.Value;
					}
					if (flag7)
					{
						if (item.stack > 0)
						{
							item.stack--;
						}
						if (item.stack <= 0)
						{
							itemTime = itemAnimation;
							Main.blockMouse = true;
						}
					}
				}
				if (item.stack <= 0 && itemAnimation == 0)
				{
					inventory[selectedItem] = new Item();
					itemAnimationMax = 0;
				}
				if (selectedItem == 58 && itemAnimation > 0)
				{
					Main.mouseItem = inventory[selectedItem].Clone();
				}
			}
		}
		else if (whoAmI == Main.myPlayer && !JustDroppedAnItem && mount.DismountOnItemUse)
		{
			ItemCheck_OwnerOnlyCode(ref context, item, weaponDamage, heldItemFrame);
		}
		if (itemAnimation == 0)
		{
			JustDroppedAnItem = false;
		}
		if (whoAmI == Main.myPlayer && flag)
		{
			PlayerInput.TryEndingFastUse();
		}
	}

	private bool TryUsingFoxsparksAbility()
	{
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.owner == whoAmI && projectile.type == 1094)
			{
				projectile.ai[0] = 1000f;
				projectile.ai[1] = 0f;
				projectile.localAI[0] = 0f;
				projectile.localAI[1] = 0f;
				projectile.netUpdate = true;
				channel = true;
				SetDummyItemTime(2);
				if (projectile.soundDelay <= -320)
				{
					projectile.soundDelay = -21;
					SoundEngine.PlaySound(SoundID.PalFoxparksAttack, base.Center);
				}
				return true;
			}
		}
		return false;
	}

	public Rectangle AnimatePlayerAndGetItemFrame(float mountOffset, Item sItem)
	{
		Item item = ((itemAnimation > 0) ? lastVisualizedSelectedItem : sItem);
		Rectangle drawHitbox = Item.GetDrawHitbox(item.type, this);
		compositeFrontArm.enabled = false;
		compositeBackArm.enabled = false;
		if (itemAnimation > 0)
		{
			ItemCheck_ApplyUseStyle(mountOffset, item, drawHitbox);
		}
		else
		{
			ItemCheck_ApplyHoldStyle(mountOffset, item, drawHitbox);
		}
		return drawHitbox;
	}

	public float GetPlacementPreviewOpacity()
	{
		if (!ItemID.Sets.IsAKite[HeldItem.type])
		{
			return 1f;
		}
		if (HeldItem.holdStyle != 0)
		{
			return 0f;
		}
		return Utils.Remap(framesInMovementForPlacementPreview, 0f, 30f, 1f, 0f);
	}

	private void UpdatePlacementPreview(Item sItem)
	{
		if (Main.myPlayer == whoAmI && itemAnimation == 0 && !sItem.IsAir)
		{
			int num = ((velocity.Length() > 0.1f) ? 3 : (-1));
			framesInMovementForPlacementPreview = Utils.Clamp(framesInMovementForPlacementPreview + num, 0, 33);
			Tile targetTile = Main.tile[tileTargetX, tileTargetY];
			FigureOutWhatToPlace(targetTile, sItem, out var tileToCreate, out var previewPlaceStyle, out var overrideCanPlace, out var forcedRandom);
			if ((!overrideCanPlace.HasValue || overrideCanPlace.Value) && TileObjectData.CustomPlace(tileToCreate, previewPlaceStyle))
			{
				TileObject.CanPlace(tileTargetX, tileTargetY, tileToCreate, previewPlaceStyle, direction, out var _, onlyCheck: true, forcedRandom);
			}
		}
	}

	private void FigureOutWhatToPlace(Tile targetTile, Item sItem, out int tileToCreate, out int previewPlaceStyle, out bool? overrideCanPlace, out int? forcedRandom)
	{
		tileToCreate = sItem.createTile;
		previewPlaceStyle = sItem.placeStyle;
		overrideCanPlace = null;
		forcedRandom = null;
		if (UsingBiomeTorches && tileToCreate == 4 && previewPlaceStyle == 0)
		{
			BiomeTorchPlaceStyle(ref tileToCreate, ref previewPlaceStyle);
		}
		if (UsingBiomeTorches && tileToCreate == 215 && previewPlaceStyle == 0)
		{
			BiomeCampfirePlaceStyle(ref tileToCreate, ref previewPlaceStyle);
		}
		if (targetTile != null && targetTile.active())
		{
			ushort type = targetTile.type;
			if (tileToCreate == 23 && type == 59)
			{
				tileToCreate = 661;
			}
			if (tileToCreate == 199 && type == 59)
			{
				tileToCreate = 662;
			}
		}
		if (!ModifyFlexibleWandPlacementInfo(ref tileToCreate, ref previewPlaceStyle, ref forcedRandom))
		{
			overrideCanPlace = false;
		}
		if (tileToCreate == 724)
		{
			previewPlaceStyle = TECritterAnchor.GetLeashedCritterPrototype(sItem.type).anchorStyle;
		}
	}

	private void ItemCheck_OwnerOnlyCode(ref ItemCheckContext context, Item sItem, int weaponDamage, Rectangle heldItemFrame)
	{
		bool flag = true;
		if (selectedItemState.HasBufferedChange && sItem.useTime > itemAnimation)
		{
			flag = false;
		}
		int type = sItem.type;
		if ((type == 65 || type == 676 || type == 723 || type == 724 || type == 757 || type == 674 || type == 675 || type == 989 || type == 1226 || type == 1227) && !ItemAnimationJustStarted)
		{
			flag = false;
		}
		if (type == 5097 && ItemAnimationJustStarted)
		{
			_batbatCanHeal = true;
		}
		if (type == 5094 && ItemAnimationJustStarted)
		{
			_spawnTentacleSpikes = true;
		}
		if (type == 795 && ItemAnimationJustStarted)
		{
			_spawnBloodButcherer = true;
		}
		if (type == 121 && ItemAnimationJustStarted)
		{
			_spawnVolcanoExplosion = true;
		}
		if (type == 155 && ItemAnimationJustStarted)
		{
			_spawnMuramasaCut = true;
		}
		if (type == 3852)
		{
			if (itemAnimation < itemAnimationMax - 12)
			{
				flag = false;
			}
			if (altFunctionUse == 2 && !ItemAnimationJustStarted)
			{
				flag = false;
			}
		}
		if ((type == 4956 || type == 5669) && itemAnimation < itemAnimationMax - 3 * sItem.useTime)
		{
			flag = false;
		}
		if (type == 4952 && itemAnimation < itemAnimationMax - 8)
		{
			flag = false;
		}
		if (type == 4953 && itemAnimation < itemAnimationMax - 10)
		{
			flag = false;
		}
		if (type == 5451 && ownedProjectileCounts[1020] > 0)
		{
			flag = false;
		}
		if (type == 5738 && ownedProjectileCounts[1105] > 0)
		{
			flag = false;
		}
		if (ItemID.Sets.ShootsOnUseRelease[sItem.type] && controlUseItem)
		{
			flag = false;
		}
		bool flag2 = ItemID.Sets.PlaceTileOnAltUse[type];
		bool flag3 = false;
		if (altFunctionUse == 2 && flag2)
		{
			flag3 = true;
		}
		if (altFunctionUse == 2 && ItemID.Sets.IsAKite[type] && sItem.holdStyle != 0)
		{
			flag3 = false;
			StartChanneling();
		}
		ItemCheck_TurretAltFeatureUse(sItem, flag);
		ItemCheck_MinionAltFeatureUse(sItem, flag);
		bool flag4 = itemAnimation > 0 && ItemTimeIsZero && flag;
		if (type == 1156 && channel)
		{
			int num = 0;
			for (int i = 0; i < 1000; i++)
			{
				if (Main.projectile[i].active && Main.projectile[i].owner == whoAmI && Main.projectile[i].type == HeldItem.shoot)
				{
					num++;
				}
			}
			if (num > 0 && num < 3)
			{
				flag4 = true;
			}
		}
		if (sItem.shootsEveryUse)
		{
			flag4 = ItemAnimationJustStarted;
		}
		if (flag3)
		{
			flag4 = false;
		}
		if (sItem.shoot > 0 && flag4)
		{
			ItemCheck_Shoot(whoAmI, sItem, weaponDamage);
		}
		ItemCheck_UseWiringTools(sItem);
		ItemCheck_UseLawnMower(sItem);
		ItemCheck_PlayInstruments(sItem);
		ItemCheck_UseBuckets(sItem);
		if (!channel)
		{
			toolTime = itemTime;
		}
		else
		{
			toolTime--;
			if (toolTime < 0)
			{
				int num2 = sItem.useTime - 1;
				toolTime = num2;
			}
		}
		if (cannonCooldown > 0)
		{
			cannonCooldown--;
		}
		ItemCheck_TryDestroyingDrones(sItem);
		ItemCheck_UseMiningTools(sItem);
		ItemCheck_UseTeleportRod(sItem);
		ItemCheck_UseLifeCrystal(sItem);
		ItemCheck_UseLifeFruit(sItem);
		ItemCheck_UseManaCrystal(sItem);
		ItemCheck_UseDemonHeart(sItem);
		ItemCheck_UseMinecartPowerUp(sItem);
		ItemCheck_UseTorchGodsFavor(sItem);
		ItemCheck_UseArtisanLoaf(sItem);
		ItemCheck_UseEventItems(sItem);
		ItemCheck_UseBossSpawners(whoAmI, sItem);
		ItemCheck_UseCombatBook(sItem);
		ItemCheck_UsePeddlersSatchel(sItem);
		ItemCheck_UsePetLicenses(sItem);
		ItemCheck_UseShimmerPermanentItems(sItem);
		ItemCheck_UsePlayerSoundOverrideAccessory(sItem);
		if (sItem.type == 4095 && itemAnimation == 2)
		{
			Main.LocalGolfState.ResetGolfBall();
		}
		bool doPlacementAction = flag3 || !flag2;
		PlaceThing(doPlacementAction, ref context);
		if (sItem.makeNPC > 0)
		{
			if (!Main.GamepadDisableCursorItemIcon && IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost))
			{
				cursorItemIconEnabled = true;
				Main.ItemIconCacheUpdate(sItem.type);
			}
			if (ItemTimeIsZero && itemAnimation > 0 && controlUseItem && altFunctionUse == 0)
			{
				ItemCheck_ReleaseCritter(sItem);
			}
		}
		if (boneGloveItem != null && !boneGloveItem.IsAir && boneGloveTimer == 0 && itemAnimation > 0 && sItem.damage > 0)
		{
			boneGloveTimer = 60;
			Vector2 center = base.Center;
			Vector2 vector = DirectionTo(ApplyRangeCompensation(0.2f, center, Main.MouseWorld)) * 10f;
			Projectile.NewProjectile(GetProjectileSource_Accessory(boneGloveItem), center.X, center.Y, vector.X, vector.Y, 532, 25, 5f, whoAmI);
		}
		if (sItem.type == 1124 && itemAnimation > 0)
		{
			ItemCheck_GetMeleeHitbox(sItem, heldItemFrame, out var _, out var itemRectangle);
			if (Main.rand.Next(30) == 0)
			{
				_ = base.Center;
				Vector2 vector2 = DirectionTo(Main.MouseWorld) * 6f;
				int dmg = 5;
				int num3 = Projectile.NewProjectile(GetProjectileSource_Item(sItem), itemRectangle.X + itemRectangle.Width / 2, itemRectangle.Y + itemRectangle.Height / 2, vector2.X, vector2.Y, beeType(), beeDamage(dmg), beeKB(0f), whoAmI);
				Main.projectile[num3].melee = true;
			}
		}
		if (sItem.type > 0 && itemAnimation > 0)
		{
			ItemCheck_GetMeleeHitboxParticles(sItem, heldItemFrame);
		}
		if (((sItem.damage >= 0 && sItem.type > 0 && !sItem.noMelee) || sItem.type == 1991 || sItem.type == 3183 || sItem.type == 4821) && itemAnimation > 0)
		{
			ItemCheck_GetMeleeHitbox(sItem, heldItemFrame, out var dontAttack2, out var itemRectangle2);
			if (!dontAttack2)
			{
				ItemCheck_EmitUseVisuals(sItem, itemRectangle2);
				if (Main.myPlayer == whoAmI && (sItem.type == 1991 || sItem.type == 3183 || sItem.type == 4821))
				{
					ItemCheck_CatchCritters(sItem, itemRectangle2);
				}
				if (sItem.type == 3183 || sItem.type == 4821)
				{
					bool[] shouldIgnore = ItemCheck_GetTileCutIgnoreList(sItem);
					ItemCheck_CutTiles(sItem, itemRectangle2, shouldIgnore, cutExtraTiles: true);
				}
				if (sItem.damage > 0)
				{
					UpdateMeleeHitCooldowns();
					float knockBack = sItem.knockBack;
					float num4 = 1f;
					if (kbGlove)
					{
						num4 += 1f;
					}
					if (kbBuff)
					{
						num4 += 0.5f;
					}
					knockBack *= num4;
					if (inventory[selectedItem].type == 3106)
					{
						knockBack += knockBack * (1f - stealth);
					}
					bool[] shouldIgnore2 = ItemCheck_GetTileCutIgnoreList(sItem);
					ItemCheck_CutTiles(sItem, itemRectangle2, shouldIgnore2);
					ItemCheck_MeleeHitNPCs(sItem, itemRectangle2, weaponDamage, knockBack);
					ItemCheck_MeleeHitPVP(sItem, itemRectangle2, weaponDamage, knockBack);
					ItemCheck_EmitHammushProjectiles(whoAmI, sItem, itemRectangle2, weaponDamage);
				}
			}
		}
		if (sItem.type == 5464 && itemAnimation == itemAnimationMax - 1)
		{
			Vector2 vector3 = Main.MouseWorld - MountedCenter;
			ChangeDir((vector3.X > 0f) ? 1 : (-1));
			itemRotation = (vector3 * direction).ToRotation();
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			NetMessage.SendData(41, -1, -1, null, whoAmI);
		}
		if (sItem.type != 5644 || !ItemAnimationJustStarted)
		{
			return;
		}
		if (AnyoneToSpectate())
		{
			IngameUIWindows.CloseAll();
			SoundEngine.PlaySound(SoundID.Item197);
			SpectateNextPlayer(1, includeSelf: false);
			return;
		}
		SoundEngine.PlaySound(SoundID.Item198);
		if (Main.netMode == 0)
		{
			ChatHelper.DisplayMessage(NetworkText.FromKey("Game.SpectateSinglePlayer"), new Color(255, 240, 20), byte.MaxValue);
		}
		else
		{
			ChatHelper.DisplayMessage(NetworkText.FromKey("Game.SpectateNoTargets"), new Color(255, 240, 20), byte.MaxValue);
		}
	}

	private void ItemCheck_EmitFoodParticles(Item sItem)
	{
		if (itemAnimation < 1)
		{
			return;
		}
		Color[] array = ItemID.Sets.FoodParticleColors[sItem.type];
		if (array != null && array.Length != 0 && Main.rand.Next(2) != 0)
		{
			Vector2? mouthPosition = MouthPosition;
			if (mouthPosition.HasValue)
			{
				Vector2 vector = mouthPosition.Value + Main.rand.NextVector2Square(-4f, 4f);
				Vector2 spinningpoint = new Vector2(direction, (0f - gravDir) * 0.8f);
				Dust.NewDustPerfect(vector, 284, 1.3f * spinningpoint.RotatedBy((float)Math.PI / 5f * Main.rand.NextFloatDirection()), 0, array[Main.rand.Next(array.Length)], 0.8f + 0.2f * Main.rand.NextFloat()).fadeIn = 0f;
			}
		}
	}

	private void ItemCheck_EmitDrinkParticles(Item sItem)
	{
		if (itemAnimation < 1)
		{
			return;
		}
		Color[] array = ItemID.Sets.DrinkParticleColors[sItem.type];
		if (array != null && array.Length != 0)
		{
			Vector2? mouthPosition = MouthPosition;
			if (mouthPosition.HasValue)
			{
				Vector2 vector = mouthPosition.Value + Main.rand.NextVector2Square(-4f, 4f);
				Vector2 spinningpoint = new Vector2((float)direction * 0.1f, (0f - gravDir) * 0.1f);
				Dust.NewDustPerfect(vector, 284, 1.3f * spinningpoint.RotatedBy(-(float)Math.PI / 5f * Main.rand.NextFloatDirection()), 0, array[Main.rand.Next(array.Length)] * 0.7f, 0.8f + 0.2f * Main.rand.NextFloat()).fadeIn = 0f;
			}
		}
	}

	private void ItemCheck_UseBossSpawners(int onWhichPlayer, Item sItem)
	{
		if (!ItemTimeIsZero || itemAnimation <= 0 || (sItem.type != 43 && sItem.type != 70 && sItem.type != 544 && sItem.type != 556 && sItem.type != 557 && sItem.type != 560 && sItem.type != 1133 && sItem.type != 1331 && sItem.type != 4988 && sItem.type != 5120 && sItem.type != 5334) || !SummonItemCheck(sItem))
		{
			return;
		}
		if (sItem.type == 560)
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				NPC.SpawnOnPlayer(onWhichPlayer, 50);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, 50f);
			}
		}
		else if (sItem.type == 43)
		{
			if (!Main.IsItDay())
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 4);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 4f);
				}
				WorldGen.spawnEye = false;
			}
		}
		else if (sItem.type == 70)
		{
			if (ZoneCorrupt)
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 13);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 13f);
				}
			}
		}
		else if (sItem.type == 544)
		{
			if (!Main.IsItDay() && sItem.Variant != ItemVariants.DisabledBossSummonVariant)
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 125);
					NPC.SpawnOnPlayer(onWhichPlayer, 126);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 125f);
					NetMessage.SendData(61, -1, -1, null, whoAmI, 126f);
				}
			}
		}
		else if (sItem.type == 556)
		{
			if (!Main.IsItDay() && sItem.Variant != ItemVariants.DisabledBossSummonVariant)
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 134);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 134f);
				}
			}
		}
		else if (sItem.type == 557)
		{
			if (!Main.IsItDay() && sItem.Variant != ItemVariants.DisabledBossSummonVariant)
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 127);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 127f);
				}
			}
		}
		else if (sItem.type == 5334)
		{
			if (NPC.SpawnMechQueen(whoAmI))
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			}
		}
		else if (sItem.type == 1133)
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(SoundID.Item173, (int)position.X, (int)position.Y);
			if (Main.netMode != 1)
			{
				NPC.SpawnOnPlayer(onWhichPlayer, 222);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, 222f);
			}
		}
		else if (sItem.type == 1331)
		{
			if (ZoneCrimson)
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 266);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 266f);
				}
			}
		}
		else if (sItem.type == 4988)
		{
			if (ZoneHallow)
			{
				ApplyItemTime(sItem);
				SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
				if (Main.netMode != 1)
				{
					NPC.SpawnOnPlayer(onWhichPlayer, 657);
				}
				else
				{
					NetMessage.SendData(61, -1, -1, null, whoAmI, 657f);
				}
			}
		}
		else if (sItem.type == 5120 && ZoneSnow)
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				NPC.SpawnOnPlayer(onWhichPlayer, 668);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, 668f);
			}
		}
	}

	private void ItemCheck_UseEventItems(Item sItem)
	{
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 361 && Main.CanStartInvasion(1, ignoreDelay: true))
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				if (Main.invasionType == 0)
				{
					Main.invasionDelay = 0;
					Main.StartInvasion();
				}
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -1f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 602 && Main.CanStartInvasion(2, ignoreDelay: true))
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				if (Main.invasionType == 0)
				{
					Main.invasionDelay = 0;
					Main.StartInvasion(2);
				}
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -2f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 1315 && Main.CanStartInvasion(3, ignoreDelay: true))
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				if (Main.invasionType == 0)
				{
					Main.invasionDelay = 0;
					Main.StartInvasion(3);
				}
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -3f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 1844 && !Main.dayTime && !Main.pumpkinMoon && !Main.snowMoon && !DD2Event.Ongoing)
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				Main.NewText(Lang.misc[31].Value, 50, byte.MaxValue, 130);
				Main.startPumpkinMoon();
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -4f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 2767 && Main.dayTime && !Main.eclipse)
		{
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			ApplyItemTime(sItem);
			if (Main.netMode == 0)
			{
				Main.eclipse = true;
				if (Main.remixWorld)
				{
					Main.NewText(Lang.misc[106].Value, 50, byte.MaxValue, 130);
				}
				else
				{
					Main.NewText(Lang.misc[20].Value, 50, byte.MaxValue, 130);
				}
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -6f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 4271 && !Main.dayTime && !Main.bloodMoon)
		{
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			ApplyItemTime(sItem);
			if (Main.netMode == 0)
			{
				AchievementsHelper.NotifyProgressionEvent(4);
				Main.bloodMoon = true;
				if (Main.GetMoonPhase() == MoonPhase.Empty)
				{
					Main.moonPhase = 5;
				}
				Main.NewText(Lang.misc[8].Value, 50, byte.MaxValue, 130);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -10f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 3601 && NPC.downedGolemBoss && Main.hardMode && !NPC.AnyDanger() && !NPC.AnyoneNearCultists())
		{
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			ApplyItemTime(sItem);
			if (Main.netMode == 0)
			{
				WorldGen.StartImpendingDoom(720);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -8f);
			}
		}
		if (ItemTimeIsZero && itemAnimation > 0 && sItem.type == 1958 && !Main.dayTime && !Main.pumpkinMoon && !Main.snowMoon && !DD2Event.Ongoing)
		{
			ApplyItemTime(sItem);
			SoundEngine.PlaySound(15, (int)position.X, (int)position.Y, 0);
			if (Main.netMode != 1)
			{
				Main.NewText(Lang.misc[34].Value, 50, byte.MaxValue, 130);
				Main.startSnowMoon();
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -5f);
			}
		}
	}

	private void ItemCheck_ReleaseCritter(Item sItem)
	{
		if (sItem.makeNPC == 614)
		{
			ApplyItemTime(sItem);
			NPC.ReleaseNPC((int)base.Center.X, (int)base.Bottom.Y, sItem.makeNPC, sItem.placeStyle, whoAmI);
		}
		else if (IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost))
		{
			int num = (int)Main.MouseWorld.X;
			int num2 = (int)Main.MouseWorld.Y;
			int i = num / 16;
			int j = num2 / 16;
			if (!WorldGen.SolidTile(i, j))
			{
				ApplyItemTime(sItem);
				NPC.ReleaseNPC(num, num2, sItem.makeNPC, sItem.placeStyle, whoAmI);
			}
		}
	}

	private void ItemCheck_MeleeHitPVP(Item sItem, Rectangle itemRectangle, int damage, float knockBack)
	{
		if (!hostile)
		{
			return;
		}
		for (int i = 0; i < 255; i++)
		{
			Player player = Main.player[i];
			if (i == whoAmI || !player.active || !player.hostile || player.immune || player.dead || (team != 0 && team == player.team) || !itemRectangle.Intersects(player.Hitbox) || !CanHit(player))
			{
				continue;
			}
			bool flag = false;
			if (Main.rand.Next(1, 101) <= 10)
			{
				flag = true;
			}
			int num = Main.DamageVar(damage, luck);
			StatusToPlayerPvP(sItem.type, i);
			OnHit(player.Center.X, player.Center.Y, player);
			PlayerDeathReason playerDeathReason = PlayerDeathReason.ByPlayer(whoAmI);
			int num2 = (int)player.Hurt(playerDeathReason, num, direction, pvp: true, quiet: false, flag);
			if (inventory[selectedItem].type == 3211)
			{
				Vector2 vector = new Vector2(direction * 100 + Main.rand.Next(-25, 26), Main.rand.Next(-75, 76));
				vector.Normalize();
				vector *= (float)Main.rand.Next(30, 41) * 0.1f;
				Vector2 vector2 = new Vector2(itemRectangle.X + Main.rand.Next(itemRectangle.Width), itemRectangle.Y + Main.rand.Next(itemRectangle.Height));
				vector2 = (vector2 + player.Center * 2f) / 3f;
				Projectile.NewProjectile(GetProjectileSource_Item(HeldItem), vector2.X, vector2.Y, vector.X, vector.Y, 524, (int)((double)damage * 0.7), knockBack * 0.7f, whoAmI);
			}
			if (sItem.type == 5097)
			{
				BatBat_TryLifeLeeching(player);
			}
			if (beetleOffense)
			{
				beetleCounter += num2;
				beetleCountdown = 0;
			}
			if (meleeEnchant == 7)
			{
				Projectile.NewProjectile(GetProjectileSource_Misc(8), player.Center.X, player.Center.Y, player.velocity.X, player.velocity.Y, 289, 0, 0f, whoAmI);
			}
			if (sItem.type == 1123)
			{
				int num3 = Main.rand.Next(1, 4);
				if (strongBees && Main.rand.Next(3) == 0)
				{
					num3++;
				}
				for (int j = 0; j < num3; j++)
				{
					float num4 = (float)(direction * 2) + (float)Main.rand.Next(-35, 36) * 0.02f;
					float num5 = (float)Main.rand.Next(-35, 36) * 0.02f;
					num4 *= 0.2f;
					num5 *= 0.2f;
					int num6 = Projectile.NewProjectile(GetProjectileSource_Item(sItem), itemRectangle.X + itemRectangle.Width / 2, itemRectangle.Y + itemRectangle.Height / 2, num4, num5, beeType(), beeDamage(num / 3), beeKB(0f), whoAmI);
					Main.projectile[num6].melee = true;
				}
			}
			if (inventory[selectedItem].type == 3106)
			{
				stealth = 1f;
				if (Main.netMode == 1)
				{
					NetMessage.SendData(84, -1, -1, null, whoAmI);
				}
			}
			if (Main.netMode != 0)
			{
				NetMessage.SendPlayerHurt(i, playerDeathReason, num, direction, flag, pvp: true, ImmunityCooldownID.General);
			}
			ApplyAttackCooldown();
		}
	}

	private void Volcano_TrySpawningVolcano(NPC npc, Item sItem, float damage, float knockBack, Rectangle itemRectangle)
	{
		if (_spawnVolcanoExplosion && Main.myPlayer == whoAmI && (npc == null || npc.HittableForOnHitRewards()))
		{
			Vector2 center = npc.Center;
			int num = 2;
			Projectile.NewProjectile(GetProjectileSource_Item(sItem), center.X, center.Y, 0f, -1f * gravDir, 978, (int)damage, knockBack, whoAmI, 0f, num);
			_spawnVolcanoExplosion = false;
		}
	}

	private void TentacleSpike_TrySpiking(NPC npc, Item sItem, float damage, float knockBack)
	{
		if (_spawnTentacleSpikes && Main.myPlayer == whoAmI && (npc == null || npc.CanBeChasedBy(this)))
		{
			Vector2 v = npc.Center - MountedCenter;
			v = v.SafeNormalize(Vector2.Zero);
			Vector2 vector = npc.Hitbox.ClosestPointInRect(MountedCenter) + v;
			Vector2 vector2 = (npc.Center - vector) * 0.8f;
			int num = Projectile.NewProjectile(GetProjectileSource_Item(sItem), vector.X, vector.Y, vector2.X, vector2.Y, 971, (int)damage, knockBack, whoAmI, 1f, npc.whoAmI);
			Main.projectile[num].StatusNPC(npc.whoAmI);
			Projectile.KillOldestJavelin(num, 971, npc.whoAmI, _tentacleSpikesMax5);
			_spawnTentacleSpikes = false;
		}
	}

	private void BloodButcherer_TryButchering(NPC npc, Item sItem, float damage, float knockBack)
	{
		if (_spawnBloodButcherer && Main.myPlayer == whoAmI && (npc == null || npc.CanBeChasedBy(this)))
		{
			Vector2 v = npc.Center - MountedCenter;
			v = v.SafeNormalize(Vector2.Zero);
			Vector2 vector = npc.Hitbox.ClosestPointInRect(MountedCenter) + v;
			Vector2 spinningpoint = (npc.Center - vector) * 0.8f;
			spinningpoint = spinningpoint.RotatedBy(Main.rand.NextFloatDirection() * (float)Math.PI * 0.25f);
			int num = Projectile.NewProjectile(GetProjectileSource_Item(sItem), vector.X, vector.Y, spinningpoint.X, spinningpoint.Y, 975, (int)damage, knockBack, whoAmI, 1f, npc.whoAmI);
			Main.projectile[num].StatusNPC(npc.whoAmI);
			Projectile.KillOldestJavelin(num, 975, npc.whoAmI, _bloodButchererMax5);
			_spawnBloodButcherer = false;
		}
	}

	private void BatBat_TryLifeLeeching(Entity entity)
	{
		if (_batbatCanHeal && statLife < statLifeMax2 && (!(entity is NPC nPC) || nPC.HittableForOnHitRewards()))
		{
			_batbatCanHeal = false;
			Heal(1);
		}
	}

	public bool HasNPCBannerBuff(int bannerType)
	{
		return SceneMetrics.NPCBannerBuff[bannerType];
	}

	public static void ResetNPCSlotData(int npcIndex)
	{
		for (int i = 0; i < 255; i++)
		{
			Player obj = Main.player[i];
			obj.meleeNPCHitCooldown[npcIndex] = 0;
			obj.TagEffectState.ResetNPCSlotData(npcIndex);
		}
	}

	public void ResetMeleeHitCooldowns()
	{
		if (Main.myPlayer == whoAmI)
		{
			Array.Clear(meleeNPCHitCooldown, 0, Main.maxNPCs);
		}
	}

	public void UpdateMeleeHitCooldowns()
	{
		if (Main.myPlayer == whoAmI)
		{
			for (int i = 0; i < Main.maxNPCs; i++)
			{
				meleeNPCHitCooldown[i]--;
			}
		}
	}

	public bool CanHitNPCWithMeleeHit(int npcIndex)
	{
		return meleeNPCHitCooldown[npcIndex] <= 0;
	}

	public void SetMeleeHitCooldown(int npcIndex, int timeInFrames)
	{
		meleeNPCHitCooldown[npcIndex] = timeInFrames;
	}

	private void ItemCheck_MeleeHitNPCs(Item sItem, Rectangle itemRectangle, int originalDamage, float knockBack)
	{
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (nPC.active && nPC.immune[whoAmI] == 0 && CanHitNPCWithMeleeHit(i) && attackCD <= 0)
			{
				nPC.position += nPC.netOffset;
				ProcessHitAgainstNPC(sItem, itemRectangle, originalDamage, knockBack, i);
				nPC.position -= nPC.netOffset;
			}
		}
	}

	public void TakeDamageFromJellyfish(int npcIndex)
	{
		NPC nPC = Main.npc[npcIndex];
		Hurt(PlayerDeathReason.ByNPC(npcIndex), (int)((double)nPC.damage * 1.3), -direction);
		SetMeleeHitCooldown(npcIndex, itemAnimation);
		ApplyAttackCooldown();
	}

	private void ProcessHitAgainstNPC(Item sItem, Rectangle itemRectangle, int originalDamage, float knockBack, int npcIndex)
	{
		NPC nPC = Main.npc[npcIndex];
		if (nPC.dontTakeDamage || !CanNPCBeHitByPlayerOrPlayerProjectile(nPC))
		{
			if (NPCID.Sets.ZappingJellyfish[nPC.type] && itemRectangle.Intersects(nPC.Hitbox) && (nPC.noTileCollide || CanHit(nPC)))
			{
				TakeDamageFromJellyfish(npcIndex);
			}
		}
		else
		{
			if (nPC.friendly && (nPC.type != 22 || !killGuide) && (nPC.type != 54 || !killClothier) && (!nPC.isLikeATownNPC || (sItem.type != 5129 && sItem.type != 3351)))
			{
				return;
			}
			Rectangle rectangle = new Rectangle((int)nPC.position.X, (int)nPC.position.Y, nPC.width, nPC.height);
			bool flag = itemRectangle.Intersects(rectangle);
			int type = sItem.type;
			if (type == 121)
			{
				GetPointOnSwungItemPath(70f, 70f, 0f, GetAdjustedItemScale(sItem), out var location, out var outwardDirection);
				GetPointOnSwungItemPath(70f, 70f, 0.9f, GetAdjustedItemScale(sItem), out var location2, out outwardDirection);
				bool flag2 = Utils.LineRectangleDistance(rectangle, location, location2) <= 16f;
				flag = ((!_spawnVolcanoExplosion) ? (flag || flag2) : flag2);
			}
			if (!flag || (!nPC.noTileCollide && !CanHit(nPC)))
			{
				return;
			}
			int damage = originalDamage;
			damage = ApplyRapidAttackBonus(damage, sItem.type, !nPC.immortal);
			if (nPC.isLikeATownNPC && sItem.type == 3351)
			{
				damage = 1;
			}
			bool flag3 = false;
			int weaponCrit = GetWeaponCrit(sItem);
			if (Main.rand.Next(1, 101) <= weaponCrit)
			{
				flag3 = true;
			}
			if (GetBannerBuffEffect(nPC, out var effect))
			{
				damage = (int)((float)damage * effect.DamageDealt.Sample(Main.Difficulty));
			}
			if (parryDamageBuff && sItem.melee)
			{
				damage *= 5;
				parryDamageBuff = false;
				ClearBuff(198);
			}
			if (sItem.type == 426 && (float)nPC.life >= (float)nPC.lifeMax * 0.9f)
			{
				damage = (int)((float)damage * 2.5f);
			}
			if (sItem.type == 5096)
			{
				int num = 0;
				if (FindBuffIndex(26) != -1)
				{
					num = 1;
				}
				if (FindBuffIndex(206) != -1)
				{
					num = 2;
				}
				if (FindBuffIndex(207) != -1)
				{
					num = 3;
				}
				float num2 = 1f + 0.05f * (float)num;
				damage = (int)((float)damage * num2);
			}
			if (sItem.type == 671)
			{
				damage = nPC.KeyBrandStrike(whoAmI, damage, itemRectangle.Center.ToVector2());
			}
			int num3 = Main.DamageVar(damage, luck);
			float armorPenetrationPercent = 0f;
			if (sItem.type == 5129 && nPC.isLikeATownNPC)
			{
				armorPenetrationPercent = 1f;
				if (nPC.type == 18)
				{
					num3 *= 2;
				}
			}
			if (sItem.type == 3258)
			{
				ParticleOrchestraSettings settings = new ParticleOrchestraSettings
				{
					PositionInWorld = nPC.Center
				};
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.SlapHand, settings, whoAmI);
			}
			if (sItem.type == 5382)
			{
				ParticleOrchestraSettings settings2 = new ParticleOrchestraSettings
				{
					PositionInWorld = nPC.Center
				};
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.WaffleIron, settings2, whoAmI);
			}
			if (sItem.type == 3351 && nPC.type != 488 && nPC.lifeMax > 5)
			{
				int num4 = Item.NewItem(GetItemSource_Misc(ItemSourceID.LuckyCoin), (int)nPC.Left.X + Main.rand.Next(nPC.width), (int)nPC.Top.Y + Main.rand.Next(nPC.height), 1, 1, 71, 1 + RollBadLuck(25));
				WorldItem worldItem = Main.item[num4];
				if (Main.netMode == 0)
				{
					worldItem.noGrabDelay = 100;
				}
				worldItem.timeLeftInWhichTheItemCannotBeTakenByEnemies = 100;
				worldItem.velocity.Y = -2f - Main.rand.NextFloat() * 2f;
				worldItem.velocity.X = (2f + Main.rand.NextFloat() * 2f) * (float)direction;
				worldItem.favorited = false;
				worldItem.newAndShiny = false;
				if (Main.netMode == 1)
				{
					NetMessage.SendData(148, -1, -1, null, num4);
				}
				ParticleOrchestraSettings settings3 = new ParticleOrchestraSettings
				{
					PositionInWorld = nPC.Center
				};
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.ClassyCane, settings3, whoAmI);
			}
			if (sItem.type == 5129)
			{
				ParticleOrchestraSettings settings4 = new ParticleOrchestraSettings
				{
					PositionInWorld = nPC.Center
				};
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.FlyMeal, settings4, whoAmI);
				if (nPC.townNPC)
				{
					AchievementsHelper.NotifyProgressionEvent(42);
				}
			}
			if (sItem.type == 1166 || sItem.type == 1320)
			{
				Vector2 vector = new Vector2(itemRectangle.Left + Main.rand.Next(itemRectangle.Width), itemRectangle.Top + Main.rand.Next(itemRectangle.Height / 2));
				Vector2 vector2 = new Vector2((float)direction * (1f + Main.rand.NextFloat() * 5f), -1f - Main.rand.NextFloat() * 3f);
				int damage2 = (int)((double)originalDamage * 0.75);
				Projectile.NewProjectile(GetProjectileSource_Item(sItem), vector, vector2, 21, damage2, knockBack, Main.myPlayer);
			}
			StatusToNPC(sItem.type, npcIndex);
			if (nPC.life > 5)
			{
				OnHit(nPC.Center.X, nPC.Center.Y, nPC);
			}
			num3 += nPC.checkArmorPenetration(GetArmorPenetration(sItem.melee), armorPenetrationPercent);
			NPCKillAttempt attempt = new NPCKillAttempt(nPC);
			int num5 = (int)nPC.StrikeNPC(num3, knockBack, direction, flag3, noEffect: false, fromNet: false, whoAmI);
			ApplyNPCOnHitEffects(sItem, itemRectangle, damage, knockBack, npcIndex, num3, num5);
			int num6 = BannerSystem.NPCtoBanner(nPC.BannerID());
			if (num6 >= 0)
			{
				lastCreatureHit = num6;
			}
			if (Main.netMode != 0)
			{
				if (flag3)
				{
					NetMessage.SendData(28, -1, -1, null, npcIndex, num3, knockBack, direction, 1);
				}
				else
				{
					NetMessage.SendData(28, -1, -1, null, npcIndex, num3, knockBack, direction);
				}
			}
			if (accDreamCatcher)
			{
				addDPS(num5);
			}
			SetMeleeHitCooldown(npcIndex, itemAnimation);
			if (attempt.DidNPCDie())
			{
				OnKillNPC(ref attempt, sItem);
			}
			ApplyAttackCooldown();
		}
	}

	public void ApplyAttackCooldown()
	{
		attackCD = Math.Max(1, (int)((double)itemAnimationMax * 0.33));
	}

	public void ApplyAttackCooldown(int frames)
	{
		if (attackCD < frames)
		{
			attackCD = frames;
		}
	}

	private void ApplyNPCOnHitEffects(Item sItem, Rectangle itemRectangle, int damage, float knockBack, int npcIndex, int dmgRandomized, int dmgDone)
	{
		bool flag = !Main.npc[npcIndex].immortal;
		if (Main.npc[npcIndex].type == 488 && DebugOptions.LetProjectilesAimAtTargetDummies)
		{
			flag = true;
		}
		if (flag && ItemID.Sets.UniqueTagEffects[sItem.type] != null)
		{
			TagEffectState.TryApplyTagToNPC(sItem.type, Main.npc[npcIndex]);
		}
		if (sItem.type == 3211)
		{
			Vector2 vector = new Vector2(direction * 100 + Main.rand.Next(-25, 26), Main.rand.Next(-75, 76));
			vector.Normalize();
			vector *= (float)Main.rand.Next(30, 41) * 0.1f;
			Vector2 vector2 = new Vector2(itemRectangle.X + Main.rand.Next(itemRectangle.Width), itemRectangle.Y + Main.rand.Next(itemRectangle.Height));
			vector2 = (vector2 + Main.npc[npcIndex].Center * 2f) / 3f;
			Projectile.NewProjectile(GetProjectileSource_Item(sItem), vector2.X, vector2.Y, vector.X, vector.Y, 524, (int)((double)damage * 0.5), knockBack * 0.7f, whoAmI);
		}
		if (beetleOffense && flag)
		{
			beetleCounter += dmgDone;
			beetleCountdown = 0;
		}
		if (meleeEnchant == 7)
		{
			Projectile.NewProjectile(GetProjectileSource_Misc(8), Main.npc[npcIndex].Center.X, Main.npc[npcIndex].Center.Y, Main.npc[npcIndex].velocity.X, Main.npc[npcIndex].velocity.Y, 289, 0, 0f, whoAmI);
		}
		if (sItem.type == 3106)
		{
			stealth = 1f;
			if (Main.netMode == 1)
			{
				NetMessage.SendData(84, -1, -1, null, whoAmI);
			}
		}
		if (sItem.type == 5094)
		{
			TentacleSpike_TrySpiking(Main.npc[npcIndex], sItem, damage, knockBack);
		}
		if (sItem.type == 795)
		{
			BloodButcherer_TryButchering(Main.npc[npcIndex], sItem, damage, knockBack);
		}
		if (sItem.type == 121)
		{
			Volcano_TrySpawningVolcano(Main.npc[npcIndex], sItem, (int)((float)damage * 0.75f), knockBack, itemRectangle);
		}
		if (sItem.type == 5097)
		{
			BatBat_TryLifeLeeching(Main.npc[npcIndex]);
		}
		if (sItem.type == 1123 && flag)
		{
			int num = Main.rand.Next(1, 4);
			if (strongBees && Main.rand.Next(3) == 0)
			{
				num++;
			}
			for (int i = 0; i < num; i++)
			{
				float num2 = (float)(direction * 2) + (float)Main.rand.Next(-35, 36) * 0.02f;
				float num3 = (float)Main.rand.Next(-35, 36) * 0.02f;
				num2 *= 0.2f;
				num3 *= 0.2f;
				int num4 = Projectile.NewProjectile(GetProjectileSource_Item(sItem), itemRectangle.X + itemRectangle.Width / 2, itemRectangle.Y + itemRectangle.Height / 2, num2, num3, beeType(), beeDamage(dmgRandomized / 3), beeKB(0f), whoAmI);
				Main.projectile[num4].melee = true;
			}
		}
		if (sItem.type == 155 && flag && _spawnMuramasaCut)
		{
			_spawnMuramasaCut = false;
			int num5 = Main.rand.Next(1, 4);
			num5 = 1;
			for (int j = 0; j < num5; j++)
			{
				NPC nPC = Main.npc[npcIndex];
				Rectangle hitbox = nPC.Hitbox;
				hitbox.Inflate(30, 16);
				hitbox.Y -= 8;
				Vector2 vector3 = Main.rand.NextVector2FromRectangle(hitbox);
				Vector2 vector4 = hitbox.Center.ToVector2();
				Vector2 spinningpoint = (vector4 - vector3).SafeNormalize(new Vector2(direction, gravDir)) * 8f;
				Main.rand.NextFloat();
				float num6 = (float)(Main.rand.Next(2) * 2 - 1) * ((float)Math.PI / 5f + (float)Math.PI * 4f / 5f * Main.rand.NextFloat());
				num6 *= 0.5f;
				spinningpoint = spinningpoint.RotatedBy(0.7853981852531433);
				int num7 = 3;
				int num8 = 10 * num7;
				int num9 = 5;
				int num10 = num9 * num7;
				vector3 = vector4;
				for (int k = 0; k < num10; k++)
				{
					vector3 -= spinningpoint;
					spinningpoint = spinningpoint.RotatedBy((0f - num6) / (float)num8);
				}
				vector3 += nPC.velocity * num9;
				Projectile.NewProjectile(GetProjectileSource_Item(sItem), vector3, spinningpoint, 977, (int)((float)dmgRandomized * 0.5f), 0f, whoAmI, num6);
			}
		}
		if (Main.npc[npcIndex].value > 0f && hasLuckyCoin && Main.rand.Next(5) == 0)
		{
			int type = 71;
			if (Main.rand.Next(10) == 0)
			{
				type = 72;
			}
			if (Main.rand.Next(100) == 0)
			{
				type = 73;
			}
			int num11 = Item.NewItem(GetItemSource_OnHit(Main.npc[npcIndex], ItemSourceID.LuckyCoin), (int)Main.npc[npcIndex].position.X, (int)Main.npc[npcIndex].position.Y, Main.npc[npcIndex].width, Main.npc[npcIndex].height, type);
			Main.item[num11].stack = Main.rand.Next(1, 11);
			Main.item[num11].velocity.Y = (float)Main.rand.Next(-20, 1) * 0.2f;
			Main.item[num11].velocity.X = (float)Main.rand.Next(10, 31) * 0.2f * (float)direction;
			Main.item[num11].timeLeftInWhichTheItemCannotBeTakenByEnemies = 60;
			if (Main.netMode == 1)
			{
				NetMessage.SendData(148, -1, -1, null, num11);
			}
		}
	}

	private void ItemCheck_EmitHammushProjectiles(int i, Item sItem, Rectangle itemRectangle, int damage)
	{
		if (sItem.type != 787)
		{
			return;
		}
		int num = itemAnimationMax;
		if (itemAnimation != (int)((double)num * 0.1) && itemAnimation != (int)((double)num * 0.3) && itemAnimation != (int)((double)num * 0.5) && itemAnimation != (int)((double)num * 0.7) && itemAnimation != (int)((double)num * 0.9))
		{
			return;
		}
		float num2 = 0f;
		float num3 = 0f;
		float num4 = 0f;
		float num5 = 0f;
		if (itemAnimation == (int)((double)num * 0.9))
		{
			num2 = -7f;
		}
		if (itemAnimation == (int)((double)num * 0.7))
		{
			num2 = -6f;
			num3 = 2f;
		}
		if (itemAnimation == (int)((double)num * 0.5))
		{
			num2 = -4f;
			num3 = 4f;
		}
		if (itemAnimation == (int)((double)num * 0.3))
		{
			num2 = -2f;
			num3 = 6f;
		}
		if (itemAnimation == (int)((double)num * 0.1))
		{
			num3 = 7f;
		}
		if (itemAnimation == (int)((double)num * 0.7))
		{
			num5 = 26f;
		}
		if (itemAnimation == (int)((double)num * 0.3))
		{
			num5 -= 4f;
			num4 -= 20f;
		}
		if (itemAnimation == (int)((double)num * 0.1))
		{
			num4 += 6f;
		}
		if (direction == -1)
		{
			if (itemAnimation == (int)((double)num * 0.9))
			{
				num5 -= 8f;
			}
			if (itemAnimation == (int)((double)num * 0.7))
			{
				num5 -= 6f;
			}
		}
		num2 *= 1.5f;
		num3 *= 1.5f;
		num5 *= (float)direction;
		num4 *= gravDir;
		Projectile.NewProjectile(GetProjectileSource_Item(sItem), (float)(itemRectangle.X + itemRectangle.Width / 2) + num5, (float)(itemRectangle.Y + itemRectangle.Height / 2) + num4, (float)direction * num3, num2 * gravDir, 131, damage / 2, 0f, i);
	}

	private bool[] ItemCheck_GetTileCutIgnoreList(Item sItem)
	{
		bool allowRegrowth = false;
		int type = sItem.type;
		if (type == 213 || type == 5295)
		{
			allowRegrowth = true;
		}
		return GetTileCutIgnorance(allowRegrowth, fromTrap: false);
	}

	public bool[] GetTileCutIgnorance(bool allowRegrowth, bool fromTrap)
	{
		bool[] result = TileID.Sets.TileCutIgnore.None;
		if (allowRegrowth)
		{
			result = TileID.Sets.TileCutIgnore.Regrowth;
		}
		if (!fromTrap && dontHurtNature)
		{
			result = TileID.Sets.TileCutIgnore.IgnoreDontHurtNature;
		}
		return result;
	}

	private void ItemCheck_CutTiles(Item sItem, Rectangle itemRectangle, bool[] shouldIgnore, bool cutExtraTiles = false)
	{
		if (sItem.type == 213 || sItem.type == 5295)
		{
			staffOfRegrowthBonus = true;
		}
		int minX = itemRectangle.X / 16;
		int maxX = (itemRectangle.X + itemRectangle.Width) / 16 + 1;
		int minY = itemRectangle.Y / 16;
		int maxY = (itemRectangle.Y + itemRectangle.Height) / 16 + 1;
		Utils.ClampWithinWorld(ref minX, ref minY, ref maxX, ref maxY);
		for (int i = minX; i < maxX; i++)
		{
			for (int j = minY; j < maxY; j++)
			{
				if (Main.tile[i, j] == null || (!Main.tileCut[Main.tile[i, j].type] && (!cutExtraTiles || !TileID.Sets.bonusCutTiles[Main.tile[i, j].type])) || shouldIgnore[Main.tile[i, j].type] || !WorldGen.CanCutTile(i, j, TileCuttingContext.AttackMelee))
				{
					continue;
				}
				if (sItem.type == 1786)
				{
					ushort type = Main.tile[i, j].type;
					WorldGen.KillTile(i, j);
					if (!Main.tile[i, j].active())
					{
						int num = 0;
						switch (type)
						{
						case 3:
						case 24:
						case 61:
						case 110:
						case 201:
						case 529:
						case 637:
							num = Main.rand.Next(1, 3);
							break;
						case 73:
						case 74:
						case 113:
							num = Main.rand.Next(2, 5);
							break;
						}
						if (num > 0)
						{
							int number = Item.NewItem(WorldGen.GetItemSource_FromTileBreak(i, j), i * 16, j * 16, 16, 16, 1727, num);
							if (Main.netMode == 1)
							{
								NetMessage.SendData(21, -1, -1, null, number, 1f);
							}
						}
					}
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, i, j);
					}
				}
				else
				{
					WorldGen.KillTile(i, j);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, i, j);
					}
				}
			}
		}
		staffOfRegrowthBonus = false;
	}

	private void ItemCheck_CatchCritters(Item sItem, Rectangle itemRectangle)
	{
		bool flag = sItem.type == 3183 || sItem.type == 4821;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			if (!Main.npc[i].active || Main.npc[i].catchItem <= 0)
			{
				continue;
			}
			Rectangle value = new Rectangle((int)Main.npc[i].position.X, (int)Main.npc[i].position.Y, Main.npc[i].width, Main.npc[i].height);
			if (!itemRectangle.Intersects(value))
			{
				continue;
			}
			if (!flag && ItemID.Sets.IsLavaBait[Main.npc[i].catchItem])
			{
				if (Main.myPlayer == whoAmI && Hurt(PlayerDeathReason.ByNPC(i), 1, (Main.npc[i].Center.X < base.Center.X) ? 1 : (-1), pvp: false, quiet: false, Crit: false, ImmunityCooldownID.WrongBugNet) > 0.0 && !dead)
				{
					AddBuff(24, 300);
				}
			}
			else if (Main.npc[i].type == 585 || Main.npc[i].type == 583 || Main.npc[i].type == 584)
			{
				if (Main.npc[i].ai[2] <= 1f)
				{
					NPC.CatchNPC(i, whoAmI);
				}
			}
			else
			{
				NPC.CatchNPC(i, whoAmI);
			}
		}
	}

	private void GetPointOnSwungItemPath(float spriteWidth, float spriteHeight, float normalizedPointOnPath, float itemScale, out Vector2 location, out Vector2 outwardDirection)
	{
		float num = (float)Math.Sqrt(spriteWidth * spriteWidth + spriteHeight * spriteHeight);
		float num2 = (float)(direction == 1).ToInt() * ((float)Math.PI / 2f);
		if (gravDir == -1f)
		{
			num2 += (float)Math.PI / 2f * (float)direction;
		}
		outwardDirection = itemRotation.ToRotationVector2().RotatedBy(3.926991f + num2);
		location = RotatedRelativePoint(itemLocation + outwardDirection * num * normalizedPointOnPath * itemScale);
	}

	private void ItemCheck_EmitUseVisuals(Item sItem, Rectangle itemRectangle)
	{
		if (sItem.type == 989 && Main.rand.Next(5) == 0)
		{
			int num = Main.rand.Next(3);
			int num2 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, num switch
			{
				0 => 15, 
				1 => 57, 
				_ => 58, 
			}, direction * 2, 0f, 150, default(Color), 1.3f);
			Main.dust[num2].velocity *= 0.2f;
		}
		if (sItem.type == 2880 && Main.rand.Next(2) == 0)
		{
			int type = Utils.SelectRandom<int>(Main.rand, 226, 229);
			int num3 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, type, direction * 2, 0f, 150);
			Main.dust[num3].velocity *= 0.2f;
			Main.dust[num3].noGravity = true;
		}
		if ((sItem.type == 44 || sItem.type == 45 || sItem.type == 103 || sItem.type == 104) && Main.rand.Next(15) == 0)
		{
			Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 14, direction * 2, 0f, 150, default(Color), 1.3f);
		}
		if (sItem.type == 46 && Main.rand.Next(15) == 0)
		{
			Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 14, direction * 2, 0f, 150, default(Color), 1.3f);
		}
		if (sItem.type == 273 || sItem.type == 675)
		{
			if (Main.rand.Next(5) == 0)
			{
				Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 14, direction * 2, 0f, 150, default(Color), 1.4f);
			}
			int num4 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 27, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 1.2f);
			Main.dust[num4].noGravity = true;
			Main.dust[num4].velocity.X /= 2f;
			Main.dust[num4].velocity.Y /= 2f;
		}
		if (sItem.type == 723 && Main.rand.Next(2) == 0)
		{
			int num5 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 64, 0f, 0f, 150, default(Color), 1.2f);
			Main.dust[num5].noGravity = true;
		}
		if (sItem.type == 65)
		{
			if (Main.rand.Next(5) == 0)
			{
				Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 58, 0f, 0f, 150, default(Color), 1.2f);
			}
			if (Main.rand.Next(10) == 0)
			{
				Gore.NewGore(new Vector2(itemRectangle.X, itemRectangle.Y), default(Vector2), Main.rand.Next(16, 18));
			}
		}
		if (sItem.type == 3065)
		{
			int num6 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 58, 0f, 0f, 150, default(Color), 1.2f);
			Main.dust[num6].velocity *= 0.5f;
			if (Main.rand.Next(8) == 0)
			{
				int num7 = Gore.NewGore(new Vector2(itemRectangle.Center.X, itemRectangle.Center.Y), default(Vector2), 16);
				Main.gore[num7].velocity *= 0.5f;
				Main.gore[num7].velocity += new Vector2(direction, 0f);
			}
		}
		if (sItem.type == 190)
		{
			int num8 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 40, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 0, default(Color), 1.2f);
			Main.dust[num8].noGravity = true;
		}
		else if (sItem.type == 213 || sItem.type == 5295)
		{
			int num9 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 3, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 0, default(Color), 1.2f);
			Main.dust[num9].noGravity = true;
		}
		if (sItem.type == 121)
		{
			for (int i = 0; i < 2; i++)
			{
				GetPointOnSwungItemPath(70f, 70f, 0.2f + 0.8f * Main.rand.NextFloat(), GetAdjustedItemScale(sItem), out var location, out var outwardDirection);
				Vector2 vector = outwardDirection.RotatedBy((float)Math.PI / 2f * (float)direction * gravDir);
				Dust.NewDustPerfect(location, 6, vector * 4f, 100, default(Color), 2.5f).noGravity = true;
			}
		}
		if (sItem.type == 122 || sItem.type == 217)
		{
			int num10 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 6, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 1.9f);
			Main.dust[num10].noGravity = true;
		}
		if (sItem.type == 155)
		{
			int num11 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 172, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 0.9f);
			Main.dust[num11].noGravity = true;
			Main.dust[num11].velocity *= 0.1f;
		}
		if (sItem.type == 676 && Main.rand.Next(3) == 0)
		{
			int num12 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 67, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 90, default(Color), 1.5f);
			Main.dust[num12].noGravity = true;
			Main.dust[num12].velocity *= 0.2f;
		}
		if (sItem.type == 3063)
		{
			int num13 = Dust.NewDust(itemRectangle.TopLeft(), itemRectangle.Width, itemRectangle.Height, 66, 0f, 0f, 150, Color.Transparent, 0.85f);
			Main.dust[num13].color = Main.hslToRgb(Main.rand.NextFloat(), 1f, 0.5f);
			Main.dust[num13].noGravity = true;
			Main.dust[num13].velocity /= 2f;
		}
		if (sItem.type == 3823)
		{
			Dust dust = Dust.NewDustDirect(itemRectangle.TopLeft(), itemRectangle.Width, itemRectangle.Height, 6, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, Color.Transparent, 0.7f);
			dust.noGravity = true;
			dust.velocity *= 2f;
			dust.fadeIn = 0.9f;
		}
		if (sItem.type == 724 && Main.rand.Next(5) == 0)
		{
			int num14 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 67, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 90, default(Color), 1.5f);
			Main.dust[num14].noGravity = true;
			Main.dust[num14].velocity *= 0.2f;
		}
		if (sItem.type >= 795 && sItem.type <= 802)
		{
			for (int j = 0; j < 2; j++)
			{
				GetPointOnSwungItemPath(60f, 60f, 0.2f + 0.8f * Main.rand.NextFloat(), GetAdjustedItemScale(sItem), out var location2, out var outwardDirection2);
				Vector2 vector2 = outwardDirection2.RotatedBy((float)Math.PI / 2f * (float)direction * gravDir);
				Dust.NewDustPerfect(location2, 5, vector2 * 2f, 100, default(Color), 0.7f + Main.rand.NextFloat() * 0.6f);
				if (Main.rand.Next(20) == 0)
				{
					int num15 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 115, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 140, default(Color), 0.7f);
					Main.dust[num15].position = location2;
					Main.dust[num15].fadeIn = 1.2f;
					Main.dust[num15].noGravity = true;
					Main.dust[num15].velocity *= 0.25f;
					Main.dust[num15].velocity += vector2 * 5f;
				}
			}
		}
		if (sItem.type == 367)
		{
			int num16 = 0;
			if (Main.rand.Next(3) == 0)
			{
				num16 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 57, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 1.1f);
				Main.dust[num16].noGravity = true;
				Main.dust[num16].velocity.X /= 2f;
				Main.dust[num16].velocity.Y /= 2f;
				Main.dust[num16].velocity.X += direction * 2;
			}
			if (Main.rand.Next(4) == 0)
			{
				num16 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 43, 0f, 0f, 254, default(Color), 0.3f);
				Main.dust[num16].velocity *= 0f;
			}
		}
		else if (sItem.type != 368)
		{
			_ = sItem.type;
			_ = 674;
		}
		if (!sItem.noUseGraphic && (sItem.type == 5670 || sItem.type == 5671 || sItem.type == 5535 || sItem.type == 5536 || sItem.type == 4258 || sItem.type == 4259 || (sItem.type >= 198 && sItem.type <= 203) || (sItem.type >= 3764 && sItem.type <= 3769)))
		{
			Color color = Item.GetPhaseColor(sItem.shoot) * 0.5f;
			float r = (float)(int)color.R / 255f;
			float g = (float)(int)color.G / 255f;
			float b = (float)(int)color.B / 255f;
			Lighting.AddLight((int)((itemLocation.X + 6f + velocity.X) / 16f), (int)((itemLocation.Y - 14f) / 16f), r, g, b);
		}
		if (frostBurn && sItem.melee && !sItem.noMelee && !sItem.noUseGraphic && Main.rand.Next(2) == 0)
		{
			int num17 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 135, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 2.5f);
			Main.dust[num17].noGravity = true;
			Main.dust[num17].velocity *= 0.7f;
			Main.dust[num17].velocity.Y -= 0.5f;
		}
		if (sItem.melee && !sItem.noMelee && !sItem.noUseGraphic && meleeEnchant > 0)
		{
			if (meleeEnchant == 1)
			{
				if (Main.rand.Next(3) == 0)
				{
					int num18 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 171, 0f, 0f, 100);
					Main.dust[num18].noGravity = true;
					Main.dust[num18].fadeIn = 1.5f;
					Main.dust[num18].velocity *= 0.25f;
				}
			}
			else if (meleeEnchant == 2)
			{
				if (Main.rand.Next(2) == 0)
				{
					int num19 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 75, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 2.5f);
					Main.dust[num19].noGravity = true;
					Main.dust[num19].velocity *= 0.7f;
					Main.dust[num19].velocity.Y -= 0.5f;
				}
			}
			else if (meleeEnchant == 3)
			{
				if (Main.rand.Next(2) == 0)
				{
					int num20 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 6, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 2.5f);
					Main.dust[num20].noGravity = true;
					Main.dust[num20].velocity *= 0.7f;
					Main.dust[num20].velocity.Y -= 0.5f;
				}
			}
			else if (meleeEnchant == 4)
			{
				int num21 = 0;
				if (Main.rand.Next(2) == 0)
				{
					num21 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 57, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 1.1f);
					Main.dust[num21].noGravity = true;
					Main.dust[num21].velocity.X /= 2f;
					Main.dust[num21].velocity.Y /= 2f;
				}
			}
			else if (meleeEnchant == 5)
			{
				if (Main.rand.Next(2) == 0)
				{
					int num22 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 169, 0f, 0f, 100);
					Main.dust[num22].velocity.X += direction;
					Main.dust[num22].velocity.Y += 0.2f;
					Main.dust[num22].noGravity = true;
				}
			}
			else if (meleeEnchant == 6)
			{
				if (Main.rand.Next(2) == 0)
				{
					int num23 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 135, 0f, 0f, 100);
					Main.dust[num23].velocity.X += direction;
					Main.dust[num23].velocity.Y += 0.2f;
					Main.dust[num23].noGravity = true;
				}
			}
			else if (meleeEnchant == 7)
			{
				if (Main.rand.Next(20) == 0)
				{
					int type2 = Main.rand.Next(139, 143);
					int num24 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, type2, velocity.X, velocity.Y, 0, default(Color), 1.2f);
					Main.dust[num24].velocity.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.dust[num24].velocity.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.dust[num24].velocity.X += (float)Main.rand.Next(-50, 51) * 0.05f;
					Main.dust[num24].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.05f;
					Main.dust[num24].scale *= 1f + (float)Main.rand.Next(-30, 31) * 0.01f;
				}
				if (Main.rand.Next(40) == 0)
				{
					int type3 = Main.rand.Next(276, 283);
					int num25 = Gore.NewGore(new Vector2(itemRectangle.X, itemRectangle.Y), velocity, type3);
					Main.gore[num25].velocity.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.gore[num25].velocity.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
					Main.gore[num25].scale *= 1f + (float)Main.rand.Next(-20, 21) * 0.01f;
					Main.gore[num25].velocity.X += (float)Main.rand.Next(-50, 51) * 0.05f;
					Main.gore[num25].velocity.Y += (float)Main.rand.Next(-50, 51) * 0.05f;
				}
			}
			else if (meleeEnchant == 8 && Main.rand.Next(4) == 0)
			{
				int num26 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 46, 0f, 0f, 100);
				Main.dust[num26].noGravity = true;
				Main.dust[num26].fadeIn = 1.5f;
				Main.dust[num26].velocity *= 0.25f;
			}
		}
		if (magmaStone && sItem.melee && !sItem.noMelee && !sItem.noUseGraphic && Main.rand.Next(3) != 0)
		{
			int num27 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 6, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 2.5f);
			Main.dust[num27].noGravity = true;
			Main.dust[num27].velocity.X *= 2f;
			Main.dust[num27].velocity.Y *= 2f;
		}
		if (sItem.type == 1304 && Main.rand.Next(60) == 0 && ChildSafety.Disabled)
		{
			Gore.NewGore(new Vector2(itemRectangle.Left + itemRectangle.Width / 2, itemRectangle.Top + itemRectangle.Height / 2), new Vector2((float)direction * (2f + Main.rand.NextFloat() * 3f), -2f - Main.rand.NextFloat() * 3f), Main.rand.Next(3, 6));
		}
		if (!mount.Active || (mount.Type != 62 && mount.Type != 63) || !sItem.melee || sItem.noMelee || sItem.noUseGraphic)
		{
			return;
		}
		Vector3 vector3 = ((mount.Type == 63) ? new Vector3(0.6f, 0.3f, 0.1f) : new Vector3(0.5f, 0.1f, 0.6f));
		Lighting.AddLight(itemRectangle.Center.ToVector2(), vector3 * 0.5f);
		if (Main.rand.Next(3) != 0)
		{
			int num28 = Dust.NewDust(new Vector2(itemRectangle.X, itemRectangle.Y), itemRectangle.Width, itemRectangle.Height, 306, velocity.X * 0.2f + (float)(direction * 3), velocity.Y * 0.2f, 100, default(Color), 1.25f);
			Main.dust[num28].noGravity = true;
			Main.dust[num28].velocity.X *= 0.2f;
			Main.dust[num28].velocity.Y *= 0.2f;
			float num29 = Main.rand.NextFloat();
			Main.dust[num28].color = Color.Lerp(new Color(0.9f, 0.7f, 1f), Color.White, num29 * num29 * num29);
			if (mount.Type == 63)
			{
				Main.dust[num28].color = Color.Lerp(new Color(1f, 0.7f, 0.5f), Color.White, num29 * num29 * num29);
			}
		}
	}

	private void ItemCheck_GetMeleeHitboxParticles(Item sItem, Rectangle heldItemFrame)
	{
		if (sItem.type == 1450 && Main.rand.Next(3) == 0)
		{
			ItemCheck_GetMeleeHitbox(sItem, heldItemFrame, out var _, out var itemRectangle);
			int num = -1;
			float x = itemRectangle.X + Main.rand.Next(itemRectangle.Width);
			float y = itemRectangle.Y + Main.rand.Next(itemRectangle.Height);
			if (Main.rand.Next(500) == 0)
			{
				num = Gore.NewGore(new Vector2(x, y), default(Vector2), 415, (float)Main.rand.Next(51, 101) * 0.01f);
			}
			else if (Main.rand.Next(250) == 0)
			{
				num = Gore.NewGore(new Vector2(x, y), default(Vector2), 414, (float)Main.rand.Next(51, 101) * 0.01f);
			}
			else if (Main.rand.Next(80) == 0)
			{
				num = Gore.NewGore(new Vector2(x, y), default(Vector2), 413, (float)Main.rand.Next(51, 101) * 0.01f);
			}
			else if (Main.rand.Next(10) == 0)
			{
				num = Gore.NewGore(new Vector2(x, y), default(Vector2), 412, (float)Main.rand.Next(51, 101) * 0.01f);
			}
			else if (Main.rand.Next(3) == 0)
			{
				num = Gore.NewGore(new Vector2(x, y), default(Vector2), 411, (float)Main.rand.Next(51, 101) * 0.01f);
			}
			if (num >= 0)
			{
				Main.gore[num].velocity.X += direction * 2;
				Main.gore[num].velocity.Y *= 0.3f;
			}
		}
		if (sItem.type == 3779)
		{
			Vector2 vector = itemLocation + new Vector2(direction * 30, -8f);
			Vector2 vector2 = vector - position;
			for (float num2 = 0f; num2 < 1f; num2 += 0.2f)
			{
				Vector2 vector3 = Vector2.Lerp(oldPosition + vector2 + new Vector2(0f, gfxOffY), vector, num2);
				Dust obj = Main.dust[Dust.NewDust(vector - Vector2.One * 8f, 16, 16, 27, 0f, -2f)];
				obj.noGravity = true;
				obj.position = vector3;
				obj.velocity = new Vector2(0f, (0f - gravDir) * 2f);
				obj.scale = 1.2f;
				obj.alpha = 200;
			}
		}
	}

	private void ItemCheck_GetMeleeHitbox(Item sItem, Rectangle heldItemFrame, out bool dontAttack, out Rectangle itemRectangle)
	{
		dontAttack = false;
		itemRectangle = new Rectangle((int)itemLocation.X, (int)itemLocation.Y, 32, 32);
		if (!Main.dedServ)
		{
			int num = heldItemFrame.Width;
			int num2 = heldItemFrame.Height;
			switch (sItem.type)
			{
			case 5094:
				num -= 10;
				num2 -= 10;
				break;
			case 5095:
				num -= 10;
				num2 -= 10;
				break;
			case 5096:
				num -= 12;
				num2 -= 12;
				break;
			case 5097:
				num -= 8;
				num2 -= 8;
				break;
			}
			itemRectangle = new Rectangle((int)itemLocation.X, (int)itemLocation.Y, num, num2);
		}
		float adjustedItemScale = GetAdjustedItemScale(sItem);
		itemRectangle.Width = (int)((float)itemRectangle.Width * adjustedItemScale);
		itemRectangle.Height = (int)((float)itemRectangle.Height * adjustedItemScale);
		if (direction == -1)
		{
			itemRectangle.X -= itemRectangle.Width;
		}
		if (gravDir == 1f)
		{
			itemRectangle.Y -= itemRectangle.Height;
		}
		if (sItem.useStyle == 1)
		{
			if ((double)itemAnimation < (double)itemAnimationMax * 0.333)
			{
				if (direction == -1)
				{
					itemRectangle.X -= (int)((double)itemRectangle.Width * 1.4 - (double)itemRectangle.Width);
				}
				itemRectangle.Width = (int)((double)itemRectangle.Width * 1.4);
				itemRectangle.Y += (int)((double)itemRectangle.Height * 0.5 * (double)gravDir);
				itemRectangle.Height = (int)((double)itemRectangle.Height * 1.1);
			}
			else if (!((double)itemAnimation < (double)itemAnimationMax * 0.666))
			{
				if (direction == 1)
				{
					itemRectangle.X -= (int)((double)itemRectangle.Width * 1.2);
				}
				itemRectangle.Width *= 2;
				itemRectangle.Y -= (int)(((double)itemRectangle.Height * 1.4 - (double)itemRectangle.Height) * (double)gravDir);
				itemRectangle.Height = (int)((double)itemRectangle.Height * 1.4);
			}
		}
		else
		{
			if (sItem.useStyle != 3)
			{
				return;
			}
			if ((double)itemAnimation > (double)itemAnimationMax * 0.666)
			{
				dontAttack = true;
				return;
			}
			if (direction == -1)
			{
				itemRectangle.X -= (int)((double)itemRectangle.Width * 1.4 - (double)itemRectangle.Width);
			}
			itemRectangle.Width = (int)((double)itemRectangle.Width * 1.4);
			itemRectangle.Y += (int)((double)itemRectangle.Height * 0.6);
			itemRectangle.Height = (int)((double)itemRectangle.Height * 0.6);
			if (sItem.type == 946 || sItem.type == 4707)
			{
				itemRectangle.Height += 14;
				itemRectangle.Width -= 10;
				if (direction == -1)
				{
					itemRectangle.X += 10;
				}
			}
		}
	}

	private void ItemCheck_UseDemonHeart(Item sItem)
	{
		if (sItem.type == 3335 && itemAnimation > 0 && !extraAccessory && Main.expertMode && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			extraAccessory = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
	}

	private void ItemCheck_UseMinecartPowerUp(Item sItem)
	{
		if (sItem.type == 5289 && itemAnimation > 0 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			if (!unlockedSuperCart)
			{
				unlockedSuperCart = true;
				NetMessage.SendData(4, -1, -1, null, whoAmI);
			}
			QuickSpawnItem(GetItemSource_OpenItem(5289), 3353);
		}
	}

	private void ItemCheck_UseArtisanLoaf(Item sItem)
	{
		if (sItem.type == 5326 && itemAnimation > 0 && !ateArtisanBread && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			ateArtisanBread = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
	}

	private void ItemCheck_UseTorchGodsFavor(Item sItem)
	{
		if (sItem.type == 5043 && itemAnimation > 0 && !unlockedBiomeTorches && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			unlockedBiomeTorches = true;
			UsingBiomeTorches = true;
			AchievementsHelper.HandleSpecialEvent(this, 24);
			if (Main.netMode == 0)
			{
				NPC nPC = new NPC();
				nPC.SetDefaults(664);
				Main.BestiaryTracker.Kills.RegisterKill(nPC);
			}
			NetMessage.SendData(4, -1, -1, null, whoAmI);
			NetMessage.SendData(51, -1, -1, null, whoAmI, 5f);
		}
	}

	private void ItemCheck_TryDestroyingDrones(Item sItem)
	{
		if (sItem.type == 5451 && ownedProjectileCounts[1020] > 0 && controlUseItem && ItemTimeIsZero && !mouseInterface)
		{
			for (int i = 0; i < 1000; i++)
			{
				Projectile projectile = Main.projectile[i];
				if (projectile.owner == whoAmI && projectile.type == 1020)
				{
					projectile.Kill();
				}
			}
			releaseUseItem = false;
		}
		if (sItem.type != 5738 || ownedProjectileCounts[1105] <= 0 || !controlUseItem || !ItemTimeIsZero || mouseInterface)
		{
			return;
		}
		for (int j = 0; j < 1000; j++)
		{
			Projectile projectile2 = Main.projectile[j];
			if (projectile2.owner == whoAmI && projectile2.type == 1105)
			{
				projectile2.Kill();
			}
		}
		releaseUseItem = false;
	}

	private void ItemCheck_UseManaCrystal(Item sItem)
	{
		if (sItem.type == 109 && itemAnimation > 0 && statManaMax < 200 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			statManaMax += 20;
			statManaMax2 += 20;
			statMana += 20;
			if (Main.myPlayer == whoAmI)
			{
				ManaEffect(20);
			}
			AchievementsHelper.HandleSpecialEvent(this, 1);
		}
	}

	private void ItemCheck_UseLifeFruit(Item sItem)
	{
		if (sItem.type == 1291 && itemAnimation > 0 && statLifeMax >= 400 && statLifeMax < 500 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			statLifeMax += 5;
			statLifeMax2 += 5;
			statLife += 5;
			if (Main.myPlayer == whoAmI)
			{
				HealEffect(5);
			}
			AchievementsHelper.HandleSpecialEvent(this, 2);
		}
	}

	private void ItemCheck_UseLifeCrystal(Item sItem)
	{
		if (sItem.type == 29 && itemAnimation > 0 && statLifeMax < 400 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			statLifeMax += 20;
			statLifeMax2 += 20;
			statLife += 20;
			if (Main.myPlayer == whoAmI)
			{
				HealEffect(20);
			}
			AchievementsHelper.HandleSpecialEvent(this, 0);
		}
	}

	private void ItemCheck_UseCombatBook(Item sItem)
	{
		if (!NPC.combatBookWasUsed && sItem.type == 4382 && itemAnimation > 0 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			if (Main.netMode == 0)
			{
				NPC.combatBookWasUsed = true;
				Main.NewText(Language.GetTextValue("Misc.CombatBookUsed"), 50, byte.MaxValue, 130);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -11f);
			}
		}
		if (!NPC.combatBookVolumeTwoWasUsed && sItem.type == 5336 && itemAnimation > 0 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			if (Main.netMode == 0)
			{
				NPC.combatBookVolumeTwoWasUsed = true;
				Main.NewText(Language.GetTextValue("Misc.CombatBookVolumeTwoUsed"), 50, byte.MaxValue, 130);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -17f);
			}
		}
	}

	private void ItemCheck_UsePetLicenses(Item sItem)
	{
		if (sItem.type == 4829 && itemAnimation > 0)
		{
			LicenseOrExchangePet(sItem, ref NPC.boughtCat, 637, "Misc.LicenseCatUsed", -12);
		}
		if (sItem.type == 4830 && itemAnimation > 0)
		{
			LicenseOrExchangePet(sItem, ref NPC.boughtDog, 638, "Misc.LicenseDogUsed", -13);
		}
		if (sItem.type == 4910 && itemAnimation > 0)
		{
			LicenseOrExchangePet(sItem, ref NPC.boughtBunny, 656, "Misc.LicenseBunnyUsed", -14);
		}
	}

	private void ItemCheck_UsePeddlersSatchel(Item sItem)
	{
		if (!NPC.peddlersSatchelWasUsed && sItem.type == 5343 && itemAnimation > 0 && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			if (Main.netMode == 0)
			{
				NPC.peddlersSatchelWasUsed = true;
				Main.NewText(Language.GetTextValue("Misc.PeddlersSatchelUsed"), 50, byte.MaxValue, 130);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, -18f);
			}
		}
	}

	private void ItemCheck_UseShimmerPermanentItems(Item sItem)
	{
		if (sItem.type == 5337 && itemAnimation > 0 && !usedAegisCrystal && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			usedAegisCrystal = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
		if (sItem.type == 5338 && itemAnimation > 0 && !usedAegisFruit && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			usedAegisFruit = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
		if (sItem.type == 5339 && itemAnimation > 0 && !usedArcaneCrystal && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			usedArcaneCrystal = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
		if (sItem.type == 5340 && itemAnimation > 0 && !usedGalaxyPearl && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			usedGalaxyPearl = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
		if (sItem.type == 5341 && itemAnimation > 0 && !usedGummyWorm && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			usedGummyWorm = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
		if (sItem.type == 5342 && itemAnimation > 0 && !usedAmbrosia && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			usedAmbrosia = true;
			NetMessage.SendData(4, -1, -1, null, whoAmI);
		}
	}

	private void ItemCheck_UsePlayerSoundOverrideAccessory(Item sItem)
	{
		if (ItemTimeIsZero && itemAnimation != 0 && sItem.voiceSlot != 0)
		{
			ApplyItemTime(sItem);
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: false, ParticleOrchestraType.PlayerVoiceOverrideSound, new ParticleOrchestraSettings
			{
				PositionInWorld = base.Center,
				UniqueInfoPiece = sItem.voiceSlot
			}, whoAmI);
		}
	}

	private void LicenseOrExchangePet(Item sItem, ref bool petBoughtFlag, int npcType, string textKeyForLicense, int netMessageData)
	{
		if (ItemTimeIsZero && (!petBoughtFlag || NPC.AnyNPCs(npcType)))
		{
			ApplyItemTime(sItem);
			NPC.UnlockOrExchangePet(ref petBoughtFlag, npcType, textKeyForLicense, netMessageData);
		}
	}

	public void LimitPointToPlayerReachableArea(ref Vector2 pointPosition)
	{
		Rectangle worldRect = Utils.CenteredRectangle(base.Center, Main.MaxWorldViewSize.ToVector2());
		worldRect = WorldUtils.ClampToWorldBorders(worldRect);
		Vector2 vector = worldRect.Center.ToVector2();
		Vector2 vector2 = pointPosition - vector;
		float num = Math.Abs(vector2.X);
		float num2 = Math.Abs(vector2.Y);
		float num3 = 1f;
		float num4 = (float)worldRect.Width / 2f;
		if (num > num4)
		{
			float num5 = num4 / num;
			if (num3 > num5)
			{
				num3 = num5;
			}
		}
		float num6 = (float)worldRect.Height / 2f;
		if (num2 > num6)
		{
			float num7 = num6 / num2;
			if (num3 > num7)
			{
				num3 = num7;
			}
		}
		Vector2 vector3 = vector2 * num3;
		pointPosition = vector + vector3;
	}

	private void ItemCheck_UseTeleportRod(Item sItem)
	{
		if (Main.myPlayer != whoAmI || (sItem.type != 1326 && sItem.type != 5335) || itemAnimation <= 0 || !ItemTimeIsZero)
		{
			return;
		}
		ApplyItemTime(sItem);
		Vector2 pointPosition = default(Vector2);
		pointPosition.X = (float)Main.mouseX + Main.screenPosition.X;
		if (gravDir == 1f)
		{
			pointPosition.Y = (float)Main.mouseY + Main.screenPosition.Y - (float)height;
		}
		else
		{
			pointPosition.Y = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY;
		}
		pointPosition.X -= width / 2;
		LimitPointToPlayerReachableArea(ref pointPosition);
		bool flag = pointPosition.X > 50f && pointPosition.X < (float)(Main.maxTilesX * 16 - 50) && pointPosition.Y > 50f && pointPosition.Y < (float)(Main.maxTilesY * 16 - 50);
		Point point = base.Center.ToTileCoordinates();
		Point point2 = (pointPosition + new Vector2(width / 2, height / 2)).ToTileCoordinates();
		if (Collision.AnyWallOfTypeOnLine(point.X, point.Y, point2.X, point2.Y, 350))
		{
			flag = false;
		}
		if (!flag)
		{
			return;
		}
		int num = (int)(pointPosition.X / 16f);
		int num2 = (int)(pointPosition.Y / 16f);
		if ((Main.tile[num, num2].wall == 87 && !NPC.downedPlantBoss && (Main.remixWorld || (double)num2 > Main.worldSurface)) || Collision.SolidCollision(pointPosition, width, height))
		{
			return;
		}
		Teleport(pointPosition, 1);
		NetMessage.SendData(65, -1, -1, null, 0, whoAmI, pointPosition.X, pointPosition.Y, 1);
		if (sItem.type != 1326)
		{
			return;
		}
		if (chaosState)
		{
			statLife -= statLifeMax2 / 7;
			PlayerDeathReason damageSource = PlayerDeathReason.ByOther(13);
			if (Main.rand.Next(2) == 0)
			{
				damageSource = PlayerDeathReason.ByOther(Male ? 14 : 15);
			}
			if (statLife <= 0)
			{
				KillMe(damageSource, 1.0, 0);
			}
			lifeRegenCount = 0;
			lifeRegenTime = 0f;
		}
		AddBuff(88, 360);
	}

	private bool IsAHammerTarget(Tile targetTile)
	{
		if (!Main.tileHammer[targetTile.type])
		{
			return IsTilePoundable(targetTile);
		}
		return true;
	}

	private bool IsTilePoundable(Tile targetTile)
	{
		if (Main.tileHammer[targetTile.type])
		{
			return false;
		}
		if (!Main.tileSolid[targetTile.type] && targetTile.type != 314 && targetTile.type != 424 && targetTile.type != 442 && targetTile.type != 351 && targetTile.type != 470)
		{
			return TileID.Sets.IsLivingFire[targetTile.type];
		}
		return true;
	}

	private void UseShovel(Player user, Item item, int sX, int sY)
	{
		for (int i = sX - 1; i <= sX + 1; i++)
		{
			for (int j = sY - 1; j <= sY + 1; j++)
			{
				DamageTileWithShovel(user, item, i, j);
			}
		}
		itemTime = (int)((float)item.useTime * pickSpeed);
	}

	private void DamageTileWithShovel(Player user, Item item, int x, int y)
	{
		Tile tileSafely = Framing.GetTileSafely(x, y);
		if (TileID.Sets.CanBeDugByShovel[tileSafely.type])
		{
			int pickPower = 30;
			if (tileSafely.active() && (TileID.Sets.Conversion.Grass[tileSafely.type] || TileID.Sets.Conversion.JungleGrass[tileSafely.type] || tileSafely.type == 70 || tileSafely.type == 633))
			{
				PickTile(x, y, 100);
			}
			PickTile(x, y, pickPower);
		}
	}

	private void ItemCheck_UseMiningTools(Item sItem)
	{
		SpecialToolUsageSettings specialToolUsageSettings = default(SpecialToolUsageSettings);
		if (sItem.type == 4711)
		{
			specialToolUsageSettings = new SpecialToolUsageSettings
			{
				IsAValidTool = true,
				UsageAction = UseShovel
			};
		}
		if (sItem.pick <= 0 && sItem.axe <= 0 && sItem.hammer <= 0 && !specialToolUsageSettings.IsAValidTool)
		{
			return;
		}
		bool flag = IsTargetTileInItemRange(sItem);
		if (noBuilding)
		{
			flag = false;
		}
		if (flag && specialToolUsageSettings.UsageCondition != null)
		{
			flag = specialToolUsageSettings.UsageCondition(this, sItem, tileTargetX, tileTargetY);
		}
		if (toolTime == 0 && itemAnimation > 0 && controlUseItem)
		{
			Tile tile = Main.tile[tileTargetX, tileTargetY];
			if (!tile.active() || !IsAHammerTarget(tile))
			{
				poundRelease = false;
			}
		}
		if (!flag)
		{
			return;
		}
		if (!Main.GamepadDisableCursorItemIcon)
		{
			cursorItemIconEnabled = true;
			Main.ItemIconCacheUpdate(sItem.type);
		}
		bool canHitWalls = false;
		if (toolTime == 0 && itemAnimation > 0 && controlUseItem)
		{
			if (specialToolUsageSettings.UsageAction != null)
			{
				specialToolUsageSettings.UsageAction(this, sItem, tileTargetX, tileTargetY);
				return;
			}
			ItemCheck_UseMiningTools_ActuallyUseMiningTool(sItem, out canHitWalls, tileTargetX, tileTargetY);
		}
		if (releaseUseItem)
		{
			poundRelease = true;
		}
		if (toolTime == 0 && itemAnimation > 0 && controlUseItem && canHitWalls)
		{
			ItemCheck_UseMiningTools_TryFindingWallToHammer(out var wX, out var wY);
			ItemCheck_UseMiningTools_TryHittingWall(sItem, wX, wY);
		}
	}

	private void ItemCheck_UseMiningTools_ActuallyUseMiningTool(Item sItem, out bool canHitWalls, int x, int y)
	{
		int num = -1;
		int num2 = 0;
		canHitWalls = true;
		Tile tile = Main.tile[x, y];
		if (!tile.active())
		{
			return;
		}
		if ((sItem.pick > 0 && !Main.tileAxe[tile.type] && !Main.tileHammer[tile.type]) || (sItem.axe > 0 && Main.tileAxe[tile.type]) || (sItem.hammer > 0 && Main.tileHammer[tile.type]))
		{
			canHitWalls = false;
		}
		num = hitTile.HitObject(x, y, 1);
		if (Main.tileNoFail[tile.type])
		{
			num2 = 100;
		}
		if (Main.tileHammer[tile.type])
		{
			canHitWalls = false;
			if (sItem.hammer > 0)
			{
				num2 += sItem.hammer;
				if (!WorldGen.CanKillTile(x, y))
				{
					num2 = 0;
				}
				if (tile.type == 26 && (sItem.hammer < 80 || !Main.hardMode))
				{
					num2 = 0;
					Hurt(PlayerDeathReason.ByOther(4), statLife / 2, -direction);
				}
				AchievementsHelper.CurrentlyMining = true;
				if (hitTile.AddDamage(num, num2) >= 100)
				{
					ClearMiningCacheAt(x, y, 1);
					WorldGen.KillTile(x, y);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, x, y);
					}
				}
				else
				{
					WorldGen.KillTile(x, y, fail: true);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, x, y, 1f);
					}
				}
				if (num2 != 0)
				{
					hitTile.Prune();
				}
				ApplyItemTime(sItem);
				AchievementsHelper.CurrentlyMining = false;
			}
		}
		else if (Main.tileAxe[tile.type])
		{
			num2 = ((tile.type != 80) ? (num2 + (int)((float)sItem.axe * 1.2f)) : (num2 + (int)((float)(sItem.axe * 3) * 1.2f)));
			if (Main.getGoodWorld)
			{
				num2 = (int)((double)num2 * 1.3);
			}
			if (sItem.axe > 0)
			{
				IntentionGuesser.Track(this, x, y, GuessedPlayerIntention.HarvestTrees);
				AchievementsHelper.CurrentlyMining = true;
				if (!WorldGen.CanKillTile(x, y))
				{
					num2 = 0;
				}
				if (Main.dontStarveWorld && Main.myPlayer == whoAmI && num2 > 0 && tile.type == 80)
				{
					Hurt(PlayerDeathReason.ByOther(3), Main.DamageVar(6f, 0f - luck), 0, pvp: false, quiet: false, Crit: false, ImmunityCooldownID.TileContactDamage);
				}
				if (hitTile.AddDamage(num, num2) >= 100)
				{
					if (whoAmI == Main.myPlayer && sItem.type == 5095 && (TileID.Sets.IsATreeTrunk[tile.type] || tile.type == 323 || tile.type == 80))
					{
						LucyAxeMessage.MessageSource source = LucyAxeMessage.MessageSource.ChoppedTree;
						if (TileID.Sets.CountsAsGemTree[tile.type])
						{
							source = LucyAxeMessage.MessageSource.ChoppedGemTree;
						}
						if (tile.type == 80)
						{
							source = LucyAxeMessage.MessageSource.ChoppedCactus;
							LucyAxeMessage.TryCreatingMessageWithCooldown(source, base.Top, new Vector2(direction * 7, -7f), 420);
						}
						else
						{
							LucyAxeMessage.Create(source, base.Top, new Vector2(direction * 7, -7f));
						}
					}
					ClearMiningCacheAt(x, y, 1);
					bool flag = IsBottomOfTreeTrunkNoRoots(x, y);
					WorldGen.KillTile(x, y);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, x, y);
					}
					if (sItem.type == 5295 && flag)
					{
						TryReplantingTree();
					}
					IntentionGuesser.AllowTracking();
				}
				else
				{
					WorldGen.KillTile(x, y, fail: true);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 0, x, y, 1f);
					}
				}
				if (num2 != 0)
				{
					hitTile.Prune();
				}
				ApplyItemTime(sItem);
				AchievementsHelper.CurrentlyMining = false;
			}
		}
		else if (sItem.pick > 0)
		{
			IntentionGuesser.Track(this, x, y, GuessedPlayerIntention.HarvestTreasure);
			PickTile(x, y, sItem.pick);
		}
		if (sItem.pick > 0)
		{
			itemTime = (int)((float)sItem.useTime * pickSpeed);
		}
		ItemCheck_UseMiningTools_TryPoundingTile(sItem, num, ref canHitWalls, x, y);
	}

	private bool IsBottomOfTreeTrunkNoRoots(int x, int y)
	{
		Tile tile = Main.tile[x, y];
		if (!tile.active())
		{
			return false;
		}
		if (!TileID.Sets.IsATreeTrunk[tile.type] && tile.type != 323)
		{
			return false;
		}
		short frameX = tile.frameX;
		short frameY = tile.frameY;
		ushort type = tile.type;
		if (type != 323 && frameY >= 132 && frameY <= 176 && (frameX == 22 || frameX == 44))
		{
			return false;
		}
		return true;
	}

	private void TryReplantingTree()
	{
		ushort type = 20;
		int style = 0;
		if (!TileObject.CanPlace(tileTargetX, tileTargetY, type, style, direction, out var objectData))
		{
			return;
		}
		bool num = TileObject.Place(objectData);
		WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
		if (num)
		{
			TileObjectData.CallPostPlacementPlayerHook(tileTargetX, tileTargetY, type, style, direction, objectData.alternate, objectData);
			if (Main.netMode == 1)
			{
				NetMessage.SendObjectPlacement(-1, tileTargetX, tileTargetY, objectData.type, objectData.style, objectData.alternate, objectData.random, direction);
			}
		}
	}

	private void TryReplantingHerbs(int herbStyle)
	{
		if (Main.tile[tileTargetX, tileTargetY + 1].active() && (Main.tile[tileTargetX, tileTargetY + 1].type == 78 || Main.tile[tileTargetX, tileTargetY + 1].type == 380 || Main.tile[tileTargetX, tileTargetY + 1].type == 579) && WorldGen.PlaceTile(tileTargetX, tileTargetY, 82, mute: false, forced: false, whoAmI, herbStyle))
		{
			NetMessage.SendData(17, -1, -1, null, 1, tileTargetX, tileTargetY, 82f, herbStyle);
		}
	}

	private static void ItemCheck_UseMiningTools_TryFindingWallToHammer(out int wX, out int wY)
	{
		wX = tileTargetX;
		wY = tileTargetY;
		bool flag = true;
		if (Main.tile[wX, wY].wall > 0)
		{
			if (!Main.wallHouse[Main.tile[wX, wY].wall])
			{
				for (int i = wX - 1; i < wX + 2; i++)
				{
					for (int j = wY - 1; j < wY + 2; j++)
					{
						if (Main.tile[i, j].wall != Main.tile[wX, wY].wall)
						{
							flag = false;
							break;
						}
					}
				}
			}
			else
			{
				flag = false;
			}
		}
		if (!flag || Main.tile[wX, wY].active())
		{
			return;
		}
		int num = -1;
		if ((double)(((float)Main.mouseX + Main.screenPosition.X) / 16f) < Math.Round(((float)Main.mouseX + Main.screenPosition.X) / 16f))
		{
			num = 0;
		}
		int num2 = -1;
		if ((double)(((float)Main.mouseY + Main.screenPosition.Y) / 16f) < Math.Round(((float)Main.mouseY + Main.screenPosition.Y) / 16f))
		{
			num2 = 0;
		}
		for (int k = tileTargetX + num; k <= tileTargetX + num + 1; k++)
		{
			for (int l = tileTargetY + num2; l <= tileTargetY + num2 + 1; l++)
			{
				if (!flag)
				{
					continue;
				}
				wX = k;
				wY = l;
				if (Main.tile[wX, wY].wall <= 0)
				{
					continue;
				}
				if (!Main.wallHouse[Main.tile[wX, wY].wall])
				{
					for (int m = wX - 1; m < wX + 2; m++)
					{
						for (int n = wY - 1; n < wY + 2; n++)
						{
							if (Main.tile[m, n].wall != Main.tile[wX, wY].wall)
							{
								flag = false;
								break;
							}
						}
					}
				}
				else
				{
					flag = false;
				}
			}
		}
	}

	private void ItemCheck_UseMiningTools_TryHittingWall(Item sItem, int wX, int wY)
	{
		if (Main.tile[wX, wY].wall > 0 && (!Main.tile[wX, wY].active() || wX != tileTargetX || wY != tileTargetY || (!Main.tileHammer[Main.tile[wX, wY].type] && !poundRelease)) && toolTime == 0 && itemAnimation > 0 && controlUseItem && sItem.hammer > 0 && CanPlayerSmashWall(wX, wY))
		{
			int damage = (int)((float)sItem.hammer * 1.5f);
			PickWall(wX, wY, damage);
			itemTime = sItem.useTime / 2;
		}
	}

	public static bool CanPlayerSmashWall(int X, int Y)
	{
		if (Main.tile[X, Y].wall == 350)
		{
			return false;
		}
		bool result = true;
		if (!Main.wallHouse[Main.tile[X, Y].wall])
		{
			result = false;
			for (int i = X - 1; i < X + 2; i++)
			{
				for (int j = Y - 1; j < Y + 2; j++)
				{
					if (Main.tile[i, j].wall == 0 || Main.wallHouse[Main.tile[i, j].wall])
					{
						result = true;
						break;
					}
				}
			}
		}
		return result;
	}

	public void PickWall(int x, int y, int damage)
	{
		int tileId = hitTile.HitObject(x, y, 2);
		if (hitTile.AddDamage(tileId, damage) >= 100)
		{
			hitTile.Clear(tileId);
			ClearMiningCacheAt(x, y, 2);
			WorldGen.KillWall(x, y);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 2, x, y);
			}
		}
		else
		{
			WorldGen.KillWall(x, y, fail: true);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 2, x, y, 1f);
			}
		}
		if (damage != 0)
		{
			hitTile.Prune();
		}
	}

	private void ItemCheck_UseMiningTools_TryPoundingTile(Item sItem, int tileHitId, ref bool hitWall, int x, int y)
	{
		if (!poundRelease)
		{
			return;
		}
		Tile tile = Main.tile[x, y];
		if (sItem.hammer <= 0 || !tile.active())
		{
			poundRelease = false;
			return;
		}
		if (!IsTilePoundable(tile))
		{
			poundRelease = false;
			return;
		}
		hitWall = false;
		ApplyItemTime(sItem);
		int damageAmount = 100;
		if (WorldGen.IsLockedDoor(x, y - 1) || WorldGen.IsLockedDoor(x, y + 1))
		{
			damageAmount = 0;
		}
		if (hitTile.AddDamage(tileHitId, damageAmount) < 100)
		{
			WorldGen.KillTile(x, y, fail: true, effectOnly: true);
			SoundEngine.PlaySound(0, x * 16, y * 16);
			return;
		}
		ClearMiningCacheAt(x, y, 1);
		if (!poundRelease)
		{
			return;
		}
		if (Main.tile[x, y].type == 470)
		{
			TEDisplayDoll.TryChangePose(x, y);
		}
		else if (TileID.Sets.Platforms[Main.tile[x, y].type])
		{
			if (tile.halfBrick())
			{
				WorldGen.PoundTile(x, y);
				if (Main.netMode == 1)
				{
					NetMessage.SendData(17, -1, -1, null, 7, x, y, 1f);
				}
			}
			else
			{
				int num = 1;
				int slope = 2;
				if (TileID.Sets.Platforms[Main.tile[x + 1, y - 1].type] || TileID.Sets.Platforms[Main.tile[x - 1, y + 1].type] || (WorldGen.SolidTile(x + 1, y) && !WorldGen.SolidTile(x - 1, y)))
				{
					num = 2;
					slope = 1;
				}
				if (Main.tile[x, y].slope() == 0)
				{
					WorldGen.SlopeTile(x, y, num);
					int num2 = Main.tile[x, y].slope();
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 14, x, y, num2);
					}
				}
				else if (Main.tile[x, y].slope() == num)
				{
					WorldGen.SlopeTile(x, y, slope);
					int num3 = Main.tile[x, y].slope();
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 14, x, y, num3);
					}
				}
				else if (WorldGen.CanPoundTile(x, y))
				{
					Main.tile[x, y].slope(0);
					WorldGen.PoundTile(x, y);
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 23, x, y);
					}
				}
			}
		}
		else if (Main.tile[x, y].type == 314)
		{
			if (Minecart.FrameTrack(x, y, pound: true) && Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 15, x, y, 1f);
			}
		}
		else if (Main.tile[x, y].type == 137)
		{
			int num4 = 0;
			switch (Main.tile[x, y].frameY / 18)
			{
			case 0:
			case 1:
			case 2:
			case 5:
				switch (Main.tile[x, y].frameX / 18)
				{
				case 0:
					num4 = 2;
					break;
				case 1:
					num4 = 3;
					break;
				case 2:
					num4 = 4;
					break;
				case 3:
					num4 = 5;
					break;
				case 4:
					num4 = 1;
					break;
				case 5:
					num4 = 0;
					break;
				}
				break;
			case 3:
			case 4:
				switch (Main.tile[x, y].frameX / 18)
				{
				case 0:
				case 1:
					num4 = 3;
					break;
				case 3:
					num4 = 2;
					break;
				case 2:
					num4 = 4;
					break;
				case 4:
					num4 = 0;
					break;
				}
				break;
			}
			Main.tile[x, y].frameX = (short)(num4 * 18);
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, x, y);
			}
		}
		else if (Main.tile[x, y].type == 424)
		{
			if (Main.tile[x, y].frameX == 0)
			{
				Main.tile[x, y].frameX = 18;
			}
			else if (Main.tile[x, y].frameX == 18)
			{
				Main.tile[x, y].frameX = 36;
			}
			else
			{
				Main.tile[x, y].frameX = 0;
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, x, y);
			}
		}
		else if (Main.tile[x, y].type == 442)
		{
			Tile tile2 = Main.tile[x, y - 1];
			Tile tile3 = Main.tile[x, y + 1];
			Tile tile4 = Main.tile[x - 1, y];
			Tile tile5 = Main.tile[x + 1, y];
			Tile tile6 = Main.tile[x - 1, y + 1];
			Tile tile7 = Main.tile[x + 1, y + 1];
			Tile tile8 = Main.tile[x - 1, y - 1];
			Tile tile9 = Main.tile[x + 1, y - 1];
			int num5 = -1;
			int num6 = -1;
			int num7 = -1;
			int num8 = -1;
			int tree = -1;
			int tree2 = -1;
			int tree3 = -1;
			int tree4 = -1;
			if (tile2 != null && tile2.nactive() && !tile2.bottomSlope())
			{
				num6 = tile2.type;
			}
			if (tile3 != null && tile3.nactive() && !tile3.halfBrick() && !tile3.topSlope())
			{
				num5 = tile3.type;
			}
			if (tile4 != null && tile4.nactive() && (tile4.slope() == 0 || tile4.slope() % 2 != 1))
			{
				num7 = tile4.type;
			}
			if (tile5 != null && tile5.nactive() && (tile5.slope() == 0 || tile5.slope() % 2 != 0))
			{
				num8 = tile5.type;
			}
			if (tile6 != null && tile6.nactive())
			{
				tree = tile6.type;
			}
			if (tile7 != null && tile7.nactive())
			{
				tree2 = tile7.type;
			}
			if (tile8 != null && tile8.nactive())
			{
				tree3 = tile8.type;
			}
			if (tile9 != null && tile9.nactive())
			{
				tree4 = tile9.type;
			}
			bool flag = false;
			bool flag2 = false;
			bool flag3 = false;
			bool flag4 = false;
			if (num5 >= 0 && Main.tileSolid[num5] && (!Main.tileNoAttach[num5] || TileID.Sets.Platforms[num5]) && (tile3.bottomSlope() || tile3.slope() == 0) && !tile3.halfBrick())
			{
				flag4 = true;
			}
			if (num6 >= 0 && Main.tileSolid[num6] && (!Main.tileNoAttach[num6] || (TileID.Sets.Platforms[num6] && tile2.halfBrick())) && (tile2.topSlope() || tile2.slope() == 0 || tile2.halfBrick()))
			{
				flag = true;
			}
			if ((num7 >= 0 && Main.tileSolid[num7] && !Main.tileNoAttach[num7] && (tile4.leftSlope() || tile4.slope() == 0) && !tile4.halfBrick()) || (num7 >= 0 && TileID.Sets.IsBeam[num7]) || (WorldGen.IsTreeType(num7) && WorldGen.IsTreeType(tree3) && WorldGen.IsTreeType(tree)))
			{
				flag2 = true;
			}
			if ((num8 >= 0 && Main.tileSolid[num8] && !Main.tileNoAttach[num8] && (tile5.rightSlope() || tile5.slope() == 0) && !tile5.halfBrick()) || (num8 >= 0 && TileID.Sets.IsBeam[num8]) || (WorldGen.IsTreeType(num8) && WorldGen.IsTreeType(tree4) && WorldGen.IsTreeType(tree2)))
			{
				flag3 = true;
			}
			int num9 = Main.tile[x, y].frameX / 22;
			short num10 = -2;
			switch (num9)
			{
			case 0:
				num10 = (short)((!flag2) ? (flag ? 1 : ((!flag3) ? (-1) : 3)) : 2);
				break;
			case 2:
				num10 = (short)(flag ? 1 : ((!flag3) ? ((!flag4) ? (-1) : 0) : 3));
				break;
			case 1:
				num10 = (short)((!flag3) ? ((!flag4) ? ((!flag2) ? (-1) : 2) : 0) : 3);
				break;
			case 3:
				num10 = (short)((!flag4) ? ((!flag2) ? (flag ? 1 : (-1)) : 2) : 0);
				break;
			}
			if (num10 != -1)
			{
				if (num10 == -2)
				{
					num10 = 0;
				}
				Main.tile[x, y].frameX = (short)(22 * num10);
				if (Main.netMode == 1)
				{
					NetMessage.SendTileSquare(-1, x, y);
				}
			}
		}
		else if ((Main.tile[x, y].halfBrick() || Main.tile[x, y].slope() != 0) && !Main.tileSolidTop[Main.tile[x, y].type])
		{
			int num11 = 1;
			int num12 = 1;
			int num13 = 2;
			if ((WorldGen.SolidTile(x + 1, y) || Main.tile[x + 1, y].slope() == 1 || Main.tile[x + 1, y].slope() == 3) && !WorldGen.SolidTile(x - 1, y))
			{
				num12 = 2;
				num13 = 1;
			}
			if (WorldGen.SolidTile(x, y - 1) && !WorldGen.SolidTile(x, y + 1))
			{
				num11 = -1;
			}
			if (num11 == 1)
			{
				if (Main.tile[x, y].slope() == 0)
				{
					WorldGen.SlopeTile(x, y, num12);
				}
				else if (Main.tile[x, y].slope() == num12)
				{
					WorldGen.SlopeTile(x, y, num13);
				}
				else if (Main.tile[x, y].slope() == num13)
				{
					WorldGen.SlopeTile(x, y, num12 + 2);
				}
				else if (Main.tile[x, y].slope() == num12 + 2)
				{
					WorldGen.SlopeTile(x, y, num13 + 2);
				}
				else
				{
					WorldGen.SlopeTile(x, y);
				}
			}
			else if (Main.tile[x, y].slope() == 0)
			{
				WorldGen.SlopeTile(x, y, num12 + 2);
			}
			else if (Main.tile[x, y].slope() == num12 + 2)
			{
				WorldGen.SlopeTile(x, y, num13 + 2);
			}
			else if (Main.tile[x, y].slope() == num13 + 2)
			{
				WorldGen.SlopeTile(x, y, num12);
			}
			else if (Main.tile[x, y].slope() == num12)
			{
				WorldGen.SlopeTile(x, y, num13);
			}
			else
			{
				WorldGen.SlopeTile(x, y);
			}
			int num14 = Main.tile[x, y].slope();
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 14, x, y, num14);
			}
		}
		else
		{
			WorldGen.PoundTile(x, y);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 7, x, y, 1f);
			}
		}
		poundRelease = false;
	}

	public bool IsTargetTileInItemRange(Item sItem)
	{
		return IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost);
	}

	private void ItemCheck_UseBuckets(Item sItem)
	{
		if (((sItem.type < 205 || sItem.type > 207) && sItem.type != 1128 && sItem.type != 3031 && sItem.type != 3032 && sItem.type != 4820 && sItem.type != 4872 && sItem.type != 5302 && sItem.type != 5303 && sItem.type != 5304 && sItem.type != 5364) || noBuilding || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost))
		{
			return;
		}
		if (!Main.GamepadDisableCursorItemIcon)
		{
			cursorItemIconEnabled = true;
			Main.ItemIconCacheUpdate(sItem.type);
		}
		if (!ItemTimeIsZero || itemAnimation <= 0 || !controlUseItem)
		{
			return;
		}
		if ((sItem.type == 205 && !Main.tile[tileTargetX, tileTargetY].shimmer()) || (sItem.type == 3032 && Main.tile[tileTargetX, tileTargetY].liquidType() == 0) || (sItem.type == 3032 && Main.tile[tileTargetX, tileTargetY].shimmer()) || (sItem.type == 4872 && Main.tile[tileTargetX, tileTargetY].lava()) || (sItem.type == 5303 && Main.tile[tileTargetX, tileTargetY].honey()) || sItem.type == 5304)
		{
			int num = Main.tile[tileTargetX, tileTargetY].liquidType();
			int num2 = 0;
			for (int i = tileTargetX - 1; i <= tileTargetX + 1; i++)
			{
				for (int j = tileTargetY - 1; j <= tileTargetY + 1; j++)
				{
					if (Main.tile[i, j].liquidType() == num)
					{
						num2 += Main.tile[i, j].liquid;
					}
				}
			}
			if (Main.tile[tileTargetX, tileTargetY].liquid <= 0 || (num2 <= 100 && sItem.type != 3032 && sItem.type != 4872 && sItem.type != 5303 && sItem.type != 5304))
			{
				return;
			}
			int liquidType = Main.tile[tileTargetX, tileTargetY].liquidType();
			if (sItem.type != 3032 && sItem.type != 4872 && sItem.type != 5303 && sItem.type != 5304)
			{
				if (Main.tile[tileTargetX, tileTargetY].honey() && sItem.type == 205)
				{
					sItem.stack--;
					PutItemInInventoryFromItemUsage(1128);
				}
				else if (Main.tile[tileTargetX, tileTargetY].lava() && sItem.type == 205)
				{
					sItem.stack--;
					PutItemInInventoryFromItemUsage(207);
				}
				else
				{
					if (Main.tile[tileTargetX, tileTargetY].shimmer() && sItem.type == 205)
					{
						return;
					}
					sItem.stack--;
					PutItemInInventoryFromItemUsage(206);
				}
			}
			SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
			ApplyItemTime(sItem);
			int num3 = Main.tile[tileTargetX, tileTargetY].liquid;
			Main.tile[tileTargetX, tileTargetY].liquid = 0;
			Main.tile[tileTargetX, tileTargetY].lava(lava: false);
			Main.tile[tileTargetX, tileTargetY].honey(honey: false);
			WorldGen.SquareTileFrame(tileTargetX, tileTargetY, resetFrame: false);
			if (Main.netMode == 1)
			{
				NetMessage.sendWater(tileTargetX, tileTargetY);
			}
			else
			{
				Liquid.AddWater(tileTargetX, tileTargetY);
			}
			if (num3 >= 255)
			{
				return;
			}
			for (int k = tileTargetX - 1; k <= tileTargetX + 1; k++)
			{
				for (int l = tileTargetY - 1; l <= tileTargetY + 1; l++)
				{
					if ((k != tileTargetX || l != tileTargetY) && Main.tile[k, l].liquid > 0 && Main.tile[k, l].liquidType() == num)
					{
						int num4 = Main.tile[k, l].liquid;
						if (num4 + num3 > 255)
						{
							num4 = 255 - num3;
						}
						num3 += num4;
						Main.tile[k, l].liquid -= (byte)num4;
						Main.tile[k, l].liquidType(liquidType);
						if (Main.tile[k, l].liquid == 0)
						{
							Main.tile[k, l].lava(lava: false);
							Main.tile[k, l].honey(honey: false);
						}
						WorldGen.SquareTileFrame(k, l, resetFrame: false);
						if (Main.netMode == 1)
						{
							NetMessage.sendWater(k, l);
						}
						else
						{
							Liquid.AddWater(k, l);
						}
					}
				}
			}
		}
		else
		{
			if (Main.tile[tileTargetX, tileTargetY].liquid >= 200 || (Main.tile[tileTargetX, tileTargetY].nactive() && Main.tileSolid[Main.tile[tileTargetX, tileTargetY].type] && !Main.tileSolidTop[Main.tile[tileTargetX, tileTargetY].type] && Main.tile[tileTargetX, tileTargetY].type != 546))
			{
				return;
			}
			if (sItem.type == 207 || sItem.type == 4820)
			{
				if (Main.tile[tileTargetX, tileTargetY].liquid == 0 || Main.tile[tileTargetX, tileTargetY].liquidType() == 1)
				{
					SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
					Main.tile[tileTargetX, tileTargetY].liquidType(1);
					Main.tile[tileTargetX, tileTargetY].liquid = byte.MaxValue;
					WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
					if (sItem.type != 4820)
					{
						sItem.stack--;
						PutItemInInventoryFromItemUsage(205);
					}
					ApplyItemTime(sItem);
					if (Main.netMode == 1)
					{
						NetMessage.sendWater(tileTargetX, tileTargetY);
					}
				}
			}
			else if (sItem.type == 206 || sItem.type == 3031)
			{
				if (Main.tile[tileTargetX, tileTargetY].liquid == 0 || Main.tile[tileTargetX, tileTargetY].liquidType() == 0)
				{
					SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
					Main.tile[tileTargetX, tileTargetY].liquidType(0);
					Main.tile[tileTargetX, tileTargetY].liquid = byte.MaxValue;
					WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
					if (sItem.type != 3031)
					{
						sItem.stack--;
						PutItemInInventoryFromItemUsage(205);
					}
					ApplyItemTime(sItem);
					if (Main.netMode == 1)
					{
						NetMessage.sendWater(tileTargetX, tileTargetY);
					}
				}
			}
			else if (sItem.type == 1128 || sItem.type == 5302)
			{
				if (Main.tile[tileTargetX, tileTargetY].liquid == 0 || Main.tile[tileTargetX, tileTargetY].liquidType() == 2)
				{
					SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
					Main.tile[tileTargetX, tileTargetY].liquidType(2);
					Main.tile[tileTargetX, tileTargetY].liquid = byte.MaxValue;
					WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
					if (sItem.type != 5302)
					{
						sItem.stack--;
						PutItemInInventoryFromItemUsage(205);
					}
					ApplyItemTime(sItem);
					if (Main.netMode == 1)
					{
						NetMessage.sendWater(tileTargetX, tileTargetY);
					}
				}
			}
			else if (sItem.type == 5364 && (Main.tile[tileTargetX, tileTargetY].liquid == 0 || Main.tile[tileTargetX, tileTargetY].liquidType() == 3))
			{
				SoundEngine.PlaySound(19, (int)position.X, (int)position.Y);
				Main.tile[tileTargetX, tileTargetY].liquidType(3);
				Main.tile[tileTargetX, tileTargetY].liquid = byte.MaxValue;
				WorldGen.SquareTileFrame(tileTargetX, tileTargetY);
				ApplyItemTime(sItem);
				if (Main.netMode == 1)
				{
					NetMessage.sendWater(tileTargetX, tileTargetY);
				}
			}
		}
	}

	private void ItemCheck_PlayInstruments(Item sItem)
	{
		Vector2 vector = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
		float num = (float)Main.mouseX + Main.screenPosition.X - vector.X;
		float num2 = (float)Main.mouseY + Main.screenPosition.Y - vector.Y;
		float num3 = (float)Math.Sqrt(num * num + num2 * num2);
		float smallerScaledAxis = Main.Camera.SmallerScaledAxis;
		num3 /= smallerScaledAxis / 2f;
		if (num3 > 1f)
		{
			num3 = 1f;
		}
		musicDist = num3;
		if (itemAnimation > 0 && ItemTimeIsZero && (sItem.type == 508 || sItem.type == 507))
		{
			ApplyItemTime(sItem);
			Vector2 vector2 = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
			float num4 = (float)Main.mouseX + Main.screenPosition.X - vector2.X;
			float num5 = (float)Main.mouseY + Main.screenPosition.Y - vector2.Y;
			float num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
			float smallerScaledAxis2 = Main.Camera.SmallerScaledAxis;
			num6 /= smallerScaledAxis2 / 2f;
			if (num6 > 1f)
			{
				num6 = 1f;
			}
			num6 = num6 * 2f - 1f;
			if (num6 < -1f)
			{
				num6 = -1f;
			}
			if (num6 > 1f)
			{
				num6 = 1f;
			}
			num6 = (float)Math.Round(num6 * (float)musicNotes);
			num6 = (Main.musicPitch = num6 / (float)musicNotes);
			LegacySoundStyle type = SoundID.Item26;
			if (sItem.type == 507)
			{
				type = SoundID.Item35;
			}
			SoundEngine.PlaySound(type, position);
			NetMessage.SendData(58, -1, -1, null, whoAmI, num6);
		}
		if (itemAnimation <= 0 || mouseInterface)
		{
			return;
		}
		if (Main.mouseLeft && Main.mouseLeftRelease)
		{
			if (sItem.type == 1305)
			{
				Vector2 vector3 = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
				float num7 = (float)Main.mouseX + Main.screenPosition.X - vector3.X;
				float num8 = (float)Main.mouseY + Main.screenPosition.Y - vector3.Y;
				float num9 = (float)Math.Sqrt(num7 * num7 + num8 * num8);
				float smallerScaledAxis3 = Main.Camera.SmallerScaledAxis;
				num9 /= smallerScaledAxis3 / 2f;
				if (num9 > 1f)
				{
					num9 = 1f;
				}
				num9 = num9 * 2f - 1f;
				if (num9 < -1f)
				{
					num9 = -1f;
				}
				if (num9 > 1f)
				{
					num9 = 1f;
				}
				num9 = (float)Math.Round(num9 * (float)musicNotes);
				num9 = (Main.musicPitch = num9 / (float)musicNotes);
				SoundEngine.PlaySound(SoundID.Item47, position);
				NetMessage.SendData(58, -1, -1, null, whoAmI, num9);
				AchievementsHelper.NotifyProgressionEvent(37);
			}
			else if (sItem.type == 4057 || sItem.type == 4372)
			{
				Vector2 vector4 = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
				float num10 = (float)Main.mouseX + Main.screenPosition.X - vector4.X;
				float num11 = (float)Main.mouseY + Main.screenPosition.Y - vector4.Y;
				float num12 = (float)Math.Sqrt(num10 * num10 + num11 * num11);
				float smallerScaledAxis4 = Main.Camera.SmallerScaledAxis;
				num12 /= smallerScaledAxis4 / 2f;
				if (num12 > 1f)
				{
					num12 = 1f;
				}
				PlayGuitarChord(num12);
				NetMessage.SendData(58, -1, -1, null, whoAmI, num12);
				AchievementsHelper.NotifyProgressionEvent(37);
			}
		}
		if (sItem.type == 4715 && ((Main.mouseLeft && Main.mouseLeftRelease) | ItemAnimationJustStarted))
		{
			Vector2 vector5 = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
			float num13 = (float)Main.mouseX + Main.screenPosition.X - vector5.X;
			float num14 = (float)Main.mouseY + Main.screenPosition.Y - vector5.Y;
			float num15 = (float)Math.Sqrt(num13 * num13 + num14 * num14);
			float smallerScaledAxis5 = Main.Camera.SmallerScaledAxis;
			num15 /= smallerScaledAxis5 / 2f;
			if (num15 > 1f)
			{
				num15 = 1f;
			}
			PlayGuitarChord(num15);
			NetMessage.SendData(58, -1, -1, null, whoAmI, num15);
			AchievementsHelper.NotifyProgressionEvent(37);
		}
		if (sItem.type != 4673)
		{
			return;
		}
		int num16 = (int)base.Center.X / 16;
		int num17 = (int)base.Center.Y / 16;
		if (WorldGen.InWorld(num16, num17) && Main.tile[num16, num17] != null && Main.tile[num16, num17].type == 486 && ((Main.mouseLeft && Main.mouseLeftRelease) || (Main.mouseRight && Main.mouseRightRelease)))
		{
			Vector2 vector6 = new Vector2(position.X + (float)width * 0.5f, position.Y + (float)height * 0.5f);
			float num18 = (float)Main.mouseX + Main.screenPosition.X - vector6.X;
			float num19 = (float)Main.mouseY + Main.screenPosition.Y - vector6.Y;
			float num20 = (float)Math.Sqrt(num18 * num18 + num19 * num19);
			float smallerScaledAxis6 = Main.Camera.SmallerScaledAxis;
			num20 /= smallerScaledAxis6 / 2f;
			if (num20 > 1f)
			{
				num20 = 1f;
			}
			PlayDrums(num20);
			NetMessage.SendData(58, -1, -1, null, whoAmI, num20);
		}
	}

	private bool GetSparkleGuitarTarget(out List<NPC> validTargets)
	{
		validTargets = new List<NPC>();
		Rectangle value = Utils.CenteredRectangle(base.Center, new Vector2(1000f, 800f));
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (nPC.CanBeChasedBy(this) && nPC.Hitbox.Intersects(value))
			{
				validTargets.Add(nPC);
			}
		}
		if (validTargets.Count == 0)
		{
			return false;
		}
		return true;
	}

	private bool GetZenithTarget(Vector2 searchCenter, float maxDistance, out int npcTargetIndex)
	{
		npcTargetIndex = 0;
		int? num = null;
		float num2 = maxDistance;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			NPC nPC = Main.npc[i];
			if (nPC.CanBeChasedBy(this))
			{
				float num3 = searchCenter.Distance(nPC.Center);
				if (!(num2 <= num3))
				{
					num = i;
					num2 = num3;
				}
			}
		}
		if (!num.HasValue)
		{
			return false;
		}
		npcTargetIndex = num.Value;
		return true;
	}

	public void PlayGuitarChord(float range)
	{
		int num = 6;
		float num2 = 1f / (float)num;
		float pitchOffset = 0f;
		if (RollOnlyBadLuckExtreme(10) == 0)
		{
			pitchOffset = (float)Main.rand.Next(-50, 51) * 0.01f;
		}
		if (range > num2 * 5f)
		{
			SoundEngine.PlaySound(49, base.Center, 1, pitchOffset);
		}
		else if (range > num2 * 4f)
		{
			SoundEngine.PlaySound(48, base.Center, 1, pitchOffset);
		}
		else if (range > num2 * 3f)
		{
			SoundEngine.PlaySound(47, base.Center, 1, pitchOffset);
		}
		else if (range > num2 * 2f)
		{
			SoundEngine.PlaySound(51, base.Center, 1, pitchOffset);
		}
		else if (range > num2 * 1f)
		{
			SoundEngine.PlaySound(52, base.Center, 1, pitchOffset);
		}
		else
		{
			SoundEngine.PlaySound(50, base.Center, 1, pitchOffset);
		}
	}

	public void PlayDrums(float range)
	{
		int num = 10;
		float num2 = 1f / (float)num;
		if (range > num2 * 9f)
		{
			SoundEngine.PlaySound(59, base.Center);
		}
		else if (range > num2 * 8f)
		{
			SoundEngine.PlaySound(58, base.Center);
		}
		else if (range > num2 * 7f)
		{
			SoundEngine.PlaySound(53, base.Center);
		}
		else if (range > num2 * 6f)
		{
			SoundEngine.PlaySound(57, base.Center);
		}
		else if (range > num2 * 5f)
		{
			SoundEngine.PlaySound(62, base.Center);
		}
		else if (range > num2 * 4f)
		{
			SoundEngine.PlaySound(61, base.Center);
		}
		else if (range > num2 * 3f)
		{
			SoundEngine.PlaySound(54, base.Center);
		}
		else if (range > num2 * 2f)
		{
			SoundEngine.PlaySound(56, base.Center);
		}
		else if (range > num2 * 1f)
		{
			SoundEngine.PlaySound(55, base.Center);
		}
		else
		{
			SoundEngine.PlaySound(60, base.Center);
		}
	}

	private void ItemCheck_UseWiringTools(Item sItem)
	{
		if ((sItem.type != 509 && sItem.type != 510 && sItem.type != 849 && sItem.type != 850 && sItem.type != 851 && sItem.type != 3612 && sItem.type != 3620 && sItem.type != 3625) || !IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost + blockRange))
		{
			return;
		}
		if (!Main.GamepadDisableCursorItemIcon)
		{
			cursorItemIconEnabled = true;
			Main.ItemIconCacheUpdate(sItem.type);
		}
		if (!CanDoWireStuffHere(tileTargetX, tileTargetY) || itemAnimation <= 0 || !ItemTimeIsZero || !controlUseItem)
		{
			return;
		}
		int num = tileTargetX;
		int num2 = tileTargetY;
		if (sItem.type == 509)
		{
			int num3 = -1;
			for (int i = 0; i < 58; i++)
			{
				if (inventory[i].stack > 0 && inventory[i].type == 530)
				{
					num3 = i;
					break;
				}
			}
			if (num3 >= 0 && WorldGen.PlaceWire(num, num2))
			{
				inventory[num3].stack--;
				if (inventory[num3].stack <= 0)
				{
					inventory[num3].SetDefaults(0);
				}
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 5, tileTargetX, tileTargetY);
			}
		}
		else if (sItem.type == 850)
		{
			int num4 = -1;
			for (int j = 0; j < 58; j++)
			{
				if (inventory[j].stack > 0 && inventory[j].type == 530)
				{
					num4 = j;
					break;
				}
			}
			if (num4 >= 0 && WorldGen.PlaceWire2(num, num2))
			{
				inventory[num4].stack--;
				if (inventory[num4].stack <= 0)
				{
					inventory[num4].SetDefaults(0);
				}
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 10, tileTargetX, tileTargetY);
			}
		}
		if (sItem.type == 851)
		{
			int num5 = -1;
			for (int k = 0; k < 58; k++)
			{
				if (inventory[k].stack > 0 && inventory[k].type == 530)
				{
					num5 = k;
					break;
				}
			}
			if (num5 >= 0 && WorldGen.PlaceWire3(num, num2))
			{
				inventory[num5].stack--;
				if (inventory[num5].stack <= 0)
				{
					inventory[num5].SetDefaults(0);
				}
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 12, tileTargetX, tileTargetY);
			}
		}
		if (sItem.type == 3612)
		{
			int num6 = -1;
			for (int l = 0; l < 58; l++)
			{
				if (inventory[l].stack > 0 && inventory[l].type == 530)
				{
					num6 = l;
					break;
				}
			}
			if (num6 >= 0 && WorldGen.PlaceWire4(num, num2))
			{
				inventory[num6].stack--;
				if (inventory[num6].stack <= 0)
				{
					inventory[num6].SetDefaults(0);
				}
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 16, tileTargetX, tileTargetY);
			}
		}
		else if (sItem.type == 510)
		{
			if (WorldGen.KillActuator(num, num2))
			{
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 9, tileTargetX, tileTargetY);
			}
			else if (WorldGen.KillWire4(num, num2))
			{
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 17, tileTargetX, tileTargetY);
			}
			else if (WorldGen.KillWire3(num, num2))
			{
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 13, tileTargetX, tileTargetY);
			}
			else if (WorldGen.KillWire2(num, num2))
			{
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 11, tileTargetX, tileTargetY);
			}
			else if (WorldGen.KillWire(num, num2))
			{
				ApplyItemTime(sItem);
				NetMessage.SendData(17, -1, -1, null, 6, tileTargetX, tileTargetY);
			}
		}
		else if (sItem.type == 849 && sItem.stack > 0 && WorldGen.PlaceActuator(num, num2))
		{
			ApplyItemTime(sItem);
			NetMessage.SendData(17, -1, -1, null, 8, tileTargetX, tileTargetY);
		}
		if (sItem.type == 3620)
		{
			Tile tile = Main.tile[num, num2];
			if (tile != null && tile.actuator())
			{
				bool flag = tile.inActive();
				if ((!ActuationRodLock || ActuationRodLockSetting == tile.inActive()) && Wiring.Actuate(num, num2) && flag != tile.inActive())
				{
					ActuationRodLock = true;
					ActuationRodLockSetting = !tile.inActive();
					ApplyItemTime(sItem);
					NetMessage.SendData(17, -1, -1, null, 19, tileTargetX, tileTargetY);
				}
			}
		}
		if (sItem.type == 3625)
		{
			Point point = new Point(tileTargetX, tileTargetY);
			ApplyItemTime(sItem);
			WiresUI.Settings.MultiToolMode toolMode = WiresUI.Settings.ToolMode;
			WiresUI.Settings.ToolMode &= ~WiresUI.Settings.MultiToolMode.Actuator;
			if (Main.netMode == 1)
			{
				NetMessage.SendData(109, -1, -1, null, point.X, point.Y, point.X, point.Y, (int)WiresUI.Settings.ToolMode);
			}
			else
			{
				Wiring.MassWireOperation(point, point, this);
			}
			WiresUI.Settings.ToolMode = toolMode;
		}
	}

	public bool CanDoWireStuffHere(int x, int y)
	{
		if (!WorldGen.InWorld(x, y))
		{
			return false;
		}
		Tile tile = Main.tile[x, y];
		if (tile.wall == 350)
		{
			return false;
		}
		if (!NPC.downedGolemBoss)
		{
			if (Main.dualDungeonsSeed && (double)y > Main.worldSurface && DungeonGenerationStyles.Temple.WallIsInStyle(tile.wall, includeWindows: true))
			{
				return false;
			}
			if (tile.wall == 87)
			{
				return false;
			}
		}
		return true;
	}

	public bool CanShowWireStuffHere(int x, int y)
	{
		if (!WorldGen.InWorld(x, y))
		{
			return false;
		}
		if (!NPC.downedGolemBoss)
		{
			Tile tile = Main.tile[x, y];
			if (Main.dualDungeonsSeed && (double)y > Main.worldSurface && DungeonGenerationStyles.Temple.WallIsInStyle(tile.wall, includeWindows: true))
			{
				return false;
			}
			if (tile.wall == 87)
			{
				return false;
			}
		}
		return true;
	}

	private void ItemCheck_UseLawnMower(Item sItem)
	{
		if (sItem.type == 4049 && IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost + blockRange) && itemAnimation > 0 && ItemTimeIsZero && controlUseItem)
		{
			MowGrassTile(new Point(tileTargetX, tileTargetY).ToWorldCoordinates());
			ApplyItemTime(sItem);
		}
	}

	private void DestroyOldestProximityMinesOverMinesCap(int minesCap)
	{
		_oldestProjCheckList.Clear();
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.owner == whoAmI)
			{
				switch (projectile.type)
				{
				case 135:
				case 138:
				case 141:
				case 144:
				case 778:
				case 782:
				case 786:
				case 789:
				case 792:
				case 795:
				case 798:
				case 801:
					_oldestProjCheckList.Add(projectile);
					break;
				}
			}
		}
		while (_oldestProjCheckList.Count > minesCap)
		{
			Projectile projectile2 = _oldestProjCheckList[0];
			for (int j = 1; j < _oldestProjCheckList.Count; j++)
			{
				if (_oldestProjCheckList[j].timeLeft < projectile2.timeLeft)
				{
					projectile2 = _oldestProjCheckList[j];
				}
			}
			projectile2.Kill();
			_oldestProjCheckList.Remove(projectile2);
		}
		_oldestProjCheckList.Clear();
	}

	public void SilentlyShootItem(Item sItem)
	{
		ItemCheck_Shoot(whoAmI, sItem, 0, withAudioVisualFeedback: false);
	}

	private void ItemCheck_Shoot(int i, Item sItem, int weaponDamage, bool withAudioVisualFeedback = true)
	{
		int projToShoot = sItem.shoot;
		float speed = sItem.shootSpeed;
		int damage = sItem.damage;
		if (sItem.melee && !ProjectileID.Sets.NoMeleeSpeedVelocityScaling[projToShoot])
		{
			speed /= meleeSpeed;
		}
		bool canShoot = false;
		int Damage = weaponDamage;
		float KnockBack = sItem.knockBack;
		int usedAmmoItemId = 0;
		if (sItem.useAmmo > 0)
		{
			PickAmmo(sItem, ref projToShoot, ref speed, ref canShoot, ref Damage, ref KnockBack, out usedAmmoItemId, ItemID.Sets.gunProj[sItem.type]);
		}
		else
		{
			canShoot = true;
		}
		if (ItemID.Sets.gunProj[sItem.type])
		{
			KnockBack = sItem.knockBack;
			Damage = weaponDamage;
			speed = sItem.shootSpeed;
		}
		if (ProjectileID.Sets.IsAPhaseblade[sItem.shoot] && sItem.type != 671)
		{
			KnockBack *= 1.25f;
			switch (sItem.shoot)
			{
			default:
				Damage = (int)((double)Damage * 1.25);
				break;
			case 1065:
			case 1066:
			case 1067:
			case 1068:
			case 1069:
			case 1070:
			case 1072:
			case 1076:
				Damage = (int)((double)Damage * 1.5);
				break;
			}
		}
		if (sItem.IsACoin)
		{
			canShoot = false;
		}
		if (sItem.type == 1254 && projToShoot == 14)
		{
			projToShoot = 242;
		}
		if (sItem.type == 1255 && projToShoot == 14)
		{
			projToShoot = 242;
		}
		if (sItem.type == 1265 && projToShoot == 14)
		{
			projToShoot = 242;
		}
		if (sItem.type == 3542)
		{
			if (Main.rand.Next(100) < 20)
			{
				projToShoot++;
				Damage *= 3;
			}
			else
			{
				speed -= 1f;
			}
		}
		if (sItem.type == 1928)
		{
			Damage = (int)((float)Damage * 1f);
		}
		if (sItem.type == 3063)
		{
			Damage = (int)((float)Damage * 1.25f);
		}
		if (sItem.type == 1306)
		{
			Damage = (int)((double)Damage * 0.67);
		}
		if (sItem.type == 1227)
		{
			Damage = (int)((double)Damage * 0.7);
		}
		if (!canShoot)
		{
			return;
		}
		KnockBack = GetWeaponKnockback(sItem, KnockBack);
		IEntitySource projectileSource_Item_WithPotentialAmmo = GetProjectileSource_Item_WithPotentialAmmo(sItem, usedAmmoItemId);
		if (projToShoot == 228)
		{
			KnockBack = 0f;
		}
		if (projToShoot == 1 && sItem.type == 120)
		{
			projToShoot = 2;
		}
		if (sItem.type == 682)
		{
			projToShoot = 117;
		}
		if (sItem.type == 725)
		{
			projToShoot = 120;
		}
		if (sItem.type == 2796)
		{
			projToShoot = 442;
		}
		if (sItem.type == 2223)
		{
			projToShoot = 357;
		}
		if (sItem.type == 5117)
		{
			projToShoot = 968;
		}
		if (sItem.fishingPole > 0 && overrideFishingBobber > -1)
		{
			projToShoot = overrideFishingBobber;
		}
		if (withAudioVisualFeedback)
		{
			ApplyItemTime(sItem);
		}
		Vector2 mountedCenter = MountedCenter;
		Vector2 pointPosition = RotatedRelativePoint(mountedCenter);
		bool flag = true;
		int type = sItem.type;
		if (type == 723 || type == 3611)
		{
			flag = false;
		}
		Vector2 value = Vector2.UnitX.RotatedBy(fullRotation);
		Vector2 vector = Main.MouseWorld - pointPosition;
		Vector2 v = itemRotation.ToRotationVector2() * direction;
		if (sItem.type == 3852 && !ItemAnimationJustStarted)
		{
			vector = (v.ToRotation() + fullRotation).ToRotationVector2();
		}
		if (vector != Vector2.Zero)
		{
			vector.Normalize();
		}
		float num = Vector2.Dot(value, vector);
		if (flag)
		{
			if (num > 0f)
			{
				ChangeDir(1);
			}
			else
			{
				ChangeDir(-1);
			}
		}
		if (sItem.type == 3094 || sItem.type == 3378 || sItem.type == 3543)
		{
			pointPosition.Y = position.Y + (float)(height / 3);
		}
		if (sItem.type == 5117)
		{
			pointPosition.Y = position.Y + (float)(height / 3);
		}
		if (sItem.type == 517)
		{
			pointPosition.X += (float)Main.rand.Next(-3, 4) * 3.5f;
			pointPosition.Y += (float)Main.rand.Next(-3, 4) * 3.5f;
		}
		if (sItem.type == 2611 || sItem.type == 5526)
		{
			Vector2 vector2 = vector;
			if (vector2 != Vector2.Zero)
			{
				vector2.Normalize();
			}
			pointPosition += vector2;
		}
		if (sItem.type == 3827)
		{
			pointPosition += vector.SafeNormalize(Vector2.Zero).RotatedBy((float)direction * (-(float)Math.PI / 2f)) * 24f;
		}
		if (projToShoot == 9)
		{
			float num2 = (float)Main.mouseX + Main.screenPosition.X;
			int num3 = -1;
			if (num2 < base.Left.X)
			{
				num3 = 1;
			}
			else if (num2 <= base.Right.X && Main.rand.Next(2) == 0)
			{
				num3 = 1;
			}
			pointPosition = new Vector2(position.X + (float)width * 0.5f + (float)(Main.rand.Next(201) * num3) + ((float)Main.mouseX + Main.screenPosition.X - position.X), MountedCenter.Y - 600f);
			KnockBack = 0f;
			Damage = (int)((float)Damage * 1.5f);
		}
		if (sItem.type == 986 || sItem.type == 281)
		{
			pointPosition.X += 6 * direction;
			pointPosition.Y -= 6f * gravDir;
		}
		if (sItem.type == 3007)
		{
			pointPosition.X -= 4 * direction;
			pointPosition.Y -= 2f * gravDir;
		}
		float num4 = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
		float num5 = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y;
		if (sItem.type == 3852 && !ItemAnimationJustStarted)
		{
			Vector2 vector3 = vector;
			num4 = vector3.X;
			num5 = vector3.Y;
		}
		if (gravDir == -1f)
		{
			num5 = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY - pointPosition.Y;
		}
		float num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
		float num7 = num6;
		if ((float.IsNaN(num4) && float.IsNaN(num5)) || (num4 == 0f && num5 == 0f))
		{
			num4 = direction;
			num5 = 0f;
			num6 = speed;
		}
		else
		{
			num6 = speed / num6;
		}
		if (sItem.type == 1929 || sItem.type == 2270)
		{
			num4 += (float)Main.rand.Next(-50, 51) * 0.03f / num6;
			num5 += (float)Main.rand.Next(-50, 51) * 0.03f / num6;
		}
		num4 *= num6;
		num5 *= num6;
		if (projToShoot == 250)
		{
			for (int j = 0; j < 1000; j++)
			{
				if (Main.projectile[j].active && Main.projectile[j].owner == whoAmI && (Main.projectile[j].type == 250 || Main.projectile[j].type == 251))
				{
					Main.projectile[j].Kill();
				}
			}
		}
		if (projToShoot == 12 && Collision.CanHitLine(base.Center, 0, 0, pointPosition + new Vector2(num4, num5) * 4f, 0, 0))
		{
			pointPosition += new Vector2(num4, num5) * 3f;
		}
		if (projToShoot == 728 && !Collision.CanHitLine(base.Center, 0, 0, pointPosition + new Vector2(num4, num5) * 2f, 0, 0))
		{
			Vector2 vector4 = new Vector2(num4, num5) * 0.25f;
			pointPosition = base.Center - vector4;
		}
		if (projToShoot == 85)
		{
			pointPosition += new Vector2(0f, -6f * (float)direction * Directions.Y).RotatedBy(vector.ToRotation());
			if (Collision.CanHitLine(pointPosition, 0, 0, pointPosition + new Vector2(num4, num5) * 5f, 0, 0))
			{
				pointPosition += new Vector2(num4, num5) * 4f;
			}
		}
		if (projToShoot == 802 || projToShoot == 842)
		{
			Vector2 v2 = new Vector2(num4, num5);
			float num8 = (float)Math.PI / 4f;
			Vector2 vector5 = v2.SafeNormalize(Vector2.Zero).RotatedBy(num8 * (Main.rand.NextFloat() - 0.5f)) * (v2.Length() - Main.rand.NextFloatDirection() * 0.7f);
			num4 = vector5.X;
			num5 = vector5.Y;
		}
		if (sItem.useStyle == 5)
		{
			if (sItem.type == 3029)
			{
				Vector2 vector6 = new Vector2(num4, num5);
				vector6.X = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
				vector6.Y = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y - 1000f;
				itemRotation = (float)Math.Atan2(vector6.Y * (float)direction, vector6.X * (float)direction);
			}
			else if (sItem.type == 4381)
			{
				Vector2 vector7 = new Vector2(num4, num5);
				vector7.X = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
				vector7.Y = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y - 1000f;
				itemRotation = (float)Math.Atan2(vector7.Y * (float)direction, vector7.X * (float)direction);
			}
			else if (sItem.type == 3779)
			{
				itemRotation = 0f;
			}
			else
			{
				itemRotation = (float)Math.Atan2(num5 * (float)direction, num4 * (float)direction) - fullRotation;
			}
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			NetMessage.SendData(41, -1, -1, null, whoAmI);
		}
		if (sItem.useStyle == 13)
		{
			itemRotation = (float)Math.Atan2(num5 * (float)direction, num4 * (float)direction) - fullRotation;
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			NetMessage.SendData(41, -1, -1, null, whoAmI);
		}
		if (projToShoot == 17)
		{
			pointPosition.X = (float)Main.mouseX + Main.screenPosition.X;
			pointPosition.Y = (float)Main.mouseY + Main.screenPosition.Y;
			if (gravDir == -1f)
			{
				pointPosition.Y = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY;
			}
			LimitPointToPlayerReachableArea(ref pointPosition);
		}
		if (projToShoot == 76)
		{
			projToShoot += Main.rand.Next(3);
			float smallerScaledAxis = Main.Camera.SmallerScaledAxis;
			num7 /= smallerScaledAxis / 2f;
			if (num7 > 1f)
			{
				num7 = 1f;
			}
			float num9 = num4 + (float)Main.rand.Next(-40, 41) * 0.01f;
			float num10 = num5 + (float)Main.rand.Next(-40, 41) * 0.01f;
			num7 *= 1.75f;
			num9 *= num7 + 0.1f;
			num10 *= num7 + 0.1f;
			int num11 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num9, num10, projToShoot, Damage, KnockBack, i, 0f, 1f);
			num7 = num7 * 2f - 1f;
			if (num7 < -1f)
			{
				num7 = -1f;
			}
			if (num7 > 1f)
			{
				num7 = 1f;
			}
			Main.projectile[num11].ai[0] = num7;
			NetMessage.SendData(27, -1, -1, null, num11);
			return;
		}
		if (sItem.type == 3029)
		{
			int num12 = 3;
			if (projToShoot == 91 || projToShoot == 4 || projToShoot == 5 || projToShoot == 41)
			{
				if (Main.rand.Next(3) == 0)
				{
					num12--;
				}
			}
			else if (Main.rand.Next(3) == 0)
			{
				num12++;
			}
			for (int k = 0; k < num12; k++)
			{
				pointPosition = new Vector2(position.X + (float)width * 0.5f + (float)(Main.rand.Next(201) * -direction) + ((float)Main.mouseX + Main.screenPosition.X - position.X), MountedCenter.Y - 600f);
				pointPosition.X = (pointPosition.X * 10f + base.Center.X) / 11f + (float)Main.rand.Next(-100, 101);
				pointPosition.Y -= 150 * k;
				num4 = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
				num5 = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y;
				if (num5 < 0f)
				{
					num5 *= -1f;
				}
				if (num5 < 20f)
				{
					num5 = 20f;
				}
				num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
				num6 = speed / num6;
				num4 *= num6;
				num5 *= num6;
				float num13 = num4 + (float)Main.rand.Next(-40, 41) * 0.03f;
				float speedY = num5 + (float)Main.rand.Next(-40, 41) * 0.03f;
				num13 *= (float)Main.rand.Next(75, 150) * 0.01f;
				pointPosition.X += Main.rand.Next(-50, 51);
				int num14 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num13, speedY, projToShoot, Damage, KnockBack, i);
				Main.projectile[num14].noDropItem = true;
			}
			return;
		}
		if (sItem.type == 4381)
		{
			int num15 = Main.rand.Next(1, 3);
			if (Main.rand.Next(3) == 0)
			{
				num15++;
			}
			for (int l = 0; l < num15; l++)
			{
				pointPosition = new Vector2(position.X + (float)width * 0.5f + (float)(Main.rand.Next(61) * -direction) + ((float)Main.mouseX + Main.screenPosition.X - position.X), MountedCenter.Y - 600f);
				pointPosition.X = (pointPosition.X * 10f + base.Center.X) / 11f + (float)Main.rand.Next(-30, 31);
				pointPosition.Y -= 150f * Main.rand.NextFloat();
				num4 = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
				num5 = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y;
				if (num5 < 0f)
				{
					num5 *= -1f;
				}
				if (num5 < 20f)
				{
					num5 = 20f;
				}
				num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
				num6 = speed / num6;
				num4 *= num6;
				num5 *= num6;
				float num16 = num4 + (float)Main.rand.Next(-20, 21) * 0.03f;
				float speedY2 = num5 + (float)Main.rand.Next(-40, 41) * 0.03f;
				num16 *= (float)Main.rand.Next(55, 80) * 0.01f;
				pointPosition.X += Main.rand.Next(-50, 51);
				int num17 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num16, speedY2, projToShoot, Damage, KnockBack, i);
				Main.projectile[num17].noDropItem = true;
			}
			return;
		}
		if (sItem.type == 98 || sItem.type == 533)
		{
			float speedX = num4 + (float)Main.rand.Next(-40, 41) * 0.01f;
			float speedY3 = num5 + (float)Main.rand.Next(-40, 41) * 0.01f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX, speedY3, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 1319)
		{
			float speedX2 = num4 + (float)Main.rand.Next(-40, 41) * 0.02f;
			float speedY4 = num5 + (float)Main.rand.Next(-40, 41) * 0.02f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX2, speedY4, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3107)
		{
			float speedX3 = num4 + (float)Main.rand.Next(-40, 41) * 0.02f;
			float speedY5 = num5 + (float)Main.rand.Next(-40, 41) * 0.02f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX3, speedY5, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (ProjectileID.Sets.IsAGolfBall[projToShoot])
		{
			Vector2 vector8 = new Vector2((float)Main.mouseX + Main.screenPosition.X, (float)Main.mouseY + Main.screenPosition.Y);
			Vector2 vector9 = vector8 - base.Center;
			bool flag2 = false;
			if (vector9.Length() < 100f)
			{
				flag2 = TryPlacingAGolfBallNearANearbyTee(vector8);
			}
			if (!flag2)
			{
				if (vector9.Length() > 100f || !Collision.CanHit(base.Center, 1, 1, vector8, 1, 1))
				{
					Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
				}
				else
				{
					Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector8.X, vector8.Y, 0f, 0f, projToShoot, Damage, KnockBack, i);
				}
			}
			return;
		}
		if (sItem.type == 3053)
		{
			bool flag3 = false;
			if (itemAnimation <= sItem.useTime + 1)
			{
				flag3 = true;
			}
			Vector2 vector10 = new Vector2(num4, num5);
			vector10.Normalize();
			vector10 *= 4f;
			if (!flag3)
			{
				Vector2 vector11 = new Vector2(Main.rand.Next(-100, 101), Main.rand.Next(-100, 101));
				vector11.Normalize();
				vector10 += vector11;
			}
			vector10.Normalize();
			vector10 *= sItem.shootSpeed;
			float num18 = (float)Main.rand.Next(10, 80) * 0.001f;
			if (Main.rand.Next(2) == 0)
			{
				num18 *= -1f;
			}
			float num19 = (float)Main.rand.Next(10, 80) * 0.001f;
			if (Main.rand.Next(2) == 0)
			{
				num19 *= -1f;
			}
			if (flag3)
			{
				num19 = (num18 = 0f);
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector10.X, vector10.Y, projToShoot, Damage, KnockBack, i, num19, num18);
			return;
		}
		if (sItem.type == 3019)
		{
			Vector2 spinninpoint = new Vector2(num4, num5);
			spinninpoint = spinninpoint.RotatedByRandom(0.39269909262657166);
			Vector2 spinninpoint2 = new Vector2(num4, num5);
			spinninpoint2 = spinninpoint2.RotatedByRandom(0.19634954631328583);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, spinninpoint2.X, spinninpoint2.Y, projToShoot, Damage, KnockBack, i, spinninpoint.X, spinninpoint.Y);
			return;
		}
		if (sItem.type == 2797)
		{
			Vector2 vector12 = Vector2.Normalize(new Vector2(num4, num5)) * 40f * sItem.scale;
			if (Collision.CanHit(pointPosition, 0, 0, pointPosition + vector12, 0, 0))
			{
				pointPosition += vector12;
			}
			float ai = new Vector2(num4, num5).ToRotation();
			float num20 = (float)Math.PI * 2f / 3f;
			int num21 = Main.rand.Next(4, 5);
			if (Main.rand.Next(4) == 0)
			{
				num21++;
			}
			for (int m = 0; m < num21; m++)
			{
				float num22 = (float)Main.rand.NextDouble() * 0.2f + 0.05f;
				Vector2 vector13 = new Vector2(num4, num5).RotatedBy(num20 * (float)Main.rand.NextDouble() - num20 / 2f) * num22;
				int num23 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector13.X, vector13.Y, 444, Damage, KnockBack, i, ai);
				Main.projectile[num23].localAI[0] = projToShoot;
				Main.projectile[num23].localAI[1] = speed;
			}
			return;
		}
		if (sItem.type == 2270)
		{
			float num24 = num4 + (float)Main.rand.Next(-40, 41) * 0.05f;
			float num25 = num5 + (float)Main.rand.Next(-40, 41) * 0.05f;
			if (Main.rand.Next(3) == 0)
			{
				num24 *= 1f + (float)Main.rand.Next(-30, 31) * 0.02f;
				num25 *= 1f + (float)Main.rand.Next(-30, 31) * 0.02f;
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num24, num25, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 5117)
		{
			float speedX4 = num4 + (float)Main.rand.Next(-15, 16) * 0.075f;
			float speedY6 = num5 + (float)Main.rand.Next(-15, 16) * 0.075f;
			int num26 = Main.rand.Next(Main.projFrames[sItem.shoot]);
			int damage2 = Damage;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX4, speedY6, projToShoot, damage2, KnockBack, i, 0f, num26);
			return;
		}
		if (sItem.type == 1930)
		{
			int num27 = 2 + Main.rand.Next(3);
			for (int n = 0; n < num27; n++)
			{
				float num28 = num4;
				float num29 = num5;
				float num30 = 0.025f * (float)n;
				num28 += (float)Main.rand.Next(-35, 36) * num30;
				num29 += (float)Main.rand.Next(-35, 36) * num30;
				num6 = (float)Math.Sqrt(num28 * num28 + num29 * num29);
				num6 = speed / num6;
				num28 *= num6;
				num29 *= num6;
				float x = pointPosition.X + num4 * (float)(num27 - n) * 1.75f;
				float y = pointPosition.Y + num5 * (float)(num27 - n) * 1.75f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, x, y, num28, num29, projToShoot, Damage, KnockBack, i, Main.rand.Next(0, 10 * (n + 1)));
			}
			return;
		}
		if (sItem.type == 1931)
		{
			int num31 = 2;
			for (int num32 = 0; num32 < num31; num32++)
			{
				pointPosition = new Vector2(position.X + (float)width * 0.5f + (float)(Main.rand.Next(201) * -direction) + ((float)Main.mouseX + Main.screenPosition.X - position.X), MountedCenter.Y - 600f);
				pointPosition.X = (pointPosition.X + base.Center.X) / 2f + (float)Main.rand.Next(-200, 201);
				pointPosition.Y -= 100 * num32;
				num4 = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
				num5 = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y;
				if (gravDir == -1f)
				{
					num5 = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY - pointPosition.Y;
				}
				if (num5 < 0f)
				{
					num5 *= -1f;
				}
				if (num5 < 20f)
				{
					num5 = 20f;
				}
				num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
				num6 = speed / num6;
				num4 *= num6;
				num5 *= num6;
				float speedX5 = num4 + (float)Main.rand.Next(-40, 41) * 0.02f;
				float speedY7 = num5 + (float)Main.rand.Next(-40, 41) * 0.02f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX5, speedY7, projToShoot, Damage, KnockBack, i, 0f, Main.rand.Next(5));
			}
			return;
		}
		if (sItem.type == 2750)
		{
			int num33 = 1;
			for (int num34 = 0; num34 < num33; num34++)
			{
				pointPosition = new Vector2(position.X + (float)width * 0.5f + (float)(Main.rand.Next(201) * -direction) + ((float)Main.mouseX + Main.screenPosition.X - position.X), MountedCenter.Y - 600f);
				pointPosition.X = (pointPosition.X + base.Center.X) / 2f + (float)Main.rand.Next(-200, 201);
				pointPosition.Y -= 100 * num34;
				num4 = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X + (float)Main.rand.Next(-40, 41) * 0.03f;
				num5 = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y;
				if (gravDir == -1f)
				{
					num5 = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY - pointPosition.Y;
				}
				if (num5 < 0f)
				{
					num5 *= -1f;
				}
				if (num5 < 20f)
				{
					num5 = 20f;
				}
				num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
				num6 = speed / num6;
				num4 *= num6;
				num5 *= num6;
				float num35 = num4;
				float num36 = num5 + (float)Main.rand.Next(-40, 41) * 0.02f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num35 * 0.75f, num36 * 0.75f, projToShoot + Main.rand.Next(3), Damage, KnockBack, i, 0f, 0.5f + (float)Main.rand.NextDouble() * 0.3f);
			}
			return;
		}
		if (sItem.type == 3570)
		{
			int num37 = 3;
			for (int num38 = 0; num38 < num37; num38++)
			{
				pointPosition = new Vector2(position.X + (float)width * 0.5f + (float)(Main.rand.Next(201) * -direction) + ((float)Main.mouseX + Main.screenPosition.X - position.X), MountedCenter.Y - 600f);
				pointPosition.X = (pointPosition.X + base.Center.X) / 2f + (float)Main.rand.Next(-200, 201);
				pointPosition.Y -= 100 * num38;
				num4 = (float)Main.mouseX + Main.screenPosition.X - pointPosition.X;
				num5 = (float)Main.mouseY + Main.screenPosition.Y - pointPosition.Y;
				float ai2 = num5 + pointPosition.Y;
				if (num5 < 0f)
				{
					num5 *= -1f;
				}
				if (num5 < 20f)
				{
					num5 = 20f;
				}
				num6 = (float)Math.Sqrt(num4 * num4 + num5 * num5);
				num6 = speed / num6;
				num4 *= num6;
				num5 *= num6;
				Vector2 vector14 = new Vector2(num4, num5) / 2f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector14.X, vector14.Y, projToShoot, Damage, KnockBack, i, 0f, ai2);
			}
			return;
		}
		if (sItem.type == 5065)
		{
			Vector2 farthestSpawnPositionOnLine = GetFarthestSpawnPositionOnLine(pointPosition, num4, num5);
			Vector2 zero = Vector2.Zero;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, farthestSpawnPositionOnLine, zero, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3065)
		{
			Vector2 vector15 = Main.screenPosition + new Vector2(Main.mouseX, Main.mouseY);
			float num39 = vector15.Y;
			if (num39 > base.Center.Y - 200f)
			{
				num39 = base.Center.Y - 200f;
			}
			for (int num40 = 0; num40 < 3; num40++)
			{
				pointPosition = base.Center + new Vector2(-Main.rand.Next(0, 401) * direction, -600f);
				pointPosition.Y -= 100 * num40;
				Vector2 vector16 = vector15 - pointPosition;
				if (vector16.Y < 0f)
				{
					vector16.Y *= -1f;
				}
				if (vector16.Y < 20f)
				{
					vector16.Y = 20f;
				}
				vector16.Normalize();
				vector16 *= speed;
				num4 = vector16.X;
				num5 = vector16.Y;
				float speedX6 = num4;
				float speedY8 = num5 + (float)Main.rand.Next(-40, 41) * 0.02f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX6, speedY8, projToShoot, Damage, KnockBack, i, 0f, num39);
			}
			return;
		}
		if (sItem.type == 2624)
		{
			float num41 = (float)Math.PI / 10f;
			int num42 = 5;
			Vector2 vector17 = new Vector2(num4, num5);
			vector17.Normalize();
			vector17 *= 40f;
			bool flag4 = Collision.CanHit(pointPosition, 0, 0, pointPosition + vector17, 0, 0);
			for (int num43 = 0; num43 < num42; num43++)
			{
				float num44 = (float)num43 - ((float)num42 - 1f) / 2f;
				Vector2 vector18 = vector17.RotatedBy(num41 * num44);
				if (!flag4)
				{
					vector18 -= vector17;
				}
				Vector2 vector19 = pointPosition + vector18;
				Vector2 vector20 = (vector19 - base.Center).SafeNormalize(Vector2.Zero);
				if (!Collision.CanHitLine(MountedCenter, 4, 4, vector19 - new Vector2(num4, num5), 0, 0))
				{
					vector19 -= vector20 * 15f;
				}
				int num45 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector19.X, vector19.Y, num4, num5, projToShoot, Damage, KnockBack, i);
				Main.projectile[num45].noDropItem = true;
			}
			return;
		}
		if (sItem.type == 1929)
		{
			float speedX7 = num4 + (float)Main.rand.Next(-40, 41) * 0.03f;
			float speedY9 = num5 + (float)Main.rand.Next(-40, 41) * 0.03f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX7, speedY9, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 1553)
		{
			float speedX8 = num4 + (float)Main.rand.Next(-40, 41) * 0.005f;
			float speedY10 = num5 + (float)Main.rand.Next(-40, 41) * 0.005f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, speedX8, speedY10, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 518)
		{
			float num46 = num4;
			float num47 = num5;
			num46 += (float)Main.rand.Next(-40, 41) * 0.04f;
			num47 += (float)Main.rand.Next(-40, 41) * 0.04f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num46, num47, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 1265)
		{
			float num48 = num4;
			float num49 = num5;
			num48 += (float)Main.rand.Next(-30, 31) * 0.03f;
			num49 += (float)Main.rand.Next(-30, 31) * 0.03f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num48, num49, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 4262)
		{
			float num50 = 2.6666667f;
			_ = base.Bottom;
			_ = (int)base.Bottom.X / 16;
			int num51 = 4;
			float num52 = Math.Abs((float)Main.mouseX + Main.screenPosition.X - position.X) / 16f;
			if (direction < 0)
			{
				num52 += 1f;
			}
			num51 = (int)num52;
			if (num51 > 15)
			{
				num51 = 15;
			}
			Point point = base.Center.ToTileCoordinates();
			int maxDistance = 31;
			for (int num53 = num51; num53 >= 0; num53--)
			{
				if (Collision.CanHitLine(base.Center, 1, 1, base.Center + new Vector2(16 * num53 * direction, 0f), 1, 1) && WorldUtils.Find(new Point(point.X + direction * num53, point.Y), Searches.Chain(new Searches.Down(maxDistance), new Conditions.MysticSnake()), out var result))
				{
					int num54 = result.Y;
					while (Main.tile[result.X, num54 - 1].active())
					{
						num54--;
						if (Main.tile[result.X, num54 - 1] == null || num54 < 10 || result.Y - num54 > 7)
						{
							num54 = -1;
							break;
						}
					}
					if (num54 >= 10)
					{
						result.Y = num54;
						for (int num55 = 0; num55 < 1000; num55++)
						{
							Projectile projectile = Main.projectile[num55];
							if (projectile.active && projectile.owner == whoAmI && projectile.type == projToShoot)
							{
								if (projectile.ai[1] == 2f)
								{
									projectile.timeLeft = 4;
								}
								else
								{
									projectile.Kill();
								}
							}
						}
						Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, result.X * 16 + 8, result.Y * 16 + 8 - 16, 0f, 0f - num50, projToShoot, Damage, KnockBack, i, result.Y * 16 + 8 - 16);
						break;
					}
				}
			}
			return;
		}
		if (sItem.type == 4952)
		{
			Vector2 vector21 = Main.rand.NextVector2Circular(1f, 1f) + Main.rand.NextVector2CircularEdge(3f, 3f);
			if (vector21.Y > 0f)
			{
				vector21.Y *= -1f;
			}
			float num56 = (float)itemAnimation / (float)itemAnimationMax * 0.66f + miscCounterNormalized;
			pointPosition = MountedCenter + new Vector2(direction * 15, gravDir * 3f);
			ApplyItemPositionOffsetFromMount(ref pointPosition);
			Point point2 = pointPosition.ToTileCoordinates();
			Tile tile = Main.tile[point2.X, point2.Y];
			if (tile != null && tile.nactive() && Main.tileSolid[tile.type] && !Main.tileSolidTop[tile.type] && !TileID.Sets.Platforms[tile.type])
			{
				pointPosition = MountedCenter;
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector21.X, vector21.Y, projToShoot, Damage, KnockBack, i, -1f, num56 % 1f);
			return;
		}
		if (sItem.type == 4953)
		{
			float num57 = (float)Math.PI / 10f;
			int num58 = 5;
			Vector2 vector22 = new Vector2(num4, num5);
			vector22.Normalize();
			vector22 *= 40f;
			bool num59 = Collision.CanHit(pointPosition, 0, 0, pointPosition + vector22, 0, 0);
			int num60 = (itemAnimationMax - itemAnimation) / 2;
			int num61 = num60;
			if (direction == 1)
			{
				num61 = 4 - num60;
			}
			float num62 = (float)num61 - ((float)num58 - 1f) / 2f;
			Vector2 vector23 = vector22.RotatedBy(num57 * num62);
			if (!num59)
			{
				vector23 -= vector22;
			}
			Vector2 mouseWorld = Main.MouseWorld;
			Vector2 vector24 = pointPosition + vector23;
			Vector2 vector25 = (vector24 - base.Center).SafeNormalize(Vector2.Zero);
			if (!Collision.CanHitLine(MountedCenter, 4, 4, vector24 - new Vector2(num4, num5), 0, 0))
			{
				vector24 -= vector25 * 15f;
			}
			Vector2 vector26 = vector24.DirectionTo(mouseWorld).SafeNormalize(-Vector2.UnitY);
			Vector2 value2 = base.Center.DirectionTo(base.Center + new Vector2(num4, num5)).SafeNormalize(-Vector2.UnitY);
			float lerpValue = Utils.GetLerpValue(100f, 40f, mouseWorld.Distance(base.Center), clamped: true);
			if (lerpValue > 0f)
			{
				vector26 = Vector2.Lerp(vector26, value2, lerpValue).SafeNormalize(new Vector2(num4, num5).SafeNormalize(-Vector2.UnitY));
			}
			Vector2 v3 = vector26 * speed;
			if (num60 == 2)
			{
				projToShoot = 932;
				Damage *= 2;
			}
			if (projToShoot == 932)
			{
				float ai3 = miscCounterNormalized * 12f % 1f;
				v3 = v3.SafeNormalize(Vector2.Zero) * (speed * 2f);
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector24, v3, projToShoot, Damage, KnockBack, i, 0f, ai3);
			}
			else
			{
				int num63 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector24, v3, projToShoot, Damage, KnockBack, i);
				Main.projectile[num63].noDropItem = true;
			}
			return;
		}
		if (sItem.type == 534)
		{
			int num64 = Main.rand.Next(4, 6);
			for (int num65 = 0; num65 < num64; num65++)
			{
				float num66 = num4;
				float num67 = num5;
				num66 += (float)Main.rand.Next(-40, 41) * 0.05f;
				num67 += (float)Main.rand.Next(-40, 41) * 0.05f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num66, num67, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 4703)
		{
			float num68 = (float)Math.PI / 2f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
			for (int num69 = 0; num69 < 7; num69++)
			{
				Vector2 v4 = new Vector2(num4, num5);
				float num70 = v4.Length();
				v4 += v4.SafeNormalize(Vector2.Zero).RotatedBy(num68 * Main.rand.NextFloat()) * Main.rand.NextFloatDirection() * 5f;
				v4 = v4.SafeNormalize(Vector2.Zero) * num70;
				float x2 = v4.X;
				float y2 = v4.Y;
				x2 += (float)Main.rand.Next(-40, 41) * 0.05f;
				y2 += (float)Main.rand.Next(-40, 41) * 0.05f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, x2, y2, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 4270)
		{
			Vector2 pointPosition2 = Main.MouseWorld;
			LimitPointToPlayerReachableArea(ref pointPosition2);
			Vector2 vector27 = pointPosition2 + Main.rand.NextVector2Circular(8f, 8f);
			Vector2 vector28 = FindSharpTearsSpot(vector27).ToWorldCoordinates(Main.rand.Next(17), Main.rand.Next(17));
			Vector2 vector29 = (vector27 - vector28).SafeNormalize(-Vector2.UnitY) * 16f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector28.X, vector28.Y, vector29.X, vector29.Y, projToShoot, Damage, KnockBack, i, 0f, Main.rand.NextFloat() * 0.5f + 0.6f);
			return;
		}
		if (sItem.type == 4715)
		{
			Vector2 vector30 = Main.MouseWorld;
			List<NPC> validTargets;
			bool sparkleGuitarTarget = GetSparkleGuitarTarget(out validTargets);
			if (sparkleGuitarTarget)
			{
				NPC nPC = validTargets[Main.rand.Next(validTargets.Count)];
				vector30 = nPC.Center + nPC.velocity * 20f;
			}
			Vector2 vector31 = vector30 - base.Center;
			if (!sparkleGuitarTarget)
			{
				vector30 += Main.rand.NextVector2Circular(24f, 24f);
				if (vector31.Length() > 700f)
				{
					vector31 *= 700f / vector31.Length();
					vector30 = base.Center + vector31;
				}
			}
			Vector2 vector32 = Main.rand.NextVector2CircularEdge(1f, 1f);
			if (vector32.Y > 0f)
			{
				vector32 *= -1f;
			}
			if (Math.Abs(vector32.Y) < 0.5f)
			{
				vector32.Y = (0f - Main.rand.NextFloat()) * 0.5f - 0.5f;
			}
			vector32 *= vector31.Length() * 2f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector32.X, vector32.Y, projToShoot, Damage, KnockBack, i, vector30.X, vector30.Y);
			return;
		}
		if (sItem.type == 4722)
		{
			Vector2 vector33 = Main.MouseWorld;
			List<NPC> validTargets2;
			bool sparkleGuitarTarget2 = GetSparkleGuitarTarget(out validTargets2);
			if (sparkleGuitarTarget2)
			{
				NPC nPC2 = validTargets2[Main.rand.Next(validTargets2.Count)];
				vector33 = nPC2.Center + nPC2.velocity * 20f;
			}
			Vector2 vector34 = vector33 - base.Center;
			Vector2 vector35 = Main.rand.NextVector2CircularEdge(1f, 1f);
			float num71 = 1f;
			int num72 = 1;
			for (int num73 = 0; num73 < num72; num73++)
			{
				if (!sparkleGuitarTarget2)
				{
					vector33 += Main.rand.NextVector2Circular(24f, 24f);
					if (vector34.Length() > 700f)
					{
						vector34 *= 700f / vector34.Length();
						vector33 = base.Center + vector34;
					}
					float num74 = Utils.GetLerpValue(0f, 6f, velocity.Length(), clamped: true) * 0.8f;
					vector35 *= 1f - num74;
					vector35 += velocity * num74;
					vector35 = vector35.SafeNormalize(Vector2.UnitX);
				}
				float num75 = 60f;
				float num76 = Main.rand.NextFloatDirection() * (float)Math.PI * (1f / num75) * 0.5f * num71;
				float num77 = num75 / 2f;
				float num78 = 12f + Main.rand.NextFloat() * 2f;
				Vector2 vector36 = vector35 * num78;
				Vector2 vector37 = new Vector2(0f, 0f);
				Vector2 vector38 = vector36;
				for (int num79 = 0; (float)num79 < num77; num79++)
				{
					vector37 += vector38;
					vector38 = vector38.RotatedBy(num76);
				}
				Vector2 vector39 = -vector37;
				Vector2 vector40 = vector33 + vector39;
				float lerpValue2 = Utils.GetLerpValue(itemAnimationMax, 0f, itemAnimation, clamped: true);
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector40, vector36, projToShoot, Damage, KnockBack, i, num76, lerpValue2);
			}
			return;
		}
		if (sItem.type == 4607)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 5069)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 5114)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 5456)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 2188)
		{
			int num80 = 4;
			if (Main.rand.Next(3) == 0)
			{
				num80++;
			}
			if (Main.rand.Next(4) == 0)
			{
				num80++;
			}
			if (Main.rand.Next(5) == 0)
			{
				num80++;
			}
			for (int num81 = 0; num81 < num80; num81++)
			{
				float num82 = num4;
				float num83 = num5;
				float num84 = 0.05f * (float)num81;
				num82 += (float)Main.rand.Next(-35, 36) * num84;
				num83 += (float)Main.rand.Next(-35, 36) * num84;
				num6 = (float)Math.Sqrt(num82 * num82 + num83 * num83);
				num6 = speed / num6;
				num82 *= num6;
				num83 *= num6;
				float x3 = pointPosition.X;
				float y3 = pointPosition.Y;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, x3, y3, num82, num83, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 1308)
		{
			int num85 = 3;
			if (Main.rand.Next(3) == 0)
			{
				num85++;
			}
			for (int num86 = 0; num86 < num85; num86++)
			{
				float num87 = num4;
				float num88 = num5;
				float num89 = 0.05f * (float)num86;
				num87 += (float)Main.rand.Next(-35, 36) * num89;
				num88 += (float)Main.rand.Next(-35, 36) * num89;
				num6 = (float)Math.Sqrt(num87 * num87 + num88 * num88);
				num6 = speed / num6;
				num87 *= num6;
				num88 *= num6;
				float x4 = pointPosition.X;
				float y4 = pointPosition.Y;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, x4, y4, num87, num88, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 1258)
		{
			float num90 = num4;
			float num91 = num5;
			num90 += (float)Main.rand.Next(-40, 41) * 0.01f;
			num91 += (float)Main.rand.Next(-40, 41) * 0.01f;
			pointPosition.X += (float)Main.rand.Next(-40, 41) * 0.05f;
			pointPosition.Y += (float)Main.rand.Next(-45, 36) * 0.05f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num90, num91, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 964)
		{
			int num92 = Main.rand.Next(3, 5);
			for (int num93 = 0; num93 < num92; num93++)
			{
				float num94 = num4;
				float num95 = num5;
				num94 += (float)Main.rand.Next(-35, 36) * 0.04f;
				num95 += (float)Main.rand.Next(-35, 36) * 0.04f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num94, num95, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 1569)
		{
			int num96 = 4;
			if (Main.rand.Next(2) == 0)
			{
				num96++;
			}
			if (Main.rand.Next(4) == 0)
			{
				num96++;
			}
			if (Main.rand.Next(8) == 0)
			{
				num96++;
			}
			if (Main.rand.Next(16) == 0)
			{
				num96++;
			}
			for (int num97 = 0; num97 < num96; num97++)
			{
				float num98 = num4;
				float num99 = num5;
				float num100 = 0.05f * (float)num97;
				num98 += (float)Main.rand.Next(-35, 36) * num100;
				num99 += (float)Main.rand.Next(-35, 36) * num100;
				num6 = (float)Math.Sqrt(num98 * num98 + num99 * num99);
				num6 = speed / num6;
				num98 *= num6;
				num99 *= num6;
				float x5 = pointPosition.X;
				float y5 = pointPosition.Y;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, x5, y5, num98, num99, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 1572 || sItem.type == 2366 || sItem.type == 3571 || sItem.type == 3569 || sItem.type == 5119 || sItem.type == 5463)
		{
			PickSentryLandingSpot(sItem, out var spawnX, out var spawnY);
			float speedX9 = 0f;
			float speedY11 = 15f;
			int num101 = 0;
			switch (sItem.type)
			{
			case 1572:
				num101 = 60;
				break;
			case 5119:
				num101 = 90;
				break;
			case 5463:
				spawnY = (float)Main.mouseY + Main.screenPosition.Y;
				speedY11 = 0f;
				break;
			}
			int num102 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, spawnX, spawnY, speedX9, speedY11, projToShoot, Damage, KnockBack, i, num101);
			Main.projectile[num102].originalDamage = damage;
			UpdateMaxTurrets();
			return;
		}
		if (sItem.type == 5667)
		{
			bool flag5 = altFunctionUse == 2;
			bool flag6 = !flag5;
			if (ownedProjectileCounts[1098] > 0)
			{
				for (int num103 = 0; num103 < 1000; num103++)
				{
					Projectile projectile2 = Main.projectile[num103];
					if (!projectile2.active || projectile2.owner != whoAmI || projectile2.type != 1098)
					{
						continue;
					}
					if (flag5)
					{
						projectile2.Kill();
						continue;
					}
					flag6 = false;
					projectile2.netUpdate2 = true;
					projectile2.ai[1] = 0f;
					StopPettingAnimal();
					if (projectile2.Distance(base.Center) >= 1200f)
					{
						projectile2.Kill();
						continue;
					}
					if (projectile2.ai[0] == 0f || projectile2.ai[0] == 4f || projectile2.ai[0] == 5f)
					{
						Vector2 vector41 = Main.ReverseGravitySupport(Main.MouseScreen) + Main.screenPosition - projectile2.Center;
						if (Math.Abs(vector41.Y) >= Math.Abs(vector41.X))
						{
							projectile2.ai[0] = 1f;
						}
						else
						{
							projectile2.ai[0] = ((vector41.X >= 0f) ? 2 : 3);
						}
						continue;
					}
					int num104 = 6;
					if (projectile2.ai[0] == 2f)
					{
						projectile2.velocity.X = -num104;
					}
					else if (projectile2.ai[0] == 3f)
					{
						projectile2.velocity.X = num104;
					}
					projectile2.ai[0] = 4f;
				}
			}
			if (flag6)
			{
				SpawnDigtoiseOnCursor(i, projToShoot, projectileSource_Item_WithPotentialAmmo);
			}
			return;
		}
		if (sItem.type == 1244 || sItem.type == 1256)
		{
			int num105 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
			Main.projectile[num105].ai[0] = (float)Main.mouseX + Main.screenPosition.X;
			Main.projectile[num105].ai[1] = (float)Main.mouseY + Main.screenPosition.Y;
			return;
		}
		if (sItem.type == 1229)
		{
			int num106 = 2;
			if (Main.rand.Next(3) == 0)
			{
				num106++;
			}
			for (int num107 = 0; num107 < num106; num107++)
			{
				float num108 = num4;
				float num109 = num5;
				if (num107 > 0)
				{
					num108 += (float)Main.rand.Next(-35, 36) * 0.04f;
					num109 += (float)Main.rand.Next(-35, 36) * 0.04f;
				}
				if (num107 > 1)
				{
					num108 += (float)Main.rand.Next(-35, 36) * 0.04f;
					num109 += (float)Main.rand.Next(-35, 36) * 0.04f;
				}
				if (num107 > 2)
				{
					num108 += (float)Main.rand.Next(-35, 36) * 0.04f;
					num109 += (float)Main.rand.Next(-35, 36) * 0.04f;
				}
				int num110 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num108, num109, projToShoot, Damage, KnockBack, i);
				Main.projectile[num110].noDropItem = true;
			}
			return;
		}
		if (sItem.type == 1121)
		{
			int num111 = Main.rand.Next(1, 4);
			if (Main.rand.Next(6) == 0)
			{
				num111++;
			}
			if (Main.rand.Next(6) == 0)
			{
				num111++;
			}
			if (strongBees && Main.rand.Next(3) == 0)
			{
				num111++;
			}
			for (int num112 = 0; num112 < num111; num112++)
			{
				float num113 = num4;
				float num114 = num5;
				num113 += (float)Main.rand.Next(-35, 36) * 0.02f;
				num114 += (float)Main.rand.Next(-35, 36) * 0.02f;
				int num115 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num113, num114, beeType(), beeDamage(Damage), beeKB(KnockBack), i);
				Main.projectile[num115].magic = true;
			}
			return;
		}
		if (sItem.type == 1155)
		{
			int num116 = Main.rand.Next(2, 5);
			for (int num117 = 0; num117 < num116; num117++)
			{
				float num118 = num4;
				float num119 = num5;
				num118 += (float)Main.rand.Next(-35, 36) * 0.02f;
				num119 += (float)Main.rand.Next(-35, 36) * 0.02f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num118, num119, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 1801)
		{
			int num120 = Main.rand.Next(2, 4);
			for (int num121 = 0; num121 < num120; num121++)
			{
				float num122 = num4;
				float num123 = num5;
				num122 += (float)Main.rand.Next(-35, 36) * 0.05f;
				num123 += (float)Main.rand.Next(-35, 36) * 0.05f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num122, num123, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 679)
		{
			for (int num124 = 0; num124 < 6; num124++)
			{
				float num125 = num4;
				float num126 = num5;
				num125 += (float)Main.rand.Next(-40, 41) * 0.05f;
				num126 += (float)Main.rand.Next(-40, 41) * 0.05f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num125, num126, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 1156)
		{
			int num127 = 0;
			for (int num128 = 0; num128 < 1000; num128++)
			{
				if (Main.projectile[num128].active && Main.projectile[num128].owner == whoAmI && Main.projectile[num128].type == HeldItem.shoot)
				{
					num127++;
				}
			}
			for (int num129 = 0; num129 < 3 - num127; num129++)
			{
				float num130 = num4;
				float num131 = num5;
				num130 += (float)Main.rand.Next(-40, 41) * 0.05f;
				num131 += (float)Main.rand.Next(-40, 41) * 0.05f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num130, num131, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 4682)
		{
			for (int num132 = 0; num132 < 3; num132++)
			{
				float num133 = num4;
				float num134 = num5;
				num133 += (float)Main.rand.Next(-20, 21) * 0.1f;
				num134 += (float)Main.rand.Next(-20, 21) * 0.1f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num133, num134, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 2623)
		{
			for (int num135 = 0; num135 < 3; num135++)
			{
				float num136 = num4;
				float num137 = num5;
				num136 += (float)Main.rand.Next(-40, 41) * 0.1f;
				num137 += (float)Main.rand.Next(-40, 41) * 0.1f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num136, num137, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 3210)
		{
			Vector2 vector42 = new Vector2(num4, num5);
			vector42.X += (float)Main.rand.Next(-30, 31) * 0.04f;
			vector42.Y += (float)Main.rand.Next(-30, 31) * 0.03f;
			vector42.Normalize();
			vector42 *= (float)Main.rand.Next(70, 91) * 0.1f;
			vector42.X += (float)Main.rand.Next(-30, 31) * 0.04f;
			vector42.Y += (float)Main.rand.Next(-30, 31) * 0.03f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector42.X, vector42.Y, projToShoot, Damage, KnockBack, i, Main.rand.Next(20));
			return;
		}
		if (sItem.type == 434)
		{
			float num138 = num4;
			float num139 = num5;
			if (itemAnimation < 5)
			{
				num138 += (float)Main.rand.Next(-40, 41) * 0.01f;
				num139 += (float)Main.rand.Next(-40, 41) * 0.01f;
				num138 *= 1.1f;
				num139 *= 1.1f;
			}
			else if (itemAnimation < 10)
			{
				num138 += (float)Main.rand.Next(-20, 21) * 0.01f;
				num139 += (float)Main.rand.Next(-20, 21) * 0.01f;
				num138 *= 1.05f;
				num139 *= 1.05f;
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num138, num139, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 1157)
		{
			projToShoot = Main.rand.Next(191, 195);
			int num140 = SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			Main.projectile[num140].localAI[0] = 30f;
			return;
		}
		if (sItem.type == 5663)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 5664)
		{
			int num141 = SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			Main.projectile[num141].localAI[0] = 30f;
			return;
		}
		if (sItem.type == 1802)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 2364 || sItem.type == 2365)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 2535)
		{
			num4 = 0f;
			num5 = 0f;
			Vector2 spinningpoint = new Vector2(num4, num5);
			spinningpoint = spinningpoint.RotatedBy(1.5707963705062866);
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack, spinningpoint, spinningpoint);
			spinningpoint = spinningpoint.RotatedBy(-3.1415927410125732);
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot + 1, damage, KnockBack, spinningpoint, spinningpoint);
			return;
		}
		if (sItem.type == 2551)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot + nextCycledSpiderMinionType, damage, KnockBack);
			nextCycledSpiderMinionType++;
			nextCycledSpiderMinionType %= 3;
			return;
		}
		if (sItem.type == 2584)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot + Main.rand.Next(3), damage, KnockBack);
			return;
		}
		if (sItem.type == 2621)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 2749 || sItem.type == 3249 || sItem.type == 3474 || sItem.type == 4273 || sItem.type == 4281)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.type == 3531)
		{
			int num142 = -1;
			int num143 = -1;
			for (int num144 = 0; num144 < 1000; num144++)
			{
				if (Main.projectile[num144].active && Main.projectile[num144].owner == Main.myPlayer)
				{
					if (num142 == -1 && Main.projectile[num144].type == 625)
					{
						num142 = num144;
					}
					if (num143 == -1 && Main.projectile[num144].type == 628)
					{
						num143 = num144;
					}
					if (num142 != -1 && num143 != -1)
					{
						break;
					}
				}
			}
			if (num142 == -1 && num143 == -1)
			{
				num4 = 0f;
				num5 = 0f;
				pointPosition.X = (float)Main.mouseX + Main.screenPosition.X;
				pointPosition.Y = (float)Main.mouseY + Main.screenPosition.Y;
				int num145 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
				int num146 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot + 1, Damage, KnockBack, i, num145);
				int num147 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot + 2, Damage, KnockBack, i, num146);
				int num148 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot + 3, Damage, KnockBack, i, num147);
				Main.projectile[num146].localAI[1] = num147;
				Main.projectile[num147].localAI[1] = num148;
				Main.projectile[num145].originalDamage = damage;
				Main.projectile[num146].originalDamage = damage;
				Main.projectile[num147].originalDamage = damage;
				Main.projectile[num148].originalDamage = damage;
			}
			else if (num142 != -1 && num143 != -1)
			{
				int num149 = (int)Main.projectile[num143].ai[0];
				int num150 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot + 1, Damage, KnockBack, i, num149);
				int num151 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot + 2, Damage, KnockBack, i, num150);
				Main.projectile[num150].localAI[1] = num151;
				Main.projectile[num150].netUpdate = true;
				Main.projectile[num150].ai[1] = 1f;
				Main.projectile[num151].localAI[1] = num143;
				Main.projectile[num151].netUpdate = true;
				Main.projectile[num151].ai[1] = 1f;
				Main.projectile[num143].ai[0] = num151;
				Main.projectile[num143].netUpdate = true;
				Main.projectile[num143].ai[1] = 1f;
				Main.projectile[num150].originalDamage = damage;
				Main.projectile[num151].originalDamage = damage;
				Main.projectile[num143].originalDamage = damage;
			}
			return;
		}
		if (sItem.type == 1309 || sItem.type == 4758 || sItem.type == 4269 || sItem.type == 5005)
		{
			SpawnMinionOnCursor(projectileSource_Item_WithPotentialAmmo, i, projToShoot, damage, KnockBack);
			return;
		}
		if (sItem.shoot > 0 && (Main.projPet[sItem.shoot] || sItem.shoot == 72 || sItem.shoot == 18 || sItem.shoot == 500 || sItem.shoot == 650) && !sItem.summon)
		{
			for (int num152 = 0; num152 < 1000; num152++)
			{
				Projectile projectile3 = Main.projectile[num152];
				if (projectile3.active && projectile3.owner == whoAmI)
				{
					if (sItem.shoot == 72 && (projectile3.type == 72 || projectile3.type == 86 || projectile3.type == 87))
					{
						projectile3.Kill();
					}
					else if (sItem.type == 5131 && (projectile3.type == 881 || projectile3.type == 934))
					{
						projectile3.Kill();
					}
					else if (sItem.shoot == projectile3.type)
					{
						projectile3.Kill();
					}
				}
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, 0, 0f, i);
			return;
		}
		if (sItem.type == 3006)
		{
			pointPosition = GetFarthestSpawnPositionOnLine(pointPosition, num4, num5);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, 0f, 0f, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3014)
		{
			Vector2 pointPosition3 = default(Vector2);
			pointPosition3.X = Main.MouseWorld.X;
			pointPosition3.Y = Main.MouseWorld.Y;
			LimitPointToPlayerReachableArea(ref pointPosition3);
			while (Collision.CanHitLine(position, width, height, pointPosition, 1, 1))
			{
				pointPosition.X += num4;
				pointPosition.Y += num5;
				if ((pointPosition - pointPosition3).Length() < 20f + Math.Abs(num4) + Math.Abs(num5))
				{
					pointPosition = pointPosition3;
					break;
				}
			}
			bool flag7 = false;
			int num153 = (int)pointPosition.Y / 16;
			int num154 = (int)pointPosition.X / 16;
			int num155;
			for (num155 = num153; num153 < Main.maxTilesY - 10 && num153 - num155 < 30 && !WorldGen.SolidTile(num154, num153); num153++)
			{
				ushort type2 = Main.tile[num154, num153].type;
				if (TileID.Sets.Platforms[type2] || type2 == 380)
				{
					break;
				}
			}
			if (!WorldGen.SolidTile(num154, num153) && !TileID.Sets.Platforms[Main.tile[num154, num153].type] && Main.tile[num154, num153].type != 380)
			{
				flag7 = true;
			}
			float num156 = num153 * 16;
			num153 = num155;
			while (num153 > 10 && num155 - num153 < 30 && !WorldGen.SolidTile(num154, num153))
			{
				num153--;
			}
			float num157 = num153 * 16 + 16;
			float num158 = num156 - num157;
			int num159 = 15;
			if (num158 > (float)(16 * num159))
			{
				num158 = 16 * num159;
			}
			num157 = num156 - num158;
			pointPosition.X = (int)(pointPosition.X / 16f) * 16;
			if (!flag7)
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, 0f, 0f, projToShoot, Damage, KnockBack, i, num157, num158);
			}
			return;
		}
		if (sItem.type == 3384)
		{
			int num160 = ((altFunctionUse == 2) ? 1 : 0);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, 0f, num160);
			return;
		}
		if (sItem.type == 3473)
		{
			float ai4 = (Main.rand.NextFloat() - 0.5f) * ((float)Math.PI / 4f);
			Vector2 vector43 = new Vector2(num4, num5);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector43.X, vector43.Y, projToShoot, Damage, KnockBack, i, 0f, ai4);
			return;
		}
		if (sItem.type == 5688 || sItem.type == 4672 || sItem.type == 5473 || sItem.type == 5474 || sItem.type == 5475 || sItem.type == 5476 || sItem.type == 5477 || sItem.type == 5478 || sItem.type == 5479 || sItem.type == 5480 || sItem.type == 5074 || sItem.type == 4911 || sItem.type == 4912 || sItem.type == 4913 || sItem.type == 4914 || sItem.type == 4678 || sItem.type == 4679 || sItem.type == 4680)
		{
			float num161 = 0.4f;
			float num162 = 0.6f + num161 * Main.rand.NextFloat();
			if (sItem.type != 4680 && Main.rand.Next(3) == 0)
			{
				num162 *= -2.5f;
			}
			float num163 = 1f;
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, 0f, num162 * num163);
			return;
		}
		if (sItem.type == 4956 || sItem.type == 5669)
		{
			int num164 = (itemAnimationMax - itemAnimation) / itemTime;
			Vector2 vector44 = new Vector2(num4, num5);
			int num165 = 4956;
			if (sItem.type == 4956)
			{
				num165 = FinalFractalHelper.GetRandomProfileIndex();
				if (num164 == 0)
				{
					num165 = 4956;
				}
			}
			if (sItem.type == 5669)
			{
				num165 = 3507;
			}
			Vector2 pointPosition4 = Main.MouseWorld;
			LimitPointToPlayerReachableArea(ref pointPosition4);
			Vector2 vector45 = pointPosition4 - MountedCenter;
			if (num164 == 1 || num164 == 2)
			{
				int npcTargetIndex;
				bool zenithTarget = GetZenithTarget(pointPosition4, 400f, out npcTargetIndex);
				if (zenithTarget)
				{
					vector45 = Main.npc[npcTargetIndex].Center - MountedCenter;
				}
				bool flag8 = num164 == 2;
				if (num164 == 1 && !zenithTarget)
				{
					flag8 = true;
				}
				if (flag8)
				{
					vector45 += Main.rand.NextVector2Circular(150f, 150f);
				}
			}
			vector44 = vector45 / 2f;
			float ai5 = Main.rand.Next(-100, 101);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector44, projToShoot, Damage, KnockBack, i, ai5, num165);
			return;
		}
		if (sItem.type == 3836)
		{
			float ai6 = Main.rand.NextFloat() * speed * 0.75f * (float)direction;
			Projectile.NewProjectile(velocity: new Vector2(num4, num5), spawnSource: projectileSource_Item_WithPotentialAmmo, position: pointPosition, Type: projToShoot, Damage: Damage, KnockBack: KnockBack, Owner: i, ai0: ai6);
			return;
		}
		if (sItem.type == 3858)
		{
			bool num166 = altFunctionUse == 2;
			Vector2 vector46 = new Vector2(num4, num5);
			if (num166)
			{
				vector46 *= 1.5f;
				float ai7 = (0.3f + 0.7f * Main.rand.NextFloat()) * speed * 1.75f * (float)direction;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector46, 708, (int)((float)Damage * 0.5f), KnockBack + 4f, i, ai7);
			}
			else
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector46, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 3859)
		{
			Vector2 vector47 = new Vector2(num4, num5);
			projToShoot = 710;
			vector47 *= 0.8f;
			Vector2 vector48 = vector47.SafeNormalize(-Vector2.UnitY);
			float num167 = (float)Math.PI / 180f * (float)(-direction);
			for (float num168 = -2.5f; num168 < 3f; num168 += 1f)
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, (vector47 + vector48 * num168 * 0.5f).RotatedBy(num168 * num167), projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 3870)
		{
			Vector2 vector49 = Vector2.Normalize(new Vector2(num4, num5)) * 40f * sItem.scale;
			if (Collision.CanHit(pointPosition, 0, 0, pointPosition + vector49, 0, 0))
			{
				pointPosition += vector49;
			}
			Vector2 vector50 = new Vector2(num4, num5);
			vector50 *= 0.8f;
			Vector2 vector51 = vector50.SafeNormalize(-Vector2.UnitY);
			float num169 = (float)Math.PI / 180f * (float)(-direction);
			for (int num170 = 0; num170 <= 2; num170++)
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, (vector50 + vector51 * num170 * 1f).RotatedBy((float)num170 * num169), projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 3542)
		{
			float num171 = (Main.rand.NextFloat() - 0.5f) * ((float)Math.PI / 4f) * 0.7f;
			for (int num172 = 0; num172 < 10; num172++)
			{
				if (Collision.CanHit(pointPosition, 0, 0, pointPosition + new Vector2(num4, num5).RotatedBy(num171) * 100f, 0, 0))
				{
					break;
				}
				num171 = (Main.rand.NextFloat() - 0.5f) * ((float)Math.PI / 4f) * 0.7f;
			}
			Vector2 vector52 = new Vector2(num4, num5).RotatedBy(num171) * (0.95f + Main.rand.NextFloat() * 0.3f);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector52.X, vector52.Y, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3779)
		{
			float num173 = Main.rand.NextFloat() * ((float)Math.PI * 2f);
			for (int num174 = 0; num174 < 10; num174++)
			{
				if (Collision.CanHit(pointPosition, 0, 0, pointPosition + new Vector2(num4, num5).RotatedBy(num173) * 100f, 0, 0))
				{
					break;
				}
				num173 = Main.rand.NextFloat() * ((float)Math.PI * 2f);
			}
			Vector2 vector53 = new Vector2(num4, num5).RotatedBy(num173) * (0.95f + Main.rand.NextFloat() * 0.3f);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition + vector53 * 30f, Vector2.Zero, projToShoot, Damage, KnockBack, i, -2f);
			return;
		}
		if (sItem.type == 3787)
		{
			float f = Main.rand.NextFloat() * ((float)Math.PI * 2f);
			float value3 = 20f;
			float value4 = 60f;
			Vector2 vector54 = pointPosition + f.ToRotationVector2() * MathHelper.Lerp(value3, value4, Main.rand.NextFloat());
			for (int num175 = 0; num175 < 50; num175++)
			{
				vector54 = pointPosition + f.ToRotationVector2() * MathHelper.Lerp(value3, value4, Main.rand.NextFloat());
				if (Collision.CanHit(pointPosition, 0, 0, vector54 + (vector54 - pointPosition).SafeNormalize(Vector2.UnitX) * 8f, 0, 0))
				{
					break;
				}
				f = Main.rand.NextFloat() * ((float)Math.PI * 2f);
			}
			Vector2 v5 = Main.MouseWorld - vector54;
			Vector2 vector55 = new Vector2(num4, num5).SafeNormalize(Vector2.UnitY) * speed;
			v5 = v5.SafeNormalize(vector55) * speed;
			v5 = Vector2.Lerp(v5, vector55, 0.25f);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector54, v5, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3788)
		{
			Vector2 vector56 = new Vector2(num4, num5);
			float num176 = (float)Math.PI / 4f;
			for (int num177 = 0; num177 < 2; num177++)
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector56 + vector56.SafeNormalize(Vector2.Zero).RotatedBy(num176 * (Main.rand.NextFloat() * 0.5f + 0.5f)) * Main.rand.NextFloatDirection() * 2f, projToShoot, Damage, KnockBack, i);
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector56 + vector56.SafeNormalize(Vector2.Zero).RotatedBy((0f - num176) * (Main.rand.NextFloat() * 0.5f + 0.5f)) * Main.rand.NextFloatDirection() * 2f, projToShoot, Damage, KnockBack, i);
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector56.SafeNormalize(Vector2.UnitX * direction) * (speed * 1.3f), 661, Damage * 2, KnockBack, i);
			return;
		}
		if (sItem.type == 4463 || sItem.type == 486)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, new Vector2(num4, num5), projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 46)
		{
			Vector2 vector57 = new Vector2(direction, gravDir * 4f).SafeNormalize(Vector2.UnitY).RotatedBy((float)Math.PI * 2f * Main.rand.NextFloatDirection() * 0.05f);
			Vector2 searchCenter = MountedCenter + new Vector2(70f, -40f) * Directions + vector57 * -10f;
			if (GetZenithTarget(searchCenter, 50f, out var npcTargetIndex2))
			{
				NPC nPC3 = Main.npc[npcTargetIndex2];
				searchCenter = nPC3.Center + Main.rand.NextVector2Circular(nPC3.width / 2, nPC3.height / 2);
			}
			else
			{
				searchCenter += Main.rand.NextVector2Circular(20f, 20f);
			}
			float ai8 = 1f;
			if (Main.rand.Next(100) < meleeCrit)
			{
				ai8 = 2f;
				Damage *= 2;
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, searchCenter, vector57 * 0.001f, projToShoot, (int)((double)Damage * 0.5), KnockBack, i, ai8);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 273)
		{
			float adjustedItemScale = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), projToShoot, Damage, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(num4, num5), projToShoot, Damage, KnockBack, i, (float)direction * gravDir * 0.1f, 30f, adjustedItemScale);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 5462)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
			itemAnimation = sItem.useAnimation - 10;
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 368)
		{
			float adjustedItemScale2 = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), projToShoot, Damage, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale2);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 1826)
		{
			float adjustedItemScale3 = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), projToShoot, Damage, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale3);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 675)
		{
			float adjustedItemScale4 = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), 972, Damage, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale4);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(num4, num5), projToShoot, Damage / 2, KnockBack, i, (float)direction * gravDir, 32f, adjustedItemScale4);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 674)
		{
			float adjustedItemScale5 = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), projToShoot, Damage, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale5);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), 982, 0, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale5);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 757)
		{
			float adjustedItemScale6 = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(direction, 0f), 984, Damage, KnockBack, i, (float)direction * gravDir, itemAnimationMax, adjustedItemScale6);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, MountedCenter, new Vector2(num4, num5) * 5f, projToShoot, Damage, KnockBack, i, (float)direction * gravDir, 18f, adjustedItemScale6);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 190)
		{
			Vector2 vector58 = MountedCenter + new Vector2(70f, -40f) * Directions;
			int npcTargetIndex3;
			bool zenithTarget2 = GetZenithTarget(vector58, 150f, out npcTargetIndex3);
			if (zenithTarget2)
			{
				NPC nPC4 = Main.npc[npcTargetIndex3];
				vector58 = Main.rand.NextVector2FromRectangle(nPC4.Hitbox);
			}
			else
			{
				vector58 += Main.rand.NextVector2Circular(20f, 20f);
			}
			Vector2 vector59 = base.Center + new Vector2(Main.rand.NextFloatDirection() * (float)width / 2f, height / 2) * Directions;
			Vector2 v6 = vector58 - vector59;
			float num178 = ((float)Math.PI + (float)Math.PI * 2f * Main.rand.NextFloat() * 1.5f) * ((float)(-direction) * gravDir);
			int num179 = 60;
			float num180 = num178 / (float)num179;
			float num181 = 16f;
			float num182 = v6.Length();
			if (Math.Abs(num180) >= 0.17f)
			{
				num180 *= 0.7f;
			}
			_ = direction;
			_ = gravDir;
			Vector2 vector60 = Vector2.UnitX * num181;
			Vector2 v7 = vector60;
			int num183 = 0;
			while (v7.Length() < num182 && num183 < num179)
			{
				num183++;
				v7 += vector60;
				vector60 = vector60.RotatedBy(num180);
			}
			float num184 = v7.ToRotation();
			Vector2 spinningpoint2 = v6.SafeNormalize(Vector2.UnitY).RotatedBy(0f - num184 - num180) * num181;
			if (num183 == num179)
			{
				spinningpoint2 = new Vector2(direction, 0f) * num181;
			}
			if (!zenithTarget2)
			{
				vector59.Y -= gravDir * 24f;
				spinningpoint2 = spinningpoint2.RotatedBy((float)direction * gravDir * ((float)Math.PI * 2f) * 0.14f);
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector59, spinningpoint2, projToShoot, (int)((double)Damage * 0.25), KnockBack, i, num180, num183);
			NetMessage.SendData(13, -1, -1, null, whoAmI);
			return;
		}
		if (sItem.type == 3475)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, 615, Damage, KnockBack, i, 5 * Main.rand.Next(0, 20));
			return;
		}
		if (sItem.type == 3930)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, 714, Damage, KnockBack, i, 5 * Main.rand.Next(0, 20));
			return;
		}
		if (sItem.type == 3540)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, 630, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 5451 || sItem.type == 5738)
		{
			for (int num185 = 0; num185 < 1000; num185++)
			{
				Projectile projectile4 = Main.projectile[num185];
				if (projectile4.type == projToShoot && projectile4.owner == whoAmI)
				{
					projectile4.Kill();
				}
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3854)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, 705, Damage, KnockBack, i);
			return;
		}
		if (sItem.type == 3546)
		{
			for (int num186 = 0; num186 < 2; num186++)
			{
				float num187 = num4;
				float num188 = num5;
				num187 += (float)Main.rand.Next(-40, 41) * 0.05f;
				num188 += (float)Main.rand.Next(-40, 41) * 0.05f;
				Vector2 vector61 = pointPosition + Vector2.Normalize(new Vector2(num187, num188).RotatedBy(-(float)Math.PI / 2f * (float)direction)) * 6f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, vector61.X, vector61.Y, num187, num188, 167 + Main.rand.Next(4), Damage, KnockBack, i, 0f, 1f);
			}
			return;
		}
		if (sItem.type == 3350)
		{
			float num189 = num4;
			float num190 = num5;
			num189 += (float)Main.rand.Next(-1, 2) * 0.5f;
			num190 += (float)Main.rand.Next(-1, 2) * 0.5f;
			if (Collision.CanHitLine(base.Center, 0, 0, pointPosition + new Vector2(num189, num190) * 2f, 0, 0))
			{
				pointPosition += new Vector2(num189, num190);
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y - gravDir * 4f, num189, num190, projToShoot, Damage, KnockBack, i, 0f, (float)Main.rand.Next(12) / 6f);
			return;
		}
		if (sItem.type == 3852)
		{
			if (altFunctionUse == 2)
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, base.Bottom.Y - 100f, (float)direction * speed, 0f, 704, (int)((float)Damage * 1.75f), KnockBack, i);
			}
			else
			{
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i);
			}
			return;
		}
		if (sItem.type == 3818 || sItem.type == 3819 || sItem.type == 3820 || sItem.type == 3824 || sItem.type == 3825 || sItem.type == 3826 || sItem.type == 3829 || sItem.type == 3830 || sItem.type == 3831 || sItem.type == 3832 || sItem.type == 3833 || sItem.type == 3834)
		{
			PayDD2CrystalsBeforeUse(sItem);
			FindSentryRestingSpot(sItem.shoot, out var worldX, out var worldY, out var pushYUp);
			int num191 = 0;
			int num192 = 0;
			int num193 = 0;
			switch (sItem.type)
			{
			case 3824:
			case 3825:
			case 3826:
				num191 = 1;
				num192 = Projectile.GetBallistraShotDelay(this);
				break;
			case 3832:
			case 3833:
			case 3834:
				num193 = Projectile.GetExplosiveTrapCooldown(this);
				break;
			case 3818:
				num191 = 1;
				num192 = 80;
				break;
			case 3819:
				num191 = 1;
				num192 = 70;
				break;
			case 3820:
				num191 = 1;
				num192 = 60;
				break;
			}
			int num194 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, worldX, worldY - pushYUp, 0f, 0f, projToShoot, Damage, KnockBack, i, num191, num192);
			Main.projectile[num194].originalDamage = damage;
			Main.projectile[num194].localAI[0] = num193;
			UpdateMaxTurrets();
			return;
		}
		if (sItem.type == 65)
		{
			Vector2 vector62 = new Vector2(num4, num5);
			new Vector2(100f, 0f);
			Vector2 mouseWorld2 = Main.MouseWorld;
			Vector2 vec = mouseWorld2;
			Vector2 vector63 = (pointPosition - mouseWorld2).SafeNormalize(new Vector2(0f, -1f));
			while (vec.Y > pointPosition.Y && WorldGen.SolidTile(vec.ToTileCoordinates()))
			{
				vec += vector63 * 16f;
			}
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition, vector62, projToShoot, Damage, KnockBack, i, 0f, vec.Y);
			return;
		}
		if (sItem.type == 4923)
		{
			float adjustedItemScale7 = GetAdjustedItemScale(sItem);
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, 0f, adjustedItemScale7);
			return;
		}
		if (sItem.type == 1910)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, 1f);
			return;
		}
		if (sItem.type == 5134)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, 0f, 1f);
			return;
		}
		if (sItem.type == 5495)
		{
			Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, 0f, 1f);
			return;
		}
		if (sItem.type == 5461)
		{
			if (killingCardFireType == 3)
			{
				bool flag9 = true;
				for (int num195 = 0; num195 < 1000; num195++)
				{
					Projectile projectile5 = Main.projectile[num195];
					if (projectile5.type == projToShoot && projectile5.owner == whoAmI && projectile5.ai[0] != 2f)
					{
						flag9 = false;
						break;
					}
				}
				if (flag9)
				{
					killingCardFireType = 0;
				}
			}
			float num196 = 1f;
			switch (killingCardFireType)
			{
			default:
				num196 = 1f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, (int)((float)Damage * num196), KnockBack, i, 0f, 0f, (float)(Main.rand.Next(2) * 2 - 1) * 0.4f);
				break;
			case 1:
				num196 = 1f;
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, (int)((float)Damage * num196), KnockBack, i, 0f, 0f, (float)(Main.rand.Next(2) * 2 - 1) * 0.4f);
				Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4 * -1f, num5 * -1f, projToShoot, (int)((float)Damage * num196), KnockBack, i, 0f, 0f, (float)(Main.rand.Next(2) * 2 - 1) * 0.4f);
				break;
			case 2:
			{
				num196 = 1f;
				float num198 = 6f;
				float num199 = num198 - 1f;
				float num200 = (float)Math.PI / 4f / num199;
				int num201 = -1;
				for (int num202 = 0; (float)num202 < num198; num202++)
				{
					Vector2 vector64 = new Vector2(num4, num5).RotatedBy(num200 * ((0f - num199) * 0.5f + (float)num202));
					Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, vector64.X, vector64.Y, projToShoot, (int)((float)Damage * num196), KnockBack, i, 0f, 0f, (float)num201 * 0.4f);
					if (Main.rand.Next(2) == 0)
					{
						num201 *= -1;
					}
				}
				break;
			}
			case 3:
			{
				for (int num197 = 0; num197 < 1000; num197++)
				{
					Projectile projectile6 = Main.projectile[num197];
					if (projectile6.type == projToShoot && projectile6.owner == whoAmI)
					{
						projectile6.velocity = Vector2.Zero;
						projectile6.ai[0] = 2f;
						projectile6.netUpdate = true;
						projectile6.ResetLocalNPCHitImmunity();
						projectile6.Damage();
					}
				}
				break;
			}
			}
			killingCardFireType++;
			if (killingCardFireType < 0 || killingCardFireType > 3)
			{
				killingCardFireType = 0;
			}
			return;
		}
		float ai9 = 0f;
		float ai10 = 0f;
		float ai11 = 0f;
		if (projToShoot == 88)
		{
			ai9 = Main.rand.Next(3, 6);
		}
		if (projToShoot == 80)
		{
			ai9 = tileTargetX;
			ai10 = tileTargetY;
		}
		if (projToShoot == 442)
		{
			ai9 = tileTargetX;
			ai10 = tileTargetY;
		}
		if (projToShoot == 826)
		{
			ai10 = Main.rand.Next(3);
		}
		if (sItem.type == 949)
		{
			ai10 = 1f;
		}
		if (sItem.type == 3772 || sItem.type == 3352)
		{
			ai9 = Main.rand.Next(-5, 1);
		}
		if (sItem.type == 2880)
		{
			ai9 = -1f;
		}
		if (projToShoot == 22)
		{
			ai11 = Main.rand.Next(0, 20000);
		}
		if (projToShoot == 26 || projToShoot == 35)
		{
			for (int num203 = 0; num203 < 50; num203++)
			{
				Item item = inventory[num203];
				if (!item.IsAir && item.shoot != projToShoot && (item.shoot == 26 || item.shoot == 35))
				{
					ai11 = 1f;
					Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, 0f - num4, 0f - num5, item.shoot, GetWeaponDamage(item), GetWeaponKnockback(item, item.knockBack), i, ai9, ai10, ai11);
					break;
				}
			}
		}
		int num204 = Projectile.NewProjectile(projectileSource_Item_WithPotentialAmmo, pointPosition.X, pointPosition.Y, num4, num5, projToShoot, Damage, KnockBack, i, ai9, ai10, ai11);
		if (sItem.type == 726)
		{
			Main.projectile[num204].magic = true;
		}
		if (sItem.type == 724 || sItem.type == 676)
		{
			Main.projectile[num204].melee = true;
		}
		if (sItem.type == 760)
		{
			DestroyOldestProximityMinesOverMinesCap(20);
		}
		if (Main.projectile[num204].aiStyle == 99)
		{
			AchievementsHelper.HandleSpecialEvent(this, 7);
		}
		if (Main.projectile[num204].aiStyle == 160 && Main.IsItAHappyWindyDay)
		{
			AchievementsHelper.HandleSpecialEvent(this, 17);
		}
		if (ItemID.Sets.ShootsOnUseRelease[sItem.type])
		{
			SetItemTime(itemAnimation);
			itemAnimation = 0;
		}
		NetMessage.SendData(13, -1, -1, null, whoAmI);
	}

	private void SpawnDigtoiseOnCursor(int owner, int shoot, IEntitySource projectileSource)
	{
		int num = (int)((float)Main.mouseX + Main.screenPosition.X) / 16;
		int y = (int)((float)Main.mouseY + Main.screenPosition.Y) / 16;
		if (gravDir == -1f)
		{
			y = (int)(Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY) / 16;
		}
		if (!TrySpawnDigtoiseAt(owner, shoot, projectileSource, num, y) && !TrySpawnDigtoiseAt(owner, shoot, projectileSource, num + 1, y))
		{
			TrySpawnDigtoiseAt(owner, shoot, projectileSource, num - 1, y);
		}
	}

	private static bool TrySpawnDigtoiseAt(int owner, int shoot, IEntitySource projectileSource, int x, int y)
	{
		while (y < Main.maxTilesY - 10 && !WorldGen.SolidTile(x, y) && !WorldGen.SolidTile(x - 1, y) && !WorldGen.SolidTile(x + 1, y))
		{
			y++;
		}
		for (int i = -1; i <= 1; i++)
		{
			for (int j = -2; j <= -1; j++)
			{
				if (WorldGen.SolidTile(x + i, y + j))
				{
					return false;
				}
			}
		}
		Projectile.NewProjectile(projectileSource, x * 16 + 8, y * 16 - 32, 0f, 15f, shoot, 0, 0f, owner);
		return true;
	}

	private void PickSentryLandingSpot(Item sItem, out float spawnX, out float spawnY)
	{
		bool num = sItem.type == 3571 || sItem.type == 3569 || sItem.type == 5463;
		int num2 = (int)((float)Main.mouseX + Main.screenPosition.X) / 16;
		int i = (int)((float)Main.mouseY + Main.screenPosition.Y) / 16;
		if (gravDir == -1f)
		{
			i = (int)(Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY) / 16;
		}
		if (!num)
		{
			for (; i < Main.maxTilesY - 10 && Main.tile[num2, i] != null && !WorldGen.SolidTile2(num2, i) && Main.tile[num2 - 1, i] != null && !WorldGen.SolidTile2(num2 - 1, i) && Main.tile[num2 + 1, i] != null && !WorldGen.SolidTile2(num2 + 1, i); i++)
			{
			}
			i--;
		}
		spawnX = (float)Main.mouseX + Main.screenPosition.X;
		spawnY = (float)i * 16f - 24f;
	}

	public Vector2 GetFarthestSpawnPositionOnLine(Vector2 startPos, float speedX, float speedY)
	{
		Vector2 pointPosition = Main.ReverseGravitySupport(Main.MouseScreen) + Main.screenPosition;
		LimitPointToPlayerReachableArea(ref pointPosition);
		int num = 0;
		float num2 = new Vector2(speedX, speedY).Length();
		float num3 = (pointPosition - startPos).Length();
		Vector2 center = base.Center;
		center.X += direction * 16;
		while (Collision.CanHitLine(center, 0, 0, startPos, 0, 0))
		{
			num++;
			startPos.X += speedX;
			startPos.Y += speedY;
			if ((startPos - pointPosition).Length() < 20f + Math.Abs(speedX) + Math.Abs(speedY))
			{
				startPos = pointPosition;
				break;
			}
			if (num2 * (float)num >= num3)
			{
				startPos = pointPosition;
				break;
			}
		}
		return startPos;
	}

	public int SpawnMinionOnCursor(IEntitySource projectileSource, int ownerIndex, int minionProjectileId, int originalDamageNotScaledByMinionDamage, float KnockBack, Vector2 offsetFromCursor = default(Vector2), Vector2 velocityOnSpawn = default(Vector2))
	{
		Vector2 pointPosition = Main.MouseWorld;
		pointPosition += offsetFromCursor;
		LimitPointToPlayerReachableArea(ref pointPosition);
		float ai = 0f;
		if (projectileSource is EntitySource_ItemUse entitySource_ItemUse)
		{
			switch (entitySource_ItemUse.Item.type)
			{
			case 1157:
				ai = 60f;
				break;
			case 2364:
			case 2365:
			case 2535:
			case 2621:
			case 2749:
			case 3474:
				ai = 1f;
				break;
			}
		}
		int num = Projectile.NewProjectile(projectileSource, pointPosition, velocityOnSpawn, minionProjectileId, originalDamageNotScaledByMinionDamage, KnockBack, ownerIndex, 0f, ai);
		Main.projectile[num].originalDamage = originalDamageNotScaledByMinionDamage;
		return num;
	}

	private Point FindSharpTearsSpot(Vector2 targetSpot)
	{
		Point point = targetSpot.ToTileCoordinates();
		Vector2 center = base.Center;
		Vector2 endPoint = targetSpot;
		int samplesToTake = 3;
		float samplingWidth = 4f;
		Collision.AimingLaserScan(center, endPoint, samplingWidth, samplesToTake, out var vectorTowardsTarget, out var samples);
		float num = float.PositiveInfinity;
		for (int i = 0; i < samples.Length; i++)
		{
			if (samples[i] < num)
			{
				num = samples[i];
			}
		}
		targetSpot = center + vectorTowardsTarget.SafeNormalize(Vector2.Zero) * num;
		point = targetSpot.ToTileCoordinates();
		Rectangle value = new Rectangle(point.X, point.Y, 1, 1);
		value.Inflate(6, 16);
		Rectangle value2 = new Rectangle(0, 0, Main.maxTilesX, Main.maxTilesY);
		value2.Inflate(-40, -40);
		value = Rectangle.Intersect(value, value2);
		List<Point> list = new List<Point>();
		List<Point> list2 = new List<Point>();
		for (int j = value.Left; j <= value.Right; j++)
		{
			for (int k = value.Top; k <= value.Bottom; k++)
			{
				if (!WorldGen.SolidTile2(j, k))
				{
					continue;
				}
				Vector2 value3 = new Vector2(j * 16 + 8, k * 16 + 8);
				if (!(Vector2.Distance(targetSpot, value3) > 200f))
				{
					if (FindSharpTearsOpening(j, k, j > point.X, j < point.X, k > point.Y, k < point.Y))
					{
						list.Add(new Point(j, k));
					}
					else
					{
						list2.Add(new Point(j, k));
					}
				}
			}
		}
		if (list.Count == 0 && list2.Count == 0)
		{
			list.Add((base.Center.ToTileCoordinates().ToVector2() + Main.rand.NextVector2Square(-2f, 2f)).ToPoint());
		}
		List<Point> list3 = list;
		if (list3.Count == 0)
		{
			list3 = list2;
		}
		int index = Main.rand.Next(list3.Count);
		return list3[index];
	}

	private bool FindSharpTearsOpening(int x, int y, bool acceptLeft, bool acceptRight, bool acceptUp, bool acceptDown)
	{
		if (acceptLeft && !WorldGen.SolidTile(x - 1, y))
		{
			return true;
		}
		if (acceptRight && !WorldGen.SolidTile(x + 1, y))
		{
			return true;
		}
		if (acceptUp && !WorldGen.SolidTile(x, y - 1))
		{
			return true;
		}
		if (acceptDown && !WorldGen.SolidTile(x, y + 1))
		{
			return true;
		}
		return false;
	}

	public bool TryPlacingAGolfBallNearANearbyTee(Vector2 placePosition)
	{
		TileReachCheckSettings.Simple.GetTileRegion(this, out var LX, out var LY, out var HX, out var HY);
		LX = Utils.Clamp(LX, 10, Main.maxTilesX - 10);
		HX = Utils.Clamp(HX, 10, Main.maxTilesX - 10);
		LY = Utils.Clamp(LY, 10, Main.maxTilesY - 10);
		HY = Utils.Clamp(HY, 10, Main.maxTilesY - 10);
		Vector2 value = Main.screenPosition + new Vector2(Main.mouseX, Main.mouseY);
		if (gravDir == -1f)
		{
			value.Y = Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY;
		}
		Point point = placePosition.ToTileCoordinates();
		List<Tuple<int, int>> list = new List<Tuple<int, int>>();
		for (int i = -2; i <= 2; i++)
		{
			for (int j = -2; j <= 2; j++)
			{
				int num = point.X + i;
				int num2 = point.Y + j;
				if (WorldGen.InWorld(num, num2, 1))
				{
					Tile tileSafely = Framing.GetTileSafely(num, num2);
					if (tileSafely.active() && tileSafely.type == 494)
					{
						list.Add(new Tuple<int, int>(num, num2));
						break;
					}
				}
			}
		}
		bool result = false;
		if (list.Count > 0)
		{
			float num3 = -1f;
			Tuple<int, int> tuple = list[0];
			for (int k = 0; k < list.Count; k++)
			{
				float num4 = Vector2.Distance(new Vector2(list[k].Item1, list[k].Item2) * 16f + Vector2.One * 8f, value);
				if (num3 == -1f || num4 < num3)
				{
					num3 = num4;
					tuple = list[k];
				}
			}
			if (Collision.InTileBounds(tuple.Item1, tuple.Item2, LX, LY, HX, HY))
			{
				result = true;
				for (int l = 0; l < 1000; l++)
				{
					if (ProjectileID.Sets.IsAGolfBall[Main.projectile[l].type] && Main.projectile[l].owner == whoAmI)
					{
						Main.projectile[l].Kill();
					}
				}
				GetPreferredGolfBallToUse(out var projType);
				Projectile.NewProjectile(GetProjectileSource_TileInteraction(tuple.Item1, tuple.Item2), (float)(tuple.Item1 * 16) + 8.5f, tuple.Item2 * 16 + 6, 0f, 0f, projType, 0, 0f, whoAmI, 0f, -1f);
			}
		}
		return result;
	}

	public void GetPreferredGolfBallToUse(out int projType)
	{
		projType = 721;
		Item item = inventory[selectedItem];
		if (!item.IsAir && item.shoot > 0 && ProjectileID.Sets.IsAGolfBall[item.shoot])
		{
			projType = item.shoot;
			return;
		}
		for (int num = 19; num >= 0; num--)
		{
			if (IsItemSlotUnlockedAndUsable(num))
			{
				_ = num % 10;
				Item item2 = armor[num];
				if (!item2.IsAir && item2.shoot > 0 && ProjectileID.Sets.IsAGolfBall[item2.shoot])
				{
					projType = item2.shoot;
					return;
				}
			}
		}
		for (int i = 0; i < 50; i++)
		{
			Item item3 = inventory[i];
			if (!item3.IsAir && item3.shoot > 0 && ProjectileID.Sets.IsAGolfBall[item3.shoot])
			{
				projType = item3.shoot;
				break;
			}
		}
	}

	private void ItemCheck_MinionAltFeatureUse(Item sItem, bool cShoot)
	{
		if (sItem.shoot > 0 && ProjectileID.Sets.MinionTargettingFeature[sItem.shoot] && altFunctionUse == 2 && cShoot && ItemTimeIsZero)
		{
			ApplyItemTime(sItem);
			MinionNPCTargetAim(doNotDisableIfTheTargetIsTheSame: false);
		}
	}

	private void ItemCheck_TurretAltFeatureUse(Item sItem, bool cShoot)
	{
		if (sItem.shoot <= 0 || !ProjectileID.Sets.TurretFeature[sItem.shoot] || altFunctionUse != 2 || !cShoot || !ItemTimeIsZero)
		{
			return;
		}
		ApplyItemTime(sItem);
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.owner == Main.myPlayer && ProjectileID.Sets.TurretFeature[projectile.type])
			{
				projectile.Kill();
			}
		}
	}

	private void EmitMaxManaEffect()
	{
		SoundEngine.PlaySound(25);
		for (int i = 0; i < 5; i++)
		{
			int num = Dust.NewDust(position, width, height, 45, 0f, 0f, 255, default(Color), (float)Main.rand.Next(20, 26) * 0.1f);
			Main.dust[num].noLight = true;
			Main.dust[num].noGravity = true;
			Main.dust[num].velocity *= 0.5f;
		}
	}

	public void ItemCheck_EmitHeldItemLight(Item sItem)
	{
		float num = 1f;
		bool flag = stealth >= 1f;
		Vector2? handPosition = HandPosition;
		Vector2 pos = Vector2.Zero;
		ApplyItemPositionOffsetFromMount(ref pos);
		if (((ItemID.Sets.Torches[sItem.type] && !wet) || ItemID.Sets.WaterTorches[sItem.type]) && !pulley && !happyFunTorchTime)
		{
			float R = 1f;
			float G = 0.95f;
			float B = 0.8f;
			int num2 = 0;
			int num3 = BiomeTorchHoldStyle(sItem.type);
			if (num3 == 523)
			{
				num2 = 8;
			}
			else if (num3 == 974)
			{
				num2 = 9;
			}
			else if (num3 == 1245)
			{
				num2 = 10;
			}
			else if (num3 == 1333)
			{
				num2 = 11;
			}
			else if (num3 == 2274)
			{
				num2 = 12;
			}
			else if (num3 == 3004)
			{
				num2 = 13;
			}
			else if (num3 == 3045)
			{
				num2 = 14;
			}
			else if (num3 == 3114)
			{
				num2 = 15;
			}
			else if (num3 == 4383)
			{
				num2 = 16;
			}
			else if (num3 == 4384)
			{
				num2 = 17;
			}
			else if (num3 == 4385)
			{
				num2 = 18;
			}
			else if (num3 == 4386)
			{
				num2 = 19;
			}
			else if (num3 == 4387)
			{
				num2 = 20;
			}
			else if (num3 == 4388)
			{
				num2 = 21;
			}
			else if (num3 == 5293)
			{
				num2 = 22;
			}
			else if (num3 == 5353)
			{
				num2 = 23;
			}
			else if (num3 >= 427)
			{
				num2 = num3 - 426;
			}
			num2 = (int)MathHelper.Clamp(num2, 0f, TorchID.Count - 1);
			TorchID.TorchColor(num2, out R, out G, out B);
			int num4 = TorchID.Dust[num2];
			int maxValue = 30;
			if (itemAnimation > 0)
			{
				maxValue = 7;
			}
			if (direction == -1)
			{
				if (flag && Main.rand.Next(maxValue) == 0)
				{
					int num5 = Dust.NewDust(new Vector2(itemLocation.X - 16f, itemLocation.Y - 14f * gravDir) + pos, 4, 4, num4, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num5].noGravity = true;
					}
					Main.dust[num5].velocity *= 0.3f;
					Main.dust[num5].velocity.Y -= 1.5f;
					Main.dust[num5].position = RotatedRelativePoint(Main.dust[num5].position);
					if (num4 == 66)
					{
						Main.dust[num5].color = new Color(Main.DiscoR, Main.DiscoG, Main.DiscoB);
						Main.dust[num5].noGravity = true;
					}
				}
				Vector2 pos2 = new Vector2(itemLocation.X - 12f + velocity.X, itemLocation.Y - 14f + velocity.Y) + pos;
				pos2 = RotatedRelativePoint(pos2);
				R *= num;
				G *= num;
				B *= num;
				Lighting.AddLight(pos2, R, G, B);
			}
			else
			{
				if (flag && Main.rand.Next(maxValue) == 0)
				{
					int num6 = Dust.NewDust(new Vector2(itemLocation.X + 6f, itemLocation.Y - 14f * gravDir) + pos, 4, 4, num4, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num6].noGravity = true;
					}
					Main.dust[num6].velocity *= 0.3f;
					Main.dust[num6].velocity.Y -= 1.5f;
					Main.dust[num6].position = RotatedRelativePoint(Main.dust[num6].position);
					if (num4 == 66)
					{
						Main.dust[num6].color = new Color(Main.DiscoR, Main.DiscoG, Main.DiscoB);
						Main.dust[num6].noGravity = true;
					}
				}
				Vector2 pos3 = new Vector2(itemLocation.X + 12f + velocity.X, itemLocation.Y - 14f + velocity.Y) + pos;
				pos3 = RotatedRelativePoint(pos3);
				R *= num;
				G *= num;
				B *= num;
				Lighting.AddLight(pos3, R, G, B);
			}
		}
		if ((sItem.type == 105 || sItem.type == 713) && !wet && !pulley)
		{
			int maxValue2 = 20;
			if (itemAnimation > 0)
			{
				maxValue2 = 7;
			}
			if (direction == -1)
			{
				if (flag && Main.rand.Next(maxValue2) == 0)
				{
					int num7 = Dust.NewDust(new Vector2(itemLocation.X - 12f, itemLocation.Y - 20f * gravDir) + pos, 4, 4, 6, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num7].noGravity = true;
					}
					Main.dust[num7].velocity *= 0.3f;
					Main.dust[num7].velocity.Y -= 1.5f;
					Main.dust[num7].position = RotatedRelativePoint(Main.dust[num7].position);
				}
				Vector2 pos4 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos4 = RotatedRelativePoint(pos4);
				float r = 1f * num;
				float g = 0.95f * num;
				float b = 0.8f * num;
				Lighting.AddLight(pos4, r, g, b);
			}
			else
			{
				if (flag && Main.rand.Next(maxValue2) == 0)
				{
					int num8 = Dust.NewDust(new Vector2(itemLocation.X + 4f, itemLocation.Y - 20f * gravDir) + pos, 4, 4, 6, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num8].noGravity = true;
					}
					Main.dust[num8].velocity *= 0.3f;
					Main.dust[num8].velocity.Y -= 1.5f;
					Main.dust[num8].position = RotatedRelativePoint(Main.dust[num8].position);
				}
				Vector2 pos5 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos5 = RotatedRelativePoint(pos5);
				float r2 = 1f * num;
				float g2 = 0.95f * num;
				float b2 = 0.8f * num;
				Lighting.AddLight(pos5, r2, g2, b2);
			}
		}
		else if (sItem.type == 148 && !pulley)
		{
			int maxValue3 = 10;
			if (itemAnimation > 0)
			{
				maxValue3 = 7;
			}
			if (direction == -1)
			{
				if (flag && Main.rand.Next(maxValue3) == 0)
				{
					int num9 = Dust.NewDust(new Vector2(itemLocation.X - 12f, itemLocation.Y - 20f * gravDir) + pos, 4, 4, 172, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num9].noGravity = true;
					}
					Main.dust[num9].velocity *= 0.3f;
					Main.dust[num9].velocity.Y -= 1.5f;
					Main.dust[num9].position = RotatedRelativePoint(Main.dust[num9].position);
				}
				Vector2 pos6 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos6 = RotatedRelativePoint(pos6);
				float r3 = 0f;
				float g3 = 0.5f * num;
				float b3 = 1f * num;
				Lighting.AddLight(pos6, r3, g3, b3);
			}
			else
			{
				if (flag && Main.rand.Next(maxValue3) == 0)
				{
					int num10 = Dust.NewDust(new Vector2(itemLocation.X + 4f, itemLocation.Y - 20f * gravDir) + pos, 4, 4, 172, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num10].noGravity = true;
					}
					Main.dust[num10].velocity *= 0.3f;
					Main.dust[num10].velocity.Y -= 1.5f;
					Main.dust[num10].position = RotatedRelativePoint(Main.dust[num10].position);
				}
				Vector2 pos7 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos7 = RotatedRelativePoint(pos7);
				float r4 = 0f;
				float g4 = 0.5f * num;
				float b4 = 1f * num;
				Lighting.AddLight(pos7, r4, g4, b4);
			}
		}
		else if (sItem.type == 3117 && !wet && !pulley)
		{
			itemLocation.X -= direction * 4;
			int maxValue4 = 10;
			if (itemAnimation > 0)
			{
				maxValue4 = 7;
			}
			if (direction == -1)
			{
				if (flag && Main.rand.Next(maxValue4) == 0)
				{
					int num11 = Dust.NewDust(new Vector2(itemLocation.X - 10f, itemLocation.Y - 20f * gravDir), 4, 4, 242, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num11].noGravity = true;
					}
					Main.dust[num11].velocity *= 0.3f;
					Main.dust[num11].velocity.Y -= 1.5f;
					Main.dust[num11].position = RotatedRelativePoint(Main.dust[num11].position);
				}
				Vector2 vector = RotatedRelativePoint(new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f));
				float r5 = 0.9f * num;
				float g5 = 0.1f * num;
				float b5 = 0.75f * num;
				Lighting.AddLight(vector, r5, g5, b5);
			}
			else
			{
				if (flag && Main.rand.Next(maxValue4) == 0)
				{
					int num12 = Dust.NewDust(new Vector2(itemLocation.X + 6f, itemLocation.Y - 20f * gravDir), 4, 4, 242, 0f, 0f, 100);
					if (Main.rand.Next(3) != 0)
					{
						Main.dust[num12].noGravity = true;
					}
					Main.dust[num12].velocity *= 0.3f;
					Main.dust[num12].velocity.Y -= 1.5f;
					Main.dust[num12].position = RotatedRelativePoint(Main.dust[num12].position);
				}
				Vector2 vector2 = RotatedRelativePoint(new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f));
				float r6 = 0.9f * num;
				float g6 = 0.1f * num;
				float b6 = 0.75f * num;
				Lighting.AddLight(vector2, r6, g6, b6);
			}
		}
		else if (sItem.type == 5322 && !wet && !pulley)
		{
			float r7 = 0.2f * num;
			float g7 = 0.3f * num;
			float b7 = 0.32f * num;
			if (direction == -1)
			{
				Lighting.AddLight(RotatedRelativePoint(new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f)), r7, g7, b7);
			}
			else
			{
				Lighting.AddLight(RotatedRelativePoint(new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f)), r7, g7, b7);
			}
		}
		if (sItem.type == 282 && !pulley)
		{
			if (direction == -1)
			{
				Vector2 pos8 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos8 = RotatedRelativePoint(pos8);
				float r8 = 0.7f * num;
				float g8 = 1f * num;
				float b8 = 0.8f * num;
				Lighting.AddLight(pos8, r8, g8, b8);
			}
			else
			{
				Vector2 pos9 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos9 = RotatedRelativePoint(pos9);
				float r9 = 0.7f * num;
				float g9 = 1f * num;
				float b9 = 0.8f * num;
				Lighting.AddLight(pos9, r9, g9, b9);
			}
		}
		if (sItem.type == 3002 && !pulley)
		{
			float r10 = 1.05f * num;
			float g10 = 0.95f * num;
			float b10 = 0.55f * num;
			if (direction == -1)
			{
				Vector2 pos10 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos10 = RotatedRelativePoint(pos10);
				Lighting.AddLight(pos10, r10, g10, b10);
			}
			else
			{
				Vector2 pos11 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos11 = RotatedRelativePoint(pos11);
				Lighting.AddLight(pos11, r10, g10, b10);
			}
			spelunkerTimer++;
			if (spelunkerTimer >= 10)
			{
				spelunkerTimer = 0;
				Main.instance.SpelunkerProjectileHelper.AddSpotToCheck(base.Center);
			}
		}
		if (sItem.type == 286 && !pulley)
		{
			if (direction == -1)
			{
				Vector2 pos12 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos12 = RotatedRelativePoint(pos12);
				float r11 = 0.7f * num;
				float g11 = 0.8f * num;
				float b11 = 1f * num;
				Lighting.AddLight(pos12, r11, g11, b11);
			}
			else
			{
				Vector2 pos13 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos13 = RotatedRelativePoint(pos13);
				float r12 = 0.7f * num;
				float g12 = 0.8f * num;
				float b12 = 1f * num;
				Lighting.AddLight(pos13, r12, g12, b12);
			}
		}
		if (sItem.type == 3112 && !pulley)
		{
			if (direction == -1)
			{
				Vector2 pos14 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos14 = RotatedRelativePoint(pos14);
				float r13 = 1f * num;
				float g13 = 0.6f * num;
				float b13 = 0.85f * num;
				Lighting.AddLight(pos14, r13, g13, b13);
			}
			else
			{
				Vector2 pos15 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos15 = RotatedRelativePoint(pos15);
				float r14 = 1f * num;
				float g14 = 0.6f * num;
				float b14 = 0.85f * num;
				Lighting.AddLight(pos15, r14, g14, b14);
			}
		}
		if (sItem.type == 4776 && !pulley)
		{
			Vector2 pos16 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
			if (direction == -1)
			{
				pos16 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
			}
			pos16 = RotatedRelativePoint(pos16);
			Vector3 rgb = (DelegateMethods.v3_1 = new Vector3(0.9f * num, 0.35f * num, 1f * num));
			Point point = pos16.ToTileCoordinates();
			DelegateMethods.v2_1 = point.ToVector2();
			DelegateMethods.f_1 = 4.5f;
			Utils.FloodFillTile(point, 4.5f, DelegateMethods.SpreadLightOpen_StopForSolids);
			Lighting.AddLight(pos16, rgb);
		}
		if (sItem.type == 5643 && !pulley)
		{
			float r15 = (float)Main.DiscoR / 255f * num;
			float g15 = (float)Main.DiscoG / 255f * num;
			float b15 = (float)Main.DiscoB / 255f * num;
			if (direction == -1)
			{
				Vector2 pos17 = new Vector2(itemLocation.X - 16f + velocity.X, itemLocation.Y - 14f) + pos;
				pos17 = RotatedRelativePoint(pos17);
				Lighting.AddLight(pos17, r15, g15, b15);
			}
			else
			{
				Vector2 pos18 = new Vector2(itemLocation.X + 6f + velocity.X, itemLocation.Y - 14f) + pos;
				pos18 = RotatedRelativePoint(pos18);
				Lighting.AddLight(pos18, r15, g15, b15);
			}
		}
		if (sItem.type == 3542 && handPosition.HasValue && flag)
		{
			Vector2 vector3 = handPosition.Value - velocity;
			for (int i = 0; i < 4; i++)
			{
				Dust dust = Main.dust[Dust.NewDust(base.Center, 0, 0, 242, direction * 2, 0f, 150, default(Color), 1.3f)];
				dust.position = vector3;
				dust.velocity *= 0f;
				dust.noGravity = true;
				dust.fadeIn = 1f;
				dust.velocity += velocity;
				if (Main.rand.Next(2) == 0)
				{
					dust.position += Utils.RandomVector2(Main.rand, -4f, 4f);
					dust.scale += Main.rand.NextFloat();
					if (Main.rand.Next(2) == 0)
					{
						dust.customData = this;
					}
				}
			}
		}
		if (sItem.type != 4952 || pulley || petting.isPetting)
		{
			return;
		}
		Vector2 pos19 = itemLocation + new Vector2(8 * direction, -10f * gravDir) + pos;
		Vector3 rgb2 = new Vector3(1f * num, 0.7f * num, 0.8f * num) * 1.3f;
		Vector2 vector4 = RotatedRelativePoint(pos19);
		Lighting.AddLight(vector4, rgb2);
		if (flag && Main.rand.Next(40) == 0)
		{
			Vector2 vector5 = Main.rand.NextVector2Circular(4f, 4f);
			Dust dust2 = Dust.NewDustPerfect(vector4 + vector5, 43, Vector2.Zero, 254, new Color(255, 255, 0, 255), 0.3f);
			if (vector5 != Vector2.Zero)
			{
				dust2.velocity = vector4.DirectionTo(dust2.position) * 0.2f;
			}
			dust2.fadeIn = 0.3f;
			dust2.noLightEmittence = true;
			dust2.customData = this;
		}
	}

	public bool CanVisuallyHoldItem(Item item)
	{
		if (mount.Active && !mount.CanVisuallyHoldItem(this, item))
		{
			return false;
		}
		if (item.holdStyle == 4)
		{
			if (petting.isPetting)
			{
				return false;
			}
			if (pulley)
			{
				return false;
			}
			if (gravDir == -1f)
			{
				return false;
			}
			if (velocity.Y != 0f)
			{
				return false;
			}
			if (mount.Active)
			{
				return false;
			}
		}
		if (item.holdStyle == 6 && petting.isPetting)
		{
			return false;
		}
		if (item.holdStyle == 5 && petting.isPetting)
		{
			return false;
		}
		if (item.holdStyle == 8 && spectating < 0)
		{
			return false;
		}
		return true;
	}

	private void ItemCheck_ApplyHoldStyle(float mountOffset, Item sItem, Rectangle heldItemFrame)
	{
		bool flag = !isDisplayDollOrInanimate;
		if (petting.isPetting)
		{
			if (mount.Active && (mount.Type == 62 || mount.Type == 63))
			{
				int num = miscCounter % 14 / 7;
				CompositeArmStretchAmount stretch = CompositeArmStretchAmount.ThreeQuarters;
				if (num == 1)
				{
					stretch = CompositeArmStretchAmount.Full;
				}
				float num2 = 0.36f;
				SetCompositeArmBack(enabled: true, stretch, (float)Math.PI * -2f * num2 * (float)direction);
			}
			else
			{
				int num3 = miscCounter % 14 / 7;
				CompositeArmStretchAmount stretch2 = CompositeArmStretchAmount.ThreeQuarters;
				if (num3 == 1)
				{
					stretch2 = CompositeArmStretchAmount.Full;
				}
				float num4 = 0.3f;
				if (petting.isPetSmall)
				{
					num4 = 0.2f;
				}
				SetCompositeArmBack(enabled: true, stretch2, (float)Math.PI * -2f * num4 * (float)direction);
			}
		}
		if (!CanVisuallyHoldItem(sItem))
		{
			return;
		}
		if (sItem.holdStyle == 1 && !pulley)
		{
			if (Main.dedServ)
			{
				itemLocation.X = position.X + (float)width * 0.5f + 20f * (float)direction;
			}
			else if (sItem.type == 930)
			{
				itemLocation.X = position.X + (float)width * 0.5f - (float)(2 * direction);
				float x = position.X + (float)(width / 2) + (float)(38 * direction);
				if (direction == 1)
				{
					x -= 10f;
				}
				float y = MountedCenter.Y - 4f * gravDir;
				if (gravDir == -1f)
				{
					y -= 8f;
				}
				RotateRelativePoint(ref x, ref y);
				int num5 = 0;
				for (int i = 54; i < 58; i++)
				{
					if (inventory[i].stack > 0 && inventory[i].ammo == 931)
					{
						num5 = inventory[i].type;
						break;
					}
				}
				if (num5 == 0)
				{
					for (int j = 0; j < 54; j++)
					{
						if (inventory[j].stack > 0 && inventory[j].ammo == 931)
						{
							num5 = inventory[j].type;
							break;
						}
					}
				}
				switch (num5)
				{
				case 931:
					num5 = 127;
					break;
				case 1614:
					num5 = 187;
					break;
				case 5377:
					num5 = 169;
					break;
				case 5378:
					num5 = 75;
					break;
				case 5379:
					num5 = 66;
					break;
				case 5380:
					num5 = 310;
					break;
				}
				if (num5 > 0)
				{
					int num6 = Dust.NewDust(new Vector2(x, y + gfxOffY), 6, 6, num5, 0f, 0f, 100, default(Color), 1.6f);
					Main.dust[num6].noGravity = true;
					Main.dust[num6].velocity.Y -= 4f * gravDir;
					if (num5 == 66)
					{
						Main.dust[num6].color = Main.hslToRgb(Main.GlobalTimeWrappedHourly * 0.6f % 1f, 1f, 0.5f);
						Main.dust[num6].scale *= 0.5f;
						Main.dust[num6].velocity *= 0.75f;
					}
				}
			}
			else if (sItem.type == 968)
			{
				itemLocation.X = position.X + (float)width * 0.5f + (float)(8 * direction);
				if (whoAmI == Main.myPlayer && flag)
				{
					int num7 = (int)(itemLocation.X + (float)heldItemFrame.Width * 0.8f * (float)direction) / 16;
					int num8 = (int)(itemLocation.Y + mountOffset + (float)(heldItemFrame.Height / 2)) / 16;
					if (Main.tile[num7, num8] == null)
					{
						Main.tile[num7, num8] = new Tile();
					}
					if (Main.tile[num7, num8].active() && TileID.Sets.Campfires[Main.tile[num7, num8].type] && Main.tile[num7, num8].frameY < 54)
					{
						miscTimer++;
						if (Main.rand.Next(5) == 0)
						{
							miscTimer++;
						}
						if (miscTimer > 900)
						{
							miscTimer = 0;
							QuickSpawnItem(GetItemSource_Item(sItem), 969);
							sItem.stack--;
							if (sItem.stack == 0)
							{
								sItem.TurnToAir();
							}
							if (selectedItem == 58)
							{
								Main.mouseItem.stack--;
								if (Main.mouseItem.stack == 0)
								{
									Main.mouseItem.TurnToAir();
								}
							}
						}
					}
					else
					{
						miscTimer = 0;
					}
				}
			}
			else if (sItem.type == 856)
			{
				itemLocation.X = position.X + (float)width * 0.5f + (float)(4 * direction);
			}
			else if (sItem.fishingPole > 0)
			{
				itemLocation.X = position.X + (float)width * 0.5f + (float)((int)((float)heldItemFrame.Width * 0.18f) * direction);
			}
			else
			{
				itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f + 2f) * (float)direction;
				if (sItem.type == 282 || sItem.type == 286 || sItem.type == 3112 || sItem.type == 4776 || sItem.type == 5643)
				{
					itemLocation.X -= direction * 2;
					itemLocation.Y += 4f;
				}
				else if (sItem.type == 3002)
				{
					itemLocation.X -= 4 * direction;
					itemLocation.Y += 2f;
				}
			}
			itemLocation.Y = position.Y + 24f + mountOffset;
			if (sItem.type == 1304)
			{
				itemLocation.X = position.X + (float)width * 0.5f + (float)(6 * direction);
				itemLocation.Y += 2f;
			}
			if (sItem.type == 856)
			{
				itemLocation.Y = position.Y + 34f + mountOffset;
			}
			if (sItem.type == 930)
			{
				itemLocation.Y = position.Y + 9f + mountOffset;
			}
			if (sItem.fishingPole > 0)
			{
				itemLocation.Y += 4f;
			}
			else if (sItem.type == 3476)
			{
				itemLocation.X = base.Center.X + (float)(14 * direction);
				itemLocation.Y = MountedCenter.Y;
			}
			else if (sItem.type == 3779)
			{
				itemLocation.X = base.Center.X + (float)(6 * direction);
				itemLocation.Y = MountedCenter.Y + 6f;
			}
			else if (sItem.type == 4952)
			{
				itemLocation.X = base.Center.X + (float)(2 * direction);
				itemLocation.Y = MountedCenter.Y + 26f;
			}
			else if (sItem.type == 353)
			{
				itemLocation.X = base.Center.X + (float)(6 * direction);
				itemLocation.Y = MountedCenter.Y + 11f;
			}
			else if (ItemID.Sets.IsFood[sItem.type])
			{
				itemLocation.X = base.Center.X + (float)(4 * direction);
				itemLocation.Y = MountedCenter.Y + (float)(heldItemFrame.Height / 2);
			}
			else if (sItem.type == 4049 && stealth >= 1f && Main.rand.Next(4) == 0)
			{
				Dust dust = Dust.NewDustPerfect(base.Center + new Vector2(direction * 23, gravDir * 6f), 31, Vector2.Zero, 127, default(Color), 0.7f);
				dust.noGravity = true;
				dust.velocity = Main.rand.NextVector2Circular(1f, 1f) + new Vector2(0f, -1f);
			}
			itemRotation = 0f;
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y) + mountOffset;
				if (sItem.type == 930)
				{
					itemLocation.Y -= 24f;
				}
			}
		}
		else if (sItem.holdStyle == 2 && !pulley)
		{
			if (sItem.type == 946 || sItem.type == 4707)
			{
				itemRotation = 0f;
				itemLocation.X = position.X + (float)width * 0.5f - (float)(16 * direction);
				itemLocation.Y = position.Y + 22f + mountOffset;
				if (flag)
				{
					fallStart = (int)(position.Y / 16f);
				}
				if (gravDir == -1f)
				{
					itemRotation = 0f - itemRotation;
					itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
					if (velocity.Y < -2f && !controlDown)
					{
						velocity.Y = -2f;
					}
				}
				else if (velocity.Y > 2f && !controlDown)
				{
					velocity.Y = 2f;
				}
			}
			else
			{
				itemLocation.X = position.X + (float)width * 0.5f + (float)(6 * direction);
				itemLocation.Y = position.Y + 16f + mountOffset;
				itemRotation = 0.79f * (float)(-direction);
				if (gravDir == -1f)
				{
					itemRotation = 0f - itemRotation;
					itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
				}
			}
		}
		else if (sItem.holdStyle == 3 && !pulley)
		{
			if (!Main.dedServ)
			{
				itemLocation.X = position.X + (float)width * 0.5f - (float)(direction * 2);
				itemLocation.Y = MountedCenter.Y - (float)heldItemFrame.Height * 0.5f;
				itemRotation = 0f;
			}
		}
		else if (sItem.holdStyle == 4)
		{
			if (!Main.dedServ)
			{
				float num9 = new Vector2(10 * direction, 10f).ToRotation() + (float)Math.PI / 4f;
				itemRotation = num9;
				if (direction == -1)
				{
					itemRotation += (float)Math.PI / 2f;
				}
				CompositeArmStretchAmount stretch3 = CompositeArmStretchAmount.Full;
				CompositeArmStretchAmount stretch4 = CompositeArmStretchAmount.ThreeQuarters;
				float num10 = -(float)Math.PI / 10f;
				if (direction == -1)
				{
					num10 *= -1f;
				}
				float num11 = itemRotation - (float)Math.PI / 4f + (float)Math.PI;
				if (direction == 1)
				{
					num11 += (float)Math.PI / 2f;
				}
				float rotation = num11 + num10;
				float rotation2 = num11 - num10;
				Vector2 vector = (num11 + (float)Math.PI / 2f).ToRotationVector2() * 2f;
				itemLocation = MountedCenter.Floor() + vector;
				SetCompositeArmFront(enabled: true, stretch3, rotation);
				SetCompositeArmBack(enabled: true, stretch4, rotation2);
				FlipItemLocationAndRotationForGravity();
			}
		}
		else if (sItem.holdStyle == 5 && !pulley)
		{
			if (!Main.dedServ)
			{
				itemRotation = 0f;
				itemLocation.X = base.Center.X - (float)(8 * direction);
				itemLocation.Y = position.Y + 40f + mountOffset;
				Vector2 vector2 = Main.OffsetsPlayerHeadgear[bodyFrame.Y / 56];
				itemLocation += vector2;
				CompositeArmStretchAmount stretch5 = CompositeArmStretchAmount.Quarter;
				SetCompositeArmBack(enabled: true, stretch5, -(float)Math.PI / 4f * (float)direction);
				CompositeArmStretchAmount stretch6 = CompositeArmStretchAmount.Full;
				SetCompositeArmFront(enabled: true, stretch6, -0.39269912f * (float)direction);
				FlipItemLocationAndRotationForGravity();
			}
		}
		else if (sItem.holdStyle == 6 && !pulley)
		{
			if (!Main.dedServ)
			{
				itemRotation = 0f;
				itemLocation.X = base.Center.X + (float)(8 * direction);
				itemLocation.Y = position.Y + 40f + mountOffset - 2f;
				Vector2 vector3 = Main.OffsetsPlayerHeadgear[bodyFrame.Y / 56];
				itemLocation += vector3;
				CompositeArmStretchAmount stretch7 = CompositeArmStretchAmount.ThreeQuarters;
				SetCompositeArmBack(enabled: true, stretch7, (float)Math.PI * -3f / 5f * (float)direction);
				FlipItemLocationAndRotationForGravity();
			}
		}
		else if (sItem.holdStyle == 8)
		{
			itemRotation = 0f;
			itemLocation.X = base.Center.X + (float)(6 * direction);
			itemLocation.Y = position.Y + 30f + mountOffset - 2f;
			Vector2 vector4 = Main.OffsetsPlayerHeadgear[bodyFrame.Y / 56];
			itemLocation += vector4;
			SetCompositeArmBack(enabled: true, CompositeArmStretchAmount.ThreeQuarters, (float)Math.PI * -2f / 5f * (float)direction);
			SetCompositeArmFront(enabled: true, CompositeArmStretchAmount.Full, (float)Math.PI * -2f / 5f * (float)direction);
			FlipItemLocationAndRotationForGravity();
		}
	}

	private void ItemCheck_ApplyManaRegenDelay(Item sItem)
	{
		if (!spaceGun || (sItem.type != 127 && sItem.type != 4347 && sItem.type != 4348 && sItem.type != 514))
		{
			manaRegenDelay = (int)maxRegenDelay;
		}
	}

	public Vector2 GetFrontHandPosition(CompositeArmStretchAmount stretch, float rotation)
	{
		float num = rotation + (float)Math.PI / 2f;
		Vector2 vector = new Vector2((float)Math.Cos(num), (float)Math.Sin(num));
		switch (stretch)
		{
		case CompositeArmStretchAmount.Full:
			vector *= 10f;
			break;
		case CompositeArmStretchAmount.None:
			vector *= 4f;
			break;
		case CompositeArmStretchAmount.Quarter:
			vector *= 6f;
			break;
		case CompositeArmStretchAmount.ThreeQuarters:
			vector *= 8f;
			break;
		}
		if (direction == -1)
		{
			vector += new Vector2(4f, -2f);
			vector += new Vector2(0f, -3f).RotatedBy(rotation + (float)Math.PI / 2f);
		}
		else
		{
			vector += new Vector2(-4f, -2f);
			vector += new Vector2(0f, 3f).RotatedBy(rotation + (float)Math.PI / 2f);
		}
		return MountedCenter + vector;
	}

	public Vector2 GetBackHandPosition(CompositeArmStretchAmount stretch, float rotation)
	{
		float num = rotation + (float)Math.PI / 2f;
		Vector2 vector = new Vector2((float)Math.Cos(num), (float)Math.Sin(num));
		switch (stretch)
		{
		case CompositeArmStretchAmount.Full:
			vector *= new Vector2(10f, 12f);
			break;
		case CompositeArmStretchAmount.None:
			vector *= new Vector2(4f, 6f);
			break;
		case CompositeArmStretchAmount.Quarter:
			vector *= new Vector2(6f, 8f);
			break;
		case CompositeArmStretchAmount.ThreeQuarters:
			vector *= new Vector2(8f, 10f);
			break;
		}
		if (direction == -1)
		{
			vector += new Vector2(-6f, -2f);
		}
		else
		{
			vector += new Vector2(6f, -2f);
		}
		return MountedCenter + vector;
	}

	public void ItemCheck_ApplyUseStyle(float mountOffset, Item sItem, Rectangle heldItemFrame)
	{
		if (Main.dedServ)
		{
			return;
		}
		_ = isDisplayDollOrInanimate;
		if (sItem.useStyle == 1)
		{
			if (sItem.type > -1 && Item.claw[sItem.type])
			{
				if ((double)itemAnimation < (double)itemAnimationMax * 0.333)
				{
					float num = 10f;
					itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - num) * (float)direction;
					itemLocation.Y = position.Y + 26f + mountOffset;
				}
				else if ((double)itemAnimation < (double)itemAnimationMax * 0.666)
				{
					float num2 = 8f;
					itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - num2) * (float)direction;
					num2 = 24f;
					itemLocation.Y = position.Y + num2 + mountOffset;
				}
				else
				{
					float num3 = 6f;
					itemLocation.X = position.X + (float)width * 0.5f - ((float)heldItemFrame.Width * 0.5f - num3) * (float)direction;
					num3 = 20f;
					itemLocation.Y = position.Y + num3 + mountOffset;
				}
				itemRotation = ((float)itemAnimation / (float)itemAnimationMax - 0.5f) * (float)(-direction) * 3.5f - (float)direction * 0.3f;
			}
			else
			{
				Vector2 zero = Vector2.Zero;
				if ((double)itemAnimation < (double)itemAnimationMax * 0.333)
				{
					float num4 = 10f;
					if (heldItemFrame.Width > 32)
					{
						num4 = 14f;
					}
					if (heldItemFrame.Width >= 52)
					{
						num4 = 24f;
					}
					if (heldItemFrame.Width >= 64)
					{
						num4 = 28f;
					}
					if (heldItemFrame.Width >= 92)
					{
						num4 = 38f;
					}
					if (sItem.type == 2330 || sItem.type == 2320 || sItem.type == 2341)
					{
						num4 += 8f;
					}
					if (sItem.type == 671)
					{
						num4 += 12f;
					}
					itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - num4) * (float)direction;
					itemLocation.Y = position.Y + 24f + mountOffset;
					zero = new Vector2(-4f, 1f);
				}
				else if ((double)itemAnimation < (double)itemAnimationMax * 0.666)
				{
					float num5 = 10f;
					if (heldItemFrame.Width > 32)
					{
						num5 = 18f;
					}
					if (heldItemFrame.Width >= 52)
					{
						num5 = 24f;
					}
					if (heldItemFrame.Width >= 64)
					{
						num5 = 28f;
					}
					if (heldItemFrame.Width >= 92)
					{
						num5 = 38f;
					}
					if (sItem.type == 2330 || sItem.type == 2320 || sItem.type == 2341)
					{
						num5 += 4f;
					}
					if (sItem.type == 671)
					{
						num5 += 6f;
					}
					itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - num5) * (float)direction;
					num5 = 10f;
					if (heldItemFrame.Height > 32)
					{
						num5 = 8f;
					}
					if (heldItemFrame.Height > 52)
					{
						num5 = 12f;
					}
					if (heldItemFrame.Height > 64)
					{
						num5 = 14f;
					}
					if (sItem.type == 2330 || sItem.type == 2320 || sItem.type == 2341)
					{
						num5 += 4f;
					}
					if (sItem.type == 671)
					{
						num5 += 10f;
					}
					itemLocation.Y = position.Y + num5 + mountOffset;
					zero = new Vector2(-6f, -4f);
				}
				else
				{
					float num6 = 6f;
					if (heldItemFrame.Width > 32)
					{
						num6 = 14f;
					}
					if (heldItemFrame.Width >= 48)
					{
						num6 = 18f;
					}
					if (heldItemFrame.Width >= 52)
					{
						num6 = 24f;
					}
					if (heldItemFrame.Width >= 64)
					{
						num6 = 28f;
					}
					if (heldItemFrame.Width >= 92)
					{
						num6 = 38f;
					}
					if (sItem.type == 2330 || sItem.type == 2320 || sItem.type == 2341)
					{
						num6 += 4f;
					}
					if (sItem.type == 671)
					{
						num6 += 8f;
					}
					itemLocation.X = position.X + (float)width * 0.5f - ((float)heldItemFrame.Width * 0.5f - num6) * (float)direction;
					num6 = 10f;
					if (heldItemFrame.Height > 32)
					{
						num6 = 10f;
					}
					if (heldItemFrame.Height > 52)
					{
						num6 = 12f;
					}
					if (heldItemFrame.Height > 64)
					{
						num6 = 14f;
					}
					if (sItem.type == 2330 || sItem.type == 2320 || sItem.type == 2341)
					{
						num6 += 4f;
					}
					if (sItem.type == 671)
					{
						num6 += 8f;
					}
					itemLocation.Y = position.Y + num6 + mountOffset;
					zero = new Vector2(4f, -2f);
				}
				if (sItem.type > -1 && ItemID.Sets.UsesBetterMeleeItemLocation[sItem.type])
				{
					itemLocation += zero * Directions;
				}
				itemRotation = ((float)itemAnimation / (float)itemAnimationMax - 0.5f) * (float)(-direction) * 3.5f - (float)direction * 0.3f;
			}
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 7)
		{
			itemRotation = (float)itemAnimation / (float)itemAnimationMax * (float)direction * 2f + -1.4f * (float)direction;
			if ((double)itemAnimation < (double)itemAnimationMax * 0.5)
			{
				itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - 9f - itemRotation * 12f * (float)direction) * (float)direction;
				itemLocation.Y = position.Y + 38f + itemRotation * (float)direction * 4f + mountOffset;
			}
			else
			{
				itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - 9f - itemRotation * 16f * (float)direction) * (float)direction;
				itemLocation.Y = position.Y + 38f + itemRotation * (float)direction + mountOffset;
			}
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 9)
		{
			float num7 = (float)itemAnimation / (float)itemAnimationMax;
			float t = 1f - num7;
			t = Utils.GetLerpValue(0f, 0.7f, t, clamped: true);
			itemRotation = t * (float)(-direction) * 2f + 0.7f * (float)direction;
			itemLocation = MountedCenter + new Vector2((float)(direction * 10) * ((float)itemAnimation / (float)itemAnimationMax), 0f);
			float num8 = 8f;
			float num9 = 7f;
			float num10 = (float)Math.PI * 2f / 5f;
			float num11 = (0f - num10) * 0.5f + (1f - t) * num10;
			num11 += (float)Math.PI / 10f;
			Vector2 vector = base.Center + new Vector2((float)direction * num8, 0f) + num11.ToRotationVector2() * num9 * new Vector2(direction, 1f);
			itemLocation = vector;
			float num12 = num11 - (float)Math.PI / 2f;
			if (direction == -1)
			{
				num12 = 0f - num12;
			}
			SetCompositeArmFront(enabled: true, CompositeArmStretchAmount.Full, num12);
			itemLocation = GetFrontHandPosition(CompositeArmStretchAmount.Full, num12);
			itemLocation -= MountedCenter;
			itemLocation *= MathHelper.Lerp(1.5f, 1.2f, t);
			itemLocation += MountedCenter;
			itemLocation.X += (float)direction * MathHelper.Lerp(8f, 2f, t);
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 6)
		{
			float num13 = 1f - (float)itemAnimation / (float)itemAnimationMax;
			num13 *= 6f;
			if (num13 > 1f)
			{
				num13 = 1f;
			}
			itemRotation = (1f - num13) * (float)direction * 2f - 1.4f * (float)direction;
			if (num13 >= 0.5f)
			{
				itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - 9f - itemRotation * 12f * (float)direction) * (float)direction;
				itemLocation.Y = position.Y + 38f + itemRotation * (float)direction * 4f + mountOffset;
			}
			else
			{
				itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - 9f - itemRotation * 16f * (float)direction) * (float)direction;
				itemLocation.Y = position.Y + 38f + itemRotation * (float)direction + mountOffset;
			}
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 2)
		{
			itemLocation = MountedCenter + new Vector2(10 * direction, -10f).RotatedBy(itemRotation + (float)Math.PI / 4f * (float)direction);
			float num14 = 1f - (float)itemAnimation / (float)itemAnimationMax;
			CompositeArmStretchAmount compositeArmStretchAmount = CompositeArmStretchAmount.Full;
			if (num14 > 0.25f && num14 <= 0.5f)
			{
				compositeArmStretchAmount = CompositeArmStretchAmount.ThreeQuarters;
			}
			if (num14 > 0.5f && num14 <= 0.75f)
			{
				compositeArmStretchAmount = CompositeArmStretchAmount.Quarter;
			}
			if (num14 > 0.75f && num14 <= 1f)
			{
				compositeArmStretchAmount = CompositeArmStretchAmount.None;
			}
			SetCompositeArmFront(enabled: true, compositeArmStretchAmount, -(float)Math.PI / 2f * (float)direction);
			SetCompositeArmBack(enabled: true, compositeArmStretchAmount, -(float)Math.PI / 2f * (float)direction);
			int num15 = 8;
			switch (compositeArmStretchAmount)
			{
			case CompositeArmStretchAmount.Full:
				num15 = 8;
				break;
			case CompositeArmStretchAmount.ThreeQuarters:
				num15 = 6;
				break;
			case CompositeArmStretchAmount.Quarter:
				num15 = 4;
				break;
			case CompositeArmStretchAmount.None:
				num15 = 2;
				break;
			}
			itemLocation = MountedCenter + new Vector2((num15 + 10 - heldItemFrame.Width / 2) * direction, heldItemFrame.Height / 2 - 4);
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 11)
		{
			float num16 = 1f - (float)itemAnimation / (float)itemAnimationMax;
			num16 *= 2f;
			CompositeArmStretchAmount compositeArmStretchAmount2 = CompositeArmStretchAmount.Full;
			if (num16 > 0.25f && num16 <= 0.5f)
			{
				compositeArmStretchAmount2 = CompositeArmStretchAmount.ThreeQuarters;
			}
			if (num16 > 0.5f && num16 <= 0.75f)
			{
				compositeArmStretchAmount2 = CompositeArmStretchAmount.Quarter;
			}
			if (num16 > 0.75f && num16 <= 1.25f)
			{
				compositeArmStretchAmount2 = CompositeArmStretchAmount.None;
			}
			if (num16 > 1.25f && num16 <= 1.5f)
			{
				compositeArmStretchAmount2 = CompositeArmStretchAmount.Quarter;
			}
			if (num16 > 1.5f && num16 <= 1.75f)
			{
				compositeArmStretchAmount2 = CompositeArmStretchAmount.ThreeQuarters;
			}
			if (num16 > 1.75f && num16 <= 2f)
			{
				compositeArmStretchAmount2 = CompositeArmStretchAmount.Full;
			}
			SetCompositeArmFront(enabled: true, compositeArmStretchAmount2, -(float)Math.PI / 4f * (float)direction);
			SetCompositeArmBack(enabled: true, CompositeArmStretchAmount.Full, -(float)Math.PI / 16f);
			int num17 = 8;
			switch (compositeArmStretchAmount2)
			{
			case CompositeArmStretchAmount.Full:
				num17 = 8;
				break;
			case CompositeArmStretchAmount.ThreeQuarters:
				num17 = 6;
				break;
			case CompositeArmStretchAmount.Quarter:
				num17 = 4;
				break;
			case CompositeArmStretchAmount.None:
				num17 = 2;
				break;
			}
			itemLocation = MountedCenter + new Vector2((num17 + 22 - heldItemFrame.Width / 2) * direction, heldItemFrame.Height / 2 - 8);
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 3)
		{
			if ((double)itemAnimation > (double)itemAnimationMax * 0.666)
			{
				itemLocation.X = -1000f;
				itemLocation.Y = -1000f;
				itemRotation = -1.3f * (float)direction;
			}
			else
			{
				itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - 4f) * (float)direction;
				itemLocation.Y = position.Y + 24f + mountOffset;
				float num18 = (float)itemAnimation / (float)itemAnimationMax * (float)heldItemFrame.Width * (float)direction * GetAdjustedItemScale(sItem) * 1.2f - (float)(10 * direction);
				if (num18 > -4f && direction == -1)
				{
					num18 = -8f;
				}
				if (num18 < 4f && direction == 1)
				{
					num18 = 8f;
				}
				itemLocation.X -= num18;
				itemRotation = 0.8f * (float)direction;
				if (sItem.type == 946 || sItem.type == 4707)
				{
					itemLocation.X -= 6 * direction;
				}
			}
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 4)
		{
			int num19 = 0;
			int num20 = 0;
			if (sItem.type == 3601)
			{
				num19 = 10;
			}
			if (sItem.type == 5114)
			{
				num19 = 10;
				num20 = -2;
			}
			if (sItem.type == 5120)
			{
				num19 = 10;
			}
			itemRotation = 0f;
			itemLocation.X = position.X + (float)width * 0.5f + ((float)heldItemFrame.Width * 0.5f - 9f - itemRotation * 14f * (float)direction - 4f - (float)num19) * (float)direction;
			itemLocation.Y = position.Y + (float)heldItemFrame.Height * 0.5f + 4f + mountOffset + (float)num20;
			if (gravDir == -1f)
			{
				itemRotation = 0f - itemRotation;
				itemLocation.Y = position.Y + (float)height + (position.Y - itemLocation.Y);
			}
		}
		else if (sItem.useStyle == 5)
		{
			if (sItem.type == 3779)
			{
				itemRotation = 0f;
				itemLocation.X = base.Center.X + (float)(6 * direction);
				itemLocation.Y = MountedCenter.Y + 6f;
			}
			else if (sItem.type == 4262)
			{
				itemRotation = 0f;
				itemLocation.X = base.Center.X + (float)(direction * -6);
				itemLocation.Y = MountedCenter.Y - 6f;
				bool flag = true;
				if (mount.Active && mount.Type >= 0 && MountID.Sets.DontHoldItems[mount.Type])
				{
					flag = false;
				}
				if (flag && Main.rand.Next(20) == 0)
				{
					int num21 = Main.rand.Next(570, 573);
					Vector2 vector2 = new Vector2(base.Center.X + (float)(direction * 30) - 6f, itemLocation.Y - 30f);
					Vector2 vector3 = new Vector2(Main.WindForVisuals * 2f + (float)direction * 0.3f, -0.5f);
					vector3.X *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
					vector3.Y *= 1f + (float)Main.rand.Next(-50, 51) * 0.01f;
					if (num21 == 572)
					{
						vector2.X -= 8f;
					}
					if (num21 == 571)
					{
						vector2.X -= 4f;
					}
					Gore.NewGore(vector2, vector3, num21, 0.8f);
				}
			}
			else if (Item.staff[sItem.type])
			{
				float num22 = 6f;
				if (sItem.type == 3476)
				{
					num22 = 14f;
				}
				itemLocation = MountedCenter;
				itemLocation += (itemRotation.ToRotationVector2() * num22 * direction).Floor();
			}
			else
			{
				itemLocation.X = position.X + (float)width * 0.5f - (float)(direction * 2);
				itemLocation.Y = MountedCenter.Y - (float)heldItemFrame.Height * 0.5f;
			}
			if (sItem.type != 5065)
			{
				return;
			}
			_ = itemRotation;
			Vector2 vector4 = itemLocation + itemRotation.ToRotationVector2() * 38f * direction;
			Vector2 vector5 = itemRotation.ToRotationVector2() * 5f * direction;
			if (itemAnimation % 2 == 0)
			{
				Color newColor = Main.hslToRgb(0.92f, 1f, 0.5f);
				int num23 = Dust.NewDust(vector4, 0, 0, 267, 0f, 0f, 0, newColor);
				Main.dust[num23].position = vector4 - velocity + Main.rand.NextVector2Circular(10f, 10f);
				Main.dust[num23].noGravity = true;
				Main.dust[num23].scale = 0.3f;
				Main.dust[num23].fadeIn = Main.rand.NextFloat() * 1.2f;
				Main.dust[num23].velocity = Main.rand.NextVector2Circular(1f, 1f) + velocity;
				if (num23 != 6000)
				{
					Dust dust = Dust.CloneDust(num23);
					dust.scale /= 2f;
					dust.fadeIn *= 0.85f;
					dust.color = new Color(255, 255, 255, 255);
				}
			}
			if (itemAnimation % 4 == 0)
			{
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.PrincessWeapon, new ParticleOrchestraSettings
				{
					PositionInWorld = vector4,
					MovementVector = vector5 * 0.1f + Main.rand.NextVector2Circular(2f, 2f) + velocity
				}, whoAmI);
			}
		}
		else if (sItem.useStyle == 13)
		{
			int useAnimation = itemAnimationMax;
			if (itemTimeMax != 0)
			{
				useAnimation = itemTimeMax;
			}
			if (useAnimation == 0)
			{
				useAnimation = sItem.useAnimation;
			}
			float num24 = 1f - (float)(itemAnimation % useAnimation) / (float)useAnimation;
			CompositeArmStretchAmount stretch = CompositeArmStretchAmount.Quarter;
			if (num24 > 0.33f && num24 <= 0.66f)
			{
				stretch = CompositeArmStretchAmount.ThreeQuarters;
			}
			if (num24 > 0.66f && num24 <= 1f)
			{
				stretch = CompositeArmStretchAmount.Full;
			}
			float rotation = itemRotation * Directions.Y - (float)Math.PI / 2f * (float)direction;
			SetCompositeArmFront(enabled: true, stretch, rotation);
		}
		else if (sItem.useStyle == 8)
		{
			if (itemAnimation >= sItem.useAnimation - 1 && itemAnimation <= sItem.useAnimation)
			{
				float num25 = new Vector2(10 * direction, 10f).ToRotation() + (float)Math.PI / 4f;
				itemRotation = num25;
				if (direction == -1)
				{
					itemRotation += (float)Math.PI / 2f;
				}
				_ = (float)itemAnimation / (float)itemAnimationMax;
				CompositeArmStretchAmount stretch2 = CompositeArmStretchAmount.Full;
				CompositeArmStretchAmount stretch3 = CompositeArmStretchAmount.ThreeQuarters;
				float num26 = -(float)Math.PI / 10f;
				if (direction == -1)
				{
					num26 *= -1f;
				}
				float num27 = itemRotation - (float)Math.PI / 4f + (float)Math.PI;
				if (direction == 1)
				{
					num27 += (float)Math.PI / 2f;
				}
				float rotation2 = num27 + num26;
				float rotation3 = num27 - num26;
				Vector2 vector6 = (num27 + (float)Math.PI / 2f).ToRotationVector2() * -2f;
				itemLocation = (MountedCenter + vector6).Floor();
				SetCompositeArmFront(enabled: true, stretch2, rotation2);
				SetCompositeArmBack(enabled: true, stretch3, rotation3);
			}
			else if (itemAnimation > sItem.useAnimation)
			{
				float num28 = 0f - Utils.GetLerpValue(itemAnimationMax, itemAnimationMax * 5, itemAnimation, clamped: true);
				CompositeArmStretchAmount stretch4 = CompositeArmStretchAmount.Full;
				CompositeArmStretchAmount stretch5 = CompositeArmStretchAmount.ThreeQuarters;
				float num29 = -(float)Math.PI / 10f;
				num29 *= 0f - num28;
				itemRotation = (float)Math.PI / 2f * (float)(-direction) + (float)Math.PI + (float)Math.PI * num28 * (float)(-direction);
				float num30 = -(float)Math.PI / 5f * (float)direction;
				if (direction < 1)
				{
					num29 *= -1f;
				}
				float rotation4 = num30 + num29;
				float rotation5 = num30 - num29;
				Vector2 vector7 = new Vector2(10 * direction, num28 * -6f);
				itemLocation = (MountedCenter + vector7).Floor();
				SetCompositeArmFront(enabled: true, stretch4, rotation4);
				SetCompositeArmBack(enabled: true, stretch5, rotation5);
			}
			else
			{
				float num31 = 1f - (float)itemAnimation / (float)itemAnimationMax;
				CompositeArmStretchAmount stretch6 = CompositeArmStretchAmount.Full;
				CompositeArmStretchAmount stretch7 = CompositeArmStretchAmount.ThreeQuarters;
				if (num31 > 0.6f)
				{
					stretch7 = CompositeArmStretchAmount.Quarter;
				}
				float num32 = -(float)Math.PI / 10f;
				if (direction == -1)
				{
					num32 *= -1f;
				}
				num32 *= 1f - num31 * 2.2f;
				itemRotation = (num31 * (float)Math.PI * 1.6f + -(float)Math.PI / 2f) * (float)(-direction) + (float)Math.PI;
				float num33 = (num31 * (float)Math.PI * 0.6f + (float)Math.PI * 2f / 5f) * (float)(-direction) + (float)Math.PI - (float)Math.PI / 4f + (float)Math.PI;
				if (direction == 1)
				{
					num33 += (float)Math.PI / 2f;
				}
				float rotation6 = num33 + num32;
				float rotation7 = num33 - num32;
				Vector2 vector8 = (num33 + (float)Math.PI / 2f).ToRotationVector2() * (-5f * (1f - num31));
				itemLocation = (MountedCenter + vector8).Floor();
				SetCompositeArmFront(enabled: true, stretch6, rotation6);
				SetCompositeArmBack(enabled: true, stretch7, rotation7);
			}
			FlipItemLocationAndRotationForGravity();
		}
		else if (sItem.useStyle == 12)
		{
			itemRotation = 0f;
			itemLocation.X = MountedCenter.X - (float)(8 * direction);
			itemLocation.Y = position.Y + 40f + mountOffset;
			Vector2 vector9 = Main.OffsetsPlayerHeadgear[bodyFrame.Y / 56];
			itemLocation += vector9;
			float num34 = itemAnimationMax;
			if (num34 == 0f)
			{
				num34 = sItem.useAnimation;
			}
			float num35 = 1f - (float)itemAnimation / num34;
			num35 *= 2f;
			float num36 = (float)Math.Cos(num35 * (float)Math.PI) * 0.2f;
			CompositeArmStretchAmount compositeArmStretchAmount3 = CompositeArmStretchAmount.Full;
			if (num35 > 0.25f && num35 <= 0.5f)
			{
				compositeArmStretchAmount3 = CompositeArmStretchAmount.ThreeQuarters;
			}
			if (num35 > 0.5f && num35 <= 0.75f)
			{
				compositeArmStretchAmount3 = CompositeArmStretchAmount.Quarter;
			}
			if (num35 > 0.75f && num35 <= 1.25f)
			{
				compositeArmStretchAmount3 = CompositeArmStretchAmount.None;
			}
			if (num35 > 1.25f && num35 <= 1.5f)
			{
				compositeArmStretchAmount3 = CompositeArmStretchAmount.Quarter;
			}
			if (num35 > 1.5f && num35 <= 1.75f)
			{
				compositeArmStretchAmount3 = CompositeArmStretchAmount.ThreeQuarters;
			}
			if (num35 > 1.75f && num35 <= 2f)
			{
				compositeArmStretchAmount3 = CompositeArmStretchAmount.Full;
			}
			SetCompositeArmFront(enabled: true, compositeArmStretchAmount3, (-(float)Math.PI / 4f + num36) * (float)direction);
			CompositeArmStretchAmount stretch8 = CompositeArmStretchAmount.Quarter;
			SetCompositeArmBack(enabled: true, stretch8, (-(float)Math.PI / 4f - num36 * 0.5f) * (float)direction);
			FlipItemLocationAndRotationForGravity();
			if (sItem.type != 4715 || compositeArmStretchAmount3 != CompositeArmStretchAmount.ThreeQuarters)
			{
				return;
			}
			Vector2 vector10 = itemLocation + new Vector2(heldItemFrame.Width, -heldItemFrame.Height) * new Vector2(direction, gravDir) * 0.3f;
			Dust dust2 = Dust.NewDustPerfect(vector10, 228, Main.rand.NextVector2CircularEdge(1f, 1f));
			dust2.noGravity = true;
			dust2.noLight = true;
			dust2.velocity *= 2f;
			float num37 = 0.5f;
			for (float num38 = 0f; num38 < 1f; num38 += 0.5f)
			{
				if (Main.rand.Next(3) == 0)
				{
					Dust dust3 = Dust.NewDustPerfect(vector10, 278, Vector2.UnitY.RotatedBy(num38 * ((float)Math.PI * 2f) + Main.rand.NextFloat() * num37 - num37 * 0.5f + (float)Math.PI / 2f) * (2f + Main.rand.NextFloat() * 1f), 150, Color.Lerp(Color.White, Color.HotPink, Main.rand.NextFloat() * 0.5f + 0.5f), 0.45f);
					dust3.noGravity = true;
					dust3.velocity *= 0.5f;
					dust3.customData = this;
					dust3.position += dust3.velocity * 6f;
				}
			}
			for (float num39 = 0f; num39 < 1f; num39 += 0.5f)
			{
				if (Main.rand.Next(3) == 0)
				{
					Dust dust4 = Dust.NewDustPerfect(vector10, 278, Vector2.UnitY.RotatedBy(num39 * ((float)Math.PI * 2f) + Main.rand.NextFloat() * num37 - num37 * 0.5f + (float)Math.PI / 2f) * (0.5f + Main.rand.NextFloat() * 1f), 150, Color.Lerp(Color.White, Color.Gold, Main.rand.NextFloat() * 0.5f + 0.5f), 0.45f);
					dust4.noGravity = true;
					dust4.velocity *= 0.5f;
					dust4.customData = this;
					dust4.position += dust4.velocity * 6f;
				}
			}
		}
		else if (sItem.useStyle == 14)
		{
			if (!Main.dedServ)
			{
				itemRotation = 0f;
				itemLocation.X = base.Center.X + (float)(6 * direction);
				itemLocation.Y = position.Y + 40f + mountOffset - 8f;
				Vector2 vector11 = Main.OffsetsPlayerHeadgear[bodyFrame.Y / 56];
				itemLocation += vector11;
				CompositeArmStretchAmount stretch9 = CompositeArmStretchAmount.Full;
				SetCompositeArmBack(enabled: true, stretch9, (float)Math.PI * -3f / 4f * (float)direction);
				FlipItemLocationAndRotationForGravity();
			}
		}
		else if (sItem.useStyle == 15)
		{
			itemRotation = 0f;
			itemLocation.X = base.Center.X + (float)(6 * direction);
			itemLocation.Y = position.Y + 30f + mountOffset - 2f;
			Vector2 vector12 = Main.OffsetsPlayerHeadgear[bodyFrame.Y / 56];
			itemLocation += vector12;
			SetCompositeArmBack(enabled: true, CompositeArmStretchAmount.ThreeQuarters, (float)Math.PI * -2f / 5f * (float)direction);
			SetCompositeArmFront(enabled: true, CompositeArmStretchAmount.Full, (float)Math.PI * -2f / 5f * (float)direction);
			FlipItemLocationAndRotationForGravity();
		}
		else if (sItem.useStyle == 16)
		{
			bool flag2 = pulley;
			pulley = false;
			ItemCheck_ApplyHoldStyle(mountOffset, sItem, heldItemFrame);
			pulley = flag2;
		}
	}

	public void ApplyItemPositionOffsetFromMount(ref Vector2 pos)
	{
		if (!mount.Active)
		{
			return;
		}
		int num = bodyFrame.Y / bodyFrame.Height;
		Vector2 zero = Vector2.Zero;
		Item heldItem = HeldItem;
		bool flag = itemAnimation > 0;
		bool flag2 = !flag && heldItem.holdStyle > 0;
		if (!flag && !flag2)
		{
			return;
		}
		bool flag3 = heldItem.useStyle == 5;
		_ = heldProj;
		bool flag4 = heldItem.useStyle == 2;
		bool flag5 = heldItem.useStyle == 9;
		bool flag6 = heldItem.fishingPole != 0;
		bool flag7 = heldItem.useStyle == 14;
		bool flag8 = heldItem.useStyle == 8;
		bool flag9 = heldItem.type > 0 && ItemID.Sets.Yoyo[heldItem.type];
		bool flag10 = heldItem.useStyle == 11;
		bool flag11 = heldItem.type == 3542;
		bool flag12 = heldItem.type > 0 && ItemID.Sets.IsAKite[heldItem.type];
		bool flag13 = heldItem.holdStyle == 1;
		bool flag14 = heldItem.holdStyle == 2;
		bool flag15 = heldItem.holdStyle == 5;
		if (mount.Type == 54)
		{
			if (flag4)
			{
				if (flag)
				{
					zero += new Vector2(7f, -4f) * Directions;
				}
				else
				{
					zero += new Vector2(3f, 2f) * Directions;
				}
			}
			else if (flag6)
			{
				zero += new Vector2(-2f, 0f) * Directions;
			}
			else if (flag5)
			{
				if (flag)
				{
					zero += new Vector2(14f, -10f) * Directions;
				}
				else
				{
					zero += new Vector2(3f, 2f) * Directions;
				}
			}
			else if (flag10)
			{
				if (flag)
				{
					zero += new Vector2(4f, 0f) * Directions;
				}
				else
				{
					zero += new Vector2(1f, 0f) * Directions;
				}
			}
			else if (flag8)
			{
				zero += new Vector2(6f, 0f) * Directions;
			}
			else if (flag7)
			{
				if (flag)
				{
					zero += new Vector2(-6f, 6f) * Directions;
				}
				else
				{
					zero += new Vector2(-10f, 10f) * Directions;
				}
			}
			else if (flag12)
			{
				zero += new Vector2(4f, -4f) * Directions;
			}
			else if (flag15)
			{
				zero += new Vector2(6f, 0f) * Directions;
			}
			else if (flag13 && !flag)
			{
				zero += new Vector2(1f, 4f) * Directions;
			}
			else if (flag14)
			{
				if (flag && heldItem.type == 186)
				{
					zero += new Vector2(-4f, 0f).RotatedBy((pos - base.Center).ToRotation(), Vector2.Zero);
				}
				else
				{
					zero += new Vector2(6f, 0f) * Directions;
				}
			}
			else if (flag9)
			{
				switch (num)
				{
				case 2:
					zero += new Vector2(10f, -10f) * Directions;
					break;
				case 3:
					zero += new Vector2(8f, 0f) * Directions;
					break;
				case 4:
					zero += new Vector2(2f, 2f) * Directions;
					break;
				}
			}
			else if (flag11)
			{
				switch (num)
				{
				case 2:
					zero += new Vector2(-10f, 0f) * Directions;
					break;
				case 3:
					zero += new Vector2(10f, 0f) * Directions;
					break;
				case 4:
					zero += new Vector2(10f, 0f) * Directions;
					break;
				}
			}
			else if (flag3)
			{
				zero += new Vector2(4f, 0f) * Directions;
			}
			else
			{
				switch (num)
				{
				case 1:
					zero += new Vector2(1f, -1f) * Directions;
					break;
				case 2:
					zero += new Vector2(4f, 2f) * Directions;
					break;
				case 3:
					zero += new Vector2(2f, 0f) * Directions;
					break;
				}
			}
		}
		pos += zero;
	}

	public void ApplyHeadOffsetFromMount(ref Vector2 pos)
	{
		if (!mount.Active)
		{
			return;
		}
		int frame = mount.Frame;
		Vector2 vector = Vector2.Zero;
		if (mount.Type == 56 || mount.Type == 61)
		{
			vector = new Vector2(6f, 14f) * Directions;
			switch (frame)
			{
			case 1:
			case 2:
				vector += new Vector2(0f, 2f) * Directions;
				break;
			case 6:
			case 7:
			case 8:
			case 9:
				vector += new Vector2(0f, 2f) * Directions;
				break;
			}
		}
		if (mount.Type == 55)
		{
			vector = new Vector2(0f, 14f) * Directions;
			switch (frame)
			{
			case 1:
				vector += new Vector2(-2f, 0f) * Directions;
				break;
			case 2:
			case 3:
				vector += new Vector2(-4f, -2f) * Directions;
				break;
			case 4:
			case 5:
			case 6:
			case 7:
			case 8:
			case 9:
			case 10:
				vector += new Vector2(4f, 2f) * Directions;
				break;
			case 11:
				vector += new Vector2(4f, 2f) * Directions;
				break;
			case 12:
			case 13:
				vector += new Vector2(6f, 0f) * Directions;
				break;
			case 14:
				vector += new Vector2(6f, 2f) * Directions;
				break;
			case 15:
				vector += new Vector2(4f, 2f) * Directions;
				break;
			}
		}
		if (mount.Type == 54)
		{
			vector = new Vector2(23f, -8f) * Directions;
			switch (frame)
			{
			case 5:
				vector += new Vector2(0f, 4f) * Directions;
				break;
			case 6:
				vector += new Vector2(2f, 2f) * Directions;
				break;
			case 7:
				vector += new Vector2(2f, 0f) * Directions;
				break;
			case 8:
			case 9:
			case 11:
			case 12:
			case 13:
			case 15:
				vector += new Vector2(4f, 4f) * Directions;
				break;
			case 10:
			case 14:
				vector += new Vector2(4f, 2f) * Directions;
				break;
			case 16:
			case 17:
			case 18:
			case 19:
			case 20:
				vector += new Vector2(4f, 4f) * Directions;
				break;
			}
		}
		pos += vector;
	}

	public void FlipItemLocationAndRotationForGravity()
	{
		if (gravDir == -1f)
		{
			itemRotation = 0f - itemRotation;
			float num = position.Y - itemLocation.Y;
			itemLocation.Y = base.Bottom.Y + num;
		}
	}

	private void ItemCheck_StartActualUse(Item sItem)
	{
		bool flag = sItem.type == 4711;
		if (sItem.pick > 0 || sItem.axe > 0 || sItem.hammer > 0 || flag)
		{
			toolTime = 1;
		}
		if (grappling[0] > -1)
		{
			pulley = false;
			pulleyDir = 1;
			if (controlRight)
			{
				direction = 1;
			}
			else if (controlLeft)
			{
				direction = -1;
			}
		}
		StartChanneling(sItem);
		attackCD = 0;
		ResetMeleeHitCooldowns();
		ApplyItemAnimation(sItem);
		bool flag2 = ItemID.Sets.SkipsInitialUseSound[sItem.type];
		if (sItem.UseSound != null && !flag2)
		{
			bool flag3 = sItem.useStyle == 5 || sItem.useStyle == 13 || sItem.shoot > 0;
			bool? flag4 = ItemID.Sets.NetUseSoundSync[sItem.type];
			if (flag4.HasValue)
			{
				flag3 = flag4.Value;
			}
			if (whoAmI == Main.myPlayer && Main.netMode == 1 && flag3)
			{
				NetMessage.SendData(152, -1, -1, null, whoAmI);
			}
			if (whoAmI == Main.myPlayer || !flag3)
			{
				SoundEngine.PlaySound(sItem.UseSound, base.Center, sItem.useSoundPitch);
			}
		}
	}

	private void FreeUpPetsAndMinions(Item sItem)
	{
		if (sItem.shoot == 1093)
		{
			for (int i = 0; i < 1000; i++)
			{
				if (Main.projectile[i].active && Main.projectile[i].owner == whoAmI && Main.projectile[i].minion && Main.projectile[i].type == sItem.shoot)
				{
					Main.projectile[i].Kill();
				}
			}
		}
		if (ProjectileID.Sets.MinionSacrificable[sItem.shoot])
		{
			List<int> list = new List<int>();
			float num = 0f;
			for (int j = 0; j < 1000; j++)
			{
				if (!Main.projectile[j].active || Main.projectile[j].owner != whoAmI || !Main.projectile[j].minion)
				{
					continue;
				}
				int k;
				for (k = 0; k < list.Count; k++)
				{
					if (Main.projectile[list[k]].minionSlots > Main.projectile[j].minionSlots)
					{
						list.Insert(k, j);
						break;
					}
				}
				if (k == list.Count)
				{
					list.Add(j);
				}
				num += Main.projectile[j].minionSlots;
			}
			float num2 = ItemID.Sets.StaffMinionSlotsRequired[sItem.type];
			float num3 = 0f;
			int num4 = 388;
			int num5 = -1;
			for (int l = 0; l < list.Count; l++)
			{
				int type = Main.projectile[list[l]].type;
				if (type == 626)
				{
					list.RemoveAt(l);
					l--;
				}
				if (type == 627)
				{
					if (Main.projectile[(int)Main.projectile[list[l]].localAI[1]].type == 628)
					{
						num5 = list[l];
					}
					list.RemoveAt(l);
					l--;
				}
			}
			if (num5 != -1)
			{
				list.Add(num5);
				list.Add(Projectile.GetByUUID(Main.projectile[num5].owner, Main.projectile[num5].ai[0]));
			}
			for (int m = 0; m < list.Count; m++)
			{
				if (!(num - num3 > (float)maxMinions - num2))
				{
					break;
				}
				int type2 = Main.projectile[list[m]].type;
				if (type2 == num4 || type2 == 625 || type2 == 628 || type2 == 623)
				{
					continue;
				}
				if (type2 == 388 && num4 == 387)
				{
					num4 = 388;
				}
				if (type2 == 387 && num4 == 388)
				{
					num4 = 387;
				}
				num3 += Main.projectile[list[m]].minionSlots;
				if (type2 == 626 || type2 == 627)
				{
					Projectile projectile = Main.projectile[list[m]];
					int byUUID = Projectile.GetByUUID(projectile.owner, projectile.ai[0]);
					if (Main.projectile.IndexInRange(byUUID))
					{
						Projectile projectile2 = Main.projectile[byUUID];
						if (projectile2.type != 625)
						{
							projectile2.localAI[1] = projectile.localAI[1];
						}
						projectile2 = Main.projectile[(int)projectile.localAI[1]];
						projectile2.ai[0] = projectile.ai[0];
						projectile2.ai[1] = 1f;
						projectile2.netUpdate = true;
					}
				}
				Main.projectile[list[m]].Kill();
			}
			list.Clear();
			if (num + num2 >= 9f)
			{
				AchievementsHelper.HandleSpecialEvent(this, 6);
			}
			return;
		}
		for (int n = 0; n < 1000; n++)
		{
			Projectile projectile3 = Main.projectile[n];
			if (projectile3.active && projectile3.owner == whoAmI)
			{
				if (projectile3.type == sItem.shoot)
				{
					projectile3.Kill();
				}
				if (sItem.shoot == 72 && (projectile3.type == 86 || projectile3.type == 87))
				{
					projectile3.Kill();
				}
				if (sItem.type == 5131 && (projectile3.type == 881 || projectile3.type == 934))
				{
					projectile3.Kill();
				}
			}
		}
	}

	private void ApplyPotionDelay(Item sItem)
	{
		if (sItem.type == 3001)
		{
			int minValue = 2400;
			int num = 4200;
			potionDelay = Main.rand.Next(minValue, num + 1);
			if (pStone)
			{
				potionDelay = (int)((float)potionDelay * PhilosopherStoneDurationMultiplier);
			}
			AddBuff(21, potionDelay);
		}
		else if (sItem.type == 227 || sItem.type == 126)
		{
			potionDelay = restorationDelayTime;
			AddBuff(21, potionDelay);
		}
		else if (sItem.type == 1912)
		{
			potionDelay = eggnogDelayTime;
			AddBuff(21, potionDelay);
			TryToResetHungerToNeutral();
		}
		else if (sItem.type == 5)
		{
			potionDelay = mushroomDelayTime;
			AddBuff(21, potionDelay);
			TryToResetHungerToNeutral();
		}
		else
		{
			potionDelay = potionDelayTime;
			AddBuff(21, potionDelay);
		}
	}

	private void ApplyLifeAndOrMana(Item item)
	{
		int num = item.healLife;
		int healMana = item.healMana;
		if (item.type == 3001)
		{
			int healLife = item.healLife;
			int num2 = 120;
			num = Main.rand.Next(healLife, num2 + 1);
			if (Main.myPlayer == whoAmI)
			{
				float num3 = Main.rand.NextFloat();
				int num4 = 0;
				if (num3 <= 0.1f)
				{
					num4 = 240;
				}
				else if (num3 <= 0.3f)
				{
					num4 = 120;
				}
				else if (num3 <= 0.6f)
				{
					num4 = 60;
				}
				if (num4 > 0)
				{
					SetImmuneTimeForAllTypes(num4);
				}
			}
		}
		statLife += num;
		statMana += healMana;
		if (statLife > statLifeMax2)
		{
			statLife = statLifeMax2;
		}
		if (statMana > statManaMax2)
		{
			statMana = statManaMax2;
		}
		if (num > 0 && Main.myPlayer == whoAmI)
		{
			HealEffect(num);
		}
		if (healMana > 0)
		{
			AddBuff(94, manaSickTime);
			if (Main.myPlayer == whoAmI)
			{
				ManaEffect(healMana);
			}
		}
	}

	private bool ItemCheck_CanUse(Item sItem, bool ignoreCursed = false)
	{
		return ItemCheck_CheckCanUse_Inner(sItem, ignoreCursed);
	}

	private bool ItemCheck_TryStartUse(Item sItem, bool ignoreCursed = false)
	{
		bool flag = ItemCheck_CheckCanUse_Inner(sItem, ignoreCursed);
		if (flag)
		{
			if (!ItemCheck_ActuallyPayMana(sItem))
			{
				flag = false;
			}
			if (!ItemCheck_CheckCanUse_KillDirtBlock(sItem))
			{
				flag = false;
			}
			if (!ItemCheck_PullFishingBobbers(sItem))
			{
				flag = false;
			}
		}
		return flag;
	}

	private bool ItemCheck_CheckCanUse_Inner(Item sItem, bool ignoreCursed = false)
	{
		if (whoAmI == Main.myPlayer && Main.LocalPlayerHasPendingInventoryActions())
		{
			return false;
		}
		int num = whoAmI;
		bool flag = true;
		GetTargetTileWithReverseGravity(out var screenTargetTileX, out var screenTargetTileY);
		if (sItem.type == 3335 && (extraAccessory || !Main.expertMode))
		{
			flag = false;
		}
		if (pulley && sItem.fishingPole > 0)
		{
			flag = false;
		}
		if (pulley && ItemID.Sets.IsAKite[sItem.type])
		{
			flag = false;
		}
		if (sItem.type == 3611 && (WiresUI.Settings.ToolMode & (WiresUI.Settings.MultiToolMode.Red | WiresUI.Settings.MultiToolMode.Green | WiresUI.Settings.MultiToolMode.Blue | WiresUI.Settings.MultiToolMode.Yellow | WiresUI.Settings.MultiToolMode.Actuator)) == 0)
		{
			flag = false;
		}
		if (sItem.type == 5451 && ownedProjectileCounts[1020] > 0)
		{
			flag = false;
		}
		if (sItem.type == 5738 && ownedProjectileCounts[1105] > 0)
		{
			flag = false;
		}
		if ((sItem.type == 3611 || sItem.type == 3625) && wireOperationsCooldown > 0)
		{
			flag = false;
		}
		if (!CheckDD2CrystalPaymentLock(sItem))
		{
			flag = false;
		}
		if (sItem.shoot > -1 && ProjectileID.Sets.IsADD2Turret[sItem.shoot] && !downedDD2EventAnyDifficulty && !DD2Event.Ongoing)
		{
			flag = false;
		}
		if (sItem.shoot > -1 && ProjectileID.Sets.IsADD2Turret[sItem.shoot] && DD2Event.Ongoing && num == Main.myPlayer)
		{
			FindSentryRestingSpot(sItem.shoot, out var worldX, out var worldY, out var _);
			if (WouldSpotOverlapWithSentry(worldX, worldY, sItem.shoot == 688 || sItem.shoot == 689 || sItem.shoot == 690))
			{
				flag = false;
			}
		}
		if (sItem.shoot > -1 && ProjectileID.Sets.IsADD2Turret[sItem.shoot] && num == Main.myPlayer)
		{
			FindSentryRestingSpot(sItem.shoot, out var worldX2, out var worldY2, out var _);
			worldX2 /= 16;
			worldY2 /= 16;
			worldY2--;
			if (sItem.shoot == 688 || sItem.shoot == 689 || sItem.shoot == 690)
			{
				if (Collision.SolidTiles(worldX2, worldX2, worldY2 - 2, worldY2))
				{
					flag = false;
				}
			}
			else if (WorldGen.SolidTile(worldX2, worldY2))
			{
				flag = false;
			}
		}
		if (wet && !lavaWet && (sItem.shoot == 85 || sItem.shoot == 15 || sItem.shoot == 34))
		{
			flag = false;
		}
		if (sItem.makeNPC > 0 && !NPC.CanReleaseNPCs(whoAmI))
		{
			flag = false;
		}
		if (whoAmI == Main.myPlayer && sItem.type == 603 && !Main.runningCollectorsEdition)
		{
			flag = false;
		}
		if (sItem.type == 1071 || sItem.type == 1072 || sItem.type == 1543 || sItem.type == 1544)
		{
			bool flag2 = false;
			for (int i = 0; i < 58; i++)
			{
				if (inventory[i].PaintOrCoating)
				{
					flag2 = true;
					break;
				}
			}
			if (!flag2)
			{
				flag = false;
			}
		}
		bool flag3 = ignoreCursed;
		if (mount.Active && mount.DismountOnItemUse && mount.CanDismount(this) && noItems && !cursed)
		{
			flag3 = true;
		}
		if (noItems && !flag3)
		{
			flag = false;
		}
		if (sItem.tileWand > 0)
		{
			int tileWand = sItem.tileWand;
			flag = false;
			for (int j = 0; j < 58; j++)
			{
				if (tileWand == inventory[j].type && inventory[j].stack > 0)
				{
					flag = true;
					break;
				}
			}
		}
		if (sItem.shoot == 6 || sItem.shoot == 19 || sItem.shoot == 33 || sItem.shoot == 52 || sItem.shoot == 113 || sItem.shoot == 320 || sItem.shoot == 333 || sItem.shoot == 383 || sItem.shoot == 491 || sItem.shoot == 867 || sItem.shoot == 1052 || sItem.shoot == 902 || sItem.shoot == 866 || ProjectileID.Sets.IsAPhaseblade[sItem.shoot] || sItem.shoot == 301)
		{
			for (int k = 0; k < 1000; k++)
			{
				if (Main.projectile[k].active && Main.projectile[k].owner == whoAmI && Main.projectile[k].type == sItem.shoot)
				{
					flag = false;
				}
			}
		}
		if (sItem.shoot == 106)
		{
			int num2 = 0;
			for (int l = 0; l < 1000; l++)
			{
				if (Main.projectile[l].active && Main.projectile[l].owner == whoAmI && Main.projectile[l].type == sItem.shoot)
				{
					num2++;
				}
			}
			if (num2 >= 6)
			{
				flag = false;
			}
		}
		if (sItem.shoot == 272)
		{
			int num3 = 0;
			for (int m = 0; m < 1000; m++)
			{
				if (Main.projectile[m].active && Main.projectile[m].owner == whoAmI && Main.projectile[m].type == sItem.shoot)
				{
					num3++;
				}
			}
			if (num3 >= 10)
			{
				flag = false;
			}
		}
		if (sItem.shoot == 1000)
		{
			int num4 = 0;
			for (int n = 0; n < 1000; n++)
			{
				if (Main.projectile[n].active && Main.projectile[n].owner == whoAmI && Main.projectile[n].type == sItem.shoot)
				{
					num4++;
				}
			}
			if (num4 >= 3)
			{
				flag = false;
			}
		}
		if (sItem.potion && potionDelay > 0)
		{
			flag = false;
		}
		if (sItem.mana > 0 && silence)
		{
			flag = false;
		}
		if (sItem.mana > 0 && flag)
		{
			flag = ItemCheck_CheckCanUse_CanPayMana(sItem, flag);
		}
		if (gravDir == -1f && GolfHelper.IsPlayerHoldingClub(this))
		{
			flag = false;
		}
		if (sItem.type == 43 && Main.IsItDay())
		{
			flag = false;
		}
		if (sItem.type == 544 && Main.IsItDay())
		{
			flag = false;
		}
		if (sItem.type == 556 && Main.IsItDay())
		{
			flag = false;
		}
		if (sItem.type == 557 && Main.IsItDay())
		{
			flag = false;
		}
		if (sItem.type == 70 && !ZoneCorrupt)
		{
			flag = false;
		}
		if (sItem.type == 1133 && !ZoneJungle)
		{
			flag = false;
		}
		if (sItem.type == 5120 && !ZoneSnow)
		{
			flag = false;
		}
		if (sItem.type == 1844 && (Main.dayTime || Main.pumpkinMoon || Main.snowMoon || DD2Event.Ongoing))
		{
			flag = false;
		}
		if (sItem.type == 1958 && (Main.dayTime || Main.pumpkinMoon || Main.snowMoon || DD2Event.Ongoing))
		{
			flag = false;
		}
		if (sItem.type == 2767 && (!Main.dayTime || Main.eclipse || !Main.hardMode))
		{
			flag = false;
		}
		if (sItem.type == 4271 && (Main.dayTime || Main.bloodMoon))
		{
			flag = false;
		}
		if (sItem.type == 3601 && (!NPC.downedGolemBoss || !Main.hardMode || NPC.AnyDanger() || NPC.AnyoneNearCultists()))
		{
			flag = false;
		}
		if (!SummonItemCheck(sItem))
		{
			flag = false;
		}
		if (sItem.chlorophyteExtractinatorConsumable && flag && num == Main.myPlayer)
		{
			Tile tile = Main.tile[screenTargetTileX, screenTargetTileY];
			if (!tile.active() || (tile.type != 642 && tile.type != 219))
			{
				flag = false;
			}
		}
		if (ItemID.Sets.HasAProjectileThatHasAUsabilityCheck[sItem.type])
		{
			flag = ItemCheck_CheckUsabilityOfProjectiles(flag);
		}
		if (ItemID.Sets.ShootsOnUseRelease[sItem.type])
		{
			flag &= itemTime == 0;
		}
		if (sItem.shoot == 17 && flag && num == Main.myPlayer)
		{
			if (!ItemCheck_IsValidDirtRodTarget(Main.tile[screenTargetTileX, screenTargetTileY]))
			{
				flag = false;
			}
			if (!WorldGen.CanKillTile(screenTargetTileX, screenTargetTileY))
			{
				flag = false;
			}
		}
		if (flag && sItem.mountType != -1 && !mount.CanMount(sItem.mountType, this))
		{
			flag = false;
		}
		if (flag)
		{
			flag = HasAmmo(sItem, flag);
		}
		return flag;
	}

	private void GetTargetTileWithReverseGravity(out int screenTargetTileX, out int screenTargetTileY)
	{
		screenTargetTileX = (int)((float)Main.mouseX + Main.screenPosition.X) / 16;
		screenTargetTileY = (int)((float)Main.mouseY + Main.screenPosition.Y) / 16;
		if (gravDir == -1f)
		{
			screenTargetTileY = (int)(Main.screenPosition.Y + (float)Main.screenHeight - (float)Main.mouseY) / 16;
		}
	}

	private bool ItemCheck_CheckCanUse_KillDirtBlock(Item sItem)
	{
		if (sItem.shoot == 17 && whoAmI == Main.myPlayer)
		{
			GetTargetTileWithReverseGravity(out var screenTargetTileX, out var screenTargetTileY);
			if (ItemCheck_IsValidDirtRodTarget(Main.tile[screenTargetTileX, screenTargetTileY]))
			{
				WorldGen.KillTile(screenTargetTileX, screenTargetTileY, fail: false, effectOnly: false, noItem: true);
				if (!Main.tile[screenTargetTileX, screenTargetTileY].active())
				{
					if (Main.netMode == 1)
					{
						NetMessage.SendData(17, -1, -1, null, 4, screenTargetTileX, screenTargetTileY);
					}
					return true;
				}
			}
			return false;
		}
		return true;
	}

	private bool ItemCheck_CheckUsabilityOfProjectiles(bool canUse)
	{
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.owner == whoAmI)
			{
				projectile.CheckUsability(this, ref canUse);
			}
		}
		return canUse;
	}

	private bool ItemCheck_PullFishingBobbers(Item sItem)
	{
		if (sItem.fishingPole <= 0)
		{
			return true;
		}
		bool result = true;
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (!projectile.active || projectile.owner != whoAmI || !projectile.bobber)
			{
				continue;
			}
			result = false;
			if (whoAmI == Main.myPlayer && projectile.ai[0] == 0f)
			{
				projectile.ai[0] = 1f;
				float num = -10f;
				if (projectile.wet && projectile.velocity.Y > num)
				{
					projectile.velocity.Y = num;
				}
				projectile.netUpdate2 = true;
				if (projectile.ai[1] < 0f && projectile.localAI[1] != 0f && ItemCheck_CheckFishingBobber_ConsumeBait(projectile, out var baitTypeUsed))
				{
					ItemCheck_CheckFishingBobber_PullBobber(projectile, baitTypeUsed);
				}
			}
		}
		return result;
	}

	private void ItemCheck_CheckFishingBobber_PullBobber(Projectile bobber, int baitTypeUsed)
	{
		if (baitTypeUsed == 2673)
		{
			if (Main.netMode != 1)
			{
				NPC.SpawnOnPlayer(whoAmI, 370);
			}
			else
			{
				NetMessage.SendData(61, -1, -1, null, whoAmI, 370f);
			}
			bobber.ai[0] = 2f;
		}
		else if (bobber.localAI[1] < 0f)
		{
			Point point = new Point((int)bobber.position.X, (int)bobber.position.Y);
			int num = (int)(0f - bobber.localAI[1]);
			if (num == 618)
			{
				point.Y += 64;
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendData(130, -1, -1, null, point.X / 16, point.Y / 16, num);
			}
			else
			{
				if (num == 682)
				{
					NPC.unlockedSlimeRedSpawn = true;
				}
				NPC.NewNPC(new EntitySource_FishedOut(this), point.X, point.Y, num);
				bobber.ai[0] = 2f;
				WorldGen.CheckAchievement_RealEstateAndTownSlimes();
			}
		}
		else if (Main.rand.Next(7) == 0 && !accFishingLine)
		{
			bobber.ai[0] = 2f;
		}
		else
		{
			bobber.ai[1] = bobber.localAI[1];
		}
		bobber.netUpdate = true;
	}

	private bool ItemCheck_CheckFishingBobber_ConsumeBait(Projectile bobber, out int baitTypeUsed)
	{
		int num = -1;
		for (int i = 54; i < 58; i++)
		{
			if (inventory[i].stack > 0 && (float)inventory[i].type == bobber.localAI[2])
			{
				num = i;
				break;
			}
		}
		if (num == -1)
		{
			for (int j = 0; j < 50; j++)
			{
				if (inventory[j].stack > 0 && (float)inventory[j].type == bobber.localAI[2])
				{
					num = j;
					break;
				}
			}
		}
		if (num == -1)
		{
			baitTypeUsed = 0;
			return false;
		}
		Item item = inventory[num];
		bool flag = false;
		float num2 = 1f + (float)item.bait / 6f;
		if (num2 < 1f)
		{
			num2 = 1f;
		}
		if (accTackleBox)
		{
			num2 += 1f;
		}
		if (Main.rand.NextFloat() * num2 < 1f)
		{
			flag = true;
		}
		if (bobber.localAI[1] == -1f)
		{
			flag = true;
		}
		if (bobber.localAI[1] > 0f)
		{
			Item item2 = new Item();
			item2.SetDefaults((int)bobber.localAI[1]);
			if (item2.rare < 0)
			{
				flag = false;
			}
		}
		baitTypeUsed = item.type;
		if (baitTypeUsed == 2895)
		{
			flag = Main.rand.Next(20) == 0;
		}
		if (baitTypeUsed == 2673)
		{
			flag = true;
		}
		if (flag)
		{
			if (item.type == 4361 || item.type == 4362)
			{
				NPC.LadyBugKilled(base.Center, item.type == 4362);
			}
			item.stack--;
			if (item.stack <= 0)
			{
				item.SetDefaults(0);
			}
		}
		return true;
	}

	private static bool ItemCheck_IsValidDirtRodTarget(Tile t)
	{
		if (!t.active())
		{
			return false;
		}
		switch (t.type)
		{
		default:
			return false;
		case 0:
		case 2:
		case 23:
		case 109:
		case 199:
		case 477:
		case 492:
			return true;
		}
	}

	public bool CheckManaPredictWithoutUse(int amountBeforeManaCost, bool allowQuickMana = true)
	{
		int num = (int)((float)amountBeforeManaCost * manaCost);
		if (statMana >= num)
		{
			return true;
		}
		if (!allowQuickMana)
		{
			return false;
		}
		Item item = QuickMana_GetItemToUse();
		if (item == null)
		{
			return false;
		}
		if (Math.Min(statMana + item.healMana, statManaMax2) >= num)
		{
			return true;
		}
		return false;
	}

	public bool CheckMana(int amount, bool pay = false, bool blockQuickMana = false)
	{
		int num = (int)((float)amount * manaCost);
		if (statMana >= num)
		{
			if (pay)
			{
				statMana -= num;
			}
			return true;
		}
		if (manaFlower && !blockQuickMana)
		{
			QuickMana();
			if (statMana >= num)
			{
				if (pay)
				{
					statMana -= num;
				}
				return true;
			}
			return false;
		}
		return false;
	}

	private bool ItemCheck_CheckCanUse_CanPayMana(Item sItem, bool canUse)
	{
		GetItemManaUsageDetails(sItem, out var skipUsageCheck, out var rawAmountToPay, out var _);
		if (skipUsageCheck)
		{
			return canUse;
		}
		if (!CheckManaPredictWithoutUse(rawAmountToPay))
		{
			return false;
		}
		return canUse;
	}

	private bool ItemCheck_ActuallyPayMana(Item sItem)
	{
		GetItemManaUsageDetails(sItem, out var skipUsageCheck, out var rawAmountToPay, out var freeUsage);
		if (skipUsageCheck)
		{
			return true;
		}
		if (!CheckMana(rawAmountToPay, !freeUsage))
		{
			return false;
		}
		return true;
	}

	private void GetItemManaUsageDetails(Item sItem, out bool skipUsageCheck, out int rawAmountToPay, out bool freeUsage)
	{
		bool altFire = altFunctionUse == 2;
		skipUsageCheck = ItemCheck_PayMana_ShouldSkipManaUse(sItem, altFire);
		rawAmountToPay = ItemCheck_PayMana_GetManaCostToPay(sItem, altFire);
		freeUsage = ItemCheck_PayMana_ShouldPayManaAfterCheck(sItem);
	}

	private static bool ItemCheck_PayMana_ShouldPayManaAfterCheck(Item sItem)
	{
		bool result = false;
		if (sItem.type == 2795)
		{
			result = true;
		}
		if (sItem.type == 3006)
		{
			result = true;
		}
		return result;
	}

	private static int ItemCheck_PayMana_GetManaCostToPay(Item sItem, bool altFire)
	{
		int num = sItem.mana;
		if (sItem.type == 3852 && altFire)
		{
			num *= 2;
		}
		return num;
	}

	private bool ItemCheck_PayMana_ShouldSkipManaUse(Item sItem, bool altFire)
	{
		if (sItem.type == 3269)
		{
			return true;
		}
		if (spaceGun && (sItem.type == 127 || sItem.type == 4347 || sItem.type == 4348 || sItem.type == 514))
		{
			return true;
		}
		if (sItem.shoot > 0 && ProjectileID.Sets.TurretFeature[sItem.shoot] && altFire)
		{
			return true;
		}
		if (sItem.shoot > 0 && ProjectileID.Sets.MinionTargettingFeature[sItem.shoot] && altFire)
		{
			return true;
		}
		return false;
	}

	private void ItemCheck_TryPlacingWearablesOnMannequins(Item sItem)
	{
		if (!controlUseItem || !releaseUseItem || (sItem.headSlot <= 0 && sItem.bodySlot <= 0 && sItem.legSlot <= 0))
		{
			return;
		}
		if (sItem.useStyle == 0)
		{
			releaseUseItem = false;
		}
		if (!IsInTileInteractionRange(tileTargetX, tileTargetY, TileReachCheckSettings.Simple, sItem.tileBoost))
		{
			return;
		}
		int num = tileTargetX;
		int num2 = tileTargetY;
		if (!Main.tile[num, num2].active() || (Main.tile[num, num2].type != 128 && Main.tile[num, num2].type != 269))
		{
			return;
		}
		int frameY = Main.tile[num, num2].frameY;
		int num3 = 0;
		if (sItem.bodySlot >= 0)
		{
			num3 = 1;
		}
		if (sItem.legSlot >= 0)
		{
			num3 = 2;
		}
		frameY /= 18;
		while (num3 > frameY)
		{
			num2++;
			frameY = Main.tile[num, num2].frameY;
			frameY /= 18;
		}
		while (num3 < frameY)
		{
			num2--;
			frameY = Main.tile[num, num2].frameY;
			frameY /= 18;
		}
		int num4;
		for (num4 = Main.tile[num, num2].frameX; num4 >= 100; num4 -= 100)
		{
		}
		if (num4 >= 36)
		{
			num4 -= 36;
		}
		num -= num4 / 18;
		int num5 = Main.tile[num, num2].frameX;
		WorldGen.KillTile(num, num2, fail: true);
		if (Main.netMode == 1)
		{
			NetMessage.SendData(17, -1, -1, null, 0, num, num2, 1f);
		}
		while (num5 >= 100)
		{
			num5 -= 100;
		}
		if (frameY == 0 && sItem.headSlot >= 0)
		{
			Main.blockMouse = true;
			Main.tile[num, num2].frameX = (short)(num5 + sItem.headSlot * 100);
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, num, num2);
			}
			sItem.stack--;
			if (sItem.stack <= 0)
			{
				sItem.SetDefaults(0);
				Main.mouseItem.SetDefaults(0);
			}
			if (selectedItem == 58)
			{
				Main.mouseItem = sItem.Clone();
			}
			releaseUseItem = false;
			mouseInterface = true;
		}
		else if (frameY == 1 && sItem.bodySlot >= 0)
		{
			Main.blockMouse = true;
			Main.tile[num, num2].frameX = (short)(num5 + sItem.bodySlot * 100);
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, num, num2);
			}
			sItem.stack--;
			if (sItem.stack <= 0)
			{
				sItem.SetDefaults(0);
				Main.mouseItem.SetDefaults(0);
			}
			if (selectedItem == 58)
			{
				Main.mouseItem = sItem.Clone();
			}
			releaseUseItem = false;
			mouseInterface = true;
		}
		else if (frameY == 2 && sItem.legSlot >= 0 && !ArmorIDs.Legs.Sets.MannequinIncompatible.Contains(sItem.legSlot))
		{
			Main.blockMouse = true;
			Main.tile[num, num2].frameX = (short)(num5 + sItem.legSlot * 100);
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, num, num2);
			}
			sItem.stack--;
			if (sItem.stack <= 0)
			{
				sItem.SetDefaults(0);
				Main.mouseItem.SetDefaults(0);
			}
			if (selectedItem == 58)
			{
				Main.mouseItem = sItem.Clone();
			}
			releaseUseItem = false;
			mouseInterface = true;
		}
	}

	private void ApplyReuseDelay()
	{
		itemAnimation = reuseDelay;
		itemTime = reuseDelay;
		reuseDelay = 0;
	}

	private void ItemCheck_HackHoldStyles(Item sItem)
	{
		if (sItem.fishingPole > 0)
		{
			sItem.holdStyle = 0;
			if (ItemTimeIsZero && itemAnimation == 0)
			{
				for (int i = 0; i < 1000; i++)
				{
					if (Main.projectile[i].active && Main.projectile[i].owner == whoAmI && Main.projectile[i].bobber)
					{
						sItem.holdStyle = 1;
					}
				}
			}
		}
		if (!ItemID.Sets.IsAKite[sItem.type])
		{
			return;
		}
		sItem.holdStyle = 0;
		if (!ItemTimeIsZero || itemAnimation != 0)
		{
			return;
		}
		for (int j = 0; j < 1000; j++)
		{
			if (Main.projectile[j].active && Main.projectile[j].owner == whoAmI && Main.projectile[j].type == sItem.shoot)
			{
				sItem.holdStyle = 1;
				ChangeDir((!(Main.projectile[j].Center.X - base.Center.X < 0f)) ? 1 : (-1));
			}
		}
	}

	private void ItemCheck_AutoReuseLogic(Item sItem)
	{
		if (selectedItemState.HasBufferedChange && (sItem.shoot <= 0 || ItemTimeIsZero))
		{
			return;
		}
		if (sItem.autoReuse && !noItems)
		{
			releaseUseItem = true;
			if (itemAnimation == 1 && sItem.stack > 0)
			{
				if (sItem.shoot > 0 && whoAmI != Main.myPlayer && controlUseItem && sItem.useStyle == 5 && sItem.reuseDelay == 0 && lastItemUseAttemptSuccess)
				{
					ApplyItemAnimation(sItem);
				}
				else
				{
					itemAnimation = 0;
					if (ItemID.Sets.ShootsOnUseRelease[sItem.type])
					{
						controlUseItem = true;
					}
				}
			}
		}
		TryAllowingItemReuse(sItem);
	}

	private void TryAllowingItemReuse(Item sItem)
	{
		bool flag = false;
		if (autoReuseGlove)
		{
			flag |= sItem.melee && sItem.type != 3030;
			flag |= sItem.summon && ItemID.Sets.SummonerWeaponThatScalesWithAttackSpeed[sItem.type];
		}
		if ((stressBall || autoReuseAllWeapons) && sItem.damage > 0 && (!sItem.channel || !channel))
		{
			flag = true;
		}
		if (flag)
		{
			releaseUseItem = true;
		}
	}

	private void ItemCheck_HandleMount()
	{
		if (!mount.Active)
		{
			return;
		}
		if (whoAmI == Main.myPlayer && gravDir == -1f)
		{
			mount.TryDismount(this);
		}
		else
		{
			if (mount.Type != 8)
			{
				return;
			}
			noItems = true;
			if (controlUseItem || controlUseTile)
			{
				StartChanneling();
				if (releaseUseItem && releaseUseTile)
				{
					mount.UseAbility(this, Vector2.Zero, toggleOn: true);
				}
				releaseUseItem = false;
				releaseUseTile = false;
			}
		}
	}

	public void StartChanneling()
	{
		channel = true;
		_channelShotCache = default(ChannelCancelKey);
	}

	public void StartChanneling(Item item)
	{
		if (item.channel)
		{
			channel = true;
			_channelShotCache = new ChannelCancelKey
			{
				ProjectileTypeExpected = item.shoot
			};
		}
	}

	public void TryUpdateChannel(Projectile projectile)
	{
		_channelShotCache.TryTracking(projectile);
	}

	public void TryCancelChannel(Projectile projectile)
	{
		if (_channelShotCache.Matches(projectile))
		{
			channel = false;
		}
	}

	public static bool WouldSpotOverlapWithSentry(int worldX, int worldY, bool lightningAura)
	{
		Point value = new Point(worldX, worldY - 8);
		Point value2 = new Point(worldX + 16, worldY - 8);
		Point value3 = new Point(worldX - 16, worldY - 8);
		bool result = false;
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.sentry)
			{
				Rectangle hitbox = projectile.Hitbox;
				if (lightningAura)
				{
					hitbox.Inflate(8, 0);
				}
				else if (hitbox.X > 30)
				{
					hitbox.X += hitbox.Width / 2;
					hitbox.Width = 30;
					hitbox.X -= hitbox.Width / 2;
				}
				if (hitbox.Contains(value) || hitbox.Contains(value2) || hitbox.Contains(value3))
				{
					result = true;
					break;
				}
			}
		}
		return result;
	}

	public void FindSentryRestingSpot(int checkProj, out int worldX, out int worldY, out int pushYUp)
	{
		bool flag = false;
		Vector2 pointPosition = Main.MouseWorld;
		LimitPointToPlayerReachableArea(ref pointPosition);
		int num = (int)pointPosition.X / 16;
		int i = (int)pointPosition.Y / 16;
		worldX = num * 16 + 8;
		pushYUp = 41;
		switch (checkProj)
		{
		case 663:
			worldX += direction;
			break;
		case 665:
			pushYUp += 2;
			break;
		case 667:
			pushYUp += 3;
			break;
		case 677:
			worldX += direction;
			break;
		case 678:
			worldX += direction;
			break;
		case 691:
		case 692:
		case 693:
			pushYUp = 20;
			worldX += direction;
			pushYUp += 2;
			break;
		}
		if (!flag)
		{
			for (; i < Main.maxTilesY - 10 && Main.tile[num, i] != null && !WorldGen.SolidTile2(num, i) && Main.tile[num - 1, i] != null && !WorldGen.SolidTile2(num - 1, i) && Main.tile[num + 1, i] != null && !WorldGen.SolidTile2(num + 1, i); i++)
			{
			}
			i++;
		}
		i--;
		pushYUp -= 14;
		worldY = i * 16;
	}

	public void UpdateMaxTurrets()
	{
		if (Main.myPlayer != whoAmI)
		{
			return;
		}
		List<Projectile> list = new List<Projectile>();
		for (int i = 0; i < 1000; i++)
		{
			if (Main.projectile[i].WipableTurret)
			{
				list.Add(Main.projectile[i]);
			}
		}
		int num = 0;
		while (list.Count > maxTurrets && ++num < 1000)
		{
			Projectile projectile = list[0];
			for (int j = 1; j < list.Count; j++)
			{
				if (list[j].timeLeft < projectile.timeLeft)
				{
					projectile = list[j];
				}
			}
			projectile.Kill();
			list.Remove(projectile);
		}
	}

	private void ItemCheck_ApplyPetBuffs(Item sItem)
	{
		if (whoAmI == Main.myPlayer && sItem.type == 603 && Main.runningCollectorsEdition)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 669)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 115)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 3060)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 3628)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 3062)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 3577)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 425)
		{
			int num = Main.rand.Next(3);
			if (num == 0)
			{
				num = 27;
			}
			if (num == 1)
			{
				num = 101;
			}
			if (num == 2)
			{
				num = 102;
			}
			for (int i = 0; i < maxBuffs; i++)
			{
				if (buffType[i] == 27 || buffType[i] == 101 || buffType[i] == 102)
				{
					DelBuff(i);
					i--;
				}
			}
			AddBuff(num, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 753)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 994)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1169)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1170)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1171)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1172)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1180)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1181)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1182)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1183)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1242)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1157)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1309)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1311)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1837)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1312)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1798)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1799)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1802)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1810)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1927)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 1959)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 2364)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 2365)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 3043)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer && sItem.type == 2420)
		{
			AddBuff(sItem.buffType, 3600);
		}
		if (whoAmI == Main.myPlayer)
		{
			switch (sItem.type)
			{
			case 2535:
			case 2551:
			case 2584:
			case 2587:
			case 2621:
			case 2749:
			case 3249:
			case 3474:
			case 3531:
			case 4269:
			case 4273:
			case 4281:
			case 4607:
			case 4758:
			case 5005:
			case 5069:
			case 5114:
			case 5456:
			case 5663:
			case 5664:
				AddBuff(sItem.buffType, 3600);
				break;
			}
		}
		if (whoAmI == Main.myPlayer)
		{
			switch (sItem.type)
			{
			case 3855:
			case 3856:
			case 3857:
			case 4365:
			case 4366:
			case 4425:
			case 4550:
			case 4551:
			case 4603:
			case 4604:
			case 4605:
			case 4701:
			case 4735:
			case 4736:
			case 4737:
			case 4777:
			case 4797:
			case 4798:
			case 4799:
			case 4800:
			case 4801:
			case 4802:
			case 4803:
			case 4804:
			case 4805:
			case 4806:
			case 4807:
			case 4808:
			case 4809:
			case 4810:
			case 4811:
			case 4812:
			case 4813:
			case 4814:
			case 4815:
			case 4816:
			case 4817:
			case 4960:
			case 5088:
			case 5089:
			case 5090:
			case 5091:
			case 5098:
			case 5131:
			case 5276:
			case 5297:
			case 5332:
			case 5333:
			case 5400:
			case 5466:
			case 5513:
			case 5517:
			case 5523:
			case 5654:
				AddBuff(sItem.buffType, 3600);
				break;
			}
		}
	}

	public float GetWeaponKnockback(Item sItem, float KnockBack)
	{
		if (sItem.summon)
		{
			KnockBack += minionKB;
		}
		if (sItem.melee && kbGlove)
		{
			KnockBack *= 2f;
		}
		if (kbBuff)
		{
			KnockBack *= 1.5f;
		}
		if (sItem.ranged && shroomiteStealth)
		{
			KnockBack *= 1f + (1f - stealth) * 0.5f;
		}
		if (sItem.ranged && setVortex)
		{
			KnockBack *= 1f + (1f - stealth) * 0.5f;
		}
		return KnockBack;
	}

	public int GetWeaponCrit(Item sItem)
	{
		if (sItem.melee)
		{
			return meleeCrit;
		}
		if (sItem.ranged)
		{
			return rangedCrit;
		}
		if (sItem.magic)
		{
			return magicCrit;
		}
		return 0;
	}

	public float GetWeaponDamageMultiplier(Item item)
	{
		if (item.melee)
		{
			return meleeDamage;
		}
		if (item.ranged)
		{
			if (AmmoID.Sets.IsArrow[item.useAmmo] || AmmoID.Sets.IsArrow[item.ammo])
			{
				return bowEffectiveDamage;
			}
			if (AmmoID.Sets.IsBullet[item.useAmmo] || AmmoID.Sets.IsBullet[item.ammo])
			{
				return gunEffectiveDamage;
			}
			if (AmmoID.Sets.IsSpecialist[item.useAmmo] || AmmoID.Sets.IsSpecialist[item.ammo] || ItemID.Sets.IsRangedSpecialistWeapon[item.type])
			{
				return specialistEffectiveDamage;
			}
			return rangedDamage;
		}
		if (item.magic)
		{
			return magicDamage;
		}
		if (item.summon)
		{
			return minionDamage;
		}
		return 1f;
	}

	public int GetWeaponDamage(Item sItem)
	{
		int damage = sItem.damage;
		if (damage <= 0)
		{
			return damage;
		}
		return (int)((float)damage * GetWeaponDamageMultiplier(sItem) + 5E-06f);
	}

	public bool HasAmmo(Item sItem, bool canUse)
	{
		if (sItem.useAmmo > 0)
		{
			canUse = false;
			for (int i = 0; i < 58; i++)
			{
				if (inventory[i].ammo == sItem.useAmmo && inventory[i].stack > 0)
				{
					canUse = true;
					break;
				}
			}
		}
		return canUse;
	}

	private bool PickAmmo_TryFindingSpecificMatches(int launcher, int ammo, out int pickedProjectileId)
	{
		pickedProjectileId = 0;
		if (AmmoID.Sets.SpecificLauncherAmmoProjectileMatches.TryGetValue(launcher, out var value) && value.TryGetValue(ammo, out pickedProjectileId))
		{
			return true;
		}
		return false;
	}

	public void PickAmmo(Item sItem, ref int projToShoot, ref float speed, ref bool canShoot, ref int Damage, ref float KnockBack, out int usedAmmoItemId, bool dontConsume = false)
	{
		Item item = new Item();
		bool flag = false;
		usedAmmoItemId = 0;
		if (sItem.useAmmo == AmmoID.Coin)
		{
			for (int i = 0; i < 4; i++)
			{
				int num = 50 + i;
				if (inventory[num].ammo == sItem.useAmmo && inventory[num].stack > 0)
				{
					item = inventory[num];
					canShoot = true;
					flag = true;
					break;
				}
			}
		}
		for (int j = 54; j < 58; j++)
		{
			if (inventory[j].ammo == sItem.useAmmo && inventory[j].stack > 0)
			{
				item = inventory[j];
				canShoot = true;
				flag = true;
				break;
			}
		}
		if (!flag)
		{
			for (int k = 0; k < 54; k++)
			{
				if (inventory[k].ammo == sItem.useAmmo && inventory[k].stack > 0)
				{
					item = inventory[k];
					canShoot = true;
					break;
				}
			}
		}
		if (!canShoot)
		{
			return;
		}
		usedAmmoItemId = item.type;
		int pickedProjectileId = -1;
		if (PickAmmo_TryFindingSpecificMatches(sItem.type, item.type, out pickedProjectileId))
		{
			projToShoot = pickedProjectileId;
		}
		else if (sItem.type == 1946)
		{
			projToShoot = 338 + item.type - 771;
		}
		else if (sItem.type == 3930)
		{
			projToShoot = 715 + item.type - AmmoID.Rocket;
		}
		else if (sItem.useAmmo == AmmoID.Rocket)
		{
			projToShoot += item.shoot;
		}
		else if (sItem.useAmmo == AmmoID.Solution)
		{
			projToShoot += item.shoot;
		}
		else if (item.shoot > 0)
		{
			projToShoot = item.shoot;
		}
		if (sItem.type == 3019 && projToShoot == 1)
		{
			projToShoot = 485;
		}
		if (sItem.type == 3052)
		{
			projToShoot = 495;
		}
		if (sItem.type == 4953 && projToShoot == 1)
		{
			projToShoot = 932;
		}
		if (sItem.type == 4381)
		{
			projToShoot = 819;
		}
		if (sItem.type == 4058 && projToShoot == 474)
		{
			projToShoot = 117;
		}
		if (projToShoot == 42)
		{
			if (item.type == 370)
			{
				projToShoot = 65;
				Damage += 5;
			}
			else if (item.type == 408)
			{
				projToShoot = 68;
				Damage += 5;
			}
			else if (item.type == 1246)
			{
				projToShoot = 354;
				Damage += 5;
			}
		}
		if (inventory[selectedItem].type == 2888 && projToShoot == 1)
		{
			projToShoot = 469;
		}
		if (hasMoltenQuiver && projToShoot == 1)
		{
			projToShoot = 2;
			Damage += 2;
		}
		speed += item.shootSpeed;
		if (magicQuiver && (sItem.useAmmo == AmmoID.Arrow || sItem.useAmmo == AmmoID.Stake))
		{
			KnockBack *= 1.1f;
			speed *= 1.1f;
		}
		if (item.damage > 0)
		{
			Damage += (int)((float)item.damage * GetWeaponDamageMultiplier(item));
		}
		if (AmmoID.Sets.IsArrow[item.ammo] && archery && speed < 20f)
		{
			speed *= 1.2f;
			if (speed > 20f)
			{
				speed = 20f;
			}
		}
		KnockBack += item.knockBack;
		bool flag2 = dontConsume;
		if (sItem.type == 3475 && Main.rand.Next(3) != 0)
		{
			flag2 = true;
		}
		if (sItem.type == 3930 && Main.rand.Next(2) == 0)
		{
			flag2 = true;
		}
		if (sItem.type == 3540 && Main.rand.Next(3) != 0)
		{
			flag2 = true;
		}
		if (sItem.type == 5134 && Main.rand.Next(3) == 0)
		{
			flag2 = true;
		}
		if (magicQuiver && (sItem.useAmmo == AmmoID.Arrow || sItem.useAmmo == AmmoID.Stake) && Main.rand.Next(5) == 0)
		{
			flag2 = true;
		}
		if (ammoBox && Main.rand.Next(5) == 0)
		{
			flag2 = true;
		}
		if (ammoPotion && Main.rand.Next(5) == 0)
		{
			flag2 = true;
		}
		if (sItem.type == 1782 && Main.rand.Next(3) == 0)
		{
			flag2 = true;
		}
		if (sItem.type == 98 && Main.rand.Next(3) == 0)
		{
			flag2 = true;
		}
		if (sItem.type == 2270 && Main.rand.Next(2) == 0)
		{
			flag2 = true;
		}
		if (sItem.type == 533 && Main.rand.Next(2) == 0)
		{
			flag2 = true;
		}
		if (sItem.type == 1929 && Main.rand.Next(3) != 0)
		{
			flag2 = true;
		}
		if (sItem.type == 1553 && Main.rand.Next(3) != 0)
		{
			flag2 = true;
		}
		if (sItem.type == 434 && !ItemAnimationJustStarted)
		{
			flag2 = true;
		}
		if (sItem.type == 4953 && itemAnimation > sItem.useAnimation - 8)
		{
			flag2 = true;
		}
		if (sItem.type == 3821 && Main.rand.Next(100) < 69)
		{
			flag2 = true;
		}
		if (huntressAmmoCost90 && Main.rand.Next(10) == 0)
		{
			flag2 = true;
		}
		if (chloroAmmoCost80 && Main.rand.Next(5) == 0)
		{
			flag2 = true;
		}
		if (ammoCost80 && Main.rand.Next(5) == 0)
		{
			flag2 = true;
		}
		if (ammoCost75 && Main.rand.Next(4) == 0)
		{
			flag2 = true;
		}
		if (Main.remixWorld && sItem.type == 1319 && Main.rand.Next(2) == 0)
		{
			flag2 = true;
		}
		if (projToShoot == 85 && itemAnimation < itemAnimationMax - sItem.useTime)
		{
			flag2 = true;
		}
		if ((sItem.type == 779 || sItem.type == 5134) && itemAnimation < itemAnimationMax - sItem.useTime)
		{
			flag2 = true;
		}
		if (sItem.type == 5629)
		{
			flag2 = false;
		}
		if (!flag2 && item.consumable)
		{
			item.stack--;
			if (item.stack <= 0)
			{
				item.TurnToAir();
			}
		}
	}

	public void GetOtherPlayersPickTile(int x, int y, int pickDamage)
	{
		int tileId = hitTile.HitObject(x, y, 1);
		hitTile.AddDamage(tileId, pickDamage);
	}

	public void PickTile(int x, int y, int pickPower)
	{
		Tile tile = Main.tile[x, y];
		if (tile.type == 504)
		{
			return;
		}
		PickTile_DetermineDamage(x, y, pickPower, tile, out var bufferIndex, out var damage);
		if (hitTile.AddDamage(bufferIndex, damage) >= 100)
		{
			IntentionGuesser.AllowTracking();
			AchievementsHelper.CurrentlyMining = true;
			ClearMiningCacheAt(x, y, 1);
			if (Main.netMode == 1 && Main.tileContainer[Main.tile[x, y].type])
			{
				if (Main.tile[x, y].type == 470 || Main.tile[x, y].type == 475)
				{
					NetMessage.SendData(17, -1, -1, null, 20, x, y);
				}
				else
				{
					WorldGen.KillTile(x, y, fail: true);
					NetMessage.SendData(17, -1, -1, null, 0, x, y, 1f);
				}
				if (Main.tile[x, y].type == 21)
				{
					NetMessage.SendData(34, -1, -1, null, 1, x, y);
				}
				if (Main.tile[x, y].type == 467)
				{
					NetMessage.SendData(34, -1, -1, null, 5, x, y);
				}
				if (Main.tile[x, y].type == 88)
				{
					NetMessage.SendData(34, -1, -1, null, 3, x, y);
				}
			}
			else
			{
				bool flag = Main.tile[x, y].active();
				WorldGen.KillTile(x, y);
				if (!Main.dedServ && flag && !Main.tile[x, y].active())
				{
					AchievementsHelper.HandleMining();
				}
				if (Main.netMode == 1)
				{
					NetMessage.SendData(17, -1, -1, null, 0, x, y);
				}
			}
			AchievementsHelper.CurrentlyMining = false;
		}
		else
		{
			WorldGen.KillTile(x, y, fail: true);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 0, x, y, 1f);
				NetMessage.SendData(125, -1, -1, null, Main.myPlayer, x, y, damage);
			}
		}
		if (damage != 0)
		{
			hitTile.Prune();
		}
	}

	public void PickTile_DetermineDamage(int x, int y, int pickPower, Tile tileTarget, out int bufferIndex, out int damage)
	{
		bufferIndex = hitTile.HitObject(x, y, 1);
		damage = GetPickaxeDamage(x, y, pickPower, bufferIndex, tileTarget);
		if (!WorldGen.CanKillTile(x, y))
		{
			damage = 0;
		}
		if (Main.getGoodWorld)
		{
			damage *= 2;
		}
		if (DoesPickTargetTransformOnKill(hitTile, damage, x, y, pickPower, bufferIndex, tileTarget))
		{
			damage = 0;
		}
	}

	private void ClearMiningCacheAt(int x, int y, int hitTileCacheType)
	{
		hitReplace.TryClearingAndPruning(x, y, 1);
		hitTile.TryClearingAndPruning(x, y, 1);
	}

	public bool isNearFairy()
	{
		if (NPC.npcsFoundForCheckActive[583] || NPC.npcsFoundForCheckActive[584] || NPC.npcsFoundForCheckActive[585])
		{
			for (int i = 0; i < Main.maxNPCs; i++)
			{
				if (Main.npc[i].active && (Main.npc[i].type == 583 || Main.npc[i].type == 584 || Main.npc[i].type == 585) && Vector2.Distance(Main.npc[i].Center, base.Center) < (float)NPC.sWidth)
				{
					return true;
				}
			}
		}
		return false;
	}

	public bool isNearNPC(int type, float range = -1f)
	{
		if (range == -1f)
		{
			range = NPC.sWidth;
		}
		if (NPC.npcsFoundForCheckActive[type])
		{
			for (int i = 0; i < Main.maxNPCs; i++)
			{
				if (Main.npc[i].active && Main.npc[i].type == type && Vector2.Distance(Main.npc[i].Center, base.Center) < range)
				{
					return true;
				}
			}
		}
		return false;
	}

	public bool HasEnoughPickPowerToHurtTile(int x, int y)
	{
		Item bestPickaxe = GetBestPickaxe();
		if (bestPickaxe == null)
		{
			return false;
		}
		Tile tile = Main.tile[x, y];
		_ = tile.type;
		int hitBufferIndex = hitTile.HitObject(x, y, 1);
		if (GetPickaxeDamage(x, y, bestPickaxe.pick, hitBufferIndex, tile) == 0)
		{
			return false;
		}
		return true;
	}

	private int GetPickaxeDamage(int x, int y, int pickPower, int hitBufferIndex, Tile tileTarget)
	{
		int num = 0;
		if (Main.tileNoFail[tileTarget.type])
		{
			num = 100;
		}
		num = ((!Main.tileDungeon[tileTarget.type] && tileTarget.type != 58 && tileTarget.type != 25 && tileTarget.type != 117 && tileTarget.type != 203) ? ((tileTarget.type == 85) ? ((!Main.getGoodWorld) ? (num + pickPower) : (num + pickPower / 4)) : ((tileTarget.type != 48 && tileTarget.type != 232 && (tileTarget.type < 0 || !TileID.Sets.Clouds[tileTarget.type])) ? ((tileTarget.type == 226) ? (num + pickPower / 4) : ((tileTarget.type != 107 && tileTarget.type != 221) ? ((tileTarget.type != 108 && tileTarget.type != 222) ? ((tileTarget.type == 111 || tileTarget.type == 223) ? (num + pickPower / 4) : ((tileTarget.type != 211) ? (num + pickPower) : (num + pickPower / 5))) : (num + pickPower / 3)) : (num + pickPower / 2))) : (num + pickPower * 2))) : (num + pickPower / 2));
		if (tileTarget.type == 211 && pickPower < 200)
		{
			num = 0;
		}
		if (!Main.infectedSeed && (tileTarget.type == 25 || tileTarget.type == 203) && pickPower < 65)
		{
			num = 0;
		}
		else if (tileTarget.type == 117 && pickPower < 65)
		{
			num = 0;
		}
		else if (tileTarget.type == 37 && pickPower < 50)
		{
			num = 0;
		}
		else if ((tileTarget.type == 22 || tileTarget.type == 204) && (double)y > Main.worldSurface && pickPower < 55)
		{
			num = 0;
		}
		else if (tileTarget.type == 56 && pickPower < 55)
		{
			num = 0;
		}
		else if (tileTarget.type == 77 && pickPower < 65 && y >= Main.UnderworldLayer)
		{
			num = 0;
		}
		else if (tileTarget.type == 58 && pickPower < 65)
		{
			num = 0;
		}
		else if ((tileTarget.type == 226 || tileTarget.type == 237) && pickPower < 210)
		{
			num = 0;
		}
		else if (tileTarget.type == 137 && pickPower < 210 && (!Main.notTheBeesWorld || !Main.noTrapsWorld || Main.tenthAnniversaryWorld))
		{
			int num2 = tileTarget.frameY / 18;
			if ((uint)(num2 - 1) <= 3u)
			{
				num = 0;
			}
		}
		else if (Main.tileDungeon[tileTarget.type] && pickPower < 100 && (double)y > Main.worldSurface)
		{
			if ((double)x < (double)Main.maxTilesX * 0.35 || (double)x > (double)Main.maxTilesX * 0.65)
			{
				num = 0;
			}
		}
		else if ((tileTarget.type == 107 || tileTarget.type == 221) && pickPower < 100)
		{
			num = 0;
		}
		else if ((tileTarget.type == 108 || tileTarget.type == 222) && pickPower < 110)
		{
			num = 0;
		}
		else if ((tileTarget.type == 111 || tileTarget.type == 223) && pickPower < 150)
		{
			num = 0;
		}
		if (tileTarget.type == 147 || tileTarget.type == 0 || tileTarget.type == 40 || tileTarget.type == 53 || tileTarget.type == 57 || tileTarget.type == 59 || tileTarget.type == 123 || tileTarget.type == 224 || tileTarget.type == 397)
		{
			num += pickPower;
		}
		if (tileTarget.type == 404)
		{
			num += 5;
		}
		if (tileTarget.type == 165 || Main.tileRope[tileTarget.type] || tileTarget.type == 199)
		{
			num = 100;
		}
		if (tileTarget.type == 128 || tileTarget.type == 269)
		{
			if (tileTarget.frameX == 18 || tileTarget.frameX == 54)
			{
				x--;
				tileTarget = Main.tile[x, y];
				hitTile.UpdatePosition(hitBufferIndex, x, y);
			}
			if (tileTarget.frameX >= 100)
			{
				num = 0;
				Main.blockMouse = true;
			}
		}
		if (tileTarget.type == 334)
		{
			if (tileTarget.frameY == 0)
			{
				y++;
				tileTarget = Main.tile[x, y];
				hitTile.UpdatePosition(hitBufferIndex, x, y);
			}
			if (tileTarget.frameY == 36)
			{
				y--;
				tileTarget = Main.tile[x, y];
				hitTile.UpdatePosition(hitBufferIndex, x, y);
			}
			int frameX = tileTarget.frameX;
			bool flag = frameX >= 5000;
			bool flag2 = false;
			if (!flag)
			{
				int num3 = frameX / 18;
				num3 %= 3;
				x -= num3;
				tileTarget = Main.tile[x, y];
				if (tileTarget.frameX >= 5000)
				{
					flag = true;
				}
			}
			if (flag)
			{
				frameX = tileTarget.frameX;
				int num4 = 0;
				while (frameX >= 5000)
				{
					frameX -= 5000;
					num4++;
				}
				if (num4 != 0)
				{
					flag2 = true;
				}
			}
			if (flag2)
			{
				num = 0;
				Main.blockMouse = true;
			}
		}
		return num;
	}

	private bool DoesPickTargetTransformOnKill(HitTile hitCounter, int damage, int x, int y, int pickPower, int bufferIndex, Tile tileTarget)
	{
		if (hitCounter.AddDamage(bufferIndex, damage, updateAmount: false) >= 100 && (tileTarget.type == 2 || tileTarget.type == 477 || tileTarget.type == 492 || tileTarget.type == 23 || tileTarget.type == 60 || tileTarget.type == 70 || tileTarget.type == 109 || tileTarget.type == 199 || Main.tileMoss[tileTarget.type] || tileTarget.type == 662 || tileTarget.type == 661 || TileID.Sets.tileMossBrick[tileTarget.type] || tileTarget.type == 633))
		{
			return true;
		}
		return false;
	}

	public bool ItemFitsWeaponRack(Item i)
	{
		bool flag = false;
		if (i.fishingPole > 0)
		{
			flag = true;
		}
		int type = i.type;
		if (type == 905 || type == 1326 || type == 5335)
		{
			flag = true;
		}
		if ((i.damage > 0 || flag) && i.useStyle != 0)
		{
			return i.stack > 0;
		}
		return false;
	}

	public void PlaceWeapon(int x, int y)
	{
		if (Main.tile[x, y].active() && Main.tile[x, y].type == 334)
		{
			int frameY = Main.tile[x, y].frameY;
			int num = 1;
			frameY /= 18;
			while (num > frameY)
			{
				y++;
				frameY = Main.tile[x, y].frameY;
				frameY /= 18;
			}
			while (num < frameY)
			{
				y--;
				frameY = Main.tile[x, y].frameY;
				frameY /= 18;
			}
			int num2 = Main.tile[x, y].frameX;
			int num3 = 0;
			while (num2 >= 5000)
			{
				num2 -= 5000;
				num3++;
			}
			if (num3 != 0)
			{
				num2 = (num3 - 1) * 18;
			}
			bool flag = false;
			if (num2 >= 54)
			{
				num2 -= 54;
				flag = true;
			}
			x -= num2 / 18;
			int num4 = Main.tile[x, y].frameX;
			WorldGen.KillTile(x, y, fail: true);
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 0, x, y, 1f);
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendData(17, -1, -1, null, 0, x + 1, y, 1f);
			}
			while (num4 >= 5000)
			{
				num4 -= 5000;
			}
			Main.blockMouse = true;
			int num5 = 5000;
			int num6 = 10000;
			if (flag)
			{
				num5 = 20000;
				num6 = 25000;
			}
			Main.tile[x, y].frameX = (short)(inventory[selectedItem].type + num5 + 100);
			Main.tile[x + 1, y].frameX = (short)(inventory[selectedItem].prefix + num6);
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, x, y);
			}
			if (Main.netMode == 1)
			{
				NetMessage.SendTileSquare(-1, x + 1, y);
			}
			inventory[selectedItem].stack--;
			if (inventory[selectedItem].stack <= 0)
			{
				inventory[selectedItem].SetDefaults(0);
				Main.mouseItem.SetDefaults(0);
			}
			if (selectedItem == 58)
			{
				Main.mouseItem = inventory[selectedItem].Clone();
			}
			releaseUseItem = false;
			mouseInterface = true;
		}
	}

	public bool ItemFitsItemFrame(Item i)
	{
		return i.stack > 0;
	}

	public Color GetImmuneAlpha(Color newColor, float alphaReduction)
	{
		float num = (float)(255 - immuneAlpha) / 255f;
		if (alphaReduction > 0f)
		{
			num *= 1f - alphaReduction;
		}
		if (shimmerTransparency > 0f)
		{
			if ((double)shimmerTransparency >= 0.8)
			{
				return Color.Transparent;
			}
			num *= 1f - shimmerTransparency;
			num *= 1f - shimmerTransparency;
			num *= 1f - shimmerTransparency;
		}
		if (immuneAlpha > 125)
		{
			return Color.Transparent;
		}
		return Color.Multiply(newColor, num);
	}

	public Color GetImmuneAlphaPure(Color newColor, float alphaReduction)
	{
		float num = (float)(255 - immuneAlpha) / 255f;
		if (alphaReduction > 0f)
		{
			num *= 1f - alphaReduction;
		}
		if (shimmerTransparency > 0f)
		{
			num *= 1f - shimmerTransparency;
		}
		return Color.Multiply(newColor, num);
	}

	public Color GetDeathAlpha(Color newColor)
	{
		int r = newColor.R + (int)((double)immuneAlpha * 0.9);
		int g = newColor.G + (int)((double)immuneAlpha * 0.5);
		int b = newColor.B + (int)((double)immuneAlpha * 0.5);
		int num = newColor.A + (int)((double)immuneAlpha * 0.4);
		if (num < 0)
		{
			num = 0;
		}
		if (num > 255)
		{
			num = 255;
		}
		return new Color(r, g, b, num);
	}

	public void addDPS(int dmg)
	{
		if (dpsStarted)
		{
			dpsLastHit = DateTime.Now;
			dpsDamage += dmg;
			dpsEnd = DateTime.Now;
		}
		else
		{
			dpsStarted = true;
			dpsStart = DateTime.Now;
			dpsEnd = DateTime.Now;
			dpsLastHit = DateTime.Now;
			dpsDamage = dmg;
		}
	}

	public void checkDPSTime()
	{
		int num = 3;
		if (dpsStarted && (DateTime.Now - dpsLastHit).Seconds >= num)
		{
			dpsStarted = false;
		}
	}

	public int getDPS()
	{
		TimeSpan timeSpan = dpsEnd - dpsStart;
		float num = (float)timeSpan.Milliseconds / 1000f;
		num += (float)timeSpan.Seconds;
		num += (float)timeSpan.Minutes / 60f;
		if (num >= 3f)
		{
			dpsStart = DateTime.Now;
			dpsStart = dpsStart.AddSeconds(-1.0);
			dpsDamage = (int)((float)dpsDamage / num);
			timeSpan = dpsEnd - dpsStart;
			num = (float)timeSpan.Milliseconds / 1000f;
			num += (float)timeSpan.Seconds;
			num += (float)timeSpan.Minutes / 60f;
		}
		if (num < 1f)
		{
			num = 1f;
		}
		return (int)((float)dpsDamage / num);
	}

	public long DropCoins()
	{
		IEntitySource itemSource_Death = GetItemSource_Death();
		long num = 0L;
		Item[] array = inventory;
		foreach (Item item in array)
		{
			if (item.IsACoin)
			{
				int num2 = item.stack / 2;
				if (Main.expertMode)
				{
					num2 = item.stack / 4;
				}
				if (Main.masterMode)
				{
					num2 = 0;
				}
				int num3 = item.stack - num2;
				if (item.type == 71)
				{
					num += num3;
				}
				if (item.type == 72)
				{
					num += (long)num3 * 100L;
				}
				if (item.type == 73)
				{
					num += (long)num3 * 10000L;
				}
				if (item.type == 74)
				{
					num += (long)num3 * 1000000L;
				}
				TryDroppingSingleItem(itemSource_Death, item, num3);
			}
		}
		return num;
	}

	public void DropItems(bool gemsOnly)
	{
		trashItem.TurnToAir(fullReset: true);
		IEntitySource itemSource_Death = GetItemSource_Death();
		Item[] array;
		if (gemsOnly)
		{
			array = inventory;
			foreach (Item item in array)
			{
				if ((item.type >= 1522 && item.type <= 1527) || item.type == 3643)
				{
					TryDroppingSingleItem(itemSource_Death, item);
				}
			}
			return;
		}
		array = inventory;
		foreach (Item item2 in array)
		{
			if (item2.type == 3507 || item2.type == 3506 || item2.type == 3509)
			{
				item2.TurnToAir(fullReset: true);
			}
			else
			{
				TryDroppingSingleItem(itemSource_Death, item2);
			}
		}
		array = armor;
		foreach (Item theItem in array)
		{
			TryDroppingSingleItem(itemSource_Death, theItem);
		}
		array = dye;
		foreach (Item theItem2 in array)
		{
			TryDroppingSingleItem(itemSource_Death, theItem2);
		}
		array = miscEquips;
		foreach (Item theItem3 in array)
		{
			TryDroppingSingleItem(itemSource_Death, theItem3);
		}
		array = miscDyes;
		foreach (Item theItem4 in array)
		{
			TryDroppingSingleItem(itemSource_Death, theItem4);
		}
		EquipmentLoadout[] loadouts = Loadouts;
		for (int i = 0; i < loadouts.Length; i++)
		{
			loadouts[i].TryDroppingItems(this, itemSource_Death);
		}
		inventory[0].SetDefaults(3507);
		inventory[0].Prefix(-1);
		inventory[1].SetDefaults(3509);
		inventory[1].Prefix(-1);
		inventory[2].SetDefaults(3506);
		inventory[2].Prefix(-1);
	}

	public void TryDroppingSingleItem(IEntitySource source, Item theItem)
	{
		TryDroppingSingleItem(source, theItem, theItem.stack);
	}

	public void TryDroppingSingleItem(IEntitySource source, Item theItem, int stack)
	{
		if (stack > 0 && Main.netMode != 1)
		{
			int num = Item.NewItem(source, (int)position.X, (int)position.Y, width, height, theItem.type, stack, noBroadcast: true, theItem.prefix);
			WorldItem obj = Main.item[num];
			obj.velocity.Y = (float)Main.rand.Next(-20, 1) * 0.2f;
			obj.velocity.X = (float)Main.rand.Next(-20, 21) * 0.2f;
			NetMessage.SendData(21, -1, -1, null, num);
		}
		theItem.stack -= stack;
		if (theItem.stack <= 0)
		{
			theItem.TurnToAir(fullReset: true);
		}
	}

	public void CopyVisuals(Player other)
	{
		skinVariant = other.skinVariant;
		direction = other.direction;
		selectedItemState = other.selectedItemState;
		extraAccessory = other.extraAccessory;
		skinColor = other.skinColor;
		eyeColor = other.eyeColor;
		hair = other.hair;
		hairColor = other.hairColor;
		shirtColor = other.shirtColor;
		underShirtColor = other.underShirtColor;
		pantsColor = other.pantsColor;
		shoeColor = other.shoeColor;
		position = other.position;
		velocity = other.velocity;
		statLife = other.statLife;
		statLifeMax = other.statLifeMax;
		statLifeMax2 = other.statLifeMax2;
		statMana = other.statMana;
		statManaMax = other.statManaMax;
		statManaMax2 = other.statManaMax2;
		hideMisc = other.hideMisc;
		for (int i = 0; i < 59; i++)
		{
			inventory[i] = other.inventory[i].Clone();
			if (i < armor.Length)
			{
				armor[i] = other.armor[i].Clone();
			}
			if (i < dye.Length)
			{
				dye[i] = other.dye[i].Clone();
			}
			if (i < miscEquips.Length)
			{
				miscEquips[i] = other.miscEquips[i].Clone();
			}
			if (i < miscDyes.Length)
			{
				miscDyes[i] = other.miscDyes[i].Clone();
			}
			if (i < hideVisibleAccessory.Length)
			{
				hideVisibleAccessory[i] = other.hideVisibleAccessory[i];
			}
		}
	}

	public Player clientClone(Player clonePlayer)
	{
		clonePlayer.zone1 = zone1;
		clonePlayer.zone2 = zone2;
		clonePlayer.zone3 = zone3;
		clonePlayer.zone4 = zone4;
		clonePlayer.zone5 = zone5;
		clonePlayer.townNPCs = townNPCs;
		clonePlayer.voidVaultInfo = voidVaultInfo;
		clonePlayer.luck = luck;
		clonePlayer.extraAccessory = extraAccessory;
		clonePlayer.MinionRestTargetPoint = MinionRestTargetPoint;
		clonePlayer.MinionAttackTargetNPC = MinionAttackTargetNPC;
		clonePlayer.direction = direction;
		clonePlayer.selectedItemState = selectedItemState;
		clonePlayer.controlUp = controlUp;
		clonePlayer.controlDown = controlDown;
		clonePlayer.controlLeft = controlLeft;
		clonePlayer.controlRight = controlRight;
		clonePlayer.controlJump = controlJump;
		clonePlayer.controlUseItem = controlUseItem;
		clonePlayer.controlDownHold = controlDownHold;
		clonePlayer.isOperatingAnotherEntity = isOperatingAnotherEntity;
		clonePlayer.autoReuseAllWeapons = autoReuseAllWeapons;
		clonePlayer.statLife = statLife;
		clonePlayer.statLifeMax = statLifeMax;
		clonePlayer.statMana = statMana;
		clonePlayer.statManaMax = statManaMax;
		clonePlayer.position.X = position.X;
		clonePlayer.tileEntityAnchor = tileEntityAnchor;
		clonePlayer.chest = chest;
		clonePlayer.talkNPC = talkNPC;
		clonePlayer.piggyBankProjTracker = piggyBankProjTracker;
		clonePlayer.voidLensChest = voidLensChest;
		clonePlayer.hideVisibleAccessory = hideVisibleAccessory;
		clonePlayer.hideMisc = hideMisc;
		clonePlayer.shieldRaised = shieldRaised;
		clonePlayer.lastItemUseAttemptSuccess = lastItemUseAttemptSuccess;
		clientCloneItem(trashItem, clonePlayer.trashItem);
		clientCloneItemArray(inventory, clonePlayer.inventory);
		clientCloneItemArray(armor, clonePlayer.armor);
		clientCloneItemArray(dye, clonePlayer.dye);
		clientCloneItemArray(miscEquips, clonePlayer.miscEquips);
		clientCloneItemArray(miscDyes, clonePlayer.miscDyes);
		clientCloneItemArray(bank.item, clonePlayer.bank.item);
		clientCloneItemArray(bank2.item, clonePlayer.bank2.item);
		clientCloneItemArray(bank3.item, clonePlayer.bank3.item);
		clientCloneItemArray(bank4.item, clonePlayer.bank4.item);
		clientCloneLoadouts(clonePlayer);
		Array.Copy(buffType, clonePlayer.buffType, buffType.Length);
		Array.Copy(buffTime, clonePlayer.buffTime, buffTime.Length);
		DpadRadial.CopyTo(clonePlayer.DpadRadial);
		CircularRadial.CopyTo(clonePlayer.CircularRadial);
		return clonePlayer;
	}

	public static void clientCloneItemArray(Item[] from, Item[] to)
	{
		for (int i = 0; i < from.Length; i++)
		{
			clientCloneItem(from[i], to[i]);
		}
	}

	public static void clientCloneItem(Item from, Item to)
	{
		to.type = from.type;
		to.stack = from.stack;
		to.prefix = from.prefix;
		to.favorited = from.favorited;
	}

	private void clientCloneLoadouts(Player clonePlayer)
	{
		clientCloneItemArray(armor, clonePlayer.armor);
		clientCloneItemArray(dye, clonePlayer.dye);
		for (int i = 0; i < Loadouts.Length; i++)
		{
			clientCloneItemArray(Loadouts[i].Armor, clonePlayer.Loadouts[i].Armor);
			clientCloneItemArray(Loadouts[i].Dye, clonePlayer.Loadouts[i].Dye);
		}
	}

	public static bool CheckSpawn(int x, int y)
	{
		bool flag = Main.tileSolid[379];
		Main.tileSolid[379] = true;
		bool result = CheckSpawn_Internal(x, y);
		Main.tileSolid[379] = flag;
		return result;
	}

	private static bool CheckSpawn_Internal(int x, int y)
	{
		if (x < 10 || x > Main.maxTilesX - 10 || y < 10 || y > Main.maxTilesX - 10)
		{
			return false;
		}
		if (Main.tile[x, y - 1] == null)
		{
			return false;
		}
		if (!Main.tile[x, y - 1].active() || Main.tile[x, y - 1].type != 79)
		{
			return false;
		}
		for (int i = x - 1; i <= x + 1; i++)
		{
			for (int j = y - 3; j < y; j++)
			{
				if (Main.tile[i, j] == null)
				{
					return false;
				}
				if (Main.tile[i, j].nactive() && Main.tileSolid[Main.tile[i, j].type] && !Main.tileSolidTop[Main.tile[i, j].type])
				{
					Main.NewText(Language.GetTextValue("Game.BedObstructed"), byte.MaxValue, 240, 20);
					return false;
				}
			}
		}
		if (!WorldGen.StartRoomCheck(x, y - 1))
		{
			string text = null;
			text = WorldGen.roomCheckFailureReason switch
			{
				TownNPCRoomCheckFailureReason.TooCloseToWorldEdge => "Game.BedTooCloseToWorldEdge", 
				TownNPCRoomCheckFailureReason.RoomIsTooBig => "Game.BedRoomIsTooBig", 
				TownNPCRoomCheckFailureReason.RoomIsTooSmall => "Game.BedRoomIsTooSmall", 
				TownNPCRoomCheckFailureReason.HoleInWallIsTooBig => "Game.BedRoomHasHolesInWall", 
				TownNPCRoomCheckFailureReason.TooManyUnsafeWalls => "Game.BedRoomHasUnsafeWalls", 
				_ => "Game.BedRoomIsNotValid", 
			};
			if (!string.IsNullOrEmpty(text))
			{
				Main.NewText(Language.GetTextValue(text), byte.MaxValue, 240, 20);
			}
			return false;
		}
		return true;
	}

	public void FindSpawn()
	{
		for (int i = 0; i < 200; i++)
		{
			if (spN[i] == null)
			{
				SpawnX = -1;
				SpawnY = -1;
				break;
			}
			if (spN[i] == Main.worldName && spI[i] == Main.worldID)
			{
				SpawnX = spX[i];
				SpawnY = spY[i];
				break;
			}
		}
	}

	public void RemoveSpawn()
	{
		SpawnX = -1;
		SpawnY = -1;
		for (int i = 0; i < 200 && spN[i] != null; i++)
		{
			if (spN[i] == Main.worldName && spI[i] == Main.worldID)
			{
				for (int j = i; j < 199; j++)
				{
					spN[j] = spN[j + 1];
					spI[j] = spI[j + 1];
					spX[j] = spX[j + 1];
					spY[j] = spY[j + 1];
				}
				spN[199] = null;
				spI[199] = 0;
				spX[199] = 0;
				spY[199] = 0;
				break;
			}
		}
	}

	public void ChangeSpawn(int x, int y)
	{
		for (int i = 0; i < 200 && spN[i] != null; i++)
		{
			if (spN[i] == Main.worldName && spI[i] == Main.worldID)
			{
				for (int num = i; num > 0; num--)
				{
					spN[num] = spN[num - 1];
					spI[num] = spI[num - 1];
					spX[num] = spX[num - 1];
					spY[num] = spY[num - 1];
				}
				spN[0] = Main.worldName;
				spI[0] = Main.worldID;
				spX[0] = x;
				spY[0] = y;
				FindSpawn();
				return;
			}
		}
		for (int num2 = 199; num2 > 0; num2--)
		{
			if (spN[num2 - 1] != null)
			{
				spN[num2] = spN[num2 - 1];
				spI[num2] = spI[num2 - 1];
				spX[num2] = spX[num2 - 1];
				spY[num2] = spY[num2 - 1];
			}
		}
		spN[0] = Main.worldName;
		spI[0] = Main.worldID;
		spX[0] = x;
		spY[0] = y;
		FindSpawn();
	}

	public static void SavePlayer(PlayerFileData playerFile, bool skipMapSave = false)
	{
		try
		{
			Main.Achievements.Save();
			InternalSaveMap(playerFile.IsCloudSave);
			if (!Main.ServerSideCharacter)
			{
				FileUtilities.ProtectedInvoke(delegate
				{
					InternalSavePlayerFile(playerFile);
				});
			}
		}
		catch (Exception exception)
		{
			FancyErrorPrinter.ShowFileSavingFailError(exception, playerFile.Path);
			throw;
		}
	}

	private static void InternalSavePlayerFile(PlayerFileData playerFile)
	{
		if (playerFile.ServerSideCharacter)
		{
			return;
		}
		string path = playerFile.Path;
		Player player = playerFile.Player;
		bool isCloudSave = playerFile.IsCloudSave;
		if (string.IsNullOrEmpty(path))
		{
			return;
		}
		if (FileUtilities.Exists(path, isCloudSave))
		{
			FileUtilities.Copy(path, path + ".bak", isCloudSave);
		}
		RijndaelManaged rijndaelManaged = new RijndaelManaged();
		using Stream stream = (isCloudSave ? ((Stream)new MemoryStream(2000)) : ((Stream)new FileStream(path, FileMode.Create)));
		using CryptoStream cryptoStream = new CryptoStream(stream, rijndaelManaged.CreateEncryptor(ENCRYPTION_KEY, ENCRYPTION_KEY), CryptoStreamMode.Write);
		using BinaryWriter binaryWriter = new BinaryWriter(cryptoStream);
		binaryWriter.Write(317);
		playerFile.Metadata.Write(binaryWriter);
		Serialize(playerFile, player, binaryWriter);
		binaryWriter.Flush();
		cryptoStream.FlushFinalBlock();
		stream.Flush();
		if (isCloudSave && SocialAPI.Cloud != null)
		{
			SocialAPI.Cloud.Write(playerFile.Path, ((MemoryStream)stream).ToArray());
		}
	}

	private static void Serialize(PlayerFileData playerFile, Player newPlayer, BinaryWriter fileIO)
	{
		fileIO.Write(newPlayer.name);
		fileIO.Write(newPlayer.difficulty);
		fileIO.Write(playerFile.GetPlayTime().Ticks);
		fileIO.Write(newPlayer.hair);
		fileIO.Write(newPlayer.hairDye);
		fileIO.Write((byte)newPlayer.team);
		BitsByte bitsByte = (byte)0;
		for (int i = 0; i < 8; i++)
		{
			bitsByte[i] = newPlayer.hideVisibleAccessory[i];
		}
		fileIO.Write(bitsByte);
		bitsByte = (byte)0;
		for (int j = 0; j < 2; j++)
		{
			bitsByte[j] = newPlayer.hideVisibleAccessory[j + 8];
		}
		fileIO.Write(bitsByte);
		fileIO.Write(newPlayer.hideMisc);
		fileIO.Write((byte)newPlayer.skinVariant);
		fileIO.Write(newPlayer.statLife);
		fileIO.Write(newPlayer.statLifeMax);
		fileIO.Write(newPlayer.statMana);
		fileIO.Write(newPlayer.statManaMax);
		fileIO.Write(newPlayer.extraAccessory);
		fileIO.Write(newPlayer.unlockedBiomeTorches);
		fileIO.Write(newPlayer.UsingBiomeTorches);
		fileIO.Write(newPlayer.ateArtisanBread);
		fileIO.Write(newPlayer.usedAegisCrystal);
		fileIO.Write(newPlayer.usedAegisFruit);
		fileIO.Write(newPlayer.usedArcaneCrystal);
		fileIO.Write(newPlayer.usedGalaxyPearl);
		fileIO.Write(newPlayer.usedGummyWorm);
		fileIO.Write(newPlayer.usedAmbrosia);
		fileIO.Write(newPlayer.downedDD2EventAnyDifficulty);
		fileIO.Write(newPlayer.taxMoney);
		fileIO.Write(newPlayer.numberOfDeathsPVE);
		fileIO.Write(newPlayer.numberOfDeathsPVP);
		fileIO.Write(newPlayer.hairColor.R);
		fileIO.Write(newPlayer.hairColor.G);
		fileIO.Write(newPlayer.hairColor.B);
		fileIO.Write(newPlayer.skinColor.R);
		fileIO.Write(newPlayer.skinColor.G);
		fileIO.Write(newPlayer.skinColor.B);
		fileIO.Write(newPlayer.eyeColor.R);
		fileIO.Write(newPlayer.eyeColor.G);
		fileIO.Write(newPlayer.eyeColor.B);
		fileIO.Write(newPlayer.shirtColor.R);
		fileIO.Write(newPlayer.shirtColor.G);
		fileIO.Write(newPlayer.shirtColor.B);
		fileIO.Write(newPlayer.underShirtColor.R);
		fileIO.Write(newPlayer.underShirtColor.G);
		fileIO.Write(newPlayer.underShirtColor.B);
		fileIO.Write(newPlayer.pantsColor.R);
		fileIO.Write(newPlayer.pantsColor.G);
		fileIO.Write(newPlayer.pantsColor.B);
		fileIO.Write(newPlayer.shoeColor.R);
		fileIO.Write(newPlayer.shoeColor.G);
		fileIO.Write(newPlayer.shoeColor.B);
		for (int k = 0; k < newPlayer.armor.Length; k++)
		{
			fileIO.Write(newPlayer.armor[k].type);
			fileIO.Write(newPlayer.armor[k].prefix);
		}
		for (int l = 0; l < newPlayer.dye.Length; l++)
		{
			fileIO.Write(newPlayer.dye[l].type);
			fileIO.Write(newPlayer.dye[l].prefix);
		}
		for (int m = 0; m < 58; m++)
		{
			fileIO.Write(newPlayer.inventory[m].type);
			fileIO.Write(newPlayer.inventory[m].stack);
			fileIO.Write(newPlayer.inventory[m].prefix);
			fileIO.Write(newPlayer.inventory[m].favorited);
		}
		for (int n = 0; n < newPlayer.miscEquips.Length; n++)
		{
			fileIO.Write(newPlayer.miscEquips[n].type);
			fileIO.Write(newPlayer.miscEquips[n].prefix);
			fileIO.Write(newPlayer.miscDyes[n].type);
			fileIO.Write(newPlayer.miscDyes[n].prefix);
		}
		for (int num = 0; num < newPlayer.bank.maxItems; num++)
		{
			fileIO.Write(newPlayer.bank.item[num].type);
			fileIO.Write(newPlayer.bank.item[num].stack);
			fileIO.Write(newPlayer.bank.item[num].prefix);
		}
		for (int num2 = 0; num2 < newPlayer.bank2.maxItems; num2++)
		{
			fileIO.Write(newPlayer.bank2.item[num2].type);
			fileIO.Write(newPlayer.bank2.item[num2].stack);
			fileIO.Write(newPlayer.bank2.item[num2].prefix);
		}
		for (int num3 = 0; num3 < newPlayer.bank3.maxItems; num3++)
		{
			fileIO.Write(newPlayer.bank3.item[num3].type);
			fileIO.Write(newPlayer.bank3.item[num3].stack);
			fileIO.Write(newPlayer.bank3.item[num3].prefix);
		}
		for (int num4 = 0; num4 < newPlayer.bank4.maxItems; num4++)
		{
			fileIO.Write(newPlayer.bank4.item[num4].type);
			fileIO.Write(newPlayer.bank4.item[num4].stack);
			fileIO.Write(newPlayer.bank4.item[num4].prefix);
			fileIO.Write(newPlayer.bank4.item[num4].favorited);
		}
		fileIO.Write(newPlayer.voidVaultInfo);
		for (int num5 = 0; num5 < maxBuffs; num5++)
		{
			if (Main.buffNoSave[newPlayer.buffType[num5]])
			{
				fileIO.Write(0);
				fileIO.Write(0);
			}
			else
			{
				fileIO.Write(newPlayer.buffType[num5]);
				fileIO.Write(newPlayer.buffTime[num5]);
			}
		}
		for (int num6 = 0; num6 < 200; num6++)
		{
			if (newPlayer.spN[num6] == null)
			{
				fileIO.Write(-1);
				break;
			}
			fileIO.Write(newPlayer.spX[num6]);
			fileIO.Write(newPlayer.spY[num6]);
			fileIO.Write(newPlayer.spI[num6]);
			fileIO.Write(newPlayer.spN[num6]);
		}
		fileIO.Write(newPlayer.hbLocked);
		for (int num7 = 0; num7 < newPlayer.hideInfo.Length; num7++)
		{
			fileIO.Write(newPlayer.hideInfo[num7]);
		}
		fileIO.Write(newPlayer.anglerQuestsFinished);
		for (int num8 = 0; num8 < newPlayer.DpadRadial.Bindings.Length; num8++)
		{
			fileIO.Write(newPlayer.DpadRadial.Bindings[num8]);
		}
		for (int num9 = 0; num9 < newPlayer.builderAccStatus.Length; num9++)
		{
			fileIO.Write(newPlayer.builderAccStatus[num9]);
		}
		fileIO.Write(newPlayer.bartenderQuestLog);
		fileIO.Write(newPlayer.dead);
		if (newPlayer.dead)
		{
			fileIO.Write(newPlayer.respawnTimer);
		}
		long value = DateTime.UtcNow.ToBinary();
		fileIO.Write(value);
		fileIO.Write(newPlayer.golferScoreAccumulated);
		newPlayer.creativeTracker.Save(fileIO);
		newPlayer.SaveTemporaryItemSlotContents(fileIO);
		CreativePowerManager.Instance.SaveToPlayer(newPlayer, fileIO);
		fileIO.Write(new BitsByte
		{
			[0] = newPlayer.unlockedSuperCart,
			[1] = newPlayer.enabledSuperCart
		});
		fileIO.Write(newPlayer.CurrentLoadoutIndex);
		for (int num10 = 0; num10 < newPlayer.Loadouts.Length; num10++)
		{
			newPlayer.Loadouts[num10].Serialize(fileIO);
		}
		fileIO.Write((byte)newPlayer.voiceVariant);
		fileIO.Write(newPlayer.voicePitchOffset);
		CraftingRequests.SavePossibleRefunds(fileIO);
		List<string> list = new List<string>(newPlayer.oneTimeDialoguesSeen);
		fileIO.Write(list.Count);
		foreach (string item in list)
		{
			fileIO.Write(item);
		}
	}

	private void SaveTemporaryItemSlotContents(BinaryWriter writer)
	{
		Item itemByIndex = Main.CreativeMenu.GetItemByIndex(0);
		BitsByte bitsByte = (byte)0;
		bitsByte[0] = !Main.mouseItem.IsAir;
		bitsByte[1] = !itemByIndex.IsAir;
		bitsByte[2] = !Main.guideItem.IsAir;
		bitsByte[3] = !Main.reforgeItem.IsAir;
		ItemSerializationContext context = ItemSerializationContext.SavingAndLoading;
		writer.Write(bitsByte);
		if (bitsByte[0])
		{
			Main.mouseItem.Serialize(writer, context);
		}
		if (bitsByte[1])
		{
			itemByIndex.Serialize(writer, context);
		}
		if (bitsByte[2])
		{
			Main.guideItem.Serialize(writer, context);
		}
		if (bitsByte[3])
		{
			Main.reforgeItem.Serialize(writer, context);
		}
	}

	private void LoadTemporaryItemSlotContents(BinaryReader reader)
	{
		BitsByte bitsByte = reader.ReadByte();
		ItemSerializationContext context = ItemSerializationContext.SavingAndLoading;
		if (bitsByte[0])
		{
			_temporaryItemSlots[0] = new Item();
			_temporaryItemSlots[0].DeserializeFrom(reader, context);
		}
		if (bitsByte[1])
		{
			_temporaryItemSlots[1] = new Item();
			_temporaryItemSlots[1].DeserializeFrom(reader, context);
		}
		if (bitsByte[2])
		{
			_temporaryItemSlots[2] = new Item();
			_temporaryItemSlots[2].DeserializeFrom(reader, context);
		}
		if (bitsByte[3])
		{
			_temporaryItemSlots[3] = new Item();
			_temporaryItemSlots[3].DeserializeFrom(reader, context);
		}
	}

	public void SetPlayerDataToOutOfClassFields()
	{
		Item mouseItem = new Item();
		if (_temporaryItemSlots[0] != null)
		{
			mouseItem = _temporaryItemSlots[0].Clone();
		}
		Main.mouseItem = mouseItem;
		mouseItem = new Item();
		if (_temporaryItemSlots[1] != null)
		{
			mouseItem = _temporaryItemSlots[1].Clone();
		}
		Main.CreativeMenu.SetItembyIndex(mouseItem, 0);
		mouseItem = new Item();
		if (_temporaryItemSlots[2] != null)
		{
			mouseItem = _temporaryItemSlots[2].Clone();
		}
		Main.guideItem = mouseItem;
		mouseItem = new Item();
		if (_temporaryItemSlots[3] != null)
		{
			mouseItem = _temporaryItemSlots[3].Clone();
		}
		Main.reforgeItem = mouseItem;
		CreativePowerManager.Instance.ApplyLoadedDataToPlayer(this);
	}

	private void ProcessPendingRefunds()
	{
		Item[] pendingRefunds = _pendingRefunds;
		for (int i = 0; i < pendingRefunds.Length; i++)
		{
			CraftingRequests.Refund(pendingRefunds[i]);
		}
		_pendingRefunds = new Item[0];
	}

	public static void ClearPlayerTempInfo()
	{
		Main.mouseItem.TurnToAir();
		Main.guideItem.TurnToAir();
		Main.reforgeItem.TurnToAir();
		Main.CreativeMenu.GetItemByIndex(0).TurnToAir();
		CraftingRequests.Clear();
		FakeCursorItem.Reset();
	}

	public static void InternalSaveMap(bool isCloudSave)
	{
		if (string.IsNullOrEmpty(Main.playerPathName))
		{
			return;
		}
		try
		{
			if (Main.mapEnabled)
			{
				Main.Map.Save();
			}
		}
		catch
		{
		}
		if (!isCloudSave)
		{
			Utils.TryCreatingDirectory(Main.PlayerPath);
		}
	}

	public static PlayerFileData LoadPlayer(string playerPath, bool cloudSave)
	{
		PlayerFileData playerFileData = new PlayerFileData(playerPath, cloudSave);
		if (cloudSave && SocialAPI.Cloud == null)
		{
			return playerFileData;
		}
		if (Main.rand == null)
		{
			Main.rand = new UnifiedRandom((int)DateTime.Now.Ticks);
		}
		Player player = new Player();
		bool gotToReadName = false;
		try
		{
			RijndaelManaged rijndaelManaged = new RijndaelManaged();
			rijndaelManaged.Padding = PaddingMode.None;
			using (MemoryStream stream = new MemoryStream(FileUtilities.ReadAllBytes(playerPath, cloudSave)))
			{
				using CryptoStream input = new CryptoStream(stream, rijndaelManaged.CreateDecryptor(ENCRYPTION_KEY, ENCRYPTION_KEY), CryptoStreamMode.Read);
				using BinaryReader binaryReader = new BinaryReader(input);
				int num = binaryReader.ReadInt32();
				if (num >= 135)
				{
					playerFileData.Metadata = FileMetadata.Read(binaryReader, FileType.Player);
				}
				else
				{
					playerFileData.Metadata = FileMetadata.FromCurrentSettings(FileType.Player);
				}
				if (num > 317)
				{
					player.loadStatus = StatusID.LaterVersion;
					player.name = binaryReader.ReadString();
					playerFileData.Player = player;
					return playerFileData;
				}
				Deserialize(playerFileData, player, binaryReader, num, out gotToReadName);
				if (player.lastTimePlayerWasSaved == 0L && !cloudSave)
				{
					player.lastTimePlayerWasSaved = File.GetLastWriteTimeUtc(playerPath).ToBinary();
				}
			}
			player.PlayerFrame();
			player.loadStatus = StatusID.Ok;
			playerFileData.Player = player;
			return playerFileData;
		}
		catch
		{
		}
		Player player2 = new Player();
		player2.loadStatus = StatusID.UnknownError;
		if (gotToReadName && player.name.Length <= nameLen)
		{
			player2.name = player.name;
		}
		else
		{
			string[] array = playerPath.Replace('/', Path.DirectorySeparatorChar).Split(Path.DirectorySeparatorChar);
			player2.name = array[array.Length - 1].Split('.')[0];
		}
		playerFileData.Player = player2;
		return playerFileData;
	}

	public Player SerializedClone()
	{
		Player player = new Player();
		_visualCloneStream.Seek(0L, SeekOrigin.Begin);
		Serialize(_visualCloneDummyData, this, _visualCloneWriter);
		_visualCloneStream.Seek(0L, SeekOrigin.Begin);
		Deserialize(_visualCloneDummyData, player, _visualCloneReader, 317, out var _);
		return player;
	}

	private static void Deserialize(PlayerFileData data, Player newPlayer, BinaryReader fileIO, int release, out bool gotToReadName)
	{
		gotToReadName = false;
		newPlayer.name = fileIO.ReadString();
		gotToReadName = true;
		if (release >= 10)
		{
			if (release >= 17)
			{
				newPlayer.difficulty = fileIO.ReadByte();
			}
			else if (fileIO.ReadBoolean())
			{
				newPlayer.difficulty = 2;
			}
		}
		if (release >= 138)
		{
			data.SetPlayTime(new TimeSpan(fileIO.ReadInt64()));
		}
		else
		{
			data.SetPlayTime(TimeSpan.Zero);
		}
		newPlayer.hair = fileIO.ReadInt32();
		if (newPlayer.hair >= 228)
		{
			newPlayer.hair = 0;
		}
		if (release >= 82)
		{
			newPlayer.hairDye = fileIO.ReadByte();
		}
		if (release >= 283)
		{
			newPlayer.team = fileIO.ReadByte();
		}
		if (release >= 124)
		{
			BitsByte bitsByte = fileIO.ReadByte();
			for (int i = 0; i < 8; i++)
			{
				newPlayer.hideVisibleAccessory[i] = bitsByte[i];
			}
			bitsByte = fileIO.ReadByte();
			for (int j = 0; j < 2; j++)
			{
				newPlayer.hideVisibleAccessory[j + 8] = bitsByte[j];
			}
		}
		else if (release >= 83)
		{
			BitsByte bitsByte2 = fileIO.ReadByte();
			for (int k = 0; k < 8; k++)
			{
				newPlayer.hideVisibleAccessory[k] = bitsByte2[k];
			}
		}
		if (release >= 119)
		{
			newPlayer.hideMisc = fileIO.ReadByte();
		}
		if (release <= 17)
		{
			if (newPlayer.hair == 5 || newPlayer.hair == 6 || newPlayer.hair == 9 || newPlayer.hair == 11)
			{
				newPlayer.Male = false;
			}
			else
			{
				newPlayer.Male = true;
			}
		}
		else if (release < 107)
		{
			newPlayer.Male = fileIO.ReadBoolean();
		}
		else
		{
			newPlayer.skinVariant = fileIO.ReadByte();
		}
		if (release < 161 && newPlayer.skinVariant == 7)
		{
			newPlayer.skinVariant = 9;
		}
		newPlayer.statLife = fileIO.ReadInt32();
		newPlayer.statLifeMax = fileIO.ReadInt32();
		if (newPlayer.statLifeMax > 500)
		{
			newPlayer.statLifeMax = 500;
		}
		newPlayer.statMana = fileIO.ReadInt32();
		newPlayer.statManaMax = fileIO.ReadInt32();
		if (newPlayer.statManaMax > 200)
		{
			newPlayer.statManaMax = 200;
		}
		if (newPlayer.statMana > 400)
		{
			newPlayer.statMana = 400;
		}
		if (release >= 125)
		{
			newPlayer.extraAccessory = fileIO.ReadBoolean();
		}
		if (release >= 229)
		{
			newPlayer.unlockedBiomeTorches = fileIO.ReadBoolean();
			newPlayer.UsingBiomeTorches = fileIO.ReadBoolean();
			if (release >= 256)
			{
				newPlayer.ateArtisanBread = fileIO.ReadBoolean();
			}
			if (release >= 260)
			{
				newPlayer.usedAegisCrystal = fileIO.ReadBoolean();
				newPlayer.usedAegisFruit = fileIO.ReadBoolean();
				newPlayer.usedArcaneCrystal = fileIO.ReadBoolean();
				newPlayer.usedGalaxyPearl = fileIO.ReadBoolean();
				newPlayer.usedGummyWorm = fileIO.ReadBoolean();
				newPlayer.usedAmbrosia = fileIO.ReadBoolean();
			}
		}
		if (release >= 182)
		{
			newPlayer.downedDD2EventAnyDifficulty = fileIO.ReadBoolean();
		}
		if (release >= 128)
		{
			newPlayer.taxMoney = fileIO.ReadInt32();
		}
		if (release >= 254)
		{
			newPlayer.numberOfDeathsPVE = fileIO.ReadInt32();
		}
		if (release >= 254)
		{
			newPlayer.numberOfDeathsPVP = fileIO.ReadInt32();
		}
		newPlayer.hairColor = fileIO.ReadRGB();
		newPlayer.skinColor = fileIO.ReadRGB();
		newPlayer.eyeColor = fileIO.ReadRGB();
		newPlayer.shirtColor = fileIO.ReadRGB();
		newPlayer.underShirtColor = fileIO.ReadRGB();
		newPlayer.pantsColor = fileIO.ReadRGB();
		newPlayer.shoeColor = fileIO.ReadRGB();
		Main.player[Main.myPlayer].hairColor = newPlayer.hairColor;
		Main.player[Main.myPlayer].skinColor = newPlayer.skinColor;
		Main.player[Main.myPlayer].eyeColor = newPlayer.eyeColor;
		Main.player[Main.myPlayer].shirtColor = newPlayer.shirtColor;
		Main.player[Main.myPlayer].underShirtColor = newPlayer.underShirtColor;
		Main.player[Main.myPlayer].pantsColor = newPlayer.pantsColor;
		Main.player[Main.myPlayer].shoeColor = newPlayer.shoeColor;
		if (release >= 38)
		{
			if (release < 124)
			{
				int num = 11;
				if (release >= 81)
				{
					num = 16;
				}
				for (int l = 0; l < num; l++)
				{
					int num2 = l;
					if (num2 >= 8)
					{
						num2 += 2;
					}
					newPlayer.armor[num2].netDefaults(fileIO.ReadInt32());
					newPlayer.armor[num2].Prefix(fileIO.ReadByte());
				}
			}
			else
			{
				int num3 = 20;
				for (int m = 0; m < num3; m++)
				{
					newPlayer.armor[m].netDefaults(fileIO.ReadInt32());
					newPlayer.armor[m].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 47)
			{
				int num4 = 3;
				if (release >= 81)
				{
					num4 = 8;
				}
				if (release >= 124)
				{
					num4 = 10;
				}
				for (int n = 0; n < num4; n++)
				{
					int num5 = n;
					newPlayer.dye[num5].netDefaults(fileIO.ReadInt32());
					newPlayer.dye[num5].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 58)
			{
				for (int num6 = 0; num6 < 58; num6++)
				{
					int num7 = fileIO.ReadInt32();
					if (num7 >= ItemID.Count)
					{
						newPlayer.inventory[num6].netDefaults(0);
						fileIO.ReadInt32();
						fileIO.ReadByte();
						if (release >= 114)
						{
							fileIO.ReadBoolean();
						}
					}
					else
					{
						newPlayer.inventory[num6].netDefaults(num7);
						newPlayer.inventory[num6].stack = fileIO.ReadInt32();
						newPlayer.inventory[num6].Prefix(fileIO.ReadByte());
						if (release >= 114)
						{
							newPlayer.inventory[num6].favorited = fileIO.ReadBoolean();
						}
					}
				}
			}
			else
			{
				for (int num8 = 0; num8 < 48; num8++)
				{
					int num9 = fileIO.ReadInt32();
					if (num9 >= ItemID.Count)
					{
						newPlayer.inventory[num8].netDefaults(0);
						fileIO.ReadInt32();
						fileIO.ReadByte();
					}
					else
					{
						newPlayer.inventory[num8].netDefaults(num9);
						newPlayer.inventory[num8].stack = fileIO.ReadInt32();
						newPlayer.inventory[num8].Prefix(fileIO.ReadByte());
					}
				}
			}
			if (release >= 117)
			{
				if (release < 136)
				{
					for (int num10 = 0; num10 < 5; num10++)
					{
						if (num10 != 1)
						{
							int num11 = fileIO.ReadInt32();
							if (num11 >= ItemID.Count)
							{
								newPlayer.miscEquips[num10].netDefaults(0);
								fileIO.ReadByte();
							}
							else
							{
								newPlayer.miscEquips[num10].netDefaults(num11);
								newPlayer.miscEquips[num10].Prefix(fileIO.ReadByte());
							}
							num11 = fileIO.ReadInt32();
							if (num11 >= ItemID.Count)
							{
								newPlayer.miscDyes[num10].netDefaults(0);
								fileIO.ReadByte();
							}
							else
							{
								newPlayer.miscDyes[num10].netDefaults(num11);
								newPlayer.miscDyes[num10].Prefix(fileIO.ReadByte());
							}
						}
					}
				}
				else
				{
					for (int num12 = 0; num12 < 5; num12++)
					{
						int num13 = fileIO.ReadInt32();
						if (num13 >= ItemID.Count)
						{
							newPlayer.miscEquips[num12].netDefaults(0);
							fileIO.ReadByte();
						}
						else
						{
							newPlayer.miscEquips[num12].netDefaults(num13);
							newPlayer.miscEquips[num12].Prefix(fileIO.ReadByte());
						}
						num13 = fileIO.ReadInt32();
						if (num13 >= ItemID.Count)
						{
							newPlayer.miscDyes[num12].netDefaults(0);
							fileIO.ReadByte();
						}
						else
						{
							newPlayer.miscDyes[num12].netDefaults(num13);
							newPlayer.miscDyes[num12].Prefix(fileIO.ReadByte());
						}
					}
				}
			}
			if (release >= 58)
			{
				for (int num14 = 0; num14 < 40; num14++)
				{
					newPlayer.bank.item[num14].netDefaults(fileIO.ReadInt32());
					newPlayer.bank.item[num14].stack = fileIO.ReadInt32();
					newPlayer.bank.item[num14].Prefix(fileIO.ReadByte());
				}
				for (int num15 = 0; num15 < 40; num15++)
				{
					newPlayer.bank2.item[num15].netDefaults(fileIO.ReadInt32());
					newPlayer.bank2.item[num15].stack = fileIO.ReadInt32();
					newPlayer.bank2.item[num15].Prefix(fileIO.ReadByte());
				}
			}
			else
			{
				for (int num16 = 0; num16 < 20; num16++)
				{
					newPlayer.bank.item[num16].netDefaults(fileIO.ReadInt32());
					newPlayer.bank.item[num16].stack = fileIO.ReadInt32();
					newPlayer.bank.item[num16].Prefix(fileIO.ReadByte());
				}
				for (int num17 = 0; num17 < 20; num17++)
				{
					newPlayer.bank2.item[num17].netDefaults(fileIO.ReadInt32());
					newPlayer.bank2.item[num17].stack = fileIO.ReadInt32();
					newPlayer.bank2.item[num17].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 182)
			{
				for (int num18 = 0; num18 < 40; num18++)
				{
					newPlayer.bank3.item[num18].netDefaults(fileIO.ReadInt32());
					newPlayer.bank3.item[num18].stack = fileIO.ReadInt32();
					newPlayer.bank3.item[num18].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 198)
			{
				for (int num19 = 0; num19 < 40; num19++)
				{
					newPlayer.bank4.item[num19].netDefaults(fileIO.ReadInt32());
					newPlayer.bank4.item[num19].stack = fileIO.ReadInt32();
					newPlayer.bank4.item[num19].Prefix(fileIO.ReadByte());
					if (release >= 255)
					{
						newPlayer.bank4.item[num19].favorited = fileIO.ReadBoolean();
					}
				}
			}
			if (release >= 199)
			{
				newPlayer.voidVaultInfo = fileIO.ReadByte();
			}
		}
		else
		{
			for (int num20 = 0; num20 < 8; num20++)
			{
				newPlayer.armor[num20].SetDefaults(ItemID.FromLegacyName(fileIO.ReadString(), release));
				if (release >= 36)
				{
					newPlayer.armor[num20].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 6)
			{
				for (int num21 = 10; num21 < 13; num21++)
				{
					newPlayer.armor[num21].SetDefaults(ItemID.FromLegacyName(fileIO.ReadString(), release));
					if (release >= 36)
					{
						newPlayer.armor[num21].Prefix(fileIO.ReadByte());
					}
				}
			}
			for (int num22 = 0; num22 < 44; num22++)
			{
				newPlayer.inventory[num22].SetDefaults(ItemID.FromLegacyName(fileIO.ReadString(), release));
				newPlayer.inventory[num22].stack = fileIO.ReadInt32();
				if (release >= 36)
				{
					newPlayer.inventory[num22].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 15)
			{
				for (int num23 = 44; num23 < 48; num23++)
				{
					newPlayer.inventory[num23].SetDefaults(ItemID.FromLegacyName(fileIO.ReadString(), release));
					newPlayer.inventory[num23].stack = fileIO.ReadInt32();
					if (release >= 36)
					{
						newPlayer.inventory[num23].Prefix(fileIO.ReadByte());
					}
				}
			}
			for (int num24 = 0; num24 < 20; num24++)
			{
				newPlayer.bank.item[num24].SetDefaults(ItemID.FromLegacyName(fileIO.ReadString(), release));
				newPlayer.bank.item[num24].stack = fileIO.ReadInt32();
				if (release >= 36)
				{
					newPlayer.bank.item[num24].Prefix(fileIO.ReadByte());
				}
			}
			if (release >= 20)
			{
				for (int num25 = 0; num25 < 20; num25++)
				{
					newPlayer.bank2.item[num25].SetDefaults(ItemID.FromLegacyName(fileIO.ReadString(), release));
					newPlayer.bank2.item[num25].stack = fileIO.ReadInt32();
					if (release >= 36)
					{
						newPlayer.bank2.item[num25].Prefix(fileIO.ReadByte());
					}
				}
			}
		}
		if (release < 58)
		{
			for (int num26 = 40; num26 < 48; num26++)
			{
				newPlayer.inventory[num26 + 10] = newPlayer.inventory[num26].Clone();
				newPlayer.inventory[num26].SetDefaults(0);
			}
		}
		if (release >= 11)
		{
			int num27 = 22;
			if (release < 74)
			{
				num27 = 10;
			}
			if (release >= 252)
			{
				num27 = 44;
			}
			for (int num28 = 0; num28 < num27; num28++)
			{
				newPlayer.buffType[num28] = fileIO.ReadInt32();
				newPlayer.buffTime[num28] = fileIO.ReadInt32();
				if (newPlayer.buffType[num28] == 0)
				{
					num28--;
					num27--;
				}
			}
		}
		for (int num29 = 0; num29 < 200; num29++)
		{
			int num30 = fileIO.ReadInt32();
			if (num30 == -1)
			{
				break;
			}
			newPlayer.spX[num29] = num30;
			newPlayer.spY[num29] = fileIO.ReadInt32();
			newPlayer.spI[num29] = fileIO.ReadInt32();
			newPlayer.spN[num29] = fileIO.ReadString();
		}
		if (release >= 16)
		{
			newPlayer.hbLocked = fileIO.ReadBoolean();
		}
		if (release >= 115)
		{
			int num31 = 13;
			for (int num32 = 0; num32 < num31; num32++)
			{
				newPlayer.hideInfo[num32] = fileIO.ReadBoolean();
			}
		}
		if (release >= 98)
		{
			newPlayer.anglerQuestsFinished = fileIO.ReadInt32();
		}
		if (release >= 162)
		{
			for (int num33 = 0; num33 < 4; num33++)
			{
				newPlayer.DpadRadial.Bindings[num33] = fileIO.ReadInt32();
			}
		}
		if (release >= 164)
		{
			int num34 = 8;
			if (release >= 167)
			{
				num34 = 10;
			}
			if (release >= 197)
			{
				num34 = 11;
			}
			if (release >= 230)
			{
				num34 = 12;
			}
			for (int num35 = 0; num35 < num34; num35++)
			{
				newPlayer.builderAccStatus[num35] = fileIO.ReadInt32();
			}
			if (release < 210)
			{
				newPlayer.builderAccStatus[0] = 1;
			}
			if (release < 249)
			{
				bool flag = false;
				for (int num36 = 0; num36 < 58; num36++)
				{
					if (newPlayer.inventory[num36].type == 3611)
					{
						flag = true;
						break;
					}
				}
				if (flag)
				{
					newPlayer.builderAccStatus[1] = 1;
				}
			}
		}
		if (release >= 181)
		{
			newPlayer.bartenderQuestLog = fileIO.ReadInt32();
		}
		if (release >= 200)
		{
			newPlayer.dead = fileIO.ReadBoolean();
			if (newPlayer.dead)
			{
				newPlayer.respawnTimer = Utils.Clamp(fileIO.ReadInt32(), 0, 60000);
			}
		}
		newPlayer.lastTimePlayerWasSaved = 0L;
		if (release >= 202)
		{
			newPlayer.lastTimePlayerWasSaved = fileIO.ReadInt64();
		}
		if (release >= 206)
		{
			newPlayer.golferScoreAccumulated = fileIO.ReadInt32();
		}
		if (release >= 218)
		{
			newPlayer.creativeTracker.Load(fileIO, release);
		}
		if (release >= 214)
		{
			newPlayer.LoadTemporaryItemSlotContents(fileIO);
		}
		newPlayer.savedPerPlayerFieldsThatArentInThePlayerClass = new SavedPlayerDataWithAnnoyingRules();
		CreativePowerManager.Instance.ResetDataForNewPlayer(newPlayer);
		if (release >= 220)
		{
			CreativePowerManager.Instance.LoadToPlayer(newPlayer, fileIO, release);
		}
		if (release >= 253)
		{
			BitsByte bitsByte3 = fileIO.ReadByte();
			newPlayer.unlockedSuperCart = bitsByte3[0];
			newPlayer.enabledSuperCart = bitsByte3[1];
		}
		else
		{
			newPlayer.unlockedSuperCart = newPlayer.HasItemInAnyInventory(3353);
		}
		if (release >= 262)
		{
			int value = fileIO.ReadInt32();
			newPlayer.CurrentLoadoutIndex = Utils.Clamp(value, 0, newPlayer.Loadouts.Length - 1);
			for (int num37 = 0; num37 < newPlayer.Loadouts.Length; num37++)
			{
				newPlayer.Loadouts[num37].Deserialize(fileIO, release);
			}
		}
		if (release >= 280)
		{
			newPlayer.voiceVariant = fileIO.ReadByte();
		}
		else
		{
			newPlayer.skinVariant = (int)MathHelper.Clamp(newPlayer.skinVariant, 0f, PlayerVariantID.Count - 1);
			newPlayer.voiceVariant = (newPlayer.Male ? 1 : 2);
			newPlayer.voicePitchOffset = 0f;
		}
		if (release >= 281)
		{
			newPlayer.voicePitchOffset = fileIO.ReadSingle();
		}
		else
		{
			newPlayer.voicePitchOffset = 0f;
		}
		if (release >= 300)
		{
			newPlayer._pendingRefunds = new Item[fileIO.ReadInt32()];
			for (int num38 = 0; num38 < newPlayer._pendingRefunds.Length; num38++)
			{
				newPlayer._pendingRefunds[num38] = new Item();
				newPlayer._pendingRefunds[num38].DeserializeFrom(fileIO, ItemSerializationContext.SavingAndLoading);
			}
		}
		if (release >= 310)
		{
			int num39 = fileIO.ReadInt32();
			for (int num40 = 0; num40 < num39; num40++)
			{
				newPlayer.oneTimeDialoguesSeen.Add(fileIO.ReadString());
			}
		}
		LoadPlayer_LastMinuteFixes(newPlayer);
	}

	private static void AdjustRespawnTimerForWorldJoining(Player newPlayer)
	{
		if (Main.myPlayer == newPlayer.whoAmI && newPlayer.dead && newPlayer.lastTimePlayerWasSaved != 0L)
		{
			long ticks = DateTime.UtcNow.ToBinary() - newPlayer.lastTimePlayerWasSaved;
			int num = Utils.Clamp((int)(Utils.Clamp(new TimeSpan(ticks).TotalSeconds, 0.0, 1000.0) * 60.0), 0, newPlayer.respawnTimer);
			newPlayer.respawnTimer -= num;
			if (newPlayer.respawnTimer == 0)
			{
				newPlayer.dead = false;
			}
		}
	}

	public void FixLoadedData()
	{
		FixLoadedData_Items(armor);
		FixLoadedData_Items(dye);
		FixLoadedData_Items(inventory);
		FixLoadedData_Items(miscEquips);
		FixLoadedData_Items(miscDyes);
		FixLoadedData_Items(bank.item);
		FixLoadedData_Items(bank2.item);
		FixLoadedData_Items(bank3.item);
		FixLoadedData_Items(bank4.item);
		FixLoadedData_Items(_temporaryItemSlots);
		FixLoadedData_EliminiateDuplicateAccessories(armor);
		for (int i = 0; i < Loadouts.Length; i++)
		{
			Loadouts[i].FixLoadedData();
		}
	}

	public static void FixLoadedData_EliminiateDuplicateAccessories(Item[] armorArray)
	{
		for (int i = 3; i < 10; i++)
		{
			Item item = armorArray[i];
			if (item.IsAir)
			{
				continue;
			}
			for (int j = i + 1; j < 10; j++)
			{
				Item item2 = armorArray[j];
				if (item2.type == item.type)
				{
					item2.TurnToAir();
				}
			}
		}
	}

	private void FixLoadedData_Items(Item[] items)
	{
		for (int i = 0; i < items.Length; i++)
		{
			if (items[i] != null)
			{
				items[i].FixAgainstExploit();
			}
		}
	}

	private static void LoadPlayer_LastMinuteFixes(Player newPlayer)
	{
		newPlayer.skinVariant = (int)MathHelper.Clamp(newPlayer.skinVariant, 0f, PlayerVariantID.Count - 1);
		newPlayer.voiceVariant = Utils.Clamp(newPlayer.voiceVariant, 1, 4);
		for (int i = 3; i < 10; i++)
		{
			int type = newPlayer.armor[i].type;
			if (type == 908 || type == 5000)
			{
				newPlayer.lavaMax += 420;
			}
			if (type == 906 || type == 4038 || type == 3999 || type == 4003)
			{
				newPlayer.lavaMax += 420;
			}
			if (newPlayer.wingsLogic == 0 && newPlayer.armor[i].wingSlot >= 0)
			{
				newPlayer.wingsLogic = newPlayer.armor[i].wingSlot;
			}
			if (type == 158 || type == 396 || type == 1250 || type == 1251 || type == 1252)
			{
				newPlayer.noFallDmg = true;
			}
			if (type == 860 || type == 535)
			{
				newPlayer.pStone = true;
			}
			newPlayer.lavaTime = newPlayer.lavaMax;
		}
		newPlayer.FixLoadedData();
	}

	public static PlayerFileData GetFileData(string file, bool cloudSave)
	{
		if (file == null || (cloudSave && SocialAPI.Cloud == null))
		{
			return null;
		}
		PlayerFileData playerFileData = LoadPlayer(file, cloudSave);
		if (playerFileData.Player != null)
		{
			if (playerFileData.Player.loadStatus != StatusID.Ok && playerFileData.Player.loadStatus != StatusID.LaterVersion)
			{
				if (FileUtilities.Exists(file + ".bak", cloudSave))
				{
					FileUtilities.Move(file + ".bak", file, cloudSave);
				}
				playerFileData = LoadPlayer(file, cloudSave);
				if (playerFileData.Player == null)
				{
					return null;
				}
			}
			return playerFileData;
		}
		return null;
	}

	public Color GetHairColor(bool useLighting = true)
	{
		Color color = Lighting.GetColor((int)((double)position.X + (double)width * 0.5) / 16, (int)(((double)position.Y + (double)height * 0.25) / 16.0));
		return GameShaders.Hair.GetColor(hairDye, this, useLighting ? color : Color.White);
	}

	public bool HasItem(int type)
	{
		for (int i = 0; i < 58; i++)
		{
			if (type == inventory[i].type && inventory[i].stack > 0)
			{
				return true;
			}
		}
		return false;
	}

	public bool HasItem(int type, Item[] collection)
	{
		for (int i = 0; i < collection.Length; i++)
		{
			if (type == collection[i].type && collection[i].stack > 0)
			{
				return true;
			}
		}
		return false;
	}

	public bool HasItemInInventoryOrOpenVoidBag(int type)
	{
		if (!HasItem(type))
		{
			if (useVoidBag())
			{
				return HasItem(type, bank4.item);
			}
			return false;
		}
		return true;
	}

	public bool HasItemInAnyInventory(int type)
	{
		if (HasItem(type, inventory))
		{
			return true;
		}
		if (HasItem(type, armor))
		{
			return true;
		}
		if (HasItem(type, dye))
		{
			return true;
		}
		if (HasItem(type, miscEquips))
		{
			return true;
		}
		if (HasItem(type, miscDyes))
		{
			return true;
		}
		if (HasItem(type, bank.item))
		{
			return true;
		}
		if (HasItem(type, bank2.item))
		{
			return true;
		}
		if (HasItem(type, bank3.item))
		{
			return true;
		}
		if (HasItem(type, bank4.item))
		{
			return true;
		}
		return false;
	}

	public int FindItem(int type)
	{
		for (int i = 0; i < 58; i++)
		{
			if (type == inventory[i].type && inventory[i].stack > 0)
			{
				return i;
			}
		}
		return -1;
	}

	public int FindItem(List<int> types)
	{
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].stack > 0 && types.Contains(inventory[i].type))
			{
				return i;
			}
		}
		return -1;
	}

	public int FindItem(bool[] validtypes)
	{
		for (int i = 0; i < 58; i++)
		{
			if (inventory[i].stack > 0 && validtypes[inventory[i].type])
			{
				return i;
			}
		}
		return -1;
	}

	public int FindItem(int type, Item[] collection)
	{
		for (int i = 0; i < collection.Length; i++)
		{
			if (inventory[i].stack > 0 && type == collection[i].type)
			{
				return i;
			}
		}
		return -1;
	}

	public int FindItemInInventoryOrOpenVoidBag(int type, out bool inVoidBag)
	{
		inVoidBag = false;
		int num = FindItem(type);
		if (num == -1 && useVoidBag())
		{
			num = FindItem(type, bank4.item);
			if (num == -1)
			{
				return -1;
			}
			inVoidBag = true;
		}
		return num;
	}

	public Player()
	{
		width = 20;
		height = 42;
		name = string.Empty;
		bodyFrame.Width = 40;
		bodyFrame.Height = 56;
		legFrame.Width = 40;
		legFrame.Height = 56;
		voiceVariant = 1;
		tileEntityAnchor.Clear();
		doorHelper = new DoorOpeningHelper();
		for (int i = 0; i < 59; i++)
		{
			if (i < armor.Length)
			{
				armor[i] = new Item();
			}
			inventory[i] = new Item();
		}
		bank.FillWithEmptyInstances();
		bank2.FillWithEmptyInstances();
		bank3.FillWithEmptyInstances();
		bank4.FillWithEmptyInstances();
		for (int j = 0; j < dye.Length; j++)
		{
			dye[j] = new Item();
		}
		for (int k = 0; k < miscEquips.Length; k++)
		{
			miscEquips[k] = new Item();
		}
		for (int l = 0; l < miscDyes.Length; l++)
		{
			miscDyes[l] = new Item();
		}
		trashItem = new Item();
		lastVisualizedSelectedItem = new Item();
		grappling[0] = -1;
		statManaMax = 20;
		extraAccessory = false;
		ateArtisanBread = false;
		usedAegisCrystal = false;
		usedAegisFruit = false;
		usedArcaneCrystal = false;
		usedGalaxyPearl = false;
		usedGummyWorm = false;
		usedAmbrosia = false;
		Array.Clear(adjTile, 0, adjTile.Length);
		hitTile = new HitTile();
		hitReplace = new HitTile();
		mount = new Mount();
		talkNPC = -1;
		piggyBankProjTracker.Clear();
		voidLensChest.Clear();
		creativeTracker = new CreativeUnlocksTracker();
		builderAccStatus[0] = 1;
		TagEffectState = new TagEffectState(this);
		selectedItemState = new SelectedItemState(this);
		IntentionGuesser = new PlayerIntentionGuesser();
	}

	public void MagicConch()
	{
		bool flag = position.X / 16f < (float)(Main.maxTilesX / 2);
		bool flag2 = false;
		int num = 50;
		int num2 = 50;
		int num3 = WorldGen.beachDistance - num - num2;
		if (flag)
		{
			num3 = Main.maxTilesX - num3 - 1 - num2;
		}
		else
		{
			num3 -= num2 / 2;
		}
		_ = (float)Main.maxTilesY / 1200f;
		_ = (float)Main.maxTilesY / 1200f;
		new Utils.RandomTeleportationAttemptSettings
		{
			teleporteeSize = base.Size,
			teleporteeVelocity = velocity,
			teleporteeGravityDirection = gravDir,
			avoidAnyLiquid = true,
			avoidHurtTiles = true,
			attemptsBeforeGivingUp = 1000,
			maximumFallDistanceFromOrignalPoint = 300
		};
		Vector2 vector = Vector2.Zero;
		int num4 = flag.ToDirectionInt();
		int startX = (flag ? (Main.maxTilesX - 50) : 50);
		flag2 = true;
		if (!TeleportHelpers.RequestMagicConchTeleportPosition(this, -num4, startX, out var landingPoint))
		{
			flag2 = false;
			startX = ((!flag) ? (Main.maxTilesX - 50) : 50);
			if (TeleportHelpers.RequestMagicConchTeleportPosition(this, num4, startX, out landingPoint))
			{
				flag2 = true;
			}
		}
		if (flag2)
		{
			vector = landingPoint.ToWorldCoordinates(8f, 16f) - new Vector2(width / 2, height);
		}
		if (flag2)
		{
			Vector2 newPos = vector;
			Teleport(newPos, 5);
			velocity = Vector2.Zero;
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, position);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos.X, newPos.Y, 5);
			}
		}
		else
		{
			Vector2 newPos2 = position;
			Teleport(newPos2, 5);
			velocity = new Vector2(0f, 0.001f);
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, position);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos2.X, newPos2.Y, 5, 1);
			}
		}
	}

	public void Shellphone_Spawn()
	{
		int floorX = Main.spawnTileX;
		int floorY = Main.spawnTileY;
		Spawn_GetPositionAtWorldSpawn(ref floorX, ref floorY);
		if (Main.netMode != 1 && !Spawn_IsAreaValidSpawn(floorX, floorY))
		{
			Spawn_ForceClearArea(floorX, floorY);
		}
		Vector2 newPos = new Point(floorX, floorY).ToWorldCoordinates(8f, 0f) - new Vector2(width / 2, height);
		Teleport(newPos, 11);
		velocity = Vector2.Zero;
		if (Main.netMode == 2)
		{
			RemoteClient.CheckSection(whoAmI, position);
			NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos.X, newPos.Y, 11);
		}
	}

	public void DemonConch()
	{
		bool canSpawn = false;
		int num = Main.maxTilesX / 2;
		int num2 = 100;
		int num3 = num2 / 2;
		int teleportStartY = Main.UnderworldLayer + 20;
		int teleportRangeY = 80;
		Utils.RandomTeleportationAttemptSettings settings = new Utils.RandomTeleportationAttemptSettings
		{
			teleporteeSize = base.Size,
			teleporteeVelocity = velocity,
			teleporteeGravityDirection = gravDir,
			mostlySolidFloor = true,
			avoidAnyLiquid = true,
			avoidLava = true,
			avoidHurtTiles = true,
			avoidWalls = true,
			attemptsBeforeGivingUp = 1000,
			maximumFallDistanceFromOrignalPoint = 100,
			allowSolidTopFloor = true
		};
		Vector2 vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num - num3, num2, teleportStartY, teleportRangeY, settings);
		if (!canSpawn)
		{
			vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num - num2, num3, teleportStartY, teleportRangeY, settings);
		}
		if (!canSpawn)
		{
			vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num + num3, num3, teleportStartY, teleportRangeY, settings);
		}
		if (!canSpawn)
		{
			bool flag = Main.rand.Next(2) == 0;
			num = (flag ? (num2 * 3) : (Main.maxTilesX - num2 * 3));
			vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num - num3, num3, teleportStartY, teleportRangeY, settings);
			if (!canSpawn)
			{
				vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num - num2, num3, teleportStartY, teleportRangeY, settings);
			}
			if (!canSpawn)
			{
				vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num + num3, num3, teleportStartY, teleportRangeY, settings);
			}
			if (!canSpawn)
			{
				num = (flag ? (Main.maxTilesX - num2 * 3) : (num2 * 3));
				vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num - num3, num3, teleportStartY, teleportRangeY, settings);
				if (!canSpawn)
				{
					vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num - num2, num3, teleportStartY, teleportRangeY, settings);
				}
				if (!canSpawn)
				{
					vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, num + num3, num3, teleportStartY, teleportRangeY, settings);
				}
			}
		}
		if (canSpawn)
		{
			Vector2 newPos = vector;
			Teleport(newPos, 7);
			velocity = Vector2.Zero;
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, position);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos.X, newPos.Y, 7);
			}
		}
		else
		{
			Vector2 newPos2 = position;
			Teleport(newPos2, 7);
			velocity = new Vector2(0f, 0.001f);
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, position);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos2.X, newPos2.Y, 7, 1);
			}
		}
	}

	public void TeleportationPotion()
	{
		bool canSpawn = false;
		int teleportStartX = 100;
		int teleportRangeX = Main.maxTilesX - 200;
		int teleportStartY = 100;
		int underworldLayer = Main.UnderworldLayer;
		Vector2 vector = Utils.CheckForGoodTeleportationSpot(ref canSpawn, teleportStartX, teleportRangeX, teleportStartY, underworldLayer, new Utils.RandomTeleportationAttemptSettings
		{
			teleporteeSize = base.Size,
			teleporteeVelocity = velocity,
			teleporteeGravityDirection = gravDir,
			avoidLava = true,
			avoidHurtTiles = true,
			maximumFallDistanceFromOrignalPoint = 100,
			attemptsBeforeGivingUp = 1000
		});
		if (canSpawn)
		{
			Vector2 newPos = vector;
			Teleport(newPos, 2);
			velocity = Vector2.Zero;
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, position);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos.X, newPos.Y, 2);
			}
		}
		else
		{
			Vector2 newPos2 = position;
			Teleport(newPos2, 2);
			velocity = Vector2.Zero;
			if (Main.netMode == 2)
			{
				RemoteClient.CheckSection(whoAmI, position);
				NetMessage.SendData(65, -1, -1, null, 0, whoAmI, newPos2.X, newPos2.Y, 2, 1);
			}
		}
	}

	public void GetAnglerReward(NPC angler, int questItemType)
	{
		EntitySource_Gift source = new EntitySource_Gift(angler);
		int questsDone = anglerQuestsFinished;
		float anglerRewardRarityMultiplier = GetAnglerRewardRarityMultiplier(questsDone);
		anglerRewardRarityMultiplier *= (currentShoppingSettings.PriceAdjustment + 1f) / 2f;
		GetAnglerReward_MainReward(source, questsDone, anglerRewardRarityMultiplier, questItemType);
		GetAnglerReward_Decoration(source, questsDone, anglerRewardRarityMultiplier);
		GetAnglerReward_Money(source, questsDone, anglerRewardRarityMultiplier);
		GetAnglerReward_Bait(source, questsDone, anglerRewardRarityMultiplier);
	}

	public static float GetAnglerRewardRarityMultiplier(int questsDone)
	{
		float num = 1f;
		num = ((questsDone <= 50) ? (num - (float)questsDone * 0.01f) : ((questsDone <= 100) ? (0.5f - (float)(questsDone - 50) * 0.005f) : ((questsDone > 150) ? 0.15f : (0.25f - (float)(questsDone - 100) * 0.002f))));
		return num * 0.9f;
	}

	private void GetAnglerReward_MainReward(IEntitySource source, int questsDone, float rarityReduction, int questItemType)
	{
		Item item = new Item();
		item.type = 0;
		switch (questsDone)
		{
		case 5:
			item.SetDefaults(2428);
			break;
		case 10:
			item.SetDefaults(2367);
			break;
		case 15:
			item.SetDefaults(2368);
			break;
		case 20:
			item.SetDefaults(2369);
			break;
		case 25:
			item.SetDefaults(3031);
			break;
		case 30:
			item.SetDefaults(2294);
			break;
		default:
		{
			if (questItemType == 2451 && Main.hardMode)
			{
				item.SetDefaults((Main.rand.Next(2) == 0) ? 5303 : 5302);
				break;
			}
			if (questItemType == 2451 && !Main.hardMode && Main.rand.Next(2) == 0)
			{
				item.SetDefaults((Main.rand.Next(2) == 0) ? 5303 : 5302);
				break;
			}
			List<int> list = new List<int> { 2373, 2374, 2375, 3120, 3037, 3096, 5139 };
			float num = 1f;
			for (int i = 0; i < 3; i++)
			{
				num *= 1f - 1f / (float)(int)(40f * rarityReduction);
			}
			for (int j = 0; j < 3; j++)
			{
				num *= 1f - 1f / (float)(int)(30f * rarityReduction);
			}
			num *= 1f - 1f / (float)(int)(25f * rarityReduction);
			float num2 = 1f - num;
			num2 *= 0.8f;
			if (questsDone > 75 && Main.rand.Next((int)(250f * rarityReduction)) == 0)
			{
				item.SetDefaults(2294);
				break;
			}
			if (Main.hardMode && questsDone > 25 && Main.rand.Next((int)(100f * rarityReduction)) == 0)
			{
				item.SetDefaults(2422);
				break;
			}
			if (Main.hardMode && questsDone > 10 && Main.rand.Next((int)(70f * rarityReduction)) == 0)
			{
				item.SetDefaults(2494);
				break;
			}
			if (questsDone > 10 && Main.rand.Next((int)(70f * rarityReduction)) == 0)
			{
				item.SetDefaults(3031);
				break;
			}
			if (questsDone > 10 && Main.rand.Next((int)(70f * rarityReduction)) == 0)
			{
				item.SetDefaults(3032);
				break;
			}
			if (Main.rand.Next((int)(80f * rarityReduction)) == 0)
			{
				item.SetDefaults(3183);
				break;
			}
			if (Main.rand.Next((int)(60f * rarityReduction)) == 0)
			{
				item.SetDefaults(2360);
				break;
			}
			if (Main.rand.Next((int)(60f * rarityReduction)) == 0)
			{
				item.SetDefaults(4067);
				break;
			}
			if (Main.rand.Next((int)(80f * rarityReduction)) == 0)
			{
				item.SetDefaults(2417);
				break;
			}
			if (Main.rand.Next((int)(80f * rarityReduction)) == 0)
			{
				item.SetDefaults(2498);
				break;
			}
			if (DropAnglerAccByMissing(list, num2, out var botheredRollingForADrop, out var itemIdToDrop))
			{
				item.SetDefaults(itemIdToDrop);
				break;
			}
			if (!botheredRollingForADrop && Main.rand.NextDouble() < (double)num2)
			{
				int type = Utils.SelectRandom(Main.rand, list.ToArray());
				item.SetDefaults(type);
				break;
			}
			switch (Main.rand.Next(3))
			{
			case 0:
				item.SetDefaults(2354);
				item.stack = Main.rand.Next(2, 6);
				break;
			case 1:
				item.SetDefaults(2355);
				item.stack = Main.rand.Next(2, 6);
				break;
			default:
				item.SetDefaults(2356);
				item.stack = Main.rand.Next(2, 6);
				break;
			}
			break;
		}
		}
		QuickSpawnItem(source, item, GetItemSettings.GiftRecieved);
		if (item.type == 2417)
		{
			Item item2 = new Item();
			Item item3 = new Item();
			item2.SetDefaults(2418);
			QuickSpawnItem(source, item2, GetItemSettings.GiftRecieved);
			item3.SetDefaults(2419);
			QuickSpawnItem(source, item3, GetItemSettings.GiftRecieved);
		}
		else if (item.type == 2498)
		{
			Item item4 = new Item();
			Item item5 = new Item();
			item4.SetDefaults(2499);
			QuickSpawnItem(source, item4, GetItemSettings.GiftRecieved);
			item5.SetDefaults(2500);
			QuickSpawnItem(source, item5, GetItemSettings.GiftRecieved);
		}
	}

	private void GetAnglerReward_Decoration(IEntitySource source, int questsDone, float rarityReduction)
	{
		float value = 1f - rarityReduction;
		int num = 100;
		float num2 = MathHelper.Lerp(value, 1f, Math.Min(1f, (float)questsDone / (float)num));
		if (num2 >= 1f || Main.rand.NextFloat() <= num2)
		{
			Item item = new Item();
			item.type = 0;
			item.SetDefaults(Main.rand.Next(19) switch
			{
				1 => 2443, 
				2 => 2444, 
				3 => 2445, 
				4 => 2497, 
				5 => 2495, 
				6 => 2446, 
				7 => 2447, 
				8 => 2448, 
				9 => 2449, 
				10 => 2490, 
				11 => 2496, 
				12 => 5235, 
				13 => 5252, 
				14 => 5256, 
				15 => 5259, 
				16 => 5263, 
				17 => 5264, 
				18 => 5265, 
				_ => 2442, 
			});
			QuickSpawnItem(source, item, GetItemSettings.GiftRecieved);
		}
	}

	private void GetAnglerReward_Bait(IEntitySource source, int questsDone, float rarityReduction)
	{
		if (Main.rand.Next((int)(100f * rarityReduction)) <= 50)
		{
			Item item = new Item();
			if (Main.rand.Next((int)(15f * rarityReduction)) == 0)
			{
				item.SetDefaults(2676);
			}
			else if (Main.rand.Next((int)(5f * rarityReduction)) == 0)
			{
				item.SetDefaults(2675);
			}
			else
			{
				item.SetDefaults(2674);
			}
			if (Main.rand.Next(25) <= questsDone)
			{
				item.stack++;
			}
			if (Main.rand.Next(50) <= questsDone)
			{
				item.stack++;
			}
			if (Main.rand.Next(100) <= questsDone)
			{
				item.stack++;
			}
			if (Main.rand.Next(150) <= questsDone)
			{
				item.stack++;
			}
			if (Main.rand.Next(200) <= questsDone)
			{
				item.stack++;
			}
			if (Main.rand.Next(250) <= questsDone)
			{
				item.stack++;
			}
			QuickSpawnItem(source, item, GetItemSettings.GiftRecieved);
		}
	}

	private void GetAnglerReward_Money(IEntitySource source, int questsDone, float rarityReduction)
	{
		Item item = new Item();
		int num = (questsDone + 50) / 2;
		num = (int)((float)(num * Main.rand.Next(50, 201)) * 0.015f);
		num = (int)((double)num * 1.5);
		if (Main.hardMode)
		{
			num *= 2;
		}
		if (Main.expertMode)
		{
			num *= 2;
		}
		if (num > 100)
		{
			num /= 100;
			if (num > 10)
			{
				num = 10;
			}
			if (num < 1)
			{
				num = 1;
			}
			item.SetDefaults(73);
			item.stack = num;
		}
		else
		{
			if (num > 99)
			{
				num = 99;
			}
			if (num < 1)
			{
				num = 1;
			}
			item.SetDefaults(72);
			item.stack = num;
		}
		QuickSpawnItem(source, item, GetItemSettings.GiftRecieved);
	}

	public bool DropAnglerAccByMissing(List<int> itemIdsOfAccsWeWant, float totalChance, out bool botheredRollingForADrop, out int itemIdToDrop)
	{
		botheredRollingForADrop = false;
		itemIdToDrop = 0;
		List<int> list = new List<int>(itemIdsOfAccsWeWant);
		Item[] array = inventory;
		for (int i = 0; i < array.Length; i++)
		{
			RemoveAnglerAccOptionsFromRewardPool(list, array[i]);
		}
		array = armor;
		for (int j = 0; j < array.Length; j++)
		{
			RemoveAnglerAccOptionsFromRewardPool(list, array[j]);
		}
		array = bank.item;
		for (int k = 0; k < array.Length; k++)
		{
			RemoveAnglerAccOptionsFromRewardPool(list, array[k]);
		}
		array = bank2.item;
		for (int l = 0; l < array.Length; l++)
		{
			RemoveAnglerAccOptionsFromRewardPool(list, array[l]);
		}
		array = bank3.item;
		for (int m = 0; m < array.Length; m++)
		{
			RemoveAnglerAccOptionsFromRewardPool(list, array[m]);
		}
		array = bank4.item;
		for (int n = 0; n < array.Length; n++)
		{
			RemoveAnglerAccOptionsFromRewardPool(list, array[n]);
		}
		for (int num = 0; num < Loadouts.Length; num++)
		{
			array = Loadouts[num].Armor;
			for (int num2 = 0; num2 < array.Length; num2++)
			{
				RemoveAnglerAccOptionsFromRewardPool(list, array[num2]);
			}
		}
		if (list.Count == 0)
		{
			return false;
		}
		bool flag = false;
		if (Main.rand.NextDouble() < (double)totalChance)
		{
			flag = true;
		}
		botheredRollingForADrop = true;
		if (flag)
		{
			itemIdToDrop = Main.rand.NextFromList(list.ToArray());
			return true;
		}
		return false;
	}

	private void RemoveAnglerAccOptionsFromRewardPool(List<int> itemIdsOfAccsWeWant, Item itemToTestAgainst)
	{
		if (!itemToTestAgainst.IsAir)
		{
			switch (itemToTestAgainst.type)
			{
			default:
				itemIdsOfAccsWeWant.Remove(itemToTestAgainst.type);
				break;
			case 3721:
			case 5064:
				itemIdsOfAccsWeWant.Remove(2373);
				itemIdsOfAccsWeWant.Remove(2375);
				itemIdsOfAccsWeWant.Remove(2374);
				break;
			case 3036:
			case 3123:
			case 3124:
			case 5358:
			case 5359:
			case 5360:
			case 5361:
				itemIdsOfAccsWeWant.Remove(3120);
				itemIdsOfAccsWeWant.Remove(3037);
				itemIdsOfAccsWeWant.Remove(3096);
				break;
			case 5140:
			case 5141:
			case 5142:
			case 5143:
			case 5144:
			case 5145:
			case 5146:
				itemIdsOfAccsWeWant.Remove(5139);
				break;
			}
		}
	}

	public void GetDyeTraderReward(NPC dyeTrader)
	{
		int num = -1;
		List<int> list = new List<int>
		{
			3560, 3028, 3041, 3040, 3025, 3190, 3027, 3026, 3554, 3553,
			3555, 2872, 3534, 2871
		};
		if (Main.hardMode)
		{
			list.Add(3039);
			list.Add(3038);
			list.Add(3598);
			list.Add(3597);
			list.Add(3600);
			list.Add(3042);
			list.Add(3533);
			list.Add(3561);
			if (NPC.downedMechBossAny)
			{
				list.Add(2883);
				list.Add(2869);
				list.Add(2873);
				list.Add(2870);
			}
			if (NPC.downedPlantBoss)
			{
				list.Add(2878);
				list.Add(2879);
				list.Add(2884);
				list.Add(2885);
			}
			if (NPC.downedMartians)
			{
				list.Add(2864);
				list.Add(3556);
			}
			if (NPC.downedMoonlord)
			{
				list.Add(3024);
			}
		}
		num = list[Main.rand.Next(list.Count)];
		Item item = new Item();
		item.SetDefaults(num);
		item.stack = 6;
		QuickSpawnItem(new EntitySource_Gift(dyeTrader), item, GetItemSettings.GiftRecieved);
	}

	public void TryPortalJumping()
	{
		if (!mount.Active && !dead && !isLockedToATile)
		{
			PortalHelper.TryGoingThroughPortals(this);
		}
	}

	public bool ConsumeSolarFlare()
	{
		if (setSolar && solarShields > 0)
		{
			solarShields--;
			for (int i = 0; i < maxBuffs; i++)
			{
				if (buffType[i] >= 170 && buffType[i] <= 172)
				{
					DelBuff(i);
				}
			}
			if (solarShields > 0 && whoAmI == Main.myPlayer)
			{
				AddBuff(170 + solarShields - 1, 5);
			}
			solarCounter = 0;
			return true;
		}
		return false;
	}

	public void KeyDoubleTap(int keyDir)
	{
		int num = 0;
		if (Main.ReversedUpDownArmorSetBonuses)
		{
			num = 1;
		}
		if (keyDir != num)
		{
			return;
		}
		if (setVortex && !mount.Active)
		{
			vortexStealthActive = !vortexStealthActive;
		}
		if (setForbidden)
		{
			MinionRestTargetAim();
			if (!setForbiddenCooldownLocked)
			{
				CommandForbiddenStorm();
			}
		}
	}

	public void UpdateForbiddenSetLock()
	{
		List<int> list = new List<int>();
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.type == 656 && projectile.owner == whoAmI)
			{
				list.Add(i);
			}
		}
		setForbiddenCooldownLocked = list.Count > 1;
	}

	public void CommandForbiddenStorm()
	{
		List<int> list = new List<int>();
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active && projectile.type == 656 && projectile.owner == whoAmI)
			{
				list.Add(i);
			}
		}
		bool flag = StrayMethods.CanSpawnSandstormFriendly(MinionRestTargetPoint, 30, 30);
		bool num = MinionRestTargetPoint == Vector2.Zero;
		Vector2 center = base.Center;
		Vector2 endPoint = MinionRestTargetPoint;
		if (num)
		{
			endPoint = center;
		}
		int samplesToTake = 10;
		float samplingWidth = 60f;
		Collision.AimingLaserScan(center, endPoint, samplingWidth, samplesToTake, out var vectorTowardsTarget, out var samples);
		bool flag2 = false;
		float[] array = samples;
		for (int j = 0; j < array.Length; j++)
		{
			if (Math.Abs(array[j] - vectorTowardsTarget.Length()) < 10f)
			{
				flag2 = true;
				break;
			}
		}
		float num2 = 0f;
		for (int k = 0; k < samples.Length; k++)
		{
			if (samples[k] > num2)
			{
				num2 = samples[k];
			}
		}
		if (list.Count <= 1)
		{
			Vector2 vector = center + vectorTowardsTarget.SafeNormalize(Vector2.Zero) * num2;
			Vector2 vector2 = vector - center;
			if (vector2.Length() > 0f)
			{
				for (float num3 = 0f; num3 < vector2.Length(); num3 += 15f)
				{
					Vector2 vector3 = center + vector2 * (num3 / vector2.Length());
					Dust obj = Main.dust[Dust.NewDust(vector3, 0, 0, 269)];
					obj.position = vector3;
					obj.fadeIn = 0.5f;
					obj.scale = 0.7f;
					obj.velocity *= 0.4f;
					obj.noLight = true;
				}
			}
			for (float num4 = 0f; num4 < (float)Math.PI * 2f; num4 += (float)Math.PI / 15f)
			{
				Dust obj2 = Main.dust[Dust.NewDust(vector, 0, 0, 269)];
				obj2.position = vector;
				obj2.fadeIn = 1f;
				obj2.scale = 0.3f;
				obj2.noLight = true;
			}
		}
		flag &= list.Count <= 1;
		flag = flag && flag2;
		if (flag)
		{
			flag = CheckMana(20, pay: true);
			if (flag)
			{
				manaRegenDelay = (int)maxRegenDelay;
			}
		}
		if (!flag)
		{
			return;
		}
		foreach (int item in list)
		{
			Projectile projectile2 = Main.projectile[item];
			if (!(projectile2.ai[0] >= 780f))
			{
				projectile2.ai[0] = 780f + projectile2.ai[0] % 60f;
				projectile2.netUpdate = true;
			}
		}
		int damage = (int)(20f * (1f + magicDamage + minionDamage - 2f));
		IEntitySource projectileSource_SetBonus = GetProjectileSource_SetBonus(3);
		_ = Main.projectile[Projectile.NewProjectile(projectileSource_SetBonus, MinionRestTargetPoint, Vector2.Zero, 656, damage, 0f, Main.myPlayer)];
	}

	public void KeyHoldDown(int keyDir, int holdTime)
	{
		int num = 0;
		if (Main.ReversedUpDownArmorSetBonuses)
		{
			num = 1;
		}
		if (keyDir == num)
		{
			if (setStardust && holdTime >= 60)
			{
				MinionRestTargetPoint = Vector2.Zero;
			}
			if (setForbidden && holdTime >= 60)
			{
				MinionRestTargetPoint = Vector2.Zero;
			}
		}
	}

	public void MinionNPCTargetAim(bool doNotDisableIfTheTargetIsTheSame)
	{
		Vector2 mouseWorld = Main.MouseWorld;
		int num = -1;
		for (int i = 0; i < Main.maxNPCs; i++)
		{
			if (Main.npc[i].CanBeChasedBy(this) && (num == -1 || Main.npc[i].Hitbox.Distance(mouseWorld) < Main.npc[num].Hitbox.Distance(mouseWorld)))
			{
				num = i;
			}
		}
		if (MinionAttackTargetNPC == num && !doNotDisableIfTheTargetIsTheSame)
		{
			MinionAttackTargetNPC = -1;
		}
		else
		{
			MinionAttackTargetNPC = num;
		}
	}

	public void MinionRestTargetAim()
	{
		Vector2 mouseWorld = Main.MouseWorld;
		float y = mouseWorld.Y;
		int num = (int)mouseWorld.X / 16;
		int num2 = (int)y / 16;
		int num3 = 0;
		if (Main.tile[num, num2].nactive() && Main.tileSolid[Main.tile[num, num2].type] && !Main.tileSolidTop[Main.tile[num, num2].type])
		{
			int num4 = 0;
			int num5 = 0;
			while (num5 > -20 && num2 + num5 > 1)
			{
				int num6 = num2 + num5;
				if (Main.tile[num, num6].nactive() && Main.tileSolid[Main.tile[num, num6].type] && !Main.tileSolidTop[Main.tile[num, num6].type])
				{
					num4 = num5;
					num5--;
					continue;
				}
				num4 = num5;
				break;
			}
			int num7 = 0;
			for (int i = 0; i < 20 && num2 + i < Main.maxTilesY; i++)
			{
				int num8 = num2 + i;
				if (Main.tile[num, num8].nactive() && Main.tileSolid[Main.tile[num, num8].type] && !Main.tileSolidTop[Main.tile[num, num8].type])
				{
					num7 = i;
					continue;
				}
				num7 = i;
				break;
			}
			num3 = ((num7 <= -num4) ? (num7 + 3) : (num4 - 2));
		}
		int num9 = num2 + num3;
		bool flag = false;
		for (int j = num9; j < num9 + 5; j++)
		{
			if (WorldGen.SolidTileAllowBottomSlope(num, j))
			{
				flag = true;
			}
		}
		while (!flag)
		{
			num9++;
			for (int k = num9; k < num9 + 5; k++)
			{
				if (WorldGen.SolidTileAllowBottomSlope(num, k))
				{
					flag = true;
				}
			}
		}
		Vector2 vector = new Vector2(num * 16 + 8, num9 * 16);
		if (Distance(vector) <= 1000f)
		{
			MinionRestTargetPoint = vector;
		}
	}

	public void UpdateMinionTarget()
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		if (Distance(MinionRestTargetPoint) > 1000f)
		{
			MinionRestTargetPoint = Vector2.Zero;
		}
		if (MinionAttackTargetNPC != -1 && (!Main.npc[MinionAttackTargetNPC].CanBeChasedBy(this) || Main.npc[MinionAttackTargetNPC].Hitbox.Distance(base.Center) > 3000f))
		{
			MinionAttackTargetNPC = -1;
		}
		if (stardustGuardian && HasMinionRestTarget)
		{
			Vector2 minionRestTargetPoint = MinionRestTargetPoint;
			float num = (float)miscCounter / 150f;
			float num2 = (float)Math.PI * 2f / 3f;
			for (int i = 0; i < 3; i++)
			{
				int num3 = Dust.NewDust(minionRestTargetPoint, 0, 0, 135, 0f, 0f, 100, default(Color), 1.5f);
				Main.dust[num3].noGravity = true;
				Main.dust[num3].velocity = Vector2.Zero;
				Main.dust[num3].noLight = true;
				Main.dust[num3].position = minionRestTargetPoint + (num * ((float)Math.PI * 2f) + num2 * (float)i).ToRotationVector2() * 4f;
				Main.dust[num3].shader = GameShaders.Armor.GetSecondaryShader(cPet, this);
			}
		}
	}

	public void NebulaLevelup(int type)
	{
		if (whoAmI != Main.myPlayer)
		{
			return;
		}
		int time = 480;
		for (int i = 0; i < maxBuffs; i++)
		{
			if (buffType[i] >= type && buffType[i] < type + 3)
			{
				DelBuff(i--);
			}
		}
		switch (type)
		{
		case 173:
			nebulaLevelLife = (int)MathHelper.Clamp(nebulaLevelLife + 1, 0f, 3f);
			AddBuff(type + nebulaLevelLife - 1, time);
			break;
		case 176:
			nebulaLevelMana = (int)MathHelper.Clamp(nebulaLevelMana + 1, 0f, 3f);
			AddBuff(type + nebulaLevelMana - 1, time);
			break;
		case 179:
			nebulaLevelDamage = (int)MathHelper.Clamp(nebulaLevelDamage + 1, 0f, 3f);
			AddBuff(type + nebulaLevelDamage - 1, time);
			break;
		}
	}

	public void UpdateTouchingTiles()
	{
		TouchedTiles.Clear();
		List<Point> list = null;
		List<Point> list2 = null;
		if (!Collision.IsClearSpotTest(position + velocity, 16f, width, height, fallThrough: false, fall2: false, (int)gravDir, checkCardinals: true, checkSlopes: true))
		{
			list = Collision.FindCollisionTile((Math.Sign(velocity.Y) == 1) ? 2 : 3, position + velocity, 16f, width, height, fallThrough: false, fall2: false, (int)gravDir);
		}
		if (!Collision.IsClearSpotTest(position, Math.Abs(velocity.Y), width, height, fallThrough: false, fall2: false, (int)gravDir, checkCardinals: true, checkSlopes: true))
		{
			list2 = Collision.FindCollisionTile((Math.Sign(velocity.Y) == 1) ? 2 : 3, position, Math.Abs(velocity.Y), width, height, fallThrough: false, fall2: false, (int)gravDir, checkCardinals: true, checkSlopes: true);
		}
		if (list != null && list2 != null)
		{
			for (int i = 0; i < list2.Count; i++)
			{
				if (!list.Contains(list2[i]))
				{
					list.Add(list2[i]);
				}
			}
		}
		if (list == null && list2 != null)
		{
			list = list2;
		}
		if (list != null)
		{
			TouchedTiles = list;
		}
	}
}
