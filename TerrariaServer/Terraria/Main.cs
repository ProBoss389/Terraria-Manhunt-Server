using System;
using System.Collections;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;
using Microsoft.Win32;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using Microsoft.Xna.Framework.Input;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using ReLogic.Content;
using ReLogic.Content.Sources;
using ReLogic.Graphics;
using ReLogic.Localization.IME;
using ReLogic.OS;
using ReLogic.Peripherals.RGB;
using ReLogic.Threading;
using ReLogic.Utilities;
using Terraria.Achievements;
using Terraria.Audio;
using Terraria.Chat;
using Terraria.Cinematics;
using Terraria.DataStructures;
using Terraria.Enums;
using Terraria.GameContent;
using Terraria.GameContent.Achievements;
using Terraria.GameContent.Ambience;
using Terraria.GameContent.Animations;
using Terraria.GameContent.Bestiary;
using Terraria.GameContent.Creative;
using Terraria.GameContent.Drawing;
using Terraria.GameContent.Events;
using Terraria.GameContent.FishDropRules;
using Terraria.GameContent.Golf;
using Terraria.GameContent.ItemDropRules;
using Terraria.GameContent.Liquid;
using Terraria.GameContent.NetModules;
using Terraria.GameContent.Shaders;
using Terraria.GameContent.Skies;
using Terraria.GameContent.UI;
using Terraria.GameContent.UI.BigProgressBar;
using Terraria.GameContent.UI.Chat;
using Terraria.GameContent.UI.Minimap;
using Terraria.GameContent.UI.ResourceSets;
using Terraria.GameContent.UI.States;
using Terraria.GameInput;
using Terraria.Graphics;
using Terraria.Graphics.CameraModifiers;
using Terraria.Graphics.Capture;
using Terraria.Graphics.Effects;
using Terraria.Graphics.Light;
using Terraria.Graphics.Renderers;
using Terraria.Graphics.Shaders;
using Terraria.ID;
using Terraria.Initializers;
using Terraria.IO;
using Terraria.Localization;
using Terraria.Map;
using Terraria.Net;
using Terraria.ObjectData;
using Terraria.Server;
using Terraria.Social;
using Terraria.Testing;
using Terraria.UI;
using Terraria.UI.Chat;
using Terraria.UI.Gamepad;
using Terraria.Utilities;
using Terraria.WorldBuilding;

namespace Terraria;

public class Main : Microsoft.Xna.Framework.Game
{
	public static class CurrentFrameFlags
	{
		public static class Hacks
		{
			public static Matrix CurrentBackgroundMatrixForCreditsRoll;
		}

		public static int ActivePlayersCount;

		public static int SleepingPlayersCount;

		public static bool AnyActiveBossNPC;

		public static bool HadAnActiveInteractibleProjectile;
	}

	public enum PipPage
	{
		Recipes,
		Banners
	}

	private struct IMEPanelAnchor
	{
		public Vector2 Position;

		public float XAnchor;
	}

	public enum WorldPreparationState
	{
		AwaitingData,
		ProcessingData,
		Ready
	}

	internal static class NativeMethods
	{
		public const uint ES_CONTINUOUS = 2147483648u;

		public const uint ES_SYSTEM_REQUIRED = 1u;

		[DllImport("kernel32.dll")]
		public static extern uint SetThreadExecutionState(uint esFlags);
	}

	private enum TitleMusicStyle
	{
		Current,
		Old,
		Console,
		Random
	}

	private struct MouseTextCache
	{
		public bool noOverride;

		public bool isValid;

		public string cursorText;

		public int rare;

		public byte diff;

		public int X;

		public int Y;

		public int hackedScreenWidth;

		public int hackedScreenHeight;

		public string buffTooltip;
	}

	public enum DialoguePortraitDrawOption
	{
		Detailed,
		CloseUp,
		FullBodyRetro,
		Disabled
	}

	public struct SceneArea
	{
		public float totalWidth;

		public float totalHeight;

		public int bgTopY;
	}

	public struct InfoToSetBackColor
	{
		public bool isInGameMenuOrIsServer;

		public float CorruptionBiomeInfluence;

		public float CrimsonBiomeInfluence;

		public float JungleBiomeInfluence;

		public float MushroomBiomeInfluence;

		public float GraveyardInfluence;

		public bool BloodMoonActive;

		public bool LanternNightActive;
	}

	private const string versionStringBecauseTheyreTheSame = "v1.4.5.4";

	public const int curRelease = 317;

	public const string assemblyVersionNumber = "1.4.5.4";

	public const string copyrightText = "Copyright Â© 2026 Re-Logic";

	public const ulong WorldGeneratorVersion = 1361504632833uL;

	public static int mapDelay = 2;

	public static IAssetRepository Assets;

	public static AssetSourceController AssetSourceController;

	private volatile bool _musicLoaded;

	public static int CurrentDrawnEntityShader;

	public static Entity CurrentDrawnEntity;

	private static bool GameAskedToQuit = false;

	public static float ForcedMinimumZoom = 1f;

	public static SpriteViewMatrix GameViewMatrix;

	public static SpriteViewMatrix BackgroundViewMatrix;

	private static Matrix _uiScaleMatrix;

	private static float _uiScaleWanted = 1f;

	private static float _uiScaleUsed = 1f;

	public static float GameZoomTarget = 1f;

	public static bool SettingsUnlock_WorldEvil;

	public static bool SettingsEnabled_MinersWobble = true;

	public static bool SettingsEnabled_AutoReuseAllItems = false;

	public static bool SettingBlockGamepadsEntirely;

	public static bool SettingDontScaleMainMenuUp;

	public static bool SettingsEnabled_OpaqueBoxBehindTooltips = true;

	public static bool HidePassword;

	public static bool ReversedUpDownArmorSetBonuses;

	public static Microsoft.Xna.Framework.Color MouseBorderColor = new Microsoft.Xna.Framework.Color(64, 64, 64, 64);

	public static bool MouseShowBuildingGrid;

	public static bool AllowUnfocusedInputOnGamepad;

	public static bool InvisibleCursorForGamepad = true;

	public static bool GamepadDisableCursorItemIconInner = true;

	public static bool GamepadDisableInstructionsDisplay;

	public static bool CrouchingEnabled = false;

	private static GameNotificationType _flashNotificationType = GameNotificationType.All;

	public static float MouseBuildingGridAlpha;

	public static bool CaptureModeDisabled = false;

	public bool unityMouseOver;

	public static Main instance;

	public static ChromaEngine Chroma;

	public static ChromaHotkeyPainter ChromaPainter;

	public static Camera Camera = new Camera();

	public static IPlayerRenderer PlayerRenderer = new LegacyPlayerRenderer();

	public static IPlayerRenderer PotionOfReturnRenderer = new ReturnGatePlayerRenderer();

	public static MapHeadRenderer MapPlayerRenderer = new MapHeadRenderer();

	public static OutlinedTextureRenderer TownNPCHeadRenderer = null;

	public static OutlinedTextureRenderer BossNPCHeadRenderer = null;

	public static OutlinedTextureRenderer ItemMapIconRenderer = null;

	public static List<TitleLinkButton> TitleLinks = new List<TitleLinkButton>();

	public static string versionNumber = "v1.4.5.4";

	public static string versionNumber2 = "v1.4.5.4";

	public static bool AnnouncementBoxDisabled;

	public static int AnnouncementBoxRange = -1;

	public static string AutogenSeedName;

	public static bool drunkWorld = false;

	public static bool getGoodWorld = false;

	public static bool tenthAnniversaryWorld = false;

	public static bool dontStarveWorld = false;

	public static bool notTheBeesWorld = false;

	public static bool remixWorld = false;

	public static bool noTrapsWorld = false;

	public static bool zenithWorld = false;

	public static bool skyblockWorld = false;

	public static bool vampireSeed = false;

	public static bool infectedSeed = false;

	public static bool teamBasedSpawnsSeed = false;

	public static bool dualDungeonsSeed = false;

	private static float? _gameModeDifficultyOverride = null;

	public static Vector2 destroyerHB = new Vector2(0f, 0f);

	public static FavoritesFile LocalFavoriteData = new FavoritesFile(SavePath + "/favorites.json", isCloud: false);

	public static FavoritesFile CloudFavoritesData = new FavoritesFile("favorites.json", isCloud: true);

	public static FileMetadata WorldFileMetadata;

	public static FileMetadata MapFileMetadata;

	public static PingMapLayer Pings = new PingMapLayer();

	public static MapIconOverlay MapIcons = new MapIconOverlay().AddLayer(new BossBagMapLayer()).AddLayer(new SpawnMapLayer()).AddLayer(new TeamBasedSpawnMapLayer())
		.AddLayer(new TeleportPylonsMapLayer())
		.AddLayer(Pings);

	public static CreativeUI CreativeMenu = new CreativeUI();

	private static Vector2 _lastPingMousePosition = Vector2.Zero;

	private static double _lastPingMouseDownTime = 0.0;

	private AchievementManager _achievements;

	private AchievementAdvisor _achievementAdvisor;

	public static BigProgressBarSystem BigBossProgressBar = new BigProgressBarSystem();

	public static UserInterface MenuUI = new UserInterface();

	public static UserInterface InGameUI = new UserInterface();

	private static Action _pendingCharacterSelect;

	public static bool drawBackGore;

	public static ulong LobbyId = 0uL;

	public WaterfallManager waterfallManager;

	public static WorldSections sectionManager;

	public static bool ServerSideCharacter;

	public static string clientUUID;

	public static bool ContentLoaded = false;

	private static int toolTipDistance = 6;

	public static float GlobalTimeWrappedHourly;

	public static bool GlobalTimerPaused = false;

	public static ulong EverLastingTicker = 0uL;

	public static GameTime gameTimeCache = new GameTime();

	public static ulong TileFrameSeed = (ulong)Guid.NewGuid().GetHashCode();

	private static ulong _drawCycleCounter;

	public static Asset<Effect> ScreenShaderRef = Asset<Effect>.Empty;

	public static Asset<Effect> PixelShaderRef = Asset<Effect>.Empty;

	public static Asset<Effect> TileShaderRef = Asset<Effect>.Empty;

	public static int WaveQuality = 3;

	public static bool UseStormEffects = true;

	public static bool UseHeatDistortion = true;

	public static bool ForegroundSunlightEffects = true;

	public static bool UseScreenShake = true;

	public static bool FlashyEffectsWorld = true;

	public static bool FlashyEffectsInterface = true;

	public static List<IEnumerator> DelayedProcesses = new List<IEnumerator>();

	public static List<IEnumerator> DelayedProcessesInGame = new List<IEnumerator>();

	public static int npcStreamSpeed = 30;

	public static int musicError;

	public static bool dedServFPS;

	public static int dedServCount1;

	public static int dedServCount2;

	public static readonly int offLimitBorderTiles = 40;

	public static readonly int maxMusic = 105;

	public static readonly int maxBackgrounds = 344;

	public const int MaxShopIDs = 100;

	private static float cameraLerp;

	private static int cameraLerpTimer;

	private static int cameraLerpTimeToggle;

	public static Vector2[] OffsetsNPCOffhand = new Vector2[5]
	{
		new Vector2(14f, 34f),
		new Vector2(14f, 32f),
		new Vector2(14f, 26f),
		new Vector2(14f, 22f),
		new Vector2(14f, 18f)
	};

	public static Vector2[] OffsetsPlayerOffhand = new Vector2[20]
	{
		new Vector2(14f, 20f),
		new Vector2(14f, 20f),
		new Vector2(14f, 20f),
		new Vector2(14f, 18f),
		new Vector2(14f, 20f),
		new Vector2(16f, 4f),
		new Vector2(16f, 16f),
		new Vector2(18f, 14f),
		new Vector2(18f, 14f),
		new Vector2(18f, 14f),
		new Vector2(16f, 16f),
		new Vector2(16f, 16f),
		new Vector2(16f, 16f),
		new Vector2(16f, 16f),
		new Vector2(14f, 14f),
		new Vector2(14f, 14f),
		new Vector2(12f, 14f),
		new Vector2(14f, 16f),
		new Vector2(16f, 16f),
		new Vector2(16f, 16f)
	};

	public static Vector2[] OffsetsPlayerOnhand = new Vector2[20]
	{
		new Vector2(6f, 19f),
		new Vector2(5f, 10f),
		new Vector2(12f, 10f),
		new Vector2(13f, 17f),
		new Vector2(12f, 19f),
		new Vector2(5f, 10f),
		new Vector2(7f, 17f),
		new Vector2(6f, 16f),
		new Vector2(6f, 16f),
		new Vector2(6f, 16f),
		new Vector2(6f, 17f),
		new Vector2(7f, 17f),
		new Vector2(7f, 17f),
		new Vector2(7f, 17f),
		new Vector2(8f, 17f),
		new Vector2(9f, 16f),
		new Vector2(9f, 12f),
		new Vector2(8f, 17f),
		new Vector2(7f, 17f),
		new Vector2(7f, 17f)
	};

	public static Vector2[] OffsetsPlayerHeadgear = new Vector2[20]
	{
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 0f),
		new Vector2(0f, 0f),
		new Vector2(0f, 0f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 0f),
		new Vector2(0f, 0f),
		new Vector2(0f, 0f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f),
		new Vector2(0f, 2f)
	};

	public static Vector2 CurrentPan = Vector2.Zero;

	public static float sunCircle;

	public static int BlackFadeIn;

	public static bool noWindowBorder = false;

	public static RasterizerState Rasterizer = RasterizerState.CullCounterClockwise;

	private string _cachedTitle;

	public static int undergroundBackground;

	public static int oldUndergroundBackground;

	public static bool verboseNetplay = false;

	public static bool stopTimeOuts = false;

	public static bool showSpam = false;

	public static bool showItemOwner = false;

	public static bool[] townNPCCanSpawn = new bool[NPCID.Count];

	public static byte HealthBarDrawSettings = 1;

	public static bool runningCollectorsEdition;

	public static float wFrCounter;

	public static float wFrame;

	public static float upTimer;

	public static float upTimerMax;

	public static float upTimerMaxDelay;

	public static int drawDiag;

	public static bool drawRelease;

	public static bool drawBetterDebug;

	public static bool betterDebugRelease;

	public static bool renderNow;

	public static bool drawToScreen;

	public static bool targetSet;

	public static int mouseX;

	public static int mouseY;

	public static int lastMouseX;

	public static int lastMouseY;

	public static CraftingUI craftingUI = new CraftingUI();

	public static BannerClaimingUI bannerUI = new BannerClaimingUI();

	private static ConcurrentQueue<Action> _mainThreadActions = new ConcurrentQueue<Action>();

	public static bool mouseLeft;

	public static bool mouseRight;

	public static bool isMouseLeftConsumedByUI = false;

	public static float essScale = 1f;

	public static int essDir = -1;

	public static float[] cloudBGX = new float[2];

	public static float cloudBGAlpha;

	public static float cloudBGActive;

	public static int[] cloudBG = new int[2] { 112, 113 };

	public static int[] treeMntBGSet1 = new int[2];

	public static int[] treeMntBGSet2 = new int[2];

	public static int[] treeMntBGSet3 = new int[2];

	public static int[] treeMntBGSet4 = new int[2];

	public static int[] treeBGSet1 = new int[3];

	public static int[] treeBGSet2 = new int[3];

	public static int[] treeBGSet3 = new int[3];

	public static int[] treeBGSet4 = new int[3];

	public static int[] corruptBG = new int[3];

	public static int[] jungleBG = new int[3];

	public static int[] snowMntBG = new int[2];

	public static int[] snowBG = new int[3];

	public static int[] hallowBG = new int[3];

	public static int[] crimsonBG = new int[3];

	public static BackgroundVariantSet desertBackgroundSet = new BackgroundVariantSet();

	public static int[] mushroomBG = new int[3];

	public static int oceanBG;

	public static int[] underworldBG = new int[5];

	public static int[] treeX = new int[4];

	public static int[] treeStyle = new int[4];

	public static int[] caveBackX = new int[4];

	public static int[] caveBackStyle = new int[4];

	public static int iceBackStyle;

	public static int hellBackStyle;

	public static int jungleBackStyle;

	public static string debugWords = "";

	public static bool gamePad = false;

	public static bool xMas;

	public static bool halloween;

	public static bool forceXMasForToday;

	public static bool forceHalloweenForToday;

	public static bool forceXMasForever;

	public static bool forceHalloweenForever;

	public static int snowDust = 0;

	public static bool changeTheTitle;

	public static bool hairWindow;

	public static bool clothesWindow;

	public static bool ingameOptionsWindow = false;

	public static bool inFancyUI = false;

	public static bool onlyDrawFancyUI = false;

	public static int keyCount;

	public static string[] keyString = new string[100];

	public static int[] keyInt = new int[100];

	public static byte gFade;

	public static float gFader;

	public static byte gFadeDir = 1;

	public static bool shouldDrawNetDiagnosticsUI;

	private static INetDiagnosticsUI _activeNetDiagnosticsUI;

	public static IMultiplayerClosePlayersOverlay ActiveClosePlayersTeamOverlay = new NewMultiplayerClosePlayersOverlay();

	private static int successiveSkippedDraws;

	public static double UpdateTimeAccumulator;

	public static int fpsCount;

	public static Stopwatch fpsTimer = new Stopwatch();

	public bool gammaTest;

	private const bool USE_ASYNC_LOAD = true;

	private static bool _isAsyncLoadComplete;

	public static bool showSplash = true;

	public static bool ignoreErrors = true;

	public static string defaultIP = "";

	public static int dayRate = 1;

	public static int desiredWorldTilesUpdateRate = 1;

	public const int MaxWorldViewSizeWidth = 1920;

	public const int MaxWorldViewSizeHeight = 1200;

	public static readonly Microsoft.Xna.Framework.Point MaxWorldViewSize = new Microsoft.Xna.Framework.Point(1920, 1200);

	public static int maxScreenW = 1920;

	public static int maxScreenH = 1200;

	public static int minScreenW = 800;

	public static int minScreenH = 600;

	public static float iS = 1f;

	public static bool render;

	public static int qaStyle;

	public static float musicPitch = 0f;

	public static bool[] projHostile = new bool[ProjectileID.Count];

	public static bool[] projHook = new bool[ProjectileID.Count];

	public static bool[] pvpBuff = new bool[BuffID.Count];

	public static bool[] persistentBuff = new bool[BuffID.Count];

	public static bool[] vanityPet = new bool[BuffID.Count];

	public static bool[] lightPet = new bool[BuffID.Count];

	public static bool[] meleeBuff = new bool[BuffID.Count];

	public static bool[] debuff = new bool[BuffID.Count];

	public static bool[] buffNoSave = new bool[BuffID.Count];

	public static bool[] buffNoTimeDisplay = new bool[BuffID.Count];

	public static bool[] buffDoubleApply = new bool[BuffID.Count];

	public static int maxMP = 10;

	public static string[] recentWorld = new string[maxMP];

	public static string[] recentIP = new string[maxMP];

	public static int[] recentPort = new int[maxMP];

	public static bool shortRender = true;

	public static bool BackgroundEnabled = true;

	public static int instantBGTransitionCounter = 2;

	public static int bgDelay;

	public static int bgStyle;

	public static float[] bgAlphaFrontLayer = new float[16];

	public static float[] bgAlphaFarBackLayer = new float[16];

	public static int[] bgFrame = new int[16];

	public static int[] bgFrameCounter = new int[16];

	public static int EquipPage;

	public static int EquipPageSelected;

	public int mouseNPCIndex = -1;

	public int mouseNPCType = -1;

	public static int wofNPCIndex = -1;

	public static int wofDrawAreaTop;

	public static int wofDrawAreaBottom;

	public static int wofDrawFrameIndex;

	public static int offScreenRange = 200;

	private static WorldSceneLayerTarget backWaterTarget;

	public static WorldSceneLayerTarget waterTarget;

	private static WorldSceneLayerTarget tileTarget;

	private static WorldSceneLayerTarget tile2Target;

	private static WorldSceneLayerTarget wallTarget;

	private static WorldSceneLayerTarget backgroundTarget;

	private static WorldSceneLayerTarget backgroundTargetSwap;

	private static bool backgroundTargetSwapPending;

	public static RenderTarget2D skyTarget;

	public static RenderTarget2D screenTarget;

	public static RenderTarget2D screenTargetSwap;

	public static int maxMapUpdates = 250000;

	public static bool refreshMap;

	public static int loadMapLastX;

	public static bool loadMapLock;

	public static bool loadMap;

	public static bool mapReady;

	public static Microsoft.Xna.Framework.Rectangle? updateMap;

	public static int mapTimeMax = 30;

	public static int mapTime = mapTimeMax;

	public static bool clearMap;

	public const int numInfoIcons = 13;

	public static Microsoft.Xna.Framework.Color OurFavoriteColor = new Microsoft.Xna.Framework.Color(255, 231, 69);

	public static bool mapInit;

	public static bool mapEnabled = true;

	public static int mapStyle = 1;

	public static float grabMapX;

	public static float grabMapY;

	public static int miniMapX;

	public static int miniMapY;

	public static int miniMapWidth;

	public static int miniMapHeight;

	public static float mapMinimapDefaultScale = 1.05f;

	public static float mapMinimapScale = mapMinimapDefaultScale;

	public static float mapMinimapAlpha = 1f;

	public static float mapOverlayScale = 2.5f;

	public static float mapOverlayAlpha = 0.35f;

	public static Point16 MapPylonTile;

	public static bool mapFullscreen;

	public static bool resetMapFull;

	public static float mapFullscreenScale = 4f;

	public static Vector2 mapFullscreenPos = new Vector2(-1f, -1f);

	public static bool PanTargetMapFullscreen = false;

	public static Vector2 PanTargetMapFullscreenEnd = new Vector2(-1f, -1f);

	private static bool IsEnginePreloaded;

	private static bool IsEngineLoaded;

	private static uint _gameUpdateCount;

	public static bool SkipAssemblyLoad;

	private static bool Setting_AssetFileWatcherEnabled = true;

	private double bgParallax;

	private int bgStartX;

	private int bgLoops;

	private int bgStartY;

	private int bgLoopsY;

	private float bgTopY;

	public static int renderCount = 99;

	private const int MF_BYPOSITION = 1024;

	public static GraphicsDeviceManager graphics;

	public static SpriteBatch spriteBatch;

	public static SpriteDrawBuffer spriteBuffer;

	public static TileBatch tileBatch;

	public static BasicDebugDrawer DebugDrawer;

	public static SamplerState SamplerStateForCursor = SamplerState.LinearClamp;

	public static GenerationProgress AutogenProgress = new GenerationProgress();

	private static Process tServer;

	private static Stopwatch saveTime = new Stopwatch();

	public static KeyboardState keyState;

	public static KeyboardState oldKeyState;

	public static Microsoft.Xna.Framework.Color mcColor = new Microsoft.Xna.Framework.Color(1f, 0.6f, 0f);

	public static Microsoft.Xna.Framework.Color hcColor = new Microsoft.Xna.Framework.Color(1f, 0.15f, 0.1f);

	public static Microsoft.Xna.Framework.Color creativeModeColor = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.HotPink, Microsoft.Xna.Framework.Color.White, 0.1f);

	public static Microsoft.Xna.Framework.Color legendaryModeColor = Microsoft.Xna.Framework.Color.LimeGreen;

	public static Microsoft.Xna.Framework.Color highVersionColor = new Microsoft.Xna.Framework.Color(255, 255, 0);

	public static Microsoft.Xna.Framework.Color errorColor = new Microsoft.Xna.Framework.Color(255, 0, 0);

	public static bool craftingHide;

	public static bool armorHide;

	public static float shimmerAlpha = 0f;

	public static float shimmerDarken = 0f;

	public static float craftingAlpha = 1f;

	public static float armorAlpha = 1f;

	public static float[] buffAlpha = new float[BuffID.Count];

	public static bool afterPartyOfDoom = false;

	public static bool hardMode;

	public float chestLootScale = 1f;

	public bool chestLootHover;

	public float chestStackScale = 1f;

	public bool chestStackHover;

	public float chestDepositScale = 1f;

	public bool chestDepositHover;

	public float chestRenameScale = 1f;

	public bool chestRenameHover;

	public float chestCancelScale = 1f;

	public bool chestCancelHover;

	public static bool maxQ = true;

	public static float gfxQuality = 1f;

	public static float gfxRate = 0.01f;

	public int DiscoStyle;

	public static int DiscoR = 255;

	public static int DiscoB;

	public static int DiscoG;

	public static int teamCooldown;

	public static int teamCooldownLen = 300;

	public static bool gamePaused;

	public static bool gameInactive;

	public bool ReHideCursor;

	public static int updatesCountedForFPS;

	public static int drawsCountedForFPS;

	public static int uCount;

	public static int updateRate;

	public static int frameRate;

	public static bool RGBRelease;

	public static bool qRelease = false;

	public static bool netRelease;

	public static bool frameRelease;

	public static bool showFrameRate = false;

	public static int magmaBGFrame;

	public static int magmaBGFrameCounter;

	public static int saveTimer = 0;

	public static bool autoJoin;

	public static bool serverStarting = false;

	public static float leftWorld = 0f;

	public static float rightWorld = 134400f;

	public static float topWorld = 0f;

	public static float bottomWorld = 38400f;

	public static int maxTilesX = (int)rightWorld / 16 + 1;

	public static int maxTilesY = (int)bottomWorld / 16 + 1;

	public const int sectionWidth = 200;

	public const int sectionHeight = 150;

	public static int maxSectionsX = maxTilesX / 200;

	public static int maxSectionsY = maxTilesY / 150;

	public const int maxDust = 6000;

	public static int maxDustToDraw = 6000;

	public const int maxCombatText = 100;

	public const int maxPlayers = 255;

	public static int maxNetPlayers = 255;

	public const int maxChests = 8000;

	public const int maxItems = 400;

	public const int maxProjectiles = 1000;

	public static readonly int maxNPCs = InitData.MaxNPCs;

	private static UICharacterSelect _characterSelectMenu = new UICharacterSelect();

	private static UIWorldSelect _worldSelectMenu = new UIWorldSelect();

	public static UIManageControls ManageControlsMenu = new UIManageControls();

	public static UIAchievementsMenu AchievementsMenu = new UIAchievementsMenu();

	public static int maxRain = 750;

	public static int slimeWarningTime;

	public static int slimeWarningDelay = 420;

	public static float slimeRainNPCSlots = 0.65f;

	public static bool[] slimeRainNPC = new bool[NPCID.Count];

	public static double slimeRainTime;

	public static bool slimeRain;

	public static int slimeRainKillCount;

	private const double slimeRainMaxTime = 54000.0;

	private const double slimeRainMinTime = 32400.0;

	private const double slimeRainMaxDelay = 604800.0;

	private const double slimeRainMinDelay = 302400.0;

	private const double LeinforsBalanceRequestForSlimeRainChance = 1.0416666666666667;

	private const double slimeRainChance = 450000.00000000006;

	public const int maxGore = 600;

	public const int InventoryItemSlotsStart = 0;

	public const int InventoryItemSlotsCount = 50;

	public const int InventoryCoinSlotsStart = 50;

	public const int InventoryCoinSlotsCount = 4;

	public const int InventoryAmmoSlotsStart = 54;

	public const int InventoryAmmoSlotsCount = 4;

	public const int InventorySlotsTotal = 58;

	public int invBottom = 210;

	public const int maxLiquidTypes = 15;

	public static float cameraX;

	public static float cameraY;

	public static bool drewLava;

	public static float[] liquidAlpha = new float[15];

	public static int waterStyle;

	public static int WorldRollingBackupsCountToKeep = 2;

	private static bool TOWMusicUnlocked = false;

	private static bool swapMusic = false;

	public static float caveParallax = 0.88f;

	public static int dungeonX;

	public static int dungeonY;

	public static Liquid[] liquid = new Liquid[Liquid.maxLiquid];

	public static LiquidBuffer[] liquidBuffer = new LiquidBuffer[50000];

	public static bool dedServ;

	public static int spamCount = 0;

	public static int curMusic;

	public static int dayMusic;

	public static int ugMusic;

	public static int newMusic;

	public static bool showItemText = true;

	public static bool autoSave = true;

	public static bool validateSaves = true;

	public static bool bannerMouseOver;

	public static string buffString = "";

	public static string libPath = "";

	public static int lo;

	public static int LogoA = 255;

	public static int LogoB;

	public static bool LogoT;

	public static string statusText = "";

	public static string worldName = "";

	public static int background;

	public static int caveBackground = 0;

	public static float ugBackTransition;

	public static Microsoft.Xna.Framework.Color tileColor;

	public static double worldSurface;

	public static double rockLayer;

	public static Microsoft.Xna.Framework.Color[] teamColor = new Microsoft.Xna.Framework.Color[6];

	public const double dayLength = 54000.0;

	public const double nightLength = 32400.0;

	public static bool dayTime = true;

	public static double time = 13500.0;

	public static double timeForVisualEffects;

	public static int moonPhase;

	public static short sunModY;

	public static short moonModY;

	public static bool alreadyGrabbingSunOrMoon;

	public static bool bloodMoon;

	public static bool pumpkinMoon;

	public static bool snowMoon;

	public static float cloudAlpha;

	public static float maxRaining;

	public static float oldMaxRaining;

	public static int rainTime;

	public static bool raining;

	public static int coinRain;

	public static bool eclipse;

	public static float eclipseLight;

	public static int checkForSpawns;

	public static int helpText;

	public static int BartenderHelpTextIndex = 0;

	public static bool autoGen;

	public static bool autoPause = false;

	public static int[] projFrames = new int[ProjectileID.Count];

	public static bool[] projPet = new bool[ProjectileID.Count];

	public static float demonTorch = 1f;

	public static int demonTorchDir = 1;

	public static float martianLight = 1f;

	public static int martianLightDir = 1;

	public static float masterColor = 1f;

	public static int masterColorDir = 1;

	public static bool placementPreview = true;

	private static SceneMetrics _cameraSceneMetrics = new SceneMetrics();

	private static SceneMetrics _playerSceneMetrics = new SceneMetrics();

	private static bool _usingSeparateCameraSceneMetrics;

	public static SceneState SceneState = new SceneState();

	public const int maxStars = 400;

	public static int numStars;

	public const int maxStarTypes = 4;

	public const int maxClouds = 200;

	public static int weatherCounter;

	public static int numClouds = 200;

	public static int numCloudsTemp = numClouds;

	public static float windSpeedCurrent;

	public static float windSpeedTarget;

	public static int windCounter;

	public static int extremeWindCounter;

	public static bool windPhysics = false;

	public static float windPhysicsStrength = 0.1f;

	public const float lowWindLimit = 0.35f;

	public static bool SettingsEnabled_TilesSwayInWind = true;

	public static Cloud[] cloud = new Cloud[200];

	public static bool resetClouds = true;

	public static float SmoothedMushroomLightInfluence;

	public static int fadeCounter;

	public static float invAlpha = 1f;

	public static float invDir = 1f;

	[ThreadStatic]
	public static UnifiedRandom rand;

	public static bool allChestStackHover;

	public static bool inventorySortMouseOver;

	public static bool bestiaryMouseOver;

	public static bool emoteMouseOver;

	public static bool hotbarLockMouseOver;

	public static bool achievementAdvisorMouseOver;

	public static bool nearbyCraftingMouseOver;

	public static bool GridToggleMouseOverCrafting;

	public static bool GridToggleMouseOverBanners;

	public static bool CreativeMenuMouseOver;

	public static int infoAccMouseOver = -1;

	public static int toggleAccMouseOver = -1;

	public static int equipPageMouseOver = -1;

	public static int loadoutMouseOver = -1;

	public static int mapStyleMouseOver = -1;

	public static float GraveyardVisualIntensity;

	public const int maxMoons = 9;

	public static int moonType = 0;

	public const int numTileColors = 32;

	public const int numTreeStyles = 32;

	public const int numberOfHairstyles = 228;

	public const int maxHairStyles = 228;

	public const int maxCharSelectHair = 51;

	public const int maxHairOfStylistDefault = 123;

	public static bool UseExperimentalFeatures;

	public static string DefaultSeed = "";

	public static IAudioSystem audioSystem;

	public static bool[] musicNoCrossFade = new bool[maxMusic];

	public static float[] musicFade = new float[maxMusic];

	public static float musicVolume = 1f;

	public static float ambientVolume = 1f;

	public static float soundVolume = 1f;

	public static ServerMode MenuServerMode = ServerMode.Lobby | ServerMode.FriendsCanJoin;

	public static bool[] tileLighted = new bool[TileID.Count];

	public static bool[] tileMergeDirt = new bool[TileID.Count];

	public static bool[] tileCut = new bool[TileID.Count];

	public static bool[] tileAlch = new bool[TileID.Count];

	public static int[] tileShine = new int[TileID.Count];

	public static bool[] tileShine2 = new bool[TileID.Count];

	public static bool[] wallHouse = new bool[WallID.Count];

	public static bool[] wallDungeon = new bool[WallID.Count];

	public static bool[] wallLight = new bool[WallID.Count];

	public static int[] wallBlend = new int[WallID.Count];

	public static bool[] tileStone = new bool[TileID.Count];

	public static bool[] tileAxe = new bool[TileID.Count];

	public static bool[] tileHammer = new bool[TileID.Count];

	public static bool[] tileWaterDeath = new bool[TileID.Count];

	public static bool[] tileLavaDeath = new bool[TileID.Count];

	public static bool[] tileTable = new bool[TileID.Count];

	public static bool[] tileBlockLight = new bool[TileID.Count];

	public static bool[] tileNoSunLight = new bool[TileID.Count];

	public static bool[] tileDungeon = new bool[TileID.Count];

	public static bool[] tileSpelunker = new bool[TileID.Count];

	public static bool[] tileSolidTop = new bool[TileID.Count];

	public static bool[] tileSolid = new bool[TileID.Count];

	public static bool[] tileBouncy = new bool[TileID.Count];

	public static short[] tileOreFinderPriority = new short[TileID.Count];

	public static byte[] tileLargeFrames = new byte[TileID.Count];

	public static byte[] wallLargeFrames = new byte[WallID.Count];

	public static bool[] tileRope = new bool[TileID.Count];

	public static bool[] tileBrick = new bool[TileID.Count];

	public static bool[] tileMoss = new bool[TileID.Count];

	public static bool[] tileNoAttach = new bool[TileID.Count];

	public static bool[] tileNoFail = new bool[TileID.Count];

	public static bool[] tileCracked = new bool[TileID.Count];

	public static bool[] tileObsidianKill = new bool[TileID.Count];

	public static bool[] tileFrameImportant = new bool[TileID.Count];

	public static bool[] tilePile = new bool[TileID.Count];

	public static bool[] tileBlendAll = new bool[TileID.Count];

	public static short[] tileGlowMask = new short[TileID.Count];

	public static bool[] tileContainer = new bool[TileID.Count];

	public static bool[] tileSign = new bool[TileID.Count];

	public static bool[][] tileMerge = new bool[TileID.Count][];

	public static int cageFrames = 25;

	public static bool critterCage;

	public static int[] bunnyCageFrame = new int[cageFrames];

	public static int[] bunnyCageFrameCounter = new int[cageFrames];

	public static int[] squirrelCageFrame = new int[cageFrames];

	public static int[] squirrelCageFrameCounter = new int[cageFrames];

	public static int[] squirrelCageFrameOrange = new int[cageFrames];

	public static int[] squirrelCageFrameCounterOrange = new int[cageFrames];

	public static int[] mallardCageFrame = new int[cageFrames];

	public static int[] mallardCageFrameCounter = new int[cageFrames];

	public static int[] duckCageFrame = new int[cageFrames];

	public static int[] duckCageFrameCounter = new int[cageFrames];

	public static int[] grebeCageFrame = new int[cageFrames];

	public static int[] grebeCageFrameCounter = new int[cageFrames];

	public static int[] seagullCageFrame = new int[cageFrames];

	public static int[] seagullCageFrameCounter = new int[cageFrames];

	public static int[] birdCageFrame = new int[cageFrames];

	public static int[] birdCageFrameCounter = new int[cageFrames];

	public static int[] redBirdCageFrame = new int[cageFrames];

	public static int[] redBirdCageFrameCounter = new int[cageFrames];

	public static int[] blueBirdCageFrame = new int[cageFrames];

	public static int[] blueBirdCageFrameCounter = new int[cageFrames];

	public static int[] macawCageFrame = new int[cageFrames];

	public static int[] macawCageFrameCounter = new int[cageFrames];

	public static byte[,] butterflyCageMode = new byte[9, cageFrames];

	public static int[,] butterflyCageFrame = new int[9, cageFrames];

	public static int[,] butterflyCageFrameCounter = new int[9, cageFrames];

	public static int[,] dragonflyJarFrameCounter = new int[7, cageFrames];

	public static int[,] dragonflyJarFrame = new int[7, cageFrames];

	public static int[,] scorpionCageFrame = new int[2, cageFrames];

	public static int[,] scorpionCageFrameCounter = new int[2, cageFrames];

	public static int[] snailCageFrame = new int[cageFrames];

	public static int[] snailCageFrameCounter = new int[cageFrames];

	public static int[] snail2CageFrame = new int[cageFrames];

	public static int[] snail2CageFrameCounter = new int[cageFrames];

	public static byte[] fishBowlFrameMode = new byte[cageFrames];

	public static int[] fishBowlFrame = new int[cageFrames];

	public static int[] fishBowlFrameCounter = new int[cageFrames];

	public static int[] lavaFishBowlFrame = new int[cageFrames];

	public static int[] lavaFishBowlFrameCounter = new int[cageFrames];

	public static int[] frogCageFrame = new int[cageFrames];

	public static int[] frogCageFrameCounter = new int[cageFrames];

	public static int[] mouseCageFrame = new int[cageFrames];

	public static int[] mouseCageFrameCounter = new int[cageFrames];

	public static int[] turtleCageFrame = new int[cageFrames];

	public static int[] turtleCageFrameCounter = new int[cageFrames];

	public static int[] fairyJarFrame = new int[cageFrames];

	public static int[] fairyJarFrameCounter = new int[cageFrames];

	public static byte[,] jellyfishCageMode = new byte[3, cageFrames];

	public static int[,] jellyfishCageFrame = new int[3, cageFrames];

	public static int[,] jellyfishCageFrameCounter = new int[3, cageFrames];

	public static int[] wormCageFrame = new int[cageFrames];

	public static int[] wormCageFrameCounter = new int[cageFrames];

	public static int[] maggotCageFrame = new int[cageFrames];

	public static int[] maggotCageFrameCounter = new int[cageFrames];

	public static int[] ratCageFrame = new int[cageFrames];

	public static int[] ratCageFrameCounter = new int[cageFrames];

	public static int[] ladybugCageFrame = new int[cageFrames];

	public static int[] ladybugCageFrameCounter = new int[cageFrames];

	public static int[] penguinCageFrame = new int[cageFrames];

	public static int[] penguinCageFrameCounter = new int[cageFrames];

	public static int[] waterStriderCageFrame = new int[cageFrames];

	public static int[] waterStriderCageFrameCounter = new int[cageFrames];

	public static int[] seahorseCageFrame = new int[cageFrames];

	public static int[] seahorseCageFrameCounter = new int[cageFrames];

	public static int[,] slugCageFrame = new int[3, cageFrames];

	public static int[,] slugCageFrameCounter = new int[3, cageFrames];

	public static int[] owlCageFrame = new int[cageFrames];

	public static int[] owlCageFrameCounter = new int[cageFrames];

	public static int[] grasshopperCageFrame = new int[cageFrames];

	public static int[] grasshopperCageFrameCounter = new int[cageFrames];

	public static int[] pufferfishCageFrame = new int[cageFrames];

	public static int[] pufferfishCageFrameCounter = new int[cageFrames];

	public static bool[] tileSand = new bool[TileID.Count];

	public static bool[] tileFlame = new bool[TileID.Count];

	public static bool[] npcCatchable = new bool[NPCID.Count];

	public static int[] tileFrame = new int[TileID.Count];

	public static int[] tileFrameCounter = new int[TileID.Count];

	public static byte[] wallFrame = new byte[WallID.Count];

	public static byte[] wallFrameCounter = new byte[WallID.Count];

	public static int[] backgroundWidth = new int[maxBackgrounds];

	public static int[] backgroundHeight = new int[maxBackgrounds];

	public static HairstyleUnlocksHelper Hairstyles = new HairstyleUnlocksHelper();

	public static bool tilesLoaded = false;

	public static WorldMap Map;

	public static Tile[,] tile = new Tile[maxTilesX, maxTilesY];

	public static Dust[] dust = new Dust[6001];

	public static Star[] star = new Star[400];

	public static WorldItem[] item = new WorldItem[401];

	public static int[] timeItemSlotCannotBeReusedFor = new int[401];

	public static NPC[] npc = new NPC[maxNPCs + 1];

	public static Gore[] gore = new Gore[601];

	public static Rain[] rain = new Rain[maxRain + 1];

	public static Projectile[] projectile = new Projectile[1001];

	public static int[,] projectileIdentity = new int[256, 1001];

	public static CombatText[] combatText = new CombatText[100];

	public static Chest[] chest = new Chest[8000];

	public static Sign[] sign = new Sign[32000];

	public static int[] itemFrame = new int[401];

	public static int[] itemFrameCounter = new int[401];

	public static DrawAnimation[] itemAnimations = new DrawAnimation[ItemID.Count];

	private static DrawAnimation _coinOnWorldAnimation = new DrawAnimationVertical(6, 8);

	private static DrawAnimation _monkStaffT3OnWorldAnimation = new DrawAnimationVertical(5, 3);

	public static List<int> itemAnimationsRegistered = new List<int>();

	public static Vector2 screenPosition;

	public static int screenWidth = 1152;

	public static int screenHeight = 864;

	public static bool screenMaximized = true;

	public static bool screenBorderless = true;

	public static int screenBorderlessPendingResizes;

	public static int teamNamePlateDistance = 2000;

	public static int multiplayerNPCSmoothingRange = 300;

	public static bool Setting_UseReducedMaxLiquids = false;

	public static int PlayerOverheadChatMessageDisplayTime = 400;

	public static object CurrentInputTextTakerOverride;

	public static bool drawingPlayerChat;

	public static bool chatRelease;

	public static string chatText = "";

	public static bool inputTextEnter;

	public static bool inputTextEscape;

	public static float[] hotbarScale = new float[10] { 1f, 0.75f, 0.75f, 0.75f, 0.75f, 0.75f, 0.75f, 0.75f, 0.75f, 0.75f };

	public static byte mouseTextColor;

	public static int mouseTextColorChange = 1;

	public static bool mouseLeftRelease;

	public static bool mouseRightRelease;

	public static bool playerInventory;

	public static int stackSplit;

	public static bool quickCraftStackSplit;

	public static int stackCounter;

	public static int timesTriedToFastStack;

	public static int stackDelay = 7;

	public static int superFastStack;

	public static Item mouseItem = new Item();

	public static Item guideItem = new Item();

	public static Item reforgeItem = new Item();

	public static float inventoryScale = 0.75f;

	public static bool hasFocus;

	public static Microsoft.Xna.Framework.Point rulerLineDisplayValues = default(Microsoft.Xna.Framework.Point);

	public static bool PipsFastScroll;

	public static bool PipsUseGrid;

	public static PipPage PipsCurrentPage;

	public static int recStart;

	public static Recipe[] recipe = new Recipe[Recipe.maxRecipes];

	public static int[] availableRecipe = new int[Recipe.maxRecipes];

	public static int numAvailableRecipes;

	public static int focusRecipe;

	public static int myPlayer;

	public static Player[] player = new Player[256];

	public static Player[] playerVisualClone = new Player[256];

	public static bool[] countsAsHostForGameplay = new bool[256];

	public static int spawnTileX;

	public static int spawnTileY;

	public static bool npcChatRelease;

	public static bool editSign;

	public static bool editChest;

	public static bool blockInput = false;

	public static string blockKey = Microsoft.Xna.Framework.Input.Keys.None.ToString();

	public static string defaultChestName = string.Empty;

	public static string npcChatText = "";

	public static bool npcChatFocus1;

	public static bool npcChatFocus2;

	public static bool npcChatFocus3;

	public static bool npcChatFocus4;

	public static int oldNPCShop;

	public static int npcChatCornerItem;

	public static NPCID.Sets.NPCPortraitProvider npcChatPortrait;

	public static int npcChatPortraitFrameCounter;

	public Chest[] shop = new Chest[100];

	public static ItemShopSellbackHelper shopSellbackHelper = new ItemShopSellbackHelper();

	public static readonly int TravelShopMaxSlots = 40;

	public static int[] travelShop = new int[TravelShopMaxSlots];

	public static List<string> anglerWhoFinishedToday = new List<string>();

	public static bool anglerQuestFinished;

	public static int anglerQuest;

	public static int[] anglerQuestItemNetIDs = new int[41]
	{
		2450, 2451, 2452, 2453, 2454, 2455, 2456, 2457, 2458, 2459,
		2460, 2461, 2462, 2463, 2464, 2465, 2466, 2467, 2468, 2469,
		2470, 2471, 2472, 2473, 2474, 2475, 2476, 2477, 2478, 2479,
		2480, 2481, 2482, 2483, 2484, 2485, 2486, 2487, 2488, 4393,
		4394
	};

	public static AmbienceServer AmbienceServer;

	public static ItemDropDatabase ItemDropsDB;

	public static FishDropRuleList FishDropsDB;

	public static BestiaryDatabase BestiaryDB;

	public static ItemDropResolver ItemDropSolver;

	public static BestiaryUnlocksTracker BestiaryTracker;

	public static UIBestiaryTest BestiaryUI;

	public static TeleportPylonsSystem PylonSystem;

	public static ShopHelper ShopHelper;

	public static GolfState LocalGolfState = new GolfState();

	public static DroneCameraTracker DroneCameraTracker = new DroneCameraTracker();

	public static WorkshopPublishingIndicator WorkshopPublishingIndicator = new WorkshopPublishingIndicator();

	public static IssueReportsIndicator IssueReporterIndicator = new IssueReportsIndicator();

	public static bool Support4K = true;

	private static int _renderTargetMaxSize = 2048;

	private static GraphicsProfile _selectedGraphicsProfile = ((!Program.IsXna) ? GraphicsProfile.HiDef : GraphicsProfile.Reach);

	private static GraphicsProfile _currentGraphicsProfile = _selectedGraphicsProfile;

	private static WorldPreparationState _worldPreparationState = WorldPreparationState.AwaitingData;

	private static UnifiedRandom _drawRand = new UnifiedRandom();

	public static float temporaryGUIScaleSlider = -1f;

	public static bool temporaryGUIScaleSliderUpdate = false;

	public static bool InGuideCraftMenu;

	public static bool InReforgeMenu;

	private static int reforgeCooldown = 0;

	public static Item HoverItem = new Item();

	private static int backSpaceCount;

	private static float backSpaceRate;

	private static bool imeCompositionActive;

	public static Microsoft.Xna.Framework.Color imeCompositionStringColor = new Microsoft.Xna.Framework.Color(255, 240, 20);

	private static IMEPanelAnchor? imePanelAnchor = null;

	public static string motd = "";

	public static bool toggleFullscreen;

	public static int numDisplayModes;

	public static int[] displayWidth = new int[99];

	public static int[] displayHeight = new int[99];

	public static bool gameMenu = true;

	public static bool menuChat = false;

	public static bool menuBGChangedDay = false;

	public static bool menuBGChangedNight = false;

	public static bool lockMenuBGChange = false;

	private static int maxLoadPlayer = 1000;

	private static int maxLoadWorld = 1000;

	public static List<PlayerFileData> PlayerList = new List<PlayerFileData>();

	public static PlayerFileData ActivePlayerFileData = new PlayerFileData();

	public static Player PendingPlayer = null;

	public static List<WorldFileData> WorldList = new List<WorldFileData>();

	public static WorldFileData ActiveWorldFileData = new WorldFileData();

	public static string WorldPath = Path.Combine(SavePath, "Worlds");

	public static string CloudWorldPath = "worlds";

	public static string PlayerPath = Path.Combine(SavePath, "Players");

	public static string CloudPlayerPath = "players";

	public static Preferences Configuration = new Preferences(SavePath + Path.DirectorySeparatorChar + "config.json");

	public static Preferences InputProfiles = new Preferences(SavePath + Path.DirectorySeparatorChar + "input profiles.json");

	public static KeyboardState inputText;

	public static KeyboardState oldInputText;

	public static int PendingResolutionWidth = 800;

	public static int PendingResolutionHeight = 600;

	public static bool PendingBorderlessState;

	public static int invasionType;

	public static double invasionX;

	public static int invasionSize;

	public static int invasionDelay;

	public static int invasionWarn;

	public static int invasionSizeStart;

	public static bool invasionProgressNearInvasion;

	public static int invasionProgressMode = 2;

	public static int invasionProgressIcon;

	public static int invasionProgress;

	public static int invasionProgressMax;

	public static int invasionProgressWave;

	public static int invasionProgressDisplayLeft;

	public static float invasionProgressAlpha;

	public static bool HasInteractibleObjectThatIsNotATile = false;

	public int currentNPCShowingChatBubble = -1;

	public static int[] npcFrameCount = new int[697]
	{
		1, 2, 2, 3, 6, 2, 2, 1, 1, 1,
		1, 1, 1, 1, 1, 1, 2, 25, 23, 25,
		21, 15, 26, 2, 10, 1, 16, 16, 16, 3,
		1, 15, 6, 1, 3, 2, 2, 21, 25, 1,
		1, 1, 3, 3, 15, 3, 7, 7, 6, 5,
		6, 5, 3, 3, 23, 6, 3, 6, 6, 2,
		5, 6, 5, 7, 7, 4, 5, 8, 1, 5,
		1, 2, 4, 16, 5, 4, 4, 15, 16, 16,
		16, 2, 4, 6, 6, 18, 16, 1, 1, 1,
		1, 1, 1, 4, 3, 1, 1, 1, 1, 1,
		1, 5, 6, 7, 16, 1, 1, 25, 23, 12,
		20, 21, 1, 2, 2, 3, 6, 1, 1, 1,
		15, 4, 11, 1, 23, 6, 6, 6, 1, 2,
		2, 1, 3, 4, 1, 2, 1, 4, 2, 1,
		15, 3, 25, 4, 5, 7, 3, 2, 12, 12,
		4, 4, 4, 8, 8, 13, 5, 6, 4, 15,
		23, 3, 15, 8, 5, 4, 13, 15, 12, 4,
		14, 14, 3, 2, 5, 3, 2, 3, 23, 5,
		14, 16, 5, 2, 2, 12, 3, 3, 3, 3,
		2, 2, 2, 2, 2, 7, 14, 15, 16, 8,
		3, 15, 15, 16, 2, 3, 20, 25, 23, 26,
		4, 4, 16, 16, 20, 20, 20, 2, 2, 2,
		2, 8, 12, 3, 4, 2, 4, 25, 26, 26,
		6, 3, 3, 3, 3, 3, 5, 4, 4, 5,
		4, 6, 7, 15, 4, 7, 6, 1, 1, 2,
		4, 3, 5, 3, 3, 3, 4, 5, 6, 4,
		2, 1, 8, 4, 4, 1, 8, 1, 4, 15,
		15, 15, 15, 15, 15, 16, 15, 15, 15, 15,
		15, 3, 3, 3, 3, 3, 3, 16, 3, 6,
		12, 21, 21, 20, 16, 15, 15, 5, 5, 6,
		6, 5, 2, 7, 2, 6, 6, 6, 6, 6,
		15, 15, 15, 15, 15, 11, 4, 2, 2, 3,
		3, 3, 16, 15, 16, 10, 14, 12, 1, 10,
		8, 3, 3, 2, 2, 2, 2, 7, 15, 15,
		15, 6, 3, 10, 10, 6, 9, 8, 9, 8,
		20, 10, 6, 23, 1, 4, 24, 2, 4, 6,
		6, 13, 15, 15, 15, 15, 4, 4, 26, 23,
		8, 2, 4, 4, 4, 4, 2, 2, 4, 12,
		12, 9, 9, 9, 1, 9, 11, 2, 2, 9,
		5, 6, 4, 18, 8, 11, 1, 4, 5, 8,
		4, 1, 1, 1, 1, 4, 2, 5, 4, 11,
		5, 11, 1, 1, 1, 10, 10, 15, 8, 17,
		6, 6, 1, 12, 12, 13, 15, 9, 5, 10,
		7, 7, 7, 7, 7, 7, 7, 4, 4, 16,
		16, 25, 5, 7, 3, 13, 2, 6, 2, 19,
		19, 19, 20, 26, 3, 1, 1, 1, 1, 1,
		16, 21, 9, 16, 7, 6, 18, 13, 20, 12,
		12, 20, 6, 14, 14, 14, 14, 6, 1, 3,
		25, 19, 20, 22, 2, 4, 4, 4, 11, 9,
		8, 1, 9, 1, 8, 8, 12, 12, 11, 11,
		11, 11, 11, 11, 11, 11, 11, 1, 6, 9,
		1, 1, 1, 1, 1, 1, 4, 1, 10, 1,
		8, 4, 1, 5, 8, 8, 8, 8, 9, 9,
		5, 4, 8, 16, 8, 2, 3, 3, 6, 6,
		7, 13, 4, 4, 4, 4, 1, 1, 1, 8,
		25, 11, 14, 14, 14, 17, 17, 17, 5, 5,
		5, 14, 14, 14, 9, 9, 9, 9, 17, 17,
		16, 16, 18, 18, 10, 10, 10, 10, 4, 1,
		6, 9, 6, 4, 4, 4, 14, 4, 25, 13,
		3, 7, 6, 6, 1, 4, 4, 4, 4, 4,
		4, 4, 15, 15, 8, 8, 2, 6, 15, 15,
		6, 13, 5, 5, 7, 5, 14, 14, 4, 6,
		21, 1, 1, 1, 11, 12, 6, 6, 17, 6,
		16, 21, 16, 23, 5, 16, 2, 28, 28, 6,
		6, 6, 6, 6, 6, 6, 7, 7, 7, 7,
		7, 7, 7, 3, 4, 6, 27, 16, 2, 2,
		4, 3, 4, 23, 6, 1, 1, 2, 8, 8,
		14, 6, 6, 6, 6, 6, 2, 4, 14, 14,
		14, 14, 14, 14, 14, 1, 1, 13, 6, 13,
		1, 3, 16, 3, 30, 3, 1
	};

	public static Dictionary<int, byte> npcLifeBytes = new Dictionary<int, byte>();

	public static bool mouseExit;

	public static float exitScale = 0.8f;

	public static bool mouseReforge;

	public static float reforgeScale = 0.8f;

	public static Player clientPlayer = new Player();

	public static string getIP = defaultIP;

	public static string getPort = Convert.ToString(Netplay.ListenPort);

	public static bool menuMultiplayer;

	public static bool menuServer;

	public static int netMode;

	private static int _targetNetMode;

	private static bool _hasPendingNetmodeChange;

	public const int MaxTimeout = 120;

	public static int netPlayCounter;

	public static int lastNPCUpdate;

	public static int lastItemUpdate;

	public static int maxNPCUpdates = 5;

	public static int maxItemUpdates = 5;

	public static string cUp = "W";

	public static string cLeft = "A";

	public static string cDown = "S";

	public static string cRight = "D";

	public static string cJump = "Space";

	public static string cThrowItem = "T";

	public static string cHeal = "H";

	public static string cMana = "J";

	public static string cBuff = "B";

	public static string cHook = "E";

	public static string cTorch = "LeftShift";

	public static string cInv = "Escape";

	public static string cSmart = "LeftControl";

	public static string cMount = "R";

	public static string cFavoriteKey = "LeftAlt";

	public static bool cSmartCursorModeIsToggleAndNotHold = true;

	public static bool SmartCursorWanted_Mouse = false;

	public static bool SmartCursorWanted_GamePad = false;

	public static bool SmartCursorShowing = false;

	public static int SmartCursorX;

	public static int SmartCursorY;

	public static bool SmartInteractShowingGenuine;

	public static bool SmartInteractShowingFake;

	public static int SmartInteractX;

	public static int SmartInteractY;

	public static int SmartInteractNPC;

	public static int SmartInteractProj;

	public static bool SmartInteractPotionOfReturn;

	public static List<Microsoft.Xna.Framework.Point> SmartInteractTileCoords = new List<Microsoft.Xna.Framework.Point>();

	public static List<Microsoft.Xna.Framework.Point> SmartInteractTileCoordsSelected = new List<Microsoft.Xna.Framework.Point>();

	public static int TileInteractionLX = -1;

	public static int TileInteractionLY = -1;

	public static int TileInteractionHX = -1;

	public static int TileInteractionHY = -1;

	public static int cursorOverride = -1;

	public static int signHover = -1;

	public static string cMapZoomIn = "Add";

	public static string cMapZoomOut = "Subtract";

	public static string cMapAlphaUp = "PageUp";

	public static string cMapAlphaDown = "PageDown";

	public static string cMapFull = "M";

	public static string cMapStyle = "Tab";

	public static Microsoft.Xna.Framework.Input.Keys FavoriteKey = Microsoft.Xna.Framework.Input.Keys.LeftAlt;

	public static ColorSlidersSet mouseColorSlider = new ColorSlidersSet();

	public static ColorSlidersSet mouseBorderColorSlider = new ColorSlidersSet();

	public static Microsoft.Xna.Framework.Color mouseColor = new Microsoft.Xna.Framework.Color(255, 50, 95);

	public static Microsoft.Xna.Framework.Color cursorColor = Microsoft.Xna.Framework.Color.White;

	public static int cursorColorDirection = 1;

	public static float cursorAlpha;

	public static float cursorScale;

	public static bool signBubble;

	public static int signX = 0;

	public static int signY = 0;

	public static bool hideUI;

	public static bool releaseUI;

	public static FrameSkipMode FrameSkipMode = FrameSkipMode.Subtle;

	public static bool improvedSubtleFrameSkip = true;

	public static bool ThrottleWhenInactive = true;

	public static bool UnpinFromCore0 = false;

	public static bool NoPooling = false;

	public static bool CollectGen0EveryFrame = false;

	private int splashCounter;

	public List<int> DrawCacheNPCsMoonMoon = new List<int>(maxNPCs);

	public List<int> DrawCacheNPCsOverPlayers = new List<int>(maxNPCs);

	public List<int> DrawCacheNPCProjectiles = new List<int>(maxNPCs);

	public List<int> DrawCacheNPCsBehindNonSolidTiles = new List<int>(maxNPCs);

	public List<int> DrawCacheProjsBehindNPCsAndTiles = new List<int>(1000);

	public List<int> DrawCacheProjsBehindNPCs = new List<int>(1000);

	public List<int> DrawCacheProjsBehindProjectiles = new List<int>(1000);

	public List<int> DrawCacheProjsOverWiresUI = new List<int>(1000);

	public List<int> DrawCacheProjsOverPlayers = new List<int>(1000);

	public List<int> DrawCacheFirstFractals = new List<int>(1000);

	public static ParticleRenderer ParticleSystem_World_OverPlayers = new ParticleRenderer();

	public static ParticleRenderer ParticleSystem_World_BehindPlayers = new ParticleRenderer();

	public static ParticleRenderer ParticleSystem_OverInventory = new ParticleRenderer();

	public static ParticleRenderer ParticleSystem_OverCursor = new ParticleRenderer();

	private static WindowStateController _windowMover;

	public static AnchoredEntitiesCollection sittingManager;

	public static AnchoredEntitiesCollection sleepingManager;

	public static MinimapFrameManager MinimapFrameManagerInstance;

	public static PlayerResourceSetsManager ResourceSetsManager;

	private static bool shouldSetDefaultUIScale = true;

	private static float newDefaultUIScale = 0f;

	public static bool IsInTheMiddleOfLoadingSettings;

	public static Microsoft.Xna.Framework.Point LastLoadedResolution;

	public static bool startFullscreen = false;

	public static string oldStatusText = "";

	public static string autoGenFileLocation = null;

	public static bool autoShutdown;

	private uint previousExecutionState;

	public static bool fastForwardTimeToDawn;

	public static int sundialCooldown;

	public static bool fastForwardTimeToDusk;

	public static int moondialCooldown;

	private static Stopwatch splashTimer = new Stopwatch();

	public static GeneralIssueReporter IssueReporter;

	private JArray _lastLoadedPacks;

	public static bool PreventUpdatingTargets = true;

	private IEnumerator _gameContentLoadProcess;

	public static bool _shouldUseWindyDayMusic = false;

	public static bool _shouldUseStormMusic = false;

	private int lastMusicPlayed = -1;

	private bool playOldTile;

	private bool boulderLogo;

	private static TitleMusicStyle titleMusicStyle = TitleMusicStyle.Current;

	private static TitleMusicStyle titleMusicStyleRandom = TitleMusicStyle.Current;

	private static float _minWind = 0.34f;

	private static float _maxWind = 0.4f;

	private static float _minRain = 0.4f;

	private static float _maxRain = 0.5f;

	public static float ambientWaterfallX = -1f;

	public static float ambientWaterfallY = -1f;

	public static float ambientWaterfallStrength = 0f;

	public static float ambientLavafallX = -1f;

	public static float ambientLavafallY = -1f;

	public static float ambientLavafallStrength = 0f;

	public static float ambientLavaX = -1f;

	public static float ambientLavaY = -1f;

	public static float ambientLavaStrength;

	public static int ambientCounter;

	private static bool _isWaterfallMusicPlaying = false;

	private static bool _isLavafallMusicPlaying = false;

	public static IChatMonitor chatMonitor = new RemadeChatMonitor();

	public static int ProjectileUpdateLoopIndex = -1;

	public static readonly double TARGET_FRAME_TIME = 0.01666666753590107;

	public static GameTipsDisplay gameTips;

	private Stopwatch _worldUpdateTimeTester = new Stopwatch();

	public SpelunkerProjectileHelper SpelunkerProjectileHelper = new SpelunkerProjectileHelper();

	public ChumBucketProjectileHelper ChumBucketProjectileHelper = new ChumBucketProjectileHelper();

	public static int weatherVaneBobframe = 0;

	private static int seedMoonGoal = 16200;

	private float logoRotation;

	private float logoRotationDirection = -1f;

	private float logoRotationSpeed = 1f;

	private float logoScale = 1f;

	private float logoScaleDirection = 1f;

	private float logoScaleSpeed = 1f;

	private static int maxMenuItems = 16;

	private float[] menuItemScale = new float[maxMenuItems];

	private int focusMenu = -1;

	private int selectedMenu = -1;

	private int selectedMenu2 = -1;

	public static int selectedPlayer = 0;

	public static int selectedWorld;

	public static int menuMode;

	public static int menuSkip;

	private static bool _needsLanguageSelect = true;

	private static Item tooltipPrefixComparisonItem = new Item();

	private MouseTextCache _mouseTextCache;

	private static Item _mouseTextFakeItem = new Item();

	private static Item _airHoverItem = new Item();

	private const int _mouseTextTooltip_MaxLines = 30;

	private static readonly string[] _mouseTextTooltipLine_Text = new string[30];

	private static readonly Microsoft.Xna.Framework.Color[] _mouseTextTooltipLine_Color = new Microsoft.Xna.Framework.Color[30];

	public int textBlinkerCount;

	public int textBlinkerState;

	public static string newWorldName = "";

	private static Vector3 shimmerShine = new Vector3(1f, 0.5f, 1f);

	private static int[] specX = new int[1000];

	private static int[] specY = new int[1000];

	public TilePaintSystemV2 TilePaintSystem;

	public TileDrawing TilesRenderer;

	public WallDrawing WallsRenderer;

	public IHorizonRenderer HorizonRenderer = new NextHorizonRenderer();

	public static readonly HorizonHelper HorizonHelper = new HorizonHelper();

	private AmbientWindSystem _ambientWindSys = new AmbientWindSystem();

	private List<Player> _playersThatDrawBehindNPCs = new List<Player>(255);

	private List<Player> _playersThatDrawAfterProjectiles = new List<Player>(255);

	private List<DrawData> _voidLensData = new List<DrawData>();

	private List<DrawData> _voidLensDataSillouette = new List<DrawData>();

	private List<DrawData> _voidLensDataSillouette2 = new List<DrawData>();

	private static BlendState _multiplyBlendState = null;

	private static StardewValleyAnimation _stardewAnimation;

	private static UnifiedRandom _tempSeededRandom = new UnifiedRandom();

	private TextDisplayCache _textDisplayCache = new TextDisplayCache();

	private NPCChatPanel _newChatPanel = new NPCChatPanel();

	private static NPC _portraitDummy = new NPC();

	private static RasterizerState ScissorState = new RasterizerState
	{
		CullMode = CullMode.None,
		ScissorTestEnable = true
	};

	public static DialoguePortraitDrawOption DialoguePortraitPreference = DialoguePortraitDrawOption.Detailed;

	private List<int> _occupantsListToDrawNPCHouses = new List<int>();

	private List<int> _npcsWithBannersToDraw = new List<int>();

	private bool _imeToggle;

	private static int shopHappinessTextOffsetX = 26;

	private static int shopHappinessTextOffsetY = 98;

	private static int shopHappinessIconOffsetX = 12;

	private static int shopHappinessIconOffsetY = 108;

	private List<int> _npcTypesThatAlreadyDrewAHead = new List<int>();

	private int[] _npcIndexWhoHoldsHeadIndex = new int[NPCHeadID.Count];

	private static List<string> _requiredObjecsForCraftingText = new List<string>();

	public static bool _preventCraftingBecauseClickWasUsedToChangeFocusedRecipe;

	private static int _currentRecipeBeingCrafted = -1;

	private static bool hidePVPAndTeamIcons = false;

	public static bool HoveringOverAnNPC;

	public static string hoverItemName = "";

	public static Microsoft.Xna.Framework.Color inventoryBack = new Microsoft.Xna.Framework.Color(220, 220, 220, 220);

	public static bool mouseText;

	private static int mH;

	private static int rare;

	public static int hairStart;

	private static int oldHairStyle;

	private static Microsoft.Xna.Framework.Color oldHairColor;

	public static int selClothes;

	private static Microsoft.Xna.Framework.Color[] oldClothesColor = new Microsoft.Xna.Framework.Color[6];

	private static int oldClothesStyle;

	private static int oldVoiceStyle;

	public static float oldVoicePitch;

	public static int interactedDresserTopLeftX;

	public static int interactedDresserTopLeftY;

	public static Player dresserInterfaceDummy;

	public static bool WasDraggingPlayerAudio;

	private bool _needToSetupDrawInterfaceLayers = true;

	private List<GameInterfaceLayer> _gameInterfaceLayers;

	private static GameTime _drawInterfaceGameTime;

	public static bool DoGlowingMouseItemDraw;

	private byte instrumentMouseFixHack;

	private static bool _settingsButtonIsPushedToSide;

	private static Vector2 _itemIconCacheScreenPosition;

	private static int _itemIconCacheSelectedItemID;

	private static int _itemIconCacheTime;

	private static readonly Microsoft.Xna.Framework.Point[] SmartCursorDirectionLocks = new Microsoft.Xna.Framework.Point[8]
	{
		new Microsoft.Xna.Framework.Point(0, -1),
		new Microsoft.Xna.Framework.Point(1, -1),
		new Microsoft.Xna.Framework.Point(1, 0),
		new Microsoft.Xna.Framework.Point(1, 1),
		new Microsoft.Xna.Framework.Point(0, 1),
		new Microsoft.Xna.Framework.Point(-1, 1),
		new Microsoft.Xna.Framework.Point(-1, 0),
		new Microsoft.Xna.Framework.Point(-1, -1)
	};

	private static bool _cannotDrawAccessoriesHorizontally = false;

	public static Microsoft.Xna.Framework.Color selColor = Microsoft.Xna.Framework.Color.White;

	public static int focusColor;

	public static int colorDelay;

	public static int setKey = -1;

	public static int bgScroll;

	public static bool autoPass;

	public static int menuFocus = 0;

	public static float hBar = -1f;

	public static float sBar = -1f;

	public static float lBar = 1f;

	public static float aBar = 1f;

	private int grabColorSlider;

	public static bool blockMouse;

	private static bool _blockFancyUIWhileLoading;

	private bool[] menuWide = new bool[100];

	public static float GamepadCursorAlpha = 0f;

	private bool _needsMenuUIRecalculation;

	public static float MenuXMovement = 0f;

	public RejectionMenuInfo RejectionMenuInfo;

	private float _splashFrameCount;

	private bool quickSplash;

	private float hellBlackBoxBottom;

	private Microsoft.Xna.Framework.Color[] _drawbackground_colorSlices = new Microsoft.Xna.Framework.Color[9];

	private int[] _drawBackground_backTexture = new int[7];

	private int[] _drawBackground_oldBackTexture = new int[7];

	private int[] _drawBackground_tempBack = new int[7];

	public static float InitialMapScale = 1f;

	public static float MapScale = 1f;

	private static int _minimapTopRightAnchorOffsetTowardsLeft = 52;

	private static int _minimapTopRightAnchorOffsetTowardsBottom = 90;

	public static bool cancelWormHole = false;

	private static VertexColors _glowPaintColors = new VertexColors(Microsoft.Xna.Framework.Color.White);

	protected List<Tuple<int, int, ushort>> DrawWiresSpecialTiles = new List<Tuple<int, int, ushort>>();

	public static float lightning;

	private static float lightningDecay = 1f;

	private static float lightningSpeed = 0f;

	private static int thunderDelay;

	public static int thunderDistance;

	public static bool thunderSkipSound;

	public static SpriteBatchBeginner LatestSurfaceBackgroundBeginner;

	private static float backgroundLayerTransitionSpeed = 0.05f;

	public static float atmo;

	private static float bgScale = 1f;

	private static int bgWidthScaled = (int)(1024f * bgScale);

	public static Microsoft.Xna.Framework.Color ColorOfTheSkies;

	public static Microsoft.Xna.Framework.Color ColorOfSurfaceBackgroundsBase = Microsoft.Xna.Framework.Color.White;

	public static Microsoft.Xna.Framework.Color ColorOfSurfaceBackgroundsModified = Microsoft.Xna.Framework.Color.White;

	private float scAdj;

	private static int _rainbowBoulderMusicFramesCounter;

	private static bool _finishedRainbowBoulderStart;

	private bool _isDrawingOrUpdating;

	private long presentTimestamp;

	public static List<INeedRenderTargetContent> ContentThatNeedsRenderTargets = new List<INeedRenderTargetContent>();

	private bool _resetContentThatNeedsRenderTargetsNextFrame;

	public static bool disableDontStarveDarknessDamage = false;

	public CameraModifierStack CameraModifiers = new CameraModifierStack();

	public static bool starGame = false;

	public static int starsHit = 0;

	public static Vector2 LastCelestialBodyPosition;

	private static string _oldNetplayStatusText;

	private static TextSnippet[] _netplayStatusTextSnippets;

	public static int ladyBugRainBoost = 0;

	private static bool _canShowMeteorFall;

	private static bool _isResizingAndRemakingTargets = false;

	public static bool CanUpdateGameplay { get; private set; }

	public static Matrix UIScaleMatrix => _uiScaleMatrix;

	public static float UIScaleWanted => _uiScaleWanted;

	public static float UIScale
	{
		get
		{
			return _uiScaleUsed;
		}
		set
		{
			_uiScaleWanted = value;
			float uIScaleMax = instance.UIScaleMax;
			if (value > uIScaleMax)
			{
				value = uIScaleMax;
			}
			_uiScaleUsed = value;
			_uiScaleMatrix = Matrix.CreateScale(value, value, 1f);
		}
	}

	public float UIScaleMax
	{
		get
		{
			int realScreenWidth = PlayerInput.RealScreenWidth;
			float val = Math.Min(val2: (float)PlayerInput.RealScreenHeight / 600f, val1: (float)realScreenWidth / 800f);
			return Math.Max(1f, val);
		}
	}

	public static bool RenderTargetsRequired
	{
		get
		{
			if (!(GameZoomTarget > 1f))
			{
				return GameViewMatrix.TransformationMatrix.M11 > 1f;
			}
			return true;
		}
	}

	public static bool IsItRaining => cloudAlpha > 0f;

	public static bool ThickMouse => MouseBorderColor != Microsoft.Xna.Framework.Color.Transparent;

	public static bool GamepadDisableCursorItemIcon
	{
		get
		{
			if (PlayerInput.UsingGamepad)
			{
				return GamepadDisableCursorItemIconInner;
			}
			return false;
		}
	}

	public static string SavePath => Program.SavePath;

	public static int GameMode
	{
		get
		{
			if (ActiveWorldFileData == null)
			{
				return 0;
			}
			return ActiveWorldFileData.GameMode;
		}
		set
		{
			if (ActiveWorldFileData != null && GameModeID.IsValid(value))
			{
				ActiveWorldFileData.GameMode = value;
			}
		}
	}

	public static bool IsJourneyMode => GameMode == 3;

	public static bool surviveHardcoreDeath
	{
		get
		{
			if (dontStarveWorld && tenthAnniversaryWorld)
			{
				return !getGoodWorld;
			}
			return false;
		}
	}

	public static bool specialSeedWorld
	{
		get
		{
			if (!drunkWorld && !getGoodWorld && !tenthAnniversaryWorld && !notTheBeesWorld && !dontStarveWorld && !remixWorld && !noTrapsWorld && !zenithWorld)
			{
				return skyblockWorld;
			}
			return true;
		}
	}

	public static bool onlyDontStarveWorld
	{
		get
		{
			if (dontStarveWorld && !drunkWorld && !getGoodWorld && !tenthAnniversaryWorld && !notTheBeesWorld && !remixWorld && !noTrapsWorld && !zenithWorld)
			{
				return !skyblockWorld;
			}
			return false;
		}
	}

	public static bool onlyShimmerOceanWorlds
	{
		get
		{
			if (drunkWorld && tenthAnniversaryWorld && !remixWorld && !zenithWorld)
			{
				return !notTheBeesWorld;
			}
			return false;
		}
	}

	public static bool onlyShimmerOceanWorldsGeneration
	{
		get
		{
			if (WorldGen.drunkWorldGen && WorldGen.tenthAnniversaryWorldGen && !WorldGen.remixWorldGen && !WorldGen.everythingWorldGen)
			{
				return !WorldGen.notTheBees;
			}
			return false;
		}
	}

	public static bool masterMode => Difficulty >= GameDifficultyLevel.Master;

	public static bool expertMode => Difficulty >= GameDifficultyLevel.Expert;

	public static float Difficulty
	{
		get
		{
			float num = GameDifficultyLevel.Classic;
			if (ActiveWorldFileData != null)
			{
				if (_gameModeDifficultyOverride.HasValue)
				{
					num = _gameModeDifficultyOverride.Value;
				}
				else if (GameMode == 1)
				{
					num = GameDifficultyLevel.Expert;
				}
				else if (GameMode == 2)
				{
					num = GameDifficultyLevel.Master;
				}
				if (getGoodWorld)
				{
					num += 1f;
				}
			}
			return num;
		}
	}

	public static AchievementManager Achievements => instance._achievements;

	public static AchievementAdvisor AchievementAdvisor => instance._achievementAdvisor;

	public static ulong UnpausedUpdateSeed { get; private set; }

	public static Effect screenShader => ScreenShaderRef.Value;

	public static Effect pixelShader => PixelShaderRef.Value;

	public static Effect tileShader => TileShaderRef.Value;

	[Old("Transform is deprecated. Please use GameViewMatrix & GUIViewMatrix")]
	public static Matrix Transform => GameViewMatrix.TransformationMatrix;

	public static Vector2 MouseScreen => new Vector2(mouseX, mouseY);

	public static Vector2 MouseWorld
	{
		get
		{
			Vector2 result = MouseScreen + screenPosition;
			if (player[myPlayer].gravDir == -1f)
			{
				result.Y = screenPosition.Y + (float)screenHeight - (float)mouseY;
			}
			return result;
		}
	}

	public static INetDiagnosticsUI ActiveNetDiagnosticsUI
	{
		get
		{
			if (_activeNetDiagnosticsUI == null)
			{
				INetDiagnosticsUI activeNetDiagnosticsUI;
				if (!dedServ)
				{
					INetDiagnosticsUI netDiagnosticsUI = new NetDiagnosticsUI();
					activeNetDiagnosticsUI = netDiagnosticsUI;
				}
				else
				{
					INetDiagnosticsUI netDiagnosticsUI = new EmptyDiagnosticsUI();
					activeNetDiagnosticsUI = netDiagnosticsUI;
				}
				_activeNetDiagnosticsUI = activeNetDiagnosticsUI;
			}
			return _activeNetDiagnosticsUI;
		}
	}

	public static uint GameUpdateCount => _gameUpdateCount;

	public static SamplerState DefaultSamplerState
	{
		get
		{
			if (!drawToScreen)
			{
				return SamplerState.PointClamp;
			}
			return SamplerState.LinearClamp;
		}
	}

	public static int worldID => ActiveWorldFileData.WorldId;

	public static bool isThereAWorldSurface => worldSurface > 50.0;

	public static int UnderworldLayer => maxTilesY - 200;

	public static int HorizonPhase
	{
		get
		{
			int num = moonPhase;
			if (dayTime && time < 27000.0)
			{
				num--;
			}
			if (num < 0)
			{
				num += 8;
			}
			return num;
		}
	}

	public static SceneMetrics PlayerSceneMetrics => _playerSceneMetrics;

	public static SceneMetrics SceneMetrics
	{
		get
		{
			if (!_usingSeparateCameraSceneMetrics)
			{
				return _playerSceneMetrics;
			}
			return _cameraSceneMetrics;
		}
	}

	public static float WindForVisuals => windSpeedCurrent;

	public static int ChatLineWidthLimit => (int)((float)screenWidth * (1f / UIScale)) - 320;

	public static Player LocalPlayer => player[myPlayer];

	public static CreativeUnlocksTracker LocalPlayerCreativeTracker => player[myPlayer].creativeTracker;

	public static int npcShop { get; private set; }

	public static bool InPipCrafting
	{
		get
		{
			if (PipsCurrentPage != PipPage.Recipes)
			{
				return InGuideCraftMenu;
			}
			return true;
		}
	}

	public static bool InPipBanner
	{
		get
		{
			if (PipsCurrentPage == PipPage.Banners)
			{
				return !InGuideCraftMenu;
			}
			return false;
		}
	}

	public static string playerPathName => ActivePlayerFileData.Path;

	public static string worldPathName => ActiveWorldFileData.Path;

	public static bool HoveringAnInteractable
	{
		get
		{
			if (!HoveringOverAnNPC && !SmartInteractShowingGenuine)
			{
				return HasInteractibleObjectThatIsNotATile;
			}
			return true;
		}
	}

	public static bool SmartCursorWanted
	{
		get
		{
			if (PlayerInput.SteamDeckIsUsed && PlayerInput.SettingsForUI.CurrentCursorMode == CursorMode.Mouse)
			{
				return SmartCursorWanted_Mouse;
			}
			if (PlayerInput.UsingGamepad)
			{
				return SmartCursorWanted_GamePad;
			}
			return SmartCursorWanted_Mouse;
		}
	}

	public static bool SmartCursorIsUsed => SmartCursorWanted;

	public static bool HasSmartInteractTarget
	{
		get
		{
			if (SmartInteractNPC == -1 && (SmartInteractX == -1 || SmartInteractY == -1))
			{
				return SmartInteractProj != -1;
			}
			return true;
		}
	}

	public static bool IsItAHappyWindyDay => _shouldUseWindyDayMusic;

	public static bool IsItStorming => _shouldUseStormMusic;

	public static bool WindyEnoughForKiteDrops => Math.Abs(windSpeedTarget) >= _maxWind;

	public static bool ShouldPVPDraw => netMode == 1;

	public static bool ShouldTeamSelectDraw
	{
		get
		{
			if (!ShouldPVPDraw)
			{
				return teamBasedSpawnsSeed;
			}
			return true;
		}
	}

	public static bool ChestOrShopUIVisible
	{
		get
		{
			if (NewCraftingUI.Visible || PipsUseGrid)
			{
				return false;
			}
			if (player[myPlayer].chest == -1)
			{
				return npcShop > 0;
			}
			return true;
		}
	}

	public static Item MouseDisplayItem
	{
		get
		{
			if (FakeCursorItem.Item.IsAir)
			{
				return mouseItem;
			}
			return FakeCursorItem.Item;
		}
	}

	public int RecommendedEquipmentAreaPushUp
	{
		get
		{
			if (player[myPlayer].CanDemonHeartAccessoryBeShown())
			{
				return 610 + PlayerInput.SettingsForUI.PushEquipmentAreaUp.ToInt() * 30;
			}
			return 600;
		}
	}

	public static bool ShouldDrawInfoIconsHorizontally
	{
		get
		{
			if (_cannotDrawAccessoriesHorizontally)
			{
				return false;
			}
			if (mapStyle == 1 && mapEnabled && screenHeight < 820)
			{
				return false;
			}
			if (mapStyle != 1 && screenWidth < 855)
			{
				return false;
			}
			if (PlayerInput.UsingGamepad)
			{
				return false;
			}
			return true;
		}
	}

	public static bool CanShowInfoAccs
	{
		get
		{
			if (npcChatText == null || npcChatText == "" || player[myPlayer].chest > -1)
			{
				return player[myPlayer].sign < 0;
			}
			return false;
		}
	}

	public static Microsoft.Xna.Framework.Point ScreenSize => new Microsoft.Xna.Framework.Point(screenWidth, screenHeight);

	public static bool ShouldPlayRainbowBoulderMusic => _rainbowBoulderMusicFramesCounter > 0;

	public static bool IsGraphicsDeviceAvailable
	{
		get
		{
			if (!instance.GraphicsDevice.IsDisposed)
			{
				return instance.GraphicsDevice.GraphicsDeviceStatus == GraphicsDeviceStatus.Normal;
			}
			return false;
		}
	}

	public static float BlackFadeDist => Camera.UnscaledSize.Length() / 2f + 100f;

	public static bool IsCameraTrackingObject
	{
		get
		{
			Vector2 trackedPosition;
			float panRate;
			float doubleRateDist;
			return GetObjectTrackingCameraPan(out trackedPosition, out panRate, out doubleRateDist);
		}
	}

	public static bool IsRainingForever => rainTime >= 5184000;

	public static event Action OnEnginePreload;

	public static event Action<Vector2> OnResolutionChanged;

	public static event Action OnEngineLoad;

	public static event Action OnTickForThirdPartySoftwareOnly;

	public static event Action OnTickForInternalCodeOnly;

	public static event Action<GameTime> OnPreDraw;

	public static event Action<GameTime> OnPostDraw;

	public static event Action<Vector2, float> OnPostFullscreenMapDraw;

	public static event Action OnRenderTargetsReleased;

	public static event ResolutionChangeEvent OnRenderTargetsInitialized;

	public static void ToggleGameplayUpdates(bool state)
	{
		CanUpdateGameplay = state;
	}

	public static void FindAnnouncementBoxStatus()
	{
		AnnouncementBoxDisabled = Program.LaunchParameters.ContainsKey("-disableannouncementbox");
		if (Program.LaunchParameters.TryGetValue("-announcementboxrange", out var value) && int.TryParse(value, out var result))
		{
			AnnouncementBoxRange = result;
		}
	}

	public static Microsoft.Xna.Framework.Color GetColorForCurrentDifficulty(bool includeLegendary = true)
	{
		if (includeLegendary && getGoodWorld && masterMode)
		{
			return GetColorForDifficulty(GameDifficultyLevel.Legendary);
		}
		if (masterMode)
		{
			return GetColorForDifficulty(GameDifficultyLevel.Master);
		}
		if (expertMode)
		{
			return GetColorForDifficulty(GameDifficultyLevel.Expert);
		}
		if (IsJourneyMode)
		{
			return GetColorForDifficulty(GameDifficultyLevel.Journey);
		}
		return GetColorForDifficulty(GameDifficultyLevel.Classic);
	}

	public static Microsoft.Xna.Framework.Color GetColorForDifficulty(float gameDifficultyLevel)
	{
		if (gameDifficultyLevel <= GameDifficultyLevel.Journey)
		{
			return creativeModeColor;
		}
		if (gameDifficultyLevel <= GameDifficultyLevel.Classic)
		{
			return Microsoft.Xna.Framework.Color.White;
		}
		if (gameDifficultyLevel <= GameDifficultyLevel.Expert)
		{
			return mcColor;
		}
		if (gameDifficultyLevel <= GameDifficultyLevel.Master)
		{
			return hcColor;
		}
		if (gameDifficultyLevel <= GameDifficultyLevel.Legendary)
		{
			return legendaryModeColor;
		}
		return Microsoft.Xna.Framework.Color.White;
	}

	public static bool CanPlayCreditsRoll()
	{
		if (!gameMenu && LocalPlayer.hasCreditsSceneMusicBox)
		{
			return true;
		}
		if (gameMenu && menuMode == 3000)
		{
			return true;
		}
		return CreditsRollEvent.IsEventOngoing;
	}

	private static void SetCameraLerp(float lerp, int time)
	{
		cameraLerp = lerp;
		cameraLerpTimer = 0;
		cameraLerpTimeToggle = time;
	}

	public static Vector2 ReverseGravitySupport(Vector2 pos, float height = 0f)
	{
		if (player[myPlayer].gravDir != -1f)
		{
			return pos;
		}
		pos.Y = (float)screenHeight - pos.Y - height;
		return pos;
	}

	public static Microsoft.Xna.Framework.Point ReverseGravitySupport(Microsoft.Xna.Framework.Point pos, int height = 0)
	{
		if (player[myPlayer].gravDir != -1f)
		{
			return pos;
		}
		pos.Y = screenHeight - pos.Y - height;
		return pos;
	}

	public static Microsoft.Xna.Framework.Rectangle ReverseGravitySupport(Microsoft.Xna.Framework.Rectangle box)
	{
		if (player[myPlayer].gravDir != -1f)
		{
			return box;
		}
		box.Y = screenHeight - box.Y - box.Height;
		return box;
	}

	public void SetMouseNPC(int index, int type)
	{
		mouseNPCIndex = index;
		mouseNPCType = type;
	}

	public void SetMouseNPC_ToHousingQuery()
	{
		SetMouseNPC(-1, 0);
	}

	[DllImport("User32")]
	private static extern int RemoveMenu(IntPtr hMenu, int nPosition, int wFlags);

	[DllImport("User32")]
	private static extern IntPtr GetSystemMenu(IntPtr hWnd, bool bRevert);

	[DllImport("User32")]
	private static extern int GetMenuItemCount(IntPtr hWnd);

	[DllImport("kernel32.dll")]
	public static extern IntPtr LoadLibrary(string dllToLoad);

	public static MoonPhase GetMoonPhase()
	{
		return (MoonPhase)moonPhase;
	}

	public static void ResetInventoryState()
	{
		allChestStackHover = false;
		inventorySortMouseOver = false;
		bestiaryMouseOver = false;
		emoteMouseOver = false;
		hotbarLockMouseOver = false;
		achievementAdvisorMouseOver = false;
		nearbyCraftingMouseOver = false;
		GridToggleMouseOverCrafting = false;
		GridToggleMouseOverBanners = false;
		CreativeMenuMouseOver = false;
		infoAccMouseOver = -1;
		toggleAccMouseOver = -1;
		equipPageMouseOver = -1;
		loadoutMouseOver = -1;
		mapStyleMouseOver = -1;
		EquipPageSelected = 0;
	}

	public static void DoStatefulTickSound(ref bool flag, bool state)
	{
		if (flag != state)
		{
			flag = state;
			if (flag)
			{
				SoundEngine.PlaySound(12);
			}
		}
	}

	public static void DoStatefulTickSound(ref int flag, int state)
	{
		if (flag != state)
		{
			flag = state;
			if (flag != -1)
			{
				SoundEngine.PlaySound(12);
			}
		}
	}

	public static Vector2 DrawPlayerItemPos(float gravdir, int itemtype)
	{
		float num = 10f;
		GetItemDrawFrame(itemtype, out var _, out var r);
		Vector2 result = r.Size() / 2f;
		switch (itemtype)
		{
		case 95:
			num = 6f;
			result.Y += 2f * gravdir;
			break;
		case 5629:
			num = 4f;
			result.Y -= 2f * gravdir;
			break;
		case 1295:
			num = 4f;
			break;
		case 5464:
			num -= 8f;
			break;
		case 3611:
			num = 2f;
			break;
		case 5495:
			num = -2f;
			break;
		case 3350:
			num = 2f;
			break;
		case 2624:
			num = 4f;
			break;
		case 3018:
			num = 2f;
			break;
		case 3007:
			num = 4f;
			result.Y -= 1f * gravdir;
			break;
		case 3107:
			num = 4f;
			result.Y += 2f * gravdir;
			break;
		case 3008:
			num = -7f;
			result.Y += 2f * gravdir;
			break;
		case 1255:
			num = 6f;
			result.Y += 0f * gravdir;
			break;
		case 2269:
			num = 2f;
			result.Y += 2f * gravdir;
			break;
		case 1265:
			num = -8f;
			result.Y += 4f * gravdir;
			break;
		case 2272:
			num = 0f;
			result.Y += 4f * gravdir;
			break;
		case 3029:
			num = 4f;
			break;
		case 4381:
			num = 4f;
			break;
		case 2796:
			num = -28f;
			result.Y += 2f * gravdir;
			break;
		case 2797:
			num = 0f;
			break;
		case 2610:
			num = 0f;
			break;
		case 2623:
			num = -30f;
			result.Y -= 4f * gravdir;
			break;
		case 3546:
			num = -14f;
			result.Y -= 6f * gravdir;
			break;
		case 1835:
			num = -2f;
			result.Y += 2f * gravdir;
			break;
		default:
			switch (itemtype)
			{
			case 2624:
				num = -4f;
				break;
			case 3859:
				num = -2f;
				break;
			case 2888:
				num = 6f;
				break;
			case 2223:
				num = 2f;
				result.Y -= 2f * gravdir;
				break;
			case 1782:
				num = 0f;
				result.Y += 4f * gravdir;
				break;
			case 1929:
				num = 0f;
				result.Y += 2f * gravdir;
				break;
			case 2270:
				num = -4f;
				break;
			case 1784:
				num = 0f;
				result.Y += 4f * gravdir;
				break;
			case 1000:
				num = 6f;
				result.Y += 0f * gravdir;
				break;
			case 1178:
				num = 4f;
				result.Y += 0f * gravdir;
				break;
			case 1319:
				num = 0f;
				result.Y += 0f * gravdir;
				break;
			case 1297:
				num = -8f;
				result.Y += 0f * gravdir;
				break;
			case 1121:
				num = 6f;
				result.Y -= 2f * gravdir;
				break;
			case 1314:
				num = 2f;
				break;
			case 1258:
				num = 2f;
				result.Y -= 2f * gravdir;
				break;
			case 1155:
				num = -10f;
				result.Y -= 2f * gravdir;
				break;
			case 1156:
				num = -2f;
				break;
			case 4703:
				num = -3f;
				result.Y -= 2f * gravdir;
				break;
			case 5117:
				num = -1f;
				break;
			case 96:
				num = -8f;
				result.Y += 2f * gravdir;
				break;
			case 1870:
				num = -8f;
				result.Y += 2f * gravdir;
				break;
			case 1260:
				num = -8f;
				result.Y += 2f * gravdir;
				break;
			case 1254:
				num = -6f;
				result.Y += 2f * gravdir;
				break;
			case 98:
				num = -5f;
				result.Y -= 2f * gravdir;
				break;
			case 534:
				num = -2f;
				result.Y += 1f * gravdir;
				break;
			case 679:
				num = 0f;
				result.Y += 2f * gravdir;
				break;
			case 964:
				num = 0f;
				result.Y += 0f * gravdir;
				break;
			case 533:
				num = -7f;
				result.Y -= 2f * gravdir;
				break;
			case 1553:
				num = -10f;
				result.Y -= 2f * gravdir;
				break;
			case 506:
				num = 0f;
				result.Y -= 2f * gravdir;
				break;
			case 1910:
				num = 0f;
				result.Y -= 2f * gravdir;
				break;
			case 494:
			case 508:
				num = -2f;
				break;
			case 434:
				num = 0f;
				result.Y -= 2f * gravdir;
				break;
			case 514:
				num = 0f;
				result.Y += 3f * gravdir;
				break;
			case 435:
			case 436:
			case 481:
			case 578:
			case 1187:
			case 1194:
			case 1201:
			case 1229:
				num = -2f;
				result.Y -= 2f * gravdir;
				break;
			case 197:
				num = -5f;
				result.Y += 4f * gravdir;
				break;
			case 4060:
				num = -2f;
				result.Y += 4f * gravdir;
				break;
			case 126:
				num = 4f;
				result.Y += 4f * gravdir;
				break;
			case 800:
				num = 4f;
				result.Y += 2f * gravdir;
				break;
			case 127:
				num = 4f;
				result.Y += 2f * gravdir;
				break;
			case 157:
				num = 6f;
				result.Y += 2f * gravdir;
				break;
			case 160:
				num = -8f;
				break;
			case 164:
			case 219:
				num = 0f;
				result.Y += 2f * gravdir;
				break;
			case 165:
			case 272:
				num = 4f;
				result.Y += 4f * gravdir;
				break;
			case 3870:
				num = 4f;
				result.Y += 4f * gravdir;
				break;
			case 266:
				num = 0f;
				result.Y += 2f * gravdir;
				break;
			case 281:
				num = 6f;
				result.Y -= 6f * gravdir;
				break;
			case 986:
				num = 6f;
				result.Y -= 10f * gravdir;
				break;
			case 682:
				num = 4f;
				break;
			case 4953:
				num = -4f;
				break;
			case 758:
				num -= 20f;
				result.Y += 0f * gravdir;
				break;
			case 759:
				num -= 18f;
				result.Y += 2f * gravdir;
				break;
			case 5460:
				num -= 10f;
				result.Y += -6f * gravdir;
				break;
			case 760:
				num -= 12f;
				result.Y += 2f * gravdir;
				break;
			case 1946:
				num -= 12f;
				result.Y += 2f * gravdir;
				break;
			case 779:
				num = 0f;
				result.Y += 2f * gravdir;
				break;
			case 5134:
				num = 0f;
				result.Y += 2f * gravdir;
				break;
			case 905:
				num = -5f;
				result.Y += 0f * gravdir;
				break;
			case 930:
				num = 4f;
				result.Y += 2f * gravdir;
				break;
			case 3788:
				num = 2f;
				result.Y += 2f * gravdir;
				break;
			case 5668:
				num = -13f;
				break;
			}
			break;
		}
		result.X = num;
		return result;
	}

	public static void SetupTileMerge()
	{
		int count = TileID.Count;
		tileMerge = new bool[count][];
		for (int i = 0; i < tileMerge.Length; i++)
		{
			tileMerge[i] = new bool[count];
		}
		for (int j = 0; j < TileID.Count; j++)
		{
			bool flag = j == 10 || j == 387 || j == 541;
			TileID.Sets.BlockMergesWithMergeAllBlock[j] = !flag && tileSolid[j] && !tileSolidTop[j];
		}
		for (int k = 0; k < 6; k++)
		{
			int num = ((k == 0) ? 426 : (429 + k));
			int num2 = 727 + k;
			tileMerge[num][num2] = (tileMerge[num2][num] = true);
		}
	}

	public static void RegisterItemAnimation(int index, DrawAnimation animation)
	{
		if (!itemAnimationsRegistered.Contains(index))
		{
			itemAnimationsRegistered.Add(index);
		}
		itemAnimations[index] = animation;
	}

	public static void InitializeItemAnimations()
	{
		for (int i = 0; i < itemAnimations.Length; i++)
		{
			itemAnimations[i] = null;
		}
		itemAnimationsRegistered.Clear();
		RegisterItemAnimation(3581, new DrawAnimationVertical(4, 4));
		RegisterItemAnimation(3580, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(75, new DrawAnimationVertical(5, 8)
		{
			PingPong = true
		});
		RegisterItemAnimation(575, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(547, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(520, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(548, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(521, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(549, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(3453, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(3454, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(3455, new DrawAnimationVertical(6, 4));
		RegisterItemAnimation(4068, new DrawAnimationVertical(6, 4)
		{
			NotActuallyAnimating = true
		});
		RegisterItemAnimation(4069, new DrawAnimationVertical(6, 4)
		{
			NotActuallyAnimating = true
		});
		RegisterItemAnimation(4070, new DrawAnimationVertical(6, 4)
		{
			NotActuallyAnimating = true
		});
		for (int j = 0; j < ItemID.Sets.IsFood.Length; j++)
		{
			if (ItemID.Sets.IsFood[j])
			{
				RegisterItemAnimation(j, new DrawAnimationVertical(int.MaxValue, 3));
			}
		}
		RegisterItemAnimation(5644, new DrawAnimationScryingOrb
		{
			TicksPerFrame = 7,
			FrameCount = 9
		});
	}

	public static bool TryChangePipsPage(PipPage mode)
	{
		if (PipsCurrentPage == mode)
		{
			return false;
		}
		PipsCurrentPage = mode;
		PipsUseGrid = false;
		return true;
	}

	public static void SetGraphicsProfile(GraphicsProfile profile, bool forceSet)
	{
		if (_currentGraphicsProfile != profile || forceSet)
		{
			_selectedGraphicsProfile = profile;
			SetGraphicsProfileInternal();
		}
	}

	private static void SetGraphicsProfileInternal()
	{
		_currentGraphicsProfile = _selectedGraphicsProfile;
		graphics.GraphicsProfile = _selectedGraphicsProfile;
		switch (_selectedGraphicsProfile)
		{
		case GraphicsProfile.HiDef:
			maxScreenW = 4096;
			maxScreenH = 4096;
			_renderTargetMaxSize = 4096;
			TrySupporting8K();
			break;
		case GraphicsProfile.Reach:
			maxScreenW = MaxWorldViewSize.X;
			maxScreenH = MaxWorldViewSize.Y;
			_renderTargetMaxSize = 2048;
			break;
		}
		try
		{
			graphics.ApplyChanges();
		}
		catch (NoSuitableGraphicsDeviceException)
		{
			if (_currentGraphicsProfile == GraphicsProfile.HiDef)
			{
				_selectedGraphicsProfile = GraphicsProfile.Reach;
				SetGraphicsProfileInternal();
			}
		}
		instance.EnsureRenderTargetContent();
	}

	private static void TrySupporting8K()
	{
		if (!Platform.IsWindows)
		{
			return;
		}
		instance.ReleaseTargets();
		Type type = Assembly.GetAssembly(typeof(GraphicsProfile)).GetType("Microsoft.Xna.Framework.Graphics.ProfileCapabilities", throwOnError: true);
		if (type != null)
		{
			FieldInfo field = type.GetField("MaxTextureSize", BindingFlags.Instance | BindingFlags.NonPublic);
			FieldInfo field2 = type.GetField("HiDef", BindingFlags.Static | BindingFlags.NonPublic);
			if (field != null && field2 != null)
			{
				field.SetValue(field2.GetValue(null), 8192);
			}
		}
	}

	public static void AnglerQuestSwap()
	{
		if (netMode == 1)
		{
			return;
		}
		anglerWhoFinishedToday.Clear();
		anglerQuestFinished = false;
		bool flag = NPC.downedBoss1 || NPC.downedBoss2 || NPC.downedBoss3 || hardMode || NPC.downedSlimeKing || NPC.downedQueenBee;
		bool flag2 = true;
		while (flag2)
		{
			flag2 = false;
			anglerQuest = rand.Next(anglerQuestItemNetIDs.Length);
			int num = anglerQuestItemNetIDs[anglerQuest];
			if (num == 2454 && (!hardMode || WorldGen.crimson))
			{
				flag2 = true;
			}
			if (num == 2457 && WorldGen.crimson)
			{
				flag2 = true;
			}
			if (num == 2462 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2463 && (!hardMode || !WorldGen.crimson))
			{
				flag2 = true;
			}
			if (num == 2465 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2468 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2471 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2473 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2477 && !WorldGen.crimson)
			{
				flag2 = true;
			}
			if (num == 2480 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2483 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2484 && !hardMode)
			{
				flag2 = true;
			}
			if (num == 2485 && WorldGen.crimson)
			{
				flag2 = true;
			}
			if ((num == 2476 || num == 2453 || num == 2473) && !flag)
			{
				flag2 = true;
			}
			if (!isThereAWorldSurface)
			{
				if (num == 2476)
				{
					flag2 = true;
				}
				if (num == 2479)
				{
					flag2 = true;
				}
				if (num == 2480)
				{
					flag2 = true;
				}
				if (num == 2452)
				{
					flag2 = true;
				}
				if (num == 2453)
				{
					flag2 = true;
				}
				if (num == 2481)
				{
					flag2 = true;
				}
				if (num == 2483)
				{
					flag2 = true;
				}
				if (num == 2456)
				{
					flag2 = true;
				}
				if (num == 2458)
				{
					flag2 = true;
				}
				if (num == 2459)
				{
					flag2 = true;
				}
				if (num == 2461)
				{
					flag2 = true;
				}
				if (num == 2467)
				{
					flag2 = true;
				}
				if (num == 2468)
				{
					flag2 = true;
				}
				if (num == 2487)
				{
					flag2 = true;
				}
				if (num == 2488)
				{
					flag2 = true;
				}
				if (num == 2470)
				{
					flag2 = true;
				}
				if (num == 2473)
				{
					flag2 = true;
				}
				if (num == 2474)
				{
					flag2 = true;
				}
			}
		}
		NetMessage.SendAnglerQuest(-1);
	}

	public void UpdateParticleSystems_World()
	{
		ParticleSystem_World_OverPlayers.Update();
		ParticleSystem_World_BehindPlayers.Update();
	}

	public void UpdateParticleSystems_UI()
	{
		ParticleSystem_OverInventory.Update();
		ParticleSystem_OverCursor.Update();
	}

	public static void TrySetPreparationState(WorldPreparationState state)
	{
		if (state == WorldPreparationState.ProcessingData)
		{
			_worldPreparationState = state;
		}
	}

	public static void UpdateWorldPreparationState()
	{
		if (netMode != 1)
		{
			_worldPreparationState = WorldPreparationState.Ready;
			return;
		}
		if (netMode == 1 && gameMenu && _worldPreparationState == WorldPreparationState.Ready)
		{
			_worldPreparationState = WorldPreparationState.AwaitingData;
		}
		if (netMode == 1 && _worldPreparationState == WorldPreparationState.ProcessingData)
		{
			_worldPreparationState = WorldPreparationState.Ready;
			gameMenu = false;
			FixUIScale();
			ChatHelper.ShowCachedMessages();
			ChatHelper.ClearDelayedMessagesCache();
		}
	}

	public static bool InSmartCursorHighlightArea(int x, int y, out bool actuallySelected)
	{
		actuallySelected = SmartInteractTileCoordsSelected.Contains(new Microsoft.Xna.Framework.Point(x, y));
		if (hideUI)
		{
			return false;
		}
		if (Collision.InTileBounds(x, y, TileInteractionLX, TileInteractionLY, TileInteractionHX, TileInteractionHY))
		{
			return SmartInteractTileCoords.Contains(new Microsoft.Xna.Framework.Point(x, y));
		}
		return false;
	}

	public static void LoadWorlds()
	{
		WorldList.Clear();
		if (!Utils.TryCreatingDirectory(WorldPath))
		{
			return;
		}
		string[] files = Directory.GetFiles(WorldPath, "*.wld");
		int num = Math.Min(files.Length, maxLoadWorld);
		for (int i = 0; i < num; i++)
		{
			WorldList.Add(WorldFile.GetAllMetadata(files[i], cloudSave: false));
		}
		if (SocialAPI.Cloud != null)
		{
			foreach (string item in from path in SocialAPI.Cloud.GetFiles()
				where path.StartsWith(CloudWorldPath, StringComparison.CurrentCultureIgnoreCase) && path.EndsWith(".wld", StringComparison.CurrentCultureIgnoreCase)
				select path)
			{
				WorldList.Add(WorldFile.GetAllMetadata(item, cloudSave: true));
			}
		}
		WorldList.Sort(WorldListSortMethod);
	}

	private static int WorldListSortMethod(WorldFileData data1, WorldFileData data2)
	{
		if (data1 == null && data2 == null)
		{
			return 0;
		}
		if (data1 == null || data1.Name == null)
		{
			return 1;
		}
		if (data2 == null || data2.Name == null)
		{
			return -1;
		}
		return data1.Name.CompareTo(data2.Name);
	}

	public static void LoadPlayers()
	{
		PlayerList.Clear();
		if (!Utils.TryCreatingDirectory(PlayerPath))
		{
			return;
		}
		string[] files = Directory.GetFiles(PlayerPath, "*.plr");
		int num = Math.Min(maxLoadPlayer, files.Length);
		for (int i = 0; i < num; i++)
		{
			PlayerFileData fileData = Player.GetFileData(files[i], cloudSave: false);
			if (fileData != null)
			{
				PlayerList.Add(fileData);
			}
		}
		if (SocialAPI.Cloud != null)
		{
			foreach (string item in from path in SocialAPI.Cloud.GetFiles()
				where path.StartsWith(CloudPlayerPath, StringComparison.CurrentCultureIgnoreCase) && path.EndsWith(".plr", StringComparison.CurrentCultureIgnoreCase)
				select path)
			{
				PlayerFileData fileData2 = Player.GetFileData(item, cloudSave: true);
				if (fileData2 != null)
				{
					PlayerList.Add(fileData2);
				}
			}
		}
		PlayerList.Sort(PlayerListSortMethod);
	}

	private static int PlayerListSortMethod(PlayerFileData data1, PlayerFileData data2)
	{
		return data1.Name.CompareTo(data2.Name);
	}

	protected void OpenRecent()
	{
		try
		{
			if (!File.Exists(SavePath + Path.DirectorySeparatorChar + "servers.dat"))
			{
				return;
			}
			using FileStream input = new FileStream(SavePath + Path.DirectorySeparatorChar + "servers.dat", FileMode.Open);
			using BinaryReader binaryReader = new BinaryReader(input);
			binaryReader.ReadInt32();
			for (int i = 0; i < 10; i++)
			{
				recentWorld[i] = binaryReader.ReadString();
				recentIP[i] = binaryReader.ReadString();
				recentPort[i] = binaryReader.ReadInt32();
			}
		}
		catch
		{
		}
	}

	public static void SaveRecent()
	{
		Utils.TryCreatingDirectory(SavePath);
		try
		{
			File.SetAttributes(SavePath + Path.DirectorySeparatorChar + "servers.dat", FileAttributes.Normal);
		}
		catch
		{
		}
		try
		{
			using FileStream output = new FileStream(SavePath + Path.DirectorySeparatorChar + "servers.dat", FileMode.Create);
			using BinaryWriter binaryWriter = new BinaryWriter(output);
			binaryWriter.Write(317);
			for (int i = 0; i < 10; i++)
			{
				binaryWriter.Write(recentWorld[i]);
				binaryWriter.Write(recentIP[i]);
				binaryWriter.Write(recentPort[i]);
			}
		}
		catch
		{
		}
	}

	public static bool SaveSettings()
	{
		Preferences configuration = Configuration;
		configuration.Clear();
		configuration.Put("ResetDefaultUIScale", false);
		configuration.Put("SmartCursorToggle", cSmartCursorModeIsToggleAndNotHold);
		configuration.Put("MapEnabled", mapEnabled);
		configuration.Put("InvasionBarMode", invasionProgressMode);
		configuration.Put("AutoSave", autoSave);
		configuration.Put("AutoPause", autoPause);
		configuration.Put("Language", Language.ActiveCulture.Name);
		configuration.Put("PlacementPreview", placementPreview);
		configuration.Put("GoreVisualsAllowed", ChildSafety.Disabled);
		configuration.Put("WorldRollbacksToKeep", WorldRollingBackupsCountToKeep);
		configuration.Put("TeamNameplateDistance", teamNamePlateDistance);
		configuration.Put("MultiplayerNPCSmoothingRange", multiplayerNPCSmoothingRange);
		configuration.Put("VolumeSound", soundVolume);
		configuration.Put("VolumeAmbient", ambientVolume);
		configuration.Put("VolumeMusic", musicVolume);
		configuration.Put("UnlockMusicSwap", TOWMusicUnlocked);
		configuration.Put("UseExperimentalFeatures", UseExperimentalFeatures);
		configuration.Put("KeyFavoriteModifier", cFavoriteKey);
		configuration.Put("Fullscreen", graphics.IsFullScreen);
		configuration.Put("WindowMaximized", screenMaximized);
		configuration.Put("WindowBorderless", screenBorderless);
		configuration.Put("ControllerGlyphs", GlyphTagHandler.GlyphStyle);
		int num = graphics.PreferredBackBufferWidth;
		int num2 = graphics.PreferredBackBufferHeight;
		if (IsInTheMiddleOfLoadingSettings)
		{
			if (LastLoadedResolution.X != 0)
			{
				num = LastLoadedResolution.X;
			}
			if (LastLoadedResolution.Y != 0)
			{
				num2 = LastLoadedResolution.Y;
			}
		}
		configuration.Put("DisplayWidth", num);
		configuration.Put("DisplayHeight", num2);
		configuration.Put("GraphicsQuality", qaStyle);
		configuration.Put("BackgroundEnabled", BackgroundEnabled);
		configuration.Put("FrameSkipMode", FrameSkipMode);
		configuration.Put("LightingMode", Lighting.Mode);
		configuration.Put("BackgroundParallax", bgScroll);
		configuration.Put("ShowItemText", showItemText);
		configuration.Put("LastLaunchedVersion", 317);
		configuration.Put("ClientUUID", clientUUID);
		configuration.Put("UseSmartCursorForCommonBlocks", Player.SmartCursorSettings.SmartBlocksEnabled);
		configuration.Put("UseSmartAxeAfterSmartPickaxe", Player.SmartCursorSettings.SmartAxeAfterPickaxe);
		configuration.Put("SmartCursorHoldCanReleaseMidUse", Player.SmartCursorSettings.SmartCursorHoldCanReleaseMidUse);
		configuration.Put("DisableLeftShiftTrashCan", ItemSlot.Options.DisableLeftShiftTrashCan);
		configuration.Put("DisableQuickTrash", ItemSlot.Options.DisableQuickTrash);
		configuration.Put("HighlightNewItems", ItemSlot.Options.HighlightNewItems);
		configuration.Put("HidePasswords", HidePassword);
		configuration.Put("ReverseUpDownForArmorSetBonuses", ReversedUpDownArmorSetBonuses);
		configuration.Put("MouseShowBuildingGrid", MouseShowBuildingGrid);
		configuration.Put("AllowUnfocusedInputOnGamepad", AllowUnfocusedInputOnGamepad);
		configuration.Put("LockOnPriority", LockOnHelper.UseMode);
		configuration.Put("TitleMusic", titleMusicStyle.ToString());
		configuration.Put("InvisibleCursorForGamepad", InvisibleCursorForGamepad);
		configuration.Put("GamepadDisableInstructionsDisplay", GamepadDisableInstructionsDisplay);
		configuration.Put("SettingsUnlock_WorldEvil", SettingsUnlock_WorldEvil);
		configuration.Put("SettingsEnabled_MinersWobble", SettingsEnabled_MinersWobble);
		configuration.Put("SettingBlockGamepadsEntirely", SettingBlockGamepadsEntirely);
		configuration.Put("SettingsEnabled_OpaqueBoxBehindTooltips", SettingsEnabled_OpaqueBoxBehindTooltips);
		configuration.Put("SettingDontScaleMainMenuUp", SettingDontScaleMainMenuUp);
		configuration.Put("SettingsEnabled_TilesSwayInWind", SettingsEnabled_TilesSwayInWind);
		configuration.Put("SettingsEnabled_AutoReuseAllItems", SettingsEnabled_AutoReuseAllItems);
		configuration.Put("UseStormEffect", UseStormEffects);
		configuration.Put("UseHeatDistortion", UseHeatDistortion);
		configuration.Put("ForegroundSunlightEffects", ForegroundSunlightEffects);
		configuration.Put("WaveQuality", WaveQuality);
		configuration.Put("Support4K", Support4K);
		configuration.Put("MouseColor", new Dictionary<string, byte>
		{
			{ "R", mouseColor.R },
			{ "G", mouseColor.G },
			{ "B", mouseColor.B }
		});
		configuration.Put("MouseBorderColor", new Dictionary<string, byte>
		{
			{ "R", MouseBorderColor.R },
			{ "G", MouseBorderColor.G },
			{ "B", MouseBorderColor.B },
			{ "A", MouseBorderColor.A }
		});
		configuration.Put("QuickLaunch", SkipAssemblyLoad);
		configuration.Put("AssetFileWatcherEnabled", Setting_AssetFileWatcherEnabled);
		configuration.Put("Zoom", GameZoomTarget);
		configuration.Put("UIScale", _uiScaleWanted);
		configuration.Put("MapScale", MapScale);
		configuration.Put("FlashIconForEvents", Enum.GetName(typeof(GameNotificationType), _flashNotificationType));
		configuration.Put("Display", _windowMover.ScreenDeviceName);
		configuration.Put("DisplayScreen", _windowMover.ScreenDeviceName);
		configuration.Put("ThrottleWhenInactive", ThrottleWhenInactive);
		configuration.Put("UnpinFromCore0", UnpinFromCore0);
		configuration.Put("DoorAutoOpeningMode", DoorOpeningHelper.PreferenceSettings);
		configuration.Put("HoverControlMode", Player.Settings.HoverControl);
		configuration.Put("StackToChestsPreferredMode", Player.Settings.StackToChestsPreferredMode);
		configuration.Put("CraftFromNearbyChests", Player.Settings.CraftFromNearbyChests);
		configuration.Put("WaterfallDrawLimit", instance.waterfallManager.maxWaterfallCount);
		configuration.Put("FlashyEffectsWorld", FlashyEffectsWorld);
		configuration.Put("FlashyEffectsInterface", FlashyEffectsInterface);
		configuration.Put("UseScreenShake", UseScreenShake);
		configuration.Put("PortraitPreference", DialoguePortraitPreference);
		configuration.Put("SecretSeeds", SecretSeedsTracker.GetStringsToSave());
		if (Configuration.Save())
		{
			return PlayerInput.Save();
		}
		return false;
	}

	protected void CheckBunny()
	{
		try
		{
			RegistryKey currentUser = Registry.CurrentUser;
			currentUser = currentUser.CreateSubKey("Software\\Terraria");
			if (currentUser != null && currentUser.GetValue("Bunny") != null && currentUser.GetValue("Bunny").ToString() == "1")
			{
				runningCollectorsEdition = true;
			}
		}
		catch
		{
			runningCollectorsEdition = false;
		}
	}

	private static void TryPickingDefaultUIScale(float displayHeight)
	{
		if (shouldSetDefaultUIScale)
		{
			newDefaultUIScale = displayHeight / 1080f * 1.1f;
			shouldSetDefaultUIScale = false;
			Configuration.Put("UIScale", newDefaultUIScale);
			Configuration.Save();
		}
	}

	protected void LoadSettings()
	{
		if (File.Exists(SavePath + Path.DirectorySeparatorChar + "config.dat"))
		{
			OpenLegacySettings();
			if (SaveSettings())
			{
				File.Delete(SavePath + Path.DirectorySeparatorChar + "config.dat");
			}
			return;
		}
		IsInTheMiddleOfLoadingSettings = true;
		Preferences configuration = Configuration;
		configuration.Load();
		int currentValue = 0;
		configuration.Get("LastLaunchedVersion", ref currentValue);
		bool flag = false;
		if (currentValue < 219)
		{
			flag = true;
		}
		if (!flag)
		{
			configuration.Get("ResetDefaultUIScale", ref shouldSetDefaultUIScale);
			configuration.Get("Fullscreen", ref startFullscreen);
			configuration.Get("WindowMaximized", ref screenMaximized);
			configuration.Get("WindowBorderless", ref screenBorderless);
		}
		PendingBorderlessState = screenBorderless;
		screenBorderlessPendingResizes = (screenBorderless ? 6 : 0);
		if (Platform.IsWindows && !dedServ)
		{
			Form form = (Form)Control.FromHandle(instance.Window.Handle);
			if (screenBorderless)
			{
				SetBorderlessFormStyle(form);
			}
			else if (screenMaximized)
			{
				form.FormBorderStyle = FormBorderStyle.Sizable;
				form.WindowState = FormWindowState.Maximized;
			}
			else
			{
				form.FormBorderStyle = FormBorderStyle.Sizable;
			}
			form.BringToFront();
		}
		int currentValue2 = graphics.PreferredBackBufferWidth;
		int currentValue3 = graphics.PreferredBackBufferHeight;
		configuration.Get("DisplayWidth", ref currentValue2);
		configuration.Get("DisplayHeight", ref currentValue3);
		LastLoadedResolution = new Microsoft.Xna.Framework.Point(currentValue2, currentValue3);
		if (!startFullscreen)
		{
			if (PendingBorderlessState)
			{
				screenBorderlessPendingResizes = 1;
			}
			SetDisplayMode(currentValue2, currentValue3, fullscreen: false);
			TryPickingDefaultUIScale(currentValue3);
		}
		configuration.Get("SmartCursorToggle", ref cSmartCursorModeIsToggleAndNotHold);
		configuration.Get("MapEnabled", ref mapEnabled);
		configuration.Get("InvasionBarMode", ref invasionProgressMode);
		configuration.Get("AutoSave", ref autoSave);
		configuration.Get("AutoPause", ref autoPause);
		_needsLanguageSelect = !configuration.Contains("Language");
		string text = configuration.Get("Language", "en-US");
		int result = 0;
		if (int.TryParse(text, out result))
		{
			LanguageManager.Instance.SetLanguage(result);
			SetTitle(initialSetup: true);
		}
		else
		{
			LanguageManager.Instance.SetLanguage(text);
			SetTitle(initialSetup: true);
		}
		configuration.Get("PlacementPreview", ref placementPreview);
		configuration.Get("GoreVisualsAllowed", ref ChildSafety.Disabled);
		configuration.Get("FlashyEffectsWorld", ref FlashyEffectsWorld);
		configuration.Get("FlashyEffectsInterface", ref FlashyEffectsInterface);
		if (!flag)
		{
			configuration.Get("VolumeSound", ref soundVolume);
			configuration.Get("VolumeAmbient", ref ambientVolume);
			configuration.Get("VolumeMusic", ref musicVolume);
		}
		configuration.Get("KeyFavoriteModifier", ref cFavoriteKey);
		if (Enum.TryParse<Microsoft.Xna.Framework.Input.Keys>(cFavoriteKey, out var result2))
		{
			FavoriteKey = result2;
		}
		GlyphTagHandler.GlyphStyle = configuration.Get("ControllerGlyphs", -1);
		if (GlyphTagHandler.GlyphStyle < -1 || GlyphTagHandler.GlyphStyle > 2)
		{
			GlyphTagHandler.GlyphStyle = -1;
		}
		if (!flag)
		{
			configuration.Get("GraphicsQuality", ref qaStyle);
			configuration.Get("BackgroundEnabled", ref BackgroundEnabled);
		}
		if (configuration.GetAllKeys().Contains("FrameSkip"))
		{
			bool currentValue4 = false;
			configuration.Get("FrameSkip", ref currentValue4);
			if (!currentValue4)
			{
				FrameSkipMode = FrameSkipMode.Subtle;
			}
			else
			{
				FrameSkipMode = FrameSkipMode.On;
			}
		}
		int currentValue5 = (int)FrameSkipMode;
		configuration.Get("FrameSkipMode", ref currentValue5);
		if (currentValue5 < 0)
		{
			currentValue5 = 0;
		}
		if (currentValue5 > 2)
		{
			currentValue5 = 2;
		}
		FrameSkipMode = (FrameSkipMode)currentValue5;
		int currentValue6 = (int)Lighting.Mode;
		if (!flag)
		{
			configuration.Get("LightingMode", ref currentValue6);
		}
		Lighting.Mode = (LightMode)currentValue6;
		configuration.Get("UnlockMusicSwap", ref TOWMusicUnlocked);
		configuration.Get("Parallax", ref caveParallax);
		bgScroll = (int)((1f - caveParallax) * 500f);
		configuration.Get("BackgroundParallax", ref bgScroll);
		caveParallax = 1f - (float)bgScroll / 500f;
		configuration.Get("ShowItemText", ref showItemText);
		configuration.Get("ClientUUID", ref clientUUID);
		configuration.Get("UseSmartCursorForCommonBlocks", ref Player.SmartCursorSettings.SmartBlocksEnabled);
		configuration.Get("UseSmartAxeAfterSmartPickaxe", ref Player.SmartCursorSettings.SmartAxeAfterPickaxe);
		configuration.Get("SmartCursorHoldCanReleaseMidUse", ref Player.SmartCursorSettings.SmartCursorHoldCanReleaseMidUse);
		if (!flag)
		{
			configuration.Get("DisableLeftShiftTrashCan", ref ItemSlot.Options.DisableLeftShiftTrashCan);
		}
		if (!flag)
		{
			configuration.Get("DisableQuickTrash", ref ItemSlot.Options.DisableQuickTrash);
		}
		configuration.Get("HidePasswords", ref HidePassword);
		configuration.Get("HighlightNewItems", ref ItemSlot.Options.HighlightNewItems);
		configuration.Get("ReverseUpDownForArmorSetBonuses", ref ReversedUpDownArmorSetBonuses);
		configuration.Get("MouseShowBuildingGrid", ref MouseShowBuildingGrid);
		configuration.Get("AllowUnfocusedInputOnGamepad", ref AllowUnfocusedInputOnGamepad);
		configuration.Get("GamepadDisableInstructionsDisplay", ref GamepadDisableInstructionsDisplay);
		configuration.Get("SettingDontScaleMainMenuUp", ref SettingDontScaleMainMenuUp);
		configuration.Get("WorldRollbacksToKeep", ref WorldRollingBackupsCountToKeep);
		configuration.Get("TeamNameplateDistance", ref teamNamePlateDistance);
		if (currentValue < 230)
		{
			configuration.Get("MultiplayerNPCSmoothingRange", ref multiplayerNPCSmoothingRange);
		}
		configuration.Get("UseStormEffect", ref UseStormEffects);
		configuration.Get("ForegroundSunlightEffects", ref ForegroundSunlightEffects);
		configuration.Get("UseHeatDistortion", ref UseHeatDistortion);
		configuration.Get("WaveQuality", ref WaveQuality);
		if (WaveQuality > 3)
		{
			WaveQuality = 3;
		}
		if (WaveQuality < 0)
		{
			WaveQuality = 0;
		}
		Dictionary<string, byte> currentValue7 = new Dictionary<string, byte>();
		configuration.Get("MouseColor", ref currentValue7);
		if (currentValue7.TryGetValue("R", out var value))
		{
			mouseColor.R = value;
		}
		if (currentValue7.TryGetValue("G", out value))
		{
			mouseColor.G = value;
		}
		if (currentValue7.TryGetValue("B", out value))
		{
			mouseColor.B = value;
		}
		currentValue7.Clear();
		configuration.Get("MouseBorderColor", ref currentValue7);
		if (currentValue7.TryGetValue("R", out value))
		{
			MouseBorderColor.R = value;
		}
		if (currentValue7.TryGetValue("G", out value))
		{
			MouseBorderColor.G = value;
		}
		if (currentValue7.TryGetValue("B", out value))
		{
			MouseBorderColor.B = value;
		}
		if (currentValue7.TryGetValue("A", out value))
		{
			MouseBorderColor.A = value;
		}
		configuration.Get("QuickLaunch", ref SkipAssemblyLoad);
		configuration.Get("AssetFileWatcherEnabled", ref Setting_AssetFileWatcherEnabled);
		if (!flag)
		{
			GameZoomTarget = configuration.Get("Zoom", 1f);
		}
		if (!flag)
		{
			UIScale = configuration.Get("UIScale", Platform.Get<IWindowService>().GetScaling());
		}
		if (newDefaultUIScale > 0f)
		{
			UIScale = newDefaultUIScale;
			newDefaultUIScale = 0f;
		}
		MapScale = MathHelper.Clamp(configuration.Get("MapScale", InitialMapScale), 0.5f, 1f);
		int currentValue8 = -1;
		configuration.Get("LockOnPriority", ref currentValue8);
		if (currentValue8 < 0)
		{
			currentValue8 = 0;
		}
		if (currentValue8 > 2)
		{
			currentValue8 = 2;
		}
		LockOnHelper.UseMode = (LockOnHelper.LockOnMode)currentValue8;
		if (LockOnHelper.UseMode == LockOnHelper.LockOnMode.FocusTarget)
		{
			LockOnHelper.UseMode = LockOnHelper.LockOnMode.ThreeDS;
		}
		if (Enum.TryParse<TitleMusicStyle>(configuration.Get("TitleMusic", "Current"), out var result3))
		{
			titleMusicStyle = result3;
			if (titleMusicStyle == TitleMusicStyle.Random)
			{
				titleMusicStyleRandom = (TitleMusicStyle)new UnifiedRandom((int)DateTime.Now.Ticks).Next(3);
			}
		}
		configuration.Get("InvisibleCursorForGamepad", ref InvisibleCursorForGamepad);
		if (Enum.TryParse<GameNotificationType>(configuration.Get("FlashIconForEvents", "All"), out var result4))
		{
			_flashNotificationType = result4;
		}
		if (!flag)
		{
			string screenDeviceName = configuration.Get("DisplayScreen", "");
			_windowMover.TryMovingToScreen(screenDeviceName);
			ThrottleWhenInactive = configuration.Get("ThrottleWhenInactive", defaultValue: true);
			UnpinFromCore0 = configuration.Get("UnpinFromCore0", defaultValue: false);
			if (UnpinFromCore0 && Platform.IsWindows)
			{
				WindowsPerformanceDiagnostics.UnpinFromCore0();
			}
		}
		if (!flag)
		{
			configuration.Get("Support4K", ref Support4K);
		}
		configuration.Get("UseExperimentalFeatures", ref UseExperimentalFeatures);
		configuration.Get("SettingsUnlock_WorldEvil", ref SettingsUnlock_WorldEvil);
		configuration.Get("SettingsEnabled_MinersWobble", ref SettingsEnabled_MinersWobble);
		configuration.Get("SettingBlockGamepadsEntirely", ref SettingBlockGamepadsEntirely);
		configuration.Get("SettingsEnabled_OpaqueBoxBehindTooltips", ref SettingsEnabled_OpaqueBoxBehindTooltips);
		configuration.Get("SettingsEnabled_TilesSwayInWind", ref SettingsEnabled_TilesSwayInWind);
		configuration.Get("SettingsEnabled_AutoReuseAllItems", ref SettingsEnabled_AutoReuseAllItems);
		configuration.Get("DoorAutoOpeningMode", ref DoorOpeningHelper.PreferenceSettings);
		configuration.Get("HoverControlMode", ref Player.Settings.HoverControl);
		configuration.Get("StackToChestsPreferredMode", ref Player.Settings.StackToChestsPreferredMode);
		configuration.Get("CraftFromNearbyChests", ref Player.Settings.CraftFromNearbyChests);
		configuration.Get("PortraitPreference", ref DialoguePortraitPreference);
		configuration.Get("UseScreenShake", ref UseScreenShake);
		JArray jArray = configuration.Get("SecretSeeds", new JArray());
		try
		{
			if (jArray != null && jArray.Count != 0)
			{
				SecretSeedsTracker.SetstringsFromConfig(jArray.ToObject<List<string>>());
			}
		}
		catch (JsonReaderException arg)
		{
			Console.WriteLine("Failed to parse configuration entry for secret seed list. {0}", arg);
		}
		if (currentValue <= 162)
		{
			bool currentValue9 = false;
			uint currentValue10 = 0u;
			configuration.Get("ThickMouseEdges", ref currentValue9);
			if (currentValue9)
			{
				configuration.Get("ThickMouseEdgesPackedColor", ref currentValue10);
				MouseBorderColor.PackedValue = currentValue10;
				mouseColor.R = configuration.Get("MouseColorR", mouseColor.R);
				mouseColor.G = configuration.Get("MouseColorG", mouseColor.G);
				mouseColor.B = configuration.Get("MouseColorB", mouseColor.B);
			}
		}
		if (currentValue <= 162)
		{
			configuration.Get("KeyUp", ref cUp);
			configuration.Get("KeyDown", ref cDown);
			configuration.Get("KeyLeft", ref cLeft);
			configuration.Get("KeyRight", ref cRight);
			configuration.Get("KeyJump", ref cJump);
			configuration.Get("KeyThrowItem", ref cThrowItem);
			configuration.Get("KeyInventory", ref cInv);
			configuration.Get("KeyQuickHeal", ref cHeal);
			configuration.Get("KeyQuickMana", ref cMana);
			configuration.Get("KeyQuickBuff", ref cBuff);
			configuration.Get("KeyUseHook", ref cHook);
			configuration.Get("KeyAutoSelect", ref cTorch);
			configuration.Get("KeySmartCursor", ref cSmart);
			configuration.Get("KeyMount", ref cMount);
			configuration.Get("KeyMapStyle", ref cMapStyle);
			configuration.Get("KeyFullscreenMap", ref cMapFull);
			configuration.Get("KeyMapZoomIn", ref cMapZoomIn);
			configuration.Get("KeyMapZoomOut", ref cMapZoomOut);
			configuration.Get("KeyMapAlphaUp", ref cMapAlphaUp);
			configuration.Get("KeyMapAlphaDown", ref cMapAlphaDown);
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Up"] = new List<string> { cUp };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Down"] = new List<string> { cDown };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Left"] = new List<string> { cLeft };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Right"] = new List<string> { cRight };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Jump"] = new List<string> { cJump };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Throw"] = new List<string> { cThrowItem };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Inventory"] = new List<string> { cInv };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["QuickHeal"] = new List<string> { cHeal };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["QuickMana"] = new List<string> { cMana };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["QuickBuff"] = new List<string> { cBuff };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["Grapple"] = new List<string> { cHook };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["SmartSelect"] = new List<string> { cTorch };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["SmartCursor"] = new List<string> { cSmart };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["QuickMount"] = new List<string> { cMount };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["MapStyle"] = new List<string> { cMapStyle };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["MapFull"] = new List<string> { cMapFull };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["MapZoomIn"] = new List<string> { cMapZoomIn };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["MapZoomOut"] = new List<string> { cMapZoomOut };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["MapAlphaUp"] = new List<string> { cMapAlphaUp };
			PlayerInput.CurrentProfile.InputModes[InputMode.Keyboard].KeyStatus["MapAlphaDown"] = new List<string> { cMapAlphaDown };
		}
		PlayerInput.Load();
		if (currentValue < 165)
		{
			try
			{
				PlayerInput.ManageVersion_1_3();
			}
			catch (Exception)
			{
			}
		}
		mouseColorSlider.SetHSL(mouseColor);
		mouseBorderColorSlider.SetHSL(MouseBorderColor);
		mouseBorderColorSlider.Alpha = (float)(int)MouseBorderColor.A / 255f;
		if (currentValue != 317)
		{
			SaveSettings();
		}
		IsInTheMiddleOfLoadingSettings = false;
	}

	protected void OpenLegacySettings()
	{
		try
		{
			if (!File.Exists(SavePath + Path.DirectorySeparatorChar + "config.dat"))
			{
				return;
			}
			using FileStream input = new FileStream(SavePath + Path.DirectorySeparatorChar + "config.dat", FileMode.Open);
			using BinaryReader binaryReader = new BinaryReader(input);
			int num = binaryReader.ReadInt32();
			if (num >= 68)
			{
				if (num >= 67)
				{
					clientUUID = binaryReader.ReadString();
				}
				bool flag = binaryReader.ReadBoolean();
				mouseColor.R = binaryReader.ReadByte();
				mouseColor.G = binaryReader.ReadByte();
				mouseColor.B = binaryReader.ReadByte();
				soundVolume = binaryReader.ReadSingle();
				if (num >= 90)
				{
					ambientVolume = binaryReader.ReadSingle();
				}
				musicVolume = binaryReader.ReadSingle();
				cUp = binaryReader.ReadString();
				cDown = binaryReader.ReadString();
				cLeft = binaryReader.ReadString();
				cRight = binaryReader.ReadString();
				cJump = binaryReader.ReadString();
				cThrowItem = binaryReader.ReadString();
				if (num >= 1)
				{
					cInv = binaryReader.ReadString();
				}
				if (num >= 12)
				{
					cHeal = binaryReader.ReadString();
					cMana = binaryReader.ReadString();
					cBuff = binaryReader.ReadString();
				}
				if (num >= 13)
				{
					cHook = binaryReader.ReadString();
				}
				caveParallax = binaryReader.ReadSingle();
				if (num >= 2)
				{
					binaryReader.ReadBoolean();
				}
				if (num >= 91 && binaryReader.ReadBoolean() && !dedServ && Platform.IsWindows)
				{
					((Form)Control.FromHandle(base.Window.Handle)).WindowState = FormWindowState.Maximized;
				}
				if (num >= 4)
				{
					int width = binaryReader.ReadInt32();
					int height = binaryReader.ReadInt32();
					SetDisplayMode(width, height, flag);
				}
				if (num >= 8)
				{
					autoSave = binaryReader.ReadBoolean();
				}
				if (num >= 9)
				{
					autoPause = binaryReader.ReadBoolean();
				}
				if (num >= 19)
				{
					showItemText = binaryReader.ReadBoolean();
				}
				if (num >= 30)
				{
					cTorch = binaryReader.ReadString();
					Lighting.Mode = (LightMode)binaryReader.ReadByte();
					qaStyle = binaryReader.ReadByte();
				}
				if (num >= 37)
				{
					BackgroundEnabled = binaryReader.ReadBoolean();
				}
				if (num >= 39)
				{
					byte b = binaryReader.ReadByte();
					_needsLanguageSelect = b == 0;
					LanguageManager.Instance.SetLanguage(b);
				}
				if (num >= 46)
				{
					mapEnabled = binaryReader.ReadBoolean();
					cMapStyle = binaryReader.ReadString();
					cMapFull = binaryReader.ReadString();
					cMapZoomIn = binaryReader.ReadString();
					cMapZoomOut = binaryReader.ReadString();
					cMapAlphaUp = binaryReader.ReadString();
					cMapAlphaDown = binaryReader.ReadString();
				}
				if (num >= 89)
				{
					binaryReader.ReadInt32();
				}
				if (num >= 100)
				{
					cSmart = binaryReader.ReadString();
					cSmartCursorModeIsToggleAndNotHold = binaryReader.ReadBoolean();
				}
				if (num >= 107)
				{
					invasionProgressMode = binaryReader.ReadByte();
				}
				if (num >= 111)
				{
					placementPreview = binaryReader.ReadBoolean();
				}
				if (num >= 111)
				{
					placementPreview = binaryReader.ReadBoolean();
				}
				SetFullScreen(flag);
			}
			binaryReader.Close();
		}
		catch
		{
		}
	}

	private static void ErasePlayer(int i)
	{
		try
		{
			FileUtilities.Delete(PlayerList[i].Path, PlayerList[i].IsCloudSave);
			FileUtilities.Delete(PlayerList[i].Path + ".bak", PlayerList[i].IsCloudSave);
		}
		catch
		{
		}
		try
		{
			string text = PlayerList[i].Path.Substring(0, PlayerList[i].Path.Length - 4);
			if (text.Substring(text.Length - 1) != "." && text.Substring(text.Length - 1) != "\\" && Directory.Exists(text))
			{
				Directory.Delete(text, recursive: true);
			}
			LoadPlayers();
		}
		catch
		{
		}
	}

	private static void EraseWorld(int i)
	{
		try
		{
			if (!WorldList[i].IsCloudSave)
			{
				Platform.Get<IPathService>().MoveToRecycleBin(WorldList[i].Path);
				Platform.Get<IPathService>().MoveToRecycleBin(WorldList[i].Path + ".bak");
				for (int j = 2; j <= 9; j++)
				{
					Platform.Get<IPathService>().MoveToRecycleBin(WorldList[i].Path + ".bak" + j);
				}
			}
			else if (SocialAPI.Cloud != null)
			{
				SocialAPI.Cloud.Delete(WorldList[i].Path);
			}
			LoadWorlds();
		}
		catch
		{
		}
	}

	public static string GetPlayerPathFromName(string playerName, bool cloudSave)
	{
		char[] invalidFileNameChars = Path.GetInvalidFileNameChars();
		string text = "";
		playerName = playerName.Replace(".", "_");
		playerName = playerName.Replace("*", "_");
		foreach (char c in playerName)
		{
			text += ((!invalidFileNameChars.Contains(c)) ? ((c != ' ') ? c : '_') : '-');
		}
		string text2 = (cloudSave ? CloudPlayerPath : PlayerPath);
		if (FileUtilities.GetFullPath(text2 + Path.DirectorySeparatorChar + text + ".plr", cloudSave).StartsWith("\\\\.\\", StringComparison.Ordinal))
		{
			text += "_";
		}
		if (FileUtilities.Exists(text2 + Path.DirectorySeparatorChar + text + ".plr", cloudSave))
		{
			int num = 2;
			while (FileUtilities.Exists(text2 + Path.DirectorySeparatorChar.ToString() + text + num + ".plr", cloudSave))
			{
				num++;
			}
			text += num;
		}
		return text2 + Path.DirectorySeparatorChar + text + ".plr";
	}

	public static string GetWorldPathFromName(string worldName, bool cloudSave)
	{
		char[] invalidFileNameChars = Path.GetInvalidFileNameChars();
		string text = "";
		foreach (char c in worldName)
		{
			text += ((!invalidFileNameChars.Contains(c)) ? ((c != ' ') ? c : '_') : '-');
		}
		text = text.Replace(".", "_");
		text = text.Replace("*", "_");
		string text2 = (cloudSave ? CloudWorldPath : WorldPath);
		if (FileUtilities.GetFullPath(text2 + Path.DirectorySeparatorChar + text + ".wld", cloudSave).StartsWith("\\\\.\\", StringComparison.Ordinal))
		{
			text += "_";
		}
		if (FileUtilities.Exists(text2 + Path.DirectorySeparatorChar + text + ".wld", cloudSave))
		{
			int num = 2;
			while (FileUtilities.Exists(text2 + Path.DirectorySeparatorChar.ToString() + text + num + ".wld", cloudSave))
			{
				num++;
			}
			text += num;
		}
		return text2 + Path.DirectorySeparatorChar + text + ".wld";
	}

	public void setServerWorldRollbacks(string rollBacksToKeep)
	{
		WorldRollingBackupsCountToKeep = Convert.ToInt32(rollBacksToKeep);
	}

	public void autoCreate(string worldSize)
	{
		switch (worldSize)
		{
		case "0":
			autoGen = false;
			break;
		case "1":
			maxTilesX = 4200;
			maxTilesY = 1200;
			autoGen = true;
			break;
		case "2":
			maxTilesX = 6400;
			maxTilesY = 1800;
			autoGen = true;
			break;
		case "3":
			maxTilesX = 8400;
			maxTilesY = 2400;
			autoGen = true;
			break;
		}
	}

	public void NewMOTD(string newMOTD)
	{
		motd = newMOTD;
	}

	public static string ConvertToSafeArgument(string arg)
	{
		return Uri.EscapeDataString(arg);
	}

	public static string ConvertFromSafeArgument(string arg)
	{
		return Uri.UnescapeDataString(arg);
	}

	public void LoadDedConfig(string configPath)
	{
		if (!File.Exists(configPath))
		{
			return;
		}
		using StreamReader streamReader = new StreamReader(configPath);
		string text = string.Empty;
		string text2;
		while ((text2 = streamReader.ReadLine()) != null)
		{
			try
			{
				if (text2.Length > 6 && text2.Substring(0, 6).ToLower() == "world=")
				{
					string path = text2.Substring(6);
					string text3;
					try
					{
						text3 = Platform.Get<IPathService>().ExpandPathVariables(path);
						new FileInfo(text3);
					}
					catch
					{
						goto end_IL_001e;
					}
					autoGenFileLocation = text3;
					if (!File.Exists(text3))
					{
						ActiveWorldFileData = new WorldFileData(text3, cloudSave: false);
					}
					else
					{
						WorldFile.GetAllMetadata(text3, cloudSave: false).SetAsActive();
					}
				}
				if (text2.Length > 5 && text2.Substring(0, 5).ToLower() == "port=")
				{
					string value = text2.Substring(5);
					try
					{
						Netplay.ListenPort = Convert.ToInt32(value);
					}
					catch
					{
					}
				}
				if (text2.Length > 21 && text2.Substring(0, 21).ToLower() == "worldrollbackstokeep=")
				{
					string value2 = text2.Substring(21);
					try
					{
						WorldRollingBackupsCountToKeep = Convert.ToInt32(value2);
					}
					catch
					{
					}
				}
				if (text2.Length > 11 && text2.Substring(0, 11).ToLower() == "maxplayers=")
				{
					string value3 = text2.Substring(11);
					try
					{
						int num = Convert.ToInt32(value3);
						if (num <= 255 && num >= 1)
						{
							SetNetPlayers(num);
						}
					}
					catch
					{
					}
				}
				if (text2.Length > 11 && text2.Substring(0, 9).ToLower() == "priority=" && !Program.LaunchParameters.ContainsKey("-forcepriority"))
				{
					string value4 = text2.Substring(9);
					try
					{
						int num2 = Convert.ToInt32(value4);
						if (num2 >= 0 && num2 <= 5)
						{
							Process currentProcess = Process.GetCurrentProcess();
							switch (num2)
							{
							case 0:
								currentProcess.PriorityClass = ProcessPriorityClass.RealTime;
								break;
							case 1:
								currentProcess.PriorityClass = ProcessPriorityClass.High;
								break;
							case 2:
								currentProcess.PriorityClass = ProcessPriorityClass.AboveNormal;
								break;
							case 3:
								currentProcess.PriorityClass = ProcessPriorityClass.Normal;
								break;
							case 4:
								currentProcess.PriorityClass = ProcessPriorityClass.BelowNormal;
								break;
							case 5:
								currentProcess.PriorityClass = ProcessPriorityClass.Idle;
								break;
							}
						}
					}
					catch
					{
					}
				}
				if (text2.Length > 9 && text2.Substring(0, 9).ToLower() == "password=")
				{
					Netplay.ServerPassword = ConvertFromSafeArgument(text2.Substring(9));
				}
				if (text2.Length > 5 && text2.Substring(0, 5).ToLower() == "motd=")
				{
					motd = text2.Substring(5);
				}
				if (text2.Length > 5 && text2.Substring(0, 5).ToLower() == "lang=")
				{
					string value5 = text2.Substring(5);
					LanguageManager.Instance.SetLanguage(Convert.ToInt32(value5));
				}
				if (text2.Length > 9 && text2.Substring(0, 9).ToLower() == "language=")
				{
					string language = text2.Substring(9);
					LanguageManager.Instance.SetLanguage(language);
				}
				if (text2.Length >= 10 && text2.Substring(0, 10).ToLower() == "worldpath=")
				{
					string path2 = text2.Substring(10);
					WorldPath = Platform.Get<IPathService>().ExpandPathVariables(path2);
				}
				if (text2.Length >= 10 && text2.Substring(0, 10).ToLower() == "worldname=")
				{
					worldName = text2.Substring(10);
				}
				if (text2.Length >= 5 && text2.Substring(0, 5).ToLower() == "seed=")
				{
					AutogenSeedName = text2.Substring(5);
				}
				if (text2.Length > 8 && text2.Substring(0, 8).ToLower() == "banlist=")
				{
					string path3 = text2.Substring(8);
					Netplay.BanFilePath = Platform.Get<IPathService>().ExpandPathVariables(path3);
				}
				if (text2.Length > 11 && text2.Substring(0, 11).ToLower() == "difficulty=")
				{
					text = text2.Substring(11);
				}
				if (text2.Length > 11 && text2.Substring(0, 11).ToLower() == "autocreate=")
				{
					string worldSize = text2.Substring(11);
					autoCreate(worldSize);
				}
				if (text2.Length > 7 && text2.Substring(0, 7).ToLower() == "secure=" && text2.Substring(7) == "1")
				{
					Netplay.SpamCheck = true;
				}
				if (text2.Length > 5 && text2.Substring(0, 5).ToLower() == "upnp=" && text2.Substring(5) != "1")
				{
					Netplay.UseUPNP = false;
				}
				string text4 = "slowliquids=";
				if (text2.Length > text4.Length && text2.Substring(0, text4.Length).ToLower() == text4 && text2.Substring(text4.Length) == "1")
				{
					Setting_UseReducedMaxLiquids = true;
				}
				if (text2.Length > 10 && text2.Substring(0, 10).ToLower() == "npcstream=")
				{
					string value6 = text2.Substring(10);
					try
					{
						npcStreamSpeed = Convert.ToInt32(value6);
					}
					catch
					{
					}
				}
				CreativePowerManager.TryListingPermissionsFrom(text2);
				WorldGenerationOptions.TryEnablingFlagFrom(text2);
				end_IL_001e:;
			}
			catch
			{
			}
		}
		if (!string.IsNullOrEmpty(text))
		{
			switch (text)
			{
			case "0":
				GameMode = 0;
				break;
			case "1":
				GameMode = 1;
				break;
			case "2":
				GameMode = 2;
				break;
			case "3":
				GameMode = 3;
				break;
			}
		}
	}

	public void SetNetPlayers(int mPlayers)
	{
		maxNetPlayers = mPlayers;
	}

	public void SetWorld(string world, bool cloud)
	{
		WorldFile.GetAllMetadata(world, cloud).SetAsActive();
	}

	public void SetWorldName(string world)
	{
		worldName = world;
	}

	public void EnableAutoShutdown()
	{
		autoShutdown = true;
	}

	[DllImport("user32.dll")]
	public static extern IntPtr FindWindow(string lpClassName, string lpWindowName);

	[DllImport("user32.dll")]
	private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);

	public void AutoPass()
	{
		autoPass = true;
	}

	public void AutoJoin(string IP)
	{
		defaultIP = IP;
		getIP = IP;
		Netplay.SetRemoteIP(defaultIP);
		autoJoin = true;
	}

	public void AutoHost()
	{
		menuMultiplayer = true;
		menuServer = true;
		ClearPendingPlayerSelectCallbacks();
		menuMode = 1;
	}

	public void loadLib(string path)
	{
		libPath = path;
		LoadLibrary(libPath);
	}

	public void NeverSleep()
	{
		if (Platform.IsWindows)
		{
			previousExecutionState = NativeMethods.SetThreadExecutionState(2147483649u);
		}
	}

	public void YouCanSleepNow()
	{
		if (Platform.IsWindows && previousExecutionState != 0)
		{
			NativeMethods.SetThreadExecutionState(previousExecutionState);
		}
	}

	public static int HunterDelay = 15;
    public void DedServ()
    {
        NeverSleep();
        rand = new UnifiedRandom();
        if (autoShutdown)
        {
            string lpWindowName = (Console.Title = "terraria" + rand.Next(int.MaxValue));
            if (Platform.IsWindows)
            {
                IntPtr intPtr = FindWindow(null, lpWindowName);
                if (intPtr != IntPtr.Zero)
                {
                    ShowWindow(intPtr, 0);
                }
            }
        }
        else
        {
            Console.Title = "Terraria Server " + versionNumber2;
        }
        dedServ = true;
        showSplash = false;
        Initialize();
        while (worldPathName == null || worldPathName == "")
        {
            bool flag = true;
            while (flag)
            {
                LoadWorlds();
                Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                Console.WriteLine("");
                for (int i = 0; i < WorldList.Count; i++)
                {
                    WorldFileData worldFileData = WorldList[i];
                    string text2 = WorldList[i].Name;
                    if (!worldFileData.IsValid)
                    {
                        text2 = "(" + StatusID.Search.GetName(worldFileData.LoadStatus) + ") " + text2;
                    }
                    Console.WriteLine(i + 1 + "\t\t" + text2);
                }
                string textValue = Language.GetTextValue("CLI.NewWorld_Command");
                string textValue2 = Language.GetTextValue("CLI.DeleteWorld_Example");
                int num = (Math.Max(newWorldName.Length, textValue2.Length) + 1) / 8 + 1;
                textValue = textValue + new string('\t', num - textValue.Length / 8) + Language.GetTextValue("CLI.NewWorld_Description");
                textValue2 = textValue2 + new string('\t', num - textValue2.Length / 8) + Language.GetTextValue("CLI.DeleteWorld_Description");
                Console.WriteLine(textValue);
                Console.WriteLine(textValue2);
                Console.WriteLine("");
                Console.Write(Language.GetTextValue("CLI.ChooseWorld"));
                string text3 = ReadLineInput();
                if (text3 == null)
                {
                    text3 = "";
                }
                try
                {
                    Console.Clear();
                }
                catch
                {
                }
                if (Language.GetText("CLI.DeleteWorld_Command").ParseCommandPrefix(text3, out var remainder))
                {
                    try
                    {
                        int num2 = Convert.ToInt32(remainder) - 1;
                        if (num2 < WorldList.Count)
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                            Console.WriteLine("");
                            Console.WriteLine(Language.GetTextValue("CLI.DeleteConfirmation", WorldList[num2].Name));
                            Console.Write("({0}/{1}): ", Language.GetTextValue("CLI.ShortYes"), Language.GetTextValue("CLI.ShortNo"));
                            string text4 = ReadLineInput();
                            if (Language.GetText("CLI.ShortYes").EqualsCommand(text4) || Language.GetText("CLI.Yes").EqualsCommand(text4))
                            {
                                EraseWorld(num2);
                            }
                        }
                    }
                    catch
                    {
                    }
                    try
                    {
                        Console.Clear();
                    }
                    catch
                    {
                    }
                    continue;
                }
                if (Language.GetText("CLI.NewWorld_Command").EqualsCommand(text3))
                {
                    bool flag2 = true;
                    while (flag2)
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        Console.WriteLine("");
                        Console.WriteLine("1\t" + Language.GetTextValue("UI.WorldSizeSmall"));
                        Console.WriteLine("2\t" + Language.GetTextValue("UI.WorldSizeMedium"));
                        Console.WriteLine("3\t" + Language.GetTextValue("UI.WorldSizeLarge"));
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.ChooseSize"));
                        string value = ReadLineInput();
                        try
                        {
                            switch (Convert.ToInt32(value))
                            {
                                case 1:
                                    maxTilesX = 4200;
                                    maxTilesY = 1200;
                                    flag2 = false;
                                    break;
                                case 2:
                                    maxTilesX = 6400;
                                    maxTilesY = 1800;
                                    flag2 = false;
                                    break;
                                case 3:
                                    maxTilesX = 8400;
                                    maxTilesY = 2400;
                                    flag2 = false;
                                    break;
                            }
                        }
                        catch
                        {
                        }
                        try
                        {
                            Console.Clear();
                        }
                        catch
                        {
                        }
                    }
                    flag2 = true;
                    while (flag2)
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        Console.WriteLine("");
                        Console.WriteLine("1\t" + Language.GetTextValue("UI.Normal"));
                        Console.WriteLine("2\t" + Language.GetTextValue("UI.Expert"));
                        Console.WriteLine("3\t" + Language.GetTextValue("UI.Master"));
                        Console.WriteLine("4\t" + Language.GetTextValue("UI.Creative"));
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.ChooseDifficulty"));
                        string value = ReadLineInput();
                        try
                        {
                            switch (Convert.ToInt32(value))
                            {
                                case 1:
                                    GameMode = 0;
                                    flag2 = false;
                                    break;
                                case 2:
                                    GameMode = 1;
                                    flag2 = false;
                                    break;
                                case 3:
                                    GameMode = 2;
                                    flag2 = false;
                                    break;
                                case 4:
                                    GameMode = 3;
                                    flag2 = false;
                                    break;
                            }
                        }
                        catch
                        {
                        }
                        try
                        {
                            Console.Clear();
                        }
                        catch
                        {
                        }
                    }
                    flag2 = true;
                    while (flag2)
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        Console.WriteLine("");
                        Console.WriteLine("1\t" + Language.GetTextValue("CLI.Random"));
                        Console.WriteLine("2\t" + Language.GetTextValue("CLI.Corrupt"));
                        Console.WriteLine("3\t" + Language.GetTextValue("CLI.Crimson"));
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.ChooseEvil"));
                        string value = ReadLineInput();
                        try
                        {
                            switch (Convert.ToInt32(value))
                            {
                                case 1:
                                    WorldGen.WorldGenParam_Evil = -1;
                                    flag2 = false;
                                    break;
                                case 2:
                                    WorldGen.WorldGenParam_Evil = 0;
                                    flag2 = false;
                                    break;
                                case 3:
                                    WorldGen.WorldGenParam_Evil = 1;
                                    flag2 = false;
                                    break;
                            }
                        }
                        catch
                        {
                        }
                        try
                        {
                            Console.Clear();
                        }
                        catch
                        {
                        }
                    }
                    flag2 = true;
                    Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                    while (flag2)
                    {
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.EnterWorldName"));
                        newWorldName = ReadLineInput();
                        if (newWorldName != null && newWorldName != "" && newWorldName != " ")
                        {
                            if (newWorldName.Length >= 27)
                            {
                                Console.WriteLine("");
                                Console.WriteLine(Language.GetTextValue("CLI.WorldNameLengthTooLong", 26));
                                continue;
                            }
                            flag2 = false;
                            try
                            {
                                Console.Clear();
                            }
                            catch
                            {
                            }
                        }
                        else
                        {
                            try
                            {
                                Console.Clear();
                            }
                            catch
                            {
                            }
                            Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        }
                    }
                    string text5 = "";
                    flag2 = true;
                    Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                    string processedSeed;
                    List<string> secretSeedTexts;
                    while (flag2)
                    {
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.EnterSeed"));
                        text5 = ReadLineInput();
                        if (text5 != null)
                        {
                            text5 = text5.Trim();
                            if (!WorldFileData.TryApplyingCopiedSeed(text5, playSound: false, out processedSeed, out processedSeed, out secretSeedTexts) && text5.Length > WorldFileData.MAX_USER_SEED_TEXT_LENGTH)
                            {
                                Console.WriteLine("");
                                Console.WriteLine(Language.GetTextValue("CLI.SeedLengthTooLong", WorldFileData.MAX_USER_SEED_TEXT_LENGTH));
                                continue;
                            }
                            if (WorldGen.SecretSeed.CheckInputForSecretSeed(text5, out var secretSeed))
                            {
                                WorldGen.SecretSeed.Enable(secretSeed);
                                Console.WriteLine("");
                                Console.WriteLine(Language.GetTextValue("CLI.SecretSeedEnabled"));
                                continue;
                            }
                            flag2 = false;
                            try
                            {
                                Console.Clear();
                            }
                            catch
                            {
                            }
                        }
                        else
                        {
                            text5 = "";
                        }
                    }
                    worldName = newWorldName;
                    ActiveWorldFileData = WorldFile.CreateMetadata(worldName, SocialAPI.Cloud != null && SocialAPI.Cloud.EnabledByDefault, GameMode);
                    if (WorldFileData.TryApplyingCopiedSeed(text5, playSound: true, out processedSeed, out var seedTextIncludingSecrets, out secretSeedTexts))
                    {
                        ActiveWorldFileData.SetSeed(seedTextIncludingSecrets);
                    }
                    else
                    {
                        AWorldGenerationOption optionFromSeedText = WorldGenerationOptions.GetOptionFromSeedText(text5);
                        WorldGenerationOptions.SelectOption(optionFromSeedText);
                        if (optionFromSeedText != null || string.IsNullOrWhiteSpace(text5))
                        {
                            ActiveWorldFileData.SetSeedToRandomWithCurrentEvents();
                        }
                        else
                        {
                            ActiveWorldFileData.SetSeed(text5);
                        }
                    }
                    DedServ_SeedFlagsMenu();
                    menuMode = 10;
                    GenerationProgress generationProgress = new GenerationProgress();
                    Task task = WorldGen.CreateNewWorld(generationProgress);
                    flag2 = false;
                    while (menuMode == 10)
                    {
                        if (oldStatusText != statusText && !WorldGen.drunkWorldGen)
                        {
                            oldStatusText = statusText;
                            Console.WriteLine(statusText);
                        }
                    }
                    try
                    {
                        Console.Clear();
                    }
                    catch
                    {
                    }
                    while (!task.IsCompleted)
                    {
                        statusText = string.Format("{0:0.0%} - " + generationProgress.Message + " - {1:0.0%}", generationProgress.TotalProgress, generationProgress.Value);
                        if (oldStatusText != statusText)
                        {
                            oldStatusText = statusText;
                            string value2 = statusText;
                            if (WorldGen.notTheBees && !WorldGen.getGoodWorldGen)
                            {
                                value2 = string.Format("{0:0.0%} - " + Language.GetTextValue("UI.WorldGenEasterEgg_GeneratingBees") + " - {1:0.0%}", generationProgress.TotalProgress, generationProgress.Value);
                            }
                            Console.WriteLine(value2);
                        }
                    }
                    continue;
                }
                try
                {
                    int num3 = Convert.ToInt32(text3);
                    num3--;
                    if (num3 < 0 || num3 >= WorldList.Count || !WorldList[num3].IsValid)
                    {
                        continue;
                    }
                    bool flag3 = true;
                    while (flag3)
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.SetInitialMaxPlayers"));
                        string text6 = ReadLineInput();
                        try
                        {
                            if (text6 == "")
                            {
                                text6 = "16";
                            }
                            int num4 = Convert.ToInt32(text6);
                            if (num4 <= 255 && num4 >= 1)
                            {
                                SetNetPlayers(num4);
                                flag3 = false;
                            }
                            flag3 = false;
                        }
                        catch
                        {
                        }
                        try
                        {
                            Console.Clear();
                        }
                        catch
                        {
                        }
                    }
                    flag3 = true;
                    while (flag3)
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.SetInitialPort"));
                        string text7 = ReadLineInput();
                        try
                        {
                            if (text7 == "")
                            {
                                text7 = "7777";
                            }
                            int num5 = Convert.ToInt32(text7);
                            if (num5 <= 65535)
                            {
                                Netplay.ListenPort = num5;
                                flag3 = false;
                            }
                        }
                        catch
                        {
                        }
                        try
                        {
                            Console.Clear();
                        }
                        catch
                        {
                        }
                    }
                    flag3 = true;
                    while (flag3)
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                        Console.WriteLine("");
                        Console.Write(Language.GetTextValue("CLI.AutomaticPortForward", Language.GetTextValue("CLI.ShortYes"), Language.GetTextValue("CLI.ShortNo")));
                        string text8 = ReadLineInput();
                        try
                        {
                            if (text8 == "" || Language.GetText("CLI.ShortYes").EqualsCommand(text8) || Language.GetText("CLI.Yes").EqualsCommand(text8))
                            {
                                Netplay.UseUPNP = true;
                                flag3 = false;
                            }
                            else if (Language.GetText("CLI.ShortNo").EqualsCommand(text8) || Language.GetText("CLI.No").EqualsCommand(text8))
                            {
                                Netplay.UseUPNP = false;
                                flag3 = false;
                            }
                        }
                        catch
                        {
                        }
                        try
                        {
                            Console.Clear();
                        }
                        catch
                        {
                        }
                    }
                    Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
                    Console.WriteLine("");
                    Console.Write(Language.GetTextValue("CLI.EnterServerPassword"));
                    Netplay.ServerPassword = ReadLineInput();
                    WorldList[num3].SetAsActive();
                    flag = false;
                    try
                    {
                        Console.Clear();
                    }
                    catch
                    {
                    }
                }
                catch
                {
                }
            }
        }
        try
        {
            Console.Clear();
        }
        catch
        {
        }
        Task task2 = WorldGen.serverLoadWorld();
        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber));
        Console.WriteLine("");
        while (!task2.IsCompleted)
        {
            if (WorldFile.LastThrownLoadException == null)
            {
                if (AutogenProgress.TotalProgress != 0.0)
                {
                    statusText = string.Format("{0:0.0%} - " + AutogenProgress.Message + " - {1:0.0%}", AutogenProgress.TotalProgress, AutogenProgress.Value);
                }
                if (oldStatusText != statusText)
                {
                    oldStatusText = statusText;
                    Console.WriteLine(statusText);
                }
            }
        }
        try
        {
            if (WorldFile.LastThrownLoadException == null)
            {
                Console.Clear();
            }
        }
        catch
        {
        }
        if (WorldGen.loadFailed)
        {
            WriteFancyWorldLoadErrorToConsole();
            if (!autoShutdown)
            {
                Console.ReadKey();
            }
            YouCanSleepNow();
            return;
        }
        Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber));
        Console.WriteLine("");
        Console.WriteLine(Language.GetTextValue("CLI.ListeningOnPort", Netplay.ListenPort));
        Console.WriteLine(Language.GetTextValue("CLI.HelpHint"));
        Console.WriteLine("");
        Console.Title = "Terraria Server: " + worldName;
        Stopwatch stopwatch = new Stopwatch();
        if (!autoShutdown)
        {
            startDedInput();
        }
        stopwatch.Start();
        double num6 = 16.666666666666668;
        double num7 = 0.0;
        int num8 = 0;
        new Stopwatch().Start();
        Netplay.StartServer();
        gameMenu = false;

        int dayCounter = 0;
        bool wasNight = false;
        int countdownTime = 0;
        bool countdownActive = false;
        int countdownTickCounter = 0;
        string currentRunnerName = "";
        int runnerTeamID = 0;
        Dictionary<string, int> playerJoinTicks = new Dictionary<string, int>();
        int buffSyncTimer = 0;

        while (!Netplay.Disconnect)
        {
            double totalMilliseconds = stopwatch.Elapsed.TotalMilliseconds;
            if (totalMilliseconds + num7 >= num6)
            {
                num8++;
                num7 += totalMilliseconds - num6;
                stopwatch.Reset();
                stopwatch.Start();
                if (oldStatusText != statusText)
                {
                    oldStatusText = statusText;
                    Console.WriteLine(statusText);
                }
                if (Netplay.HasClients)
                {
                    DetailedFPS.StartNextFrame();
                    Update(new GameTime());

                    int activePlayerCount = 0;
                    int currentRunnerIndex = -1;
                    buffSyncTimer++;

                    for (int k = 0; k < 255; k++)
                    {
                        if (Main.player[k].active && !string.IsNullOrEmpty(Main.player[k].name))
                        {
                            activePlayerCount++;
                            if (currentRunnerName != "" && Main.player[k].name.Equals(currentRunnerName, StringComparison.OrdinalIgnoreCase))
                            {
                                currentRunnerIndex = k;
                            }
                        }
                    }

                    bool isLobby = (currentRunnerName == "");
                    HashSet<string> currentActiveNames = new HashSet<string>();

                    for (int i = 0; i < 255; i++)
                    {
                        if (Main.player[i].active && !string.IsNullOrEmpty(Main.player[i].name))
                        {
                            string pName = Main.player[i].name;
                            currentActiveNames.Add(pName);

                            bool isRunner = (i == currentRunnerIndex);
                            bool isHunter = (!isRunner && !isLobby);

                            int heldItem = 0;
                            if (Main.player[i].inventory != null && Main.player[i].selectedItem >= 0)
                                heldItem = Main.player[i].inventory[Main.player[i].selectedItem].type;

                            bool isAttemptingUse = Main.player[i].controlUseItem;

                            if (currentRunnerName == "" && heldItem == 5334 && isAttemptingUse && !countdownActive)
                            {
                                if (Main.player[i].team != 4 && Main.player[i].team != 0)
                                {
                                    currentRunnerName = Main.player[i].name;
                                    currentRunnerIndex = i;
                                    runnerTeamID = Main.player[i].team;
                                    countdownActive = true;

                                    int hunters = activePlayerCount - 1;
                                    if (hunters < 1)
                                        hunters = 1;
                                    int totalSeconds = hunters * HunterDelay;
                                    countdownTime = totalSeconds;
                                    countdownTickCounter = 0;

                                    string msg = $"RUNNER SELECTED: {currentRunnerName}! Team: {runnerTeamID}. Countdown: {totalSeconds}s.";
                                    Console.WriteLine(msg);
                                    ChatHelper.BroadcastChatMessage(NetworkText.FromLiteral(msg), new Microsoft.Xna.Framework.Color(50, 255, 50));

                                    isLobby = false;
                                    isRunner = true;
                                }
                            }

                            if (isLobby)
                            {
                                Main.dayTime = true;
                                Main.time = 13500.0;
                                NetMessage.SendData(7);
                                int existingIdx = Main.player[i].FindBuffIndex(23);
                                if (existingIdx != -1 && Main.player[i].buffTime[existingIdx] > 12)
                                {
                                    Main.player[i].buffTime[existingIdx] = 12;
                                }
                                Main.player[i].AddBuff(23, 12);
                                NetMessage.SendData(55, -1, -1, null, i, 23, 12);
                            }
                            else if (countdownActive && isHunter)
                            {
                                Main.player[i].AddBuff(149, 12);
                                NetMessage.SendData(55, -1, -1, null, i, 149, 12);
                            }

                            bool desiredPvP = !isLobby && !countdownActive;
                            if (Main.player[i].hostile != desiredPvP)
                            {
                                Main.player[i].hostile = desiredPvP;
                                NetMessage.SendData(30, -1, -1, null, i);
                            }

                            if (!playerJoinTicks.ContainsKey(pName))
                                playerJoinTicks[pName] = 0;
                            playerJoinTicks[pName]++;

                            if (playerJoinTicks[pName] == 120)
                            {
                                bool alreadyHas = false;
                                for (int inv = 0; inv < 58; inv++)
                                {
                                    if (Main.player[i].inventory[inv].type == 5334)
                                    {
                                        alreadyHas = true;
                                        break;
                                    }
                                }

                                if (!alreadyHas)
                                {
                                    int itemIdx = Item.NewItem(
                                        new EntitySource_DebugCommand(),
                                        (int)Main.player[i].Center.X,
                                        (int)Main.player[i].Center.Y,
                                        0, 0,
                                        5334, 1, false, 0, true
                                    );
                                    if (Main.netMode == 2)
                                        NetMessage.SendData(21, -1, -1, null, itemIdx, 1f);
                                    Console.WriteLine($"Dropped Razor for {pName}");
                                }
                            }

                            if (i != currentRunnerIndex)
                            {
                                int desiredTeam = 4;
                                if (currentRunnerIndex != -1 && heldItem == 5334)
                                    desiredTeam = runnerTeamID;
                                bool shouldForceTeam = (currentRunnerName != "" || Main.player[i].team == 0);

                                if (shouldForceTeam && Main.player[i].team != desiredTeam)
                                {
                                    Main.player[i].team = desiredTeam;
                                    NetMessage.SendData(45, -1, -1, null, i);
                                }
                            }
                            else if (currentRunnerIndex != -1)
                            {
                                if (Main.player[i].team != runnerTeamID)
                                {
                                    Main.player[i].team = runnerTeamID;
                                    NetMessage.SendData(45, -1, -1, null, i);
                                }
                            }
                        }
                    }

                    List<string> keysToRemove = new List<string>();
                    foreach (var key in playerJoinTicks.Keys)
                    {
                        if (!currentActiveNames.Contains(key))
                            keysToRemove.Add(key);
                    }
                    foreach (var key in keysToRemove)
                        playerJoinTicks.Remove(key);

                    if (buffSyncTimer >= 60)
                        buffSyncTimer = 0;

                    if (countdownActive)
                    {
                        countdownTickCounter++;
                        if (countdownTickCounter >= 60)
                        {
                            countdownTickCounter = 0;
                            countdownTime--;
                            if (countdownTime > 0 && (countdownTime % 5 == 0 || countdownTime <= 5))
                            {
                                ChatHelper.BroadcastChatMessage(NetworkText.FromLiteral($"{countdownTime} seconds remaining..."), new Microsoft.Xna.Framework.Color(255, 255, 100));
                            }
                            if (countdownTime <= 0)
                            {
                                countdownActive = false;
                                ChatHelper.BroadcastChatMessage(NetworkText.FromLiteral("HUNT BEGINS! GO! GO! GO!"), new Microsoft.Xna.Framework.Color(255, 50, 50));
                            }
                        }
                    }

                    if (!dayTime)
                        wasNight = true;
                    if (dayTime && wasNight)
                    {
                        wasNight = false;
                        dayCounter++;
                        if (dayCounter == 3)
                        {
                            string msg = "The 3rd Day has begun!";
                            Console.WriteLine(msg);
                            ChatHelper.BroadcastChatMessage(NetworkText.FromLiteral(msg), new Microsoft.Xna.Framework.Color(175, 75, 255));
                        }
                    }
                }
                else
                {
                    if (Main.OnTickForThirdPartySoftwareOnly != null)
                    {
                        Main.OnTickForThirdPartySoftwareOnly();
                    }
                    if (saveTime.IsRunning)
                    {
                        saveTime.Stop();
                        if (!autoShutdown)
                        {
                            WorldGen.saveAndPlay();
                        }
                    }
                }
                double num9 = stopwatch.Elapsed.TotalMilliseconds + num7;
                if (num9 < num6)
                {
                    int num10 = (int)(num6 - num9) - 1;
                    if (num10 > 1)
                    {
                        Thread.Sleep(num10 - 1);
                        if (!Netplay.HasClients)
                        {
                            num7 = 0.0;
                            Thread.Sleep(10);
                        }
                    }
                }
            }
            Thread.Sleep(0);
        }
        if (Netplay.SaveOnServerExit)
        {
            Console.WriteLine(Language.GetTextValue("Net.ServerSavingOnExit"));
            WorldFile.SaveWorld();
        }
        YouCanSleepNow();
    }

    private static void DedServ_SeedFlagsMenu()
	{
		List<AWorldGenerationOption> list = WorldGenerationOptions.Options.ToList();
		foreach (AWorldGenerationOption item in list)
		{
			item.Load();
		}
		string text = "[x]";
		string text2 = "[ ]";
		string value = "\t";
		while (true)
		{
			Console.Clear();
			Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber2));
			Console.WriteLine();
			int num = 0;
			foreach (AWorldGenerationOption item2 in list)
			{
				num++;
				Console.Write($"{num,-2}");
				Console.Write(value);
				Console.Write(item2.Enabled ? text : text2);
				Console.Write(value);
				Console.Write(item2.Title);
				Console.WriteLine();
			}
			Console.WriteLine();
			Console.Write(Language.GetTextValue("CLI.EnterSeedToggleNumber"));
			string text3 = ReadLineInput();
			if (text3 == string.Empty)
			{
				break;
			}
			if (!int.TryParse(text3, out var result))
			{
				Console.Clear();
				continue;
			}
			int num2 = result - 1;
			if (num2 < 0 || num2 >= list.Count)
			{
				Console.Clear();
			}
			else
			{
				list[num2].Enabled = !list[num2].Enabled;
			}
		}
	}

	private static void WriteFancyWorldLoadErrorToConsole()
	{
		Console.WriteLine();
		if (WorldFile.LastThrownLoadException != null)
		{
			Console.WriteLine(WorldFile.LastThrownLoadException.ToString());
		}
	}

	public static void startDedInput()
	{
		Thread thread = new Thread(startDedInputCallBack);
		thread.IsBackground = true;
		thread.Name = "Server Input Thread";
		thread.Start();
	}

    public static void startDedInputCallBack()
    {
        while (!Netplay.Disconnect)
        {
            Console.Write(": ");
            string text = ReadLineInput();
            string text2 = text;
            try
            {
                if (Language.GetText("CLI.Help_Command").EqualsCommand(text))
                {
                    Console.WriteLine(Language.GetTextValue("CLI.AvailableCommands"));
                    Console.WriteLine("");
                    Console.WriteLine("i \"name\" <id> [amt] [pfx] \t Gives item to player.");
                    Console.WriteLine("kick \"name\" [reason]      \t Kicks a player.");
                    Console.WriteLine("ban \"name\" [reason]       \t Bans a player.");
                    Console.WriteLine("delay <seconds>           \t Sets the countdown multiplier.");
                    Console.WriteLine("time <hh:mm am/pm>        \t Sets the server time.");
                    List<string> list = new List<string>
            {
                "Help", "Playing", "Clear", "Exit", "ExitNoSave", "Save", "Kick", "Ban", "Password", "SetPassword",
                "Version", "Time", "Port", "MaxPlayers", "Say", "MOTD", "SetMOTD", "Dawn", "Noon", "Dusk",
                "Midnight", "Settle", "Seed"
            };
                    int num = 0;
                    for (int i = 0; i < list.Count; i++)
                    {
                        string text3 = (Language.Exists("CLI." + list[i] + "_Example") ? Language.GetTextValue("CLI." + list[i] + "_Example") : Language.GetTextValue("CLI." + list[i] + "_Command"));
                        num = Math.Max(num, EstimatedMonospacedWidth(text3));
                    }
                    int num2 = (num + 1) / 8;
                    for (int j = 0; j < list.Count; j++)
                    {
                        string text4 = (Language.Exists("CLI." + list[j] + "_Example") ? Language.GetTextValue("CLI." + list[j] + "_Example") : Language.GetTextValue("CLI." + list[j] + "_Command"));
                        Console.WriteLine(text4 + new string('\t', num2 - EstimatedMonospacedWidth(text4) / 8) + Language.GetTextValue("CLI." + list[j] + "_Description"));
                    }
                }
                else if (Language.GetText("CLI.Settle_Command").EqualsCommand(text))
                {
                    if (!Liquid.panicMode)
                    {
                        Liquid.StartPanic();
                    }
                    else
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.WaterIsAlreadySettling"));
                    }
                }
                else if (Language.GetText("CLI.Dawn_Command").EqualsCommand(text))
                {
                    dayTime = true;
                    time = 0.0;
                    NetMessage.SendData(7);
                }
                else if (Language.GetText("CLI.Dusk_Command").EqualsCommand(text))
                {
                    dayTime = false;
                    time = 0.0;
                    NetMessage.SendData(7);
                }
                else if (Language.GetText("CLI.Noon_Command").EqualsCommand(text))
                {
                    dayTime = true;
                    time = 27000.0;
                    NetMessage.SendData(7);
                }
                else if (Language.GetText("CLI.Midnight_Command").EqualsCommand(text))
                {
                    dayTime = false;
                    time = 16200.0;
                    NetMessage.SendData(7);
                }
                else if (Language.GetText("CLI.ExitNoSave_Command").EqualsCommand(text))
                {
                    Netplay.SaveOnServerExit = false;
                    Netplay.Disconnect = true;
                }
                else if (Language.GetText("CLI.Exit_Command").EqualsCommand(text))
                {
                    Netplay.Disconnect = true;
                    SocialAPI.Shutdown();
                }
                else if (Language.GetText("CLI.FPS_Command").EqualsCommand(text))
                {
                    if (!dedServFPS)
                    {
                        dedServFPS = true;
                        fpsTimer.Reset();
                    }
                    else
                    {
                        dedServCount1 = 0;
                        dedServCount2 = 0;
                        dedServFPS = false;
                    }
                }
                else if (Language.GetText("CLI.Save_Command").EqualsCommand(text))
                {
                    WorldFile.SaveWorld();
                }
                else if (text.ToLower().StartsWith("time "))
                {
                    string timeArg = text2.Substring(5).Trim();
                    if (DateTime.TryParse(timeArg, out DateTime result))
                    {
                        double totalHours = result.TimeOfDay.TotalHours;
                        if (totalHours >= 4.5 && totalHours < 19.5)
                        {
                            dayTime = true;
                            time = (totalHours - 4.5) * 3600.0;
                        }
                        else
                        {
                            dayTime = false;
                            if (totalHours >= 19.5)
                                time = (totalHours - 19.5) * 3600.0;
                            else
                                time = (totalHours + 4.5) * 3600.0;
                        }
                        NetMessage.SendData(7);
                        Console.WriteLine($"Set time to {result.ToShortTimeString()}");
                    }
                    else
                    {
                        Console.WriteLine("Invalid time format.");
                    }
                }
                else if (Language.GetText("CLI.Time_Command").EqualsCommand(text))
                {
                    string textValue = Language.GetTextValue("GameUI.TimeAtMorning");
                    double num3 = time;
                    if (!dayTime)
                    {
                        num3 += 54000.0;
                    }
                    num3 = num3 / 86400.0 * 24.0;
                    double num4 = 7.5;
                    num3 = num3 - num4 - 12.0;
                    if (num3 < 0.0)
                    {
                        num3 += 24.0;
                    }
                    if (num3 >= 12.0)
                    {
                        textValue = Language.GetTextValue("GameUI.TimePastMorning");
                    }
                    int num5 = (int)num3;
                    double num6 = (int)((num3 - (double)num5) * 60.0);
                    string text5 = string.Concat(num6);
                    if (num6 < 10.0)
                    {
                        text5 = "0" + text5;
                    }
                    if (num5 > 12)
                    {
                        num5 -= 12;
                    }
                    if (num5 == 0)
                    {
                        num5 = 12;
                    }
                    Console.WriteLine(Language.GetTextValue("CLI.Time", num5 + ":" + text5 + " " + textValue));
                }
                else if (Language.GetText("CLI.MaxPlayers_Command").EqualsCommand(text))
                {
                    Console.WriteLine(Language.GetTextValue("CLI.PlayerLimit", maxNetPlayers));
                }
                else if (Language.GetText("CLI.Port_Command").EqualsCommand(text))
                {
                    Console.WriteLine(Language.GetTextValue("CLI.Port", Netplay.ListenPort));
                }
                else if (Language.GetText("CLI.Version_Command").EqualsCommand(text))
                {
                    Console.WriteLine(Language.GetTextValue("CLI.Server", versionNumber));
                }
                else if (Language.GetText("CLI.Clear_Command").EqualsCommand(text))
                {
                    try
                    {
                        Console.Clear();
                    }
                    catch
                    {
                    }
                }
                else if (Language.GetText("CLI.Playing_Command").EqualsCommand(text))
                {
                    int num7 = 0;
                    for (int k = 0; k < 255; k++)
                    {
                        if (player[k].active)
                        {
                            num7++;
                            Console.WriteLine(string.Concat(player[k].name, " (", Netplay.Clients[k].Socket.GetRemoteAddress(), ")"));
                        }
                    }
                    switch (num7)
                    {
                        case 0:
                            Console.WriteLine(Language.GetTextValue("CLI.NoPlayers"));
                            break;
                        case 1:
                            Console.WriteLine(Language.GetTextValue("CLI.OnePlayerConnected"));
                            break;
                        default:
                            Console.WriteLine(Language.GetTextValue("CLI.PlayersConnected", num7));
                            break;
                    }
                }
                else if (text.ToLower().StartsWith("delay "))
                {
                    if (int.TryParse(text2.Substring(6).Trim(), out int newDelay))
                    {
                        HunterDelay = newDelay;
                        Console.WriteLine($"Hunter Delay set to {HunterDelay} seconds per player.");
                    }
                    else
                    {
                        Console.WriteLine("Invalid number.");
                    }
                }
                else if (text.ToLower().StartsWith("i "))
                {
                    string argsRaw = text2.Substring(2).Trim();
                    string targetName = "";
                    string rest = "";

                    if (argsRaw.StartsWith("\""))
                    {
                        int end = argsRaw.IndexOf("\"", 1);
                        if (end != -1)
                        {
                            targetName = argsRaw.Substring(1, end - 1);
                            if (end + 1 < argsRaw.Length)
                                rest = argsRaw.Substring(end + 1).Trim();
                        }
                    }
                    else
                    {
                        int split = argsRaw.IndexOf(' ');
                        if (split != -1)
                        {
                            targetName = argsRaw.Substring(0, split);
                            rest = argsRaw.Substring(split + 1).Trim();
                        }
                        else
                        {
                            targetName = argsRaw;
                        }
                    }

                    string[] itemArgs = rest.Split(new char[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
                    if (itemArgs.Length > 0 && int.TryParse(itemArgs[0], out int itemID))
                    {
                        int amount = 1;
                        int prefix = 0;

                        if (itemArgs.Length > 1)
                            int.TryParse(itemArgs[1], out amount);
                        if (itemArgs.Length > 2)
                            int.TryParse(itemArgs[2], out prefix);

                        int count = 0;
                        for (int k = 0; k < 255; k++)
                        {
                            if (Main.player[k].active && (targetName == "@a" || Main.player[k].name.ToLower() == targetName.ToLower()))
                            {
                                count++;
                                int index = Item.NewItem(
                                    new EntitySource_DebugCommand(),
                                    (int)Main.player[k].Center.X,
                                    (int)Main.player[k].Center.Y,
                                    0, 0,
                                    itemID, amount, false, prefix, true
                                );

                                if (Main.netMode == 2)
                                    NetMessage.SendData(21, -1, -1, null, index, 1f);

                                Console.WriteLine($"Dropped {itemID} (x{amount}, pre:{prefix}) on {Main.player[k].name}");
                                if (targetName != "@a")
                                    break;
                            }
                        }
                        if (count == 0)
                            Console.WriteLine($"Player '{targetName}' not found.");
                    }
                    else
                    {
                        Console.WriteLine("Usage: i <\"player\"|@a> <ItemID> [Amount] [Prefix]");
                    }
                }
                else
                {
                    if (text == "")
                    {
                        continue;
                    }
                    string remainder;
                    if (Language.GetText("CLI.MOTD_Command").EqualsCommand(text))
                    {
                        if (motd == "")
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.NoMOTD", worldName));
                        }
                        else
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.MOTD", motd));
                        }
                    }
                    else if (Language.GetText("CLI.MOTD_Command").ParseCommandPrefix(text, out remainder))
                    {
                        motd = remainder;
                    }
                    else if (Language.GetText("CLI.Password_Command").EqualsCommand(text))
                    {
                        if (Netplay.ServerPassword == "")
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.NoPassword"));
                        }
                        else
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.Password", Netplay.ServerPassword));
                        }
                    }
                    else if (Language.GetText("CLI.SetPassword_Command").ParseCommandPrefix(text, out remainder))
                    {
                        if (string.IsNullOrWhiteSpace(remainder))
                        {
                            Netplay.ServerPassword = "";
                            Console.WriteLine(Language.GetTextValue("CLI.PasswordDisabled"));
                        }
                        else
                        {
                            Netplay.ServerPassword = remainder;
                            Console.WriteLine(Language.GetTextValue("CLI.PasswordSet", Netplay.ServerPassword));
                        }
                    }
                    else if (Language.GetText("CLI.Say_Command").ParseCommandPrefix(text, out remainder))
                    {
                        if (string.IsNullOrWhiteSpace(remainder))
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.Say_Usage"));
                            continue;
                        }
                        string text6 = remainder;
                        Console.WriteLine(Language.GetTextValue("CLI.ServerMessage", text6));
                        ChatHelper.BroadcastChatMessage(NetworkText.FromKey("CLI.ServerMessage", text6), new Microsoft.Xna.Framework.Color(255, 240, 20));
                    }
                    else if (Language.GetText("CLI.Kick_Command").ParseCommandPrefix(text, out remainder))
                    {
                        if (string.IsNullOrWhiteSpace(remainder))
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.Kick_Usage"));
                            continue;
                        }

                        string kickName = "";
                        string kickReason = "Kicked from server.";
                        string argsRaw = remainder.Trim();

                        if (argsRaw.StartsWith("\""))
                        {
                            int end = argsRaw.IndexOf("\"", 1);
                            if (end != -1)
                            {
                                kickName = argsRaw.Substring(1, end - 1);
                                if (end + 1 < argsRaw.Length)
                                    kickReason = argsRaw.Substring(end + 1).Trim();
                            }
                        }
                        else
                        {
                            int split = argsRaw.IndexOf(' ');
                            if (split != -1)
                            {
                                kickName = argsRaw.Substring(0, split);
                                kickReason = argsRaw.Substring(split + 1).Trim();
                            }
                            else { kickName = argsRaw; }
                        }

                        bool found = false;
                        for (int l = 0; l < 255; l++)
                        {
                            if (player[l].active && (kickName == "@a" || player[l].name.ToLower() == kickName.ToLower()))
                            {
                                NetMessage.SendData(2, l, -1, NetworkText.FromLiteral(kickReason));
                                found = true;
                                Console.WriteLine($"Kicked {player[l].name}: {kickReason}");
                            }
                        }
                        if (!found)
                            Console.WriteLine("Player not found.");
                    }
                    else if (Language.GetText("CLI.Seed_Command").EqualsCommand(text))
                    {
                        if (ActiveWorldFileData == null || !ActiveWorldFileData.HasValidSeed)
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.NoValidSeed"));
                        }
                        else
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.DisplaySeed", ActiveWorldFileData.GetFullSeedText()));
                        }
                    }
                    else if (Language.GetText("CLI.Ban_Command").ParseCommandPrefix(text, out remainder))
                    {
                        if (string.IsNullOrWhiteSpace(remainder))
                        {
                            Console.WriteLine(Language.GetTextValue("CLI.Ban_Usage"));
                            continue;
                        }

                        string banName = "";
                        string banReason = "Banned from server.";
                        string argsRaw = remainder.Trim();

                        if (argsRaw.StartsWith("\""))
                        {
                            int end = argsRaw.IndexOf("\"", 1);
                            if (end != -1)
                            {
                                banName = argsRaw.Substring(1, end - 1);
                                if (end + 1 < argsRaw.Length)
                                    banReason = argsRaw.Substring(end + 1).Trim();
                            }
                        }
                        else
                        {
                            int split = argsRaw.IndexOf(' ');
                            if (split != -1)
                            {
                                banName = argsRaw.Substring(0, split);
                                banReason = argsRaw.Substring(split + 1).Trim();
                            }
                            else { banName = argsRaw; }
                        }

                        bool found = false;
                        for (int m = 0; m < 255; m++)
                        {
                            if (player[m].active && (banName == "@a" || player[m].name.ToLower() == banName.ToLower()))
                            {
                                Netplay.AddBan(m);
                                NetMessage.SendData(2, m, -1, NetworkText.FromLiteral(banReason));
                                found = true;
                                Console.WriteLine($"Banned {player[m].name}: {banReason}");
                            }
                        }
                        if (!found)
                            Console.WriteLine("Player not found.");
                    }
                    else if (!ChatManager.DebugCommands.Process((byte)myPlayer, "/" + text))
                    {
                        Console.WriteLine(Language.GetTextValue("CLI.InvalidCommand"));
                    }
                    continue;
                }
            }
            catch
            {
                Console.WriteLine(Language.GetTextValue("CLI.InvalidCommand"));
            }
        }
    }

    private static int EstimatedMonospacedWidth(string text)
	{
		int num = 0;
		foreach (char c in text)
		{
			num = ((c >= '\u3000' && c <= 'ã¿') ? (num + 2) : ((c < 'ä¸' || c > 'é¿¿') ? (num + 1) : (num + 2)));
		}
		return num;
	}

	private static string ReadLineInput()
	{
		string text = null;
		do
		{
			text = Console.ReadLine();
		}
		while (text == null);
		return text;
	}

	public static bool IsFastForwardingTime()
	{
		if (!fastForwardTimeToDawn)
		{
			return fastForwardTimeToDusk;
		}
		return true;
	}

	public static void Sundialing()
	{
		if (sundialCooldown == 0)
		{
			if (netMode == 1)
			{
				NetMessage.SendData(51, -1, -1, null, myPlayer, 3f);
				return;
			}
			fastForwardTimeToDawn = true;
			sundialCooldown = 8;
			NetMessage.SendData(7);
		}
	}

	public static void Moondialing()
	{
		if (moondialCooldown == 0)
		{
			if (netMode == 1)
			{
				NetMessage.SendData(51, -1, -1, null, myPlayer, 6f);
				return;
			}
			fastForwardTimeToDusk = true;
			moondialCooldown = 8;
			NetMessage.SendData(7);
		}
	}

	public static void UpdateTimeRate()
	{
		if (IsFastForwardingTime())
		{
			dayRate = 60;
			desiredWorldTilesUpdateRate = 1;
			return;
		}
		bool enabled = CreativePowerManager.Instance.GetPower<CreativePowers.FreezeTime>().Enabled;
		int targetTimeRate = CreativePowerManager.Instance.GetPower<CreativePowers.ModifyTimeRate>().TargetTimeRate;
		bool flag = CurrentFrameFlags.SleepingPlayersCount == CurrentFrameFlags.ActivePlayersCount && CurrentFrameFlags.SleepingPlayersCount > 0;
		int num = targetTimeRate;
		if (!gameMenu && flag)
		{
			num *= 5;
		}
		if (enabled)
		{
			num = 0;
		}
		dayRate = num;
		desiredWorldTilesUpdateRate = num;
		if (gameMenu)
		{
			dayRate = 1;
			desiredWorldTilesUpdateRate = 1;
		}
	}

	public Main()
	{
		instance = this;
		UnpausedUpdateSeed = (ulong)Guid.NewGuid().GetHashCode();
		base.Exiting += Main_Exiting;
		if (!dedServ)
		{
			Map = new WorldMap(maxTilesX, maxTilesY);
			Configuration.Load();
			graphics = new GraphicsDeviceManager(this as Microsoft.Xna.Framework.Game);
			base.Content.RootDirectory = "Content";
		}
	}

	private static void SetDisplayMonitor()
	{
		Configuration.Get("Display", "");
		if (Program.IsXna)
		{
			graphics.PreparingDeviceSettings += SetMonitorOnce;
		}
	}

	private static void SetMonitorOnce(object sender, PreparingDeviceSettingsEventArgs e)
	{
		string displayName = Configuration.Get("Display", "");
		GraphicsAdapter graphicsAdapter = GraphicsAdapter.Adapters.Where((GraphicsAdapter adapter) => adapter.DeviceName == displayName).FirstOrDefault();
		if (graphicsAdapter != null)
		{
			e.GraphicsDeviceInformation.Adapter = graphicsAdapter;
		}
		graphics.PreparingDeviceSettings -= SetMonitorOnce;
	}

	protected void SetTitle(bool initialSetup = false)
	{
		if (!dedServ)
		{
			if (initialSetup)
			{
				_cachedTitle = Language.GetTextValue("UI.TerrariaLoadingTitle");
			}
			else
			{
				_cachedTitle = Lang.GetRandomGameTitle();
			}
			Platform.Get<IWindowService>().SetUnicodeTitle(base.Window, _cachedTitle);
			if (rand.Next(200) == 0)
			{
				boulderLogo = true;
			}
		}
	}

	private static void SetTileValue()
	{
		tileOreFinderPriority[28] = 100;
		tileOreFinderPriority[407] = 150;
		tileOreFinderPriority[404] = 150;
		tileOreFinderPriority[7] = 200;
		tileOreFinderPriority[166] = 210;
		tileOreFinderPriority[6] = 220;
		tileOreFinderPriority[167] = 230;
		tileOreFinderPriority[9] = 240;
		tileOreFinderPriority[168] = 250;
		tileOreFinderPriority[8] = 260;
		tileOreFinderPriority[169] = 270;
		tileOreFinderPriority[22] = 300;
		tileOreFinderPriority[204] = 310;
		tileOreFinderPriority[37] = 400;
		tileOreFinderPriority[21] = 500;
		tileOreFinderPriority[467] = 500;
		tileOreFinderPriority[441] = 500;
		tileOreFinderPriority[468] = 500;
		tileOreFinderPriority[12] = 550;
		tileOreFinderPriority[665] = 550;
		tileOreFinderPriority[639] = 550;
		tileOreFinderPriority[107] = 600;
		tileOreFinderPriority[221] = 610;
		tileOreFinderPriority[108] = 620;
		tileOreFinderPriority[222] = 630;
		tileOreFinderPriority[111] = 640;
		tileOreFinderPriority[223] = 650;
		tileOreFinderPriority[129] = 675;
		tileOreFinderPriority[211] = 700;
		tileOreFinderPriority[227] = 750;
		tileOreFinderPriority[656] = 760;
		tileOreFinderPriority[701] = 760;
		tileOreFinderPriority[751] = 770;
		tileOreFinderPriority[752] = 770;
		tileOreFinderPriority[236] = 810;
		tileOreFinderPriority[702] = 810;
	}

	private static void ResetGameCounter()
	{
		_gameUpdateCount = 65536u;
	}

	protected override void Initialize()
	{
		musicFade[50] = 1f;
		if (dedServ)
		{
			netMode = 2;
		}
		for (int i = 0; i < 10; i++)
		{
			recentWorld[i] = "";
			recentIP[i] = "";
			recentPort[i] = 0;
		}
		if (rand == null)
		{
			rand = new UnifiedRandom((int)DateTime.Now.Ticks);
		}
		SetTitle(initialSetup: true);
		lo = rand.Next(6);
		waterfallManager = new WaterfallManager();
		_windowMover = new WindowStateController();
		sittingManager = new AnchoredEntitiesCollection();
		sleepingManager = new AnchoredEntitiesCollection();
		gameTips = new GameTipsDisplay(new GameTipsProvider());
		if (player[myPlayer] == null)
		{
			player[myPlayer] = new Player();
		}
		ContentSamples.Initialize();
		PlayerInput.Initialize();
		player[myPlayer] = new Player();
		WorldGen.Hooks.OnWorldLoad += delegate
		{
			AmbienceServer = new AmbienceServer();
			LocalGolfState = new GolfState();
			if (!dedServ)
			{
				Lighting.Clear();
			}
		};
		DontStarveSeed.Initialize();
		ResourceSetsManager = new PlayerResourceSetsManager();
		MinimapFrameManagerInstance = new MinimapFrameManager();
		PlayerInput.OnActionableInput += delegate
		{
			LocalGolfState.CancelBallTracking();
		};
		BindSettingsTo(Configuration);
		if (dedServ)
		{
			Initialize_AlmostEverything();
			return;
		}
		LoadContent_TryEnteringHiDef();
		ClientInitialize();
		base.Initialize();
	}

	private void BindSettingsTo(Preferences preferences)
	{
		waterfallManager.BindTo(preferences);
		MinimapFrameManagerInstance.BindTo(preferences);
		BigBossProgressBar.BindTo(preferences);
		ResourceSetsManager.BindTo(preferences);
		ChromaInitializer.BindTo(preferences);
		Terraria.Graphics.Effects.Filters.Scene.BindTo(preferences);
		if (SocialAPI.Cloud != null)
		{
			SocialAPI.Cloud.BindTo(preferences);
		}
		preferences.OnSave += SaveResourcePacks;
		preferences.OnLoad += LoadResourcePacks;
	}

	private void LoadResourcePacks(Preferences prefs)
	{
		_lastLoadedPacks = prefs.Get("ResourcePacks", new JArray());
	}

	private void SaveResourcePacks(Preferences prefs)
	{
		JArray value = _lastLoadedPacks;
		if (AssetSourceController != null)
		{
			value = AssetSourceController.ActiveResourcePackList.ToJson();
		}
		prefs.Put("ResourcePacks", value);
	}

	private void Initialize_AlmostEverything()
	{
		TilePaintSystem = new TilePaintSystemV2();
		TilesRenderer = new TileDrawing(TilePaintSystem);
		WallsRenderer = new WallDrawing(TilePaintSystem);
		CreativePowerManager.Initialize();
		LocalFavoriteData.Load();
		CloudFavoritesData.Load();
		Initialize_Entities();
		FindAnnouncementBoxStatus();
		CustomCurrencyManager.Initialize();
		WingStatsInitializer.Load();
		TileObjectData.Initialize();
		Animation.Initialize();
		Chest.Initialize();
		Wiring.Initialize();
		Framing.Initialize();
		ItemRarity.Initialize();
		TileEntity.InitializeAll();
		Projectile.InitializeStaticThings();
		TorchID.Initialize();
		LeashedEntity.Registry.RegisterAll();
		NPCInteractions.Initialize();
		InitializeItemAnimations();
		BestiaryDatabase bestiaryDatabase = new BestiaryDatabase();
		BestiaryDatabaseNPCsPopulator bestiaryDatabaseNPCsPopulator = new BestiaryDatabaseNPCsPopulator();
		bestiaryDatabaseNPCsPopulator.Populate(bestiaryDatabase);
		BestiaryDB = bestiaryDatabase;
		ContentSamples.RebuildBestiarySortingIDsByBestiaryDatabaseContents(bestiaryDatabase);
		BestiaryTracker = new BestiaryUnlocksTracker();
		ItemDropDatabase itemDropDatabase = new ItemDropDatabase();
		itemDropDatabase.Populate();
		ItemDropsDB = itemDropDatabase;
		bestiaryDatabase.Merge(ItemDropsDB);
		bestiaryDatabaseNPCsPopulator.AddDropOverrides(bestiaryDatabase);
		FishDropRuleList fishDropRuleList = new FishDropRuleList();
		new GameContentFishDropPopulator(fishDropRuleList).Populate();
		FishDropsDB = fishDropRuleList;
		PylonSystem = new TeleportPylonsSystem();
		ItemDropSolver = new ItemDropResolver(itemDropDatabase);
		ShopHelper = new ShopHelper();
		CreativeItemSacrificesCatalog.Instance.Initialize();
		if (!dedServ)
		{
			BestiaryUI = new UIBestiaryTest(BestiaryDB);
			ContentThatNeedsRenderTargets.Add(MapPlayerRenderer);
		}
		if (!dedServ)
		{
			Lighting.Initialize();
			MapHelper.Initialize();
		}
		else
		{
			Mount.Initialize();
			Minecart.Initialize();
		}
		WorldGen.RandomizeBackgrounds(rand);
		if (treeBGSet1[0] == 173)
		{
			WorldGen.RandomizeBackgrounds(rand);
		}
		if (treeBGSet1[0] == 173)
		{
			WorldGen.RandomizeBackgrounds(rand);
		}
		WorldGen.RandomizeCaveBackgrounds();
		WorldGen.Hooks.Initialize();
		WorldGen.Hooks.OnWorldLoad += ResetGameCounter;
		bgAlphaFrontLayer[0] = 1f;
		bgAlphaFarBackLayer[0] = 1f;
		invBottom = 258;
		Initialize_TileAndNPCData1();
		Initialize_TileAndNPCData2();
		Initialize_Items();
		for (int i = 1; i < ProjectileID.Count; i++)
		{
			Projectile obj = new Projectile();
			obj.SetDefaults(i);
			if (obj.hostile)
			{
				projHostile[i] = true;
			}
			if (obj.aiStyle == 7)
			{
				projHook[i] = true;
			}
		}
		Recipe.SetupRecipeGroups();
		ConditionalDialogue.Init();
		ArmorSetBonuses.Initialize();
		ArmorSetBonuses.BuildLookup();
		ItemID.Sets.PostSetupContent();
		TileID.Sets.PostSetupContent();
		ConditionalDialogue.ItemGroups.PostSetupContent();
		DyeInitializer.Load();
		ContentSamples.DyeShaderIDs.Initialize();
		for (int j = 0; j < Recipe.maxRecipes; j++)
		{
			recipe[j] = new Recipe();
		}
		Recipe.SetupRecipes();
		ContentSamples.FixItemsAfterRecipesAreAdded();
		ItemSorting.SetupWhiteLists();
		ContentSamples.RebuildItemCreativeSortingIDsAfterRecipesAreSetUp();
		for (int k = 0; k < Liquid.maxLiquid; k++)
		{
			liquid[k] = new Liquid();
		}
		for (int l = 0; l < 50000; l++)
		{
			liquidBuffer[l] = new LiquidBuffer();
		}
		shop[0] = Chest.CreateShop();
		Chest.SetupTravelShop();
		for (int m = 1; m < 100; m++)
		{
			shop[m] = Chest.CreateShop();
			shop[m].SetupShop(m);
		}
		teamColor[0] = Microsoft.Xna.Framework.Color.White;
		teamColor[1] = new Microsoft.Xna.Framework.Color(218, 59, 59);
		teamColor[2] = new Microsoft.Xna.Framework.Color(59, 218, 85);
		teamColor[3] = new Microsoft.Xna.Framework.Color(59, 149, 218);
		teamColor[4] = new Microsoft.Xna.Framework.Color(242, 221, 100);
		teamColor[5] = new Microsoft.Xna.Framework.Color(224, 100, 242);
		Netplay.Initialize();
		NetworkInitializer.Load();
		ChatInitializer.Load();
		LucyAxeMessage.Initialize();
		if (Platform.IsWindows && !dedServ)
		{
			IntPtr systemMenu = GetSystemMenu(base.Window.Handle, bRevert: false);
			int menuItemCount = GetMenuItemCount(systemMenu);
			RemoveMenu(systemMenu, menuItemCount - 1, 1024);
		}
		if (!dedServ)
		{
			SoundID.FillAccessMap();
			Star.SpawnStars();
		}
	}

	private void Initialize_Entities()
	{
		for (int i = 0; i < maxMenuItems; i++)
		{
			menuItemScale[i] = 0.8f;
		}
		for (int j = 0; j < 6001; j++)
		{
			dust[j] = new Dust();
			dust[j].dustIndex = j;
		}
		for (int k = 0; k < 401; k++)
		{
			item[k] = new WorldItem();
			item[k].whoAmI = k;
		}
		for (int l = 0; l < maxNPCs + 1; l++)
		{
			npc[l] = new NPC();
			npc[l].whoAmI = l;
		}
		for (int m = 0; m < 256; m++)
		{
			player[m] = new Player();
			player[m].whoAmI = m;
		}
		for (int n = 0; n < 1001; n++)
		{
			projectile[n] = new Projectile();
			projectile[n].whoAmI = n;
		}
		for (int num = 0; num < 601; num++)
		{
			gore[num] = new Gore();
		}
		for (int num2 = 0; num2 < maxRain + 1; num2++)
		{
			rain[num2] = new Rain();
		}
		for (int num3 = 0; num3 < 200; num3++)
		{
			cloud[num3] = new Cloud();
		}
		for (int num4 = 0; num4 < 100; num4++)
		{
			combatText[num4] = new CombatText();
		}
		for (int num5 = 0; num5 < 20; num5++)
		{
			PopupText.popupText[num5] = new PopupText();
		}
	}

	private static void Initialize_Items()
	{
		for (int i = 0; i < ItemID.Count; i++)
		{
			Item item = new Item();
			item.SetDefaults(i);
			if (item.headSlot > 0)
			{
				Item.headType[item.headSlot] = item.type;
			}
			if (item.bodySlot > 0)
			{
				Item.bodyType[item.bodySlot] = item.type;
			}
			if (item.legSlot > 0)
			{
				Item.legType[item.legSlot] = item.type;
			}
			switch (item.type)
			{
			case 683:
			case 723:
			case 726:
			case 739:
			case 740:
			case 741:
			case 742:
			case 743:
			case 744:
			case 788:
			case 1296:
			case 1308:
			case 1326:
			case 1444:
			case 1445:
			case 1446:
			case 1801:
			case 1930:
			case 1931:
			case 2188:
			case 2750:
			case 3006:
			case 3051:
			case 3209:
			case 3210:
			case 3377:
			case 3476:
			case 3569:
			case 3571:
			case 3787:
			case 3852:
			case 3870:
			case 4062:
			case 5065:
				Item.staff[item.type] = true;
				break;
			case 1827:
				Item.claw[item.type] = true;
				break;
			}
		}
	}

	private static void Initialize_TileAndNPCData2()
	{
		critterCage = true;
		for (int i = 0; i < 3600; i++)
		{
			AnimateTiles_CritterCages();
		}
		critterCage = false;
		tileBlockLight[549] = true;
		tileBrick[477] = true;
		tileSolid[477] = true;
		tileBlockLight[477] = true;
		tileBrick[492] = true;
		tileSolid[492] = true;
		tileBlockLight[492] = true;
		tileSolidTop[275] = true;
		tileSolidTop[280] = true;
		tileSolidTop[276] = true;
		tileSolidTop[277] = true;
		tileSolidTop[278] = true;
		tileSolidTop[279] = true;
		tileSolidTop[281] = true;
		tileSolidTop[605] = true;
		tileSolidTop[604] = true;
		tileSolidTop[603] = true;
		tileSolidTop[602] = true;
		tileSolidTop[601] = true;
		tileSolidTop[599] = true;
		tileSolidTop[600] = true;
		tileSolidTop[612] = true;
		tileSolidTop[611] = true;
		tileSolidTop[610] = true;
		tileSolidTop[609] = true;
		tileSolidTop[608] = true;
		tileSolidTop[606] = true;
		tileSolidTop[607] = true;
		tileSolidTop[558] = true;
		tileSolidTop[554] = true;
		tileSolidTop[553] = true;
		tileSolidTop[551] = true;
		tileSolidTop[550] = true;
		tileSolidTop[542] = true;
		tileSolidTop[413] = true;
		tileSolidTop[309] = true;
		tileSolidTop[297] = true;
		tileSolidTop[296] = true;
		tileSolidTop[645] = true;
		tileSolidTop[643] = true;
		tileSolidTop[644] = true;
		tileSolidTop[632] = true;
		tileSolidTop[640] = true;
		tileSolidTop[559] = true;
		tileSolidTop[414] = true;
		tileSolidTop[359] = true;
		tileSolidTop[358] = true;
		tileSolidTop[285] = true;
		tileSolidTop[286] = true;
		tileSolidTop[582] = true;
		tileSolidTop[555] = true;
		tileSolidTop[538] = true;
		tileSolidTop[533] = true;
		tileSolidTop[532] = true;
		tileSolidTop[394] = true;
		tileSolidTop[393] = true;
		tileSolidTop[392] = true;
		tileSolidTop[391] = true;
		tileSolidTop[339] = true;
		tileSolidTop[310] = true;
		tileSolidTop[299] = true;
		tileSolidTop[298] = true;
		tileSolidTop[629] = true;
		tileSolidTop[619] = true;
		tileSolidTop[556] = true;
		tileSolidTop[544] = true;
		tileSolidTop[364] = true;
		tileSolidTop[363] = true;
		tileSolidTop[362] = true;
		tileSolidTop[361] = true;
		tileSolidTop[710] = true;
		tileTable[280] = true;
		tileTable[275] = true;
		tileTable[276] = true;
		tileTable[277] = true;
		tileTable[278] = true;
		tileTable[279] = true;
		tileTable[281] = true;
		tileTable[605] = true;
		tileTable[604] = true;
		tileTable[603] = true;
		tileTable[602] = true;
		tileTable[601] = true;
		tileTable[599] = true;
		tileTable[600] = true;
		tileTable[612] = true;
		tileTable[611] = true;
		tileTable[610] = true;
		tileTable[609] = true;
		tileTable[608] = true;
		tileTable[606] = true;
		tileTable[607] = true;
		tileTable[558] = true;
		tileTable[554] = true;
		tileTable[553] = true;
		tileTable[551] = true;
		tileTable[550] = true;
		tileTable[542] = true;
		tileTable[413] = true;
		tileTable[309] = true;
		tileTable[297] = true;
		tileTable[296] = true;
		tileTable[645] = true;
		tileTable[643] = true;
		tileTable[644] = true;
		tileTable[632] = true;
		tileTable[640] = true;
		tileTable[559] = true;
		tileTable[414] = true;
		tileTable[359] = true;
		tileTable[358] = true;
		tileTable[285] = true;
		tileTable[286] = true;
		tileTable[582] = true;
		tileTable[555] = true;
		tileTable[538] = true;
		tileTable[533] = true;
		tileTable[532] = true;
		tileTable[394] = true;
		tileTable[393] = true;
		tileTable[392] = true;
		tileTable[391] = true;
		tileTable[339] = true;
		tileTable[310] = true;
		tileTable[299] = true;
		tileTable[298] = true;
		tileTable[629] = true;
		tileTable[619] = true;
		tileTable[556] = true;
		tileTable[544] = true;
		tileTable[364] = true;
		tileTable[363] = true;
		tileTable[362] = true;
		tileTable[361] = true;
		tileTable[710] = true;
		tileBrick[1] = true;
		tileBrick[54] = true;
		tileBrick[118] = true;
		tileBrick[119] = true;
		tileBrick[120] = true;
		tileBrick[121] = true;
		tileBrick[122] = true;
		tileBrick[140] = true;
		tileBrick[148] = true;
		tileBrick[150] = true;
		tileBrick[151] = true;
		tileBrick[152] = true;
		tileBrick[30] = true;
		tileBrick[38] = true;
		tileBrick[39] = true;
		tileBrick[41] = true;
		tileBrick[43] = true;
		tileBrick[44] = true;
		tileBrick[481] = true;
		tileBrick[482] = true;
		tileBrick[483] = true;
		tileBrick[45] = true;
		tileBrick[46] = true;
		tileBrick[47] = true;
		tileBrick[75] = true;
		tileBrick[76] = true;
		tileBrick[160] = true;
		tileBrick[2] = true;
		tileBrick[199] = true;
		tileBrick[23] = true;
		tileBrick[60] = true;
		tileBrick[70] = true;
		tileBrick[109] = true;
		tileBrick[53] = true;
		tileBrick[57] = true;
		tileBrick[116] = true;
		tileBrick[234] = true;
		tileBrick[112] = true;
		tileBrick[147] = true;
		tileBrick[153] = true;
		tileBrick[154] = true;
		tileBrick[155] = true;
		tileBrick[156] = true;
		tileBrick[157] = true;
		tileBrick[158] = true;
		tileBrick[159] = true;
		tileBrick[273] = true;
		tileBrick[274] = true;
		tileMergeDirt[202] = true;
		tileBrick[202] = true;
		tileSolid[202] = true;
		tileBlockLight[202] = true;
		tileMergeDirt[498] = true;
		tileBrick[161] = true;
		tileBlockLight[161] = true;
		tileBlockLight[163] = true;
		tileBlockLight[164] = true;
		tileSolid[188] = true;
		tileBlockLight[188] = true;
		tileBrick[188] = true;
		tileMergeDirt[188] = true;
		tileBrick[179] = true;
		tileSolid[179] = true;
		tileBlockLight[179] = true;
		tileMoss[179] = true;
		tileBrick[381] = true;
		tileSolid[381] = true;
		tileBlockLight[381] = true;
		tileMoss[381] = true;
		tileBrick[534] = true;
		tileSolid[534] = true;
		tileBlockLight[534] = true;
		tileMoss[534] = true;
		tileBrick[536] = true;
		tileSolid[536] = true;
		tileBlockLight[536] = true;
		tileMoss[536] = true;
		tileBrick[539] = true;
		tileSolid[539] = true;
		tileBlockLight[539] = true;
		tileMoss[539] = true;
		tileBrick[625] = true;
		tileSolid[625] = true;
		tileBlockLight[625] = true;
		tileMoss[625] = true;
		tileBrick[627] = true;
		tileSolid[627] = true;
		tileBlockLight[627] = true;
		tileMoss[627] = true;
		tileBrick[180] = true;
		tileSolid[180] = true;
		tileBlockLight[180] = true;
		tileMoss[180] = true;
		tileBrick[181] = true;
		tileSolid[181] = true;
		tileBlockLight[181] = true;
		tileMoss[181] = true;
		tileBrick[182] = true;
		tileSolid[182] = true;
		tileBlockLight[182] = true;
		tileMoss[182] = true;
		tileBrick[183] = true;
		tileSolid[183] = true;
		tileBlockLight[183] = true;
		tileMoss[183] = true;
		tileBrick[512] = true;
		tileSolid[512] = true;
		tileBlockLight[512] = true;
		tileBrick[513] = true;
		tileSolid[513] = true;
		tileBlockLight[513] = true;
		tileBrick[514] = true;
		tileSolid[514] = true;
		tileBlockLight[514] = true;
		tileBrick[515] = true;
		tileSolid[515] = true;
		tileBlockLight[515] = true;
		tileBrick[516] = true;
		tileSolid[516] = true;
		tileBlockLight[516] = true;
		tileBrick[517] = true;
		tileSolid[517] = true;
		tileBlockLight[517] = true;
		tileLighted[517] = true;
		tileBrick[687] = true;
		tileSolid[687] = true;
		tileBlockLight[687] = true;
		tileLighted[687] = true;
		tileBrick[535] = true;
		tileSolid[535] = true;
		tileBlockLight[535] = true;
		tileLighted[535] = true;
		tileBrick[689] = true;
		tileSolid[689] = true;
		tileBlockLight[689] = true;
		tileLighted[689] = true;
		tileBrick[537] = true;
		tileSolid[537] = true;
		tileBlockLight[537] = true;
		tileLighted[537] = true;
		tileBrick[690] = true;
		tileSolid[690] = true;
		tileBlockLight[690] = true;
		tileLighted[690] = true;
		tileBrick[540] = true;
		tileSolid[540] = true;
		tileBlockLight[540] = true;
		tileLighted[540] = true;
		tileBrick[688] = true;
		tileSolid[688] = true;
		tileBlockLight[688] = true;
		tileLighted[688] = true;
		tileBrick[626] = true;
		tileSolid[626] = true;
		tileBlockLight[626] = true;
		tileLighted[626] = true;
		tileBrick[691] = true;
		tileSolid[691] = true;
		tileBlockLight[691] = true;
		tileLighted[691] = true;
		tileBrick[628] = true;
		tileSolid[628] = true;
		tileBlockLight[628] = true;
		tileLighted[628] = true;
		tileBrick[692] = true;
		tileSolid[692] = true;
		tileBlockLight[692] = true;
		tileLighted[692] = true;
		tileLighted[592] = true;
		tileLighted[656] = true;
		tileLighted[701] = true;
		tileLighted[356] = true;
		tileLighted[663] = true;
		tileMergeDirt[177] = true;
		tileMergeDirt[190] = true;
		tileSolid[196] = true;
		tileSolid[197] = true;
		tileMergeDirt[197] = true;
		tileBlockLight[197] = true;
		tileNoSunLight[197] = true;
		tileBrick[175] = true;
		tileSolid[175] = true;
		tileBlockLight[175] = true;
		tileBrick[176] = true;
		tileSolid[176] = true;
		tileBlockLight[176] = true;
		tileBrick[177] = true;
		tileSolid[177] = true;
		tileBlockLight[177] = true;
		tileBrick[225] = true;
		tileBrick[229] = true;
		tileShine[221] = 925;
		tileShine[222] = 875;
		tileShine[223] = 825;
		tileShine2[221] = true;
		tileShine2[222] = true;
		tileShine2[223] = true;
		tileMergeDirt[175] = true;
		tileMergeDirt[176] = true;
		tileMergeDirt[177] = true;
		tileMergeDirt[208] = true;
		tileBrick[162] = true;
		tileSolid[162] = true;
		tileBlockLight[162] = false;
		tileBrick[163] = true;
		tileSolid[163] = true;
		tileBrick[164] = true;
		tileSolid[164] = true;
		tileShine2[6] = true;
		tileShine2[7] = true;
		tileShine2[8] = true;
		tileShine2[9] = true;
		tileShine2[166] = true;
		tileShine2[167] = true;
		tileShine2[168] = true;
		tileShine2[169] = true;
		tileShine2[12] = true;
		tileShine2[21] = true;
		tileShine2[467] = true;
		tileShine2[441] = true;
		tileShine2[468] = true;
		tileShine2[22] = true;
		tileShine2[25] = true;
		tileShine2[45] = true;
		tileShine2[46] = true;
		tileShine2[47] = true;
		tileShine2[63] = true;
		tileShine2[64] = true;
		tileShine2[65] = true;
		tileShine2[66] = true;
		tileShine2[67] = true;
		tileShine2[68] = true;
		tileShine2[566] = true;
		tileShine2[107] = true;
		tileShine2[108] = true;
		tileShine2[111] = true;
		tileShine2[121] = true;
		tileShine2[122] = true;
		tileShine2[117] = true;
		tileShine2[211] = true;
		tileShine2[682] = true;
		tileShine2[681] = true;
		tileShine2[680] = true;
		tileShine2[685] = true;
		tileShine2[686] = true;
		tileShine[129] = 300;
		tileNoFail[81] = true;
		tileCracked[481] = true;
		tileCracked[482] = true;
		tileCracked[483] = true;
		tileNoFail[481] = true;
		tileNoFail[482] = true;
		tileNoFail[483] = true;
		tileNoFail[330] = true;
		tileNoFail[331] = true;
		tileNoFail[332] = true;
		tileNoFail[333] = true;
		tileNoFail[254] = true;
		tileNoFail[324] = true;
		tileNoFail[129] = true;
		tileNoFail[192] = true;
		tileHammer[26] = true;
		tileHammer[695] = true;
		tileHammer[31] = true;
		tileHammer[696] = true;
		tileAxe[5] = true;
		tileAxe[72] = true;
		tileAxe[80] = true;
		tileAxe[488] = true;
		tileAxe[704] = true;
		tileAxe[323] = true;
		tileAxe[596] = true;
		tileAxe[616] = true;
		tileAxe[634] = true;
		tileAxe[589] = true;
		tileAxe[584] = true;
		tileAxe[588] = true;
		tileAxe[586] = true;
		tileAxe[587] = true;
		tileAxe[585] = true;
		tileAxe[583] = true;
		tileBrick[59] = true;
		tileBrick[234] = true;
		tileSolid[234] = true;
		tileMergeDirt[234] = true;
		tileSand[53] = true;
		tileSand[112] = true;
		tileSand[116] = true;
		tileSand[234] = true;
		tileFrameImportant[630] = true;
		tileLavaDeath[630] = true;
		tileNoSunLight[630] = true;
		tileFrameImportant[631] = true;
		tileLavaDeath[631] = true;
		tileNoSunLight[631] = true;
		tileFrameImportant[571] = true;
		tileLavaDeath[571] = true;
		tileFrameImportant[579] = true;
		tileLavaDeath[579] = true;
		tileFrameImportant[591] = true;
		tileLavaDeath[591] = true;
		tileFrameImportant[592] = true;
		tileLavaDeath[592] = false;
		tileFrameImportant[538] = true;
		tileLavaDeath[538] = true;
		tileFrameImportant[544] = true;
		tileLavaDeath[544] = true;
		tileFrameImportant[629] = true;
		tileLavaDeath[629] = true;
		tileFrameImportant[550] = true;
		tileLavaDeath[550] = true;
		tileFrameImportant[551] = true;
		tileLavaDeath[551] = true;
		tileFrameImportant[533] = true;
		tileLavaDeath[533] = true;
		tileFrameImportant[553] = true;
		tileLavaDeath[553] = true;
		tileFrameImportant[554] = true;
		tileLavaDeath[554] = true;
		tileFrameImportant[555] = true;
		tileLavaDeath[555] = true;
		tileFrameImportant[556] = true;
		tileLavaDeath[556] = true;
		tileFrameImportant[558] = true;
		tileLavaDeath[558] = true;
		tileFrameImportant[559] = true;
		tileLavaDeath[559] = true;
		tileFrameImportant[599] = true;
		tileLavaDeath[599] = true;
		tileFrameImportant[600] = true;
		tileLavaDeath[600] = true;
		tileFrameImportant[601] = true;
		tileLavaDeath[601] = true;
		tileFrameImportant[602] = true;
		tileLavaDeath[602] = true;
		tileFrameImportant[603] = true;
		tileLavaDeath[603] = true;
		tileFrameImportant[604] = true;
		tileLavaDeath[604] = true;
		tileFrameImportant[605] = true;
		tileLavaDeath[605] = true;
		tileFrameImportant[606] = true;
		tileLavaDeath[606] = true;
		tileFrameImportant[607] = true;
		tileLavaDeath[607] = true;
		tileFrameImportant[608] = true;
		tileLavaDeath[608] = true;
		tileFrameImportant[609] = true;
		tileLavaDeath[609] = true;
		tileFrameImportant[610] = true;
		tileLavaDeath[610] = true;
		tileFrameImportant[611] = true;
		tileLavaDeath[611] = true;
		tileFrameImportant[612] = true;
		tileLavaDeath[612] = true;
		tileFrameImportant[632] = true;
		tileLavaDeath[632] = true;
		tileFrameImportant[640] = true;
		tileLavaDeath[640] = true;
		tileFrameImportant[643] = true;
		tileLavaDeath[643] = true;
		tileFrameImportant[644] = true;
		tileLavaDeath[644] = true;
		tileFrameImportant[645] = true;
		tileLavaDeath[645] = true;
		tileFrameImportant[710] = true;
		tileLavaDeath[710] = true;
		tileFrameImportant[568] = true;
		tileNoAttach[568] = true;
		tileLavaDeath[568] = true;
		tileLighted[568] = true;
		tileFrameImportant[569] = true;
		tileNoAttach[569] = true;
		tileLavaDeath[569] = true;
		tileLighted[569] = true;
		tileFrameImportant[570] = true;
		tileNoAttach[570] = true;
		tileLavaDeath[570] = true;
		tileLighted[570] = true;
		tileFrameImportant[580] = true;
		tileNoAttach[580] = true;
		tileLavaDeath[580] = true;
		tileLighted[580] = true;
		tileFrameImportant[582] = true;
		tileLavaDeath[582] = true;
		tileLighted[582] = true;
		tileFrameImportant[619] = true;
		tileLavaDeath[619] = true;
		tileLighted[619] = true;
		tileFrameImportant[620] = true;
		tileNoAttach[620] = true;
		tileLavaDeath[620] = true;
		tileLighted[620] = true;
		tileFrameImportant[572] = true;
		tileNoAttach[572] = true;
		tileLavaDeath[572] = true;
		tileLighted[572] = true;
		tileFrameImportant[560] = true;
		tileLavaDeath[560] = true;
		tileFrameImportant[564] = true;
		tileNoAttach[564] = true;
		tileLavaDeath[564] = true;
		tileLighted[564] = true;
		tileFrameImportant[567] = true;
		tileLavaDeath[567] = true;
		tileFrameImportant[565] = true;
		tileNoAttach[565] = true;
		tileLavaDeath[565] = true;
		tileFrameImportant[593] = true;
		tileNoAttach[593] = true;
		tileLavaDeath[593] = false;
		tileLighted[593] = true;
		tileFrameImportant[594] = true;
		tileNoAttach[594] = true;
		tileLavaDeath[594] = false;
		tileLighted[594] = true;
		tileLighted[548] = true;
		tileLighted[613] = true;
		tileLighted[614] = true;
		tileFrameImportant[654] = true;
		tileCut[654] = true;
		tileNoFail[654] = true;
		tileLavaDeath[654] = true;
		tileFrameImportant[518] = true;
		tileCut[518] = true;
		tileNoFail[518] = true;
		tileFrameImportant[519] = true;
		tileCut[519] = true;
		tileNoFail[519] = true;
		tileLighted[519] = true;
		tileFrameImportant[549] = true;
		tileCut[549] = true;
		tileNoFail[549] = true;
		tileFrameImportant[529] = true;
		tileCut[529] = true;
		tileNoFail[529] = true;
		tileLavaDeath[529] = true;
		tileFrameImportant[637] = true;
		tileCut[637] = true;
		tileNoFail[637] = true;
		tileLavaDeath[637] = false;
		tileLighted[637] = true;
		tileFrameImportant[530] = true;
		tileNoFail[530] = true;
		tileLavaDeath[530] = true;
		tileFrameImportant[705] = true;
		tileNoFail[705] = true;
		tileLavaDeath[705] = true;
		tileFrameImportant[233] = true;
		tileFrameImportant[485] = true;
		tileLighted[215] = true;
		tileFrameImportant[227] = true;
		tileFrameImportant[228] = true;
		tileFrameImportant[231] = true;
		tileCut[231] = true;
		tileFrameImportant[216] = true;
		tileFrameImportant[217] = true;
		tileFrameImportant[218] = true;
		tileFrameImportant[219] = true;
		tileFrameImportant[642] = true;
		tileFrameImportant[220] = true;
		tileFrameImportant[338] = true;
		tileFrameImportant[453] = true;
		tileFrameImportant[456] = true;
		tileFrameImportant[165] = true;
		tileFrameImportant[209] = true;
		tileFrameImportant[215] = true;
		tileFrameImportant[210] = true;
		tileFrameImportant[212] = true;
		tileFrameImportant[207] = true;
		tileFrameImportant[178] = true;
		tileFrameImportant[184] = true;
		tileFrameImportant[185] = true;
		tileFrameImportant[186] = true;
		tileFrameImportant[187] = true;
		tileFrameImportant[173] = true;
		tileFrameImportant[174] = true;
		tileLighted[173] = true;
		tileLighted[174] = true;
		tileFrameImportant[139] = true;
		tileLighted[160] = true;
		tileLighted[149] = true;
		tileFrameImportant[149] = true;
		tileFrameImportant[142] = true;
		tileFrameImportant[143] = true;
		tileFrameImportant[144] = true;
		tileStone[131] = true;
		tileFrameImportant[136] = true;
		tileFrameImportant[137] = true;
		tileFrameImportant[138] = true;
		tileFrameImportant[664] = true;
		tileFrameImportant[665] = true;
		tileFrameImportant[484] = true;
		tileFrameImportant[711] = true;
		tileFrameImportant[712] = true;
		tileFrameImportant[713] = true;
		tileFrameImportant[714] = true;
		tileFrameImportant[715] = true;
		tileFrameImportant[716] = true;
		tileLavaDeath[484] = true;
		tileNoFail[484] = true;
		tileBlockLight[137] = true;
		tileSolid[137] = true;
		tileBlockLight[160] = true;
		tileSolid[160] = true;
		tileMergeDirt[160] = true;
		tileBlockLight[161] = true;
		tileSolid[161] = true;
		tileBlockLight[145] = true;
		tileSolid[145] = true;
		tileMergeDirt[145] = true;
		tileBlockLight[146] = true;
		tileSolid[146] = true;
		tileMergeDirt[146] = true;
		tileBlockLight[147] = true;
		tileSolid[147] = true;
		tileBlockLight[148] = true;
		tileSolid[148] = true;
		tileMergeDirt[148] = true;
		tileSolid[138] = true;
		tileSolid[664] = true;
		tileSolid[484] = true;
		tileSolid[711] = true;
		tileCut[484] = true;
		tileCut[711] = true;
		tileLighted[711] = true;
		tileSolid[712] = true;
		tileSolid[713] = true;
		tileSolid[714] = true;
		tileSolid[715] = true;
		tileSolid[716] = true;
		tileBlockLight[140] = true;
		tileSolid[140] = true;
		tileBlockLight[151] = true;
		tileSolid[151] = true;
		tileMergeDirt[151] = true;
		tileBlockLight[152] = true;
		tileSolid[152] = true;
		tileMergeDirt[152] = true;
		tileBlockLight[153] = true;
		tileSolid[153] = true;
		tileMergeDirt[153] = true;
		tileBlockLight[154] = true;
		tileSolid[154] = true;
		tileMergeDirt[154] = true;
		tileBlockLight[155] = true;
		tileSolid[155] = true;
		tileMergeDirt[155] = true;
		tileBlockLight[156] = true;
		tileSolid[156] = true;
		tileMergeDirt[156] = true;
		tileMergeDirt[150] = true;
		tileBlockLight[157] = true;
		tileSolid[157] = true;
		tileMergeDirt[157] = true;
		tileBlockLight[158] = true;
		tileSolid[158] = true;
		tileMergeDirt[158] = true;
		tileBlockLight[159] = true;
		tileSolid[159] = true;
		tileMergeDirt[159] = true;
		tileFrameImportant[320] = true;
		tileFrameImportant[49] = true;
		tileShine[22] = 1150;
		tileShine[6] = 1150;
		tileShine[7] = 1100;
		tileShine[8] = 1000;
		tileShine[9] = 1050;
		tileShine[166] = 1125;
		tileShine[167] = 1075;
		tileShine[168] = 1025;
		tileShine[169] = 975;
		tileShine[617] = 400;
		tileShine[178] = 500;
		tileShine2[178] = true;
		tileShine[12] = 300;
		tileShine[21] = 1200;
		tileShine[467] = 1200;
		tileShine[441] = 1200;
		tileShine[468] = 1200;
		tileShine[63] = 900;
		tileShine[64] = 900;
		tileShine[65] = 900;
		tileShine[66] = 900;
		tileShine[67] = 900;
		tileShine[68] = 900;
		tileShine[566] = 900;
		tileShine[45] = 1900;
		tileShine[680] = 1900;
		tileShine[46] = 2000;
		tileShine[681] = 2000;
		tileShine[47] = 2100;
		tileShine[682] = 2100;
		tileShine[122] = 1800;
		tileShine[686] = 1800;
		tileShine[121] = 1850;
		tileShine[685] = 1850;
		tileShine[125] = 600;
		tileShine[109] = 9000;
		tileShine[110] = 9000;
		tileShine[116] = 9000;
		tileShine[117] = 9000;
		tileShine[118] = 8000;
		tileShine[107] = 950;
		tileShine[108] = 900;
		tileShine[111] = 850;
		tileShine[211] = 500;
		tileLighted[699] = true;
		tileLighted[4] = true;
		tileLighted[17] = true;
		tileLighted[133] = true;
		tileLighted[31] = true;
		tileLighted[696] = true;
		tileLighted[33] = true;
		tileLighted[34] = true;
		tileLighted[35] = true;
		tileLighted[37] = true;
		tileLighted[42] = true;
		tileLighted[49] = true;
		tileLighted[58] = true;
		tileLighted[61] = true;
		tileLighted[703] = true;
		tileLighted[70] = true;
		tileLighted[71] = true;
		tileLighted[72] = true;
		tileLighted[76] = true;
		tileLighted[684] = true;
		tileLighted[77] = true;
		tileLighted[19] = true;
		tileLighted[22] = true;
		tileLighted[26] = true;
		tileLighted[695] = true;
		tileLighted[83] = true;
		tileLighted[84] = true;
		tileLighted[92] = true;
		tileLighted[93] = true;
		tileLighted[95] = true;
		tileLighted[98] = true;
		tileLighted[100] = true;
		tileLighted[109] = true;
		tileLighted[125] = true;
		tileLighted[126] = true;
		tileLighted[129] = true;
		tileLighted[140] = true;
		tileLighted[270] = true;
		tileLighted[271] = true;
		tileLighted[581] = true;
		tileLighted[660] = true;
		tileLighted[578] = true;
		tileMergeDirt[1] = true;
		tileMergeDirt[6] = true;
		tileMergeDirt[7] = true;
		tileMergeDirt[8] = true;
		tileMergeDirt[9] = true;
		tileMergeDirt[166] = true;
		tileMergeDirt[167] = true;
		tileMergeDirt[168] = true;
		tileMergeDirt[169] = true;
		tileMergeDirt[22] = true;
		tileMergeDirt[25] = true;
		tileMergeDirt[30] = true;
		tileMergeDirt[37] = true;
		tileMergeDirt[38] = true;
		tileMergeDirt[40] = true;
		tileMergeDirt[53] = true;
		tileMergeDirt[56] = true;
		tileMergeDirt[107] = true;
		tileMergeDirt[108] = true;
		tileMergeDirt[111] = true;
		tileMergeDirt[112] = true;
		tileMergeDirt[116] = true;
		tileMergeDirt[117] = true;
		tileMergeDirt[123] = true;
		tileMergeDirt[140] = true;
		tileMergeDirt[39] = true;
		tileMergeDirt[122] = true;
		tileMergeDirt[121] = true;
		tileMergeDirt[120] = true;
		tileMergeDirt[119] = true;
		tileMergeDirt[118] = true;
		tileMergeDirt[47] = true;
		tileMergeDirt[46] = true;
		tileMergeDirt[45] = true;
		tileMergeDirt[41] = true;
		tileMergeDirt[43] = true;
		tileMergeDirt[44] = true;
		tileMergeDirt[481] = true;
		tileMergeDirt[482] = true;
		tileMergeDirt[483] = true;
		tileFrameImportant[380] = true;
		tileFrameImportant[201] = true;
		tileFrameImportant[3] = true;
		tileFrameImportant[4] = true;
		tileFrameImportant[5] = true;
		tileFrameImportant[10] = true;
		tileFrameImportant[11] = true;
		tileFrameImportant[12] = true;
		tileFrameImportant[13] = true;
		tileFrameImportant[14] = true;
		tileFrameImportant[469] = true;
		tileFrameImportant[486] = true;
		tileFrameImportant[488] = true;
		tileFrameImportant[704] = true;
		tileFrameImportant[487] = true;
		tileFrameImportant[489] = true;
		tileFrameImportant[490] = true;
		tileFrameImportant[15] = true;
		tileFrameImportant[497] = true;
		tileFrameImportant[16] = true;
		tileFrameImportant[17] = true;
		tileFrameImportant[18] = true;
		tileFrameImportant[19] = true;
		tileFrameImportant[20] = true;
		tileFrameImportant[21] = true;
		tileFrameImportant[467] = true;
		tileFrameImportant[441] = true;
		tileFrameImportant[468] = true;
		tileFrameImportant[24] = true;
		tileFrameImportant[26] = true;
		tileFrameImportant[695] = true;
		tileFrameImportant[27] = true;
		tileFrameImportant[28] = true;
		tileFrameImportant[29] = true;
		tileFrameImportant[31] = true;
		tileFrameImportant[696] = true;
		tileFrameImportant[33] = true;
		tileFrameImportant[34] = true;
		tileFrameImportant[35] = true;
		tileFrameImportant[42] = true;
		tileFrameImportant[50] = true;
		tileFrameImportant[707] = true;
		tileFrameImportant[55] = true;
		tileFrameImportant[61] = true;
		tileFrameImportant[703] = true;
		tileFrameImportant[71] = true;
		tileFrameImportant[72] = true;
		tileFrameImportant[73] = true;
		tileFrameImportant[74] = true;
		tileFrameImportant[77] = true;
		tileFrameImportant[78] = true;
		tileFrameImportant[79] = true;
		tileFrameImportant[81] = true;
		tileFrameImportant[82] = true;
		tileFrameImportant[83] = true;
		tileFrameImportant[84] = true;
		tileFrameImportant[85] = true;
		tileFrameImportant[86] = true;
		tileFrameImportant[87] = true;
		tileFrameImportant[88] = true;
		tileFrameImportant[89] = true;
		tileFrameImportant[90] = true;
		tileFrameImportant[91] = true;
		tileFrameImportant[92] = true;
		tileFrameImportant[93] = true;
		tileFrameImportant[94] = true;
		tileFrameImportant[95] = true;
		tileFrameImportant[96] = true;
		tileFrameImportant[97] = true;
		tileFrameImportant[98] = true;
		tileFrameImportant[99] = true;
		tileFrameImportant[101] = true;
		tileFrameImportant[102] = true;
		tileFrameImportant[103] = true;
		tileFrameImportant[104] = true;
		tileFrameImportant[105] = true;
		tileFrameImportant[100] = true;
		tileFrameImportant[106] = true;
		tileFrameImportant[110] = true;
		tileFrameImportant[113] = true;
		tileFrameImportant[114] = true;
		tileFrameImportant[125] = true;
		tileFrameImportant[287] = true;
		tileFrameImportant[126] = true;
		tileFrameImportant[128] = true;
		tileFrameImportant[129] = true;
		tileFrameImportant[132] = true;
		tileFrameImportant[133] = true;
		tileFrameImportant[134] = true;
		tileFrameImportant[135] = true;
		tileFrameImportant[172] = true;
		tileFrameImportant[319] = true;
		tileFrameImportant[323] = true;
		tileFrameImportant[335] = true;
		tileFrameImportant[337] = true;
		tileFrameImportant[349] = true;
		tileFrameImportant[376] = true;
		tileFrameImportant[378] = true;
		tileFrameImportant[425] = true;
		tileFrameImportant[465] = true;
		tileFrameImportant[506] = true;
		tileFrameImportant[510] = true;
		tileFrameImportant[511] = true;
		tileFrameImportant[531] = true;
		tileFrameImportant[545] = true;
		tileFrameImportant[547] = true;
		tileFrameImportant[548] = true;
		tileFrameImportant[552] = true;
		tileFrameImportant[573] = true;
		tileFrameImportant[613] = true;
		tileFrameImportant[614] = true;
		tileFrameImportant[621] = true;
		tileFrameImportant[622] = true;
		tileFrameImportant[623] = true;
		tileFrameImportant[624] = true;
		tileFrameImportant[700] = true;
		tileFrameImportant[656] = true;
		tileFrameImportant[701] = true;
		tileFrameImportant[141] = true;
		tileFrameImportant[270] = true;
		tileFrameImportant[271] = true;
		tileFrameImportant[581] = true;
		tileFrameImportant[660] = true;
		tileFrameImportant[314] = true;
		tileFrameImportant[698] = true;
		tileSolidTop[376] = true;
		tileTable[376] = true;
		tileTable[380] = true;
		tileFrameImportant[583] = true;
		tileFrameImportant[584] = true;
		tileFrameImportant[585] = true;
		tileFrameImportant[586] = true;
		tileFrameImportant[587] = true;
		tileFrameImportant[588] = true;
		tileFrameImportant[589] = true;
		tileFrameImportant[590] = true;
		tileNoAttach[590] = true;
		tileFrameImportant[595] = true;
		tileNoAttach[595] = true;
		tileFrameImportant[596] = true;
		tileFrameImportant[615] = true;
		tileNoAttach[615] = true;
		tileFrameImportant[616] = true;
		tileFrameImportant[634] = true;
		tileCut[201] = true;
		tileCut[3] = true;
		tileCut[24] = true;
		tileCut[28] = true;
		tileCut[32] = true;
		tileCut[51] = true;
		tileCut[52] = true;
		tileCut[61] = true;
		tileCut[62] = true;
		tileCut[69] = true;
		tileCut[655] = true;
		tileCut[71] = true;
		tileCut[73] = true;
		tileCut[74] = true;
		tileCut[82] = true;
		tileCut[83] = true;
		tileCut[84] = true;
		tileCut[110] = true;
		tileCut[113] = true;
		tileCut[115] = true;
		tileCut[184] = true;
		tileCut[205] = true;
		tileCut[352] = true;
		tileCut[382] = true;
		tileCut[528] = true;
		tileLighted[528] = true;
		tileCut[636] = true;
		tileCut[638] = true;
		tileCut[444] = true;
		tileCut[485] = true;
		tileAlch[82] = true;
		tileAlch[83] = true;
		tileAlch[84] = true;
		tileSolid[127] = true;
		tileSolid[130] = true;
		tileBlockLight[130] = true;
		tileBlockLight[131] = true;
		tileSolid[107] = true;
		tileBlockLight[107] = true;
		tileSolid[108] = true;
		tileBlockLight[108] = true;
		tileSolid[111] = true;
		tileBlockLight[111] = true;
		tileSolid[109] = true;
		tileBlockLight[109] = true;
		tileSolid[110] = false;
		tileNoAttach[110] = true;
		tileNoFail[110] = true;
		tileSolid[112] = true;
		tileBlockLight[112] = true;
		tileSolid[116] = true;
		tileBlockLight[116] = true;
		tileBrick[117] = true;
		tileBrick[25] = true;
		tileBrick[203] = true;
		tileSolid[117] = true;
		tileBlockLight[117] = true;
		tileSolid[123] = true;
		tileBlockLight[123] = true;
		tileNoFail[165] = true;
		tileNoFail[184] = true;
		tileNoFail[185] = true;
		tileNoFail[186] = true;
		tileNoFail[187] = true;
		tileSolid[118] = true;
		tileBlockLight[118] = true;
		tileSolid[119] = true;
		tileBlockLight[119] = true;
		tileSolid[120] = true;
		tileBlockLight[120] = true;
		tileSolid[121] = true;
		tileBlockLight[121] = true;
		tileSolid[122] = true;
		tileBlockLight[122] = true;
		tileSolid[150] = true;
		tileBlockLight[150] = true;
		tileBlockLight[115] = true;
		tileSolid[199] = true;
		tileBlockLight[199] = true;
		tileNoFail[162] = true;
		tileSolid[0] = true;
		tileBlockLight[0] = true;
		tileSolid[1] = true;
		tileBlockLight[1] = true;
		tileSolid[2] = true;
		tileBlockLight[2] = true;
		tileSolid[3] = false;
		tileNoAttach[3] = true;
		tileNoFail[3] = true;
		tileNoFail[201] = true;
		tileSolid[4] = false;
		tileNoAttach[4] = true;
		tileNoFail[4] = true;
		tileNoFail[24] = true;
		tileSolid[5] = false;
		tileSolid[6] = true;
		tileBlockLight[6] = true;
		tileSolid[7] = true;
		tileBlockLight[7] = true;
		tileSolid[8] = true;
		tileBlockLight[8] = true;
		tileSolid[9] = true;
		tileBlockLight[9] = true;
		tileSolid[166] = true;
		tileBlockLight[166] = true;
		tileSolid[167] = true;
		tileBlockLight[167] = true;
		tileSolid[168] = true;
		tileBlockLight[168] = true;
		tileSolid[169] = true;
		tileBlockLight[169] = true;
		tileBlockLight[10] = true;
		tileSolid[10] = true;
		tileNoAttach[10] = true;
		tileBlockLight[10] = true;
		tileSolid[11] = false;
		tileSolidTop[19] = true;
		tileSolid[19] = true;
		tileSolid[22] = true;
		tileSolid[23] = true;
		tileSolid[25] = true;
		tileSolid[30] = true;
		tileNoFail[32] = true;
		tileBlockLight[32] = true;
		tileNoFail[352] = true;
		tileBlockLight[352] = true;
		tileSolid[37] = true;
		tileBlockLight[37] = true;
		tileSolid[38] = true;
		tileBlockLight[38] = true;
		tileSolid[39] = true;
		tileBlockLight[39] = true;
		tileSolid[40] = true;
		tileBlockLight[40] = true;
		tileSolid[41] = true;
		tileBlockLight[41] = true;
		tileSolid[43] = true;
		tileBlockLight[43] = true;
		tileSolid[44] = true;
		tileBlockLight[44] = true;
		tileSolid[481] = true;
		tileBlockLight[481] = true;
		tileSolid[482] = true;
		tileBlockLight[482] = true;
		tileSolid[483] = true;
		tileBlockLight[483] = true;
		tileSolid[634] = false;
		tileFrameImportant[634] = true;
		tileLavaDeath[634] = false;
		tileBlockLight[634] = false;
		tileLighted[634] = true;
		tileLighted[20] = true;
		tileSolid[45] = true;
		tileBlockLight[45] = true;
		tileSolid[46] = true;
		tileBlockLight[46] = true;
		tileSolid[47] = true;
		tileBlockLight[47] = true;
		tileSolid[48] = true;
		tileSolid[53] = true;
		tileBlockLight[53] = true;
		tileSolid[54] = true;
		tileBlockLight[52] = true;
		tileBlockLight[205] = true;
		tileSolid[56] = true;
		tileBlockLight[56] = true;
		tileSolid[57] = true;
		tileBlockLight[57] = true;
		tileSolid[58] = true;
		tileBlockLight[58] = true;
		tileBlockLight[382] = true;
		tileSolid[59] = true;
		tileBlockLight[59] = true;
		tileSolid[60] = true;
		tileBlockLight[60] = true;
		tileSolid[63] = true;
		tileBlockLight[63] = true;
		tileStone[63] = true;
		tileStone[130] = true;
		tileSolid[64] = true;
		tileBlockLight[64] = true;
		tileStone[64] = true;
		tileSolid[65] = true;
		tileBlockLight[65] = true;
		tileStone[65] = true;
		tileSolid[66] = true;
		tileBlockLight[66] = true;
		tileStone[66] = true;
		tileSolid[67] = true;
		tileBlockLight[67] = true;
		tileStone[67] = true;
		tileSolid[68] = true;
		tileBlockLight[68] = true;
		tileStone[68] = true;
		tileSolid[566] = true;
		tileBlockLight[566] = true;
		tileStone[566] = true;
		tileSolid[75] = true;
		tileBlockLight[75] = true;
		tileBrick[633] = true;
		tileSolid[633] = true;
		tileBlockLight[633] = true;
		tileLighted[633] = true;
		tileSolid[76] = true;
		tileBlockLight[76] = true;
		tileSolid[70] = true;
		tileBlockLight[70] = true;
		tileSolid[661] = true;
		tileBlockLight[661] = true;
		tileBrick[661] = true;
		tileSolid[662] = true;
		tileBlockLight[662] = true;
		tileBrick[662] = true;
		tileNoFail[50] = true;
		tileNoAttach[50] = true;
		tileNoAttach[707] = true;
		tileDungeon[41] = true;
		tileDungeon[43] = true;
		tileDungeon[44] = true;
		tileDungeon[677] = true;
		tileDungeon[678] = true;
		tileDungeon[679] = true;
		tileBlockLight[30] = true;
		tileBlockLight[25] = true;
		tileBlockLight[23] = true;
		tileBlockLight[22] = true;
		tileBlockLight[62] = true;
		tileSolidTop[18] = true;
		tileSolidTop[14] = true;
		tileSolidTop[469] = true;
		tileSolidTop[16] = true;
		tileSolidTop[134] = true;
		tileSolidTop[114] = true;
		tileNoAttach[20] = true;
		tileNoAttach[19] = true;
		tileNoAttach[13] = true;
		tileNoAttach[14] = true;
		tileNoAttach[469] = true;
		tileNoAttach[486] = true;
		tileNoAttach[488] = true;
		tileNoAttach[704] = true;
		tileNoAttach[487] = true;
		tileNoAttach[489] = true;
		tileNoAttach[490] = true;
		tileNoAttach[15] = true;
		tileNoAttach[497] = true;
		tileNoAttach[16] = true;
		tileNoAttach[134] = true;
		tileNoAttach[17] = true;
		tileNoAttach[18] = true;
		tileNoAttach[21] = true;
		tileNoAttach[467] = true;
		tileNoAttach[441] = true;
		tileNoAttach[468] = true;
		tileNoAttach[27] = true;
		tileNoAttach[114] = true;
		tileTable[14] = true;
		tileTable[469] = true;
		tileTable[18] = true;
		tileTable[19] = true;
		tileTable[114] = true;
		tileNoAttach[86] = true;
		tileNoAttach[87] = true;
		tileNoAttach[88] = true;
		tileNoAttach[89] = true;
		tileNoAttach[90] = true;
		tileTable[101] = true;
		tileNoAttach[101] = true;
		tileNoAttach[102] = true;
		tileNoAttach[94] = true;
		tileNoAttach[95] = true;
		tileNoAttach[96] = true;
		tileNoAttach[97] = true;
		tileNoAttach[98] = true;
		tileNoAttach[99] = true;
		tileTable[87] = true;
		tileTable[88] = true;
		tileSolidTop[87] = true;
		tileSolidTop[88] = true;
		tileSolidTop[101] = true;
		tileNoAttach[91] = true;
		tileNoAttach[92] = true;
		tileNoAttach[93] = true;
		tileLighted[190] = true;
		tileBlockLight[192] = true;
		tileWaterDeath[215] = true;
		tileWaterDeath[4] = true;
		tileWaterDeath[51] = true;
		tileWaterDeath[697] = true;
		tileWaterDeath[93] = true;
		tileWaterDeath[98] = true;
		tileWaterDeath[552] = true;
		tileLavaDeath[3] = true;
		tileLavaDeath[5] = true;
		tileLavaDeath[10] = true;
		tileLavaDeath[11] = true;
		tileLavaDeath[12] = true;
		tileLavaDeath[13] = true;
		tileLavaDeath[14] = true;
		tileLavaDeath[469] = true;
		tileLavaDeath[486] = true;
		tileLavaDeath[488] = true;
		tileLavaDeath[704] = true;
		tileLavaDeath[487] = true;
		tileLavaDeath[489] = true;
		tileLavaDeath[490] = true;
		tileLavaDeath[15] = true;
		tileLavaDeath[497] = true;
		tileLavaDeath[16] = true;
		tileLavaDeath[17] = true;
		tileLavaDeath[18] = true;
		tileLavaDeath[19] = true;
		tileLavaDeath[24] = true;
		tileLavaDeath[27] = true;
		tileLavaDeath[28] = true;
		tileLavaDeath[29] = true;
		tileLavaDeath[32] = true;
		tileLavaDeath[33] = true;
		tileLavaDeath[34] = true;
		tileLavaDeath[35] = true;
		tileLavaDeath[36] = true;
		tileLavaDeath[42] = true;
		tileLavaDeath[49] = true;
		tileLavaDeath[50] = true;
		tileLavaDeath[707] = true;
		tileLavaDeath[51] = true;
		tileLavaDeath[697] = true;
		tileLavaDeath[52] = true;
		tileLavaDeath[55] = true;
		tileLavaDeath[61] = true;
		tileLavaDeath[703] = true;
		tileLavaDeath[62] = true;
		tileLavaDeath[69] = true;
		tileLavaDeath[655] = true;
		tileLavaDeath[71] = true;
		tileLavaDeath[72] = true;
		tileLavaDeath[73] = true;
		tileLavaDeath[74] = true;
		tileLavaDeath[79] = true;
		tileLavaDeath[80] = true;
		tileLavaDeath[81] = true;
		tileLavaDeath[86] = true;
		tileLavaDeath[87] = true;
		tileLavaDeath[88] = true;
		tileLavaDeath[89] = true;
		tileLavaDeath[90] = true;
		tileLavaDeath[91] = true;
		tileLavaDeath[92] = true;
		tileLavaDeath[93] = true;
		tileLavaDeath[94] = true;
		tileLavaDeath[95] = true;
		tileLavaDeath[96] = true;
		tileLavaDeath[97] = true;
		tileLavaDeath[98] = true;
		tileLavaDeath[100] = true;
		tileLavaDeath[101] = true;
		tileLavaDeath[102] = true;
		tileLavaDeath[103] = true;
		tileLavaDeath[104] = true;
		tileLavaDeath[106] = true;
		tileLavaDeath[110] = true;
		tileLavaDeath[113] = true;
		tileLavaDeath[115] = true;
		tileLavaDeath[125] = true;
		tileLavaDeath[126] = true;
		tileLavaDeath[128] = true;
		tileLavaDeath[149] = true;
		tileLavaDeath[172] = true;
		tileLavaDeath[173] = true;
		tileLavaDeath[174] = true;
		tileLavaDeath[184] = true;
		tileLavaDeath[201] = true;
		tileLavaDeath[205] = true;
		tileLavaDeath[201] = true;
		tileLavaDeath[209] = true;
		tileLavaDeath[210] = true;
		tileLavaDeath[212] = true;
		tileLavaDeath[213] = true;
		tileLavaDeath[353] = true;
		tileLavaDeath[214] = false;
		tileLavaDeath[215] = true;
		tileLavaDeath[216] = true;
		tileLavaDeath[217] = true;
		tileLavaDeath[218] = true;
		tileLavaDeath[219] = true;
		tileLavaDeath[642] = true;
		tileLavaDeath[220] = true;
		tileLavaDeath[227] = true;
		tileLavaDeath[228] = true;
		tileLavaDeath[233] = true;
		tileLavaDeath[236] = true;
		tileLavaDeath[702] = true;
		tileLavaDeath[238] = true;
		tileLavaDeath[240] = true;
		tileLavaDeath[241] = true;
		tileLavaDeath[242] = true;
		tileLavaDeath[243] = true;
		tileLavaDeath[244] = true;
		tileLavaDeath[245] = true;
		tileLavaDeath[246] = true;
		tileLavaDeath[247] = true;
		tileLavaDeath[254] = true;
		tileLavaDeath[269] = true;
		tileLavaDeath[270] = true;
		tileLavaDeath[271] = true;
		tileLavaDeath[581] = true;
		tileLavaDeath[698] = true;
		tileLavaDeath[660] = true;
		tileLavaDeath[275] = true;
		tileLavaDeath[413] = true;
		tileLavaDeath[276] = true;
		tileLavaDeath[277] = true;
		tileLavaDeath[278] = true;
		tileLavaDeath[279] = true;
		tileLavaDeath[280] = true;
		tileLavaDeath[281] = true;
		tileLavaDeath[282] = true;
		tileLavaDeath[283] = true;
		tileLavaDeath[285] = true;
		tileLavaDeath[286] = true;
		tileLavaDeath[287] = true;
		tileLavaDeath[288] = true;
		tileLavaDeath[289] = true;
		tileLavaDeath[290] = true;
		tileLavaDeath[291] = true;
		tileLavaDeath[292] = true;
		tileLavaDeath[293] = true;
		tileLavaDeath[294] = true;
		tileLavaDeath[295] = true;
		tileLavaDeath[296] = true;
		tileLavaDeath[297] = true;
		tileLavaDeath[298] = true;
		tileLavaDeath[299] = true;
		tileLavaDeath[300] = true;
		tileLavaDeath[301] = true;
		tileLavaDeath[302] = true;
		tileLavaDeath[303] = true;
		tileLavaDeath[304] = true;
		tileLavaDeath[305] = true;
		tileLavaDeath[306] = true;
		tileLavaDeath[307] = true;
		tileLavaDeath[308] = true;
		tileLavaDeath[309] = true;
		tileLavaDeath[310] = true;
		tileLavaDeath[532] = true;
		tileLavaDeath[316] = true;
		tileLavaDeath[317] = true;
		tileLavaDeath[318] = true;
		tileLavaDeath[319] = true;
		tileLavaDeath[354] = true;
		tileLavaDeath[355] = true;
		tileLavaDeath[699] = true;
		tileLavaDeath[499] = true;
		tileLavaDeath[323] = true;
		tileLavaDeath[335] = true;
		tileLavaDeath[338] = true;
		tileLavaDeath[339] = true;
		tileLavaDeath[528] = true;
		tileLavaDeath[636] = true;
		tileLavaDeath[638] = false;
		tileLavaDeath[352] = true;
		tileLavaDeath[382] = true;
		tileLavaDeath[425] = true;
		tileLavaDeath[453] = true;
		tileLavaDeath[456] = true;
		tileLavaDeath[463] = true;
		tileLavaDeath[464] = true;
		tileLavaDeath[465] = true;
		tileLavaDeath[485] = true;
		tileLavaDeath[511] = true;
		tileLavaDeath[510] = true;
		tileLavaDeath[547] = true;
		tileLavaDeath[548] = true;
		tileLavaDeath[552] = true;
		tileLavaDeath[573] = true;
		tileLavaDeath[621] = true;
		tileLavaDeath[622] = true;
		tileLavaDeath[623] = true;
		tileLavaDeath[624] = true;
		tileLavaDeath[700] = true;
		tileLavaDeath[656] = true;
		tileLavaDeath[701] = true;
		tileLighted[316] = true;
		tileLighted[317] = true;
		tileLighted[318] = true;
		tileFrameImportant[493] = true;
		tileLavaDeath[493] = true;
		for (int j = 0; j < TileID.Count; j++)
		{
			if (tileLavaDeath[j])
			{
				tileObsidianKill[j] = true;
			}
		}
		tileObsidianKill[88] = false;
		tileObsidianKill[546] = true;
		tileObsidianKill[77] = true;
		tileObsidianKill[78] = true;
		tileObsidianKill[82] = true;
		tileObsidianKill[83] = true;
		tileObsidianKill[84] = true;
		tileObsidianKill[85] = true;
		tileObsidianKill[105] = true;
		tileObsidianKill[129] = true;
		tileObsidianKill[132] = true;
		tileObsidianKill[133] = true;
		tileObsidianKill[134] = true;
		tileObsidianKill[135] = true;
		tileObsidianKill[136] = true;
		tileObsidianKill[139] = true;
		tileObsidianKill[165] = true;
		tileObsidianKill[178] = true;
		tileObsidianKill[185] = true;
		tileObsidianKill[186] = true;
		tileObsidianKill[187] = true;
		tileObsidianKill[231] = true;
		tileObsidianKill[337] = true;
		tileObsidianKill[349] = true;
		tileObsidianKill[506] = true;
		tileObsidianKill[314] = true;
		tileSolid[384] = true;
		tileBlockLight[384] = true;
		tileNoFail[384] = true;
		tileFrameImportant[395] = true;
		tileLavaDeath[395] = true;
		tileFrameImportant[520] = true;
		tileLavaDeath[520] = true;
		tileLavaDeath[471] = true;
		tileFrameImportant[405] = true;
		tileLavaDeath[405] = true;
		tileSolidTop[405] = true;
		tileTable[405] = true;
		tileLighted[405] = true;
		tileWaterDeath[405] = true;
		tileFrameImportant[406] = true;
		tileLavaDeath[406] = true;
		tileFrameImportant[452] = true;
		tileLavaDeath[452] = true;
		tileFrameImportant[411] = true;
		tileLavaDeath[411] = false;
		tileFrameImportant[457] = true;
		tileLavaDeath[457] = true;
		tileFrameImportant[462] = true;
		tileFrameImportant[454] = true;
		tileLavaDeath[454] = true;
		tileCut[454] = true;
		tileFrameImportant[494] = true;
		tileLavaDeath[494] = true;
		tileFrameImportant[455] = true;
		tileFrameImportant[412] = true;
		for (int k = 0; k < WallID.Count; k++)
		{
			int num = WallID.Sets.BlendType[k];
			if (num >= 0 && num < WallID.Count)
			{
				wallBlend[k] = num;
			}
			else
			{
				wallBlend[k] = k;
			}
		}
		tileNoFail[24] = true;
		tileNoFail[3] = true;
		tileNoFail[52] = true;
		tileNoFail[62] = true;
		tileNoFail[32] = true;
		tileNoFail[61] = true;
		tileNoFail[69] = true;
		tileNoFail[655] = true;
		tileNoFail[73] = true;
		tileNoFail[74] = true;
		tileNoFail[82] = true;
		tileNoFail[83] = true;
		tileNoFail[84] = true;
		tileNoFail[110] = true;
		tileNoFail[113] = true;
		tileNoFail[115] = true;
		tileNoFail[165] = true;
		tileNoFail[184] = true;
		tileNoFail[201] = true;
		tileNoFail[205] = true;
		tileNoFail[227] = true;
		tileNoFail[233] = true;
		tileNoFail[624] = true;
		tileNoFail[700] = true;
		tileNoFail[352] = true;
		tileNoFail[382] = true;
		tileNoFail[528] = true;
		tileNoFail[485] = true;
		tileNoFail[636] = true;
		tileNoFail[638] = true;
		tileNoFail[656] = true;
		tileNoFail[701] = true;
		tileLighted[638] = true;
		tileFrameImportant[387] = true;
		tileSolid[387] = true;
		tileBlockLight[387] = true;
		tileNoAttach[387] = true;
		tileLavaDeath[387] = true;
		tileFrameImportant[386] = true;
		tileLavaDeath[386] = true;
		tileNoSunLight[386] = true;
		tileFrameImportant[388] = true;
		tileSolid[388] = true;
		tileBlockLight[388] = true;
		tileNoAttach[388] = true;
		tileLavaDeath[388] = true;
		tileFrameImportant[389] = true;
		tileLavaDeath[389] = true;
		tileNoSunLight[389] = true;
		for (int l = 0; l < TileID.Count; l++)
		{
			if (tileSolid[l])
			{
				tileNoSunLight[l] = true;
			}
			tileFrame[l] = 0;
			tileFrameCounter[l] = 0;
		}
		tileNoSunLight[546] = false;
		tileNoSunLight[379] = false;
		tileNoSunLight[54] = false;
		tileNoSunLight[328] = false;
		tileNoSunLight[459] = false;
		tileNoSunLight[19] = false;
		tileNoSunLight[11] = true;
		tileNoSunLight[189] = false;
		tileNoSunLight[196] = false;
		tileNoSunLight[48] = false;
		tileNoSunLight[232] = false;
		tileNoSunLight[460] = false;
		tileNoSunLight[541] = false;
		tileNoSunLight[388] = false;
		tileNoSunLight[748] = false;
		tileNoSunLight[750] = false;
		AddEchoFurnitureTile(647);
		AddEchoFurnitureTile(648);
		AddEchoFurnitureTile(706);
		AddEchoFurnitureTile(650);
		AddEchoFurnitureTile(649);
		AddEchoFurnitureTile(652);
		AddEchoFurnitureTile(651);
		AddEchoFurnitureTile(693);
		AddEchoFurnitureTile(694);
		tileFrameImportant[653] = true;
		tileFrameImportant[723] = true;
		tileFrameImportant[724] = true;
	}

	private static void AddEchoFurnitureTile(int tileId)
	{
		tileFrameImportant[tileId] = true;
		tileNoFail[tileId] = true;
		tileObsidianKill[tileId] = true;
	}

	private static void Initialize_TileAndNPCData1()
	{
		for (int i = 0; i < TileID.Count; i++)
		{
			tileGlowMask[i] = -1;
		}
		for (int j = 0; j < ProjectileID.Count; j++)
		{
			projFrames[j] = 1;
		}
		projFrames[1078] = 3;
		projFrames[1024] = 8;
		projFrames[736] = 3;
		projFrames[737] = 3;
		projFrames[738] = 3;
		projFrames[779] = 4;
		projFrames[783] = 4;
		projFrames[862] = 4;
		projFrames[863] = 4;
		projFrames[820] = 4;
		projFrames[916] = 6;
		projFrames[34] = 6;
		projFrames[1088] = 2;
		projFrames[706] = 8;
		projFrames[712] = 8;
		projFrames[663] = 7;
		projFrames[665] = 9;
		projFrames[667] = 9;
		projFrames[677] = 6;
		projFrames[678] = 6;
		projFrames[679] = 6;
		projFrames[688] = 6;
		projFrames[689] = 6;
		projFrames[690] = 8;
		projFrames[691] = 4;
		projFrames[692] = 4;
		projFrames[693] = 4;
		projFrames[694] = 4;
		projFrames[695] = 4;
		projFrames[696] = 5;
		projFrames[700] = 4;
		projFrames[964] = 1;
		projFrames[965] = 1;
		projFrames[643] = 8;
		projFrames[566] = 4;
		projFrames[565] = 4;
		projFrames[525] = 5;
		projFrames[519] = 4;
		projFrames[509] = 2;
		projFrames[485] = 5;
		projFrames[492] = 8;
		projFrames[500] = 4;
		projFrames[499] = 12;
		projFrames[518] = 4;
		projFrames[585] = 4;
		projFrames[593] = 4;
		projFrames[595] = 28;
		projFrames[735] = 28;
		projFrames[596] = 4;
		projFrames[612] = 5;
		projFrames[978] = 5;
		projFrames[613] = 4;
		projFrames[614] = 4;
		projFrames[615] = 7;
		projFrames[623] = 19;
		projFrames[633] = 5;
		projFrames[645] = 7;
		projFrames[650] = 4;
		projFrames[652] = 6;
		projFrames[659] = 4;
		projFrames[714] = 7;
		projFrames[734] = 8;
		projFrames[755] = 5;
		projFrames[759] = 5;
		projFrames[765] = 10;
		projFrames[951] = 12;
		projFrames[953] = 5;
		projFrames[1022] = 16;
		projFrames[1036] = 4;
		projFrames[384] = 6;
		projFrames[385] = 3;
		projFrames[386] = 6;
		projFrames[390] = 11;
		projFrames[391] = 11;
		projFrames[392] = 11;
		projFrames[393] = 15;
		projFrames[394] = 15;
		projFrames[395] = 15;
		projFrames[398] = 11;
		projFrames[407] = 6;
		projFrames[408] = 2;
		projFrames[409] = 3;
		projFrames[387] = 3;
		projFrames[388] = 3;
		projFrames[334] = 11;
		projFrames[324] = 10;
		projFrames[351] = 2;
		projFrames[349] = 5;
		projFrames[423] = 4;
		projFrames[435] = 4;
		projFrames[682] = 4;
		projFrames[436] = 4;
		projFrames[439] = 6;
		projFrames[443] = 4;
		projFrames[447] = 4;
		projFrames[448] = 3;
		projFrames[450] = 5;
		projFrames[454] = 2;
		projFrames[456] = 4;
		projFrames[459] = 3;
		projFrames[462] = 5;
		projFrames[465] = 4;
		projFrames[467] = 4;
		projFrames[468] = 4;
		projFrames[533] = 21;
		projFrames[535] = 12;
		projFrames[539] = 4;
		projFrames[575] = 4;
		projFrames[574] = 2;
		projFrames[634] = 4;
		projFrames[635] = 4;
		projFrames[709] = 3;
		projFrames[1038] = 8;
		projFrames[1093] = 28;
		projFrames[1110] = 4;
		projFrames[353] = 14;
		projFrames[346] = 2;
		projFrames[347] = 2;
		projFrames[335] = 4;
		projFrames[344] = 3;
		projFrames[337] = 5;
		projFrames[317] = 8;
		projFrames[321] = 3;
		projFrames[308] = 10;
		projFrames[316] = 4;
		projFrames[275] = 2;
		projFrames[276] = 2;
		projFrames[254] = 5;
		projFrames[307] = 2;
		projFrames[72] = 4;
		projFrames[86] = 4;
		projFrames[87] = 4;
		projFrames[102] = 2;
		projFrames[111] = 8;
		projFrames[112] = 6;
		projFrames[127] = 16;
		projFrames[175] = 2;
		projFrames[181] = 4;
		projFrames[189] = 4;
		projFrames[191] = 18;
		projFrames[192] = 18;
		projFrames[193] = 18;
		projFrames[194] = 18;
		projFrames[190] = 4;
		projFrames[198] = 4;
		projFrames[199] = 8;
		projFrames[200] = 10;
		projFrames[206] = 5;
		projFrames[208] = 5;
		projFrames[209] = 12;
		projFrames[210] = 12;
		projFrames[211] = 10;
		projFrames[221] = 3;
		projFrames[237] = 4;
		projFrames[238] = 6;
		projFrames[221] = 3;
		projFrames[228] = 5;
		projFrames[229] = 4;
		projFrames[236] = 13;
		projFrames[243] = 4;
		projFrames[244] = 6;
		projFrames[249] = 5;
		projFrames[252] = 4;
		projFrames[266] = 12;
		projFrames[268] = 8;
		projFrames[269] = 7;
		projFrames[270] = 3;
		projFrames[313] = 12;
		projFrames[314] = 13;
		projFrames[319] = 11;
		projFrames[373] = 3;
		projFrames[375] = 8;
		projFrames[377] = 9;
		projFrames[379] = 4;
		projFrames[380] = 4;
		projFrames[601] = 2;
		projFrames[602] = 4;
		projFrames[703] = 8;
		projFrames[701] = 3;
		projFrames[702] = 4;
		projFrames[732] = 4;
		projFrames[731] = 4;
		projFrames[758] = 24;
		projFrames[766] = 4;
		projFrames[767] = 4;
		projFrames[768] = 4;
		projFrames[769] = 4;
		projFrames[770] = 4;
		projFrames[774] = 8;
		projFrames[773] = 4;
		projFrames[815] = 10;
		projFrames[816] = 17;
		projFrames[817] = 18;
		projFrames[821] = 23;
		projFrames[824] = 4;
		projFrames[825] = 26;
		projFrames[826] = 3;
		projFrames[828] = 2;
		projFrames[829] = 2;
		projFrames[831] = 6;
		projFrames[970] = 6;
		projFrames[833] = 10;
		projFrames[834] = 12;
		projFrames[835] = 12;
		projFrames[836] = 4;
		projFrames[837] = 3;
		projFrames[839] = 4;
		projFrames[840] = 4;
		projFrames[851] = 4;
		projFrames[853] = 4;
		projFrames[854] = 19;
		projFrames[855] = 4;
		projFrames[858] = 14;
		projFrames[859] = 24;
		projFrames[860] = 14;
		projFrames[861] = 4;
		projFrames[864] = 2;
		projFrames[866] = 4;
		projFrames[870] = 4;
		projFrames[875] = 11;
		projFrames[881] = 12;
		projFrames[882] = 20;
		projFrames[883] = 3;
		projFrames[884] = 14;
		projFrames[885] = 10;
		projFrames[886] = 8;
		projFrames[887] = 3;
		projFrames[888] = 36;
		projFrames[889] = 11;
		projFrames[890] = 12;
		projFrames[891] = 15;
		projFrames[892] = 6;
		projFrames[893] = 4;
		projFrames[894] = 8;
		projFrames[895] = 6;
		projFrames[896] = 16;
		projFrames[897] = 11;
		projFrames[898] = 16;
		projFrames[899] = 14;
		projFrames[900] = 14;
		projFrames[901] = 12;
		projFrames[908] = 12;
		projFrames[909] = 6;
		projFrames[920] = 3;
		projFrames[934] = 12;
		projFrames[880] = 8;
		projFrames[929] = 8;
		projFrames[956] = 11;
		projFrames[957] = 12;
		projFrames[958] = 17;
		projFrames[959] = 12;
		projFrames[960] = 20;
		projFrames[961] = 1;
		projFrames[962] = 3;
		projFrames[963] = 13;
		projFrames[966] = 3;
		projFrames[967] = 8;
		projFrames[968] = 24;
		projFrames[969] = 8;
		projFrames[994] = 16;
		projFrames[995] = 20;
		projFrames[998] = 10;
		projFrames[1003] = 16;
		projFrames[1004] = 15;
		projFrames[1014] = 11;
		projFrames[1055] = 10;
		projFrames[1025] = 4;
		projFrames[1026] = 4;
		projFrames[1027] = 5;
		projFrames[1046] = 12;
		projFrames[1050] = 16;
		projFrames[1092] = 54;
		projFrames[1095] = 12;
		projFrames[1096] = 12;
		projFrames[1098] = 11;
		projFrames[1105] = 7;
		projPet[492] = true;
		projPet[499] = true;
		projPet[653] = true;
		projPet[701] = true;
		projPet[703] = true;
		projPet[702] = true;
		projPet[764] = true;
		projPet[765] = true;
		projPet[319] = true;
		projPet[334] = true;
		projPet[324] = true;
		projPet[266] = true;
		projPet[313] = true;
		projPet[314] = true;
		projPet[317] = true;
		projPet[175] = true;
		projPet[111] = true;
		projPet[112] = true;
		projPet[127] = true;
		projPet[191] = true;
		projPet[192] = true;
		projPet[193] = true;
		projPet[194] = true;
		projPet[197] = true;
		projPet[198] = true;
		projPet[199] = true;
		projPet[200] = true;
		projPet[208] = true;
		projPet[209] = true;
		projPet[210] = true;
		projPet[211] = true;
		projPet[236] = true;
		projPet[268] = true;
		projPet[269] = true;
		projPet[353] = true;
		projPet[373] = true;
		projPet[375] = true;
		projPet[380] = true;
		projPet[387] = true;
		projPet[388] = true;
		projPet[390] = true;
		projPet[391] = true;
		projPet[392] = true;
		projPet[393] = true;
		projPet[394] = true;
		projPet[395] = true;
		projPet[1093] = true;
		projPet[1094] = true;
		projPet[398] = true;
		projPet[407] = true;
		projPet[423] = true;
		projPet[533] = true;
		projPet[613] = true;
		projPet[623] = true;
		projPet[625] = true;
		projPet[626] = true;
		projPet[627] = true;
		projPet[628] = true;
		projPet[755] = true;
		projPet[758] = true;
		projPet[759] = true;
		projPet[774] = true;
		projPet[815] = true;
		projPet[816] = true;
		projPet[817] = true;
		projPet[821] = true;
		projPet[825] = true;
		projPet[831] = true;
		projPet[833] = true;
		projPet[834] = true;
		projPet[835] = true;
		projPet[854] = true;
		projPet[858] = true;
		projPet[859] = true;
		projPet[860] = true;
		projPet[864] = true;
		projPet[875] = true;
		projPet[946] = true;
		projPet[951] = true;
		projPet[963] = true;
		projPet[970] = true;
		projPet[1022] = true;
		projPet[881] = true;
		projPet[882] = true;
		projPet[883] = true;
		projPet[884] = true;
		projPet[885] = true;
		projPet[886] = true;
		projPet[887] = true;
		projPet[888] = true;
		projPet[889] = true;
		projPet[890] = true;
		projPet[891] = true;
		projPet[892] = true;
		projPet[893] = true;
		projPet[894] = true;
		projPet[895] = true;
		projPet[896] = true;
		projPet[897] = true;
		projPet[898] = true;
		projPet[899] = true;
		projPet[900] = true;
		projPet[901] = true;
		projPet[934] = true;
		projPet[956] = true;
		projPet[957] = true;
		projPet[958] = true;
		projPet[959] = true;
		projPet[960] = true;
		projPet[994] = true;
		projPet[998] = true;
		projPet[1003] = true;
		projPet[1004] = true;
		projPet[1018] = true;
		projPet[1056] = true;
		projPet[1090] = true;
		projPet[1027] = true;
		projPet[1046] = true;
		projPet[1050] = true;
		projPet[1095] = true;
		projPet[1096] = true;
		tileLighted[237] = true;
		tileLighted[27] = true;
		tileLighted[381] = true;
		tileLighted[534] = true;
		tileLighted[536] = true;
		tileLighted[539] = true;
		tileLighted[625] = true;
		tileLighted[627] = true;
		tileLighted[184] = true;
		tileLighted[463] = true;
		tileLighted[491] = true;
		slimeRainNPC[1] = true;
		debuff[158] = true;
		debuff[160] = true;
		debuff[20] = true;
		debuff[21] = true;
		debuff[22] = true;
		debuff[23] = true;
		debuff[24] = true;
		debuff[25] = true;
		debuff[28] = true;
		debuff[30] = true;
		debuff[31] = true;
		debuff[32] = true;
		debuff[33] = true;
		debuff[34] = true;
		debuff[35] = true;
		debuff[36] = true;
		debuff[37] = true;
		debuff[38] = true;
		debuff[39] = true;
		debuff[44] = true;
		debuff[46] = true;
		debuff[47] = true;
		debuff[67] = true;
		debuff[68] = true;
		debuff[69] = true;
		debuff[70] = true;
		debuff[80] = true;
		debuff[86] = true;
		debuff[87] = true;
		debuff[88] = true;
		debuff[89] = true;
		debuff[94] = true;
		debuff[103] = true;
		debuff[119] = true;
		debuff[120] = true;
		debuff[137] = true;
		debuff[145] = true;
		debuff[146] = true;
		debuff[147] = true;
		debuff[148] = true;
		debuff[149] = true;
		debuff[156] = true;
		debuff[157] = true;
		debuff[350] = true;
		debuff[163] = true;
		debuff[164] = true;
		debuff[144] = true;
		debuff[194] = true;
		debuff[195] = true;
		debuff[196] = true;
		debuff[197] = true;
		debuff[199] = true;
		debuff[215] = true;
		debuff[320] = true;
		debuff[321] = true;
		debuff[332] = true;
		debuff[333] = true;
		debuff[334] = true;
		debuff[353] = true;
		debuff[323] = true;
		debuff[324] = true;
		debuff[43] = true;
		debuff[153] = true;
		debuff[203] = true;
		debuff[204] = true;
		debuff[169] = true;
		debuff[189] = true;
		debuff[183] = true;
		debuff[186] = true;
		debuff[344] = true;
		debuff[72] = true;
		pvpBuff[20] = true;
		pvpBuff[70] = true;
		pvpBuff[24] = true;
		pvpBuff[323] = true;
		pvpBuff[31] = true;
		pvpBuff[39] = true;
		pvpBuff[44] = true;
		pvpBuff[324] = true;
		pvpBuff[69] = true;
		pvpBuff[103] = true;
		pvpBuff[119] = true;
		pvpBuff[120] = true;
		pvpBuff[137] = true;
		pvpBuff[320] = true;
		pvpBuff[30] = true;
		pvpBuff[36] = true;
		meleeBuff[71] = true;
		meleeBuff[73] = true;
		meleeBuff[74] = true;
		meleeBuff[75] = true;
		meleeBuff[76] = true;
		meleeBuff[77] = true;
		meleeBuff[78] = true;
		meleeBuff[79] = true;
		buffNoSave[20] = true;
		buffNoSave[22] = true;
		buffNoSave[23] = true;
		buffNoSave[24] = true;
		buffNoSave[28] = true;
		buffNoSave[30] = true;
		buffNoSave[31] = true;
		buffNoSave[34] = true;
		buffNoSave[35] = true;
		buffNoSave[37] = true;
		buffNoSave[38] = true;
		buffNoSave[39] = true;
		buffNoSave[43] = true;
		buffNoSave[44] = true;
		buffNoSave[46] = true;
		buffNoSave[47] = true;
		buffNoSave[48] = true;
		buffNoSave[58] = true;
		buffNoSave[59] = true;
		buffNoSave[60] = true;
		buffNoSave[62] = true;
		buffNoSave[63] = true;
		buffNoSave[64] = true;
		buffNoSave[67] = true;
		buffNoSave[68] = true;
		buffNoSave[69] = true;
		buffNoSave[70] = true;
		buffNoSave[72] = true;
		buffNoSave[80] = true;
		buffNoSave[87] = true;
		buffNoSave[158] = true;
		buffNoSave[146] = true;
		buffNoSave[147] = true;
		buffNoSave[215] = true;
		buffNoSave[88] = true;
		buffNoSave[89] = true;
		buffNoSave[94] = true;
		buffNoSave[95] = true;
		buffNoSave[96] = true;
		buffNoSave[97] = true;
		buffNoSave[98] = true;
		buffNoSave[99] = true;
		buffNoSave[100] = true;
		buffNoSave[103] = true;
		buffNoSave[119] = true;
		buffNoSave[120] = true;
		buffNoSave[125] = true;
		buffNoSave[126] = true;
		buffNoSave[133] = true;
		buffNoSave[134] = true;
		buffNoSave[135] = true;
		buffNoSave[139] = true;
		buffNoSave[140] = true;
		buffNoSave[137] = true;
		buffNoSave[144] = true;
		buffNoSave[161] = true;
		buffNoSave[163] = true;
		buffNoSave[164] = true;
		buffNoSave[170] = true;
		buffNoSave[171] = true;
		buffNoSave[172] = true;
		buffNoSave[182] = true;
		buffNoSave[187] = true;
		buffNoSave[188] = true;
		buffNoSave[194] = true;
		buffNoSave[195] = true;
		buffNoSave[196] = true;
		buffNoSave[197] = true;
		buffNoSave[198] = true;
		buffNoSave[199] = true;
		buffNoSave[205] = true;
		buffNoSave[213] = true;
		buffNoSave[214] = true;
		buffNoSave[263] = true;
		buffNoSave[271] = true;
		buffNoSave[322] = true;
		buffNoSave[320] = true;
		buffNoSave[321] = true;
		buffNoSave[325] = true;
		buffNoSave[335] = true;
		buffNoSave[150] = true;
		buffNoSave[93] = true;
		buffNoSave[159] = true;
		buffNoSave[29] = true;
		buffNoSave[348] = true;
		buffNoSave[366] = true;
		buffNoSave[353] = true;
		buffNoSave[355] = true;
		buffNoSave[385] = true;
		buffNoSave[386] = true;
		for (int k = 173; k <= 181; k++)
		{
			buffNoSave[k] = true;
		}
		buffNoTimeDisplay[19] = true;
		buffNoTimeDisplay[27] = true;
		buffNoTimeDisplay[28] = true;
		buffNoTimeDisplay[34] = true;
		buffNoTimeDisplay[37] = true;
		buffNoTimeDisplay[38] = true;
		buffNoTimeDisplay[40] = true;
		buffNoTimeDisplay[41] = true;
		buffNoTimeDisplay[42] = true;
		buffNoTimeDisplay[43] = true;
		buffNoTimeDisplay[45] = true;
		buffNoTimeDisplay[49] = true;
		buffNoTimeDisplay[60] = true;
		buffNoTimeDisplay[62] = true;
		buffNoTimeDisplay[64] = true;
		buffNoTimeDisplay[68] = true;
		buffNoTimeDisplay[81] = true;
		buffNoTimeDisplay[82] = true;
		buffNoTimeDisplay[83] = true;
		buffNoTimeDisplay[95] = true;
		buffNoTimeDisplay[96] = true;
		buffNoTimeDisplay[97] = true;
		buffNoTimeDisplay[98] = true;
		buffNoTimeDisplay[99] = true;
		buffNoTimeDisplay[100] = true;
		buffNoTimeDisplay[101] = true;
		buffNoTimeDisplay[102] = true;
		buffNoTimeDisplay[125] = true;
		buffNoTimeDisplay[126] = true;
		buffNoTimeDisplay[133] = true;
		buffNoTimeDisplay[134] = true;
		buffNoTimeDisplay[135] = true;
		buffNoTimeDisplay[136] = true;
		buffNoTimeDisplay[139] = true;
		buffNoTimeDisplay[140] = true;
		buffNoTimeDisplay[200] = true;
		buffNoTimeDisplay[202] = true;
		buffNoTimeDisplay[201] = true;
		buffNoTimeDisplay[161] = true;
		buffNoTimeDisplay[163] = true;
		buffNoTimeDisplay[170] = true;
		buffNoTimeDisplay[171] = true;
		buffNoTimeDisplay[172] = true;
		buffNoTimeDisplay[182] = true;
		buffNoTimeDisplay[165] = true;
		buffNoTimeDisplay[186] = true;
		buffNoTimeDisplay[187] = true;
		buffNoTimeDisplay[188] = true;
		buffNoTimeDisplay[199] = true;
		buffNoTimeDisplay[213] = true;
		buffNoTimeDisplay[214] = true;
		buffNoTimeDisplay[216] = true;
		buffNoTimeDisplay[217] = true;
		buffNoTimeDisplay[219] = true;
		buffNoTimeDisplay[258] = true;
		buffNoTimeDisplay[259] = true;
		buffNoTimeDisplay[260] = true;
		buffNoTimeDisplay[261] = true;
		buffNoTimeDisplay[262] = true;
		buffNoTimeDisplay[263] = true;
		buffNoTimeDisplay[264] = true;
		buffNoTimeDisplay[266] = true;
		buffNoTimeDisplay[267] = true;
		buffNoTimeDisplay[268] = true;
		buffNoTimeDisplay[271] = true;
		buffNoTimeDisplay[322] = true;
		buffNoTimeDisplay[274] = true;
		buffNoTimeDisplay[284] = true;
		buffNoTimeDisplay[285] = true;
		buffNoTimeDisplay[286] = true;
		buffNoTimeDisplay[287] = true;
		buffNoTimeDisplay[288] = true;
		buffNoTimeDisplay[289] = true;
		buffNoTimeDisplay[290] = true;
		buffNoTimeDisplay[291] = true;
		buffNoTimeDisplay[292] = true;
		buffNoTimeDisplay[293] = true;
		buffNoTimeDisplay[294] = true;
		buffNoTimeDisplay[295] = true;
		buffNoTimeDisplay[296] = true;
		buffNoTimeDisplay[297] = true;
		buffNoTimeDisplay[298] = true;
		buffNoTimeDisplay[299] = true;
		buffNoTimeDisplay[300] = true;
		buffNoTimeDisplay[301] = true;
		buffNoTimeDisplay[302] = true;
		buffNoTimeDisplay[303] = true;
		buffNoTimeDisplay[304] = true;
		buffNoTimeDisplay[317] = true;
		buffNoTimeDisplay[325] = true;
		buffNoTimeDisplay[335] = true;
		buffNoTimeDisplay[341] = true;
		buffNoTimeDisplay[327] = true;
		buffNoTimeDisplay[328] = true;
		buffNoTimeDisplay[329] = true;
		buffNoTimeDisplay[330] = true;
		buffNoTimeDisplay[331] = true;
		buffNoTimeDisplay[334] = true;
		buffNoTimeDisplay[345] = true;
		buffNoTimeDisplay[349] = true;
		buffNoTimeDisplay[351] = true;
		buffNoTimeDisplay[352] = true;
		buffNoTimeDisplay[354] = true;
		buffNoTimeDisplay[373] = true;
		buffNoTimeDisplay[356] = true;
		buffNoTimeDisplay[371] = true;
		buffNoTimeDisplay[372] = true;
		buffNoTimeDisplay[382] = true;
		buffNoTimeDisplay[29] = true;
		buffNoTimeDisplay[159] = true;
		buffNoTimeDisplay[150] = true;
		buffNoTimeDisplay[93] = true;
		buffNoTimeDisplay[348] = true;
		buffNoTimeDisplay[353] = true;
		buffNoTimeDisplay[355] = true;
		buffNoTimeDisplay[366] = true;
		buffNoTimeDisplay[385] = true;
		buffNoTimeDisplay[386] = true;
		persistentBuff[71] = true;
		persistentBuff[73] = true;
		persistentBuff[74] = true;
		persistentBuff[75] = true;
		persistentBuff[76] = true;
		persistentBuff[77] = true;
		persistentBuff[78] = true;
		persistentBuff[79] = true;
		for (int l = 0; l < BuffID.Count; l++)
		{
			if (BuffID.Sets.MountType[l] != -1)
			{
				buffNoTimeDisplay[l] = true;
				buffNoSave[l] = true;
			}
		}
		vanityPet[40] = true;
		vanityPet[41] = true;
		vanityPet[42] = true;
		vanityPet[45] = true;
		vanityPet[50] = true;
		vanityPet[51] = true;
		vanityPet[52] = true;
		vanityPet[53] = true;
		vanityPet[54] = true;
		vanityPet[55] = true;
		vanityPet[56] = true;
		vanityPet[61] = true;
		vanityPet[154] = true;
		vanityPet[65] = true;
		vanityPet[66] = true;
		vanityPet[81] = true;
		vanityPet[82] = true;
		vanityPet[84] = true;
		vanityPet[85] = true;
		vanityPet[91] = true;
		vanityPet[92] = true;
		vanityPet[127] = true;
		vanityPet[136] = true;
		vanityPet[191] = true;
		vanityPet[202] = true;
		vanityPet[200] = true;
		vanityPet[218] = true;
		vanityPet[219] = true;
		vanityPet[217] = true;
		vanityPet[258] = true;
		vanityPet[259] = true;
		vanityPet[260] = true;
		vanityPet[261] = true;
		vanityPet[262] = true;
		vanityPet[264] = true;
		vanityPet[266] = true;
		vanityPet[267] = true;
		vanityPet[268] = true;
		vanityPet[274] = true;
		vanityPet[284] = true;
		vanityPet[285] = true;
		vanityPet[286] = true;
		vanityPet[287] = true;
		vanityPet[288] = true;
		vanityPet[289] = true;
		vanityPet[290] = true;
		vanityPet[291] = true;
		vanityPet[292] = true;
		vanityPet[293] = true;
		vanityPet[295] = true;
		vanityPet[296] = true;
		vanityPet[297] = true;
		vanityPet[300] = true;
		vanityPet[301] = true;
		vanityPet[302] = true;
		vanityPet[303] = true;
		vanityPet[304] = true;
		vanityPet[317] = true;
		vanityPet[341] = true;
		vanityPet[327] = true;
		vanityPet[328] = true;
		vanityPet[329] = true;
		vanityPet[330] = true;
		vanityPet[331] = true;
		vanityPet[345] = true;
		vanityPet[349] = true;
		vanityPet[351] = true;
		vanityPet[352] = true;
		vanityPet[354] = true;
		vanityPet[373] = true;
		vanityPet[382] = true;
		vanityPet[356] = true;
		vanityPet[371] = true;
		vanityPet[372] = true;
		lightPet[19] = true;
		lightPet[155] = true;
		lightPet[27] = true;
		lightPet[101] = true;
		lightPet[102] = true;
		lightPet[57] = true;
		lightPet[190] = true;
		lightPet[152] = true;
		lightPet[201] = true;
		lightPet[294] = true;
		lightPet[298] = true;
		lightPet[299] = true;
		tileFlame[4] = true;
		tileFlame[33] = true;
		tileFlame[34] = true;
		tileFlame[35] = true;
		tileFlame[42] = true;
		tileFlame[49] = true;
		tileFlame[93] = true;
		tileFlame[98] = true;
		tileFlame[100] = true;
		tileFlame[173] = true;
		tileFlame[174] = true;
		tileFlame[372] = true;
		tileFlame[646] = true;
		tileRope[213] = true;
		tileRope[214] = true;
		tileRope[353] = true;
		tileRope[365] = true;
		tileRope[366] = true;
		tileRope[504] = true;
		tileRope[449] = true;
		tileRope[450] = true;
		tileRope[451] = true;
		tilePile[330] = true;
		tilePile[331] = true;
		tilePile[332] = true;
		tilePile[333] = true;
		for (int m = 0; m < NPCID.Count; m++)
		{
			npcCatchable[m] = false;
		}
		npcCatchable[46] = true;
		npcCatchable[55] = true;
		npcCatchable[74] = true;
		npcCatchable[148] = true;
		npcCatchable[149] = true;
		npcCatchable[297] = true;
		npcCatchable[298] = true;
		npcCatchable[299] = true;
		npcCatchable[300] = true;
		npcCatchable[355] = true;
		npcCatchable[356] = true;
		npcCatchable[357] = true;
		npcCatchable[358] = true;
		npcCatchable[359] = true;
		npcCatchable[360] = true;
		npcCatchable[361] = true;
		npcCatchable[362] = true;
		npcCatchable[363] = true;
		npcCatchable[364] = true;
		npcCatchable[365] = true;
		npcCatchable[366] = true;
		npcCatchable[367] = true;
		npcCatchable[374] = true;
		npcCatchable[377] = true;
		npcCatchable[539] = true;
		npcCatchable[538] = true;
		npcCatchable[671] = true;
		npcCatchable[672] = true;
		npcCatchable[673] = true;
		npcCatchable[674] = true;
		npcCatchable[675] = true;
		npcCatchable[484] = true;
		npcCatchable[485] = true;
		npcCatchable[486] = true;
		npcCatchable[487] = true;
		npcCatchable[583] = true;
		npcCatchable[584] = true;
		npcCatchable[585] = true;
		npcCatchable[592] = true;
		npcCatchable[593] = true;
		npcCatchable[595] = true;
		npcCatchable[596] = true;
		npcCatchable[597] = true;
		npcCatchable[598] = true;
		npcCatchable[599] = true;
		npcCatchable[600] = true;
		npcCatchable[601] = true;
		npcCatchable[604] = true;
		npcCatchable[605] = true;
		npcCatchable[602] = true;
		npcCatchable[603] = true;
		npcCatchable[606] = true;
		npcCatchable[607] = true;
		npcCatchable[608] = true;
		npcCatchable[609] = true;
		npcCatchable[610] = true;
		npcCatchable[611] = true;
		npcCatchable[612] = true;
		npcCatchable[613] = true;
		npcCatchable[614] = true;
		npcCatchable[616] = true;
		npcCatchable[617] = true;
		npcCatchable[626] = true;
		npcCatchable[627] = true;
		npcCatchable[639] = true;
		npcCatchable[640] = true;
		npcCatchable[641] = true;
		npcCatchable[642] = true;
		npcCatchable[643] = true;
		npcCatchable[644] = true;
		npcCatchable[645] = true;
		npcCatchable[646] = true;
		npcCatchable[647] = true;
		npcCatchable[648] = true;
		npcCatchable[649] = true;
		npcCatchable[650] = true;
		npcCatchable[651] = true;
		npcCatchable[652] = true;
		npcCatchable[653] = true;
		npcCatchable[654] = true;
		npcCatchable[655] = true;
		npcCatchable[661] = true;
		npcCatchable[669] = true;
		npcCatchable[677] = true;
		npcCatchable[688] = true;
		for (int n = 442; n <= 448; n++)
		{
			npcCatchable[n] = true;
		}
		SetTileValue();
		tileSpelunker[6] = true;
		tileSpelunker[7] = true;
		tileSpelunker[8] = true;
		tileSpelunker[9] = true;
		tileSpelunker[12] = true;
		tileSpelunker[21] = true;
		tileSpelunker[467] = true;
		tileSpelunker[441] = true;
		tileSpelunker[468] = true;
		tileSpelunker[28] = true;
		tileSpelunker[107] = true;
		tileSpelunker[108] = true;
		tileSpelunker[111] = true;
		tileSpelunker[63] = true;
		tileSpelunker[64] = true;
		tileSpelunker[65] = true;
		tileSpelunker[66] = true;
		tileSpelunker[67] = true;
		tileSpelunker[68] = true;
		tileSpelunker[566] = true;
		tileSpelunker[166] = true;
		tileSpelunker[167] = true;
		tileSpelunker[168] = true;
		tileSpelunker[169] = true;
		tileSpelunker[178] = true;
		tileSpelunker[211] = true;
		tileSpelunker[221] = true;
		tileSpelunker[222] = true;
		tileSpelunker[223] = true;
		tileSpelunker[236] = true;
		tileSpelunker[702] = true;
		tileSpelunker[37] = true;
		tileSpelunker[407] = true;
		tileSpelunker[227] = true;
		tileSpelunker[84] = true;
		tileSpelunker[83] = true;
		tileSpelunker[404] = true;
		tileSpelunker[242] = true;
		tileSpelunker[240] = true;
		tileSpelunker[246] = true;
		tileSpelunker[245] = true;
		tileSpelunker[105] = true;
		tileSpelunker[349] = true;
		tileSpelunker[337] = true;
		tileSpelunker[531] = true;
		tileSpelunker[506] = true;
		tileSpelunker[751] = true;
		tileSpelunker[752] = true;
		tileSolid[379] = true;
		tileMergeDirt[249] = true;
		tileBrick[268] = true;
		tileBrick[262] = true;
		tileBrick[267] = true;
		tileBrick[265] = true;
		tileBrick[266] = true;
		tileBrick[264] = true;
		tileBrick[263] = true;
		tileBrick[261] = true;
		tileBrick[255] = true;
		tileBrick[260] = true;
		tileBrick[258] = true;
		tileBrick[259] = true;
		tileBrick[257] = true;
		tileBrick[256] = true;
		tileSolid[371] = true;
		tileMergeDirt[371] = true;
		tileBlockLight[371] = true;
		tileBouncy[371] = true;
		tileBouncy[448] = true;
		tileBouncy[446] = true;
		tileBouncy[447] = true;
		tileFrameImportant[377] = true;
		tileFrameImportant[373] = true;
		tileFrameImportant[375] = true;
		tileFrameImportant[374] = true;
		tileFrameImportant[461] = true;
		tileFrameImportant[709] = true;
		tileNoFail[373] = true;
		tileNoFail[375] = true;
		tileNoFail[374] = true;
		tileNoFail[461] = true;
		tileNoFail[709] = true;
		tileLighted[646] = true;
		tileFrameImportant[646] = true;
		tileWaterDeath[646] = true;
		tileLavaDeath[646] = true;
		tileLighted[372] = true;
		tileFrameImportant[372] = true;
		tileWaterDeath[372] = true;
		tileLavaDeath[372] = true;
		tileSolid[357] = true;
		tileBrick[357] = true;
		tileBrick[311] = true;
		tileSolid[408] = true;
		tileMergeDirt[408] = true;
		tileBrick[408] = true;
		tileBlockLight[408] = true;
		tileSolid[409] = true;
		tileBrick[409] = true;
		tileBlockLight[409] = true;
		tileSolid[669] = true;
		tileBrick[669] = true;
		tileBlockLight[669] = true;
		tileSolid[670] = true;
		tileBrick[670] = true;
		tileBlockLight[670] = true;
		tileSolid[671] = true;
		tileBrick[671] = true;
		tileBlockLight[671] = true;
		tileSolid[672] = true;
		tileBrick[672] = true;
		tileBlockLight[672] = true;
		tileSolid[673] = true;
		tileBrick[673] = true;
		tileBlockLight[673] = true;
		tileSolid[674] = true;
		tileBrick[674] = true;
		tileBlockLight[674] = true;
		tileSolid[675] = true;
		tileBrick[675] = true;
		tileBlockLight[675] = true;
		tileSolid[676] = true;
		tileBrick[676] = true;
		tileBlockLight[676] = true;
		tileSolid[677] = true;
		tileBrick[677] = true;
		tileBlockLight[677] = true;
		tileMergeDirt[677] = true;
		tileSolid[678] = true;
		tileBrick[678] = true;
		tileBlockLight[678] = true;
		tileMergeDirt[678] = true;
		tileSolid[679] = true;
		tileBrick[679] = true;
		tileBlockLight[679] = true;
		tileMergeDirt[679] = true;
		tileSolid[680] = true;
		tileBrick[680] = true;
		tileBlockLight[680] = true;
		tileMergeDirt[680] = true;
		tileSolid[681] = true;
		tileBrick[681] = true;
		tileBlockLight[681] = true;
		tileMergeDirt[681] = true;
		tileSolid[682] = true;
		tileBrick[682] = true;
		tileBlockLight[682] = true;
		tileMergeDirt[682] = true;
		tileSolid[683] = true;
		tileBrick[683] = true;
		tileBlockLight[683] = true;
		tileMergeDirt[683] = true;
		tileSolid[684] = true;
		tileBrick[684] = true;
		tileBlockLight[684] = true;
		tileMergeDirt[684] = true;
		tileSolid[685] = true;
		tileBrick[685] = true;
		tileBlockLight[685] = true;
		tileMergeDirt[685] = true;
		tileSolid[686] = true;
		tileBrick[686] = true;
		tileBlockLight[686] = true;
		tileMergeDirt[686] = true;
		tileSolid[666] = true;
		tileBlockLight[666] = true;
		tileBrick[666] = true;
		tileMergeDirt[666] = true;
		tileNoFail[666] = true;
		tileSolid[415] = true;
		tileBrick[415] = true;
		tileLighted[415] = true;
		tileBlockLight[415] = true;
		tileSolid[416] = true;
		tileBrick[416] = true;
		tileLighted[416] = true;
		tileBlockLight[416] = true;
		tileSolid[417] = true;
		tileBrick[417] = true;
		tileLighted[417] = true;
		tileBlockLight[417] = true;
		tileSolid[418] = true;
		tileBrick[418] = true;
		tileLighted[418] = true;
		tileBlockLight[418] = true;
		tileSolid[498] = true;
		tileBrick[498] = true;
		tileBlockLight[498] = true;
		tileBrick[37] = true;
		tileBrick[117] = true;
		tileBrick[25] = true;
		tileBrick[203] = true;
		tileSolid[232] = true;
		tileSolid[311] = true;
		tileBlockLight[311] = true;
		tileSolid[312] = true;
		tileBlockLight[313] = true;
		tileSolid[313] = true;
		tileBlockLight[312] = true;
		tileMergeDirt[311] = true;
		tileSolid[315] = true;
		tileBlockLight[315] = true;
		tileMergeDirt[315] = true;
		tileBrick[315] = true;
		tileSolid[641] = true;
		tileBlockLight[641] = true;
		tileMergeDirt[641] = true;
		tileBrick[641] = true;
		tileSolid[659] = true;
		tileBlockLight[659] = true;
		tileLighted[659] = true;
		tileBrick[659] = true;
		tileSolid[667] = true;
		tileBlockLight[667] = true;
		tileBrick[667] = true;
		tileLighted[667] = true;
		tileMergeDirt[667] = true;
		tileSolid[321] = true;
		tileSolid[322] = true;
		tileBlockLight[321] = true;
		tileBlockLight[322] = true;
		tileMergeDirt[321] = true;
		tileMergeDirt[322] = true;
		tileBrick[321] = true;
		tileBrick[322] = true;
		tileSolid[635] = true;
		tileBlockLight[635] = true;
		tileMergeDirt[635] = true;
		tileBrick[635] = true;
		tileFrameImportant[639] = true;
		tileLavaDeath[639] = true;
		tileSpelunker[639] = true;
		tileShine[639] = 300;
		tileShine2[639] = true;
		tileLavaDeath[668] = true;
		tileSolid[668] = true;
		tileBlockLight[668] = true;
		tileShine[239] = 1100;
		tileSolid[239] = true;
		tileSolidTop[239] = true;
		tileSolid[380] = true;
		tileSolidTop[380] = true;
		tileFrameImportant[358] = true;
		tileFrameImportant[359] = true;
		tileFrameImportant[360] = true;
		tileFrameImportant[361] = true;
		tileFrameImportant[362] = true;
		tileFrameImportant[363] = true;
		tileFrameImportant[364] = true;
		tileFrameImportant[391] = true;
		tileLighted[391] = true;
		tileFrameImportant[392] = true;
		tileFrameImportant[393] = true;
		tileFrameImportant[394] = true;
		tileFrameImportant[542] = true;
		tileFrameImportant[505] = true;
		tileFrameImportant[521] = true;
		tileFrameImportant[522] = true;
		tileFrameImportant[523] = true;
		tileFrameImportant[524] = true;
		tileFrameImportant[525] = true;
		tileFrameImportant[526] = true;
		tileFrameImportant[527] = true;
		tileFrameImportant[543] = true;
		tileFrameImportant[568] = true;
		tileFrameImportant[569] = true;
		tileFrameImportant[570] = true;
		tileFrameImportant[598] = true;
		tileFrameImportant[356] = true;
		tileFrameImportant[663] = true;
		tileFrameImportant[334] = true;
		tileFrameImportant[440] = true;
		tileFrameImportant[471] = true;
		tileFrameImportant[300] = true;
		tileFrameImportant[301] = true;
		tileFrameImportant[302] = true;
		tileFrameImportant[303] = true;
		tileFrameImportant[304] = true;
		tileFrameImportant[305] = true;
		tileFrameImportant[306] = true;
		tileFrameImportant[307] = true;
		tileFrameImportant[308] = true;
		tileFrameImportant[354] = true;
		tileLighted[354] = true;
		tileFrameImportant[499] = true;
		tileFrameImportant[355] = true;
		tileFrameImportant[699] = true;
		tileFrameImportant[324] = true;
		tileObsidianKill[324] = true;
		tileLavaDeath[324] = true;
		tileFrameImportant[463] = true;
		tileFrameImportant[491] = true;
		tileFrameImportant[464] = true;
		tileFrameImportant[466] = true;
		tileFrameImportant[419] = true;
		tileFrameImportant[442] = true;
		tileFrameImportant[443] = true;
		tileFrameImportant[444] = true;
		tileFrameImportant[420] = true;
		tileFrameImportant[423] = true;
		tileFrameImportant[424] = true;
		tileFrameImportant[428] = true;
		tileFrameImportant[520] = true;
		tileFrameImportant[429] = true;
		tileFrameImportant[445] = true;
		tileFrameImportant[476] = true;
		tileFrameImportant[283] = true;
		tileFrameImportant[288] = true;
		tileFrameImportant[289] = true;
		tileFrameImportant[290] = true;
		tileFrameImportant[291] = true;
		tileFrameImportant[292] = true;
		tileFrameImportant[293] = true;
		tileFrameImportant[294] = true;
		tileFrameImportant[295] = true;
		tileFrameImportant[296] = true;
		tileFrameImportant[297] = true;
		tileFrameImportant[316] = true;
		tileFrameImportant[317] = true;
		tileFrameImportant[318] = true;
		tileLargeFrames[284] = 1;
		wallHouse[224] = true;
		wallLargeFrames[224] = 2;
		wallHouse[323] = true;
		wallLargeFrames[323] = 2;
		wallHouse[324] = true;
		wallLargeFrames[324] = 2;
		wallHouse[325] = true;
		wallLargeFrames[325] = 2;
		wallHouse[326] = true;
		wallLargeFrames[326] = 2;
		wallHouse[327] = true;
		wallLargeFrames[327] = 2;
		wallHouse[328] = true;
		wallLargeFrames[328] = 2;
		wallHouse[329] = true;
		wallLargeFrames[329] = 2;
		wallHouse[330] = true;
		wallLargeFrames[330] = 2;
		wallHouse[331] = true;
		wallHouse[332] = true;
		wallHouse[333] = true;
		wallHouse[334] = true;
		wallHouse[335] = true;
		wallHouse[336] = true;
		wallHouse[337] = true;
		wallHouse[338] = true;
		wallHouse[339] = true;
		wallHouse[340] = true;
		wallHouse[341] = true;
		wallHouse[342] = true;
		wallHouse[343] = true;
		wallHouse[344] = true;
		wallHouse[345] = true;
		wallHouse[346] = true;
		wallHouse[60] = true;
		wallHouse[225] = true;
		wallHouse[226] = true;
		wallHouse[227] = true;
		wallHouse[231] = true;
		wallHouse[232] = true;
		wallHouse[233] = true;
		wallHouse[235] = true;
		wallHouse[234] = true;
		wallHouse[312] = true;
		wallHouse[313] = true;
		wallHouse[237] = true;
		wallHouse[238] = true;
		wallHouse[239] = true;
		wallHouse[240] = true;
		tileLargeFrames[409] = 2;
		tileLargeFrames[669] = 2;
		tileLargeFrames[670] = 2;
		tileLargeFrames[671] = 2;
		tileLargeFrames[672] = 2;
		tileLargeFrames[673] = 2;
		tileLargeFrames[674] = 2;
		tileLargeFrames[675] = 2;
		tileLargeFrames[676] = 2;
		tileFrameImportant[410] = true;
		tileFrameImportant[480] = true;
		tileFrameImportant[509] = true;
		tileFrameImportant[657] = true;
		tileFrameImportant[658] = true;
		tileLighted[658] = true;
		tileFrameImportant[720] = true;
		tileFrameImportant[721] = true;
		tileFrameImportant[725] = true;
		tileFrameImportant[733] = true;
		tileFrameImportant[751] = true;
		tileFrameImportant[752] = true;
		wallHouse[173] = true;
		wallHouse[183] = true;
		wallHouse[179] = true;
		wallLargeFrames[179] = 1;
		tileSolid[367] = true;
		tileBlockLight[367] = true;
		tileMergeDirt[367] = true;
		tileSolid[357] = true;
		tileBlockLight[357] = true;
		tileLargeFrames[357] = 1;
		tileBlendAll[357] = true;
		wallHouse[184] = true;
		wallHouse[181] = true;
		tileSolid[368] = true;
		tileBlockLight[368] = true;
		tileMergeDirt[368] = true;
		tileSolid[369] = true;
		tileBlockLight[369] = true;
		tileBrick[369] = true;
		tileMergeDirt[369] = true;
		wallHouse[186] = true;
		tileLargeFrames[325] = 1;
		tileSolid[325] = true;
		tileBlockLight[325] = true;
		wallLargeFrames[146] = 1;
		wallLargeFrames[147] = 1;
		wallLargeFrames[167] = 1;
		wallLargeFrames[185] = 2;
		wallLargeFrames[274] = 2;
		tileSolid[460] = true;
		tileSolid[326] = true;
		tileBlockLight[326] = true;
		tileBrick[326] = true;
		tileSolid[458] = true;
		tileBlockLight[458] = true;
		tileBrick[458] = true;
		tileSolid[459] = true;
		tileBrick[459] = true;
		tileSolid[327] = true;
		tileBlockLight[327] = true;
		tileBrick[327] = true;
		tileSolid[345] = true;
		tileBlockLight[345] = true;
		tileBrick[345] = true;
		tileLighted[327] = true;
		tileSolid[708] = true;
		tileBlockLight[708] = true;
		tileBrick[708] = true;
		tileLighted[708] = true;
		tileSolid[722] = true;
		tileBlockLight[722] = true;
		tileBrick[722] = true;
		tileMergeDirt[722] = true;
		tileSolid[734] = true;
		tileBrick[734] = true;
		tileMergeDirt[734] = true;
		tileBlockLight[734] = true;
		tileSolid[735] = true;
		tileBrick[735] = true;
		tileBlockLight[735] = true;
		tileLargeFrames[735] = 2;
		tileSolid[736] = true;
		tileBrick[736] = true;
		tileBlockLight[736] = true;
		tileLargeFrames[736] = 1;
		wallLargeFrames[354] = 1;
		tileSolid[737] = true;
		tileBrick[737] = true;
		tileBlockLight[737] = true;
		tileLargeFrames[737] = 2;
		wallLargeFrames[355] = 2;
		tileSolid[738] = true;
		tileBrick[738] = true;
		tileBlockLight[738] = true;
		tileSolid[739] = true;
		tileBlockLight[739] = true;
		tileLighted[739] = true;
		tileSolid[741] = true;
		tileBrick[741] = true;
		tileBlockLight[741] = true;
		tileLargeFrames[741] = 2;
		wallLargeFrames[358] = 2;
		tileSolid[742] = true;
		tileBrick[742] = true;
		tileBlockLight[742] = true;
		tileLargeFrames[742] = 2;
		wallLargeFrames[359] = 2;
		tileSolid[743] = true;
		tileBrick[743] = true;
		tileBlockLight[743] = true;
		tileLargeFrames[743] = 2;
		tileSolid[744] = true;
		tileBrick[744] = true;
		tileBlockLight[744] = true;
		tileMergeDirt[744] = true;
		tileSolid[745] = true;
		tileBrick[745] = true;
		tileBlockLight[745] = true;
		tileLargeFrames[745] = 2;
		wallLargeFrames[362] = 2;
		tileSolid[750] = true;
		tileBrick[750] = true;
		tileMergeDirt[750] = true;
		tileBlockLight[750] = true;
		tileSolid[746] = true;
		tileBrick[746] = true;
		tileBlockLight[746] = true;
		tileLargeFrames[746] = 2;
		wallLargeFrames[363] = 2;
		tileSolid[747] = true;
		tileBrick[747] = true;
		tileBlockLight[747] = true;
		tileSolid[748] = true;
		tileBrick[748] = true;
		tileSolid[749] = true;
		tileBrick[749] = true;
		tileBlockLight[749] = true;
		tileLargeFrames[749] = 2;
		wallLargeFrames[366] = 2;
		tileSolid[740] = true;
		tileBrick[740] = true;
		tileMergeDirt[740] = true;
		tileBlockLight[740] = true;
		tileSolid[328] = true;
		tileBrick[328] = true;
		tileSolid[329] = true;
		tileBrick[329] = true;
		tileBlockLight[329] = true;
		tileSolid[507] = true;
		tileBlockLight[507] = true;
		tileBrick[507] = true;
		tileSolid[508] = true;
		tileBlockLight[508] = true;
		tileBrick[508] = true;
		tileLighted[336] = true;
		tileLighted[340] = true;
		tileLighted[341] = true;
		tileLighted[342] = true;
		tileLighted[343] = true;
		tileLighted[344] = true;
		tileLighted[349] = true;
		tileLighted[598] = true;
		tileSolid[421] = true;
		tileBlockLight[421] = true;
		tileSolid[422] = true;
		tileBlockLight[422] = true;
		tileSolid[426] = true;
		tileBlockLight[426] = true;
		tileSolid[430] = true;
		tileBlockLight[430] = true;
		tileSolid[431] = true;
		tileBlockLight[431] = true;
		tileSolid[432] = true;
		tileBlockLight[432] = true;
		tileSolid[433] = true;
		tileBlockLight[433] = true;
		tileSolid[434] = true;
		tileBlockLight[434] = true;
		for (ushort num = 727; num <= 732; num++)
		{
			tileSolid[num] = true;
			tileBlockLight[num] = true;
		}
		tileSolid[446] = true;
		tileSolid[447] = true;
		tileSolid[448] = true;
		tileFrameImportant[427] = true;
		tileSolidTop[427] = true;
		tileSolid[427] = true;
		tileNoAttach[427] = true;
		tileTable[427] = true;
		tileLavaDeath[427] = true;
		tileNoSunLight[427] = false;
		tileSolid[476] = true;
		for (int num2 = 435; num2 <= 439; num2++)
		{
			tileFrameImportant[num2] = true;
			tileSolidTop[num2] = true;
			tileSolid[num2] = true;
			tileNoAttach[num2] = true;
			tileTable[num2] = true;
			tileLavaDeath[num2] = true;
			tileNoSunLight[num2] = false;
		}
		tileSolid[284] = true;
		tileBlockLight[284] = true;
		tileSolid[346] = true;
		tileBlockLight[346] = true;
		tileLighted[346] = true;
		tileShine[346] = 2000;
		tileShine2[346] = true;
		tileBrick[346] = true;
		tileMergeDirt[346] = true;
		tileSolid[347] = true;
		tileBlockLight[347] = true;
		tileLighted[347] = true;
		tileShine[347] = 1900;
		tileShine2[347] = true;
		tileBrick[347] = true;
		tileMergeDirt[347] = true;
		tileSolid[348] = true;
		tileBlockLight[348] = true;
		tileLighted[348] = true;
		tileShine[348] = 1800;
		tileShine2[348] = true;
		tileBrick[348] = true;
		tileMergeDirt[348] = true;
		tileSolid[350] = true;
		tileBlockLight[350] = true;
		tileLighted[350] = true;
		tileBrick[350] = true;
		tileMergeDirt[350] = true;
		tileGlowMask[350] = 94;
		tileGlowMask[390] = 130;
		tileGlowMask[381] = 126;
		tileGlowMask[517] = 258;
		tileGlowMask[687] = 336;
		tileGlowMask[534] = 259;
		tileGlowMask[535] = 260;
		tileGlowMask[689] = 338;
		tileGlowMask[536] = 261;
		tileGlowMask[537] = 262;
		tileGlowMask[690] = 339;
		tileGlowMask[539] = 263;
		tileGlowMask[540] = 264;
		tileGlowMask[688] = 337;
		tileGlowMask[625] = 311;
		tileGlowMask[626] = 312;
		tileGlowMask[691] = 340;
		tileGlowMask[627] = 313;
		tileGlowMask[628] = 314;
		tileGlowMask[692] = 341;
		tileGlowMask[370] = 111;
		tileGlowMask[429] = 214;
		tileGlowMask[209] = 215;
		tileGlowMask[445] = 214;
		tileGlowMask[129] = -2;
		tileGlowMask[633] = 326;
		tileGlowMask[659] = 348;
		tileGlowMask[667] = 349;
		tileGlowMask[708] = 359;
		tileGlowMask[699] = 353;
		tileLighted[429] = true;
		tileLighted[209] = true;
		tileGlowMask[717] = 362;
		tileSolid[717] = true;
		tileSolid[718] = true;
		tileSolid[719] = true;
		tileLighted[719] = true;
		tileLighted[717] = true;
		tileLighted[718] = true;
		tileGlowMask[410] = 201;
		tileGlowMask[509] = 265;
		tileGlowMask[658] = 333;
		tileGlowMask[720] = 368;
		tileGlowMask[721] = 369;
		tileGlowMask[725] = 371;
		tileSolid[370] = true;
		tileBlockLight[370] = true;
		tileLighted[370] = true;
		tileShine[370] = 1900;
		tileShine2[370] = true;
		tileBrick[370] = true;
		tileMergeDirt[370] = true;
		tileContainer[21] = true;
		tileContainer[467] = true;
		tileContainer[88] = true;
		tileContainer[470] = true;
		tileContainer[475] = true;
		tileSign[55] = true;
		tileSign[85] = true;
		tileSign[425] = true;
		tileSign[573] = true;
		tileSolid[383] = true;
		tileBrick[383] = true;
		tileBlockLight[383] = true;
		tileSolid[385] = true;
		tileBrick[385] = true;
		tileBlockLight[385] = true;
		tileSolid[472] = true;
		tileBrick[472] = true;
		tileMergeDirt[472] = true;
		tileBlockLight[472] = true;
		tileSolid[726] = true;
		tileBlockLight[726] = true;
		tileFrameImportant[726] = true;
		tileSolid[473] = true;
		tileBrick[473] = true;
		tileMergeDirt[473] = true;
		tileBlockLight[473] = true;
		tileSolid[500] = true;
		tileBrick[500] = true;
		tileLighted[500] = true;
		tileMergeDirt[500] = true;
		tileBlockLight[500] = true;
		tileSolid[501] = true;
		tileBrick[501] = true;
		tileLighted[501] = true;
		tileMergeDirt[501] = true;
		tileBlockLight[501] = true;
		tileSolid[502] = true;
		tileBrick[502] = true;
		tileLighted[502] = true;
		tileMergeDirt[502] = true;
		tileBlockLight[502] = true;
		tileSolid[503] = true;
		tileBrick[503] = true;
		tileLighted[503] = true;
		tileMergeDirt[503] = true;
		tileBlockLight[503] = true;
		tileSolid[541] = true;
		tileBlockLight[541] = false;
		tileSolid[546] = true;
		tileBlockLight[546] = false;
		tileSolid[557] = true;
		tileBlockLight[557] = true;
		tileSolid[474] = true;
		tileBrick[474] = true;
		tileMergeDirt[474] = true;
		tileBlockLight[474] = true;
		tileSolid[478] = true;
		tileBrick[478] = true;
		tileMergeDirt[478] = true;
		tileBlockLight[478] = true;
		tileSolid[479] = true;
		tileBrick[479] = true;
		tileMergeDirt[479] = true;
		tileBlockLight[479] = true;
		tileSolid[562] = true;
		tileBrick[562] = true;
		tileBlockLight[562] = true;
		tileMergeDirt[562] = true;
		tileSolid[563] = true;
		tileBrick[563] = true;
		tileBlockLight[563] = true;
		tileMergeDirt[563] = true;
		tileSolid[496] = true;
		tileBrick[496] = true;
		tileMergeDirt[496] = true;
		tileBlockLight[496] = true;
		tileSolid[495] = true;
		tileBrick[495] = true;
		tileMergeDirt[495] = true;
		tileBlockLight[495] = true;
		tileSolid[396] = true;
		tileBlockLight[396] = true;
		tileSolid[397] = true;
		tileBlockLight[397] = true;
		tileSolid[399] = true;
		tileBlockLight[399] = true;
		tileSolid[401] = true;
		tileBlockLight[401] = true;
		tileSolid[398] = true;
		tileBlockLight[398] = true;
		tileSolid[400] = true;
		tileBlockLight[400] = true;
		tileSolid[402] = true;
		tileBlockLight[402] = true;
		tileSolid[403] = true;
		tileBlockLight[403] = true;
		tileSolid[404] = true;
		tileBlockLight[404] = true;
		tileSolid[407] = true;
		tileBlockLight[407] = true;
		tileShine2[407] = true;
		tileShine[407] = 1000;
		tileFrameImportant[36] = true;
		tileFrameImportant[275] = true;
		tileFrameImportant[276] = true;
		tileFrameImportant[277] = true;
		tileFrameImportant[278] = true;
		tileFrameImportant[279] = true;
		tileFrameImportant[280] = true;
		tileFrameImportant[281] = true;
		tileFrameImportant[282] = true;
		tileFrameImportant[285] = true;
		tileFrameImportant[286] = true;
		tileFrameImportant[414] = true;
		tileFrameImportant[413] = true;
		tileFrameImportant[309] = true;
		tileFrameImportant[310] = true;
		tileFrameImportant[339] = true;
		tileFrameImportant[532] = true;
		tileLighted[286] = true;
		tileLighted[302] = true;
		tileFrameImportant[298] = true;
		tileFrameImportant[299] = true;
		tileSolid[170] = true;
		tileBlockLight[170] = true;
		tileFrameImportant[171] = true;
		tileLighted[171] = true;
		tileFrameImportant[247] = true;
		tileFrameImportant[245] = true;
		tileFrameImportant[246] = true;
		tileFrameImportant[239] = true;
		tileFrameImportant[240] = true;
		tileFrameImportant[241] = true;
		tileFrameImportant[242] = true;
		tileFrameImportant[243] = true;
		tileFrameImportant[244] = true;
		tileFrameImportant[254] = true;
		tileSolid[221] = true;
		tileBlockLight[221] = true;
		tileMergeDirt[221] = true;
		tileLighted[96] = true;
		tileMergeDirt[250] = true;
		tileSolid[272] = true;
		tileBlockLight[272] = true;
		tileSolid[229] = true;
		tileBlockLight[229] = true;
		tileMergeDirt[229] = true;
		tileSolid[230] = true;
		tileBlockLight[230] = true;
		tileMergeDirt[230] = true;
		tileSolid[222] = true;
		tileBlockLight[222] = true;
		tileMergeDirt[222] = true;
		tileSolid[223] = true;
		tileBlockLight[223] = true;
		tileMergeDirt[223] = true;
		tileSolid[224] = true;
		tileBlockLight[224] = true;
		tileFrameImportant[237] = true;
		tileFrameImportant[238] = true;
		tileSolid[225] = true;
		tileBlockLight[225] = true;
		tileBrick[225] = true;
		tileSolid[226] = true;
		tileBlockLight[226] = true;
		tileBrick[226] = true;
		tileSolid[235] = true;
		tileBlockLight[235] = true;
		tileFrameImportant[235] = true;
		tileLighted[238] = true;
		tileCut[254] = true;
		tileFrameImportant[236] = true;
		tileFrameImportant[702] = true;
		tileCut[236] = true;
		tileSolid[191] = true;
		tileBrick[191] = true;
		tileBlockLight[191] = true;
		tileSolid[211] = true;
		tileBlockLight[211] = true;
		tileSolid[208] = true;
		tileBrick[208] = true;
		tileBlockLight[208] = true;
		tileSolid[192] = true;
		tileBlockLight[192] = true;
		tileSolid[193] = true;
		tileBrick[193] = true;
		tileBlockLight[193] = true;
		tileMergeDirt[193] = true;
		tileSolid[194] = true;
		tileBrick[194] = true;
		tileBlockLight[194] = true;
		tileSolid[195] = true;
		tileBrick[195] = true;
		tileMergeDirt[195] = true;
		tileBlockLight[195] = true;
		tileBlockLight[200] = true;
		tileSolid[200] = true;
		tileBrick[200] = true;
		tileBlockLight[203] = true;
		tileSolid[203] = true;
		tileMergeDirt[203] = true;
		tileBlockLight[204] = true;
		tileSolid[204] = true;
		tileMergeDirt[204] = true;
		tileBlockLight[165] = true;
		tileShine2[147] = true;
		tileShine2[161] = true;
		tileShine2[163] = true;
		tileShine2[164] = true;
		tileSolid[189] = true;
		tileBlockLight[51] = true;
		tileBlockLight[697] = true;
		tileNoFail[51] = true;
		tileNoFail[697] = true;
		tileLighted[204] = true;
		tileShine[204] = 1150;
		tileShine2[204] = true;
		tileSolid[190] = true;
		tileBlockLight[190] = true;
		tileBrick[190] = true;
		tileSolid[198] = true;
		tileMergeDirt[198] = true;
		tileBrick[198] = true;
		tileBlockLight[198] = true;
		tileSolid[206] = true;
		tileBlockLight[206] = true;
		tileMergeDirt[206] = true;
		tileBrick[206] = true;
		tileBlockLight[234] = true;
		tileSolid[248] = true;
		tileSolid[249] = true;
		tileSolid[250] = true;
		tileBrick[248] = true;
		tileBrick[249] = true;
		tileBrick[250] = true;
		tileSolid[251] = true;
		tileSolid[252] = true;
		tileBrick[252] = true;
		tileSolid[253] = true;
		tileBrick[253] = true;
		tileMergeDirt[251] = true;
		tileMergeDirt[252] = true;
		tileMergeDirt[253] = true;
		tileBlockLight[251] = true;
		tileBlockLight[252] = true;
		tileBlockLight[253] = true;
		tileBlockLight[248] = true;
		tileBlockLight[249] = true;
		tileBlockLight[250] = true;
		tileLargeFrames[273] = 1;
		tileSolid[273] = true;
		tileBlockLight[273] = true;
		tileLargeFrames[274] = 1;
		tileSolid[274] = true;
		tileBlockLight[274] = true;
		tileLargeFrames[618] = 1;
		tileSolid[618] = true;
		tileBlockLight[618] = true;
		for (int num3 = 255; num3 <= 268; num3++)
		{
			tileSolid[num3] = true;
			if (num3 > 261)
			{
				tileLighted[num3] = true;
				tileShine2[num3] = true;
			}
		}
		tileFrameImportant[269] = true;
		tileFrameImportant[470] = true;
		tileFrameImportant[475] = true;
		tileFrameImportant[390] = true;
		tileFrameImportant[597] = true;
		tileLighted[597] = true;
		tileNoAttach[390] = true;
		tileLavaDeath[390] = true;
		tileLighted[390] = true;
		tileFrameImportant[617] = true;
		wallHouse[168] = true;
		wallHouse[169] = true;
		wallHouse[142] = true;
		wallHouse[143] = true;
		wallHouse[144] = true;
		wallHouse[149] = true;
		wallHouse[151] = true;
		wallHouse[150] = true;
		wallHouse[152] = true;
		wallHouse[145] = true;
		wallHouse[148] = true;
		wallHouse[175] = true;
		wallHouse[176] = true;
		wallHouse[182] = true;
		for (int num4 = 153; num4 < 167; num4++)
		{
			wallHouse[num4] = true;
		}
		wallHouse[146] = true;
		wallHouse[147] = true;
		wallHouse[149] = true;
		wallHouse[167] = true;
		wallHouse[168] = true;
		wallHouse[133] = true;
		wallHouse[134] = true;
		wallHouse[135] = true;
		wallHouse[136] = true;
		wallHouse[137] = true;
		wallHouse[75] = true;
		wallHouse[76] = true;
		wallHouse[78] = true;
		wallHouse[82] = true;
		wallHouse[77] = true;
		wallHouse[1] = true;
		wallHouse[4] = true;
		wallHouse[5] = true;
		wallHouse[6] = true;
		wallHouse[10] = true;
		wallHouse[11] = true;
		wallHouse[12] = true;
		wallHouse[16] = true;
		wallHouse[17] = true;
		wallHouse[18] = true;
		wallHouse[19] = true;
		wallHouse[20] = true;
		wallHouse[21] = true;
		wallHouse[22] = true;
		wallHouse[23] = true;
		wallHouse[24] = true;
		wallHouse[25] = true;
		wallHouse[26] = true;
		wallHouse[27] = true;
		wallHouse[29] = true;
		wallHouse[30] = true;
		wallHouse[31] = true;
		wallHouse[32] = true;
		wallHouse[33] = true;
		wallHouse[34] = true;
		wallHouse[35] = true;
		wallHouse[36] = true;
		wallHouse[37] = true;
		wallHouse[38] = true;
		wallHouse[39] = true;
		wallHouse[41] = true;
		wallHouse[42] = true;
		wallHouse[43] = true;
		wallHouse[44] = true;
		wallHouse[45] = true;
		wallHouse[46] = true;
		wallHouse[47] = true;
		wallHouse[66] = true;
		wallHouse[67] = true;
		wallHouse[68] = true;
		wallHouse[72] = true;
		wallHouse[73] = true;
		wallHouse[107] = true;
		wallHouse[106] = true;
		wallHouse[245] = true;
		wallHouse[315] = true;
		wallHouse[316] = true;
		wallHouse[317] = true;
		wallHouse[109] = true;
		wallHouse[110] = true;
		wallHouse[111] = true;
		wallHouse[112] = true;
		wallHouse[113] = true;
		wallHouse[114] = true;
		wallHouse[115] = true;
		wallHouse[116] = true;
		wallHouse[117] = true;
		wallHouse[118] = true;
		wallHouse[119] = true;
		wallHouse[120] = true;
		wallHouse[121] = true;
		wallHouse[122] = true;
		wallHouse[123] = true;
		wallHouse[124] = true;
		wallHouse[125] = true;
		wallHouse[108] = true;
		wallHouse[100] = true;
		wallHouse[101] = true;
		wallHouse[102] = true;
		wallHouse[103] = true;
		wallHouse[104] = true;
		wallHouse[105] = true;
		wallHouse[84] = true;
		wallHouse[74] = true;
		wallHouse[241] = true;
		wallHouse[85] = true;
		wallHouse[88] = true;
		wallHouse[89] = true;
		wallHouse[90] = true;
		wallHouse[91] = true;
		wallHouse[92] = true;
		wallHouse[93] = true;
		wallHouse[126] = true;
		wallHouse[127] = true;
		wallHouse[128] = true;
		wallHouse[129] = true;
		wallHouse[130] = true;
		wallHouse[131] = true;
		wallHouse[132] = true;
		wallHouse[138] = true;
		wallHouse[139] = true;
		wallHouse[140] = true;
		wallHouse[141] = true;
		wallHouse[177] = true;
		wallHouse[172] = true;
		wallHouse[242] = true;
		wallHouse[243] = true;
		wallHouse[174] = true;
		wallHouse[230] = true;
		wallHouse[228] = true;
		wallHouse[229] = true;
		wallHouse[236] = true;
		wallHouse[319] = true;
		wallHouse[318] = true;
		wallHouse[321] = true;
		wallHouse[322] = true;
		wallHouse[320] = true;
		wallHouse[347] = true;
		wallHouse[348] = true;
		wallHouse[351] = true;
		wallHouse[352] = true;
		wallHouse[353] = true;
		wallHouse[354] = true;
		wallHouse[355] = true;
		wallHouse[356] = true;
		wallHouse[357] = true;
		wallHouse[358] = true;
		wallHouse[359] = true;
		wallHouse[360] = true;
		wallHouse[361] = true;
		wallHouse[362] = true;
		wallHouse[363] = true;
		wallHouse[364] = true;
		wallHouse[365] = true;
		wallHouse[366] = true;
		wallHouse[246] = true;
		wallHouse[247] = true;
		wallHouse[248] = true;
		wallHouse[249] = true;
		wallHouse[250] = true;
		wallHouse[251] = true;
		wallHouse[252] = true;
		wallHouse[253] = true;
		wallHouse[254] = true;
		wallHouse[255] = true;
		wallHouse[314] = true;
		wallHouse[256] = true;
		wallHouse[257] = true;
		wallHouse[258] = true;
		wallHouse[259] = true;
		wallHouse[260] = true;
		wallHouse[261] = true;
		wallHouse[262] = true;
		wallHouse[263] = true;
		wallHouse[264] = true;
		wallHouse[265] = true;
		wallHouse[266] = true;
		wallHouse[267] = true;
		wallHouse[268] = true;
		wallHouse[269] = true;
		wallHouse[270] = true;
		wallHouse[271] = true;
		wallHouse[272] = true;
		wallHouse[273] = true;
		wallHouse[274] = true;
		wallHouse[275] = true;
		wallHouse[276] = true;
		wallHouse[277] = true;
		wallHouse[278] = true;
		wallHouse[279] = true;
		wallHouse[280] = true;
		wallHouse[281] = true;
		wallHouse[282] = true;
		wallHouse[283] = true;
		wallHouse[284] = true;
		wallHouse[285] = true;
		wallHouse[286] = true;
		wallHouse[287] = true;
		wallHouse[288] = true;
		wallHouse[289] = true;
		wallHouse[290] = true;
		wallHouse[291] = true;
		wallHouse[292] = true;
		wallHouse[293] = true;
		wallHouse[294] = true;
		wallHouse[295] = true;
		wallHouse[296] = true;
		wallHouse[297] = true;
		wallHouse[298] = true;
		wallHouse[299] = true;
		wallHouse[300] = true;
		wallHouse[301] = true;
		wallHouse[302] = true;
		wallHouse[303] = true;
		wallHouse[304] = true;
		wallHouse[305] = true;
		wallHouse[306] = true;
		wallHouse[307] = true;
		wallHouse[308] = true;
		wallHouse[309] = true;
		wallHouse[310] = true;
		wallHouse[311] = true;
		wallLight[0] = true;
		wallLight[21] = true;
		wallLight[318] = true;
		wallLight[106] = true;
		wallLight[317] = true;
		wallLight[107] = true;
		wallLight[138] = true;
		wallLight[140] = true;
		wallLight[141] = true;
		wallLight[139] = true;
		wallLight[145] = true;
		wallLight[150] = true;
		wallLight[152] = true;
		wallLight[245] = true;
		wallLight[315] = true;
		wallLight[168] = true;
		for (int num5 = 0; num5 < WallID.Count; num5++)
		{
			wallDungeon[num5] = false;
		}
		wallDungeon[7] = true;
		wallDungeon[8] = true;
		wallDungeon[9] = true;
		wallDungeon[94] = true;
		wallDungeon[95] = true;
		wallDungeon[96] = true;
		wallDungeon[97] = true;
		wallDungeon[98] = true;
		wallDungeon[99] = true;
		SetupTileMerge();
	}

	private void ClientInitialize()
	{
		MessageBuffer.OnTileChangeReceived += OnTileChangeEvent;
		LanguageManager.Instance.OnLanguageChanged += delegate
		{
			ItemTooltip.InvalidateTooltips();
		};
		PlayerInput.OnBindingChange += ItemTooltip.InvalidateTooltips;
		clientUUID = Guid.NewGuid().ToString();
		_ = Terraria.Graphics.Effects.Filters.Scene;
		Platform.Current.InitializeClientServices(base.Window.Handle);
		Platform.Get<IImeService>().AddKeyListener(delegate(char keyStroke)
		{
			if (keyCount < keyInt.Length)
			{
				keyInt[keyCount] = keyStroke;
				keyString[keyCount] = keyStroke.ToString() ?? "";
				keyCount++;
			}
		});
		base.Window.AllowUserResizing = true;
		LoadSettings();
		PreventUpdatingTargets = false;
		SetDisplayMonitor();
		PlayerInput.CacheOriginalScreenDimensions();
		if (screenWidth > GraphicsAdapter.DefaultAdapter.CurrentDisplayMode.Width)
		{
			screenWidth = GraphicsAdapter.DefaultAdapter.CurrentDisplayMode.Width;
		}
		if (screenHeight > GraphicsAdapter.DefaultAdapter.CurrentDisplayMode.Height)
		{
			screenHeight = GraphicsAdapter.DefaultAdapter.CurrentDisplayMode.Height;
		}
		UpdateDisplaySettings();
		graphics.ApplyChanges();
		if (Main.OnResolutionChanged != null)
		{
			Main.OnResolutionChanged(new Vector2(screenWidth, screenHeight));
		}
		CheckBunny();
		base.GraphicsDevice.DeviceLost += GraphicsDeviceLost;
		base.GraphicsDevice.DeviceReset += GraphicsDeviceLost;
		base.GraphicsDevice.DeviceResetting += GraphicsDeviceLost;
		if (_needsLanguageSelect)
		{
			menuMode = 1212;
		}
		_achievements = new AchievementManager();
		_achievementAdvisor = new AchievementAdvisor();
		OpenRecent();
		UILinksInitializer.Load();
		Chroma = new ChromaEngine();
		ChromaPainter = new ChromaHotkeyPainter();
		ChromaPainter.CollectBoundKeys();
		CacheSupportedDisplaySizes();
		if (autoJoin)
		{
			menuMode = 1;
			menuMultiplayer = true;
		}
		fpsTimer.Start();
	}

	private static void CacheSupportedDisplaySizes()
	{
		numDisplayModes = 0;
		CollectDisplayResolutionsFromAdapter(GraphicsAdapter.DefaultAdapter);
		foreach (GraphicsAdapter adapter in GraphicsAdapter.Adapters)
		{
			if (adapter != GraphicsAdapter.DefaultAdapter)
			{
				CollectDisplayResolutionsFromAdapter(adapter);
			}
		}
		if (numDisplayModes == 0)
		{
			RegisterDisplayResolution(minScreenW, minScreenH);
		}
	}

	private static void CollectDisplayResolutionsFromAdapter(GraphicsAdapter adapter)
	{
		foreach (DisplayMode supportedDisplayMode in adapter.SupportedDisplayModes)
		{
			if (supportedDisplayMode.Width >= minScreenW && supportedDisplayMode.Width <= maxScreenW && supportedDisplayMode.Height >= minScreenH && supportedDisplayMode.Height <= maxScreenH && !IsModeOfSameResolutionRegistered(supportedDisplayMode))
			{
				RegisterDisplayResolution(supportedDisplayMode.Width, supportedDisplayMode.Height);
			}
		}
	}

	private static void RegisterDisplayResolution(int width, int height)
	{
		if (numDisplayModes >= displayWidth.Length)
		{
			Array.Resize(ref displayWidth, numDisplayModes * 2);
			Array.Resize(ref displayHeight, numDisplayModes * 2);
		}
		displayWidth[numDisplayModes] = width;
		displayHeight[numDisplayModes] = height;
		numDisplayModes++;
	}

	private static bool IsModeOfSameResolutionRegistered(DisplayMode mode)
	{
		for (int i = 0; i < numDisplayModes; i++)
		{
			if (mode.Width == displayWidth[i] && mode.Height == displayHeight[i])
			{
				return true;
			}
		}
		return false;
	}

	public static void LoadTestLog(string logname)
	{
	}

	private void OnceFailedLoadingAnAsset(string assetPath, Exception e)
	{
		FancyErrorPrinter.ShowFailedToLoadAssetError(e, assetPath);
	}

	private void AssetWatcherValueUpdated(IAsset asset)
	{
		NewTextMultiline(Language.GetTextValue("HotReload.Updated", asset.Name), force: false, new Microsoft.Xna.Framework.Color(250, 250, 0));
		_resetContentThatNeedsRenderTargetsNextFrame = true;
	}

	private void AssetWatcherUpdateFailed(IAsset asset, Exception e)
	{
		NewTextMultiline(Language.GetTextValue("HotReload.ErrorUpdating", asset.Name, e.Message), force: false, new Microsoft.Xna.Framework.Color(250, 50, 0));
	}

	internal void ContentFileUpdated(IContentSource contentSource, string path, string fullPath)
	{
		try
		{
			if (LanguageManager.Instance.HotReloadContentFile(contentSource, path, fullPath))
			{
				NewTextMultiline(Language.GetTextValue("HotReload.LocalizationsReloaded", path), force: false, new Microsoft.Xna.Framework.Color(250, 250, 0));
			}
		}
		catch (Exception ex)
		{
			NewTextMultiline(Language.GetTextValue("HotReload.ErrorUpdating", path, ex.Message), force: false, new Microsoft.Xna.Framework.Color(250, 50, 0));
		}
	}

	protected override void LoadContent()
	{
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_005a: Expected O, but got Unknown
		//IL_005a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0064: Expected O, but got Unknown
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		//IL_0080: Expected O, but got Unknown
		//IL_0080: Unknown result type (might be due to invalid IL or missing references)
		//IL_008a: Expected O, but got Unknown
		//IL_009c: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a6: Expected O, but got Unknown
		//IL_00a6: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b0: Expected O, but got Unknown
		//IL_014f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0155: Expected O, but got Unknown
		if (base.Services.Get<IAssetRepository>() == null)
		{
			AssetInitializer.CreateAssetServices(base.Services);
		}
		Assets = base.Services.Get<IAssetRepository>();
		Assets.AssetLoadFailHandler = OnceFailedLoadingAnAsset;
		IAssetRepository assets = Assets;
		assets.AssetWatcherValueUpdatedHandler = (AssetWatcherValueUpdated)Delegate.Combine((Delegate)(object)assets.AssetWatcherValueUpdatedHandler, (Delegate)new AssetWatcherValueUpdated(AssetWatcherValueUpdated));
		IAssetRepository assets2 = Assets;
		assets2.AssetWatcherUpdateFailedHandler = (AssetWatcherUpdateFailed)Delegate.Combine((Delegate)(object)assets2.AssetWatcherUpdateFailedHandler, (Delegate)new AssetWatcherUpdateFailed(AssetWatcherUpdateFailed));
		IAssetRepository assets3 = Assets;
		assets3.ContentFileUpdatedHandler = (ContentFileUpdated)Delegate.Combine((Delegate)(object)assets3.ContentFileUpdatedHandler, (Delegate)new ContentFileUpdated(ContentFileUpdated));
		spriteBatch = new SpriteBatch(base.GraphicsDevice);
		spriteBuffer = new SpriteDrawBuffer(base.GraphicsDevice);
		tileBatch = new TileBatch(base.GraphicsDevice);
		DebugDrawer = new BasicDebugDrawer(base.GraphicsDevice);
		GameViewMatrix = new SpriteViewMatrix(base.GraphicsDevice);
		BackgroundViewMatrix = new SpriteViewMatrix(base.GraphicsDevice);
		audioSystem = SoundEngine.Initialize();
		audioSystem.SetPlayCallback(102, RainbowBoulderMusicPlayCallback);
		AssetSourceController = new AssetSourceController(Assets, new IContentSource[1] { (IContentSource)new XnaContentSource(base.Content.RootDirectory) });
		VanillaContentValidator.Instance = new VanillaContentValidator("Terraria.IO.Data.ResourcePacksDefaultInfo.tsv");
		if (SocialAPI.Workshop != null)
		{
			SocialAPI.Workshop.LoadEarlyContent();
		}
		AssetSourceController.UseResourcePacks(AssetInitializer.CreateResourcePackList(base.Services));
		LoadContent_Shaders();
		AssetInitializer.LoadSplashAssets();
		ChromaInitializer.Load();
		_gameContentLoadProcess = LoadContent_Deferred();
		if (Setting_AssetFileWatcherEnabled)
		{
			Assets.EnableAssetWatcher();
		}
	}

	private void LoadContent_Shaders()
	{
		PixelShaderRef = Assets.Request<Effect>("PixelShader", AssetRequestMode.ImmediateLoad);
		TileShaderRef = Assets.Request<Effect>("TileShader", AssetRequestMode.ImmediateLoad);
		ScreenShaderRef = Assets.Request<Effect>("ScreenShader", AssetRequestMode.ImmediateLoad);
	}

	private void LoadContent_TryEnteringHiDef()
	{
		Configuration.Load();
		Configuration.Get("UseExperimentalFeatures", ref UseExperimentalFeatures);
		Configuration.Get("Support4K", ref Support4K);
		bool flag = Support4K && base.GraphicsDevice.Adapter.IsProfileSupported(GraphicsProfile.HiDef);
		if (GraphicsAdapter.DefaultAdapter.CurrentDisplayMode.Width <= MaxWorldViewSize.X && GraphicsAdapter.DefaultAdapter.CurrentDisplayMode.Height <= MaxWorldViewSize.Y)
		{
			flag = false;
		}
		if (Program.IsXna && Support4K && flag && base.GraphicsDevice.GraphicsProfile != GraphicsProfile.HiDef)
		{
			SetGraphicsProfile(GraphicsProfile.HiDef, forceSet: false);
		}
		else if (Program.IsFna)
		{
			SetGraphicsProfile(GraphicsProfile.HiDef, forceSet: true);
		}
	}

	protected IEnumerator LoadContent_Deferred()
	{
		QuickLoad.Load();
		IssueReporter = new GeneralIssueReporter();
		bool doneLoadingMusic = false;
		IEnumerator musicLoadProcedure = LoadMusic_InSteps();
		while (!doneLoadingMusic)
		{
			try
			{
				if (!musicLoadProcedure.MoveNext())
				{
					doneLoadingMusic = true;
				}
			}
			catch
			{
				doneLoadingMusic = true;
				musicVolume = 0f;
				soundVolume = 0f;
			}
			yield return null;
		}
		_musicLoaded = true;
		splashTimer.Start();
		yield return null;
		AssetInitializer.Load(asyncLoad: true);
		TownNPCHeadRenderer = new OutlinedTextureRenderer(TextureAssets.NpcHead);
		ContentThatNeedsRenderTargets.Add(TownNPCHeadRenderer);
		BossNPCHeadRenderer = new OutlinedTextureRenderer(TextureAssets.NpcHeadBoss);
		ContentThatNeedsRenderTargets.Add(BossNPCHeadRenderer);
		ItemMapIconRenderer = new OutlinedTextureRenderer(TextureAssets.Item);
		ContentThatNeedsRenderTargets.Add(ItemMapIconRenderer);
	}

	private static void PostContentLoadInitialize()
	{
		LiquidRenderer.LoadContent();
		AchievementInitializer.Load();
		AchievementAdvisor.Initialize();
		ScreenEffectInitializer.Load();
		InGameNotificationsTracker.Initialize();
		LinkButtonsInitializer.Load();
		_stardewAnimation = new StardewValleyAnimation();
		moonType = rand.Next(9);
		windSpeedCurrent = (float)rand.Next(-800, 801) * 0.001f;
		windSpeedTarget = windSpeedCurrent;
		numClouds = rand.Next(200);
		Mount.Initialize();
		Minecart.Initialize();
		CacheSupportedDisplaySizes();
		QuickLoad.OnContentLoaded();
	}

	private IEnumerator LoadMusic_InSteps()
	{
		IEnumerator sub1 = audioSystem.PrepareWaveBank();
		while (sub1.MoveNext())
		{
			yield return sub1.Current;
		}
		for (int i = 1; i < maxMusic; i++)
		{
			audioSystem.LoadCue(i, "Music_" + i);
		}
		audioSystem.LoadFromSources();
	}

	protected override void UnloadContent()
	{
	}

	public static void CheckForMoonEventsStartingTemporarySeasons()
	{
		if (netMode != 1)
		{
			bool num = forceHalloweenForToday;
			bool flag = forceXMasForToday;
			forceXMasForToday = false;
			forceHalloweenForToday = false;
			int waveNumber = NPC.waveNumber;
			_ = NPC.waveKills;
			if (pumpkinMoon && waveNumber >= 15)
			{
				forceHalloweenForToday = true;
			}
			if (snowMoon && waveNumber >= 15)
			{
				forceXMasForToday = true;
			}
			if (forceHalloweenForever)
			{
				forceHalloweenForToday = false;
			}
			if (forceXMasForever)
			{
				forceXMasForToday = false;
			}
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(50, 255, 130);
			if (num != forceHalloweenForToday)
			{
				WorldGen.BroadcastText(NetworkText.FromKey(forceHalloweenForToday ? "Misc.StartedVictoryHalloween" : "Misc.EndedVictoryHalloween"), color);
			}
			if (flag != forceXMasForToday)
			{
				WorldGen.BroadcastText(NetworkText.FromKey(forceXMasForToday ? "Misc.StartedVictoryXmas" : "Misc.EndedVictoryXmas"), color);
			}
		}
	}

	public static void CheckForMoonEventsScoreDisplay()
	{
		if (netMode != 1 && (pumpkinMoon || snowMoon))
		{
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(175, 75, 255);
			string key = "Misc.PumpkinMoonScore";
			if (snowMoon)
			{
				key = "Misc.FrostMoonScore";
			}
			WorldGen.BroadcastText(NetworkText.FromKey(key, NPC.totalInvasionPoints), color);
		}
	}

	public static void stopMoonEvent()
	{
		_ = NPC.waveNumber;
		_ = NPC.waveKills;
		if (pumpkinMoon)
		{
			pumpkinMoon = false;
			if (netMode != 1)
			{
				NPC.totalInvasionPoints = 0f;
				NPC.waveKills = 0f;
				NPC.waveNumber = 0;
			}
		}
		if (snowMoon)
		{
			snowMoon = false;
			if (netMode != 1)
			{
				NPC.totalInvasionPoints = 0f;
				NPC.waveKills = 0f;
				NPC.waveNumber = 0;
			}
		}
	}

	public static void startPumpkinMoon()
	{
		pumpkinMoon = true;
		snowMoon = false;
		bloodMoon = false;
		invasionProgress = -1;
		invasionProgressDisplayLeft = 0;
		invasionProgressAlpha = 0f;
		invasionProgressIcon = 0;
		if (netMode != 1)
		{
			NPC.totalInvasionPoints = 0f;
			NPC.waveKills = 0f;
			NPC.waveNumber = 1;
			NetworkText invasionWaveText = Lang.GetInvasionWaveText(1, 305);
			if (netMode == 0)
			{
				NewText(invasionWaveText.ToString(), 175, 75);
			}
			else if (netMode == 2)
			{
				ChatHelper.BroadcastChatMessage(invasionWaveText, new Microsoft.Xna.Framework.Color(175, 75, 255));
			}
			NPCDamageTracker.Start(new InvasionDamageTracker(-2));
		}
	}

	public static void startSnowMoon()
	{
		snowMoon = true;
		pumpkinMoon = false;
		bloodMoon = false;
		invasionProgress = -1;
		invasionProgressDisplayLeft = 0;
		invasionProgressAlpha = 0f;
		invasionProgressIcon = 0;
		if (netMode != 1)
		{
			NPC.totalInvasionPoints = 0f;
			NPC.waveKills = 0f;
			NPC.waveNumber = 1;
			NetworkText invasionWaveText = Lang.GetInvasionWaveText(1, 338, 342);
			if (netMode == 0)
			{
				NewText(invasionWaveText.ToString(), 175, 75);
			}
			else if (netMode == 2)
			{
				ChatHelper.BroadcastChatMessage(invasionWaveText, new Microsoft.Xna.Framework.Color(175, 75, 255));
			}
			NPCDamageTracker.Start(new InvasionDamageTracker(-1));
		}
	}

	protected void UpdateAudio()
	{
		if (!SoundEngine.IsAudioSupported || !_musicLoaded)
		{
			return;
		}
		if (!dedServ && !showSplash)
		{
			SoundEngine.Update();
		}
		if (musicVolume == 0f)
		{
			curMusic = 0;
		}
		try
		{
			if (dedServ)
			{
				return;
			}
			bool flag = base.IsActive || DebugOptions.noPause;
			if (!flag)
			{
				audioSystem.PauseAll();
				SoundEngine.StopAmbientSounds();
			}
			else
			{
				audioSystem.ResumeAll();
			}
			if (drunkWorld)
			{
				TOWMusicUnlocked = true;
			}
			if (gameMenu)
			{
				swapMusic = false;
			}
			bool flag2 = drunkWorld && !remixWorld && !getGoodWorld;
			if (swapMusic)
			{
				if (flag2)
				{
					UpdateAudio_DecideOnNewMusic();
				}
				else
				{
					UpdateAudio_DecideOnTOWMusic();
				}
			}
			else if (!gameMenu && flag2)
			{
				UpdateAudio_DecideOnTOWMusic();
			}
			else
			{
				UpdateAudio_DecideOnNewMusic();
			}
			if (SceneMetrics.ActiveMusicBox >= 0)
			{
				if (SceneMetrics.ActiveMusicBox == 0)
				{
					newMusic = 1;
				}
				if (SceneMetrics.ActiveMusicBox == 1)
				{
					newMusic = 2;
				}
				if (SceneMetrics.ActiveMusicBox == 2)
				{
					newMusic = 3;
				}
				if (SceneMetrics.ActiveMusicBox == 4)
				{
					newMusic = 4;
				}
				if (SceneMetrics.ActiveMusicBox == 5)
				{
					newMusic = 5;
				}
				if (SceneMetrics.ActiveMusicBox == 3)
				{
					newMusic = 6;
				}
				if (SceneMetrics.ActiveMusicBox == 6)
				{
					newMusic = 7;
				}
				if (SceneMetrics.ActiveMusicBox == 7)
				{
					newMusic = 8;
				}
				if (SceneMetrics.ActiveMusicBox == 9)
				{
					newMusic = 9;
				}
				if (SceneMetrics.ActiveMusicBox == 8)
				{
					newMusic = 10;
				}
				if (SceneMetrics.ActiveMusicBox == 11)
				{
					newMusic = 11;
				}
				if (SceneMetrics.ActiveMusicBox == 10)
				{
					newMusic = 12;
				}
				if (SceneMetrics.ActiveMusicBox == 12)
				{
					newMusic = 13;
				}
				if (SceneMetrics.ActiveMusicBox == 13)
				{
					newMusic = 14;
				}
				if (SceneMetrics.ActiveMusicBox == 14)
				{
					newMusic = 15;
				}
				if (SceneMetrics.ActiveMusicBox == 15)
				{
					newMusic = 16;
				}
				if (SceneMetrics.ActiveMusicBox == 16)
				{
					newMusic = 17;
				}
				if (SceneMetrics.ActiveMusicBox == 17)
				{
					newMusic = 18;
				}
				if (SceneMetrics.ActiveMusicBox == 18)
				{
					newMusic = 19;
				}
				if (SceneMetrics.ActiveMusicBox == 19)
				{
					newMusic = 20;
				}
				if (SceneMetrics.ActiveMusicBox == 20)
				{
					newMusic = 21;
				}
				if (SceneMetrics.ActiveMusicBox == 21)
				{
					newMusic = 22;
				}
				if (SceneMetrics.ActiveMusicBox == 22)
				{
					newMusic = 23;
				}
				if (SceneMetrics.ActiveMusicBox == 23)
				{
					newMusic = 24;
				}
				if (SceneMetrics.ActiveMusicBox == 24)
				{
					newMusic = 25;
				}
				if (SceneMetrics.ActiveMusicBox == 25)
				{
					newMusic = 26;
				}
				if (SceneMetrics.ActiveMusicBox == 26)
				{
					newMusic = 27;
				}
				if (SceneMetrics.ActiveMusicBox == 27)
				{
					newMusic = 29;
				}
				if (SceneMetrics.ActiveMusicBox == 28)
				{
					newMusic = 30;
				}
				if (SceneMetrics.ActiveMusicBox == 29)
				{
					newMusic = 31;
				}
				if (SceneMetrics.ActiveMusicBox == 30)
				{
					newMusic = 32;
				}
				if (SceneMetrics.ActiveMusicBox == 31)
				{
					newMusic = 33;
				}
				if (SceneMetrics.ActiveMusicBox == 32)
				{
					newMusic = 38;
				}
				if (SceneMetrics.ActiveMusicBox == 33)
				{
					newMusic = 37;
				}
				if (SceneMetrics.ActiveMusicBox == 34)
				{
					newMusic = 35;
				}
				if (SceneMetrics.ActiveMusicBox == 35)
				{
					newMusic = 36;
				}
				if (SceneMetrics.ActiveMusicBox == 36)
				{
					newMusic = 34;
				}
				if (SceneMetrics.ActiveMusicBox == 37)
				{
					newMusic = 39;
				}
				if (SceneMetrics.ActiveMusicBox == 38)
				{
					newMusic = 40;
				}
				if (SceneMetrics.ActiveMusicBox == 39)
				{
					newMusic = 41;
				}
				if (SceneMetrics.ActiveMusicBox == 40)
				{
					newMusic = 44;
				}
				if (SceneMetrics.ActiveMusicBox == 41)
				{
					newMusic = 48;
				}
				if (SceneMetrics.ActiveMusicBox == 42)
				{
					newMusic = 42;
				}
				if (SceneMetrics.ActiveMusicBox == 43)
				{
					newMusic = 43;
				}
				if (SceneMetrics.ActiveMusicBox == 44)
				{
					newMusic = 46;
				}
				if (SceneMetrics.ActiveMusicBox == 45)
				{
					newMusic = 47;
				}
				if (SceneMetrics.ActiveMusicBox == 46)
				{
					newMusic = 49;
				}
				if (SceneMetrics.ActiveMusicBox == 47)
				{
					newMusic = 51;
				}
				if (SceneMetrics.ActiveMusicBox == 48)
				{
					newMusic = 52;
				}
				if (SceneMetrics.ActiveMusicBox == 49)
				{
					newMusic = 53;
				}
				if (SceneMetrics.ActiveMusicBox == 50)
				{
					newMusic = 54;
				}
				if (SceneMetrics.ActiveMusicBox == 51)
				{
					newMusic = 55;
				}
				if (SceneMetrics.ActiveMusicBox == 52)
				{
					newMusic = 56;
				}
				if (SceneMetrics.ActiveMusicBox == 53)
				{
					newMusic = 57;
				}
				if (SceneMetrics.ActiveMusicBox == 54)
				{
					newMusic = 58;
				}
				if (SceneMetrics.ActiveMusicBox == 55)
				{
					newMusic = 59;
				}
				if (SceneMetrics.ActiveMusicBox == 56)
				{
					newMusic = 60;
				}
				if (SceneMetrics.ActiveMusicBox == 57)
				{
					newMusic = 61;
				}
				if (SceneMetrics.ActiveMusicBox == 58)
				{
					newMusic = 62;
				}
				if (SceneMetrics.ActiveMusicBox == 59)
				{
					newMusic = 63;
				}
				if (SceneMetrics.ActiveMusicBox == 60)
				{
					newMusic = 64;
				}
				if (SceneMetrics.ActiveMusicBox == 61)
				{
					newMusic = 65;
				}
				if (SceneMetrics.ActiveMusicBox == 62)
				{
					newMusic = 66;
				}
				if (SceneMetrics.ActiveMusicBox == 63)
				{
					newMusic = 67;
				}
				if (SceneMetrics.ActiveMusicBox == 64)
				{
					newMusic = 68;
				}
				if (SceneMetrics.ActiveMusicBox == 65)
				{
					newMusic = 69;
				}
				if (SceneMetrics.ActiveMusicBox == 66)
				{
					newMusic = 70;
				}
				if (SceneMetrics.ActiveMusicBox == 67)
				{
					newMusic = 71;
				}
				if (SceneMetrics.ActiveMusicBox == 68)
				{
					newMusic = 72;
				}
				if (SceneMetrics.ActiveMusicBox == 69)
				{
					newMusic = 73;
				}
				if (SceneMetrics.ActiveMusicBox == 70)
				{
					newMusic = 74;
				}
				if (SceneMetrics.ActiveMusicBox == 71)
				{
					newMusic = 75;
				}
				if (SceneMetrics.ActiveMusicBox == 72)
				{
					newMusic = 76;
				}
				if (SceneMetrics.ActiveMusicBox == 73)
				{
					newMusic = 77;
				}
				if (SceneMetrics.ActiveMusicBox == 74)
				{
					newMusic = 78;
				}
				if (SceneMetrics.ActiveMusicBox == 75)
				{
					newMusic = 79;
				}
				if (SceneMetrics.ActiveMusicBox == 76)
				{
					newMusic = 80;
				}
				if (SceneMetrics.ActiveMusicBox == 77)
				{
					newMusic = 81;
				}
				if (SceneMetrics.ActiveMusicBox == 78)
				{
					newMusic = 82;
				}
				if (SceneMetrics.ActiveMusicBox == 79)
				{
					newMusic = 83;
				}
				if (SceneMetrics.ActiveMusicBox == 80)
				{
					newMusic = 84;
				}
				if (SceneMetrics.ActiveMusicBox == 81)
				{
					newMusic = 85;
				}
				if (SceneMetrics.ActiveMusicBox == 82)
				{
					newMusic = 86;
				}
				if (SceneMetrics.ActiveMusicBox == 83)
				{
					newMusic = 87;
				}
				if (SceneMetrics.ActiveMusicBox == 84)
				{
					newMusic = 88;
				}
				if (SceneMetrics.ActiveMusicBox == 85)
				{
					newMusic = 89;
				}
				if (SceneMetrics.ActiveMusicBox == 86)
				{
					newMusic = 90;
				}
				if (SceneMetrics.ActiveMusicBox == 87)
				{
					newMusic = 91;
				}
				if (SceneMetrics.ActiveMusicBox == 88)
				{
					newMusic = 93;
				}
				if (SceneMetrics.ActiveMusicBox == 89)
				{
					newMusic = 96;
				}
				if (SceneMetrics.ActiveMusicBox == 90)
				{
					newMusic = 95;
				}
				if (SceneMetrics.ActiveMusicBox == 91)
				{
					newMusic = 94;
				}
				if (SceneMetrics.ActiveMusicBox == 92)
				{
					newMusic = 97;
				}
				if (SceneMetrics.ActiveMusicBox == 93)
				{
					newMusic = 98;
				}
				if (SceneMetrics.ActiveMusicBox == 94)
				{
					newMusic = 92;
				}
				if (SceneMetrics.ActiveMusicBox == 95)
				{
					newMusic = 99;
				}
				if (SceneMetrics.ActiveMusicBox == 96)
				{
					newMusic = 101;
				}
				if (SceneMetrics.ActiveMusicBox == 97)
				{
					newMusic = 100;
				}
				if (SceneMetrics.ActiveMusicBox == 98)
				{
					newMusic = 104;
				}
			}
			if (musicVolume == 0f)
			{
				newMusic = 0;
			}
			audioSystem.Update();
			audioSystem.UpdateMisc();
			curMusic = newMusic;
			float num = 1f;
			if (NPC.MoonLordCountdown > 0)
			{
				num = (float)NPC.MoonLordCountdown / (float)NPC.MaxMoonLordCountdown;
				num *= num;
				if ((float)NPC.MoonLordCountdown > (float)NPC.MaxMoonLordCountdown * 0.2f)
				{
					num = MathHelper.Lerp(0f, 1f, num);
				}
				else
				{
					num = 0f;
					curMusic = 0;
				}
				if (NPC.MoonLordCountdown == 1 && curMusic >= 1 && curMusic < maxMusic)
				{
					musicFade[curMusic] = 0f;
				}
			}
			bool isMainTrackAudible = musicFade[curMusic] > 0.25f;
			for (int i = 1; i < maxMusic; i++)
			{
				float num2 = musicFade[i] * musicVolume * num;
				if (i >= 62 && i <= 88)
				{
					num2 *= 0.9f;
				}
				else if (i == 52)
				{
					num2 *= 1.15f;
					if (num2 > 1f)
					{
						num2 = 1f;
					}
				}
				float num3 = shimmerAlpha;
				switch (i)
				{
				case 28:
				{
					float num8 = 0.5f;
					float num9 = cloudAlpha / 9f * 10f * num8 + (1f - num8);
					if (num3 > 0f)
					{
						num9 *= 1f - num3;
					}
					if (num9 > 1f)
					{
						num9 = 1f;
					}
					num9 *= (float)Math.Pow(atmo, 4.0);
					bool num10 = SceneMetrics.ZoneRain && !SceneMetrics.ZoneSnow;
					float trackVolume2 = musicFade[i];
					if (num10)
					{
						audioSystem.UpdateAmbientCueState(i, flag, ref trackVolume2, ambientVolume * num9);
					}
					else
					{
						audioSystem.UpdateAmbientCueTowardStopping(i, 0.005f, ref trackVolume2, ambientVolume * num9);
					}
					musicFade[i] = trackVolume2;
					break;
				}
				case 45:
				{
					float num4 = 0.7f;
					float num5 = Math.Abs(windSpeedCurrent) * num4 + (1f - num4);
					if (num3 > 0f)
					{
						num5 *= 1f - num3;
					}
					if (num5 > 1f)
					{
						num5 = 1f;
					}
					num5 *= 0.9f;
					float num6 = 20f;
					num5 *= (float)Math.Pow(atmo, 4.0);
					bool num7 = Math.Abs(windSpeedCurrent) >= num6 / 50f && SceneMetrics.SurfaceAtmospherics;
					float trackVolume = musicFade[i];
					if (num7)
					{
						audioSystem.UpdateAmbientCueState(i, flag, ref trackVolume, ambientVolume * num5);
					}
					else
					{
						audioSystem.UpdateAmbientCueTowardStopping(i, 0.005f, ref trackVolume, ambientVolume * num5);
					}
					musicFade[i] = trackVolume;
					break;
				}
				default:
					if (i == curMusic)
					{
						audioSystem.UpdateCommonTrack(flag, i, num2, ref musicFade[i]);
					}
					else
					{
						audioSystem.UpdateCommonTrackTowardStopping(i, num2, ref musicFade[i], isMainTrackAudible);
					}
					break;
				}
			}
			audioSystem.UpdateAudioEngine();
			if (musicError > 0)
			{
				musicError--;
			}
		}
		catch
		{
			musicError++;
			if (musicError >= 100)
			{
				musicError = 0;
				musicVolume = 0f;
			}
		}
	}

	private void UpdateAudio_DecideOnTOWMusic()
	{
		bool flag = false;
		bool flag2 = false;
		bool flag3 = false;
		bool flag4 = false;
		bool flag5 = false;
		bool flag6 = false;
		bool flag7 = false;
		bool flag8 = false;
		bool flag9 = false;
		bool flag10 = false;
		bool flag11 = false;
		bool flag12 = false;
		bool flag13 = false;
		bool flag14 = false;
		bool flag15 = false;
		bool flag16 = false;
		bool flag17 = false;
		if (!showSplash)
		{
			Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X, (int)screenPosition.Y, screenWidth, screenHeight);
			int num = 5000;
			for (int i = 0; i < maxNPCs; i++)
			{
				if (!npc[i].active)
				{
					continue;
				}
				num = 5000;
				int num2 = 0;
				switch (npc[i].type)
				{
				case 13:
				case 14:
				case 15:
					num2 = 1;
					break;
				case 26:
				case 27:
				case 28:
				case 29:
				case 111:
				case 471:
					num2 = 11;
					break;
				case 113:
				case 114:
					num2 = 3;
					break;
				case 125:
				case 126:
					num2 = 2;
					break;
				case 127:
				case 134:
					num2 = 2;
					break;
				case 143:
				case 144:
				case 145:
					num2 = 11;
					break;
				case 266:
					num2 = 1;
					break;
				case 212:
				case 213:
				case 214:
				case 215:
				case 216:
				case 491:
					num2 = 8;
					break;
				case 245:
					num2 = 2;
					break;
				case 222:
					num2 = 1;
					break;
				case 262:
				case 263:
				case 264:
					num2 = 6;
					break;
				case 381:
				case 382:
				case 383:
				case 385:
				case 386:
				case 388:
				case 389:
				case 390:
				case 391:
				case 395:
				case 520:
					num2 = 9;
					break;
				case 398:
					num2 = 7;
					break;
				case 422:
				case 493:
				case 507:
				case 517:
					num2 = 10;
					break;
				case 439:
					num2 = 2;
					break;
				case 438:
					if (npc[i].ai[1] == 1f)
					{
						num = 1600;
						num2 = 2;
					}
					break;
				case 379:
					if (npc[i].ai[3] >= 0f)
					{
						num = 1600;
						num2 = 2;
					}
					break;
				case 657:
					num2 = 13;
					break;
				case 636:
					num2 = 14;
					break;
				case 370:
					num2 = 15;
					break;
				case 668:
					num2 = 16;
					break;
				}
				if (NPCID.Sets.BelongsToInvasionOldOnesArmy[npc[i].type])
				{
					num2 = 12;
				}
				if (remixWorld && getGoodWorld && (npc[i].type == 127 || npc[i].type == 134 || npc[i].type == 125 || npc[i].type == 126))
				{
					num2 = 17;
				}
				if (num2 == 0 && npc[i].boss)
				{
					num2 = 1;
				}
				if (num2 == 0)
				{
					continue;
				}
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)(npc[i].position.X + (float)(npc[i].width / 2)) - num, (int)(npc[i].position.Y + (float)(npc[i].height / 2)) - num, num * 2, num * 2);
				if (rectangle.Intersects(value))
				{
					switch (num2)
					{
					case 1:
						flag = true;
						break;
					case 2:
						flag3 = true;
						break;
					case 3:
						flag4 = true;
						break;
					case 4:
						flag5 = true;
						break;
					case 5:
						flag6 = true;
						break;
					case 6:
						flag7 = true;
						break;
					case 7:
						flag8 = true;
						break;
					case 8:
						flag9 = true;
						break;
					case 9:
						flag10 = true;
						break;
					case 10:
						flag11 = true;
						break;
					case 11:
						flag12 = true;
						break;
					case 12:
						flag13 = true;
						break;
					case 13:
						flag14 = true;
						break;
					case 14:
						flag15 = true;
						break;
					case 15:
						flag16 = true;
						break;
					case 16:
						flag2 = true;
						break;
					case 17:
						flag17 = true;
						break;
					}
					break;
				}
			}
		}
		_ = (screenPosition.X + (float)(screenWidth / 2)) / 16f;
		if (musicVolume == 0f)
		{
			newMusic = 0;
			return;
		}
		float num3 = (float)maxTilesX / 4200f;
		num3 *= num3;
		float num4 = (float)((double)((screenPosition.Y + (float)(screenHeight / 2)) / 16f - (65f + 10f * num3)) / (worldSurface / 5.0));
		int num5 = (int)(SceneMetrics.Center.X / 16f);
		int num6 = (int)(SceneMetrics.Center.Y / 16f);
		Tile tile = (WorldGen.InWorld(num5, num6) ? Main.tile[num5, num6] : null);
		if (CreditsRollEvent.IsEventOngoing)
		{
			newMusic = 89;
		}
		else if (SceneMetrics.InTorchGodMinigame)
		{
			newMusic = 87;
		}
		else if (flag8)
		{
			newMusic = 84;
		}
		else if (flag17)
		{
			newMusic = 81;
		}
		else if (flag10)
		{
			newMusic = 82;
		}
		else if (flag11)
		{
			newMusic = 83;
		}
		else if (flag7)
		{
			newMusic = 85;
		}
		else if (flag15)
		{
			newMusic = 80;
		}
		else if (flag16)
		{
			newMusic = 80;
		}
		else if (flag3)
		{
			newMusic = 80;
		}
		else if (flag)
		{
			newMusic = 81;
		}
		else if (flag4)
		{
			newMusic = 87;
		}
		else if (flag5)
		{
			newMusic = 81;
		}
		else if (flag6)
		{
			newMusic = 81;
		}
		else if (flag14)
		{
			newMusic = 80;
		}
		else if (flag2)
		{
			newMusic = 80;
		}
		else if (flag9)
		{
			newMusic = 82;
		}
		else if (flag12)
		{
			newMusic = 82;
		}
		else if (flag13)
		{
			newMusic = 82;
		}
		else if (eclipse && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2))
		{
			newMusic = 79;
		}
		else if (eclipse && remixWorld)
		{
			newMusic = 79;
		}
		else if (remixWorld && bloodMoon && !SceneMetrics.ZoneCrimson && !SceneMetrics.ZoneCorrupt && (double)SceneMetrics.Center.Y > rockLayer * 16.0 && SceneMetrics.Center.Y <= (float)(UnderworldLayer * 16))
		{
			newMusic = 79;
		}
		else if (remixWorld && bloodMoon && SceneMetrics.Center.Y > (float)(UnderworldLayer * 16) && (double)(SceneMetrics.Center.X / 16f) > (double)maxTilesX * 0.37 + 50.0 && (double)(SceneMetrics.Center.X / 16f) < (double)maxTilesX * 0.63)
		{
			newMusic = 79;
		}
		else if (SceneMetrics.ZoneShimmer)
		{
			newMusic = 72;
		}
		else if (SceneMetrics.ZoneSandstorm)
		{
			newMusic = 66;
		}
		else if (SceneMetrics.Center.Y > (float)(UnderworldLayer * 16))
		{
			newMusic = 71;
		}
		else if (num4 < 1f)
		{
			newMusic = 70;
		}
		else if (tile != null && tile.wall == 87)
		{
			newMusic = 69;
		}
		else if (SceneMetrics.ZoneDungeon)
		{
			newMusic = 69;
		}
		else if ((bgStyle == 9 && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2)) || undergroundBackground == 2)
		{
			newMusic = 68;
		}
		else if (SceneMetrics.ZoneCorrupt)
		{
			if (SceneMetrics.ZoneCrimson && SceneMetrics.BloodTileCount > SceneMetrics.EvilTileCount)
			{
				if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = 76;
				}
				else
				{
					newMusic = 75;
				}
			}
			else if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 74;
			}
			else
			{
				newMusic = 73;
			}
		}
		else if (SceneMetrics.ZoneCrimson)
		{
			if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 76;
			}
			else
			{
				newMusic = 75;
			}
		}
		else if (SceneMetrics.ZoneMeteor)
		{
			newMusic = 79;
		}
		else if (SceneMetrics.ZoneGraveyard)
		{
			newMusic = 79;
		}
		else if (SceneMetrics.ZoneJungle)
		{
			if (remixWorld && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 70;
			}
			else
			{
				newMusic = 86;
			}
		}
		else if (SceneMetrics.ZoneSnow)
		{
			if (remixWorld)
			{
				if ((double)SceneMetrics.Center.Y < rockLayer * 16.0 + (double)(screenHeight / 2))
				{
					if ((double)SceneMetrics.Center.Y <= worldSurface * 16.0 + (double)(screenHeight / 2))
					{
						newMusic = 70;
					}
					else
					{
						newMusic = 77;
					}
				}
				else
				{
					newMusic = 72;
				}
			}
			else if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 77;
			}
			else
			{
				newMusic = 72;
			}
		}
		else if ((double)SceneMetrics.Center.Y >= worldSurface * 16.0 + (double)(screenHeight / 2) && !WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16))
		{
			if (remixWorld && (double)SceneMetrics.Center.Y >= rockLayer * 16.0 + (double)(screenHeight / 2))
			{
				if (SceneMetrics.ZoneUndergroundDesert)
				{
					newMusic = 66;
				}
				else if (cloudAlpha > 0f)
				{
					newMusic = 62;
				}
				else if (SceneMetrics.ZoneHallow)
				{
					newMusic = 88;
				}
				else if (SceneMetrics.ZoneDesert)
				{
					newMusic = 66;
				}
				else
				{
					newMusic = 62;
				}
			}
			else if (SceneMetrics.ZoneHallow)
			{
				newMusic = 78;
			}
			else if (SceneMetrics.ZoneUndergroundDesert)
			{
				newMusic = 66;
			}
			else
			{
				newMusic = 65;
			}
		}
		else if (dayTime && SceneMetrics.ZoneHallow)
		{
			if (cloudAlpha > 0f && !gameMenu)
			{
				newMusic = 62;
			}
			else
			{
				newMusic = 88;
			}
		}
		else if (_shouldUseStormMusic)
		{
			if (bloodMoon)
			{
				newMusic = 79;
			}
			else
			{
				newMusic = 62;
			}
		}
		else if (WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16))
		{
			if (bloodMoon)
			{
				newMusic = 79;
			}
			else
			{
				newMusic = 67;
			}
		}
		else if (SceneMetrics.ZoneDesert)
		{
			newMusic = 66;
		}
		else if (remixWorld)
		{
			newMusic = 70;
		}
		else if (dayTime)
		{
			if (cloudAlpha > 0f && !gameMenu)
			{
				newMusic = 62;
			}
			else
			{
				newMusic = 63;
			}
		}
		else if (!dayTime)
		{
			if (bloodMoon)
			{
				newMusic = 79;
			}
			else if (cloudAlpha > 0f && !gameMenu)
			{
				newMusic = 64;
			}
			else
			{
				newMusic = 64;
			}
		}
		if (((double)(screenPosition.Y / 16f) < worldSurface + 10.0 || remixWorld) && pumpkinMoon)
		{
			newMusic = 82;
		}
		if (((double)(screenPosition.Y / 16f) < worldSurface + 10.0 || remixWorld) && snowMoon)
		{
			newMusic = 82;
		}
	}

	private void UpdateAudio_DecideOnNewMusic()
	{
		bool flag = false;
		bool flag2 = false;
		bool flag3 = false;
		bool flag4 = false;
		bool flag5 = false;
		bool flag6 = false;
		bool flag7 = false;
		bool flag8 = false;
		bool flag9 = false;
		bool flag10 = false;
		bool flag11 = false;
		bool flag12 = false;
		bool flag13 = false;
		bool flag14 = false;
		bool flag15 = false;
		bool flag16 = false;
		bool flag17 = false;
		bool flag18 = false;
		bool flag19 = false;
		bool flag20 = false;
		bool flag21 = false;
		bool flag22 = false;
		bool flag23 = SceneMetrics.TownNPCCount >= 3 && !SceneMetrics.ZoneShadowCandle;
		bool flag24 = slimeRain;
		bool flag25 = false;
		bool flag26 = false;
		float num = 0f;
		for (int i = 0; i < maxMusic; i++)
		{
			if (musicFade[i] > num)
			{
				num = musicFade[i];
				if (num == 1f)
				{
					lastMusicPlayed = i;
				}
			}
		}
		if (lastMusicPlayed == 50)
		{
			musicNoCrossFade[51] = true;
		}
		if (!showSplash)
		{
			Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X, (int)screenPosition.Y, screenWidth, screenHeight);
			int num2 = 5000;
			for (int j = 0; j < maxNPCs; j++)
			{
				if (!npc[j].active)
				{
					continue;
				}
				num2 = 5000;
				int num3 = 0;
				switch (npc[j].type)
				{
				case 13:
				case 14:
				case 15:
					num3 = 23;
					break;
				case 35:
				case 36:
					num3 = 24;
					break;
				case 26:
				case 27:
				case 28:
				case 29:
				case 111:
				case 471:
				case 472:
					num3 = 11;
					break;
				case 113:
				case 114:
					num3 = 2;
					break;
				case 125:
				case 126:
					num3 = 21;
					break;
				case 134:
				case 135:
				case 136:
					num3 = 18;
					break;
				case 127:
				case 128:
				case 129:
				case 130:
				case 131:
					num3 = 22;
					break;
				case 143:
				case 144:
				case 145:
				case 266:
					num3 = 3;
					break;
				case 212:
				case 213:
				case 214:
				case 215:
				case 216:
				case 252:
				case 491:
				case 662:
					num3 = 8;
					break;
				case 245:
					num3 = 4;
					break;
				case 222:
					num3 = 5;
					break;
				case 262:
				case 263:
				case 264:
					num3 = 6;
					break;
				case 381:
				case 382:
				case 383:
				case 384:
				case 385:
				case 386:
				case 387:
				case 388:
				case 389:
				case 390:
				case 391:
				case 392:
				case 395:
				case 520:
					num3 = 9;
					break;
				case 398:
					num3 = 7;
					break;
				case 422:
				case 493:
				case 507:
				case 517:
					num3 = 10;
					break;
				case 438:
					if (npc[j].ai[1] == 1f)
					{
						num2 = 1600;
						num3 = 20;
					}
					break;
				case 379:
					if (npc[j].ai[3] >= 0f)
					{
						num2 = 1600;
						num3 = 20;
					}
					break;
				case 657:
					num3 = 13;
					break;
				case 636:
					num3 = 14;
					break;
				case 370:
					num3 = 15;
					break;
				case 668:
					num3 = 16;
					break;
				case 50:
					num3 = 19;
					break;
				case 439:
					num3 = 20;
					break;
				}
				if (NPCID.Sets.BelongsToInvasionOldOnesArmy[npc[j].type])
				{
					num3 = 12;
				}
				if (num3 == 0 && npc[j].boss)
				{
					num3 = 1;
				}
				if (remixWorld && getGoodWorld && (npc[j].type == 127 || npc[j].type == 134 || npc[j].type == 125 || npc[j].type == 126))
				{
					num3 = 17;
				}
				if (num3 == 0)
				{
					continue;
				}
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)(npc[j].position.X + (float)(npc[j].width / 2)) - num2, (int)(npc[j].position.Y + (float)(npc[j].height / 2)) - num2, num2 * 2, num2 * 2);
				if (rectangle.Intersects(value))
				{
					switch (num3)
					{
					case 1:
						flag = true;
						break;
					case 2:
						flag3 = true;
						break;
					case 3:
						flag4 = true;
						break;
					case 4:
						flag5 = true;
						break;
					case 5:
						flag6 = true;
						break;
					case 6:
						flag7 = true;
						break;
					case 7:
						flag8 = true;
						break;
					case 8:
						flag9 = true;
						break;
					case 9:
						flag10 = true;
						break;
					case 10:
						flag11 = true;
						break;
					case 11:
						flag12 = true;
						break;
					case 12:
						flag13 = true;
						break;
					case 13:
						flag14 = true;
						break;
					case 14:
						flag15 = true;
						break;
					case 15:
						flag16 = true;
						break;
					case 16:
						flag2 = true;
						break;
					case 17:
						flag17 = true;
						break;
					case 18:
						flag18 = true;
						break;
					case 19:
						flag19 = true;
						break;
					case 20:
						flag20 = true;
						break;
					case 21:
						flag21 = true;
						break;
					case 22:
						flag22 = true;
						break;
					case 23:
						flag25 = true;
						break;
					case 24:
						flag26 = true;
						break;
					}
					break;
				}
			}
		}
		_ = (screenPosition.X + (float)(screenWidth / 2)) / 16f;
		if (musicVolume == 0f)
		{
			newMusic = 0;
			return;
		}
		if (gameMenu)
		{
			if (netMode != 2)
			{
				if (WorldGen.drunkWorldGen)
				{
					if (WorldGen.remixWorldGen)
					{
						newMusic = 70;
					}
					else if (onlyShimmerOceanWorldsGeneration)
					{
						newMusic = 72;
					}
					else if (vampireSeed)
					{
						newMusic = 75;
					}
					else if (notTheBeesWorld)
					{
						newMusic = 86;
					}
					else
					{
						newMusic = 60;
					}
				}
				else if (WorldGen.remixWorldGen)
				{
					newMusic = 8;
				}
				else if (menuMode == 3000)
				{
					newMusic = 89;
				}
				else if (WorldGen.tenthAnniversaryWorldGen)
				{
					newMusic = 11;
				}
				else if (playOldTile && Main.titleMusicStyle == TitleMusicStyle.Current)
				{
					newMusic = 6;
				}
				else if (!_isAsyncLoadComplete && (Main.titleMusicStyle == TitleMusicStyle.Current || (Main.titleMusicStyle == TitleMusicStyle.Random && titleMusicStyleRandom == TitleMusicStyle.Current)))
				{
					newMusic = 50;
				}
				else if (!audioSystem.IsTrackPlaying(50))
				{
					TitleMusicStyle titleMusicStyle = Main.titleMusicStyle;
					if (titleMusicStyle == TitleMusicStyle.Random)
					{
						titleMusicStyle = titleMusicStyleRandom;
					}
					switch (titleMusicStyle)
					{
					case TitleMusicStyle.Console:
						newMusic = 60;
						break;
					case TitleMusicStyle.Old:
						newMusic = 6;
						break;
					default:
						newMusic = 51;
						break;
					}
					if (musicNoCrossFade[newMusic])
					{
						musicFade[newMusic] = 1f;
					}
				}
			}
			else
			{
				newMusic = 0;
			}
			return;
		}
		float num4 = (float)maxTilesX / 4200f;
		num4 *= num4;
		float num5 = (float)((double)((screenPosition.Y + (float)(screenHeight / 2)) / 16f - (65f + 10f * num4)) / (worldSurface / 5.0));
		int num6 = (int)(SceneMetrics.Center.X / 16f);
		int num7 = (int)(SceneMetrics.Center.Y / 16f);
		Tile tile = (WorldGen.InWorld(num6, num7) ? Main.tile[num6, num7] : null);
		if (CreditsRollEvent.IsEventOngoing)
		{
			newMusic = 89;
		}
		else if (SceneMetrics.InTorchGodMinigame)
		{
			newMusic = 101;
		}
		else if (flag8)
		{
			newMusic = 38;
		}
		else if (flag17)
		{
			newMusic = 25;
		}
		else if (flag10)
		{
			newMusic = 37;
		}
		else if (flag11)
		{
			newMusic = 34;
		}
		else if (flag7)
		{
			newMusic = 24;
		}
		else if (flag15)
		{
			newMusic = 57;
		}
		else if (flag16)
		{
			newMusic = 58;
		}
		else if (flag18)
		{
			newMusic = 92;
		}
		else if (flag21)
		{
			newMusic = 97;
		}
		else if (flag22)
		{
			newMusic = 98;
		}
		else if (flag19)
		{
			newMusic = 93;
		}
		else if (flag20)
		{
			newMusic = 94;
		}
		else if (flag3)
		{
			newMusic = 12;
		}
		else if (flag)
		{
			newMusic = 5;
		}
		else if (flag4)
		{
			newMusic = 13;
		}
		else if (flag5)
		{
			newMusic = 17;
		}
		else if (flag26)
		{
			newMusic = 104;
		}
		else if (flag6)
		{
			newMusic = 96;
		}
		else if (flag14)
		{
			newMusic = 56;
		}
		else if (flag25)
		{
			newMusic = 99;
		}
		else if (flag2)
		{
			newMusic = 90;
		}
		else if (ShouldPlayRainbowBoulderMusic)
		{
			newMusic = (_finishedRainbowBoulderStart ? 103 : 102);
		}
		else if (flag9)
		{
			newMusic = 35;
		}
		else if (flag12)
		{
			newMusic = 39;
		}
		else if (flag13)
		{
			newMusic = 41;
		}
		else if (eclipse && !remixWorld && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2))
		{
			newMusic = 27;
		}
		else if (eclipse && remixWorld && (double)SceneMetrics.Center.Y > rockLayer * 16.0)
		{
			newMusic = 27;
		}
		else if (flag24 && !SceneMetrics.ZoneGraveyard && (!bloodMoon || dayTime) && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2))
		{
			newMusic = 48;
		}
		else if (remixWorld && bloodMoon && !SceneMetrics.ZoneCrimson && !SceneMetrics.ZoneCorrupt && (double)SceneMetrics.Center.Y > rockLayer * 16.0 && SceneMetrics.Center.Y <= (float)(UnderworldLayer * 16))
		{
			newMusic = 2;
		}
		else if (remixWorld && bloodMoon && SceneMetrics.Center.Y > (float)(UnderworldLayer * 16) && (double)(SceneMetrics.Center.X / 16f) > (double)maxTilesX * 0.37 + 50.0 && (double)(SceneMetrics.Center.X / 16f) < (double)maxTilesX * 0.63)
		{
			newMusic = 2;
		}
		else if (SceneMetrics.ZoneShimmer)
		{
			newMusic = 91;
		}
		else if (flag23 && dayTime && ((cloudAlpha == 0f && !_shouldUseWindyDayMusic) || (double)SceneMetrics.Center.Y >= worldSurface * 16.0 + (double)(screenHeight / 2)) && !SceneMetrics.ZoneGraveyard)
		{
			newMusic = 46;
		}
		else if (flag23 && !dayTime && ((!bloodMoon && cloudAlpha == 0f) || (double)SceneMetrics.Center.Y >= worldSurface * 16.0 + (double)(screenHeight / 2)) && !SceneMetrics.ZoneGraveyard)
		{
			newMusic = 47;
		}
		else if (SceneMetrics.ZoneSandstorm)
		{
			newMusic = 40;
		}
		else if (SceneMetrics.Center.Y > (float)(UnderworldLayer * 16))
		{
			newMusic = 36;
		}
		else if (num5 < 1f)
		{
			newMusic = (dayTime ? 42 : 15);
		}
		else if (tile != null && tile.wall == 87)
		{
			newMusic = 26;
		}
		else if (SceneMetrics.ZoneDungeon)
		{
			newMusic = 23;
		}
		else if ((bgStyle == 9 && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2)) || undergroundBackground == 2)
		{
			newMusic = 29;
		}
		else if (SceneMetrics.ZoneCorrupt)
		{
			if (SceneMetrics.ZoneCrimson && SceneMetrics.BloodTileCount > SceneMetrics.EvilTileCount)
			{
				if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = 33;
				}
				else
				{
					newMusic = 16;
				}
			}
			else if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 10;
			}
			else
			{
				newMusic = 8;
			}
		}
		else if (SceneMetrics.ZoneCrimson)
		{
			if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 33;
			}
			else
			{
				newMusic = 16;
			}
		}
		else if (SceneMetrics.ZoneMeteor)
		{
			newMusic = 2;
		}
		else if (SceneMetrics.ZoneGraveyard)
		{
			newMusic = 53;
		}
		else if (SceneMetrics.ZoneUndergroundDesert)
		{
			newMusic = 61;
		}
		else if (SceneMetrics.ZoneDesert)
		{
			newMusic = 21;
		}
		else if (SceneMetrics.ZoneJungle)
		{
			if (remixWorld)
			{
				if ((double)SceneMetrics.Center.Y > rockLayer * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = 7;
				}
				else if (newMusic == 7 && (double)SceneMetrics.Center.Y > (rockLayer - 50.0) * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = 7;
				}
				else if ((double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = (dayTime ? 42 : 15);
				}
				else
				{
					newMusic = 54;
				}
			}
			else if ((double)SceneMetrics.Center.Y > rockLayer * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 54;
			}
			else if (newMusic == 54 && (double)SceneMetrics.Center.Y > (rockLayer - 50.0) * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 54;
			}
			else if (_shouldUseStormMusic && (double)SceneMetrics.Center.Y < worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				newMusic = 52;
			}
			else if (dayTime)
			{
				newMusic = 7;
			}
			else
			{
				newMusic = 55;
			}
		}
		else if (SceneMetrics.ZoneSnow)
		{
			if ((double)SceneMetrics.Center.Y > worldSurface * 16.0 + (double)(screenHeight / 2))
			{
				if (remixWorld && (double)SceneMetrics.Center.Y > rockLayer * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = 14;
				}
				else
				{
					newMusic = 20;
				}
			}
			else if (remixWorld)
			{
				newMusic = (dayTime ? 42 : 15);
			}
			else
			{
				newMusic = 14;
			}
		}
		else if ((double)SceneMetrics.Center.Y >= worldSurface * 16.0 + (double)(screenHeight / 2) && (remixWorld || !WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16)))
		{
			if (SceneMetrics.ZoneHallow)
			{
				if (remixWorld && (double)SceneMetrics.Center.Y >= rockLayer * 16.0 + (double)(screenHeight / 2))
				{
					newMusic = 9;
				}
				else
				{
					newMusic = 11;
				}
			}
			else
			{
				if (ugMusic == 0)
				{
					ugMusic = 4;
				}
				if (!audioSystem.IsTrackPlaying(4) && !audioSystem.IsTrackPlaying(31))
				{
					if (musicFade[4] == 1f)
					{
						musicFade[31] = 1f;
					}
					if (musicFade[31] == 1f)
					{
						musicFade[4] = 1f;
					}
					switch (rand.Next(2))
					{
					case 0:
						ugMusic = 4;
						musicFade[31] = 0f;
						break;
					case 1:
						ugMusic = 31;
						musicFade[4] = 0f;
						break;
					}
				}
				newMusic = ugMusic;
				if (remixWorld && (double)(SceneMetrics.Center.Y / 16f) > rockLayer && SceneMetrics.Center.Y / 16f < (float)(maxTilesY - 350))
				{
					if (cloudAlpha > 0f)
					{
						newMusic = 19;
					}
					else if (SceneMetrics.ZoneDesert)
					{
						newMusic = 21;
					}
					else if (_shouldUseWindyDayMusic)
					{
						newMusic = 44;
					}
				}
			}
		}
		else if (dayTime && SceneMetrics.ZoneHallow)
		{
			if (_shouldUseStormMusic)
			{
				newMusic = 52;
			}
			else if (cloudAlpha > 0f && !gameMenu)
			{
				newMusic = 19;
			}
			else if (_shouldUseWindyDayMusic && !remixWorld)
			{
				newMusic = 44;
			}
			else
			{
				newMusic = 9;
			}
		}
		else if (_shouldUseStormMusic)
		{
			if (bloodMoon)
			{
				newMusic = 2;
			}
			else
			{
				newMusic = 52;
			}
		}
		else if (WorldGen.oceanDepths((int)(screenPosition.X + (float)(screenWidth / 2)) / 16, (int)(screenPosition.Y + (float)(screenHeight / 2)) / 16))
		{
			if (bloodMoon)
			{
				newMusic = 2;
			}
			else if (flag23)
			{
				if (dayTime)
				{
					newMusic = 46;
				}
				else
				{
					newMusic = 47;
				}
			}
			else
			{
				newMusic = (dayTime ? 22 : 43);
			}
		}
		else if (remixWorld)
		{
			newMusic = (dayTime ? 42 : 15);
		}
		else if (dayTime)
		{
			if (cloudAlpha > 0f && !gameMenu)
			{
				if (time < 10800.0)
				{
					newMusic = 59;
				}
				else
				{
					newMusic = 19;
				}
			}
			else
			{
				if (dayMusic == 0)
				{
					dayMusic = 1;
				}
				if (!audioSystem.IsTrackPlaying(1) && !audioSystem.IsTrackPlaying(18))
				{
					if (rand.Next(2) == 0)
					{
						dayMusic = 1;
					}
					else
					{
						dayMusic = 18;
					}
				}
				newMusic = dayMusic;
				if (_shouldUseWindyDayMusic && !remixWorld)
				{
					newMusic = 44;
				}
			}
		}
		else if (!dayTime)
		{
			if (bloodMoon)
			{
				newMusic = 2;
			}
			else if (cloudAlpha > 0f && !gameMenu)
			{
				newMusic = 19;
			}
			else
			{
				newMusic = 3;
			}
		}
		if (((double)(screenPosition.Y / 16f) < worldSurface + 10.0 || remixWorld) && pumpkinMoon)
		{
			newMusic = 30;
		}
		if (((double)(screenPosition.Y / 16f) < worldSurface + 10.0 || remixWorld) && snowMoon)
		{
			newMusic = 32;
		}
	}

	private void UpdateWindyDayState()
	{
		if (cloudAlpha == 0f)
		{
			_shouldUseStormMusic = false;
			if (time < 10800.0 || time > 43200.0 || !dayTime)
			{
				_shouldUseWindyDayMusic = false;
				return;
			}
			if (Math.Abs(windSpeedTarget) < _minWind)
			{
				_shouldUseWindyDayMusic = false;
			}
			if (Math.Abs(windSpeedTarget) >= _maxWind)
			{
				_shouldUseWindyDayMusic = true;
			}
		}
		else
		{
			if (cloudAlpha < _minRain || Math.Abs(windSpeedTarget) < _minWind)
			{
				_shouldUseStormMusic = false;
			}
			else if (cloudAlpha >= _maxRain && Math.Abs(windSpeedTarget) >= _maxWind)
			{
				_shouldUseStormMusic = true;
			}
			if (remixWorld)
			{
				_shouldUseStormMusic = false;
			}
			else
			{
				_shouldUseWindyDayMusic = false;
			}
		}
	}

	public static void snowing()
	{
		if (remixWorld)
		{
			return;
		}
		Vector2 scaledSize = Camera.ScaledSize;
		Vector2 scaledPosition = Camera.ScaledPosition;
		if (gamePaused || SceneMetrics.SnowTileCount <= 0 || !SceneMetrics.SurfaceAtmospherics)
		{
			return;
		}
		float num = (float)SceneMetrics.SnowTileCount / (float)SceneMetrics.SnowTileMax;
		float num2 = 4f - cloudAlpha * 3f;
		num = (float)Math.Pow(num, num2);
		float num3 = Camera.ScaledSize.X / (float)maxScreenW;
		int num4 = (int)(500f * num3);
		num4 = (int)((float)num4 * (1f + 2f * cloudAlpha));
		float num5 = 1f + 50f * cloudAlpha;
		bool flag = NPC.IsADeerclopsNearScreen();
		if (flag)
		{
			num /= 20f;
			num4 /= 3;
		}
		for (int i = 0; (float)i < num5; i++)
		{
			try
			{
				if (!((float)snowDust < (float)num4 * (gfxQuality / 2f + 0.5f) + (float)num4 * 0.1f))
				{
					break;
				}
				if (!(rand.NextFloat() < num))
				{
					continue;
				}
				int num6 = rand.Next((int)scaledSize.X + 1500) - 750;
				int num7 = (int)scaledPosition.Y - rand.Next(50);
				if (player[myPlayer].velocity.Y > 0f)
				{
					num7 -= (int)player[myPlayer].velocity.Y;
				}
				if (rand.Next(5) == 0)
				{
					num6 = rand.Next(500) - 500;
				}
				else if (rand.Next(5) == 0)
				{
					num6 = rand.Next(500) + (int)scaledSize.X;
				}
				if (num6 < 0 || (float)num6 > scaledSize.X)
				{
					num7 += rand.Next((int)((double)scaledSize.Y * 0.8)) + (int)((double)scaledSize.Y * 0.1);
				}
				num6 += (int)scaledPosition.X;
				int num8 = num6 / 16;
				int num9 = num7 / 16;
				if (WorldGen.InWorld(num8, num9) && tile[num8, num9] != null && !tile[num8, num9].nactive() && tile[num8, num9].wall == 0)
				{
					int num10 = Dust.NewDust(new Vector2(num6, num7), 10, 10, 76);
					dust[num10].scale += cloudAlpha * 0.2f;
					dust[num10].velocity.Y = 3f + (float)rand.Next(30) * 0.1f;
					dust[num10].velocity.Y *= dust[num10].scale;
					if (!raining)
					{
						dust[num10].velocity.X = windSpeedCurrent + (float)rand.Next(-10, 10) * 0.1f;
						dust[num10].velocity.X += windSpeedCurrent * 15f;
					}
					else
					{
						dust[num10].velocity.X = (float)Math.Sqrt(Math.Abs(windSpeedCurrent)) * (float)Math.Sign(windSpeedCurrent) * (cloudAlpha + 0.5f) * 10f + rand.NextFloat() * 0.2f - 0.1f;
						dust[num10].velocity.Y *= 0.5f;
					}
					dust[num10].velocity.Y *= 1f + 0.3f * cloudAlpha;
					dust[num10].scale += cloudAlpha * 0.2f;
					if (flag)
					{
						dust[num10].scale -= 0.5f;
					}
					dust[num10].velocity *= 1f + cloudAlpha * 0.5f;
				}
				continue;
			}
			catch
			{
			}
		}
	}

	public static void checkXMas()
	{
		DateTime now = DateTime.Now;
		int day = now.Day;
		int month = now.Month;
		if (day >= 15 && month == 12)
		{
			xMas = true;
		}
		else
		{
			xMas = false;
		}
		if (forceXMasForToday)
		{
			xMas = true;
		}
		if (forceXMasForever)
		{
			xMas = true;
		}
	}

	public static bool isHalloweenDateNow()
	{
		DateTime now = DateTime.Now;
		int day = now.Day;
		int month = now.Month;
		if (day < 10 || month != 10)
		{
			if (day <= 1)
			{
				return month == 11;
			}
			return false;
		}
		return true;
	}

	public static void checkHalloween()
	{
		halloween = false;
		if (isHalloweenDateNow())
		{
			halloween = true;
		}
		if (forceHalloweenForToday)
		{
			halloween = true;
		}
		if (forceHalloweenForever)
		{
			halloween = true;
		}
	}

	public void updateCloudLayer()
	{
		if (netMode == 1 || (netMode == 0 && gameMenu))
		{
			return;
		}
		int num = 86400;
		int num2 = num / 24;
		float num3 = Math.Max(1f, 1f + 4f * cloudAlpha);
		if (cloudBGActive > 0f)
		{
			if (cloudBGActive > 1f)
			{
				cloudBGActive -= (float)dayRate / num3;
			}
			if (cloudBGActive < 1f)
			{
				cloudBGActive = 1f;
			}
			if (cloudBGActive == 1f && rand.Next((int)((float)(num2 * 2 / Math.Max(dayRate, 1)) * num3)) == 0)
			{
				cloudBGActive = -rand.Next(num2 * 4, num * 4);
				if (netMode == 2)
				{
					NetMessage.SendData(7);
				}
			}
			return;
		}
		if (cloudBGActive < 0f)
		{
			cloudBGActive += (float)dayRate * num3;
			if (raining)
			{
				cloudBGActive += (float)(2 * dayRate) * num3;
			}
		}
		if (cloudBGActive > 0f)
		{
			cloudBGActive = 0f;
		}
		if (cloudBGActive == 0f && rand.Next((int)((float)(num2 * 12 / ((dayRate == 0) ? 1 : dayRate)) / num3)) == 0)
		{
			cloudBGActive = rand.Next(num2 * 3, num * 2);
			if (netMode == 2)
			{
				NetMessage.SendData(7);
			}
		}
		else if (IsItStorming)
		{
			cloudBGActive = rand.Next(num2, num2 * 4);
			if (netMode == 2)
			{
				NetMessage.SendData(7);
			}
		}
	}

	public static void TeleportEffect(Microsoft.Xna.Framework.Rectangle effectRect, int Style, int extraInfo = 0, float dustCountMult = 1f, TeleportationSide side = TeleportationSide.Entry, Vector2 otherPosition = default(Vector2))
	{
		switch (Style)
		{
		case 0:
		{
			SoundEngine.PlaySound(SoundID.Item6, effectRect.X + effectRect.Width / 2, effectRect.Y + effectRect.Height / 2);
			int num2 = effectRect.Width * effectRect.Height / 5;
			num2 = (int)((float)num2 * dustCountMult);
			for (int j = 0; j < num2; j++)
			{
				int num3 = Dust.NewDust(new Vector2(effectRect.X, effectRect.Y), effectRect.Width, effectRect.Height, 159);
				Main.dust[num3].scale = (float)rand.Next(20, 70) * 0.01f;
				if (j < 10)
				{
					Main.dust[num3].scale += 0.25f;
				}
				if (j < 5)
				{
					Main.dust[num3].scale += 0.25f;
				}
			}
			break;
		}
		case 1:
		{
			SoundEngine.PlaySound(SoundID.Item8, effectRect.X + effectRect.Width / 2, effectRect.Y + effectRect.Height / 2);
			int num10 = effectRect.Width * effectRect.Height / 5;
			num10 = (int)((float)num10 * dustCountMult);
			for (int num11 = 0; num11 < num10; num11++)
			{
				int num12 = Dust.NewDust(new Vector2(effectRect.X, effectRect.Y), effectRect.Width, effectRect.Height, 164);
				Main.dust[num12].scale = (float)rand.Next(20, 70) * 0.01f;
				if (num11 < 10)
				{
					Main.dust[num12].scale += 0.25f;
				}
				if (num11 < 5)
				{
					Main.dust[num12].scale += 0.25f;
				}
			}
			break;
		}
		case 2:
		{
			int num15 = (int)(50f * dustCountMult);
			for (int num16 = 0; num16 < num15; num16++)
			{
				Main.dust[Dust.NewDust(new Vector2(effectRect.X, effectRect.Y), effectRect.Width, effectRect.Height, 58, 0f, 0f, 150, Microsoft.Xna.Framework.Color.GhostWhite, 1.2f)].velocity *= 0.5f;
			}
			break;
		}
		case 3:
		{
			SoundEngine.PlaySound(SoundID.Item6, effectRect.X + effectRect.Width / 2, effectRect.Y + effectRect.Height / 2);
			int num5 = (int)(50f * dustCountMult);
			for (int l = 0; l < num5; l++)
			{
				int num6 = Dust.NewDust(new Vector2(effectRect.X, effectRect.Y), effectRect.Width, effectRect.Height, 180);
				Main.dust[num6].noGravity = true;
				for (int m = 0; m < 5; m++)
				{
					if (rand.Next(3) == 0)
					{
						Main.dust[num6].velocity *= 0.75f;
					}
				}
				if (rand.Next(3) == 0)
				{
					Main.dust[num6].velocity *= 2f;
					Main.dust[num6].scale *= 1.2f;
				}
				if (rand.Next(3) == 0)
				{
					Main.dust[num6].velocity *= 2f;
					Main.dust[num6].scale *= 1.2f;
				}
				if (rand.Next(2) == 0)
				{
					Main.dust[num6].fadeIn = (float)rand.Next(75, 100) * 0.01f;
					Main.dust[num6].scale = (float)rand.Next(25, 75) * 0.01f;
				}
				Main.dust[num6].scale *= 0.8f;
			}
			break;
		}
		case 4:
		{
			SoundEngine.PlaySound(SoundID.Item8, effectRect.X + effectRect.Width / 2, effectRect.Y + effectRect.Height / 2);
			int num17 = effectRect.Width * effectRect.Height / 5;
			num17 = (int)((float)num17 * dustCountMult);
			for (int num18 = 0; num18 < num17; num18++)
			{
				Dust obj4 = Main.dust[Dust.NewDust(effectRect.TopLeft(), effectRect.Width, effectRect.Height, 263)];
				obj4.color = PortalHelper.GetPortalColor(extraInfo);
				obj4.noLight = true;
				obj4.noGravity = true;
				obj4.scale = 1.2f;
				obj4.fadeIn = 0.4f;
				obj4.color.A = byte.MaxValue;
			}
			break;
		}
		case 5:
		{
			Vector2 position = effectRect.TopLeft();
			int num8 = (int)(100f * dustCountMult);
			for (int num9 = 0; num9 < num8; num9++)
			{
				Dust obj3 = Dust.NewDustDirect(position, effectRect.Width, effectRect.Height + 24, Dust.dustWater());
				obj3.velocity.Y *= 0f;
				obj3.velocity.Y -= 3.5f;
				obj3.velocity.X *= 1.5f;
				obj3.scale = 0.8f;
				obj3.alpha = 130;
				obj3.noGravity = true;
				obj3.fadeIn = 1.2f;
			}
			SoundEngine.PlaySound(19, effectRect.Center.ToVector2(), 0);
			break;
		}
		case 7:
		{
			Vector2 position2 = effectRect.TopLeft();
			int num19 = (int)(50f * dustCountMult);
			for (int num20 = 0; num20 < num19; num20++)
			{
				Dust obj5 = Dust.NewDustDirect(position2, effectRect.Width, effectRect.Height + 24, 35);
				obj5.velocity.Y *= 0f;
				obj5.velocity.Y -= 3.5f;
				obj5.velocity.X *= 1.5f;
				obj5.scale = 0.8f;
				obj5.alpha = 130;
				obj5.noGravity = true;
				obj5.fadeIn = 1.2f;
			}
			SoundEngine.PlaySound(SoundID.Item8, effectRect.Center.ToVector2());
			break;
		}
		case 9:
		{
			effectRect.Inflate(15, 15);
			int num13 = (int)(100f * dustCountMult);
			for (int num14 = 0; num14 < num13; num14++)
			{
				TeleportPylonsSystem.SpawnInWorldDust(extraInfo, effectRect);
			}
			SoundEngine.PlaySound(SoundID.Item6, effectRect.Center.X, effectRect.Center.Y);
			break;
		}
		case 10:
		{
			effectRect.Inflate(15, 15);
			int num7 = (int)(60f * dustCountMult);
			Vector2 vector = otherPosition - effectRect.TopLeft();
			for (int n = 0; n < num7; n++)
			{
				float fadeIn = 0.4f + rand.NextFloat();
				float scale = 0.4f + rand.NextFloat();
				Microsoft.Xna.Framework.Color newColor = hslToRgb(0.66f + rand.NextFloat() * 0.24f, 1f, 0.5f);
				Dust dust = Dust.NewDustDirect(effectRect.TopLeft(), effectRect.Width, effectRect.Height, 267, 0f, 0f, 127, newColor);
				dust.scale = (float)rand.Next(20, 70) * 0.01f;
				if (n < 10)
				{
					dust.scale += 0.25f;
				}
				if (n < 5)
				{
					dust.scale += 0.25f;
				}
				if ((float)n < (float)num7 * 0.8f)
				{
					dust.velocity += vector * 0.1f * rand.NextFloat();
				}
				dust.noGravity = true;
				dust.noLight = true;
				dust.scale = scale;
				dust.fadeIn = fadeIn;
				if (dust.dustIndex != 6000)
				{
					Dust obj2 = Dust.CloneDust(dust);
					obj2.scale *= 0.65f;
					obj2.fadeIn *= 0.65f;
					obj2.color = new Microsoft.Xna.Framework.Color(255, 255, 255, 255);
				}
			}
			SoundEngine.PlaySound(SoundID.Item8, effectRect.Center.X, effectRect.Center.Y);
			break;
		}
		case 11:
		{
			for (int k = 0; k < 50; k++)
			{
				int num4 = rand.Next(4);
				Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Green;
				switch (num4)
				{
				case 0:
				case 1:
					color = new Microsoft.Xna.Framework.Color(100, 255, 100);
					break;
				case 2:
					color = Microsoft.Xna.Framework.Color.Yellow;
					break;
				case 3:
					color = Microsoft.Xna.Framework.Color.White;
					break;
				}
				Dust obj = Dust.NewDustPerfect(rand.NextVector2FromRectangle(effectRect), 267);
				obj.noGravity = true;
				obj.color = color;
				obj.velocity *= 2f;
				obj.scale = 0.8f + rand.NextFloat() * 0.6f;
				obj.fadeIn = 0.5f;
			}
			break;
		}
		case 13:
		{
			SoundEngine.PlaySound(SoundID.Item8, effectRect.Center.ToVector2());
			for (int i = 0; i < 21; i++)
			{
				int num = Dust.NewDust(rand.NextVector2FromRectangle(effectRect), 2, 2, 27, 0f, 0f, 100, default(Microsoft.Xna.Framework.Color), rand.Next(1, 3));
				Main.dust[num].velocity *= 1.75f;
				if (i % 3 == 0)
				{
					Main.dust[num].velocity *= 1.5f;
				}
				Main.dust[num].noLightEmittence = true;
				Main.dust[num].noGravity = true;
			}
			break;
		}
		}
	}

	public static void Ambience()
	{
		ambientCounter++;
		if (ambientCounter < 15)
		{
			return;
		}
		ambientCounter = 0;
		LocalPlayer.Center.ToPoint();
		if (ambientWaterfallStrength > 0f)
		{
			SoundEngine.PlaySound(34, (int)ambientWaterfallX, (int)ambientWaterfallY, (int)ambientWaterfallStrength);
			_isWaterfallMusicPlaying = true;
		}
		else
		{
			if (_isWaterfallMusicPlaying)
			{
				SoundEngine.PlaySound(34, (int)Camera.Center.X, (int)Camera.Center.Y, 0);
			}
			_isWaterfallMusicPlaying = false;
		}
		float num = Math.Abs(ambientLavaX - (screenPosition.X + (float)(screenWidth / 2))) + Math.Abs(ambientLavaY - (screenPosition.Y + (float)(screenHeight / 2)));
		float num2 = Math.Abs(ambientLavafallX - (screenPosition.X + (float)(screenWidth / 2))) + Math.Abs(ambientLavafallY - (screenPosition.Y + (float)(screenHeight / 2)));
		float num3 = ambientLavaX;
		float num4 = ambientLavaY;
		if (num2 < num)
		{
			num3 = ambientLavafallX;
			num4 = ambientLavafallY;
		}
		float num5 = ambientLavafallStrength + ambientLavaStrength;
		if (ambientLavafallStrength > 0f)
		{
			SoundEngine.PlaySound(35, (int)num3, (int)num4, (int)num5);
			_isLavafallMusicPlaying = true;
			return;
		}
		if (_isLavafallMusicPlaying)
		{
			SoundEngine.PlaySound(35, (int)Camera.Center.X, (int)Camera.Center.Y, 0);
		}
		_isLavafallMusicPlaying = false;
	}

	public static void AnimateTiles_CritterCages()
	{
		if (!critterCage)
		{
			return;
		}
		for (int i = 0; i < cageFrames; i++)
		{
			if (bunnyCageFrame[i] == 0)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] <= rand.Next(30, 900))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					int num = rand.Next(7);
					if (num == 0)
					{
						bunnyCageFrame[i] = 4;
					}
					else if (num <= 2)
					{
						bunnyCageFrame[i] = 2;
					}
					else
					{
						bunnyCageFrame[i] = 1;
					}
				}
				bunnyCageFrameCounter[i] = 0;
			}
			else if (bunnyCageFrame[i] == 1)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] >= 10)
				{
					bunnyCageFrameCounter[i] = 0;
					bunnyCageFrame[i] = 0;
				}
			}
			else if (bunnyCageFrame[i] >= 2 && bunnyCageFrame[i] <= 3)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] >= 10)
				{
					bunnyCageFrameCounter[i] = 0;
					bunnyCageFrame[i]++;
				}
				if (bunnyCageFrame[i] > 3)
				{
					bunnyCageFrame[i] = 0;
				}
			}
			else if (bunnyCageFrame[i] >= 4 && bunnyCageFrame[i] <= 10)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] >= 5)
				{
					bunnyCageFrameCounter[i] = 0;
					bunnyCageFrame[i]++;
				}
			}
			else if (bunnyCageFrame[i] == 11)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] <= rand.Next(30, 900))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(7) == 0)
					{
						bunnyCageFrame[i] = 13;
					}
					else
					{
						bunnyCageFrame[i] = 12;
					}
				}
				bunnyCageFrameCounter[i] = 0;
			}
			else if (bunnyCageFrame[i] == 12)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] >= 10)
				{
					bunnyCageFrameCounter[i] = 0;
					bunnyCageFrame[i] = 11;
				}
			}
			else if (bunnyCageFrame[i] >= 13)
			{
				bunnyCageFrameCounter[i]++;
				if (bunnyCageFrameCounter[i] >= 5)
				{
					bunnyCageFrameCounter[i] = 0;
					bunnyCageFrame[i]++;
				}
				if (bunnyCageFrame[i] > 21)
				{
					bunnyCageFrame[i] = 0;
				}
			}
		}
		for (int j = 0; j < cageFrames; j++)
		{
			if (squirrelCageFrame[j] == 0)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] <= rand.Next(30, 900))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					int num = rand.Next(7);
					if (num == 0)
					{
						squirrelCageFrame[j] = 4;
					}
					else if (num <= 2)
					{
						squirrelCageFrame[j] = 2;
					}
					else
					{
						squirrelCageFrame[j] = 1;
					}
				}
				squirrelCageFrameCounter[j] = 0;
			}
			else if (squirrelCageFrame[j] == 1)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] >= 10)
				{
					squirrelCageFrameCounter[j] = 0;
					squirrelCageFrame[j] = 0;
				}
			}
			else if (squirrelCageFrame[j] >= 2 && squirrelCageFrame[j] <= 3)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] >= 5)
				{
					squirrelCageFrameCounter[j] = 0;
					squirrelCageFrame[j]++;
				}
				if (squirrelCageFrame[j] > 3)
				{
					if (rand.Next(5) == 0)
					{
						squirrelCageFrame[j] = 0;
					}
					else
					{
						squirrelCageFrame[j] = 2;
					}
				}
			}
			else if (squirrelCageFrame[j] >= 4 && squirrelCageFrame[j] <= 8)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] >= 5)
				{
					squirrelCageFrameCounter[j] = 0;
					squirrelCageFrame[j]++;
				}
			}
			else if (squirrelCageFrame[j] == 9)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] <= rand.Next(30, 900))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					int num = rand.Next(7);
					if (num == 0)
					{
						squirrelCageFrame[j] = 13;
					}
					else if (num <= 2)
					{
						squirrelCageFrame[j] = 11;
					}
					else
					{
						squirrelCageFrame[j] = 10;
					}
				}
				squirrelCageFrameCounter[j] = 0;
			}
			else if (squirrelCageFrame[j] == 10)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] >= 10)
				{
					squirrelCageFrameCounter[j] = 0;
					squirrelCageFrame[j] = 9;
				}
			}
			else if (squirrelCageFrame[j] == 11 || squirrelCageFrame[j] == 12)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] < 5)
				{
					continue;
				}
				squirrelCageFrame[j]++;
				if (squirrelCageFrame[j] > 12)
				{
					if (rand.Next(5) != 0)
					{
						squirrelCageFrame[j] = 11;
					}
					else
					{
						squirrelCageFrame[j] = 9;
					}
				}
				squirrelCageFrameCounter[j] = 0;
			}
			else if (squirrelCageFrame[j] >= 13)
			{
				squirrelCageFrameCounter[j]++;
				if (squirrelCageFrameCounter[j] >= 5)
				{
					squirrelCageFrameCounter[j] = 0;
					squirrelCageFrame[j]++;
				}
				if (squirrelCageFrame[j] > 17)
				{
					squirrelCageFrame[j] = 0;
				}
			}
		}
		for (int k = 0; k < cageFrames; k++)
		{
			if (squirrelCageFrameOrange[k] == 0)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] <= rand.Next(30, 900))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					int num = rand.Next(7);
					if (num == 0)
					{
						squirrelCageFrameOrange[k] = 4;
					}
					else if (num <= 2)
					{
						squirrelCageFrameOrange[k] = 2;
					}
					else
					{
						squirrelCageFrameOrange[k] = 1;
					}
				}
				squirrelCageFrameCounterOrange[k] = 0;
			}
			else if (squirrelCageFrameOrange[k] == 1)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] >= 10)
				{
					squirrelCageFrameCounterOrange[k] = 0;
					squirrelCageFrameOrange[k] = 0;
				}
			}
			else if (squirrelCageFrameOrange[k] >= 2 && squirrelCageFrameOrange[k] <= 3)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] >= 5)
				{
					squirrelCageFrameCounterOrange[k] = 0;
					squirrelCageFrameOrange[k]++;
				}
				if (squirrelCageFrameOrange[k] > 3)
				{
					if (rand.Next(5) == 0)
					{
						squirrelCageFrameOrange[k] = 0;
					}
					else
					{
						squirrelCageFrameOrange[k] = 2;
					}
				}
			}
			else if (squirrelCageFrameOrange[k] >= 4 && squirrelCageFrameOrange[k] <= 8)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] >= 5)
				{
					squirrelCageFrameCounterOrange[k] = 0;
					squirrelCageFrameOrange[k]++;
				}
			}
			else if (squirrelCageFrameOrange[k] == 9)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] <= rand.Next(30, 900))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					int num = rand.Next(7);
					if (num == 0)
					{
						squirrelCageFrameOrange[k] = 13;
					}
					else if (num <= 2)
					{
						squirrelCageFrameOrange[k] = 11;
					}
					else
					{
						squirrelCageFrameOrange[k] = 10;
					}
				}
				squirrelCageFrameCounterOrange[k] = 0;
			}
			else if (squirrelCageFrameOrange[k] == 10)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] >= 10)
				{
					squirrelCageFrameCounterOrange[k] = 0;
					squirrelCageFrameOrange[k] = 9;
				}
			}
			else if (squirrelCageFrameOrange[k] == 11 || squirrelCageFrameOrange[k] == 12)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] < 5)
				{
					continue;
				}
				squirrelCageFrameOrange[k]++;
				if (squirrelCageFrameOrange[k] > 12)
				{
					if (rand.Next(5) != 0)
					{
						squirrelCageFrameOrange[k] = 11;
					}
					else
					{
						squirrelCageFrameOrange[k] = 9;
					}
				}
				squirrelCageFrameCounterOrange[k] = 0;
			}
			else if (squirrelCageFrameOrange[k] >= 13)
			{
				squirrelCageFrameCounterOrange[k]++;
				if (squirrelCageFrameCounterOrange[k] >= 5)
				{
					squirrelCageFrameCounterOrange[k] = 0;
					squirrelCageFrameOrange[k]++;
				}
				if (squirrelCageFrameOrange[k] > 17)
				{
					squirrelCageFrameOrange[k] = 0;
				}
			}
		}
		for (int l = 0; l < cageFrames; l++)
		{
			if (mallardCageFrame[l] == 0 || mallardCageFrame[l] == 4)
			{
				mallardCageFrameCounter[l]++;
				if (mallardCageFrameCounter[l] <= rand.Next(45, 2700))
				{
					continue;
				}
				if ((mallardCageFrame[l] == 0 && rand.Next(3) != 0) || (mallardCageFrame[l] == 4 && rand.Next(5) == 0))
				{
					if (rand.Next(6) == 0)
					{
						mallardCageFrame[l] = 5;
					}
					else if (rand.Next(3) == 0)
					{
						if (mallardCageFrame[l] == 4)
						{
							mallardCageFrame[l] = 0;
						}
						else
						{
							mallardCageFrame[l] = 4;
						}
					}
					else
					{
						mallardCageFrame[l] = 1;
					}
				}
				mallardCageFrameCounter[l] = 0;
			}
			else if (mallardCageFrame[l] >= 1 && mallardCageFrame[l] <= 3)
			{
				mallardCageFrameCounter[l]++;
				if (mallardCageFrameCounter[l] >= 5)
				{
					mallardCageFrameCounter[l] = 0;
					mallardCageFrame[l]++;
				}
				if (mallardCageFrame[l] > 3)
				{
					if (rand.Next(5) == 0)
					{
						mallardCageFrame[l] = 0;
					}
					else
					{
						mallardCageFrame[l] = 1;
					}
				}
			}
			else if (mallardCageFrame[l] >= 5 && mallardCageFrame[l] <= 11)
			{
				mallardCageFrameCounter[l]++;
				if (mallardCageFrameCounter[l] >= 5)
				{
					mallardCageFrameCounter[l] = 0;
					mallardCageFrame[l]++;
				}
			}
			else if (mallardCageFrame[l] == 12 || mallardCageFrame[l] == 16)
			{
				mallardCageFrameCounter[l]++;
				if (mallardCageFrameCounter[l] <= rand.Next(45, 2700))
				{
					continue;
				}
				if ((mallardCageFrame[l] == 12 && rand.Next(3) != 0) || (mallardCageFrame[l] == 16 && rand.Next(5) == 0))
				{
					if (rand.Next(6) == 0)
					{
						mallardCageFrame[l] = 17;
					}
					else if (rand.Next(3) == 0)
					{
						if (mallardCageFrame[l] == 16)
						{
							mallardCageFrame[l] = 12;
						}
						else
						{
							mallardCageFrame[l] = 16;
						}
					}
					else
					{
						mallardCageFrame[l] = 13;
					}
				}
				mallardCageFrameCounter[l] = 0;
			}
			else if (mallardCageFrame[l] >= 13 && mallardCageFrame[l] <= 15)
			{
				mallardCageFrameCounter[l]++;
				if (mallardCageFrameCounter[l] < 5)
				{
					continue;
				}
				mallardCageFrame[l]++;
				if (mallardCageFrame[l] > 15)
				{
					if (rand.Next(5) != 0)
					{
						mallardCageFrame[l] = 12;
					}
					else
					{
						mallardCageFrame[l] = 13;
					}
				}
				mallardCageFrameCounter[l] = 0;
			}
			else if (mallardCageFrame[l] >= 17)
			{
				mallardCageFrameCounter[l]++;
				if (mallardCageFrameCounter[l] >= 5)
				{
					mallardCageFrameCounter[l] = 0;
					mallardCageFrame[l]++;
				}
				if (mallardCageFrame[l] > 23)
				{
					mallardCageFrame[l] = 0;
				}
			}
		}
		for (int m = 0; m < cageFrames; m++)
		{
			if (duckCageFrame[m] == 0 || duckCageFrame[m] == 4)
			{
				duckCageFrameCounter[m]++;
				if (duckCageFrameCounter[m] <= rand.Next(45, 2700))
				{
					continue;
				}
				if ((duckCageFrame[m] == 0 && rand.Next(3) != 0) || (duckCageFrame[m] == 4 && rand.Next(5) == 0))
				{
					if (rand.Next(6) == 0)
					{
						duckCageFrame[m] = 5;
					}
					else if (rand.Next(3) == 0)
					{
						if (duckCageFrame[m] == 4)
						{
							duckCageFrame[m] = 0;
						}
						else
						{
							duckCageFrame[m] = 4;
						}
					}
					else
					{
						duckCageFrame[m] = 1;
					}
				}
				duckCageFrameCounter[m] = 0;
			}
			else if (duckCageFrame[m] >= 1 && duckCageFrame[m] <= 3)
			{
				duckCageFrameCounter[m]++;
				if (duckCageFrameCounter[m] >= 5)
				{
					duckCageFrameCounter[m] = 0;
					duckCageFrame[m]++;
				}
				if (duckCageFrame[m] > 3)
				{
					if (rand.Next(5) == 0)
					{
						duckCageFrame[m] = 0;
					}
					else
					{
						duckCageFrame[m] = 1;
					}
				}
			}
			else if (duckCageFrame[m] >= 5 && duckCageFrame[m] <= 11)
			{
				duckCageFrameCounter[m]++;
				if (duckCageFrameCounter[m] >= 5)
				{
					duckCageFrameCounter[m] = 0;
					duckCageFrame[m]++;
				}
			}
			else if (duckCageFrame[m] == 12 || duckCageFrame[m] == 16)
			{
				duckCageFrameCounter[m]++;
				if (duckCageFrameCounter[m] <= rand.Next(45, 2700))
				{
					continue;
				}
				if ((duckCageFrame[m] == 12 && rand.Next(3) != 0) || (duckCageFrame[m] == 16 && rand.Next(5) == 0))
				{
					if (rand.Next(6) == 0)
					{
						duckCageFrame[m] = 17;
					}
					else if (rand.Next(3) == 0)
					{
						if (duckCageFrame[m] == 16)
						{
							duckCageFrame[m] = 12;
						}
						else
						{
							duckCageFrame[m] = 16;
						}
					}
					else
					{
						duckCageFrame[m] = 13;
					}
				}
				duckCageFrameCounter[m] = 0;
			}
			else if (duckCageFrame[m] >= 13 && duckCageFrame[m] <= 15)
			{
				duckCageFrameCounter[m]++;
				if (duckCageFrameCounter[m] < 5)
				{
					continue;
				}
				duckCageFrame[m]++;
				if (duckCageFrame[m] > 15)
				{
					if (rand.Next(5) != 0)
					{
						duckCageFrame[m] = 12;
					}
					else
					{
						duckCageFrame[m] = 13;
					}
				}
				duckCageFrameCounter[m] = 0;
			}
			else if (duckCageFrame[m] >= 17)
			{
				duckCageFrameCounter[m]++;
				if (duckCageFrameCounter[m] >= 5)
				{
					duckCageFrameCounter[m] = 0;
					duckCageFrame[m]++;
				}
				if (duckCageFrame[m] > 23)
				{
					duckCageFrame[m] = 0;
				}
			}
		}
		for (int n = 0; n < cageFrames; n++)
		{
			grebeCageFrameCounter[n]++;
			bool flag = grebeCageFrame[n] == 0 || grebeCageFrame[n] == 7;
			bool num2 = grebeCageFrame[n] == 16 || grebeCageFrame[n] == 20;
			int num3 = 5;
			if (flag)
			{
				num3 = rand.Next(300, 400);
			}
			if (num2)
			{
				num3 = rand.Next(480, 600);
			}
			if (grebeCageFrameCounter[n] < num3)
			{
				continue;
			}
			grebeCageFrameCounter[n] = 0;
			if (grebeCageFrame[n] >= 25 && grebeCageFrame[n] <= 27)
			{
				grebeCageFrame[n]++;
				if (grebeCageFrame[n] > 27)
				{
					if (rand.Next(5) == 0)
					{
						grebeCageFrame[n] = 7;
					}
					else
					{
						grebeCageFrame[n] = 25;
					}
				}
			}
			else if (grebeCageFrame[n] >= 22 && grebeCageFrame[n] <= 24)
			{
				grebeCageFrame[n]++;
				if (grebeCageFrame[n] > 24)
				{
					if (rand.Next(5) == 0)
					{
						grebeCageFrame[n] = 0;
					}
					else
					{
						grebeCageFrame[n] = 22;
					}
				}
			}
			else if (grebeCageFrame[n] == 0 && rand.Next(3) == 0)
			{
				grebeCageFrame[n] = ((rand.Next(2) == 0) ? 22 : 14);
			}
			else if (grebeCageFrame[n] == 7 && rand.Next(3) == 0)
			{
				grebeCageFrame[n] = ((rand.Next(2) == 0) ? 25 : 18);
			}
			else if (grebeCageFrame[n] == 13 || grebeCageFrame[n] == 17)
			{
				grebeCageFrame[n] = 0;
			}
			else if (grebeCageFrame[n] == 21)
			{
				grebeCageFrame[n] = 7;
			}
			else
			{
				grebeCageFrame[n]++;
			}
		}
		for (int num4 = 0; num4 < cageFrames; num4++)
		{
			seagullCageFrameCounter[num4]++;
			bool flag2 = seagullCageFrame[num4] == 0 || seagullCageFrame[num4] == 14;
			bool flag3 = seagullCageFrame[num4] >= 15 && seagullCageFrame[num4] <= 18;
			bool num5 = seagullCageFrame[num4] >= 9 && seagullCageFrame[num4] <= 13;
			int num6 = 6;
			if (flag2)
			{
				num6 = rand.Next(180, 250);
			}
			if (flag3)
			{
				num6 = 66;
			}
			if (num5)
			{
				num6 = 78;
			}
			if (seagullCageFrameCounter[num4] >= num6)
			{
				seagullCageFrameCounter[num4] = 0;
				if (seagullCageFrame[num4] == 0 && rand.Next(3) == 0)
				{
					seagullCageFrame[num4] = 9;
					continue;
				}
				if (seagullCageFrame[num4] == 14)
				{
					if (rand.Next(2) == 0)
					{
						seagullCageFrame[num4] = 15;
					}
					else
					{
						seagullCageFrame[num4] = 19;
					}
					continue;
				}
				if (seagullCageFrame[num4] == 9)
				{
					seagullCageFrame[num4] = 0;
					continue;
				}
				if (seagullCageFrame[num4] == 8 || seagullCageFrame[num4] == 15)
				{
					seagullCageFrame[num4] = 14;
					continue;
				}
				seagullCageFrame[num4]++;
				if (seagullCageFrame[num4] > 26)
				{
					seagullCageFrame[num4] = 0;
				}
			}
			else if (seagullCageFrame[num4] >= 15 && seagullCageFrame[num4] <= 18)
			{
				int num7 = seagullCageFrameCounter[num4] % 66;
				if (num7 > 60)
				{
					seagullCageFrame[num4] = 15;
				}
				else if (num7 > 54)
				{
					seagullCageFrame[num4] = 16;
				}
				else if (num7 > 48)
				{
					seagullCageFrame[num4] = 17;
				}
				else if (num7 > 42)
				{
					seagullCageFrame[num4] = 18;
				}
				else if (num7 > 36)
				{
					seagullCageFrame[num4] = 17;
				}
				else if (num7 > 30)
				{
					seagullCageFrame[num4] = 16;
				}
				else if (num7 > 24)
				{
					seagullCageFrame[num4] = 17;
				}
				else if (num7 > 18)
				{
					seagullCageFrame[num4] = 18;
				}
				else if (num7 > 12)
				{
					seagullCageFrame[num4] = 17;
				}
				else if (num7 > 6)
				{
					seagullCageFrame[num4] = 16;
				}
				else
				{
					seagullCageFrame[num4] = 15;
				}
			}
			else if (seagullCageFrame[num4] >= 9 && seagullCageFrame[num4] <= 13)
			{
				int num8 = seagullCageFrameCounter[num4] % 78;
				if (num8 > 72)
				{
					seagullCageFrame[num4] = 9;
				}
				else if (num8 > 66)
				{
					seagullCageFrame[num4] = 10;
				}
				else if (num8 > 60)
				{
					seagullCageFrame[num4] = 11;
				}
				else if (num8 > 54)
				{
					seagullCageFrame[num4] = 12;
				}
				else if (num8 > 48)
				{
					seagullCageFrame[num4] = 13;
				}
				else if (num8 > 42)
				{
					seagullCageFrame[num4] = 12;
				}
				else if (num8 > 36)
				{
					seagullCageFrame[num4] = 11;
				}
				else if (num8 > 30)
				{
					seagullCageFrame[num4] = 12;
				}
				else if (num8 > 24)
				{
					seagullCageFrame[num4] = 13;
				}
				else if (num8 > 18)
				{
					seagullCageFrame[num4] = 12;
				}
				else if (num8 > 12)
				{
					seagullCageFrame[num4] = 11;
				}
				else if (num8 > 6)
				{
					seagullCageFrame[num4] = 10;
				}
				else
				{
					seagullCageFrame[num4] = 9;
				}
			}
		}
		for (int num9 = 0; num9 < cageFrames; num9++)
		{
			if (birdCageFrame[num9] == 0)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] <= rand.Next(30, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(3) != 0)
					{
						birdCageFrame[num9] = 2;
					}
					else
					{
						birdCageFrame[num9] = 1;
					}
				}
				birdCageFrameCounter[num9] = 0;
			}
			else if (birdCageFrame[num9] == 1)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] > rand.Next(900, 18000) && rand.Next(3) == 0)
				{
					birdCageFrameCounter[num9] = 0;
					birdCageFrame[num9] = 0;
				}
			}
			else if (birdCageFrame[num9] >= 2 && birdCageFrame[num9] <= 5)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] >= 5)
				{
					birdCageFrameCounter[num9] = 0;
					if (birdCageFrame[num9] == 3 && rand.Next(3) == 0)
					{
						birdCageFrame[num9] = 13;
					}
					else
					{
						birdCageFrame[num9]++;
					}
				}
			}
			else if (birdCageFrame[num9] == 6)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] <= rand.Next(45, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(6) == 0)
					{
						birdCageFrame[num9] = 7;
					}
					else if (rand.Next(6) == 0)
					{
						birdCageFrame[num9] = 11;
					}
				}
				birdCageFrameCounter[num9] = 0;
			}
			else if (birdCageFrame[num9] >= 7 && birdCageFrame[num9] <= 10)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] >= 5)
				{
					birdCageFrame[num9]++;
					if (birdCageFrame[num9] > 10)
					{
						birdCageFrame[num9] = 0;
					}
					birdCageFrameCounter[num9] = 0;
				}
			}
			else if (birdCageFrame[num9] >= 11 && birdCageFrame[num9] <= 13)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] >= 5)
				{
					birdCageFrame[num9]++;
					birdCageFrameCounter[num9] = 0;
				}
			}
			else if (birdCageFrame[num9] == 14)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] > rand.Next(5, 600))
				{
					if (rand.Next(20) == 0)
					{
						birdCageFrame[num9] = 16;
					}
					else if (rand.Next(20) == 0)
					{
						birdCageFrame[num9] = 4;
					}
					else
					{
						birdCageFrame[num9] = 15;
					}
					birdCageFrameCounter[num9] = 0;
				}
			}
			else if (birdCageFrame[num9] == 15)
			{
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] >= 10)
				{
					birdCageFrameCounter[num9] = 0;
					birdCageFrame[num9] = 14;
				}
			}
			else
			{
				if (birdCageFrame[num9] < 16 || birdCageFrame[num9] > 18)
				{
					continue;
				}
				birdCageFrameCounter[num9]++;
				if (birdCageFrameCounter[num9] >= 5)
				{
					birdCageFrame[num9]++;
					if (birdCageFrame[num9] > 18)
					{
						birdCageFrame[num9] = 0;
					}
					birdCageFrameCounter[num9] = 0;
				}
			}
		}
		for (int num10 = 0; num10 < cageFrames; num10++)
		{
			if (blueBirdCageFrame[num10] == 0)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] <= rand.Next(30, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(3) != 0)
					{
						blueBirdCageFrame[num10] = 2;
					}
					else
					{
						blueBirdCageFrame[num10] = 1;
					}
				}
				blueBirdCageFrameCounter[num10] = 0;
			}
			else if (blueBirdCageFrame[num10] == 1)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] > rand.Next(900, 18000) && rand.Next(3) == 0)
				{
					blueBirdCageFrameCounter[num10] = 0;
					blueBirdCageFrame[num10] = 0;
				}
			}
			else if (blueBirdCageFrame[num10] >= 2 && blueBirdCageFrame[num10] <= 5)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] >= 5)
				{
					blueBirdCageFrameCounter[num10] = 0;
					if (blueBirdCageFrame[num10] == 3 && rand.Next(3) == 0)
					{
						blueBirdCageFrame[num10] = 13;
					}
					else
					{
						blueBirdCageFrame[num10]++;
					}
				}
			}
			else if (blueBirdCageFrame[num10] == 6)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] <= rand.Next(45, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(6) == 0)
					{
						blueBirdCageFrame[num10] = 7;
					}
					else if (rand.Next(6) == 0)
					{
						blueBirdCageFrame[num10] = 11;
					}
				}
				blueBirdCageFrameCounter[num10] = 0;
			}
			else if (blueBirdCageFrame[num10] >= 7 && blueBirdCageFrame[num10] <= 10)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] >= 5)
				{
					blueBirdCageFrame[num10]++;
					if (blueBirdCageFrame[num10] > 10)
					{
						blueBirdCageFrame[num10] = 0;
					}
					blueBirdCageFrameCounter[num10] = 0;
				}
			}
			else if (blueBirdCageFrame[num10] >= 11 && blueBirdCageFrame[num10] <= 13)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] >= 5)
				{
					blueBirdCageFrame[num10]++;
					blueBirdCageFrameCounter[num10] = 0;
				}
			}
			else if (blueBirdCageFrame[num10] == 14)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] > rand.Next(5, 600))
				{
					if (rand.Next(20) == 0)
					{
						blueBirdCageFrame[num10] = 16;
					}
					else if (rand.Next(20) == 0)
					{
						blueBirdCageFrame[num10] = 4;
					}
					else
					{
						blueBirdCageFrame[num10] = 15;
					}
					blueBirdCageFrameCounter[num10] = 0;
				}
			}
			else if (blueBirdCageFrame[num10] == 15)
			{
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] >= 10)
				{
					blueBirdCageFrameCounter[num10] = 0;
					blueBirdCageFrame[num10] = 14;
				}
			}
			else
			{
				if (blueBirdCageFrame[num10] < 16 || blueBirdCageFrame[num10] > 18)
				{
					continue;
				}
				blueBirdCageFrameCounter[num10]++;
				if (blueBirdCageFrameCounter[num10] >= 5)
				{
					blueBirdCageFrame[num10]++;
					if (blueBirdCageFrame[num10] > 18)
					{
						blueBirdCageFrame[num10] = 0;
					}
					blueBirdCageFrameCounter[num10] = 0;
				}
			}
		}
		for (int num11 = 0; num11 < cageFrames; num11++)
		{
			if (redBirdCageFrame[num11] == 0)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] <= rand.Next(30, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(3) != 0)
					{
						redBirdCageFrame[num11] = 2;
					}
					else
					{
						redBirdCageFrame[num11] = 1;
					}
				}
				redBirdCageFrameCounter[num11] = 0;
			}
			else if (redBirdCageFrame[num11] == 1)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] > rand.Next(900, 18000) && rand.Next(3) == 0)
				{
					redBirdCageFrameCounter[num11] = 0;
					redBirdCageFrame[num11] = 0;
				}
			}
			else if (redBirdCageFrame[num11] >= 2 && redBirdCageFrame[num11] <= 5)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] >= 5)
				{
					redBirdCageFrameCounter[num11] = 0;
					if (redBirdCageFrame[num11] == 3 && rand.Next(3) == 0)
					{
						redBirdCageFrame[num11] = 13;
					}
					else
					{
						redBirdCageFrame[num11]++;
					}
				}
			}
			else if (redBirdCageFrame[num11] == 6)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] <= rand.Next(45, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(6) == 0)
					{
						redBirdCageFrame[num11] = 7;
					}
					else if (rand.Next(6) == 0)
					{
						redBirdCageFrame[num11] = 11;
					}
				}
				redBirdCageFrameCounter[num11] = 0;
			}
			else if (redBirdCageFrame[num11] >= 7 && redBirdCageFrame[num11] <= 10)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] >= 5)
				{
					redBirdCageFrame[num11]++;
					if (redBirdCageFrame[num11] > 10)
					{
						redBirdCageFrame[num11] = 0;
					}
					redBirdCageFrameCounter[num11] = 0;
				}
			}
			else if (redBirdCageFrame[num11] >= 11 && redBirdCageFrame[num11] <= 13)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] >= 5)
				{
					redBirdCageFrame[num11]++;
					redBirdCageFrameCounter[num11] = 0;
				}
			}
			else if (redBirdCageFrame[num11] == 14)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] > rand.Next(5, 600))
				{
					if (rand.Next(20) == 0)
					{
						redBirdCageFrame[num11] = 16;
					}
					else if (rand.Next(20) == 0)
					{
						redBirdCageFrame[num11] = 4;
					}
					else
					{
						redBirdCageFrame[num11] = 15;
					}
					redBirdCageFrameCounter[num11] = 0;
				}
			}
			else if (redBirdCageFrame[num11] == 15)
			{
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] >= 10)
				{
					redBirdCageFrameCounter[num11] = 0;
					redBirdCageFrame[num11] = 14;
				}
			}
			else
			{
				if (redBirdCageFrame[num11] < 16 || redBirdCageFrame[num11] > 18)
				{
					continue;
				}
				redBirdCageFrameCounter[num11]++;
				if (redBirdCageFrameCounter[num11] >= 5)
				{
					redBirdCageFrame[num11]++;
					if (redBirdCageFrame[num11] > 18)
					{
						redBirdCageFrame[num11] = 0;
					}
					redBirdCageFrameCounter[num11] = 0;
				}
			}
		}
		for (int num12 = 0; num12 < cageFrames; num12++)
		{
			if (macawCageFrame[num12] == 0)
			{
				macawCageFrameCounter[num12]++;
				if (macawCageFrameCounter[num12] <= rand.Next(300, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(3) != 0)
					{
						macawCageFrame[num12] = 16;
					}
					else
					{
						macawCageFrame[num12] = 1;
					}
				}
				macawCageFrameCounter[num12] = 0;
			}
			else if (macawCageFrame[num12] >= 1 && macawCageFrame[num12] <= 5)
			{
				macawCageFrameCounter[num12]++;
				if (macawCageFrameCounter[num12] > 5)
				{
					macawCageFrameCounter[num12] = 0;
					macawCageFrame[num12]++;
					if (macawCageFrame[num12] > 5)
					{
						macawCageFrame[num12] = 6;
					}
				}
			}
			else if (macawCageFrame[num12] >= 16 && macawCageFrame[num12] <= 19)
			{
				macawCageFrameCounter[num12]++;
				if (macawCageFrameCounter[num12] > 6)
				{
					macawCageFrameCounter[num12] = 0;
					macawCageFrame[num12]++;
					if (macawCageFrame[num12] > 19)
					{
						macawCageFrame[num12] = ((rand.Next(3) != 0) ? 16 : 0);
					}
				}
			}
			else if (macawCageFrame[num12] == 6)
			{
				macawCageFrameCounter[num12]++;
				if (macawCageFrameCounter[num12] <= rand.Next(300, 2700))
				{
					continue;
				}
				if (rand.Next(3) != 0)
				{
					if (rand.Next(3) != 0)
					{
						macawCageFrame[num12] = 7;
					}
					else
					{
						macawCageFrame[num12] = 11;
					}
				}
				macawCageFrameCounter[num12] = 0;
			}
			else if (macawCageFrame[num12] >= 11 && macawCageFrame[num12] <= 15)
			{
				macawCageFrameCounter[num12]++;
				if (macawCageFrameCounter[num12] > 5)
				{
					macawCageFrameCounter[num12] = 0;
					macawCageFrame[num12]++;
					if (macawCageFrame[num12] > 15)
					{
						macawCageFrame[num12] = 0;
					}
				}
			}
			else
			{
				if (macawCageFrame[num12] < 7 || macawCageFrame[num12] > 10)
				{
					continue;
				}
				macawCageFrameCounter[num12]++;
				if (macawCageFrameCounter[num12] > 6)
				{
					macawCageFrameCounter[num12] = 0;
					macawCageFrame[num12]++;
					if (macawCageFrame[num12] > 10)
					{
						macawCageFrame[num12] = ((rand.Next(3) == 0) ? 6 : 7);
					}
				}
			}
		}
		for (int num13 = 0; num13 < 2; num13++)
		{
			for (int num14 = 0; num14 < cageFrames; num14++)
			{
				if (scorpionCageFrame[num13, num14] == 0 || scorpionCageFrame[num13, num14] == 7)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] <= rand.Next(30, 3600))
					{
						continue;
					}
					if (scorpionCageFrame[num13, num14] == 7)
					{
						scorpionCageFrame[num13, num14] = 0;
					}
					else if (rand.Next(3) == 0)
					{
						if (rand.Next(7) == 0)
						{
							scorpionCageFrame[num13, num14] = 1;
						}
						else if (rand.Next(4) == 0)
						{
							scorpionCageFrame[num13, num14] = 8;
						}
						else if (rand.Next(3) == 0)
						{
							scorpionCageFrame[num13, num14] = 7;
						}
						else
						{
							scorpionCageFrame[num13, num14] = 14;
						}
					}
					scorpionCageFrameCounter[num13, num14] = 0;
				}
				else if (scorpionCageFrame[num13, num14] >= 1 && scorpionCageFrame[num13, num14] <= 2)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] >= 10)
					{
						scorpionCageFrameCounter[num13, num14] = 0;
						scorpionCageFrame[num13, num14]++;
					}
				}
				else if (scorpionCageFrame[num13, num14] >= 8 && scorpionCageFrame[num13, num14] <= 10)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] >= 10)
					{
						scorpionCageFrameCounter[num13, num14] = 0;
						scorpionCageFrame[num13, num14]++;
					}
				}
				else if (scorpionCageFrame[num13, num14] == 11)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] > rand.Next(45, 5400))
					{
						if (rand.Next(6) == 0)
						{
							scorpionCageFrame[num13, num14] = 12;
						}
						scorpionCageFrameCounter[num13, num14] = 0;
					}
				}
				else if (scorpionCageFrame[num13, num14] >= 12 && scorpionCageFrame[num13, num14] <= 13)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] >= 10)
					{
						scorpionCageFrameCounter[num13, num14] = 0;
						scorpionCageFrame[num13, num14]++;
						if (scorpionCageFrame[num13, num14] > 13)
						{
							scorpionCageFrame[num13, num14] = 0;
						}
					}
				}
				else if (scorpionCageFrame[num13, num14] >= 14 && scorpionCageFrame[num13, num14] <= 15)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] >= 5)
					{
						scorpionCageFrameCounter[num13, num14] = 0;
						scorpionCageFrame[num13, num14]++;
						if (scorpionCageFrame[num13, num14] > 15)
						{
							scorpionCageFrame[num13, num14] = 14;
						}
						if (rand.Next(5) == 0)
						{
							scorpionCageFrame[num13, num14] = 0;
						}
					}
				}
				else if (scorpionCageFrame[num13, num14] == 4 || scorpionCageFrame[num13, num14] == 3)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] <= rand.Next(30, 3600))
					{
						continue;
					}
					if (scorpionCageFrame[num13, num14] == 3)
					{
						scorpionCageFrame[num13, num14] = 4;
					}
					else if (rand.Next(3) == 0)
					{
						if (rand.Next(5) == 0)
						{
							scorpionCageFrame[num13, num14] = 5;
						}
						else if (rand.Next(3) == 0)
						{
							scorpionCageFrame[num13, num14] = 3;
						}
						else
						{
							scorpionCageFrame[num13, num14] = 16;
						}
					}
					scorpionCageFrameCounter[num13, num14] = 0;
				}
				else if (scorpionCageFrame[num13, num14] >= 5 && scorpionCageFrame[num13, num14] <= 6)
				{
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] >= 10)
					{
						scorpionCageFrameCounter[num13, num14] = 0;
						scorpionCageFrame[num13, num14]++;
						if (scorpionCageFrame[num13, num14] > 7)
						{
							scorpionCageFrame[num13, num14] = 0;
						}
					}
				}
				else
				{
					if (scorpionCageFrame[num13, num14] < 16 || scorpionCageFrame[num13, num14] > 17)
					{
						continue;
					}
					scorpionCageFrameCounter[num13, num14]++;
					if (scorpionCageFrameCounter[num13, num14] >= 5)
					{
						scorpionCageFrameCounter[num13, num14] = 0;
						scorpionCageFrame[num13, num14]++;
						if (scorpionCageFrame[num13, num14] > 17)
						{
							scorpionCageFrame[num13, num14] = 16;
						}
						if (rand.Next(5) == 0)
						{
							scorpionCageFrame[num13, num14] = 4;
						}
					}
				}
			}
		}
		for (int num15 = 0; num15 < cageFrames; num15++)
		{
			if (penguinCageFrame[num15] == 0)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] <= rand.Next(30, 1800))
				{
					continue;
				}
				if (rand.Next(2) == 0)
				{
					if (rand.Next(10) == 0)
					{
						penguinCageFrame[num15] = 4;
					}
					else if (rand.Next(7) == 0)
					{
						penguinCageFrame[num15] = 15;
					}
					else if (rand.Next(3) == 0)
					{
						penguinCageFrame[num15] = 2;
					}
					else
					{
						penguinCageFrame[num15] = 1;
					}
				}
				penguinCageFrameCounter[num15] = 0;
			}
			else if (penguinCageFrame[num15] == 1)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] >= 10)
				{
					penguinCageFrameCounter[num15] = 0;
					penguinCageFrame[num15] = 0;
				}
			}
			else if (penguinCageFrame[num15] >= 2 && penguinCageFrame[num15] <= 3)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] < 5)
				{
					continue;
				}
				penguinCageFrameCounter[num15] = 0;
				penguinCageFrame[num15]++;
				if (penguinCageFrame[num15] > 3)
				{
					if (rand.Next(3) == 0)
					{
						penguinCageFrame[num15] = 0;
					}
					else
					{
						penguinCageFrame[num15] = 2;
					}
				}
			}
			else if (penguinCageFrame[num15] >= 4 && penguinCageFrame[num15] <= 6)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] >= 10)
				{
					penguinCageFrameCounter[num15] = 0;
					penguinCageFrame[num15]++;
				}
			}
			else if (penguinCageFrame[num15] == 15)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] > rand.Next(10, 1800))
				{
					if (rand.Next(2) == 0)
					{
						penguinCageFrame[num15] = 0;
					}
					penguinCageFrameCounter[num15] = 0;
				}
			}
			else if (penguinCageFrame[num15] == 8)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] <= rand.Next(30, 3600))
				{
					continue;
				}
				if (rand.Next(2) == 0)
				{
					if (rand.Next(10) == 0)
					{
						penguinCageFrame[num15] = 12;
					}
					else if (rand.Next(7) == 0)
					{
						penguinCageFrame[num15] = 7;
					}
					else if (rand.Next(3) == 0)
					{
						penguinCageFrame[num15] = 10;
					}
					else
					{
						penguinCageFrame[num15] = 9;
					}
				}
				penguinCageFrameCounter[num15] = 0;
			}
			else if (penguinCageFrame[num15] == 9)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] >= 10)
				{
					penguinCageFrameCounter[num15] = 0;
					penguinCageFrame[num15] = 8;
				}
			}
			else if (penguinCageFrame[num15] >= 10 && penguinCageFrame[num15] <= 11)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] < 5)
				{
					continue;
				}
				penguinCageFrameCounter[num15] = 0;
				penguinCageFrame[num15]++;
				if (penguinCageFrame[num15] > 3)
				{
					if (rand.Next(3) == 0)
					{
						penguinCageFrame[num15] = 8;
					}
					else
					{
						penguinCageFrame[num15] = 10;
					}
				}
			}
			else if (penguinCageFrame[num15] >= 12 && penguinCageFrame[num15] <= 14)
			{
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] >= 10)
				{
					penguinCageFrameCounter[num15] = 0;
					penguinCageFrame[num15]++;
				}
			}
			else
			{
				if (penguinCageFrame[num15] != 7)
				{
					continue;
				}
				penguinCageFrameCounter[num15]++;
				if (penguinCageFrameCounter[num15] > rand.Next(10, 3600))
				{
					if (rand.Next(2) == 0)
					{
						penguinCageFrame[num15] = 8;
					}
					penguinCageFrameCounter[num15] = 0;
				}
			}
		}
		for (int num16 = 0; num16 < cageFrames; num16++)
		{
			turtleCageFrameCounter[num16]++;
			bool num17 = turtleCageFrame[num16] == 0 || turtleCageFrame[num16] == 15 || turtleCageFrame[num16] == 31;
			int num18 = 8;
			if (num17)
			{
				num18 = rand.Next(180, 250);
			}
			if (turtleCageFrameCounter[num16] < num18)
			{
				continue;
			}
			turtleCageFrameCounter[num16] = 0;
			if (turtleCageFrame[num16] == 29)
			{
				turtleCageFrame[num16] = 0;
				continue;
			}
			if (turtleCageFrame[num16] == 15 && rand.Next(3) == 0)
			{
				turtleCageFrame[num16] = 30;
				continue;
			}
			turtleCageFrame[num16]++;
			if (turtleCageFrame[num16] > 32)
			{
				turtleCageFrame[num16] = 15;
			}
		}
		for (int num19 = 0; num19 < cageFrames; num19++)
		{
			seahorseCageFrameCounter[num19]++;
			bool flag4 = seahorseCageFrame[num19] == 0 || seahorseCageFrame[num19] == 13;
			bool num20 = seahorseCageFrame[num19] == 4 || seahorseCageFrame[num19] == 9 || seahorseCageFrame[num19] == 17 || seahorseCageFrame[num19] == 22;
			bool flag5 = seahorseCageFrame[num19] >= 25;
			int num21 = 7;
			if (flag4)
			{
				num21 = rand.Next(220, 340);
			}
			if (num20)
			{
				num21 = 10;
			}
			if (flag5)
			{
				num21 = 6;
			}
			if (seahorseCageFrameCounter[num19] < num21)
			{
				continue;
			}
			seahorseCageFrameCounter[num19] = 0;
			if (seahorseCageFrame[num19] == 0 && rand.Next(2) == 0)
			{
				seahorseCageFrame[num19] = 25;
				continue;
			}
			if (seahorseCageFrame[num19] == 24)
			{
				seahorseCageFrame[num19] = 0;
				continue;
			}
			seahorseCageFrame[num19]++;
			if (seahorseCageFrame[num19] > 33)
			{
				seahorseCageFrame[num19] = 0;
			}
		}
		int num22 = 40;
		for (int num23 = 0; num23 < cageFrames; num23++)
		{
			if (pufferfishCageFrame[num23] >= 0 && pufferfishCageFrame[num23] <= num22)
			{
				pufferfishCageFrameCounter[num23]++;
				if (pufferfishCageFrameCounter[num23] < 7)
				{
					continue;
				}
				pufferfishCageFrameCounter[num23] = 0;
				pufferfishCageFrame[num23]++;
				if (pufferfishCageFrame[num23] > num22)
				{
					pufferfishCageFrame[num23] = 0;
				}
				if (rand.Next(75) == 0)
				{
					switch (pufferfishCageFrame[num23])
					{
					case 0:
					case 1:
					case 2:
						pufferfishCageFrame[num23] = 41;
						break;
					case 8:
					case 9:
					case 10:
						pufferfishCageFrame[num23] = 46;
						break;
					case 17:
					case 18:
					case 19:
						pufferfishCageFrame[num23] = 51;
						break;
					case 20:
					case 21:
					case 22:
						pufferfishCageFrame[num23] = 56;
						break;
					case 30:
					case 31:
					case 32:
						pufferfishCageFrame[num23] = 61;
						break;
					case 37:
					case 38:
					case 39:
					case 40:
						pufferfishCageFrame[num23] = 66;
						break;
					}
				}
				continue;
			}
			int num24 = 7;
			int num25 = 5 * num24 * 5 + 8;
			int num26 = num25 - 8;
			pufferfishCageFrameCounter[num23]++;
			if (pufferfishCageFrameCounter[num23] < num26)
			{
				int num27 = pufferfishCageFrameCounter[num23] / num24;
				if (num27 > 3)
				{
					num27 = 3;
				}
				switch (pufferfishCageFrame[num23])
				{
				default:
					pufferfishCageFrame[num23] = 41 + num27;
					break;
				case 46:
				case 47:
				case 48:
				case 49:
				case 50:
					pufferfishCageFrame[num23] = 46 + num27;
					break;
				case 51:
				case 52:
				case 53:
				case 54:
				case 55:
					pufferfishCageFrame[num23] = 51 + num27;
					break;
				case 56:
				case 57:
				case 58:
				case 59:
				case 60:
					pufferfishCageFrame[num23] = 56 + num27;
					break;
				case 61:
				case 62:
				case 63:
				case 64:
				case 65:
					pufferfishCageFrame[num23] = 61 + num27;
					break;
				case 66:
				case 67:
				case 68:
				case 69:
				case 70:
					pufferfishCageFrame[num23] = 66 + num27;
					break;
				}
			}
			else if (pufferfishCageFrameCounter[num23] >= num26)
			{
				switch (pufferfishCageFrame[num23])
				{
				default:
					pufferfishCageFrame[num23] = 45;
					break;
				case 46:
				case 47:
				case 48:
				case 49:
				case 50:
					pufferfishCageFrame[num23] = 50;
					break;
				case 51:
				case 52:
				case 53:
				case 54:
				case 55:
					pufferfishCageFrame[num23] = 55;
					break;
				case 56:
				case 57:
				case 58:
				case 59:
				case 60:
					pufferfishCageFrame[num23] = 60;
					break;
				case 61:
				case 62:
				case 63:
				case 64:
				case 65:
					pufferfishCageFrame[num23] = 65;
					break;
				case 66:
				case 67:
				case 68:
				case 69:
				case 70:
					pufferfishCageFrame[num23] = 70;
					break;
				}
			}
			if (pufferfishCageFrameCounter[num23] >= num25)
			{
				pufferfishCageFrameCounter[num23] = 0;
				switch (pufferfishCageFrame[num23])
				{
				case 41:
				case 42:
				case 43:
				case 44:
				case 45:
					pufferfishCageFrame[num23] = 1;
					break;
				case 46:
				case 47:
				case 48:
				case 49:
				case 50:
					pufferfishCageFrame[num23] = 9;
					break;
				case 51:
				case 52:
				case 53:
				case 54:
				case 55:
					pufferfishCageFrame[num23] = 18;
					break;
				case 56:
				case 57:
				case 58:
				case 59:
				case 60:
					pufferfishCageFrame[num23] = 21;
					break;
				case 61:
				case 62:
				case 63:
				case 64:
				case 65:
					pufferfishCageFrame[num23] = 31;
					break;
				case 66:
				case 67:
				case 68:
				case 69:
				case 70:
					pufferfishCageFrame[num23] = 38;
					break;
				}
			}
		}
		UpdateOwlCageFrames();
		for (int num28 = 0; num28 < cageFrames; num28++)
		{
			if (snailCageFrame[num28] >= 0 && snailCageFrame[num28] <= 13)
			{
				snailCageFrameCounter[num28]++;
				if (snailCageFrameCounter[num28] <= rand.Next(45, 3600))
				{
					continue;
				}
				if (snailCageFrame[num28] == 8 && rand.Next(2) == 0)
				{
					snailCageFrame[num28] = 14;
				}
				else if (snailCageFrame[num28] == 1 && rand.Next(3) == 0)
				{
					snailCageFrame[num28] = 19;
				}
				else if (snailCageFrame[num28] == 1 && rand.Next(3) == 0)
				{
					snailCageFrame[num28] = 20;
				}
				else
				{
					snailCageFrame[num28]++;
					if (snailCageFrame[num28] > 13)
					{
						snailCageFrame[num28] = 0;
					}
				}
				snailCageFrameCounter[num28] = 0;
			}
			else if (snailCageFrame[num28] >= 14 && snailCageFrame[num28] <= 18)
			{
				snailCageFrameCounter[num28]++;
				if (snailCageFrameCounter[num28] >= 5)
				{
					snailCageFrameCounter[num28] = 0;
					snailCageFrame[num28]++;
				}
				if (snailCageFrame[num28] > 18)
				{
					snailCageFrame[num28] = 20;
				}
			}
			else
			{
				if (snailCageFrame[num28] != 19 && snailCageFrame[num28] != 20)
				{
					continue;
				}
				snailCageFrameCounter[num28]++;
				if (snailCageFrameCounter[num28] <= rand.Next(60, 7200))
				{
					continue;
				}
				snailCageFrameCounter[num28] = 0;
				if (rand.Next(4) == 0)
				{
					if (rand.Next(3) == 0)
					{
						snailCageFrame[num28] = 2;
					}
					else if (snailCageFrame[num28] == 19)
					{
						snailCageFrame[num28] = 20;
					}
					else
					{
						snailCageFrame[num28] = 19;
					}
				}
			}
		}
		for (int num29 = 0; num29 < cageFrames; num29++)
		{
			if (snail2CageFrame[num29] >= 0 && snail2CageFrame[num29] <= 13)
			{
				snail2CageFrameCounter[num29]++;
				if (snail2CageFrameCounter[num29] <= rand.Next(30, 2700))
				{
					continue;
				}
				if (snail2CageFrame[num29] == 8 && rand.Next(2) == 0)
				{
					snail2CageFrame[num29] = 14;
				}
				else if (snail2CageFrame[num29] == 1 && rand.Next(3) == 0)
				{
					snail2CageFrame[num29] = 19;
				}
				else if (snail2CageFrame[num29] == 1 && rand.Next(3) == 0)
				{
					snail2CageFrame[num29] = 20;
				}
				else
				{
					snail2CageFrame[num29]++;
					if (snail2CageFrame[num29] > 13)
					{
						snail2CageFrame[num29] = 0;
					}
				}
				snail2CageFrameCounter[num29] = 0;
			}
			else if (snail2CageFrame[num29] >= 14 && snail2CageFrame[num29] <= 18)
			{
				snail2CageFrameCounter[num29]++;
				if (snail2CageFrameCounter[num29] >= 5)
				{
					snail2CageFrameCounter[num29] = 0;
					snail2CageFrame[num29]++;
				}
				if (snail2CageFrame[num29] > 18)
				{
					snail2CageFrame[num29] = 20;
				}
			}
			else
			{
				if (snail2CageFrame[num29] != 19 && snail2CageFrame[num29] != 20)
				{
					continue;
				}
				snail2CageFrameCounter[num29]++;
				if (snail2CageFrameCounter[num29] <= rand.Next(45, 5400))
				{
					continue;
				}
				snail2CageFrameCounter[num29] = 0;
				if (rand.Next(4) == 0)
				{
					if (rand.Next(3) == 0)
					{
						snail2CageFrame[num29] = 2;
					}
					else if (snail2CageFrame[num29] == 19)
					{
						snail2CageFrame[num29] = 20;
					}
					else
					{
						snail2CageFrame[num29] = 19;
					}
				}
			}
		}
		for (int num30 = 0; num30 < cageFrames; num30++)
		{
			if (frogCageFrame[num30] == 0)
			{
				frogCageFrameCounter[num30]++;
				if (frogCageFrameCounter[num30] > rand.Next(45, 3600))
				{
					if (rand.Next(10) == 0)
					{
						frogCageFrame[num30] = 1;
					}
					else
					{
						frogCageFrame[num30] = 12;
					}
					frogCageFrameCounter[num30] = 0;
				}
			}
			else if (frogCageFrame[num30] >= 1 && frogCageFrame[num30] <= 5)
			{
				frogCageFrameCounter[num30]++;
				if (frogCageFrameCounter[num30] >= 5)
				{
					frogCageFrame[num30]++;
					frogCageFrameCounter[num30] = 0;
				}
			}
			else if (frogCageFrame[num30] >= 12 && frogCageFrame[num30] <= 17)
			{
				frogCageFrameCounter[num30]++;
				if (frogCageFrameCounter[num30] >= 5)
				{
					frogCageFrameCounter[num30] = 0;
					frogCageFrame[num30]++;
				}
				if (frogCageFrame[num30] > 17)
				{
					if (rand.Next(3) == 0)
					{
						frogCageFrame[num30] = 0;
					}
					else
					{
						frogCageFrame[num30] = 12;
					}
				}
			}
			else if (frogCageFrame[num30] == 6)
			{
				frogCageFrameCounter[num30]++;
				if (frogCageFrameCounter[num30] > rand.Next(45, 3600))
				{
					if (rand.Next(10) == 0)
					{
						frogCageFrame[num30] = 7;
					}
					else
					{
						frogCageFrame[num30] = 18;
					}
					frogCageFrameCounter[num30] = 0;
				}
			}
			else if (frogCageFrame[num30] >= 7 && frogCageFrame[num30] <= 11)
			{
				frogCageFrameCounter[num30]++;
				if (frogCageFrameCounter[num30] >= 5)
				{
					frogCageFrame[num30]++;
					frogCageFrameCounter[num30] = 0;
					if (frogCageFrame[num30] > 11)
					{
						frogCageFrame[num30] = 0;
					}
				}
			}
			else
			{
				if (frogCageFrame[num30] < 18 || frogCageFrame[num30] > 23)
				{
					continue;
				}
				frogCageFrameCounter[num30]++;
				if (frogCageFrameCounter[num30] >= 5)
				{
					frogCageFrameCounter[num30] = 0;
					frogCageFrame[num30]++;
				}
				if (frogCageFrame[num30] > 17)
				{
					if (rand.Next(3) == 0)
					{
						frogCageFrame[num30] = 6;
					}
					else
					{
						frogCageFrame[num30] = 18;
					}
				}
			}
		}
		for (int num31 = 0; num31 < cageFrames; num31++)
		{
			if (mouseCageFrame[num31] >= 0 && mouseCageFrame[num31] <= 1)
			{
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrame[num31]++;
					if (mouseCageFrame[num31] > 1)
					{
						mouseCageFrame[num31] = 0;
					}
					mouseCageFrameCounter[num31] = 0;
					if (rand.Next(15) == 0)
					{
						mouseCageFrame[num31] = 4;
					}
				}
			}
			else if (mouseCageFrame[num31] >= 4 && mouseCageFrame[num31] <= 7)
			{
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrameCounter[num31] = 0;
					mouseCageFrame[num31]++;
				}
				if (mouseCageFrame[num31] > 7)
				{
					mouseCageFrame[num31] = 2;
				}
			}
			else if (mouseCageFrame[num31] >= 2 && mouseCageFrame[num31] <= 3)
			{
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrame[num31]++;
					if (mouseCageFrame[num31] > 3)
					{
						mouseCageFrame[num31] = 2;
					}
					mouseCageFrameCounter[num31] = 0;
					if (rand.Next(15) == 0)
					{
						mouseCageFrame[num31] = 8;
					}
					else if (rand.Next(15) == 0)
					{
						mouseCageFrame[num31] = 12;
					}
				}
			}
			else if (mouseCageFrame[num31] >= 8 && mouseCageFrame[num31] <= 11)
			{
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrameCounter[num31] = 0;
					mouseCageFrame[num31]++;
				}
				if (mouseCageFrame[num31] > 11)
				{
					mouseCageFrame[num31] = 0;
				}
			}
			else if (mouseCageFrame[num31] >= 12 && mouseCageFrame[num31] <= 13)
			{
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrameCounter[num31] = 0;
					mouseCageFrame[num31]++;
				}
			}
			else if (mouseCageFrame[num31] >= 14 && mouseCageFrame[num31] <= 17)
			{
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrameCounter[num31] = 0;
					mouseCageFrame[num31]++;
					if (mouseCageFrame[num31] > 17 && rand.Next(20) != 0)
					{
						mouseCageFrame[num31] = 14;
					}
				}
			}
			else
			{
				if (mouseCageFrame[num31] < 18 || mouseCageFrame[num31] > 19)
				{
					continue;
				}
				mouseCageFrameCounter[num31]++;
				if (mouseCageFrameCounter[num31] >= 5)
				{
					mouseCageFrameCounter[num31] = 0;
					mouseCageFrame[num31]++;
					if (mouseCageFrame[num31] > 19)
					{
						mouseCageFrame[num31] = 0;
					}
				}
			}
		}
		for (int num32 = 0; num32 < cageFrames; num32++)
		{
			wormCageFrameCounter[num32]++;
			if (wormCageFrameCounter[num32] < rand.Next(30, 91))
			{
				continue;
			}
			wormCageFrameCounter[num32] = 0;
			if (rand.Next(4) != 0)
			{
				continue;
			}
			wormCageFrame[num32]++;
			if (wormCageFrame[num32] == 9 && rand.Next(2) == 0)
			{
				wormCageFrame[num32] = 0;
			}
			if (wormCageFrame[num32] > 18)
			{
				if (rand.Next(2) == 0)
				{
					wormCageFrame[num32] = 9;
				}
				else
				{
					wormCageFrame[num32] = 0;
				}
			}
		}
		int num33 = 0;
		for (int num34 = 0; num34 < 3; num34++)
		{
			switch (num34)
			{
			case 0:
				num33 = 24;
				break;
			case 1:
				num33 = 31;
				break;
			case 2:
				num33 = 34;
				break;
			}
			for (int num35 = 0; num35 < cageFrames; num35++)
			{
				if (++slugCageFrameCounter[num34, num35] >= rand.Next(5, 15))
				{
					slugCageFrameCounter[num34, num35] = 0;
					if (++slugCageFrame[num34, num35] >= num33)
					{
						slugCageFrame[num34, num35] = 0;
					}
				}
			}
		}
		for (int num36 = 0; num36 < cageFrames; num36++)
		{
			if (grasshopperCageFrame[num36] >= 0 && grasshopperCageFrame[num36] <= 1)
			{
				grasshopperCageFrameCounter[num36]++;
				if (grasshopperCageFrameCounter[num36] >= 5)
				{
					grasshopperCageFrame[num36]++;
					if (grasshopperCageFrame[num36] > 1)
					{
						grasshopperCageFrame[num36] = 0;
					}
					grasshopperCageFrameCounter[num36] = 0;
					if (rand.Next(15) == 0)
					{
						grasshopperCageFrame[num36] = 2;
					}
				}
			}
			else if (grasshopperCageFrame[num36] >= 2 && grasshopperCageFrame[num36] <= 5)
			{
				grasshopperCageFrameCounter[num36]++;
				if (grasshopperCageFrameCounter[num36] >= 5)
				{
					grasshopperCageFrameCounter[num36] = 0;
					grasshopperCageFrame[num36]++;
				}
				if (grasshopperCageFrame[num36] > 5)
				{
					grasshopperCageFrame[num36] = 6;
				}
			}
			else if (grasshopperCageFrame[num36] >= 6 && grasshopperCageFrame[num36] <= 7)
			{
				grasshopperCageFrameCounter[num36]++;
				if (grasshopperCageFrameCounter[num36] >= 5)
				{
					grasshopperCageFrame[num36]++;
					if (grasshopperCageFrame[num36] > 7)
					{
						grasshopperCageFrame[num36] = 6;
					}
					grasshopperCageFrameCounter[num36] = 0;
					if (rand.Next(15) == 0)
					{
						grasshopperCageFrame[num36] = 8;
					}
				}
			}
			else if (grasshopperCageFrame[num36] >= 8 && grasshopperCageFrame[num36] <= 11)
			{
				grasshopperCageFrameCounter[num36]++;
				if (grasshopperCageFrameCounter[num36] >= 5)
				{
					grasshopperCageFrameCounter[num36] = 0;
					grasshopperCageFrame[num36]++;
				}
				if (grasshopperCageFrame[num36] > 11)
				{
					grasshopperCageFrame[num36] = 0;
				}
			}
		}
		for (int num37 = 0; num37 < cageFrames; num37++)
		{
			maggotCageFrameCounter[num37]++;
			bool num38 = maggotCageFrame[num37] == 0 || maggotCageFrame[num37] == 6 || maggotCageFrame[num37] == 18;
			int num39 = 8;
			if (num38)
			{
				num39 = rand.Next(100, 140);
			}
			if (maggotCageFrameCounter[num37] < num39)
			{
				continue;
			}
			maggotCageFrameCounter[num37] = 0;
			if (maggotCageFrame[num37] == 0)
			{
				if (rand.Next(3) == 0)
				{
					maggotCageFrame[num37] = 13;
				}
				else
				{
					maggotCageFrame[num37] = 1;
				}
				continue;
			}
			if (maggotCageFrame[num37] == 12)
			{
				maggotCageFrame[num37] = 0;
				continue;
			}
			maggotCageFrame[num37]++;
			if (maggotCageFrame[num37] > 23)
			{
				maggotCageFrame[num37] = 6;
			}
		}
		for (int num40 = 0; num40 < cageFrames; num40++)
		{
			ladybugCageFrameCounter[num40]++;
			bool flag6 = ladybugCageFrame[num40] == 3 || ladybugCageFrame[num40] == 7 || ladybugCageFrame[num40] >= 17;
			int num41 = rand.Next(10, 12);
			if (ladybugCageFrame[num40] == 18)
			{
				num41 = rand.Next(160, 241);
			}
			else if (flag6)
			{
				num41 = rand.Next(198, 206);
			}
			else if (ladybugCageFrame[num40] >= 8 && ladybugCageFrame[num40] <= 16)
			{
				num41 = 5;
			}
			if (ladybugCageFrameCounter[num40] < num41)
			{
				continue;
			}
			ladybugCageFrameCounter[num40] = 0;
			if (ladybugCageFrame[num40] < 18)
			{
				if ((ladybugCageFrame[num40] == 2 || ladybugCageFrame[num40] == 5) && rand.Next(3) == 0)
				{
					ladybugCageFrame[num40] = 17;
				}
				else if (ladybugCageFrame[num40] == 3 || ladybugCageFrame[num40] == 12)
				{
					switch (rand.Next(3))
					{
					case 0:
					case 1:
						ladybugCageFrame[num40] = 4;
						break;
					case 2:
						ladybugCageFrame[num40] = 13;
						break;
					}
				}
				else if (ladybugCageFrame[num40] == 7 || ladybugCageFrame[num40] == 16)
				{
					switch (rand.Next(3))
					{
					case 0:
					case 1:
						ladybugCageFrame[num40] = 0;
						break;
					case 2:
						ladybugCageFrame[num40] = 8;
						break;
					}
				}
				else
				{
					ladybugCageFrame[num40]++;
				}
			}
			else
			{
				ladybugCageFrame[num40] = ((rand.Next(2) == 0) ? 13 : 4);
			}
		}
		for (int num42 = 0; num42 < cageFrames; num42++)
		{
			ratCageFrameCounter[num42]++;
			bool flag7 = ratCageFrame[num42] == 0 || ratCageFrame[num42] == 4;
			bool num43 = ratCageFrame[num42] == 8 || ratCageFrame[num42] == 9 || ratCageFrame[num42] == 10 || ratCageFrame[num42] == 11;
			bool flag8 = ratCageFrame[num42] > 11;
			int num44 = 5;
			if (flag7)
			{
				num44 = rand.Next(40, 70);
			}
			if (num43)
			{
				num44 = rand.Next(70, 110);
			}
			if (flag8)
			{
				num44 = 180;
			}
			if (ratCageFrameCounter[num42] >= num44)
			{
				ratCageFrameCounter[num42] = 0;
				if (ratCageFrame[num42] == 0 && rand.Next(2) == 0)
				{
					if (rand.Next(3) != 0)
					{
						ratCageFrame[num42] = 12;
					}
					else
					{
						ratCageFrame[num42] = 8;
					}
					continue;
				}
				if (ratCageFrame[num42] == 4 && rand.Next(2) == 0)
				{
					ratCageFrame[num42] = 10;
					continue;
				}
				if (ratCageFrame[num42] == 7 || ratCageFrame[num42] == 9 || ratCageFrame[num42] == 12)
				{
					ratCageFrame[num42] = 0;
					continue;
				}
				if (ratCageFrame[num42] == 11)
				{
					ratCageFrame[num42] = 4;
					continue;
				}
				ratCageFrame[num42]++;
				if (ratCageFrame[num42] > 16)
				{
					ratCageFrame[num42] = 0;
				}
			}
			else if (ratCageFrame[num42] > 11)
			{
				int num45 = ratCageFrameCounter[num42] % 90;
				if (num45 > 80)
				{
					ratCageFrame[num42] = 12;
				}
				else if (num45 > 70)
				{
					ratCageFrame[num42] = 13;
				}
				else if (num45 > 60)
				{
					ratCageFrame[num42] = 14;
				}
				else if (num45 > 50)
				{
					ratCageFrame[num42] = 15;
				}
				else if (num45 > 40)
				{
					ratCageFrame[num42] = 16;
				}
				else if (num45 > 30)
				{
					ratCageFrame[num42] = 15;
				}
				else if (num45 > 20)
				{
					ratCageFrame[num42] = 14;
				}
				else if (num45 > 10)
				{
					ratCageFrame[num42] = 13;
				}
				else
				{
					ratCageFrame[num42] = 12;
				}
			}
			else if (ratCageFrameCounter[num42] % 10 == 0)
			{
				if (ratCageFrame[num42] == 8 || ratCageFrame[num42] == 10)
				{
					ratCageFrame[num42]++;
				}
				else if (ratCageFrame[num42] == 9 || ratCageFrame[num42] == 11)
				{
					ratCageFrame[num42]--;
				}
			}
		}
		for (int num46 = 0; num46 < cageFrames; num46++)
		{
			waterStriderCageFrameCounter[num46]++;
			bool flag9 = waterStriderCageFrame[num46] == 0 || waterStriderCageFrame[num46] == 8;
			bool num47 = waterStriderCageFrame[num46] == 17 || waterStriderCageFrame[num46] == 20;
			int num48 = 5;
			if (flag9)
			{
				num48 = rand.Next(110, 210);
			}
			if (num47)
			{
				num48 = rand.Next(150, 260);
			}
			if (waterStriderCageFrameCounter[num46] < num48)
			{
				continue;
			}
			waterStriderCageFrameCounter[num46] = 0;
			if (waterStriderCageFrame[num46] == 0 && rand.Next(2) == 0)
			{
				waterStriderCageFrame[num46] = 16;
				continue;
			}
			if (waterStriderCageFrame[num46] == 8 && rand.Next(2) == 0)
			{
				waterStriderCageFrame[num46] = 19;
				continue;
			}
			if (waterStriderCageFrame[num46] == 15 || waterStriderCageFrame[num46] == 18)
			{
				waterStriderCageFrame[num46] = 0;
				continue;
			}
			waterStriderCageFrame[num46]++;
			if (waterStriderCageFrame[num46] > 21)
			{
				waterStriderCageFrame[num46] = 8;
			}
		}
		fairyJarFrameCounter[0]++;
		if (fairyJarFrameCounter[0] > 5)
		{
			fairyJarFrameCounter[0] = 0;
			fairyJarFrame[0]++;
			if (fairyJarFrame[0] > 11)
			{
				fairyJarFrame[0] = 0;
			}
		}
		for (int num49 = 1; num49 < cageFrames; num49++)
		{
			int num50 = fairyJarFrame[0] + num49 % 12;
			if (num49 % 2 == 0)
			{
				num50++;
			}
			if (num49 % 5 == 0)
			{
				num50++;
			}
			if (num49 % 8 == 0)
			{
				num50++;
			}
			while (num50 >= 12)
			{
				num50 -= 12;
			}
			fairyJarFrame[num49] = num50;
		}
		for (int num51 = 0; num51 < cageFrames; num51++)
		{
			byte maxValue = 5;
			if (fishBowlFrameMode[num51] == 1)
			{
				if (rand.Next(900) == 0)
				{
					fishBowlFrameMode[num51] = (byte)rand.Next(maxValue);
				}
				fishBowlFrameCounter[num51]++;
				if (fishBowlFrameCounter[num51] < 5)
				{
					continue;
				}
				fishBowlFrameCounter[num51] = 0;
				if (fishBowlFrame[num51] == 10)
				{
					if (rand.Next(20) == 0)
					{
						fishBowlFrame[num51] = 11;
						fishBowlFrameMode[num51] = 0;
					}
					else
					{
						fishBowlFrame[num51] = 1;
					}
				}
				else
				{
					fishBowlFrame[num51]++;
				}
			}
			else if (fishBowlFrameMode[num51] == 2)
			{
				if (rand.Next(3600) == 0)
				{
					fishBowlFrameMode[num51] = (byte)rand.Next(maxValue);
				}
				fishBowlFrameCounter[num51]++;
				if (fishBowlFrameCounter[num51] < 20)
				{
					continue;
				}
				fishBowlFrameCounter[num51] = 0;
				if (fishBowlFrame[num51] == 10)
				{
					if (rand.Next(20) == 0)
					{
						fishBowlFrame[num51] = 11;
						fishBowlFrameMode[num51] = 0;
					}
					else
					{
						fishBowlFrame[num51] = 1;
					}
				}
				else
				{
					fishBowlFrame[num51]++;
				}
			}
			else if (fishBowlFrameMode[num51] == 3)
			{
				if (rand.Next(3600) == 0)
				{
					fishBowlFrameMode[num51] = (byte)rand.Next(maxValue);
				}
				fishBowlFrameCounter[num51]++;
				if (fishBowlFrameCounter[num51] < rand.Next(5, 3600))
				{
					continue;
				}
				fishBowlFrameCounter[num51] = 0;
				if (fishBowlFrame[num51] == 10)
				{
					if (rand.Next(20) == 0)
					{
						fishBowlFrame[num51] = 11;
						fishBowlFrameMode[num51] = 0;
					}
					else
					{
						fishBowlFrame[num51] = 1;
					}
				}
				else
				{
					fishBowlFrame[num51]++;
				}
			}
			else if (fishBowlFrame[num51] <= 10)
			{
				if (rand.Next(3600) == 0)
				{
					fishBowlFrameMode[num51] = (byte)rand.Next(maxValue);
				}
				fishBowlFrameCounter[num51]++;
				if (fishBowlFrameCounter[num51] < 10)
				{
					continue;
				}
				fishBowlFrameCounter[num51] = 0;
				if (fishBowlFrame[num51] == 10)
				{
					if (rand.Next(12) == 0)
					{
						fishBowlFrame[num51] = 11;
					}
					else
					{
						fishBowlFrame[num51] = 1;
					}
				}
				else
				{
					fishBowlFrame[num51]++;
				}
			}
			else if (fishBowlFrame[num51] == 12 || fishBowlFrame[num51] == 13)
			{
				fishBowlFrameCounter[num51]++;
				if (fishBowlFrameCounter[num51] < 10)
				{
					continue;
				}
				fishBowlFrameCounter[num51] = 0;
				fishBowlFrame[num51]++;
				if (fishBowlFrame[num51] > 13)
				{
					if (rand.Next(20) == 0)
					{
						fishBowlFrame[num51] = 14;
					}
					else
					{
						fishBowlFrame[num51] = 12;
					}
				}
			}
			else
			{
				if (fishBowlFrame[num51] < 11)
				{
					continue;
				}
				fishBowlFrameCounter[num51]++;
				if (fishBowlFrameCounter[num51] >= 10)
				{
					fishBowlFrameCounter[num51] = 0;
					fishBowlFrame[num51]++;
					if (fishBowlFrame[num51] > 16)
					{
						fishBowlFrame[num51] = 4;
					}
				}
			}
		}
		for (int num52 = 0; num52 < cageFrames; num52++)
		{
			lavaFishBowlFrameCounter[num52]++;
			if (lavaFishBowlFrameCounter[num52] > 4 + rand.Next(3))
			{
				lavaFishBowlFrameCounter[num52] = 0;
				lavaFishBowlFrame[num52]++;
				if (lavaFishBowlFrame[num52] > 26)
				{
					lavaFishBowlFrame[num52] = 0;
				}
			}
		}
		for (int num53 = 0; num53 < 9; num53++)
		{
			for (int num54 = 0; num54 < cageFrames; num54++)
			{
				butterflyCageFrameCounter[num53, num54]++;
				if (rand.Next(3600) == 0)
				{
					butterflyCageMode[num53, num54] = (byte)rand.Next(5);
					if (rand.Next(2) == 0)
					{
						butterflyCageMode[num53, num54] += 10;
					}
				}
				int num55 = rand.Next(3, 16);
				if (butterflyCageMode[num53, num54] == 1 || butterflyCageMode[num53, num54] == 11)
				{
					num55 = 3;
				}
				if (butterflyCageMode[num53, num54] == 2 || butterflyCageMode[num53, num54] == 12)
				{
					num55 = 5;
				}
				if (butterflyCageMode[num53, num54] == 3 || butterflyCageMode[num53, num54] == 13)
				{
					num55 = 10;
				}
				if (butterflyCageMode[num53, num54] == 4 || butterflyCageMode[num53, num54] == 14)
				{
					num55 = 15;
				}
				if (butterflyCageMode[num53, num54] >= 10)
				{
					if (butterflyCageFrame[num53, num54] <= 7)
					{
						if (butterflyCageFrameCounter[num53, num54] < num55)
						{
							continue;
						}
						butterflyCageFrameCounter[num53, num54] = 0;
						butterflyCageFrame[num53, num54]--;
						if (butterflyCageFrame[num53, num54] < 0)
						{
							butterflyCageFrame[num53, num54] = 7;
						}
						if (butterflyCageFrame[num53, num54] != 1 && butterflyCageFrame[num53, num54] != 4 && butterflyCageFrame[num53, num54] != 6)
						{
							continue;
						}
						if (rand.Next(20) == 0)
						{
							butterflyCageFrame[num53, num54] += 8;
						}
						else if (rand.Next(6) == 0)
						{
							if (butterflyCageMode[num53, num54] >= 10)
							{
								butterflyCageMode[num53, num54] -= 10;
							}
							else
							{
								butterflyCageMode[num53, num54] += 10;
							}
						}
					}
					else
					{
						if (butterflyCageFrameCounter[num53, num54] < num55)
						{
							continue;
						}
						butterflyCageFrameCounter[num53, num54] = 0;
						butterflyCageFrame[num53, num54]--;
						if (butterflyCageFrame[num53, num54] < 8)
						{
							butterflyCageFrame[num53, num54] = 14;
						}
						if (butterflyCageFrame[num53, num54] != 9 && butterflyCageFrame[num53, num54] != 12 && butterflyCageFrame[num53, num54] != 14)
						{
							continue;
						}
						if (rand.Next(20) == 0)
						{
							butterflyCageFrame[num53, num54] -= 8;
						}
						else if (rand.Next(6) == 0)
						{
							if (butterflyCageMode[num53, num54] >= 10)
							{
								butterflyCageMode[num53, num54] -= 10;
							}
							else
							{
								butterflyCageMode[num53, num54] += 10;
							}
						}
					}
				}
				else if (butterflyCageFrame[num53, num54] <= 7)
				{
					if (butterflyCageFrameCounter[num53, num54] >= num55)
					{
						butterflyCageFrameCounter[num53, num54] = 0;
						butterflyCageFrame[num53, num54]++;
						if (butterflyCageFrame[num53, num54] > 7)
						{
							butterflyCageFrame[num53, num54] = 0;
						}
						if ((butterflyCageFrame[num53, num54] == 1 || butterflyCageFrame[num53, num54] == 4 || butterflyCageFrame[num53, num54] == 6) && rand.Next(10) == 0)
						{
							butterflyCageFrame[num53, num54] += 8;
						}
					}
				}
				else if (butterflyCageFrameCounter[num53, num54] >= num55)
				{
					butterflyCageFrameCounter[num53, num54] = 0;
					butterflyCageFrame[num53, num54]++;
					if (butterflyCageFrame[num53, num54] > 15)
					{
						butterflyCageFrame[num53, num54] = 8;
					}
					if ((butterflyCageFrame[num53, num54] == 9 || butterflyCageFrame[num53, num54] == 12 || butterflyCageFrame[num53, num54] == 14) && rand.Next(10) == 0)
					{
						butterflyCageFrame[num53, num54] -= 8;
					}
				}
			}
		}
		UpdateDragonflyJarFrames();
		for (int num56 = 0; num56 < 3; num56++)
		{
			for (int num57 = 0; num57 < cageFrames; num57++)
			{
				jellyfishCageFrameCounter[num56, num57]++;
				if (jellyfishCageMode[num56, num57] == 0 && rand.Next(1800) == 0)
				{
					jellyfishCageMode[num56, num57] = 1;
				}
				if (jellyfishCageMode[num56, num57] == 2 && rand.Next(60) == 0)
				{
					jellyfishCageMode[num56, num57] = 3;
				}
				int num58 = 1;
				if (jellyfishCageMode[num56, num57] == 0)
				{
					num58 = rand.Next(10, 20);
				}
				if (jellyfishCageMode[num56, num57] == 1)
				{
					num58 = rand.Next(15, 25);
				}
				if (jellyfishCageMode[num56, num57] == 2)
				{
					num58 = rand.Next(4, 9);
				}
				if (jellyfishCageMode[num56, num57] == 3)
				{
					num58 = rand.Next(15, 25);
				}
				if (jellyfishCageMode[num56, num57] == 0 && jellyfishCageFrame[num56, num57] <= 3 && jellyfishCageFrameCounter[num56, num57] >= num58)
				{
					jellyfishCageFrameCounter[num56, num57] = 0;
					jellyfishCageFrame[num56, num57]++;
					if (jellyfishCageFrame[num56, num57] >= 4)
					{
						jellyfishCageFrame[num56, num57] = 0;
					}
				}
				if (jellyfishCageMode[num56, num57] == 1 && jellyfishCageFrame[num56, num57] <= 7 && jellyfishCageFrameCounter[num56, num57] >= num58)
				{
					jellyfishCageFrameCounter[num56, num57] = 0;
					jellyfishCageFrame[num56, num57]++;
					if (jellyfishCageFrame[num56, num57] >= 7)
					{
						jellyfishCageMode[num56, num57] = 2;
					}
				}
				if (jellyfishCageMode[num56, num57] == 2 && jellyfishCageFrame[num56, num57] <= 9 && jellyfishCageFrameCounter[num56, num57] >= num58)
				{
					jellyfishCageFrameCounter[num56, num57] = 0;
					jellyfishCageFrame[num56, num57]++;
					if (jellyfishCageFrame[num56, num57] >= 9)
					{
						jellyfishCageFrame[num56, num57] = 7;
					}
				}
				if (jellyfishCageMode[num56, num57] == 3 && jellyfishCageFrame[num56, num57] <= 10 && jellyfishCageFrameCounter[num56, num57] >= num58)
				{
					jellyfishCageFrameCounter[num56, num57] = 0;
					jellyfishCageFrame[num56, num57]++;
					if (jellyfishCageFrame[num56, num57] >= 10)
					{
						jellyfishCageFrame[num56, num57] = 3;
						jellyfishCageMode[num56, num57] = 0;
					}
				}
			}
		}
	}

	private static void UpdateOwlCageFrames()
	{
		for (int i = 0; i < cageFrames; i++)
		{
			UpdateOwlCageFrame(owlCageFrame, owlCageFrameCounter, i);
		}
	}

	private static void UpdateDragonflyJarFrames()
	{
		for (int i = 0; i < dragonflyJarFrameCounter.GetLength(0); i++)
		{
			for (int j = 0; j < cageFrames; j++)
			{
				UpdateDragonflyJarFrame(dragonflyJarFrame, dragonflyJarFrameCounter, i, j);
			}
		}
	}

	private static void UpdateOwlCageFrame(int[] frames, int[] frameCounters, int style)
	{
		if (frameCounters[style] % 40 != 0 || rand.Next(80) == 0)
		{
			frameCounters[style]++;
		}
		if ((frameCounters[style] + 1) % 40 == 39)
		{
			frameCounters[style] = 40 * rand.Next(4);
		}
		int num = frameCounters[style] % 40 / 10;
		int num2 = frameCounters[style] / 40;
		int num3 = 0;
		switch (num2)
		{
		case 0:
			if (num == 3)
			{
				num = 1;
			}
			num3 = num;
			break;
		case 1:
			if (num == 3)
			{
				num = 1;
			}
			num3 = 0;
			if (num != 0)
			{
				num3 = 8 - num;
			}
			break;
		case 2:
			num3 = 0;
			if (num != 0)
			{
				num3 = 7 + num;
			}
			break;
		case 3:
			num3 = 0;
			if (num != 0)
			{
				num3 = 11 + num;
			}
			break;
		}
		frames[style] = num3;
	}

	private static void UpdateDragonflyJarFrame(int[,] frames, int[,] frameCounters, int style, int variation)
	{
		frameCounters[style, variation]++;
		switch (frames[style, variation])
		{
		case 0:
			if (frameCounters[style, variation] >= 300 && rand.Next(60) == 0)
			{
				frameCounters[style, variation] = 0;
				frames[style, variation] = rand.NextFromList<int>(1, 5, 9);
			}
			break;
		case 1:
		case 5:
		case 9:
			if (frameCounters[style, variation] >= 100)
			{
				frameCounters[style, variation] = 0;
				if (frames[style, variation] == 1)
				{
					frames[style, variation] = rand.NextFromList<int>(0, 5, 5, 9, 9);
				}
				else
				{
					frames[style, variation] = 1;
				}
			}
			else if (frameCounters[style, variation] >= 6)
			{
				frameCounters[style, variation] = 0;
				frames[style, variation]++;
			}
			break;
		case 2:
		case 3:
		case 4:
		case 6:
		case 7:
		case 8:
		case 10:
		case 11:
		case 12:
		{
			int num = frames[style, variation] - 1;
			int num2 = num % 4;
			num2--;
			int num3 = frameCounters[style, variation] / 4 % 4;
			if (num3 > 2)
			{
				num3 = 4 - num3;
			}
			int num4 = num - num2 + 1 + num3;
			frames[style, variation] = num4;
			if (frameCounters[style, variation] >= 40 && rand.Next(30) == 0)
			{
				frameCounters[style, variation] = 100;
				frames[style, variation] = num - num2 + 1 - 1;
			}
			break;
		}
		}
	}

	public static void DoUpdate_AnimateItemIcons()
	{
		for (int i = 0; i < itemAnimationsRegistered.Count; i++)
		{
			int num = itemAnimationsRegistered[i];
			if (itemAnimations[num] != null)
			{
				itemAnimations[num].Update();
			}
		}
	}

	public static void QueueMainThreadAction(Action action)
	{
		_mainThreadActions.Enqueue(action);
	}

	public static Task RunOnMainThread(Action action)
	{
		return RunOnMainThread(delegate
		{
			action();
			return (object)null;
		});
	}

	public static Task<T> RunOnMainThread<T>(Func<T> func)
	{
		TaskCompletionSource<T> tcs = new TaskCompletionSource<T>();
		QueueMainThreadAction(delegate
		{
			tcs.SetResult(func());
		});
		return tcs.Task;
	}

	private static void ConsumeAllMainThreadActions()
	{
		Action result;
		while (_mainThreadActions.TryDequeue(out result))
		{
			result();
		}
	}

	protected override void Update(GameTime gameTime)
	{
		if (!IsEnginePreloaded)
		{
			IsEnginePreloaded = true;
			if (Main.OnEnginePreload != null)
			{
				Main.OnEnginePreload();
			}
		}
		if (!_isDrawingOrUpdating)
		{
			_isDrawingOrUpdating = true;
			DetailedFPS.Begin(DetailedFPS.OperationCategory.Update);
			DoUpdate(ref gameTime);
			CinematicManager.Instance.Update(gameTime);
			ConsumeAllMainThreadActions();
			DetailedFPS.End();
			_isDrawingOrUpdating = false;
		}
		base.Update(gameTime);
		if (GameAskedToQuit)
		{
			QuitGame();
		}
	}

	public void UpdateViewZoomKeys()
	{
		if (!inFancyUI)
		{
			float num = 0.02f;
			if (PlayerInput.Triggers.Current.ViewZoomIn)
			{
				GameZoomTarget = Utils.Clamp(GameZoomTarget + num, 1f, 2f);
			}
			if (PlayerInput.Triggers.Current.ViewZoomOut)
			{
				GameZoomTarget = Utils.Clamp(GameZoomTarget - num, 1f, 2f);
			}
		}
	}

	public static void NotifyOfEvent(GameNotificationType type)
	{
		if (!dedServ && !instance.IsActive && (_flashNotificationType & type) != GameNotificationType.None)
		{
			QueueMainThreadAction(delegate
			{
				Platform.Get<IWindowService>().StartFlashingIcon(instance.Window);
			});
		}
	}

	protected void DoUpdate(ref GameTime gameTime)
	{
		gameTimeCache = gameTime;
		if (showSplash)
		{
			UpdateAudio();
			GlobalTimeWrappedHourly = (float)(gameTime.TotalGameTime.TotalSeconds % 3600.0);
			ChromaInitializer.UpdateEvents();
			Chroma.Update(GlobalTimeWrappedHourly);
			return;
		}
		PartySky.MultipleSkyWorkaroundFix = true;
		LocalPlayer.cursorItemIconReversed = false;
		if (!GlobalTimerPaused)
		{
			GlobalTimeWrappedHourly = (float)(gameTime.TotalGameTime.TotalSeconds % 3600.0);
		}
		UpdateCreativeGameModeOverride();
		UpdateWorldPreparationState();
		if (Player.BlockInteractionWithProjectiles > 0 && !mouseRight && mouseRightRelease)
		{
			Player.BlockInteractionWithProjectiles--;
		}
		PlayerInput.SetZoom_UI();
		for (int num = DelayedProcesses.Count - 1; num >= 0; num--)
		{
			IEnumerator enumerator = DelayedProcesses[num];
			if (!enumerator.MoveNext())
			{
				DelayedProcesses.Remove(enumerator);
			}
		}
		if (!gameMenu || menuMode != 888)
		{
			MenuUI.SetState(null);
		}
		if (gameMenu)
		{
			IngameUIWindows.CloseAll(quiet: true);
		}
		CurrentInputTextTakerOverride = null;
		if (!dedServ)
		{
			AchievementAdvisor.Update();
		}
		PlayerInput.SetZoom_Unscaled();
		PlayerInput.ResetInputsOnActiveStateChange();
		if (Main.OnTickForThirdPartySoftwareOnly != null)
		{
			Main.OnTickForThirdPartySoftwareOnly();
		}
		if (_hasPendingNetmodeChange)
		{
			netMode = _targetNetMode;
			_hasPendingNetmodeChange = false;
		}
		if (CaptureManager.Instance.IsCapturing)
		{
			return;
		}
		if (ActivePlayerFileData != null)
		{
			ActivePlayerFileData.UpdatePlayTimer();
		}
		Netplay.UpdateInMainThread();
		gameInactive = !base.IsActive;
		if (changeTheTitle)
		{
			changeTheTitle = false;
			SetTitle();
		}
		_worldUpdateTimeTester.Restart();
		if (!WorldGen.isGeneratingOrLoadingWorld)
		{
			WorldGen.destroyObject = false;
		}
		if (gameMenu)
		{
			mapFullscreen = false;
		}
		UpdateSettingUnlocks();
		if (DebugOptions.UpdateWaitInMs > 0.0)
		{
			ThreadUtilities.HighPrecisionSleep(DebugOptions.UpdateWaitInMs);
		}
		NPC.UpdateProtectedSpawnSlots();
		if (dedServ)
		{
			if (dedServFPS)
			{
				updatesCountedForFPS++;
				if (!fpsTimer.IsRunning)
				{
					fpsTimer.Restart();
				}
				if (fpsTimer.ElapsedMilliseconds >= 1000)
				{
					dedServCount1 += updatesCountedForFPS;
					dedServCount2++;
					float num2 = (float)dedServCount1 / (float)dedServCount2;
					Console.WriteLine(updatesCountedForFPS + "  (" + num2 + ")");
					updatesCountedForFPS = 0;
					fpsTimer.Restart();
				}
			}
			else
			{
				if (fpsTimer.IsRunning)
				{
					fpsTimer.Stop();
				}
				updatesCountedForFPS = 0;
			}
		}
		if (!WorldGen.generatingWorld)
		{
			DoUpdate_AutoSave();
		}
		if (!dedServ)
		{
			ChromaInitializer.UpdateEvents();
			Chroma.Update(GlobalTimeWrappedHourly);
			if (FrameSkipMode == FrameSkipMode.Off || FrameSkipMode == FrameSkipMode.Subtle)
			{
				base.IsFixedTimeStep = ThrottleWhenInactive && !base.IsActive;
				graphics.SynchronizeWithVerticalRetrace = true;
			}
			else
			{
				base.IsFixedTimeStep = true;
				graphics.SynchronizeWithVerticalRetrace = true;
			}
			base.InactiveSleepTime = (ThrottleWhenInactive ? TimeSpan.FromMilliseconds(20.0) : TimeSpan.Zero);
			if (showSplash)
			{
				return;
			}
			updatesCountedForFPS++;
			if (fpsTimer.ElapsedMilliseconds >= 1000)
			{
				if ((float)fpsCount >= 30f + 30f * gfxQuality)
				{
					gfxQuality += gfxRate;
					gfxRate += 0.005f;
				}
				else if ((float)fpsCount < 29f + 30f * gfxQuality)
				{
					gfxRate = 0.01f;
					gfxQuality -= 0.1f;
				}
				if (gfxQuality < 0f)
				{
					gfxQuality = 0f;
				}
				if (gfxQuality > 1f)
				{
					gfxQuality = 1f;
				}
				if (maxQ && base.IsActive)
				{
					gfxQuality = 1f;
					maxQ = false;
				}
				updateRate = uCount;
				frameRate = fpsCount;
				fpsCount = 0;
				fpsTimer.Restart();
				updatesCountedForFPS = 0;
				drawsCountedForFPS = 0;
				uCount = 0;
				if (gfxQuality < 0.8f)
				{
					mapTimeMax = (int)((1f - gfxQuality) * 60f);
				}
				else
				{
					mapTimeMax = 0;
				}
			}
			if (FrameSkipMode == FrameSkipMode.Off || (FrameSkipMode == FrameSkipMode.Subtle && !improvedSubtleFrameSkip))
			{
				UpdateTimeAccumulator += gameTime.ElapsedGameTime.TotalSeconds;
				if (UpdateTimeAccumulator < TARGET_FRAME_TIME)
				{
					if (FrameSkipMode == FrameSkipMode.Subtle || CaptureInterface.CameraLock)
					{
						instance.SuppressDraw();
					}
					return;
				}
				gameTime = new GameTime(gameTime.TotalGameTime, new TimeSpan((long)(TARGET_FRAME_TIME * 10000000.0)));
			}
			if (FrameSkipMode == FrameSkipMode.Off || FrameSkipMode == FrameSkipMode.Subtle)
			{
				UpdateTimeAccumulator -= TARGET_FRAME_TIME;
				UpdateTimeAccumulator = Utils.Clamp(UpdateTimeAccumulator, 0.0, 3.0 * TARGET_FRAME_TIME);
				int num3 = 0;
				if (UpdateTimeAccumulator > TARGET_FRAME_TIME && ++successiveSkippedDraws <= num3)
				{
					base.InactiveSleepTime = TimeSpan.Zero;
					instance.SuppressDraw();
				}
				else
				{
					successiveSkippedDraws = 0;
				}
			}
			uCount++;
			DebugLineDraw.PreUpdate();
			MouseOversClear();
			PlayerInput.AllowExecutionOfGamepadInstructions = true;
			TryPlayingCreditsRoll();
			PlayerInput.SetZoom_UI();
			UpdateUIStates(gameTime);
			PlayerInput.SetZoom_Unscaled();
			Terraria.Graphics.Effects.Filters.Scene.Update(gameTime);
			Overlays.Scene.Update(gameTime);
			LiquidRenderer.Instance.Update(gameTime);
			UpdateAudio();
			InGameNotificationsTracker.Update();
			ItemSlot.UpdateInterface();
			CraftingEffects.Update();
			if (teamCooldown > 0)
			{
				teamCooldown--;
			}
			DoUpdate_AnimateBackgrounds();
			Animation.UpdateAll();
			if (qaStyle == 1)
			{
				gfxQuality = 1f;
			}
			else if (qaStyle == 2)
			{
				gfxQuality = 0.5f;
			}
			else if (qaStyle == 3)
			{
				gfxQuality = 0f;
			}
			maxDustToDraw = (int)(6000f * (gfxQuality * 0.7f + 0.3f));
			if ((double)gfxQuality < 0.9)
			{
				maxDustToDraw = (int)((float)maxDustToDraw * gfxQuality);
			}
			if (maxDustToDraw < 1000)
			{
				maxDustToDraw = 1000;
			}
			Gore.goreTime = (int)(600f * gfxQuality);
			if (!WorldGen.isGeneratingOrLoadingWorld)
			{
				Liquid.cycles = (int)(17f - 10f * gfxQuality);
				Liquid.curMaxLiquid = (int)((double)Liquid.maxLiquid * 0.25 + (double)Liquid.maxLiquid * 0.75 * (double)gfxQuality);
				if (Setting_UseReducedMaxLiquids)
				{
					Liquid.curMaxLiquid = (int)(2500f + 2500f * gfxQuality);
				}
			}
			if ((double)gfxQuality < 0.2)
			{
				LegacyLighting.RenderPhases = 8;
			}
			else if ((double)gfxQuality < 0.4)
			{
				LegacyLighting.RenderPhases = 7;
			}
			else if ((double)gfxQuality < 0.6)
			{
				LegacyLighting.RenderPhases = 6;
			}
			else if ((double)gfxQuality < 0.8)
			{
				LegacyLighting.RenderPhases = 5;
			}
			else
			{
				LegacyLighting.RenderPhases = 4;
			}
			if (!WorldGen.isGeneratingOrLoadingWorld && Liquid.quickSettle)
			{
				Liquid.curMaxLiquid = Liquid.maxLiquid;
				if (Setting_UseReducedMaxLiquids)
				{
					Liquid.curMaxLiquid = 5000;
				}
				Liquid.cycles = 1;
			}
			if (!gameMenu || Math.Abs(logoRotationSpeed) > 1000f)
			{
				logoRotation = 0f;
				logoRotationSpeed = 0f;
				logoScale = 1f;
			}
			UpdateOldNPCShop();
			if (reforgeCooldown > 0)
			{
				reforgeCooldown--;
			}
			hasFocus = base.IsActive || DebugOptions.noPause;
			if (Platform.IsWindows)
			{
				Form form = Control.FromHandle(base.Window.Handle) as Form;
				bool num4 = form.WindowState == FormWindowState.Minimized;
				bool flag = Form.ActiveForm == form;
				hasFocus |= flag;
				if (num4)
				{
					hasFocus = false;
				}
			}
			if (!DebugOptions.noPause)
			{
				if (!hasFocus && netMode == 0)
				{
					if (!Platform.IsOSX)
					{
						base.IsMouseVisible = true;
					}
					if (netMode != 2 && myPlayer >= 0)
					{
						player[myPlayer].delayUseItem = true;
					}
					mouseLeftRelease = false;
					mouseRightRelease = false;
					if (gameMenu)
					{
						UpdateMenu();
					}
					gamePaused = true;
					return;
				}
				if (!Platform.IsOSX)
				{
					base.IsMouseVisible = false;
				}
				if (Platform.IsWindows && ReHideCursor)
				{
					base.IsMouseVisible = false;
					ReHideCursor = false;
					IMouseNotifier val = Platform.Get<IMouseNotifier>();
					if (val != null)
					{
						val.ForceCursorHidden();
					}
				}
			}
			SkyManager.Instance.Update(gameTime);
			if (!gamePaused)
			{
				EmoteBubble.UpdateAll();
			}
			DoUpdate_AnimateCursorColors();
			DoUpdate_AnimateTileGlows();
			DoUpdate_AnimateDiscoRGB();
			DoUpdate_AnimateVisualPlayerAura();
			DoUpdate_AnimateWaterfalls();
			DoUpdate_AnimateWalls();
			AnimateTiles();
			DoUpdate_AnimateItemIcons();
			DoUpdate_F10_ToggleFPS();
			DoUpdate_F9_ToggleLighting();
			DoUpdate_F8_ToggleNetDiagnostics();
			DoUpdate_F7_ToggleGraphicsDiagnostics();
			DoUpdate_F11_ToggleUI();
			DoUpdate_AltEnter_ToggleFullscreen();
			DoDebugFunctions();
			DoUpdate_HandleInput();
			DoUpdate_HandleChat();
			DoUpdate_Enter_ToggleChat();
			if ((timeForVisualEffects += 1.0) >= 216000.0)
			{
				timeForVisualEffects = 0.0;
			}
			if (gameMenu)
			{
				UpdateMenu();
				if (netMode != 2)
				{
					return;
				}
				gamePaused = false;
			}
			UpdateParticleSystems_UI();
			EverLastingTicker++;
			if (!CanUpdateGameplay && netMode != 2)
			{
				return;
			}
			CheckInvasionProgressDisplay();
		}
		UpdateWindyDayState();
		if (netMode == 2)
		{
			cloudAlpha = maxRaining;
		}
		bool flag2 = base.IsActive || DebugOptions.noPause;
		if (netMode == 1)
		{
			TrySyncingMyPlayer();
		}
		if (CanPauseGame())
		{
			DoUpdate_WhilePaused();
			gamePaused = true;
			return;
		}
		gamePaused = false;
		if (Main.OnTickForInternalCodeOnly != null)
		{
			Main.OnTickForInternalCodeOnly();
		}
		for (int num5 = DelayedProcessesInGame.Count - 1; num5 >= 0; num5--)
		{
			IEnumerator enumerator2 = DelayedProcessesInGame[num5];
			if (!enumerator2.MoveNext())
			{
				DelayedProcessesInGame.Remove(enumerator2);
			}
		}
		if ((dedServ || (netMode != 1 && !gameMenu && !gamePaused)) && AmbienceServer != null)
		{
			AmbienceServer.Update();
		}
		WorldGen.BackgroundsCache.UpdateFlashValues();
		LocalGolfState.Update();
		if ((flag2 || netMode == 1) && cloudAlpha > 0f)
		{
			Rain.MakeRain();
		}
		if (netMode != 1)
		{
			updateCloudLayer();
		}
		for (int i = 0; i < dayRate; i++)
		{
			UpdateWeather(gameTime, i);
		}
		UnpausedUpdateSeed = Utils.RandomNextSeed(UnpausedUpdateSeed);
		Ambience();
		if (netMode != 2)
		{
			try
			{
				snowing();
			}
			catch
			{
				if (!ignoreErrors)
				{
					throw;
				}
			}
			Sandstorm.EmitDust();
		}
		if (netMode != 2)
		{
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				Star.UpdateStars();
				Cloud.UpdateClouds();
			}
			else if (shimmerAlpha > 0f)
			{
				Star.UpdateStars();
				int num6 = rand.Next(numStars);
				if (rand.Next(90) == 0)
				{
					if (star[num6] != null && !star[num6].hidden && !star[num6].falling)
					{
						star[num6].Fall();
					}
					for (int j = 0; j < numStars; j++)
					{
						if (star[j].hidden)
						{
							Star.SpawnStars(j);
						}
					}
				}
			}
		}
		PortalHelper.UpdatePortalPoints();
		LucyAxeMessage.UpdateMessageCooldowns();
		if (ShouldUpdateEntities())
		{
			DoUpdateInWorld(_worldUpdateTimeTester);
		}
		if (netMode != 2)
		{
			ChromaPainter.Update();
		}
		if (Main.OnTickForThirdPartySoftwareOnly != null)
		{
			Main.OnTickForThirdPartySoftwareOnly();
		}
	}

	internal static void UpdateCreativeGameModeOverride()
	{
		_gameModeDifficultyOverride = null;
		if (!gameMenu && IsJourneyMode)
		{
			CreativePowers.DifficultySliderPower power = CreativePowerManager.Instance.GetPower<CreativePowers.DifficultySliderPower>();
			if (power.GetIsUnlocked())
			{
				_gameModeDifficultyOverride = power.StrengthMultiplierToGiveNPCs;
			}
		}
	}

	private static void TryPlayingCreditsRoll()
	{
		if (!gameMenu && CanPlayCreditsRoll() && !SkyManager.Instance["CreditsRoll"].IsActive())
		{
			SkyManager.Instance.Activate("CreditsRoll", Vector2.Zero);
		}
	}

	private static bool CanPauseGame()
	{
		bool flag = false;
		if (netMode == 0)
		{
			flag |= ingameOptionsWindow;
			flag |= InGameUI.IsVisible && (InGameUI.CurrentState == ManageControlsMenu || InGameUI.CurrentState == AchievementsMenu);
			if (autoPause)
			{
				flag |= playerInventory;
				flag |= LocalPlayer.sign >= 0;
				flag |= InGameUI.IsVisible;
			}
		}
		return flag;
	}

	private static void DoUpdate_WhilePaused()
	{
		if (WorldGen.generatingWorld)
		{
			return;
		}
		if (!drawingPlayerChat && !editSign && !editChest && !blockInput)
		{
			Main.player[myPlayer].controlInv = PlayerInput.Triggers.Current.Inventory;
			Main.player[myPlayer].controlCreativeMenu = PlayerInput.Triggers.Current.OpenCreativePowersMenu;
			Player player = Main.player[myPlayer];
			if (player.controlCreativeMenu)
			{
				if (player.releaseCreativeMenu)
				{
					player.ToggleCreativeMenu();
				}
				player.releaseCreativeMenu = false;
			}
			else
			{
				player.releaseCreativeMenu = true;
			}
			if (player.controlInv)
			{
				if (player.releaseInventory)
				{
					player.ToggleInv();
				}
				player.releaseInventory = false;
			}
			else
			{
				player.releaseInventory = true;
			}
		}
		if (playerInventory)
		{
			Main.player[myPlayer].RefreshInfoAccs();
			DoScrollingInInventory();
			Main.player[myPlayer].dropItemCheck();
		}
		Main.player[myPlayer].head = Main.player[myPlayer].armor[0].headSlot;
		Main.player[myPlayer].body = Main.player[myPlayer].armor[1].bodySlot;
		Main.player[myPlayer].legs = Main.player[myPlayer].armor[2].legSlot;
		if (!Main.player[myPlayer].hostile)
		{
			if (Main.player[myPlayer].armor[10].headSlot >= 0)
			{
				Main.player[myPlayer].head = Main.player[myPlayer].armor[10].headSlot;
			}
			if (Main.player[myPlayer].armor[11].bodySlot >= 0)
			{
				Main.player[myPlayer].body = Main.player[myPlayer].armor[11].bodySlot;
			}
			if (Main.player[myPlayer].armor[12].legSlot >= 0)
			{
				Main.player[myPlayer].legs = Main.player[myPlayer].armor[12].legSlot;
			}
		}
		if (editSign)
		{
			if (Main.player[myPlayer].sign == -1)
			{
				editSign = false;
			}
			else
			{
				InputTextSign();
			}
		}
		else if (editChest && Main.player[myPlayer].chest == -1)
		{
			editChest = false;
		}
		Player.tileTargetX = (int)(((float)mouseX + screenPosition.X) / 16f);
		Player.tileTargetY = (int)(((float)mouseY + screenPosition.Y) / 16f);
		Main.player[myPlayer].LookForTileInteractions();
		Main.player[myPlayer].ChestChangeEvents();
		Main.player[myPlayer].UpdateNearbyCraftingTiles();
	}

	public static void DoScrollingInInventory()
	{
		int num = PlayerInput.ScrollWheelDelta / 120;
		bool flag = true;
		if (PipsUseGrid)
		{
			int num2 = 42;
			int num3 = 340;
			int num4 = 310;
			PlayerInput.SetZoom_UI();
			int num5 = (screenWidth - num4 - 280) / num2;
			int num6 = (screenHeight - num3 - 20) / num2;
			if (new Microsoft.Xna.Framework.Rectangle(num4, num3, num5 * num2, num6 * num2).Contains(MouseScreen.ToPoint()))
			{
				int num7 = Math.Sign(num);
				while (num != 0)
				{
					ScrollCraftingGrid(num, num5);
					num -= num7;
				}
			}
			PlayerInput.SetZoom_World();
		}
		if (LocalPlayer.chest != -1 && ChestUI.LastHighestChestRow > 0)
		{
			int num8 = 42;
			int num9 = 340;
			int num10 = 310;
			PlayerInput.SetZoom_UI();
			_ = (screenWidth - num10 - 280) / num8;
			_ = (screenHeight - num9 - 20) / num8;
			Microsoft.Xna.Framework.Rectangle lastChestDisplayRectangle = ChestUI.LastChestDisplayRectangle;
			if (lastChestDisplayRectangle.Contains(MouseScreen.ToPoint()))
			{
				flag = false;
				int num11 = Math.Sign(num);
				while (num != 0)
				{
					ChestUI.Scroll(num);
					num -= num11;
				}
			}
			PlayerInput.SetZoom_World();
		}
		if (NewCraftingUI.Visible)
		{
			flag = false;
		}
		if (flag)
		{
			ScrollCraftingList(num);
		}
	}

	private static void ScrollCraftingList(int mouseWheel)
	{
		if (InPipCrafting)
		{
			craftingUI.ScrollCraftingList(mouseWheel);
		}
		if (InPipBanner)
		{
			bannerUI.ScrollCraftingList(mouseWheel);
		}
	}

	private static void ScrollCraftingGrid(int mouseWheel, int width)
	{
		if (InPipCrafting)
		{
			craftingUI.ScrollCraftingGrid(mouseWheel, width);
		}
		if (InPipBanner)
		{
			bannerUI.ScrollCraftingGrid(mouseWheel, width);
		}
	}

	private static void UpdateUIStates(GameTime gameTime)
	{
		if (MenuUI != null)
		{
			MenuUI.Update(gameTime);
		}
		if (InGameUI != null)
		{
			InGameUI.Update(gameTime);
		}
		CreativeMenu.Update(gameTime);
		NewCraftingUI.UpdateUI(gameTime);
		BigBossProgressBar.Update();
	}

	private void DoDebugFunctions()
	{
		if (!DebugOptions.enableDebugCommands)
		{
			return;
		}
		for (int i = 0; i < 10; i++)
		{
			Microsoft.Xna.Framework.Input.Keys key = (Microsoft.Xna.Framework.Input.Keys)(96 + i);
			if (keyState.IsKeyDown(key) && !oldKeyState.IsKeyDown(key))
			{
				DebugUtils.QuickSPMessage("/numpad" + i);
			}
		}
	}

	public void ToggleHorizonRenderer()
	{
		if (HorizonRenderer is NextHorizonRenderer)
		{
			HorizonRenderer = new EmptyHorizonRenderer();
		}
		else
		{
			HorizonRenderer = new NextHorizonRenderer();
		}
	}

	private void PreUpdateAllProjectiles()
	{
		SpelunkerProjectileHelper.OnPreUpdateAllProjectiles();
		ChumBucketProjectileHelper.OnPreUpdateAllProjectiles();
	}

	private void PostUpdateAllProjectiles()
	{
	}

	private static void TrySyncingMyPlayer()
	{
		Player player = clientPlayer;
		bool syncedAnyInventoryContents = false;
		for (int i = 0; i < 59; i++)
		{
			if (Main.player[myPlayer].inventory[i].IsNetStateDifferent(player.inventory[i]))
			{
				syncedAnyInventoryContents = true;
				NetMessage.SendData(5, -1, -1, null, myPlayer, PlayerItemSlotID.Inventory0 + i);
			}
		}
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].armor, player.armor, PlayerItemSlotID.Armor0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].dye, player.dye, PlayerItemSlotID.Dye0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].miscEquips, player.miscEquips, PlayerItemSlotID.Misc0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].miscDyes, player.miscDyes, PlayerItemSlotID.MiscDye0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].bank.item, player.bank.item, PlayerItemSlotID.Bank1_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].bank2.item, player.bank2.item, PlayerItemSlotID.Bank2_0);
		if (Main.player[myPlayer].trashItem.IsNetStateDifferent(player.trashItem))
		{
			syncedAnyInventoryContents = true;
			NetMessage.SendData(5, -1, -1, null, myPlayer, PlayerItemSlotID.TrashItem);
		}
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].bank3.item, player.bank3.item, PlayerItemSlotID.Bank3_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].bank4.item, player.bank4.item, PlayerItemSlotID.Bank4_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].Loadouts[0].Armor, player.Loadouts[0].Armor, PlayerItemSlotID.Loadout1_Armor_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].Loadouts[0].Dye, player.Loadouts[0].Dye, PlayerItemSlotID.Loadout1_Dye_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].Loadouts[1].Armor, player.Loadouts[1].Armor, PlayerItemSlotID.Loadout2_Armor_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].Loadouts[1].Dye, player.Loadouts[1].Dye, PlayerItemSlotID.Loadout2_Dye_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].Loadouts[2].Armor, player.Loadouts[2].Armor, PlayerItemSlotID.Loadout3_Armor_0);
		TrySyncingItemArray(ref syncedAnyInventoryContents, Main.player[myPlayer].Loadouts[2].Dye, player.Loadouts[2].Dye, PlayerItemSlotID.Loadout3_Dye_0);
		if (Main.player[myPlayer].chest != player.chest && Main.player[myPlayer].chest < 0 && player.chest >= 0)
		{
			if (Main.player[myPlayer].editedChestName)
			{
				if (chest[player.chest] != null)
				{
					NetMessage.SendData(33, -1, -1, NetworkText.FromLiteral(chest[player.chest].name), Main.player[myPlayer].chest, 1f);
				}
				else
				{
					NetMessage.SendData(33, -1, -1, null, Main.player[myPlayer].chest);
				}
				Main.player[myPlayer].editedChestName = false;
			}
			else
			{
				NetMessage.SendData(33, -1, -1, null, Main.player[myPlayer].chest);
			}
		}
		if (Main.player[myPlayer].talkNPC != player.talkNPC)
		{
			NetMessage.SendData(40, -1, -1, null, myPlayer);
		}
		if ((0u | ((Main.player[myPlayer].voidLensChest != player.voidLensChest) ? 1u : 0u) | ((Main.player[myPlayer].piggyBankProjTracker != player.piggyBankProjTracker) ? 1u : 0u)) != 0)
		{
			NetMessage.SendData(142, -1, -1, null, myPlayer);
		}
		if (LocalPlayer.tileEntityAnchor.interactEntityID != player.tileEntityAnchor.interactEntityID && LocalPlayer.tileEntityAnchor.interactEntityID < 0)
		{
			NetMessage.SendData(122, -1, -1, null, -1, myPlayer);
		}
		bool flag = false;
		if ((byte)Main.player[myPlayer].zone1 != (byte)player.zone1)
		{
			flag = true;
		}
		if ((byte)Main.player[myPlayer].zone2 != (byte)player.zone2)
		{
			flag = true;
		}
		if ((byte)Main.player[myPlayer].zone3 != (byte)player.zone3)
		{
			flag = true;
		}
		if ((byte)Main.player[myPlayer].zone4 != (byte)player.zone4)
		{
			flag = true;
		}
		if ((byte)Main.player[myPlayer].zone5 != (byte)player.zone5)
		{
			flag = true;
		}
		if (Main.player[myPlayer].townNPCs != player.townNPCs)
		{
			flag = true;
		}
		if (flag)
		{
			NetMessage.SendData(36, -1, -1, null, myPlayer);
		}
		if (Main.player[myPlayer].statLife != player.statLife || Main.player[myPlayer].statLifeMax != player.statLifeMax)
		{
			Main.player[myPlayer].netLife = true;
		}
		if (Main.player[myPlayer].netLifeTime > 0)
		{
			Main.player[myPlayer].netLifeTime--;
		}
		else if (Main.player[myPlayer].netLife)
		{
			Main.player[myPlayer].netLife = false;
			Main.player[myPlayer].netLifeTime = 60;
			NetMessage.SendData(16, -1, -1, null, myPlayer);
		}
		if (Main.player[myPlayer].statMana != player.statMana || Main.player[myPlayer].statManaMax != player.statManaMax)
		{
			Main.player[myPlayer].netMana = true;
		}
		if (Main.player[myPlayer].netManaTime > 0)
		{
			Main.player[myPlayer].netManaTime--;
		}
		else if (Main.player[myPlayer].netMana)
		{
			Main.player[myPlayer].netMana = false;
			Main.player[myPlayer].netManaTime = 60;
			NetMessage.SendData(42, -1, -1, null, myPlayer);
		}
		bool flag2 = false;
		for (int j = 0; j < Player.maxBuffs; j++)
		{
			if (Main.player[myPlayer].buffType[j] != player.buffType[j])
			{
				flag2 = true;
				break;
			}
		}
		if (flag2)
		{
			NetMessage.SendData(50, -1, -1, null, myPlayer);
			NetMessage.SendData(13, -1, -1, null, myPlayer);
		}
		bool flag3 = false;
		if (Main.player[myPlayer].MinionRestTargetPoint != player.MinionRestTargetPoint)
		{
			flag3 = true;
		}
		if (flag3)
		{
			NetMessage.SendData(99, -1, -1, null, myPlayer);
		}
		bool flag4 = false;
		if (Main.player[myPlayer].MinionAttackTargetNPC != player.MinionAttackTargetNPC)
		{
			flag4 = true;
		}
		if (flag4)
		{
			NetMessage.SendData(115, -1, -1, null, myPlayer);
		}
		if (player.shieldRaised != Main.player[myPlayer].shieldRaised)
		{
			NetMessage.SendData(13, -1, -1, null, myPlayer);
		}
		if (syncedAnyInventoryContents)
		{
			NetMessage.SendData(138);
		}
		Main.player[myPlayer].clientClone(clientPlayer);
	}

	private static void TrySyncingItemArray(ref bool syncedAnyInventoryContents, Item[] my, Item[] other, int slotOffset)
	{
		for (int i = 0; i < my.Length; i++)
		{
			if (my[i].IsNetStateDifferent(other[i]))
			{
				syncedAnyInventoryContents = true;
				NetMessage.SendData(5, -1, -1, null, myPlayer, slotOffset + i);
			}
		}
	}

	public bool ShouldUpdateEntities()
	{
		if (_worldPreparationState == WorldPreparationState.Ready)
		{
			return !WorldGen.generatingWorld;
		}
		return false;
	}

	private void DoUpdateInWorld(Stopwatch sw)
	{
		DebugLineDraw.PreWorldUpdate();
		UpdateParticleSystems_World();
		tileSolid[379] = false;
		int num = 0;
		int num2 = 0;
		sittingManager.ClearPlayerAnchors();
		sleepingManager.ClearPlayerAnchors();
		for (int i = 0; i < 255; i++)
		{
			if (!player[i].active)
			{
				continue;
			}
			try
			{
				player[i].Update(i);
				if (player[i].active && !player[i].ghost)
				{
					num++;
					if (player[i].sleeping.FullyFallenAsleep)
					{
						num2++;
					}
				}
			}
			catch
			{
				if (!ignoreErrors)
				{
					throw;
				}
			}
		}
		CurrentFrameFlags.ActivePlayersCount = num;
		CurrentFrameFlags.SleepingPlayersCount = num2;
		if (netMode != 2)
		{
			int num3 = myPlayer;
			if (player[num3].creativeGodMode)
			{
				player[num3].statLife = player[num3].statLifeMax2;
				player[num3].statMana = player[num3].statManaMax2;
				player[num3].breath = player[num3].breathMax;
			}
		}
		_gameUpdateCount++;
		NPC.RevengeManager.Update();
		if (netMode != 1)
		{
			try
			{
				NPC.SpawnNPC();
			}
			catch
			{
			}
		}
		if (netMode != 1)
		{
			PressurePlateHelper.Update();
		}
		for (int j = 0; j < 255; j++)
		{
			player[j].nearbyActiveNPCs = 0f;
		}
		CheckBossIndexes();
		sittingManager.ClearNPCAnchors();
		sleepingManager.ClearNPCAnchors();
		NPC.taxCollector = false;
		NPC.ClearFoundActiveNPCs();
		NPC.UpdateFoundActiveNPCs();
		FixExploitManEaters.Update();
		if (netMode != 1)
		{
			BestiaryTracker.Sights.ScanWorldForFinds();
		}
		NPCDamageTracker.Update();
		bool anyActiveBossNPC = false;
		if (NPC.offSetDelayTime > 0)
		{
			NPC.offSetDelayTime--;
		}
		if (remixWorld && NPC.empressRageMode && !NPC.AnyNPCs(636))
		{
			NPC.empressRageMode = false;
		}
		if (netMode != 1 && afterPartyOfDoom && !BirthdayParty.PartyIsUp)
		{
			for (int k = 0; k < maxNPCs; k++)
			{
				NPC nPC = npc[k];
				if (nPC.active && nPC.townNPC && nPC.type != 37 && nPC.type != 453 && nPC.type != 368 && nPC.type != 680 && nPC.type != 20)
				{
					nPC.StrikeNPCNoInteraction(9999, 10f, -nPC.direction);
					if (netMode == 2)
					{
						NetMessage.SendData(28, -1, -1, null, k, 9999f, 10f, -nPC.direction);
					}
				}
			}
			NPC.savedMech = false;
			NPC.unlockedPartyGirlSpawn = false;
			NPC.unlockedPrincessSpawn = false;
			NPC.unlockedSlimeRainbowSpawn = false;
			NPC.unlockedSlimeGreenSpawn = false;
			NPC.boughtBunny = false;
			afterPartyOfDoom = false;
		}
		if (NPC.brainOfGravity >= 0 && NPC.brainOfGravity < maxNPCs && (!npc[NPC.brainOfGravity].active || npc[NPC.brainOfGravity].type != 266))
		{
			NPC.brainOfGravity = -1;
		}
		for (int l = 0; l < maxNPCs; l++)
		{
			if (ignoreErrors)
			{
				try
				{
					npc[l].UpdateNPC(l);
					if (npc[l].active && (npc[l].boss || NPCID.Sets.DangerThatPreventsOtherDangers[npc[l].type]))
					{
						anyActiveBossNPC = true;
					}
				}
				catch (Exception)
				{
					npc[l] = new NPC();
				}
			}
			else
			{
				npc[l].UpdateNPC(l);
			}
		}
		CurrentFrameFlags.AnyActiveBossNPC = anyActiveBossNPC;
		if (netMode != 2)
		{
			for (int m = 0; m < 600; m++)
			{
				if (ignoreErrors)
				{
					try
					{
						gore[m].Update();
					}
					catch
					{
						gore[m] = new Gore();
					}
				}
				else
				{
					gore[m].Update();
				}
			}
		}
		LockOnHelper.SetUP();
		CurrentFrameFlags.HadAnActiveInteractibleProjectile = false;
		PreUpdateAllProjectiles();
		for (int n = 0; n < 1000; n++)
		{
			ProjectileUpdateLoopIndex = n;
			if (ignoreErrors)
			{
				try
				{
					projectile[n].Update(n);
				}
				catch
				{
					projectile[n] = new Projectile();
				}
			}
			else
			{
				projectile[n].Update(n);
			}
		}
		ProjectileUpdateLoopIndex = -1;
		PostUpdateAllProjectiles();
		LockOnHelper.SetDOWN();
		for (int num4 = 0; num4 < 400; num4++)
		{
			if (ignoreErrors)
			{
				try
				{
					item[num4].UpdateItem(num4);
				}
				catch
				{
					item[num4] = new WorldItem();
					item[num4].whoAmI = num4;
				}
			}
			else
			{
				item[num4].UpdateItem(num4);
			}
		}
		if (netMode != 2)
		{
			if (ignoreErrors)
			{
				try
				{
					Dust.UpdateDust();
				}
				catch
				{
					for (int num5 = 0; num5 < 6000; num5++)
					{
						dust[num5] = new Dust();
						dust[num5].dustIndex = num5;
					}
				}
			}
			else
			{
				Dust.UpdateDust();
			}
		}
		LeashedEntity.UpdateEntities();
		if (netMode != 2)
		{
			CombatText.UpdateCombatText();
			PopupText.UpdateItemText();
		}
		if (ignoreErrors)
		{
			try
			{
				UpdateTime();
			}
			catch
			{
				checkForSpawns = 0;
			}
		}
		else
		{
			UpdateTime();
		}
		tileSolid[379] = true;
		if (gameMenu && netMode != 2)
		{
			return;
		}
		if (netMode != 1)
		{
			if (ignoreErrors)
			{
				try
				{
					WorldGen.UpdateWorld();
					UpdateInvasion();
				}
				catch
				{
				}
			}
			else
			{
				WorldGen.UpdateWorld();
				UpdateInvasion();
			}
		}
		if (ignoreErrors)
		{
			try
			{
				if (netMode == 2)
				{
					UpdateServer();
				}
				if (netMode == 1)
				{
					UpdateClient();
				}
			}
			catch
			{
				_ = netMode;
				_ = 2;
			}
		}
		else
		{
			if (netMode == 2)
			{
				UpdateServer();
			}
			if (netMode == 1)
			{
				UpdateClient();
			}
		}
		chatMonitor.Update();
		upTimer = (float)sw.Elapsed.TotalMilliseconds;
		if (upTimerMaxDelay > 0f)
		{
			upTimerMaxDelay -= 1f;
		}
		else
		{
			upTimerMax = 0f;
		}
		if (upTimer > upTimerMax)
		{
			upTimerMax = upTimer;
			upTimerMaxDelay = 400f;
		}
		Chest.UpdateChestFrames();
		_ambientWindSys.Update();
		TilesRenderer.Update();
		WallsRenderer.Update();
		UpdateCameraPan();
		if (cameraLerp > 0f)
		{
			cameraLerpTimer++;
			if (cameraLerpTimer >= cameraLerpTimeToggle)
			{
				cameraLerp += (float)((cameraLerpTimer - cameraLerpTimeToggle) / 3 + 1) * 0.001f;
			}
			if (cameraLerp > 1f)
			{
				cameraLerp = 1f;
			}
		}
		SceneState.Update(SceneMetrics);
		if (netMode == 1)
		{
			Ping.Update();
		}
	}

	private static void CheckBossIndexes()
	{
		if (!IsNPCActiveAndOneOfTypes(wofNPCIndex, 113))
		{
			wofNPCIndex = -1;
		}
		if (!IsNPCActiveAndOneOfTypes(NPC.golemBoss, 245))
		{
			NPC.golemBoss = -1;
		}
		if (!IsNPCActiveAndOneOfTypes(NPC.deerclopsBoss, 668))
		{
			NPC.deerclopsBoss = -1;
		}
		if (!IsNPCActiveAndOneOfTypes(NPC.plantBoss, 262))
		{
			NPC.plantBoss = -1;
		}
		if (!IsNPCActiveAndOneOfTypes(NPC.crimsonBoss, 266))
		{
			NPC.crimsonBoss = -1;
		}
	}

	public static bool IsNPCActiveAndOneOfTypes(int npcIndex, params int[] types)
	{
		if (npcIndex < 0)
		{
			return false;
		}
		NPC nPC = npc[npcIndex];
		if (!nPC.active)
		{
			return false;
		}
		for (int i = 0; i < types.Length; i++)
		{
			if (nPC.type == types[i])
			{
				return true;
			}
		}
		return false;
	}

	private static void UpdateOldNPCShop()
	{
		if (npcShop != oldNPCShop)
		{
			oldNPCShop = npcShop;
			shopSellbackHelper.Clear();
		}
	}

	private static void DoUpdate_AnimateCursorColors()
	{
		CursorColor();
		mouseTextColor += (byte)mouseTextColorChange;
		if (mouseTextColor >= byte.MaxValue)
		{
			mouseTextColorChange = -1;
		}
		if (mouseTextColor <= 190)
		{
			mouseTextColorChange = 1;
		}
		masterColor += (float)masterColorDir * 0.05f;
		if (masterColor > 1f)
		{
			masterColor = 1f;
			masterColorDir = -1;
		}
		if (masterColor < 0f)
		{
			masterColor = 0f;
			masterColorDir = 1;
		}
	}

	private static void DoUpdate_AnimateTileGlows()
	{
		demonTorch += (float)demonTorchDir * 0.01f;
		if (demonTorch > 1f)
		{
			demonTorch = 1f;
			demonTorchDir = -1;
		}
		if (demonTorch < 0f)
		{
			demonTorch = 0f;
			demonTorchDir = 1;
		}
		martianLight += (float)martianLightDir * 0.015f;
		if (martianLight > 1f)
		{
			martianLight = 1f;
			martianLightDir = -1;
		}
		if (martianLight < 0f)
		{
			martianLight = 0f;
			martianLightDir = 1;
		}
	}

	private static void DoUpdate_Enter_ToggleChat()
	{
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Enter) && !keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftAlt) && !keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.RightAlt) && hasFocus)
		{
			if (chatRelease && !drawingPlayerChat && !editSign && !editChest && (!gameMenu || menuChat) && !keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Escape))
			{
				SoundEngine.PlaySound(10);
				OpenPlayerChat();
				chatText = "";
			}
			chatRelease = false;
		}
		else
		{
			chatRelease = true;
		}
	}

	public static void OpenPlayerChat()
	{
		if (CurrentInputTextTakerOverride == null)
		{
			drawingPlayerChat = true;
			clrInput();
		}
	}

	public static void ClosePlayerChat()
	{
		drawingPlayerChat = false;
		PlayerInput.WritingText = false;
		player[myPlayer].releaseHook = false;
		player[myPlayer].releaseThrow = false;
	}

	private static void DoUpdate_HandleChat()
	{
		if (CurrentInputTextTakerOverride != null)
		{
			drawingPlayerChat = false;
			return;
		}
		if (editSign)
		{
			drawingPlayerChat = false;
		}
		if (PlayerInput.UsingGamepad)
		{
			drawingPlayerChat = false;
		}
		if (!drawingPlayerChat)
		{
			chatMonitor.ResetOffset();
			return;
		}
		if (!imeCompositionActive)
		{
			int linesOffset = 0;
			if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Up))
			{
				linesOffset = 1;
			}
			else if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Down))
			{
				linesOffset = -1;
			}
			chatMonitor.Offset(linesOffset);
		}
		if (inputTextEscape && !imeCompositionActive)
		{
			drawingPlayerChat = false;
		}
		string text = chatText;
		chatText = GetInputText(chatText);
		if (text != chatText)
		{
			int num = ChatLineWidthLimit - 10;
			for (float x = ChatManager.GetStringSize(FontAssets.MouseText.Value, chatText, Vector2.One).X; x > (float)num; x = ChatManager.GetStringSize(FontAssets.MouseText.Value, chatText, Vector2.One).X)
			{
				int num2 = Math.Max(0, (int)(x - (float)num) / 100);
				chatText = Utils.TrimUserString(chatText, chatText.Length - 1 - num2);
			}
		}
		if (text != chatText)
		{
			SoundEngine.PlaySound(12);
		}
		if (!inputTextEnter || !chatRelease)
		{
			return;
		}
		if (chatText != "" && !ChatManager.DebugCommands.Process((byte)myPlayer, chatText))
		{
			ChatMessage message = ChatManager.Commands.CreateOutgoingMessage(chatText);
			if (netMode == 1)
			{
				ChatHelper.SendChatMessageFromClient(message);
			}
			else if (netMode == 0)
			{
				ChatManager.Commands.ProcessIncomingMessage(message, myPlayer);
			}
		}
		chatText = "";
		ClosePlayerChat();
		chatRelease = false;
		SoundEngine.PlaySound(11);
	}

	private void DoUpdate_HandleInput()
	{
		PlayerInput.UpdateInput();
		UpdateViewZoomKeys();
		PlayerInput.SetZoom_Unscaled();
		UILinkPointNavigator.Update();
		PlayerInput.CacheMousePositionForZoom();
		PlayerInput.SetZoom_MouseInWorld();
		oldKeyState = keyState;
		keyState = Keyboard.GetState();
	}

	private static void DoUpdate_AltEnter_ToggleFullscreen()
	{
		if ((keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftAlt) || keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.RightAlt)) && keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Enter) && hasFocus)
		{
			if (toggleFullscreen)
			{
				ToggleFullScreen();
				chatRelease = false;
			}
			toggleFullscreen = false;
		}
		else
		{
			toggleFullscreen = true;
		}
	}

	private static void DoUpdate_F11_ToggleUI()
	{
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.F11))
		{
			if (releaseUI)
			{
				if (hideUI)
				{
					hideUI = false;
				}
				else
				{
					hideUI = true;
				}
				SoundEngine.PlaySound(12);
			}
			releaseUI = false;
		}
		else
		{
			releaseUI = true;
		}
	}

	private static void DoUpdate_F7_ToggleGraphicsDiagnostics()
	{
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.F7) && !drawingPlayerChat && !editSign && !editChest)
		{
			if (drawRelease)
			{
				SoundEngine.PlaySound(12);
				if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftAlt) || keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.RightAlt))
				{
					TimeLogger.ToggleLogging();
				}
				else
				{
					drawDiag = (drawDiag + 1) % 3;
					if (drawDiag > 0)
					{
						shouldDrawNetDiagnosticsUI = false;
					}
				}
			}
			drawRelease = false;
		}
		else
		{
			drawRelease = true;
		}
	}

	private static void DoUpdate_F8_ToggleNetDiagnostics()
	{
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.F8) && !drawingPlayerChat && !editSign && !editChest)
		{
			if (netRelease)
			{
				SoundEngine.PlaySound(12);
				shouldDrawNetDiagnosticsUI = !shouldDrawNetDiagnosticsUI;
				if (shouldDrawNetDiagnosticsUI)
				{
					drawDiag = 0;
				}
			}
			netRelease = false;
		}
		else
		{
			netRelease = true;
		}
	}

	private static void DoUpdate_F9_ToggleLighting()
	{
		if (keyState.PressingShift() && keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.F9) && !drawingPlayerChat && !editSign && !editChest)
		{
			if (RGBRelease)
			{
				SoundEngine.PlaySound(12);
				Lighting.NextLightMode();
			}
			RGBRelease = false;
		}
		else
		{
			RGBRelease = true;
		}
	}

	private static void DoUpdate_F10_ToggleFPS()
	{
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.F10) && !drawingPlayerChat && !editSign && !editChest)
		{
			if (frameRelease)
			{
				SoundEngine.PlaySound(12);
				if (showFrameRate)
				{
					showFrameRate = false;
				}
				else
				{
					showFrameRate = true;
				}
			}
			frameRelease = false;
		}
		else
		{
			frameRelease = true;
		}
	}

	private static void AnimateTiles()
	{
		tileFrameCounter[12]++;
		if (tileFrameCounter[12] > 5)
		{
			tileFrameCounter[12] = 0;
			tileFrame[12]++;
			if (tileFrame[12] >= 10)
			{
				tileFrame[12] = 0;
			}
		}
		tileFrameCounter[665] = tileFrameCounter[12];
		tileFrame[665] = tileFrame[12];
		tileFrameCounter[639]++;
		if (tileFrameCounter[639] > 5)
		{
			tileFrameCounter[639] = 0;
			tileFrame[639]++;
			if (tileFrame[639] >= 10)
			{
				tileFrame[639] = 0;
			}
		}
		tileFrameCounter[739]++;
		if (tileFrameCounter[739] > 10)
		{
			tileFrameCounter[739] = 0;
			tileFrame[739]++;
			if (tileFrame[739] >= 4)
			{
				tileFrame[739] = 0;
			}
		}
		tileFrameCounter[748]++;
		if (tileFrameCounter[748] > 7)
		{
			tileFrameCounter[748] = 0;
			tileFrame[748]++;
			if (tileFrame[748] >= 8)
			{
				tileFrame[748] = 0;
			}
		}
		tileFrameCounter[17]++;
		if (tileFrameCounter[17] > 5)
		{
			tileFrameCounter[17] = 0;
			tileFrame[17]++;
			if (tileFrame[17] >= 12)
			{
				tileFrame[17] = 0;
			}
		}
		if (++tileFrameCounter[133] >= 4)
		{
			tileFrameCounter[133] = 0;
			if (++tileFrame[133] >= 6)
			{
				tileFrame[133] = 0;
			}
		}
		tileFrameCounter[31]++;
		if (tileFrameCounter[31] >= 8)
		{
			tileFrameCounter[31] = 0;
			tileFrame[31]++;
			if (tileFrame[31] >= 4)
			{
				tileFrame[31] = 0;
			}
		}
		tileFrame[696] = tileFrame[31];
		tileFrameCounter[77]++;
		if (tileFrameCounter[77] > 5)
		{
			tileFrameCounter[77] = 0;
			tileFrame[77]++;
			if (tileFrame[77] >= 12)
			{
				tileFrame[77] = 0;
			}
		}
		tileFrameCounter[106]++;
		if (tileFrameCounter[106] > 4)
		{
			tileFrameCounter[106] = 0;
			tileFrame[106]++;
			if (tileFrame[106] >= 2)
			{
				tileFrame[106] = 0;
			}
		}
		tileFrameCounter[207]++;
		if (tileFrameCounter[207] > 4)
		{
			tileFrameCounter[207] = 0;
			tileFrame[207]++;
			if (tileFrame[207] >= 6)
			{
				tileFrame[207] = 0;
			}
		}
		tileFrameCounter[215]++;
		if (tileFrameCounter[215] >= 4)
		{
			tileFrameCounter[215] = 0;
			tileFrame[215]++;
			if (tileFrame[215] >= 8)
			{
				tileFrame[215] = 0;
			}
		}
		tileFrameCounter[592]++;
		if (tileFrameCounter[592] >= 5)
		{
			tileFrameCounter[592] = 0;
			tileFrame[592]++;
			if (tileFrame[592] >= 8)
			{
				tileFrame[592] = 0;
			}
		}
		tileFrameCounter[217]++;
		if (tileFrameCounter[217] > 4)
		{
			tileFrameCounter[217] = 0;
			tileFrame[217]++;
			if (tileFrame[217] >= 5)
			{
				tileFrame[217] = 0;
			}
		}
		tileFrameCounter[218]++;
		if (tileFrameCounter[218] > 4)
		{
			tileFrameCounter[218] = 0;
			tileFrame[218]++;
			if (tileFrame[218] >= 2)
			{
				tileFrame[218] = 0;
			}
		}
		tileFrameCounter[219]++;
		if (tileFrameCounter[219] > 4)
		{
			tileFrameCounter[219] = 0;
			tileFrame[219]++;
			if (tileFrame[219] >= 10)
			{
				tileFrame[219] = 0;
			}
		}
		tileFrameCounter[642]++;
		if (tileFrameCounter[642] > 4)
		{
			tileFrameCounter[642] = 0;
			tileFrame[642]++;
			if (tileFrame[642] >= 6)
			{
				tileFrame[642] = 0;
			}
		}
		tileFrameCounter[220]++;
		if (tileFrameCounter[220] > 4)
		{
			tileFrameCounter[220] = 0;
			tileFrame[220]++;
			if (tileFrame[220] >= 4)
			{
				tileFrame[220] = 0;
			}
		}
		tileFrameCounter[231]++;
		if (tileFrameCounter[231] > 16)
		{
			tileFrameCounter[231] = 0;
			tileFrame[231]++;
			if (tileFrame[231] >= 7)
			{
				tileFrame[231] = 0;
			}
		}
		tileFrameCounter[235]++;
		if (tileFrameCounter[235] > 20)
		{
			tileFrameCounter[235] = 0;
			tileFrame[235]++;
			if (tileFrame[235] >= 4)
			{
				tileFrame[235] = 0;
			}
		}
		tileFrameCounter[238]++;
		if (tileFrameCounter[238] > 20)
		{
			tileFrameCounter[238] = 0;
			tileFrame[238]++;
			if (tileFrame[238] >= 4)
			{
				tileFrame[238] = 0;
			}
		}
		tileFrameCounter[243]++;
		if (tileFrameCounter[243] > 4)
		{
			tileFrameCounter[243] = 0;
			tileFrame[243]++;
			if (tileFrame[243] >= 6)
			{
				tileFrame[243] = 0;
			}
		}
		tileFrameCounter[244]++;
		if (tileFrameCounter[244] > 4)
		{
			tileFrameCounter[244] = 0;
			tileFrame[244]++;
			if (tileFrame[244] >= 6)
			{
				tileFrame[244] = 0;
			}
		}
		tileFrameCounter[247]++;
		if (tileFrameCounter[247] > 4)
		{
			tileFrameCounter[247] = 0;
			tileFrame[247]++;
			if (tileFrame[247] > 7)
			{
				tileFrame[247] = 0;
			}
		}
		tileFrameCounter[96]++;
		if (tileFrameCounter[96] > 4)
		{
			tileFrameCounter[96] = 0;
			tileFrame[96]++;
			if (tileFrame[96] > 3)
			{
				tileFrame[96] = 0;
			}
		}
		tileFrameCounter[171]++;
		if (tileFrameCounter[171] > 16)
		{
			tileFrameCounter[171] = 0;
			tileFrame[171]++;
			if (tileFrame[171] > 3)
			{
				tileFrame[171] = 0;
			}
		}
		tileFrameCounter[270]++;
		if (tileFrameCounter[270] > 8)
		{
			tileFrameCounter[270] = 0;
			tileFrame[270]++;
			if (tileFrame[270] > 5)
			{
				tileFrame[270] = 0;
			}
		}
		int num = tileFrame[270];
		tileFrame[271] = num;
		tileFrame[581] = num;
		tileFrameCounter[660]++;
		if (tileFrameCounter[660] > 8)
		{
			tileFrameCounter[660] = 0;
			tileFrame[660]++;
			if (tileFrame[660] > 4)
			{
				tileFrame[660] = 0;
			}
		}
		tileFrameCounter[272]++;
		if (tileFrameCounter[272] >= 10)
		{
			tileFrameCounter[272] = 0;
			tileFrame[272]++;
			if (tileFrame[272] > 1)
			{
				tileFrame[272] = 0;
			}
		}
		tileFrameCounter[300]++;
		if (tileFrameCounter[300] >= 5)
		{
			tileFrameCounter[300] = 0;
			tileFrame[300]++;
			if (tileFrame[300] > 6)
			{
				tileFrame[300] = 0;
			}
		}
		tileFrameCounter[301]++;
		if (tileFrameCounter[301] >= 5)
		{
			tileFrameCounter[301] = 0;
			tileFrame[301]++;
			if (tileFrame[301] > 7)
			{
				tileFrame[301] = 0;
			}
		}
		tileFrameCounter[302]++;
		if (tileFrameCounter[302] >= 5)
		{
			tileFrameCounter[302] = 0;
			tileFrame[302]++;
			if (tileFrame[302] > 3)
			{
				tileFrame[302] = 0;
			}
		}
		tileFrameCounter[303]++;
		if (tileFrameCounter[303] >= 5)
		{
			tileFrameCounter[303] = 0;
			tileFrame[303]++;
			if (tileFrame[303] > 4)
			{
				tileFrame[303] = 0;
			}
		}
		tileFrameCounter[305]++;
		if (tileFrameCounter[305] >= 5)
		{
			tileFrameCounter[305] = 0;
			tileFrame[305]++;
			if (tileFrame[305] > 11)
			{
				tileFrame[305] = 0;
			}
		}
		tileFrameCounter[306]++;
		if (tileFrameCounter[306] >= 5)
		{
			tileFrameCounter[306] = 0;
			tileFrame[306]++;
			if (tileFrame[306] > 11)
			{
				tileFrame[306] = 0;
			}
		}
		tileFrameCounter[307]++;
		if (tileFrameCounter[307] >= 5)
		{
			tileFrameCounter[307] = 0;
			tileFrame[307]++;
			if (tileFrame[307] > 1)
			{
				tileFrame[307] = 0;
			}
		}
		tileFrameCounter[308]++;
		if (tileFrameCounter[308] >= 5)
		{
			tileFrameCounter[308] = 0;
			tileFrame[308]++;
			if (tileFrame[308] > 7)
			{
				tileFrame[308] = 0;
			}
		}
		tileFrameCounter[314]++;
		if (tileFrameCounter[314] >= 10)
		{
			tileFrameCounter[314] = 0;
			tileFrame[314]++;
			if (tileFrame[314] > 4)
			{
				tileFrame[314] = 0;
			}
		}
		tileFrameCounter[326]++;
		if (tileFrameCounter[326] >= 5)
		{
			tileFrameCounter[326] = 0;
			tileFrame[326]++;
			if (tileFrame[326] > 7)
			{
				tileFrame[326] = 0;
			}
		}
		tileFrameCounter[327]++;
		if (tileFrameCounter[327] >= 10)
		{
			tileFrameCounter[327] = 0;
			tileFrame[327]++;
			if (tileFrame[327] > 7)
			{
				tileFrame[327] = 0;
			}
		}
		tileFrameCounter[345]++;
		if (tileFrameCounter[345] >= 10)
		{
			tileFrameCounter[345] = 0;
			tileFrame[345]++;
			if (tileFrame[345] > 7)
			{
				tileFrame[345] = 0;
			}
		}
		tileFrameCounter[458]++;
		if (tileFrameCounter[458] >= 10)
		{
			tileFrameCounter[458] = 0;
			tileFrame[458]++;
			if (tileFrame[458] > 7)
			{
				tileFrame[458] = 0;
			}
		}
		tileFrameCounter[459]++;
		if (tileFrameCounter[459] >= 10)
		{
			tileFrameCounter[459] = 0;
			tileFrame[459]++;
			if (tileFrame[459] > 7)
			{
				tileFrame[459] = 0;
			}
		}
		tileFrameCounter[708]++;
		if (tileFrameCounter[708] >= 10)
		{
			tileFrameCounter[708] = 0;
			tileFrame[708]++;
			if (tileFrame[708] > 7)
			{
				tileFrame[708] = 0;
			}
		}
		tileFrameCounter[336]++;
		if (tileFrameCounter[336] >= 5)
		{
			tileFrameCounter[336] = 0;
			tileFrame[336]++;
			if (tileFrame[336] > 3)
			{
				tileFrame[336] = 0;
			}
		}
		tileFrameCounter[328]++;
		if (tileFrameCounter[328] >= 5)
		{
			tileFrameCounter[328] = 0;
			tileFrame[328]++;
			if (tileFrame[328] > 7)
			{
				tileFrame[328] = 0;
			}
		}
		tileFrameCounter[329]++;
		if (tileFrameCounter[329] >= 5)
		{
			tileFrameCounter[329] = 0;
			tileFrame[329]++;
			if (tileFrame[329] > 7)
			{
				tileFrame[329] = 0;
			}
		}
		int num2 = 20;
		if (++tileFrameCounter[507] >= num2 * 8)
		{
			tileFrameCounter[507] = 0;
		}
		if (++tileFrameCounter[508] >= num2 * 8)
		{
			tileFrameCounter[508] = 0;
		}
		for (int i = 340; i <= 344; i++)
		{
			tileFrameCounter[i]++;
			if (tileFrameCounter[i] >= 5)
			{
				tileFrameCounter[i] = 0;
				tileFrame[i]++;
				if (tileFrame[i] > 3)
				{
					tileFrame[i] = 0;
				}
			}
		}
		tileFrameCounter[351]++;
		if (tileFrameCounter[351] >= 5)
		{
			tileFrameCounter[351] = 0;
			tileFrame[351]++;
			if (tileFrame[351] > 2)
			{
				tileFrame[351] = 0;
			}
		}
		tileFrameCounter[354]++;
		if (tileFrameCounter[354] >= 5)
		{
			tileFrameCounter[354] = 0;
			tileFrame[354]++;
			if (tileFrame[354] >= 8)
			{
				tileFrame[354] = 0;
			}
		}
		tileFrame[355] = tileFrame[354];
		tileFrameCounter[377]++;
		if (tileFrameCounter[377] >= 5)
		{
			tileFrameCounter[377] = 0;
			tileFrame[377]++;
			if (tileFrame[377] >= 4)
			{
				tileFrame[377] = 0;
			}
		}
		tileFrameCounter[379]++;
		if (tileFrameCounter[379] >= 10)
		{
			tileFrameCounter[379] = 0;
			tileFrame[379]++;
			if (tileFrame[379] >= 4)
			{
				tileFrame[379] = 0;
			}
		}
		if (++tileFrameCounter[390] >= 8)
		{
			tileFrameCounter[390] = 0;
			if (++tileFrame[390] >= 7)
			{
				tileFrame[390] = 0;
			}
		}
		if (++tileFrameCounter[228] >= 5)
		{
			tileFrameCounter[228] = 0;
			if (++tileFrame[228] >= 3)
			{
				tileFrame[228] = 0;
			}
		}
		if (++tileFrameCounter[405] >= 5)
		{
			tileFrameCounter[405] = 0;
			if (++tileFrame[405] >= 8)
			{
				tileFrame[405] = 0;
			}
		}
		if (++tileFrameCounter[406] >= 8)
		{
			tileFrameCounter[406] = 0;
			if (++tileFrame[406] >= 6)
			{
				tileFrame[406] = 0;
			}
		}
		if (++tileFrameCounter[452] >= 5)
		{
			tileFrameCounter[452] = 0;
			if (++tileFrame[452] >= 15)
			{
				tileFrame[452] = 0;
			}
		}
		if (++tileFrameCounter[455] >= 5)
		{
			tileFrameCounter[455] = 0;
			if (++tileFrame[455] >= 6)
			{
				tileFrame[455] = 0;
			}
		}
		if (++tileFrameCounter[499] >= 5)
		{
			tileFrameCounter[499] = 0;
			if (++tileFrame[499] >= 8)
			{
				tileFrame[499] = 0;
			}
		}
		if (++tileFrameCounter[129] >= 8)
		{
			tileFrameCounter[129] = 0;
			if (++tileFrame[129] >= 6)
			{
				tileFrame[129] = 0;
			}
		}
		tileFrameCounter[453] += ((!WorldGen.isGeneratingOrLoadingWorld) ? rand.Next(3) : 0);
		if (++tileFrameCounter[453] >= 60)
		{
			tileFrameCounter[453] = 0;
		}
		if (++tileFrame[412] >= 240)
		{
			tileFrame[412] = 0;
		}
		tileFrameCounter[456] += ((!WorldGen.isGeneratingOrLoadingWorld) ? rand.Next(3) : 0);
		if (++tileFrameCounter[456] >= 80)
		{
			tileFrameCounter[456] = 0;
		}
		if (++tileFrame[456] >= 240)
		{
			tileFrame[456] = 0;
		}
		if (++tileFrameCounter[410] >= 8)
		{
			tileFrameCounter[410] = 0;
			if (++tileFrame[410] >= 8)
			{
				tileFrame[410] = 0;
			}
		}
		if (++tileFrameCounter[480] >= 8)
		{
			tileFrameCounter[480] = 0;
			if (++tileFrame[480] >= 8)
			{
				tileFrame[480] = 0;
			}
		}
		if (++tileFrameCounter[509] >= 8)
		{
			tileFrameCounter[509] = 0;
			if (++tileFrame[509] >= 8)
			{
				tileFrame[509] = 0;
			}
		}
		if (++tileFrameCounter[657] >= 8)
		{
			tileFrameCounter[657] = 0;
			if (++tileFrame[657] >= 8)
			{
				tileFrame[657] = 0;
			}
		}
		if (++tileFrameCounter[658] >= 4)
		{
			tileFrameCounter[658] = 0;
			if (++tileFrame[658] >= 10)
			{
				tileFrame[658] = 0;
			}
		}
		if (++tileFrameCounter[720] >= 8)
		{
			tileFrameCounter[720] = 0;
			if (++tileFrame[720] >= 16)
			{
				tileFrame[720] = 0;
			}
		}
		if (++tileFrameCounter[721] >= 8)
		{
			tileFrameCounter[721] = 0;
			if (++tileFrame[721] >= 32)
			{
				tileFrame[721] = 0;
			}
		}
		if (++tileFrameCounter[725] >= 8)
		{
			tileFrameCounter[725] = 0;
			if (++tileFrame[725] >= 4)
			{
				tileFrame[725] = 0;
			}
		}
		if (++tileFrameCounter[421] >= 4)
		{
			tileFrameCounter[421] = 0;
			if (++tileFrame[421] >= 4)
			{
				tileFrame[421] = 0;
			}
		}
		if (++tileFrameCounter[422] >= 4)
		{
			tileFrameCounter[422] = 0;
			if (--tileFrame[422] < 0)
			{
				tileFrame[422] = 3;
			}
		}
		if (++tileFrameCounter[463] >= 10)
		{
			tileFrameCounter[463] = 0;
			if (++tileFrame[463] >= 6)
			{
				tileFrame[463] = 0;
			}
		}
		if (++tileFrameCounter[464] >= 5)
		{
			tileFrameCounter[464] = 0;
			if (++tileFrame[464] >= 23)
			{
				tileFrame[464] = 0;
			}
		}
		if (++tileFrameCounter[485] >= 20)
		{
			tileFrameCounter[485] = 0;
		}
		if (++tileFrameCounter[491] >= 40)
		{
			tileFrameCounter[491] = 0;
		}
		if (++tileFrameCounter[564] >= 5)
		{
			tileFrameCounter[564] = 0;
			tileFrame[564]++;
			if (tileFrame[564] >= 36)
			{
				tileFrame[564] = 0;
			}
		}
		if (++tileFrameCounter[593] >= 5)
		{
			tileFrameCounter[593] = 0;
			tileFrame[593]++;
			if (tileFrame[593] >= 9)
			{
				tileFrame[593] = 5;
			}
		}
		if (++tileFrameCounter[594] >= 5)
		{
			tileFrameCounter[594] = 0;
			tileFrame[594]++;
			if (tileFrame[594] >= 9)
			{
				tileFrame[594] = 5;
			}
		}
		if (++tileFrameCounter[614] >= 5)
		{
			tileFrameCounter[614] = 0;
			tileFrame[614]++;
			if (tileFrame[614] >= 6)
			{
				tileFrame[614] = 0;
			}
		}
		if (++tileFrameCounter[565] >= 4)
		{
			tileFrameCounter[565] = 0;
			tileFrame[565]++;
			if (tileFrame[565] >= 5)
			{
				tileFrame[565] = 0;
			}
		}
		if (++tileFrameCounter[572] >= 6)
		{
			tileFrameCounter[572] = 0;
			if (++tileFrame[572] >= 4)
			{
				tileFrame[572] = 0;
			}
		}
		if (++tileFrameCounter[597] >= 64)
		{
			tileFrameCounter[597] = 0;
		}
		int num3 = (int)MathHelper.Clamp((float)Math.Floor(Math.Abs(WindForVisuals) * 10f) * (float)Math.Sign(WindForVisuals), -5f, 5f);
		tileFrameCounter[489] += num3;
		tileFrameCounter[489] %= 320;
		if (tileFrameCounter[489] < 0)
		{
			tileFrameCounter[489] += 320;
		}
		AnimateTiles_WeatherVane();
		int num4 = (int)MathHelper.Clamp((float)Math.Floor(Math.Abs(WindForVisuals) * 10f) * (float)Math.Sign(WindForVisuals), -5f, 5f);
		tileFrameCounter[493] += num4;
		tileFrameCounter[493] %= 120;
		if (tileFrameCounter[493] < 0)
		{
			tileFrameCounter[493] += 120;
		}
		AnimateTiles_CritterCages();
	}

	private static void AnimateTiles_WeatherVane()
	{
		int num = Math.Sign(WindForVisuals);
		int num2 = (int)MathHelper.Clamp((float)Math.Floor(Math.Abs(WindForVisuals) * 10f), -5f, 5f);
		int num3 = 6;
		tileFrameCounter[490] += num2;
		if (tileFrameCounter[490] < num3)
		{
			return;
		}
		tileFrameCounter[490] -= num3 * tileFrameCounter[490];
		if ((tileFrame[490] != 0 || num != -1) && (tileFrame[490] != 6 || num != 1))
		{
			if (++tileFrame[490] >= 12)
			{
				tileFrame[490] = 0;
				weatherVaneBobframe = 0;
			}
		}
		else if (rand.NextFloat() < Math.Abs(WindForVisuals) * 0.5f && ++weatherVaneBobframe == 8)
		{
			weatherVaneBobframe = 0;
		}
	}

	private static void DoUpdate_AnimateWalls()
	{
		wallFrameCounter[357]++;
		if (wallFrameCounter[357] >= 5)
		{
			wallFrameCounter[357] = 0;
			wallFrame[357]++;
			if (wallFrame[357] >= 8)
			{
				wallFrame[357] = 0;
			}
		}
		wallFrameCounter[365]++;
		if (wallFrameCounter[365] >= 8)
		{
			wallFrameCounter[365] = 0;
			wallFrame[365]++;
			if (wallFrame[365] >= 8)
			{
				wallFrame[365] = 0;
			}
		}
		wallFrameCounter[136]++;
		if (wallFrameCounter[136] >= 5)
		{
			wallFrameCounter[136] = 0;
			wallFrame[136]++;
			if (wallFrame[136] > 7)
			{
				wallFrame[136] = 0;
			}
		}
		wallFrameCounter[137]++;
		if (wallFrameCounter[137] >= 10)
		{
			wallFrameCounter[137] = 0;
			wallFrame[137]++;
			if (wallFrame[137] > 7)
			{
				wallFrame[137] = 0;
			}
		}
		int num = 226;
		wallFrameCounter[num]++;
		if (wallFrameCounter[num] >= 10)
		{
			wallFrameCounter[num] = 0;
			wallFrame[num]++;
			if (wallFrame[num] > 7)
			{
				wallFrame[num] = 0;
			}
		}
		num = 227;
		wallFrameCounter[num]++;
		if (wallFrameCounter[num] >= 5)
		{
			wallFrameCounter[num] = 0;
			wallFrame[num]++;
			if (wallFrame[num] > 7)
			{
				wallFrame[num] = 0;
			}
		}
		num = 225;
		wallFrameCounter[num]++;
		if (wallFrameCounter[num] >= 5)
		{
			wallFrameCounter[num] = 0;
			wallFrame[num]++;
			if (wallFrame[num] > 1)
			{
				wallFrame[num] = 0;
			}
		}
		wallFrameCounter[172]++;
		if (wallFrameCounter[172] >= 10)
		{
			wallFrameCounter[172] = 0;
			wallFrame[172]++;
			if (wallFrame[172] > 7)
			{
				wallFrame[172] = 0;
			}
		}
		wallFrameCounter[347]++;
		if (wallFrameCounter[347] >= 10)
		{
			wallFrameCounter[347] = 0;
			wallFrame[347]++;
			if (wallFrame[347] > 7)
			{
				wallFrame[347] = 0;
			}
		}
		wallFrameCounter[168]++;
		if (wallFrameCounter[168] >= 5)
		{
			wallFrameCounter[168] = 0;
			wallFrame[168]++;
			if (wallFrame[168] > 7)
			{
				wallFrame[168] = 0;
			}
		}
		wallFrameCounter[169]++;
		if (wallFrameCounter[169] >= 5)
		{
			wallFrameCounter[169] = 0;
			wallFrame[169]++;
			if (wallFrame[169] > 7)
			{
				wallFrame[169] = 0;
			}
		}
		int num2 = 20;
		if (++wallFrameCounter[242] >= num2 * 8)
		{
			wallFrameCounter[242] = 0;
		}
		if (++wallFrameCounter[243] >= num2 * 8)
		{
			wallFrameCounter[243] = 0;
		}
		wallFrameCounter[144]++;
		int num3 = 5;
		int num4 = 10;
		if (wallFrameCounter[144] < num3)
		{
			wallFrame[144] = 0;
			return;
		}
		if (wallFrameCounter[144] < num3)
		{
			wallFrame[144] = 1;
			return;
		}
		if (wallFrameCounter[144] < num3 * 2)
		{
			wallFrame[144] = 2;
			return;
		}
		if (wallFrameCounter[144] < num3 * 3)
		{
			wallFrame[144] = 3;
			return;
		}
		if (wallFrameCounter[144] < num3 * 4)
		{
			wallFrame[144] = 4;
			return;
		}
		if (wallFrameCounter[144] < num3 * 5)
		{
			wallFrame[144] = 5;
			return;
		}
		if (wallFrameCounter[144] < num3 * 6)
		{
			wallFrame[144] = 6;
			return;
		}
		if (wallFrameCounter[144] < num3 * 7)
		{
			wallFrame[144] = 7;
			return;
		}
		if (wallFrameCounter[144] < num3 * (8 + num4))
		{
			wallFrame[144] = 8;
			return;
		}
		if (wallFrameCounter[144] < num3 * (9 + num4))
		{
			wallFrame[144] = 7;
			return;
		}
		if (wallFrameCounter[144] < num3 * (10 + num4))
		{
			wallFrame[144] = 6;
			return;
		}
		if (wallFrameCounter[144] < num3 * (11 + num4))
		{
			wallFrame[144] = 5;
			return;
		}
		if (wallFrameCounter[144] < num3 * (12 + num4))
		{
			wallFrame[144] = 4;
			return;
		}
		if (wallFrameCounter[144] < num3 * (13 + num4))
		{
			wallFrame[144] = 3;
			return;
		}
		if (wallFrameCounter[144] < num3 * (14 + num4))
		{
			wallFrame[144] = 2;
			return;
		}
		if (wallFrameCounter[144] < num3 * (15 + num4))
		{
			wallFrame[144] = 1;
			return;
		}
		wallFrame[144] = 0;
		if (wallFrameCounter[144] > num3 * (16 + num4 * 2))
		{
			wallFrameCounter[144] = 0;
		}
	}

	private void DoUpdate_AnimateWaterfalls()
	{
		wFrCounter += windSpeedCurrent * 2f;
		if (wFrCounter > 4f)
		{
			wFrCounter = 0f;
			wFrame += 1f;
		}
		if (wFrCounter < 0f)
		{
			wFrCounter = 4f;
			wFrame -= 1f;
		}
		if (wFrame > 16f)
		{
			wFrame = 1f;
		}
		if (wFrame < 1f)
		{
			wFrame = 16f;
		}
		waterfallManager.UpdateFrame();
	}

	private static void DoUpdate_AnimateVisualPlayerAura()
	{
		if (gFadeDir == 1)
		{
			gFader += 0.1f;
			gFade = (byte)gFader;
			if (gFade > 150)
			{
				gFadeDir = 0;
			}
		}
		else
		{
			gFader -= 0.1f;
			gFade = (byte)gFader;
			if (gFade < 100)
			{
				gFadeDir = 1;
			}
		}
	}

	private void DoUpdate_AnimateDiscoRGB()
	{
		int num = 7;
		if (DiscoStyle == 0)
		{
			DiscoG += num;
			if (DiscoG >= 255)
			{
				DiscoG = 255;
				DiscoStyle++;
			}
		}
		if (DiscoStyle == 1)
		{
			DiscoR -= num;
			if (DiscoR <= 0)
			{
				DiscoR = 0;
				DiscoStyle++;
			}
		}
		if (DiscoStyle == 2)
		{
			DiscoB += num;
			if (DiscoB >= 255)
			{
				DiscoB = 255;
				DiscoStyle++;
			}
		}
		if (DiscoStyle == 3)
		{
			DiscoG -= num;
			if (DiscoG <= 0)
			{
				DiscoG = 0;
				DiscoStyle++;
			}
		}
		if (DiscoStyle == 4)
		{
			DiscoR += num;
			if (DiscoR >= 255)
			{
				DiscoR = 255;
				DiscoStyle++;
			}
		}
		if (DiscoStyle == 5)
		{
			DiscoB -= num;
			if (DiscoB <= 0)
			{
				DiscoB = 0;
				DiscoStyle = 0;
			}
		}
	}

	private static void DoUpdate_AnimateBackgrounds()
	{
		DoUpdate_AnimateBackgrounds_UpdateForest(0, treeMntBGSet1);
		DoUpdate_AnimateBackgrounds_UpdateForest(10, treeMntBGSet2);
		DoUpdate_AnimateBackgrounds_UpdateForest(11, treeMntBGSet3);
		DoUpdate_AnimateBackgrounds_UpdateForest(12, treeMntBGSet4);
	}

	private static void DoUpdate_AnimateBackgrounds_UpdateForest(int bgIndex, int[] bgSet)
	{
		if (bgSet[1] == 94 || (bgSet[1] >= 114 && bgSet[1] <= 116))
		{
			bgFrameCounter[bgIndex]++;
			if (bgFrameCounter[bgIndex] >= 6)
			{
				bgFrameCounter[bgIndex] = 0;
				bgFrame[bgIndex]++;
				if (bgFrame[bgIndex] >= 4)
				{
					bgFrame[bgIndex] = 0;
				}
			}
			if (bgFrame[bgIndex] == 0)
			{
				bgSet[1] = 94;
			}
			else if (bgFrame[bgIndex] == 1)
			{
				bgSet[1] = 114;
			}
			else if (bgFrame[bgIndex] == 2)
			{
				bgSet[1] = 115;
			}
			else
			{
				bgSet[1] = 116;
			}
			if (bgFrame[bgIndex] == 0)
			{
				bgSet[0] = 93;
			}
			else if (bgFrame[bgIndex] == 1)
			{
				bgSet[0] = 168;
			}
			else if (bgFrame[bgIndex] == 2)
			{
				bgSet[0] = 169;
			}
			else
			{
				bgSet[0] = 170;
			}
		}
		if (bgSet[1] < 180 || bgSet[1] > 183)
		{
			return;
		}
		bgFrameCounter[bgIndex]++;
		if (bgFrameCounter[bgIndex] >= 6)
		{
			bgFrameCounter[bgIndex] = 0;
			bgFrame[bgIndex]++;
			if (bgFrame[bgIndex] >= 4)
			{
				bgFrame[bgIndex] = 0;
			}
		}
		if (bgFrame[bgIndex] == 0)
		{
			bgSet[1] = 180;
		}
		else if (bgFrame[bgIndex] == 1)
		{
			bgSet[1] = 181;
		}
		else if (bgFrame[bgIndex] == 2)
		{
			bgSet[1] = 182;
		}
		else
		{
			bgSet[1] = 183;
		}
	}

	private static void DoUpdate_AutoSave()
	{
		if (!gameMenu && netMode == 1)
		{
			if (!saveTime.IsRunning)
			{
				saveTime.Start();
			}
			if (saveTime.ElapsedMilliseconds > 300000)
			{
				saveTime.Reset();
				WorldGen.saveToonWhilePlaying();
			}
		}
		else if (!gameMenu && (autoSave || netMode == 2))
		{
			if (!saveTime.IsRunning)
			{
				saveTime.Start();
			}
			if (saveTime.ElapsedMilliseconds > 600000)
			{
				saveTime.Reset();
				if (netMode != 2)
				{
					WorldGen.saveToonWhilePlaying();
				}
				WorldGen.saveAndPlay();
			}
		}
		else if (saveTime.IsRunning)
		{
			saveTime.Stop();
		}
	}

	private static void UpdateSettingUnlocks()
	{
		if (netMode != 2 && !dedServ && hardMode && !SettingsUnlock_WorldEvil)
		{
			SettingsUnlock_WorldEvil = true;
			SaveSettings();
		}
	}

	public static void InputTextSign()
	{
		if (!IngameFancyUI.CanShowVirtualKeyboard(1) || UIVirtualKeyboard.KeyboardContext != 1)
		{
			PlayerInput.WritingText = true;
			instance.HandleIME();
			npcChatText = GetInputText(npcChatText, allowMultiLine: true);
			if (inputTextEnter)
			{
				byte[] bytes = new byte[1] { 10 };
				npcChatText += Encoding.ASCII.GetString(bytes);
			}
			else if (inputTextEscape)
			{
				InputTextSignCancel();
			}
		}
	}

	public static void InputTextChest()
	{
		if (!IngameFancyUI.CanShowVirtualKeyboard(2) || UIVirtualKeyboard.KeyboardContext != 2)
		{
			npcChatText = GetInputText(npcChatText);
			if (inputTextEnter)
			{
				ChestUI.RenameChestSubmit(player[myPlayer]);
			}
			else if (inputTextEscape)
			{
				ChestUI.RenameChestCancel();
			}
		}
	}

	public static void InputTextSignCancel()
	{
		editSign = false;
		blockKey = Microsoft.Xna.Framework.Input.Keys.Escape.ToString();
		UIVirtualKeyboard.CacheCanceledInput(1);
		if (player[myPlayer].sign >= 0)
		{
			npcChatText = sign[player[myPlayer].sign].text;
		}
	}

	private static void UpdateMenu()
	{
		if (WorldGen.drunkWorldGen)
		{
			if (WorldGen.remixWorldGen)
			{
				screenPosition.X -= 20f;
			}
			if (WorldGen.drunkWorldGenText)
			{
				if (WorldGen.dontStarveWorldGen)
				{
					numClouds = 50;
				}
				else
				{
					numClouds = rand.Next(100, 200);
				}
				statusText = string.Concat(rand.Next(999999999));
				for (int i = 0; i < 3; i++)
				{
					if (rand.Next(2) == 0)
					{
						statusText += rand.Next(999999999);
					}
				}
			}
		}
		gamePaused = false;
		thunderDelay = 0;
		lightning = 0f;
		lightningSpeed = 0f;
		GraveyardVisualIntensity = 0f;
		playerInventory = false;
		exitScale = 0.8f;
		if (netMode == 0)
		{
			if (instance.IsActive && hasFocus && (!dayTime || WorldGen.remixWorldGen) && (rand.Next(12) == 0 || (WorldGen.drunkWorldGen && !remixWorld)))
			{
				int num = rand.Next(numStars);
				if (star[num] != null && !star[num].hidden && !star[num].falling)
				{
					star[num].Fall();
				}
			}
			if (gameMenu)
			{
				if (WorldGen.isGeneratingOrLoadingWorld)
				{
					lockMenuBGChange = true;
				}
				else if (menuMode == 0)
				{
					lockMenuBGChange = false;
				}
				if (!lockMenuBGChange)
				{
					if (dayTime)
					{
						menuBGChangedDay = false;
					}
					else if (!menuBGChangedDay && time >= 16200.0)
					{
						menuBGChangedDay = true;
						int style = WorldGen.corruptBG;
						WorldGen.RandomizeBackgrounds(rand);
						if (treeBGSet1[0] == 173)
						{
							WorldGen.RandomizeBackgrounds(rand);
						}
						if (treeBGSet1[0] == 173)
						{
							WorldGen.RandomizeBackgrounds(rand);
						}
						WorldGen.setBG(1, style);
					}
					if (!dayTime)
					{
						menuBGChangedNight = false;
					}
					else if (!menuBGChangedNight && time >= 27000.0)
					{
						moonType = rand.Next(9);
						menuBGChangedNight = true;
						int treeBG = WorldGen.treeBG1;
						WorldGen.RandomizeBackgrounds(rand);
						WorldGen.setBG(0, treeBG);
					}
				}
				else
				{
					menuBGChangedDay = true;
					menuBGChangedNight = true;
				}
			}
			if (alreadyGrabbingSunOrMoon)
			{
				return;
			}
			if (WorldGen.drunkWorldGen && !WorldGen.remixWorldGen)
			{
				if (dayTime)
				{
					time -= 1000.0;
				}
				if (dontStarveWorld)
				{
					int num2 = 200;
					if (rand.Next(300) == 0)
					{
						seedMoonGoal = rand.Next(100, 32300);
					}
					if (time < (double)(seedMoonGoal - num2 - 1))
					{
						time += num2;
					}
					else if (time > (double)(seedMoonGoal + num2 + 1))
					{
						time -= num2;
					}
					else
					{
						time = seedMoonGoal;
					}
				}
				else
				{
					time -= 6.0;
				}
				if (time < 0.0)
				{
					time = 32400.0;
					dayTime = false;
				}
			}
			else if (dayTime)
			{
				time += 33.88235294117647;
			}
			else
			{
				time += 30.857142857142858;
			}
			if (!dayTime)
			{
				if (time > 32400.0)
				{
					bloodMoon = false;
					time = 0.0;
					dayTime = true;
					if (starGame)
					{
						dayTime = false;
					}
					moonPhase++;
					if (moonPhase > 7)
					{
						moonPhase = 0;
					}
				}
			}
			else if (time > 54000.0)
			{
				time = 0.0;
				dayTime = false;
			}
		}
		else if (netMode == 1)
		{
			UpdateTime();
		}
	}

	public static void clrInput()
	{
		keyCount = 0;
		inputTextEscape = false;
	}

	[DllImport("user32.dll", CharSet = CharSet.Auto, ExactSpelling = true)]
	public static extern short GetKeyState(int keyCode);

	public static string GetInputText(string oldString, bool allowMultiLine = false)
	{
		if (dedServ)
		{
			return "";
		}
		if (!hasFocus)
		{
			return oldString;
		}
		inputTextEnter = false;
		inputTextEscape = false;
		string text = oldString;
		string text2 = "";
		if (text == null)
		{
			text = "";
		}
		bool flag = false;
		if (inputText.PressingControl() && !inputText.PressingAlt())
		{
			if (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Z) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Z))
			{
				text = "";
			}
			else if (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.X) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.X))
			{
				Platform.Get<IClipboard>().Value = oldString;
				text = "";
			}
			else if ((inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.C) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.C)) || (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Insert) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Insert)))
			{
				Platform.Get<IClipboard>().Value = oldString;
			}
			else if (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.V) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.V))
			{
				text2 = PasteTextIn(allowMultiLine, text2);
			}
		}
		else
		{
			if (inputText.PressingShift())
			{
				if (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Delete) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Delete))
				{
					Platform.Get<IClipboard>().Value = oldString;
					text = "";
				}
				if (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Insert) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Insert))
				{
					text2 = PasteTextIn(allowMultiLine, text2);
				}
			}
			if (!Platform.IsWindows && inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Escape) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Escape))
			{
				inputTextEscape = true;
			}
			for (int i = 0; i < keyCount; i++)
			{
				int num = keyInt[i];
				string text3 = keyString[i];
				if (num == 13)
				{
					inputTextEnter = true;
				}
				else if (num == 27)
				{
					inputTextEscape = true;
				}
				else if (num >= 32 && num != 127)
				{
					text2 += text3;
				}
			}
		}
		keyCount = 0;
		text += text2;
		oldInputText = inputText;
		inputText = Keyboard.GetState();
		if (inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Back) && oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Back) && !imeCompositionActive)
		{
			backSpaceRate -= 0.05f;
			if (backSpaceRate < 0f)
			{
				backSpaceRate = 0f;
			}
			if (backSpaceCount <= 0)
			{
				backSpaceCount = (int)Math.Round(backSpaceRate);
				flag = true;
			}
			backSpaceCount--;
		}
		else
		{
			backSpaceRate = 7f;
			backSpaceCount = 15;
		}
		if (((inputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Back) && !oldInputText.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.Back) && !imeCompositionActive) || flag) && text.Length > 0)
		{
			TextSnippet[] array = ChatManager.ParseMessage(text, Microsoft.Xna.Framework.Color.White).ToArray();
			text = ((!array[array.Length - 1].DeleteWhole) ? Utils.TrimLastCharacter(text) : text.Substring(0, text.Length - array[array.Length - 1].TextOriginal.Length));
		}
		imeCompositionActive = !string.IsNullOrEmpty(Platform.Get<IImeService>().CompositionString);
		return text;
	}

	private static string PasteTextIn(bool allowMultiLine, string newKeys)
	{
		newKeys = ((!allowMultiLine) ? (newKeys + Platform.Get<IClipboard>().Value) : (newKeys + Platform.Get<IClipboard>().MultiLineValue));
		return newKeys;
	}

	public void MouseTextHackZoom(string text, string buffTooltip = null)
	{
		MouseTextHackZoom(text, 0, 0, buffTooltip);
	}

	public void MouseTextHackZoom(string text, int itemRarity, byte diff = 0, string buffTooltip = null)
	{
		MouseText(text, buffTooltip, itemRarity, diff);
	}

	public void MouseTextNoOverride(string cursorText, int rare = 0, byte diff = 0, int hackedMouseX = -1, int hackedMouseY = -1, int hackedScreenWidth = -1, int hackedScreenHeight = -1, int pushWidthX = 0)
	{
		MouseText(cursorText, null, rare, diff, hackedMouseX, hackedMouseY, hackedScreenWidth, hackedScreenHeight, pushWidthX, noOverride: true);
	}

	public void MouseText(string cursorText, int rare = 0, byte diff = 0, int hackedMouseX = -1, int hackedMouseY = -1, int hackedScreenWidth = -1, int hackedScreenHeight = -1, int pushWidthX = 0)
	{
		MouseText(cursorText, null, rare, diff, hackedMouseX, hackedMouseY, hackedScreenWidth, hackedScreenHeight, pushWidthX);
	}

	public static Item DisplayAndGetFakeItem(ItemRarityColor color)
	{
		_mouseTextFakeItem.SetDefaults(0);
		_mouseTextFakeItem.type = 1;
		_mouseTextFakeItem.scale = 0f;
		_mouseTextFakeItem.value = -1;
		_mouseTextFakeItem.rare = (int)color;
		HoverItem = _mouseTextFakeItem;
		instance.MouseText("", 0, 0);
		mouseText = true;
		return _mouseTextFakeItem;
	}

	public static void ClearHoverItem()
	{
		HoverItem = _airHoverItem;
		HoverItem.TurnToAir();
	}

	public void MouseText(string cursorText, string buffTooltip, int rare = 0, byte diff = 0, int hackedMouseX = -1, int hackedMouseY = -1, int hackedScreenWidth = -1, int hackedScreenHeight = -1, int pushWidthX = 0, bool noOverride = false)
	{
		if (!_mouseTextCache.noOverride)
		{
			_mouseTextCache = new MouseTextCache
			{
				noOverride = noOverride,
				isValid = true,
				cursorText = cursorText,
				rare = rare,
				diff = diff,
				X = hackedMouseX,
				Y = hackedMouseY,
				hackedScreenWidth = hackedScreenWidth,
				hackedScreenHeight = hackedScreenHeight,
				buffTooltip = buffTooltip
			};
		}
	}

	private void MouseTextInner(MouseTextCache info)
	{
		string cursorText = info.cursorText;
		int num = info.rare;
		byte diff = info.diff;
		int x = info.X;
		int y = info.Y;
		int hackedScreenWidth = info.hackedScreenWidth;
		int hackedScreenHeight = info.hackedScreenHeight;
		int num2 = 40;
		if (mouseNPCType > -1 || cursorText == null)
		{
			return;
		}
		int X = mouseX + 14;
		int Y = mouseY + 14;
		if (x != -1 && y != -1)
		{
			X = x + 10;
			Y = y + 10;
		}
		if (ThickMouse)
		{
			X += 6;
			Y += 6;
		}
		if (!mouseItem.IsAir)
		{
			X += 34;
		}
		new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
		if (HoverItem.type > 0)
		{
			MouseText_DrawItemTooltip(info, num, diff, X, Y);
			return;
		}
		Vector2 mouseTextSize = FontAssets.MouseText.Value.MeasureString(cursorText);
		if (info.buffTooltip != null && info.buffTooltip != "")
		{
			MouseText_DrawBuffTooltip(info.buffTooltip, ref X, ref Y, mouseTextSize);
		}
		if (hackedScreenHeight != -1 && hackedScreenWidth != -1)
		{
			if ((float)X + mouseTextSize.X + (float)num2 > (float)hackedScreenWidth)
			{
				X = (int)((float)hackedScreenWidth - mouseTextSize.X - (float)num2);
			}
			if ((float)Y + mouseTextSize.Y + (float)num2 > (float)hackedScreenHeight)
			{
				Y = (int)((float)hackedScreenHeight - mouseTextSize.Y - (float)num2);
			}
		}
		else
		{
			if ((float)X + mouseTextSize.X + (float)num2 > (float)screenWidth)
			{
				X = (int)((float)screenWidth - mouseTextSize.X - (float)num2);
			}
			if ((float)Y + mouseTextSize.Y + (float)num2 > (float)screenHeight)
			{
				Y = (int)((float)screenHeight - mouseTextSize.Y - (float)num2);
			}
		}
		float num3 = (float)(int)mouseTextColor / 255f;
		Microsoft.Xna.Framework.Color baseColor = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
		if (num == -13)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(masterColor * 200f * num3), 0, mouseTextColor);
		}
		if (num == -12)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)((float)DiscoR * num3), (byte)((float)DiscoG * num3), (byte)((float)DiscoB * num3), mouseTextColor);
		}
		if (num == -11)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(175f * num3), (byte)(0f * num3), mouseTextColor);
		}
		if (num == -10)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(65f * num3), (byte)(255f * num3), (byte)(110f * num3), mouseTextColor);
		}
		if (num == -1)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(130f * num3), (byte)(130f * num3), (byte)(130f * num3), mouseTextColor);
		}
		if (num == 1)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(150f * num3), (byte)(150f * num3), (byte)(255f * num3), mouseTextColor);
		}
		if (num == 2)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(150f * num3), (byte)(255f * num3), (byte)(150f * num3), mouseTextColor);
		}
		if (num == 3)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(200f * num3), (byte)(150f * num3), mouseTextColor);
		}
		if (num == 4)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(150f * num3), (byte)(150f * num3), mouseTextColor);
		}
		if (num == 5)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(150f * num3), (byte)(255f * num3), mouseTextColor);
		}
		if (num == 6)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(210f * num3), (byte)(160f * num3), (byte)(255f * num3), mouseTextColor);
		}
		if (num == 7)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(150f * num3), (byte)(255f * num3), (byte)(10f * num3), mouseTextColor);
		}
		if (num == 8)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(255f * num3), (byte)(10f * num3), mouseTextColor);
		}
		if (num == 9)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(5f * num3), (byte)(200f * num3), (byte)(255f * num3), mouseTextColor);
		}
		if (num == 10)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(255f * num3), (byte)(40f * num3), (byte)(100f * num3), mouseTextColor);
		}
		if (num >= 11)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)(180f * num3), (byte)(40f * num3), (byte)(255f * num3), mouseTextColor);
		}
		if (diff == 1)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)((float)(int)mcColor.R * num3), (byte)((float)(int)mcColor.G * num3), (byte)((float)(int)mcColor.B * num3), mouseTextColor);
		}
		if (diff == 2)
		{
			baseColor = new Microsoft.Xna.Framework.Color((byte)((float)(int)hcColor.R * num3), (byte)((float)(int)hcColor.G * num3), (byte)((float)(int)hcColor.B * num3), mouseTextColor);
		}
		ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, cursorText, new Vector2(X, Y), baseColor, 0f, Vector2.Zero, Vector2.One);
	}

	private void MouseText_DrawItemTooltip(MouseTextCache info, int rare, byte diff, int X, int Y)
	{
		bool settingsEnabled_OpaqueBoxBehindTooltips = SettingsEnabled_OpaqueBoxBehindTooltips;
		new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
		Item hoverItem = HoverItem;
		int yoyoLogo = -1;
		int researchLine = -1;
		rare = hoverItem.rare;
		if (hoverItem.expert)
		{
			rare = -12;
		}
		float knockBack = hoverItem.knockBack;
		float num = 1f;
		if (hoverItem.melee && player[myPlayer].kbGlove)
		{
			num += 1f;
		}
		if (player[myPlayer].kbBuff)
		{
			num += 0.5f;
		}
		if (num != 1f)
		{
			hoverItem.knockBack *= num;
		}
		if (hoverItem.ranged && player[myPlayer].shroomiteStealth)
		{
			hoverItem.knockBack *= 1f + (1f - player[myPlayer].stealth) * 0.5f;
		}
		int numLines = 1;
		string[] mouseTextTooltipLine_Text = _mouseTextTooltipLine_Text;
		Microsoft.Xna.Framework.Color[] mouseTextTooltipLine_Color = _mouseTextTooltipLine_Color;
		_ = mouseTextColor;
		float num2 = (float)(int)mouseTextColor / 255f;
		for (int i = 0; i < mouseTextTooltipLine_Text.Length; i++)
		{
			mouseTextTooltipLine_Color[i] = new Microsoft.Xna.Framework.Color(255, 255, 255);
		}
		mouseTextTooltipLine_Color[0] = MouseText_DrawItemTooltip_GetItemNameColor(rare, diff);
		MouseText_DrawItemTooltip_GetLinesInfo(hoverItem, ref yoyoLogo, ref researchLine, knockBack, ref numLines, mouseTextTooltipLine_Text, mouseTextTooltipLine_Color);
		MouseText_DrawItemTooltip_AddShopLines(hoverItem, ref numLines, mouseTextTooltipLine_Text, mouseTextTooltipLine_Color);
		if (NewCraftingUI.Visible)
		{
			NewCraftingUI.AddTooltipLines(hoverItem, ref numLines, mouseTextTooltipLine_Text, mouseTextTooltipLine_Color);
		}
		Vector2 zero = Vector2.Zero;
		int num3 = 0;
		for (int j = 0; j < numLines; j++)
		{
			Vector2 stringSize = ChatManager.GetStringSize(FontAssets.MouseText.Value, mouseTextTooltipLine_Text[j], Vector2.One);
			if (stringSize.X > zero.X)
			{
				zero.X = stringSize.X;
			}
			zero.Y += stringSize.Y + (float)num3;
		}
		X += toolTipDistance;
		Y += toolTipDistance;
		int num4 = 4;
		if (settingsEnabled_OpaqueBoxBehindTooltips)
		{
			X += 8;
			Y += 2;
			num4 = 18;
		}
		int num5 = screenWidth;
		int num6 = screenHeight;
		if ((float)X + zero.X + (float)num4 > (float)num5)
		{
			X = (int)((float)num5 - zero.X - (float)num4);
		}
		if ((float)Y + zero.Y + (float)num4 > (float)num6)
		{
			Y = (int)((float)num6 - zero.Y - (float)num4);
		}
		int num7 = 0;
		if (settingsEnabled_OpaqueBoxBehindTooltips)
		{
			int num8 = 14;
			int num9 = 9;
			Utils.DrawInvBG(spriteBatch, new Microsoft.Xna.Framework.Rectangle(X - num8, Y - num9, (int)zero.X + num8 * 2, (int)zero.Y + num9 + num9 / 2), new Microsoft.Xna.Framework.Color(23, 25, 81, 255) * 0.925f);
		}
		for (int k = 0; k < mouseTextTooltipLine_Text.Length; k++)
		{
			mouseTextTooltipLine_Color[k] = new Microsoft.Xna.Framework.Color((byte)((float)(int)mouseTextTooltipLine_Color[k].R * num2), (byte)((float)(int)mouseTextTooltipLine_Color[k].G * num2), (byte)((float)(int)mouseTextTooltipLine_Color[k].B * num2), mouseTextColor);
		}
		for (int l = 0; l < numLines; l++)
		{
			if (l == yoyoLogo)
			{
				float num10 = 1f;
				int num11 = (int)((float)(int)mouseTextColor * num10);
				Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Black;
				for (int m = 0; m < 5; m++)
				{
					int num12 = X;
					int num13 = Y + num7;
					if (m == 4)
					{
						color = new Microsoft.Xna.Framework.Color(num11, num11, num11, num11);
					}
					switch (m)
					{
					case 0:
						num12--;
						break;
					case 1:
						num12++;
						break;
					case 2:
						num13--;
						break;
					case 3:
						num13++;
						break;
					}
					spriteBatch.Draw(TextureAssets.OneDropLogo.Value, new Vector2(num12, num13), null, color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				}
			}
			else
			{
				Microsoft.Xna.Framework.Color baseColor = mouseTextTooltipLine_Color[l];
				if (l == researchLine)
				{
					baseColor = Colors.JourneyMode;
				}
				ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, mouseTextTooltipLine_Text[l], new Vector2(X, Y + num7), baseColor, 0f, Vector2.Zero, Vector2.One);
			}
			num7 += (int)(FontAssets.MouseText.Value.MeasureString(mouseTextTooltipLine_Text[l]).Y + (float)num3);
		}
	}

	private static void MouseText_DrawItemTooltip_AddShopLines(Item hoverItem, ref int numLines, string[] lineText, Microsoft.Xna.Framework.Color[] lineColors)
	{
		if (npcShop <= 0 || hoverItem.value < 0 || (hoverItem.type >= 71 && hoverItem.type <= 74))
		{
			return;
		}
		LocalPlayer.GetItemExpectedPrice(hoverItem, out var calcForSelling, out var calcForBuying);
		long num = ((hoverItem.isAShopItem || hoverItem.buyOnce) ? calcForBuying : calcForSelling);
		if (hoverItem.shopSpecialCurrency != -1)
		{
			long price = num * ItemSlot.EstimateDisplayStack(hoverItem);
			CustomCurrencyManager.GetPriceText(hoverItem.shopSpecialCurrency, lineText, ref numLines, price);
			lineColors[numLines - 1] = new Microsoft.Xna.Framework.Color(255, 255, 255);
		}
		else if (num > 0)
		{
			string text = "";
			long num2 = 0L;
			long num3 = 0L;
			long num4 = 0L;
			long num5 = 0L;
			long num6 = num * ItemSlot.EstimateDisplayStack(hoverItem);
			if (!hoverItem.buy)
			{
				num6 = num / 5;
				if (num6 < 1)
				{
					num6 = 1L;
				}
				long num7 = num6;
				num6 *= hoverItem.stack;
				int amount = shopSellbackHelper.GetAmount(hoverItem);
				if (amount > 0)
				{
					num6 += (-num7 + calcForBuying) * Math.Min(amount, hoverItem.stack);
				}
			}
			if (num6 < 1)
			{
				num6 = 1L;
			}
			if (num6 >= 1000000)
			{
				num2 = num6 / 1000000;
				num6 -= num2 * 1000000;
			}
			if (num6 >= 10000)
			{
				num3 = num6 / 10000;
				num6 -= num3 * 10000;
			}
			if (num6 >= 100)
			{
				num4 = num6 / 100;
				num6 -= num4 * 100;
			}
			if (num6 >= 1)
			{
				num5 = num6;
			}
			if (num2 > 0)
			{
				text = text + num2 + " " + Lang.inter[15].Value + " ";
			}
			if (num3 > 0)
			{
				text = text + num3 + " " + Lang.inter[16].Value + " ";
			}
			if (num4 > 0)
			{
				text = text + num4 + " " + Lang.inter[17].Value + " ";
			}
			if (num5 > 0)
			{
				text = text + num5 + " " + Lang.inter[18].Value + " ";
			}
			if (!hoverItem.buy)
			{
				lineText[numLines] = Lang.tip[49].Value + " " + text;
			}
			else
			{
				lineText[numLines] = Lang.tip[50].Value + " " + text;
			}
			if (num2 > 0)
			{
				lineColors[numLines] = new Microsoft.Xna.Framework.Color(220, 220, 198);
			}
			else if (num3 > 0)
			{
				lineColors[numLines] = new Microsoft.Xna.Framework.Color(224, 201, 92);
			}
			else if (num4 > 0)
			{
				lineColors[numLines] = new Microsoft.Xna.Framework.Color(181, 192, 193);
			}
			else if (num5 > 0)
			{
				lineColors[numLines] = new Microsoft.Xna.Framework.Color(246, 138, 96);
			}
			numLines++;
		}
		else if (hoverItem.type != 3817)
		{
			lineText[numLines] = Lang.tip[51].Value;
			lineColors[numLines] = new Microsoft.Xna.Framework.Color(120, 120, 120);
			numLines++;
		}
	}

	private static Microsoft.Xna.Framework.Color MouseText_DrawItemTooltip_GetItemNameColor(int rare, byte diff)
	{
		Microsoft.Xna.Framework.Color result = Microsoft.Xna.Framework.Color.White;
		if (rare == -13)
		{
			result = new Microsoft.Xna.Framework.Color(255, (byte)(masterColor * 200f), 0);
		}
		if (rare == -12)
		{
			result = new Microsoft.Xna.Framework.Color((byte)DiscoR, (byte)DiscoG, (byte)DiscoB);
		}
		if (rare == -11)
		{
			result = new Microsoft.Xna.Framework.Color(255, 175, 0);
		}
		if (rare == -1)
		{
			result = new Microsoft.Xna.Framework.Color(130, 130, 130);
		}
		if (rare == 1)
		{
			result = new Microsoft.Xna.Framework.Color(150, 150, 255);
		}
		if (rare == 2)
		{
			result = new Microsoft.Xna.Framework.Color(150, 255, 150);
		}
		if (rare == 3)
		{
			result = new Microsoft.Xna.Framework.Color(255, 200, 150);
		}
		if (rare == 4)
		{
			result = new Microsoft.Xna.Framework.Color(255, 150, 150);
		}
		if (rare == 5)
		{
			result = new Microsoft.Xna.Framework.Color(255, 150, 255);
		}
		if (rare == 6)
		{
			result = new Microsoft.Xna.Framework.Color(210, 160, 255);
		}
		if (rare == 7)
		{
			result = new Microsoft.Xna.Framework.Color(150, 255, 10);
		}
		if (rare == 8)
		{
			result = new Microsoft.Xna.Framework.Color(255, 255, 10);
		}
		if (rare == 9)
		{
			result = new Microsoft.Xna.Framework.Color(5, 200, 255);
		}
		if (rare == 10)
		{
			result = new Microsoft.Xna.Framework.Color(255, 40, 100);
		}
		if (rare >= 11)
		{
			result = new Microsoft.Xna.Framework.Color(180, 40, 255);
		}
		if (diff == 1)
		{
			result = new Microsoft.Xna.Framework.Color(mcColor.R, mcColor.G, mcColor.B);
		}
		if (diff == 2)
		{
			result = new Microsoft.Xna.Framework.Color(hcColor.R, hcColor.G, hcColor.B);
		}
		return result;
	}

	public static void MouseText_DrawItemTooltip_GetLinesInfo(Item item, ref int yoyoLogo, ref int researchLine, float oldKB, ref int numLines, string[] toolTipLine, Microsoft.Xna.Framework.Color[] lineColors)
	{
		int stack = ItemSlot.EstimateDisplayStack(item);
		toolTipLine[0] = Item.GetHoverName(item, stack);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(190, 120, 120);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(120, 190, 120);
		if (item.favorited)
		{
			toolTipLine[numLines++] = Lang.tip[56].Value;
			toolTipLine[numLines++] = Lang.tip[57].Value;
			if (LocalPlayer.chest != -1)
			{
				Item[] container = LocalPlayer.GetCurrentContainer().item;
				if (ChestUI.IsBlockedFromTransferIntoChest(item, container))
				{
					toolTipLine[numLines++] = Language.GetTextValue("UI.ItemCannotBePlacedInsideItself");
				}
			}
		}
		if (item.social && !item.vanity && !item.hasVanityEffects)
		{
			toolTipLine[numLines] = Lang.tip[61].Value;
			numLines++;
		}
		if (item.damage > 0 && (!item.notAmmo || item.useStyle != 0) && (item.type < 71 || item.type > 74 || player[myPlayer].HasItem(905)))
		{
			float num = 5E-06f;
			int damage = item.damage;
			damage = (int)((float)damage * ItemID.Sets.ToolTipDamageMultiplier[item.type]);
			if (ItemID.Sets.RapidAttackBonusDamage[item.type])
			{
				damage = LocalPlayer.ApplyRapidAttackBonus(damage, item.type);
			}
			toolTipLine[numLines] = string.Concat((int)(LocalPlayer.GetWeaponDamageMultiplier(item) * (float)damage + num));
			if (item.melee)
			{
				toolTipLine[numLines] += Lang.tip[2].Value;
			}
			else if (item.ranged)
			{
				toolTipLine[numLines] += Lang.tip[3].Value;
			}
			else if (item.magic)
			{
				toolTipLine[numLines] += Lang.tip[4].Value;
			}
			else if (item.summon)
			{
				toolTipLine[numLines] += Lang.tip[53].Value;
			}
			else
			{
				toolTipLine[numLines] += Lang.tip[55].Value;
			}
			numLines++;
			if (item.melee)
			{
				int num2 = player[myPlayer].meleeCrit - LocalPlayer.inventory[LocalPlayer.selectedItem].crit + item.GetVisualCritChance(LocalPlayer);
				toolTipLine[numLines] = num2 + Lang.tip[5].Value;
				numLines++;
			}
			else if (item.ranged)
			{
				int num3 = player[myPlayer].rangedCrit - LocalPlayer.inventory[LocalPlayer.selectedItem].crit + item.GetVisualCritChance(LocalPlayer);
				toolTipLine[numLines] = num3 + Lang.tip[5].Value;
				numLines++;
			}
			else if (item.magic)
			{
				int num4 = player[myPlayer].magicCrit - LocalPlayer.inventory[LocalPlayer.selectedItem].crit + item.GetVisualCritChance(LocalPlayer);
				toolTipLine[numLines] = num4 + Lang.tip[5].Value;
				numLines++;
			}
			if (item.useStyle != 0 && (!item.summon || (item.shoot >= 0 && ProjectileID.Sets.IsAWhip[item.shoot])))
			{
				if (item.useAnimation <= 8)
				{
					toolTipLine[numLines] = Lang.tip[6].Value;
				}
				else if (item.useAnimation <= 20)
				{
					toolTipLine[numLines] = Lang.tip[7].Value;
				}
				else if (item.useAnimation <= 25)
				{
					toolTipLine[numLines] = Lang.tip[8].Value;
				}
				else if (item.useAnimation <= 30)
				{
					toolTipLine[numLines] = Lang.tip[9].Value;
				}
				else if (item.useAnimation <= 35)
				{
					toolTipLine[numLines] = Lang.tip[10].Value;
				}
				else if (item.useAnimation <= 45)
				{
					toolTipLine[numLines] = Lang.tip[11].Value;
				}
				else if (item.useAnimation <= 55)
				{
					toolTipLine[numLines] = Lang.tip[12].Value;
				}
				else
				{
					toolTipLine[numLines] = Lang.tip[13].Value;
				}
				numLines++;
			}
			float num5 = item.knockBack;
			if (item.summon)
			{
				num5 += player[myPlayer].minionKB;
			}
			if ((player[myPlayer].magicQuiver && item.useAmmo == AmmoID.Arrow) || item.useAmmo == AmmoID.Stake)
			{
				num5 = (int)(num5 * 1.1f);
			}
			if (player[myPlayer].inventory[player[myPlayer].selectedItem].type == 3106 && item.type == 3106)
			{
				num5 += num5 * (1f - player[myPlayer].stealth);
			}
			if (num5 == 0f)
			{
				toolTipLine[numLines] = Lang.tip[14].Value;
			}
			else if ((double)num5 <= 1.5)
			{
				toolTipLine[numLines] = Lang.tip[15].Value;
			}
			else if (num5 <= 3f)
			{
				toolTipLine[numLines] = Lang.tip[16].Value;
			}
			else if (num5 <= 4f)
			{
				toolTipLine[numLines] = Lang.tip[17].Value;
			}
			else if (num5 <= 6f)
			{
				toolTipLine[numLines] = Lang.tip[18].Value;
			}
			else if (num5 <= 7f)
			{
				toolTipLine[numLines] = Lang.tip[19].Value;
			}
			else if (num5 <= 9f)
			{
				toolTipLine[numLines] = Lang.tip[20].Value;
			}
			else if (num5 <= 11f)
			{
				toolTipLine[numLines] = Lang.tip[21].Value;
			}
			else
			{
				toolTipLine[numLines] = Lang.tip[22].Value;
			}
			numLines++;
		}
		if (item.fishingPole > 0)
		{
			toolTipLine[numLines] = Language.GetTextValue("GameUI.PrecentFishingPower", item.fishingPole);
			numLines++;
			toolTipLine[numLines] = Language.GetTextValue("GameUI.BaitRequired");
			numLines++;
		}
		if (item.bait > 0)
		{
			toolTipLine[numLines] = Language.GetTextValue("GameUI.BaitPower", item.bait);
			numLines++;
		}
		if (item.headSlot > 0 || item.bodySlot > 0 || item.legSlot > 0 || item.accessory || projHook[item.shoot] || item.mountType != -1 || (item.buffType > 0 && (lightPet[item.buffType] || vanityPet[item.buffType])))
		{
			if ((item.type == 854 || item.type == 3035) && npcShop > 0)
			{
				toolTipLine[numLines] = Lang.tip[60].Value;
			}
			else
			{
				toolTipLine[numLines] = Lang.tip[23].Value;
			}
			numLines++;
		}
		if (item.tileWand > 0)
		{
			toolTipLine[numLines] = Lang.tip[52].Value + Lang.GetItemNameValue(item.tileWand);
			numLines++;
		}
		if (item.questItem)
		{
			toolTipLine[numLines] = Lang.inter[65].Value;
			numLines++;
		}
		if (item.vanity)
		{
			toolTipLine[numLines] = Lang.tip[24].Value;
			numLines++;
		}
		if (item.defense > 0)
		{
			toolTipLine[numLines] = item.defense + Lang.tip[25].Value;
			numLines++;
		}
		if (item.pick > 0)
		{
			toolTipLine[numLines] = item.pick + Lang.tip[26].Value;
			numLines++;
		}
		if (item.axe > 0)
		{
			toolTipLine[numLines] = item.axe * 5 + Lang.tip[27].Value;
			numLines++;
		}
		if (item.hammer > 0)
		{
			toolTipLine[numLines] = item.hammer + Lang.tip[28].Value;
			numLines++;
		}
		if (item.tileBoost != 0)
		{
			int tileBoost = item.tileBoost;
			if (tileBoost > 0)
			{
				toolTipLine[numLines] = "+" + tileBoost + Lang.tip[54].Value;
			}
			else
			{
				toolTipLine[numLines] = tileBoost + Lang.tip[54].Value;
			}
			numLines++;
		}
		if (item.healLife > 0)
		{
			if (item.type == 3001)
			{
				int healLife = item.healLife;
				int num6 = 120;
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.RestoresLifeRange", healLife, num6);
			}
			else
			{
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.RestoresLife", item.healLife);
			}
			numLines++;
		}
		if (item.healMana > 0)
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.RestoresMana", item.healMana);
			numLines++;
		}
		if (item.mana > 0 && ((item.type != 127 && item.type != 4347 && item.type != 4348 && item.type != 514) || !player[myPlayer].spaceGun))
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.UsesMana", (int)((float)item.mana * player[myPlayer].manaCost));
			numLines++;
		}
		if (item.createWall > 0 || item.createTile > -1 || item.type == 849)
		{
			if (ItemID.Sets.PlaceTileOnAltUse[item.type] || item.consumable)
			{
				toolTipLine[numLines] = Lang.tip[33].Value;
				numLines++;
			}
		}
		else if (item.ammo > 0 && !item.notAmmo)
		{
			toolTipLine[numLines] = Lang.tip[34].Value;
			numLines++;
		}
		else if (item.consumable && !item.chlorophyteExtractinatorConsumable)
		{
			toolTipLine[numLines] = Lang.tip[35].Value;
			numLines++;
		}
		if (item.material)
		{
			toolTipLine[numLines] = Lang.tip[36].Value;
			numLines++;
		}
		if ((item.createTile > -1 && (TileID.Sets.Wiring.IsATrigger[item.createTile] || TileID.Sets.Wiring.IsAMechanism[item.createTile])) & (item.createTile != 105 || ItemID.Sets.IsWireableStatue[item.type]))
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.Wireable");
			numLines++;
		}
		if (item.createTile == 21 || item.createTile == 467)
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.Container");
			numLines++;
		}
		if (item.createTile == 441 || item.createTile == 468)
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.WireTrigger");
			numLines++;
		}
		if (item.ToolTip != null)
		{
			for (int i = 0; i < item.ToolTip.Lines; i++)
			{
				if (i == 0 && ItemID.Sets.UsesCursedByPlanteraTooltip[item.type] && !NPC.downedPlantBoss)
				{
					toolTipLine[numLines] = Lang.tip[59].Value;
					numLines++;
				}
				else
				{
					toolTipLine[numLines] = item.ToolTip.GetLine(i);
					numLines++;
				}
			}
		}
		if (tenthAnniversaryWorld && item.type == 238)
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.WizardHatDuringAnniversary");
			numLines++;
		}
		if (getGoodWorld && item.type == 1127)
		{
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.BurningBlock");
			numLines++;
		}
		if (SpecialSeedFeatures.Mechdusa)
		{
			if (item.type == 556 || item.type == 557 || item.type == 544)
			{
				numLines--;
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.MechSummonDuringEverything");
				numLines++;
			}
		}
		else if (item.type == 5334)
		{
			numLines--;
			toolTipLine[numLines] = "";
			numLines--;
			toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.MechdusaSummonNotDuringEverything");
			numLines++;
		}
		if ((item.type == 3818 || item.type == 3819 || item.type == 3820 || item.type == 3824 || item.type == 3825 || item.type == 3826 || item.type == 3829 || item.type == 3830 || item.type == 3831 || item.type == 3832 || item.type == 3833 || item.type == 3834) && !player[myPlayer].downedDD2EventAnyDifficulty)
		{
			toolTipLine[numLines] = Lang.misc[104].Value;
			numLines++;
		}
		if (item.buffType > 0 && BuffID.Sets.IsWellFed[item.buffType] && expertMode)
		{
			toolTipLine[numLines] = Lang.misc[40].Value;
			numLines++;
		}
		if (item.buffTime > 0)
		{
			string text = ((item.buffTime / 60 < 60) ? Language.GetTextValue("CommonItemTooltip.SecondDuration", Math.Round((double)item.buffTime / 60.0)) : Language.GetTextValue("CommonItemTooltip.MinuteDuration", Math.Round((double)(item.buffTime / 60) / 60.0)));
			toolTipLine[numLines] = text;
			numLines++;
		}
		if (item.type == 3262 || item.type == 3282 || item.type == 3283 || item.type == 3284 || item.type == 3285 || item.type == 3286 || item.type == 3316 || item.type == 3315 || item.type == 3317 || item.type == 3291 || item.type == 3389)
		{
			toolTipLine[numLines] = " ";
			yoyoLogo = numLines;
			numLines++;
		}
		if (item.prefix > 0)
		{
			Item item2 = tooltipPrefixComparisonItem;
			if (item2 == null || item2.type != item.type)
			{
				item2 = new Item();
				item2.SetDefaults(item.type);
			}
			if (item2.damage != item.damage)
			{
				double num7 = (float)item.damage - (float)item2.damage;
				num7 = num7 / (double)item2.damage * 100.0;
				num7 = Math.Round(num7);
				if (num7 > 0.0)
				{
					toolTipLine[numLines] = "+" + num7 + Lang.tip[39].Value;
				}
				else
				{
					toolTipLine[numLines] = num7 + Lang.tip[39].Value;
				}
				lineColors[numLines] = ((num7 < 0.0) ? color : color2);
				numLines++;
			}
			if (item2.useAnimation != item.useAnimation)
			{
				double num8 = (float)item.useAnimation - (float)item2.useAnimation;
				num8 = num8 / (double)item2.useAnimation * 100.0;
				num8 = Math.Round(num8);
				num8 *= -1.0;
				if (num8 > 0.0)
				{
					toolTipLine[numLines] = "+" + num8 + Lang.tip[40].Value;
				}
				else
				{
					toolTipLine[numLines] = num8 + Lang.tip[40].Value;
				}
				lineColors[numLines] = ((num8 < 0.0) ? color : color2);
				numLines++;
			}
			if (item2.crit != item.crit)
			{
				double num9 = (float)item.crit - (float)item2.crit;
				if (num9 > 0.0)
				{
					toolTipLine[numLines] = "+" + num9 + Lang.tip[41].Value;
				}
				else
				{
					toolTipLine[numLines] = num9 + Lang.tip[41].Value;
				}
				lineColors[numLines] = ((num9 < 0.0) ? color : color2);
				numLines++;
			}
			if (item2.mana != item.mana)
			{
				double num10 = (float)item.mana - (float)item2.mana;
				num10 = num10 / (double)item2.mana * 100.0;
				num10 = Math.Round(num10);
				if (num10 > 0.0)
				{
					toolTipLine[numLines] = "+" + num10 + Lang.tip[42].Value;
				}
				else
				{
					toolTipLine[numLines] = num10 + Lang.tip[42].Value;
				}
				lineColors[numLines] = ((num10 > 0.0) ? color : color2);
				numLines++;
			}
			if (item2.scale != item.scale)
			{
				double num11 = item.scale - item2.scale;
				num11 = num11 / (double)item2.scale * 100.0;
				num11 = Math.Round(num11);
				if (num11 > 0.0)
				{
					toolTipLine[numLines] = "+" + num11 + Lang.tip[43].Value;
				}
				else
				{
					toolTipLine[numLines] = num11 + Lang.tip[43].Value;
				}
				lineColors[numLines] = ((num11 < 0.0) ? color : color2);
				numLines++;
			}
			if (item2.shootSpeed != item.shootSpeed)
			{
				double num12 = item.shootSpeed - item2.shootSpeed;
				num12 = num12 / (double)item2.shootSpeed * 100.0;
				num12 = Math.Round(num12);
				if (num12 > 0.0)
				{
					toolTipLine[numLines] = "+" + num12 + Lang.tip[44].Value;
				}
				else
				{
					toolTipLine[numLines] = num12 + Lang.tip[44].Value;
				}
				lineColors[numLines] = ((num12 < 0.0) ? color : color2);
				numLines++;
			}
			if (item2.knockBack != oldKB)
			{
				double num13 = oldKB - item2.knockBack;
				num13 = num13 / (double)item2.knockBack * 100.0;
				num13 = Math.Round(num13);
				if (num13 > 0.0)
				{
					toolTipLine[numLines] = "+" + num13 + Lang.tip[45].Value;
				}
				else
				{
					toolTipLine[numLines] = num13 + Lang.tip[45].Value;
				}
				lineColors[numLines] = ((num13 < 0.0) ? color : color2);
				numLines++;
			}
			if (item2.armorPenetration != item.armorPenetration)
			{
				int num14 = item.armorPenetration - item2.armorPenetration;
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.PrefixArmorPenetration", num14);
				lineColors[numLines] = ((num14 < 0) ? color : color2);
				numLines++;
			}
			if (item2.bonusTagDamage != item.bonusTagDamage)
			{
				int num15 = item.bonusTagDamage - item2.bonusTagDamage;
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.PrefixTagDamage", num15);
				lineColors[numLines] = ((num15 < 0) ? color : color2);
				numLines++;
			}
			if (item.prefix == 62)
			{
				toolTipLine[numLines] = "+1" + Lang.tip[25].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 63)
			{
				toolTipLine[numLines] = "+2" + Lang.tip[25].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 64)
			{
				toolTipLine[numLines] = "+3" + Lang.tip[25].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 65)
			{
				toolTipLine[numLines] = "+4" + Lang.tip[25].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 66)
			{
				toolTipLine[numLines] = "+20 " + Lang.tip[31].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 67)
			{
				toolTipLine[numLines] = "+2" + Lang.tip[5].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 68)
			{
				toolTipLine[numLines] = "+4" + Lang.tip[5].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 69)
			{
				toolTipLine[numLines] = "+1" + Lang.tip[39].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 70)
			{
				toolTipLine[numLines] = "+2" + Lang.tip[39].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 71)
			{
				toolTipLine[numLines] = "+3" + Lang.tip[39].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 72)
			{
				toolTipLine[numLines] = "+4" + Lang.tip[39].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 73)
			{
				toolTipLine[numLines] = "+1" + Lang.tip[46].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 74)
			{
				toolTipLine[numLines] = "+2" + Lang.tip[46].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 75)
			{
				toolTipLine[numLines] = "+3" + Lang.tip[46].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 76)
			{
				toolTipLine[numLines] = "+4" + Lang.tip[46].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 77)
			{
				toolTipLine[numLines] = "+1" + Lang.tip[47].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 78)
			{
				toolTipLine[numLines] = "+2" + Lang.tip[47].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 79)
			{
				toolTipLine[numLines] = "+3" + Lang.tip[47].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
			if (item.prefix == 80)
			{
				toolTipLine[numLines] = "+4" + Lang.tip[47].Value;
				lineColors[numLines] = color2;
				numLines++;
			}
		}
		if (true)
		{
			ArmorSetBonus[] array = ArmorSetBonuses.SetsContaining[item.type];
			if (array.Length != 0)
			{
				if (!item.wornArmor)
				{
					toolTipLine[numLines] = array[0].GetTooltipForSinglePiece(item.type);
					lineColors[numLines] = new Microsoft.Xna.Framework.Color(130, 130, 130, 190);
					numLines++;
				}
				else
				{
					ArmorSetBonus.QueryResult result = default(ArmorSetBonus.QueryResult);
					ArmorSetBonus.QueryContext context = new ArmorSetBonus.QueryContext(LocalPlayer);
					ArmorSetBonus armorSetBonus = null;
					ArmorSetBonus[] array2 = ArmorSetBonuses.SetsContaining[item.type];
					foreach (ArmorSetBonus armorSetBonus2 in array2)
					{
						if (armorSetBonus == null)
						{
							armorSetBonus = armorSetBonus2;
						}
						ArmorSetBonus.QueryResult queryResult = armorSetBonus2.QueryCount(context);
						bool flag = false;
						if (result.ItemsNeeded < queryResult.ItemsNeeded)
						{
							flag = true;
						}
						if (result.ItemsNeeded == queryResult.ItemsNeeded && result.ItemsFound < queryResult.ItemsFound)
						{
							flag = true;
						}
						if (flag)
						{
							result = queryResult;
							armorSetBonus = armorSetBonus2;
						}
					}
					toolTipLine[numLines] = armorSetBonus.GetTooltipForWornArmor(context, result);
					lineColors[numLines] = (result.Complete ? Microsoft.Xna.Framework.Color.LimeGreen : new Microsoft.Xna.Framework.Color(130, 130, 130));
					numLines++;
				}
			}
			if (player[myPlayer].setBonus != "")
			{
				toolTipLine[numLines] = Lang.tip[48].Value + " " + player[myPlayer].setBonus;
				numLines++;
			}
		}
		if (item.expert)
		{
			toolTipLine[numLines] = Language.GetTextValue("GameUI.Expert");
			numLines++;
		}
		if (item.rare == -13)
		{
			toolTipLine[numLines] = Language.GetTextValue("GameUI.Master");
			numLines++;
		}
		if ((item.tooltipContext == 0 || item.tooltipContext == 2 || item.tooltipContext == 1 || item.tooltipContext == 3 || item.tooltipContext == 4 || item.tooltipContext == 32 || item.tooltipContext == 15 || item.tooltipContext == 6 || item.tooltipContext == 22 || item.tooltipContext == 35 || item.tooltipContext == 7 || item.tooltipContext == 5 || item.tooltipContext == 29 || item.tooltipContext == 34 || item.tooltipContext == 41 || item.tooltipContext == 42 || item.tooltipContext == 43) && LocalPlayer.difficulty == 3 && LocalPlayerCreativeTracker.ItemSacrifices.TryGetSacrificeNumbers(item.type, out var amountWeHave, out var amountNeededTotal))
		{
			string teammateName;
			if (amountWeHave < amountNeededTotal)
			{
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.CreativeSacrificeNeeded", amountNeededTotal - amountWeHave);
				researchLine = numLines;
				numLines++;
			}
			else if (item.tooltipContext == 29 && LocalPlayerCreativeTracker.ItemSacrifices.TryGetTeammateUnlockCredit(item.type, out teammateName))
			{
				toolTipLine[numLines] = Language.GetTextValue("CommonItemTooltip.ItemUnlockedByTeammate", teammateName);
				researchLine = numLines;
				numLines++;
			}
		}
		string bestiaryNotes = item.BestiaryNotes;
		if (!string.IsNullOrWhiteSpace(bestiaryNotes))
		{
			string[] array3 = bestiaryNotes.Split('\n');
			foreach (string text2 in array3)
			{
				toolTipLine[numLines++] = text2;
			}
		}
	}

	private void MouseText_DrawBuffTooltip(string buffString, ref int X, ref int Y, Vector2 mouseTextSize)
	{
		Microsoft.Xna.Framework.Point p = new Microsoft.Xna.Framework.Point(X, Y);
		int num = 220;
		int num2 = 72;
		int num3 = -1;
		float num4 = 1f;
		List<Vector2> list = new List<Vector2>();
		Vector2 vector = FontAssets.MouseText.Value.MeasureString(buffString);
		list.Add(vector);
		list.Add(mouseTextSize);
		int num5 = (int)((float)(screenHeight - Y - 24 - num2) * num4) / 20;
		if (num5 < 1)
		{
			num5 = 1;
		}
		if (bannerMouseOver)
		{
			int num6 = 0;
			for (int i = 0; i < BannerSystem.MaxBannerTypes; i++)
			{
				if (BannerSystem.BannerToNPC(i) != 0 && player[myPlayer].HasNPCBannerBuff(i))
				{
					num6++;
					string nPCNameValue = Lang.GetNPCNameValue(BannerSystem.BannerToNPC(i));
					Vector2 vector2 = FontAssets.MouseText.Value.MeasureString(nPCNameValue);
					int num7 = X;
					int num8 = Y + (int)vector2.Y + num6 * 20 + 10;
					int num9 = 0;
					int num10 = num6 / num5;
					for (int j = 0; j < num10; j++)
					{
						num9++;
						num7 += num;
						num8 -= num5 * 20;
					}
					if ((float)(num7 - 24 - num) > (float)screenWidth * num4)
					{
						num3 = num6;
						break;
					}
					list.Add(new Vector2(num7, num8) + vector2 - p.ToVector2());
				}
			}
		}
		Vector2 zero = Vector2.Zero;
		foreach (Vector2 item in list)
		{
			if (zero.X < item.X)
			{
				zero.X = item.X;
			}
			if (zero.Y < item.Y)
			{
				zero.Y = item.Y;
			}
		}
		if ((float)X + zero.X + 24f > (float)screenWidth * num4)
		{
			X = (int)((float)screenWidth * num4 - zero.X - 24f);
		}
		if ((float)Y + zero.Y + 4f > (float)screenHeight * num4)
		{
			Y = (int)((float)screenHeight * num4 - zero.Y - 4f);
		}
		for (int k = 0; k < 5; k++)
		{
			int num11 = X;
			int num12 = Y + (int)mouseTextSize.Y;
			Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Black;
			switch (k)
			{
			case 0:
				num11 -= 2;
				break;
			case 1:
				num11 += 2;
				break;
			case 2:
				num12 -= 2;
				break;
			case 3:
				num12 += 2;
				break;
			default:
				color = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
				break;
			}
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, buffString, new Vector2(num11, num12), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		if (!bannerMouseOver)
		{
			return;
		}
		int num13 = 0;
		for (int l = 0; l < BannerSystem.MaxBannerTypes; l++)
		{
			if (BannerSystem.BannerToNPC(l) == 0 || !player[myPlayer].HasNPCBannerBuff(l))
			{
				continue;
			}
			num13++;
			bool flag = false;
			for (int m = 0; m < 5; m++)
			{
				int num14 = X;
				int num15 = Y + (int)mouseTextSize.Y + num13 * 20 + 10;
				int num16 = (num13 - 1) / num5;
				num14 += num * num16;
				num15 -= num5 * 20 * num16;
				string text = Lang.GetNPCNameValue(BannerSystem.BannerToNPC(l));
				if (num3 == num13)
				{
					text = Language.GetTextValue("UI.Ellipsis");
					flag = true;
				}
				Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Black;
				switch (m)
				{
				case 0:
					num14 -= 2;
					break;
				case 1:
					num14 += 2;
					break;
				case 2:
					num15 -= 2;
					break;
				case 3:
					num15 += 2;
					break;
				default:
				{
					float num17 = (float)(int)mouseTextColor / 255f;
					color2 = new Microsoft.Xna.Framework.Color((byte)(80f * num17), (byte)(255f * num17), (byte)(120f * num17), mouseTextColor);
					break;
				}
				}
				DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, text, new Vector2(num14, num15), color2, 0f, default(Vector2), 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
			}
			if (flag)
			{
				break;
			}
		}
	}

	internal void DrawFPS()
	{
		if (showFrameRate)
		{
			string text = frameRate + "fps " + updateRate + "ups";
			text = text + " (" + (Liquid.numLiquid + LiquidBuffer.numLiquidBuffer) + ")";
			text = text + " (" + (int)(gfxQuality * 100f) + "%)";
			if (netMode == 1)
			{
				text = text + " (" + Ping.CurrentPing + "ms)";
			}
			if (DebugOptions.Shared_ServerPing > 0)
			{
				text = text + " target ~" + DebugOptions.Shared_ServerPing + "ms";
			}
			if (netMode == 1 && shouldDrawNetDiagnosticsUI)
			{
				ActiveNetDiagnosticsUI.GetLastSentRecvBytes(out var sent, out var recv);
				text += $" â{(double)sent / 1024.0:0.0} â{(double)recv / 1024.0:0.0} kB/s";
			}
			string text2 = text + " " + debugWords;
			int num = 4;
			if (!gameMenu)
			{
				num = screenHeight - 24;
			}
			Vector2 vector = new Vector2(4f, num);
			Vector2 vector2 = new Vector2(0f, 0f);
			Vector2 vector3 = FontAssets.MouseText.Value.MeasureString(text2);
			if (PlayerInput.SettingsForUI.ShowGamepadHints && !gameMenu)
			{
				vector.X = (float)(screenWidth - 4) - vector3.X;
			}
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, text2, vector, new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, vector2, 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
	}

	public static void DrawGamepadInstructions()
	{
		if (drawingPlayerChat || !PlayerInput.SettingsForUI.ShowGamepadHints)
		{
			return;
		}
		string text = PlayerInput.ComposeInstructionsForGamepad();
		PlayerInput.AllowExecutionOfGamepadInstructions = false;
		if (!GamepadDisableInstructionsDisplay && text.Length > 0)
		{
			float num = 35f;
			float num2 = 1f;
			Vector2 scale = new Vector2(num2);
			if (gameMenu)
			{
				num = 55f;
			}
			if (menuMode == 0)
			{
				num += 32f;
			}
			Vector2 stringSize = ChatManager.GetStringSize(FontAssets.MouseText.Value, text, new Vector2(1f));
			float t = num2;
			Utils.Swap(ref GlyphTagHandler.GlyphsScale, ref t);
			ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, text, new Vector2(12f, (float)screenHeight - num) - stringSize * new Vector2(0f, 0f), Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, scale, -1f, num2 * 2f);
			Utils.Swap(ref GlyphTagHandler.GlyphsScale, ref t);
		}
	}

	public static Microsoft.Xna.Framework.Color shine(Microsoft.Xna.Framework.Color newColor, int type)
	{
		int num = newColor.R;
		int num2 = newColor.G;
		int num3 = newColor.B;
		float num4 = 0.6f;
		switch (type)
		{
		case 25:
			num = (int)((float)(int)newColor.R * 0.95f);
			num2 = (int)((float)(int)newColor.G * 0.85f);
			num3 = (int)((double)(int)newColor.B * 1.1);
			break;
		case 117:
			num = (int)((float)(int)newColor.R * 1.1f);
			num2 = (int)((float)(int)newColor.G * 1f);
			num3 = (int)((double)(int)newColor.B * 1.2);
			break;
		case 204:
			num4 = 0.3f + (float)(int)mouseTextColor / 300f;
			num = (int)((float)(int)newColor.R * (1.3f * num4));
			if (num > 255)
			{
				num = 255;
			}
			return new Microsoft.Xna.Framework.Color(num, num2, num3, 255);
		case 211:
			num4 = 0.3f + (float)(int)mouseTextColor / 300f;
			num2 = (int)((float)(int)newColor.G * (1.5f * num4));
			num3 = (int)((float)(int)newColor.B * (1.1f * num4));
			break;
		case 147:
		case 161:
			num = (int)((float)(int)newColor.R * 1.1f);
			num2 = (int)((float)(int)newColor.G * 1.12f);
			num3 = (int)((double)(int)newColor.B * 1.15);
			break;
		case 163:
			num = (int)((float)(int)newColor.R * 1.05f);
			num2 = (int)((float)(int)newColor.G * 1.1f);
			num3 = (int)((double)(int)newColor.B * 1.15);
			break;
		case 164:
			num = (int)((float)(int)newColor.R * 1.1f);
			num2 = (int)((float)(int)newColor.G * 1.1f);
			num3 = (int)((double)(int)newColor.B * 1.2);
			break;
		case 178:
			num4 = 0.5f;
			num = (int)((float)(int)newColor.R * (1f + num4));
			num2 = (int)((float)(int)newColor.G * (1f + num4));
			num3 = (int)((float)(int)newColor.B * (1f + num4));
			break;
		case 185:
		case 186:
			num4 = 0.3f;
			num = (int)((float)(int)newColor.R * (1f + num4));
			num2 = (int)((float)(int)newColor.G * (1f + num4));
			num3 = (int)((float)(int)newColor.B * (1f + num4));
			break;
		case 262:
		case 263:
		case 264:
		case 265:
		case 266:
		case 267:
		case 268:
			num3 += 100;
			num += 100;
			num2 += 100;
			break;
		default:
			if (tileShine2[type])
			{
				num = (int)((float)(int)newColor.R * (1f + num4));
				num2 = (int)((float)(int)newColor.G * (1f + num4));
				num3 = (int)((float)(int)newColor.B * (1f + num4));
			}
			break;
		}
		float num5 = shimmerAlpha;
		if (num5 > 0f)
		{
			num = (int)((float)num * (1f - num5) + (float)num * shimmerShine.X * num5);
			num2 = (int)((float)num2 * (1f - num5) + (float)num2 * shimmerShine.Y * num5);
			num3 = (int)((float)num3 * (1f - num5) + (float)num3 * shimmerShine.Z * num5);
		}
		if (num > 255)
		{
			num = 255;
		}
		if (num2 > 255)
		{
			num2 = 255;
		}
		if (num3 > 255)
		{
			num3 = 255;
		}
		newColor.R = (byte)num;
		newColor.G = (byte)num2;
		newColor.B = (byte)num3;
		return new Microsoft.Xna.Framework.Color((byte)num, (byte)num2, (byte)num3, newColor.A);
	}

	public static void shine(ref Vector3 newColor, int type)
	{
		float num = 0.6f;
		switch (type)
		{
		case 25:
			newColor.X *= 0.95f;
			newColor.Y *= 0.85f;
			newColor.Z *= 1.1f;
			break;
		case 117:
			newColor.X *= 1.1f;
			newColor.Z *= 1.2f;
			break;
		case 204:
			num = 0.3f + (float)(int)mouseTextColor / 300f;
			newColor.X *= 1.3f * num;
			break;
		case 211:
			num = 0.3f + (float)(int)mouseTextColor / 300f;
			newColor.Y *= 1.5f * num;
			newColor.Z *= 1.1f * num;
			break;
		case 147:
		case 161:
			newColor.X *= 1.1f;
			newColor.Y *= 1.12f;
			newColor.Z *= 1.15f;
			break;
		case 163:
			newColor.X *= 1.05f;
			newColor.Y *= 1.1f;
			newColor.Z *= 1.15f;
			break;
		case 164:
			newColor.X *= 1.1f;
			newColor.Y *= 1.1f;
			newColor.Z *= 1.2f;
			break;
		case 178:
			num = 0.5f;
			newColor.X *= 1f + num;
			newColor.Y *= 1f + num;
			newColor.Z *= 1f + num;
			break;
		case 185:
		case 186:
			num = 0.3f;
			newColor.X *= 1f + num;
			newColor.Y *= 1f + num;
			newColor.Z *= 1f + num;
			break;
		case 262:
		case 263:
		case 264:
		case 265:
		case 266:
		case 267:
		case 268:
			newColor.X += 0.39f;
			newColor.Y += 0.39f;
			newColor.Z += 0.39f;
			break;
		default:
			if (tileShine2[type])
			{
				newColor.X *= 1f + num;
				newColor.Y *= 1f + num;
				newColor.Z *= 1f + num;
			}
			break;
		}
		float num2 = shimmerAlpha;
		if (num2 > 0f)
		{
			shimmerShine.X = 1.2f;
			shimmerShine.Y = 1f;
			shimmerShine.Z = 1.6f;
			newColor.X = newColor.X * (1f - num2) + newColor.X * shimmerShine.X * num2;
			newColor.Y = newColor.Y * (1f - num2) + newColor.Y * shimmerShine.Y * num2;
			newColor.Z = newColor.Z * (1f - num2) + newColor.Z * shimmerShine.Z * num2;
			if (newColor.X > 1f)
			{
				newColor.X = 1f;
			}
			if (newColor.Y > 1f)
			{
				newColor.Y = 1f;
			}
			if (newColor.Z > 1f)
			{
				newColor.Z = 1f;
			}
		}
	}

	private void DrawTileEntities(bool solidLayer)
	{
		TilesRenderer.PostDrawTiles(solidLayer);
	}

	public void ClearCachedTileDraws()
	{
		TilesRenderer.ClearCachedTileDraws(solidLayer: false);
		TilesRenderer.ClearCachedTileDraws(solidLayer: true);
	}

	public void ResetAllContentBasedRenderTargets()
	{
		TilePaintSystem.Reset();
		for (int i = 0; i < ContentThatNeedsRenderTargets.Count; i++)
		{
			ContentThatNeedsRenderTargets[i].Reset();
		}
	}

	public static bool IsTileSpelunkable(Tile t)
	{
		return IsTileSpelunkable(t.type, t.frameX, t.frameY);
	}

	public static bool IsTileSpelunkable(ushort typeCache, short tileFrameX, short tileFrameY)
	{
		if (tileSpelunker[typeCache])
		{
			return true;
		}
		if (typeCache == 185 && tileFrameY == 18 && tileFrameX >= 576 && tileFrameX <= 882)
		{
			return true;
		}
		if (typeCache == 186 && tileFrameX >= 864 && tileFrameX <= 1170)
		{
			return true;
		}
		return false;
	}

	public static bool IsTileBiomeSightable(ushort type, short tileFrameX, short tileFrameY, ref Microsoft.Xna.Framework.Color sightColor)
	{
		if (TileID.Sets.CorruptBiomeSight[type] || (remixWorld && type == 474))
		{
			sightColor = new Microsoft.Xna.Framework.Color(200, 100, 240);
			return true;
		}
		if (TileID.Sets.CrimsonBiomeSight[type] || (remixWorld && type == 195))
		{
			sightColor = new Microsoft.Xna.Framework.Color(255, 100, 100);
			return true;
		}
		if (TileID.Sets.HallowBiomeSight[type])
		{
			sightColor = new Microsoft.Xna.Framework.Color(255, 160, 240);
			return true;
		}
		return false;
	}

	protected void DrawTiles(bool solidLayer, bool intoRenderTargets = false, int waterStyleOverride = -1)
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		try
		{
			TilesRenderer.Begin(intoRenderTargets ? RasterizerState.CullCounterClockwise : Rasterizer, intoRenderTargets ? Matrix.Identity : Transform);
			TilesRenderer.Draw(solidLayer, intoRenderTargets, waterStyleOverride);
		}
		finally
		{
			TilesRenderer.End();
		}
		if (solidLayer)
		{
			TimeLogger.DrawSolidTiles.AddTime(fromTimestamp);
		}
		else
		{
			TimeLogger.DrawNonSolidTiles.AddTime(fromTimestamp);
		}
	}

	protected void DrawGoreBehind()
	{
		for (int i = 0; i < 600; i++)
		{
			if (!gore[i].active || gore[i].type <= 0)
			{
				continue;
			}
			bool flag = false;
			if (gore[i].type < GoreID.Count && GoreID.Sets.IsDrip[gore[i].type] && (gore[i].frame < 7 || gore[i].frame > 9))
			{
				flag = true;
			}
			if (flag)
			{
				LoadGore(gore[i].type);
				if (gore[i].Frame.ColumnCount > 1 || gore[i].Frame.RowCount > 1)
				{
					Microsoft.Xna.Framework.Rectangle sourceRectangle = gore[i].Frame.GetSourceRectangle(TextureAssets.Gore[gore[i].type].Value);
					Microsoft.Xna.Framework.Color alpha = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)sourceRectangle.Width * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)sourceRectangle.Height * 0.5) / 16.0)));
					spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(sourceRectangle.Width / 2), gore[i].position.Y - screenPosition.Y + (float)(sourceRectangle.Height / 2) - 2f), sourceRectangle, alpha, gore[i].rotation, new Vector2(sourceRectangle.Width / 2, sourceRectangle.Height / 2), gore[i].scale, SpriteEffects.None, 0f);
				}
				else
				{
					Microsoft.Xna.Framework.Color alpha2 = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)TextureAssets.Gore[gore[i].type].Width() * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)TextureAssets.Gore[gore[i].type].Height() * 0.5) / 16.0)));
					spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(TextureAssets.Gore[gore[i].type].Width() / 2), gore[i].position.Y - screenPosition.Y + (float)(TextureAssets.Gore[gore[i].type].Height() / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Gore[gore[i].type].Width(), TextureAssets.Gore[gore[i].type].Height()), alpha2, gore[i].rotation, new Vector2(TextureAssets.Gore[gore[i].type].Width() / 2, TextureAssets.Gore[gore[i].type].Height() / 2), gore[i].scale, SpriteEffects.None, 0f);
				}
			}
		}
	}

	protected void DrawGore()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		drawBackGore = false;
		for (int i = 0; i < 600; i++)
		{
			if (!gore[i].active || gore[i].type <= 0)
			{
				continue;
			}
			if (gore[i].type < GoreID.Count && GoreID.Sets.IsDrip[gore[i].type] && (gore[i].frame < 7 || gore[i].frame > 9))
			{
				drawBackGore = true;
				continue;
			}
			LoadGore(gore[i].type);
			if (gore[i].Frame.ColumnCount > 1 || gore[i].Frame.RowCount > 1)
			{
				Microsoft.Xna.Framework.Rectangle sourceRectangle = gore[i].Frame.GetSourceRectangle(TextureAssets.Gore[gore[i].type].Value);
				Vector2 vector = new Vector2(0f, 0f);
				if (gore[i].type == 1217)
				{
					vector.Y += 4f;
				}
				Microsoft.Xna.Framework.Color alpha = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)sourceRectangle.Width * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)sourceRectangle.Height * 0.5) / 16.0)));
				spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(sourceRectangle.Width / 2), gore[i].position.Y - screenPosition.Y + (float)(sourceRectangle.Height / 2) - 2f) + vector, sourceRectangle, alpha, gore[i].rotation, new Vector2(sourceRectangle.Width / 2, sourceRectangle.Height / 2), gore[i].scale, SpriteEffects.None, 0f);
			}
			else
			{
				Microsoft.Xna.Framework.Color alpha2 = gore[i].GetAlpha(Lighting.GetColor((int)((double)gore[i].position.X + (double)TextureAssets.Gore[gore[i].type].Width() * 0.5) / 16, (int)(((double)gore[i].position.Y + (double)TextureAssets.Gore[gore[i].type].Height() * 0.5) / 16.0)));
				spriteBatch.Draw(TextureAssets.Gore[gore[i].type].Value, new Vector2(gore[i].position.X - screenPosition.X + (float)(TextureAssets.Gore[gore[i].type].Width() / 2), gore[i].position.Y - screenPosition.Y + (float)(TextureAssets.Gore[gore[i].type].Height() / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Gore[gore[i].type].Width(), TextureAssets.Gore[gore[i].type].Height()), alpha2, gore[i].rotation, new Vector2(TextureAssets.Gore[gore[i].type].Width() / 2, TextureAssets.Gore[gore[i].type].Height() / 2), gore[i].scale, SpriteEffects.None, 0f);
			}
		}
		TimeLogger.Gore.AddTime(fromTimestamp);
	}

	public void DrawHealthBar(float X, float Y, int Health, int MaxHealth, float alpha, float scale = 1f, bool noFlip = false)
	{
		if (Health <= 0)
		{
			return;
		}
		float num = (float)Health / (float)MaxHealth;
		if (num > 1f)
		{
			num = 1f;
		}
		int num2 = (int)(36f * num);
		float num3 = X - 18f * scale;
		float num4 = Y;
		if (player[myPlayer].gravDir == -1f && !noFlip)
		{
			num4 -= screenPosition.Y;
			num4 = screenPosition.Y + (float)screenHeight - num4;
		}
		float num5 = 0f;
		float num6 = 0f;
		float num7 = 0f;
		float num8 = 255f;
		num -= 0.1f;
		if ((double)num > 0.5)
		{
			num6 = 255f;
			num5 = 255f * (1f - num) * 2f;
		}
		else
		{
			num6 = 255f * num * 2f;
			num5 = 255f;
		}
		float num9 = 0.95f;
		num5 = num5 * alpha * num9;
		num6 = num6 * alpha * num9;
		num8 = num8 * alpha * num9;
		if (num5 < 0f)
		{
			num5 = 0f;
		}
		if (num5 > 255f)
		{
			num5 = 255f;
		}
		if (num6 < 0f)
		{
			num6 = 0f;
		}
		if (num6 > 255f)
		{
			num6 = 255f;
		}
		if (num8 < 0f)
		{
			num8 = 0f;
		}
		if (num8 > 255f)
		{
			num8 = 255f;
		}
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color((byte)num5, (byte)num6, (byte)num7, (byte)num8);
		if (num2 < 3)
		{
			num2 = 3;
		}
		if (num2 < 34)
		{
			if (num2 < 36)
			{
				spriteBatch.Draw(TextureAssets.Hb2.Value, new Vector2(num3 - screenPosition.X + (float)num2 * scale, num4 - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(2, 0, 2, TextureAssets.Hb2.Height()), color, 0f, new Vector2(0f, 0f), scale, SpriteEffects.None, 0f);
			}
			if (num2 < 34)
			{
				spriteBatch.Draw(TextureAssets.Hb2.Value, new Vector2(num3 - screenPosition.X + (float)(num2 + 2) * scale, num4 - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(num2 + 2, 0, 36 - num2 - 2, TextureAssets.Hb2.Height()), color, 0f, new Vector2(0f, 0f), scale, SpriteEffects.None, 0f);
			}
			if (num2 > 2)
			{
				spriteBatch.Draw(TextureAssets.Hb1.Value, new Vector2(num3 - screenPosition.X, num4 - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, num2 - 2, TextureAssets.Hb1.Height()), color, 0f, new Vector2(0f, 0f), scale, SpriteEffects.None, 0f);
			}
			spriteBatch.Draw(TextureAssets.Hb1.Value, new Vector2(num3 - screenPosition.X + (float)(num2 - 2) * scale, num4 - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(32, 0, 2, TextureAssets.Hb1.Height()), color, 0f, new Vector2(0f, 0f), scale, SpriteEffects.None, 0f);
		}
		else
		{
			if (num2 < 36)
			{
				spriteBatch.Draw(TextureAssets.Hb2.Value, new Vector2(num3 - screenPosition.X + (float)num2 * scale, num4 - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(num2, 0, 36 - num2, TextureAssets.Hb2.Height()), color, 0f, new Vector2(0f, 0f), scale, SpriteEffects.None, 0f);
			}
			spriteBatch.Draw(TextureAssets.Hb1.Value, new Vector2(num3 - screenPosition.X, num4 - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, num2, TextureAssets.Hb1.Height()), color, 0f, new Vector2(0f, 0f), scale, SpriteEffects.None, 0f);
		}
	}

	public static float NPCAddHeight(NPC theNPC)
	{
		float num = 0f;
		if (theNPC.type == 125)
		{
			num = 30f;
		}
		else if (theNPC.type == 54)
		{
			num = 2f;
		}
		else if (theNPC.type == 205)
		{
			num = 8f;
		}
		else if (theNPC.type == 182)
		{
			num = 24f;
		}
		else if (theNPC.type == 178)
		{
			num = 2f;
		}
		else if (theNPC.type == 126)
		{
			num = 30f;
		}
		else if (theNPC.type == 6 || theNPC.type == 173)
		{
			num = 26f;
		}
		else if (theNPC.type == 94)
		{
			num = 14f;
		}
		else if (theNPC.type == 7 || theNPC.type == 8 || theNPC.type == 9)
		{
			num = 13f;
		}
		else if (theNPC.type == 98 || theNPC.type == 99 || theNPC.type == 100)
		{
			num = 13f;
		}
		else if (theNPC.type == 95 || theNPC.type == 96 || theNPC.type == 97)
		{
			num = 13f;
		}
		else if (theNPC.type == 10 || theNPC.type == 11 || theNPC.type == 12)
		{
			num = 8f;
		}
		else if (theNPC.type == 13 || theNPC.type == 14 || theNPC.type == 15)
		{
			num = 26f;
		}
		else if (theNPC.type == 175)
		{
			num = 4f;
		}
		else if (theNPC.type == 520)
		{
			num = 2f;
		}
		else if (theNPC.type >= 412 && theNPC.type <= 414)
		{
			num = 18f;
		}
		else if (theNPC.type == 48)
		{
			num = 32f;
		}
		else if (theNPC.type == 49 || theNPC.type == 51)
		{
			num = 4f;
		}
		else if (theNPC.type == 60)
		{
			num = 10f;
		}
		else if (theNPC.type == 62 || theNPC.type == 66 || theNPC.type == 156)
		{
			num = 14f;
		}
		else if (theNPC.type == 63 || theNPC.type == 64 || theNPC.type == 103)
		{
			num = 4f;
		}
		else if (theNPC.type == 65)
		{
			num = 5f;
		}
		else if (theNPC.type == 69)
		{
			num = 4f;
		}
		else if (theNPC.type == 70)
		{
			num = -4f;
		}
		else if (theNPC.type == 72)
		{
			num = -2f;
		}
		else if (theNPC.type == 83 || theNPC.type == 84)
		{
			num = 20f;
		}
		else if (theNPC.type == 150 || theNPC.type == 151 || theNPC.type == 158)
		{
			num = 10f;
		}
		else if (theNPC.type == 152)
		{
			num = 6f;
		}
		else if (theNPC.type == 153 || theNPC.type == 154)
		{
			num = 2f;
		}
		else if (theNPC.type == 165 || theNPC.type == 237 || theNPC.type == 238 || theNPC.type == 240 || theNPC.type == 531)
		{
			num = 10f;
		}
		else if (theNPC.type == 39 || theNPC.type == 40 || theNPC.type == 41)
		{
			num = 26f;
		}
		else if (theNPC.type >= 87 && theNPC.type <= 92)
		{
			num = 56f;
		}
		else if (theNPC.type >= 134 && theNPC.type <= 136)
		{
			num = 30f;
		}
		else if (theNPC.type == 169)
		{
			num = 8f;
		}
		else if (theNPC.type == 174)
		{
			num = 6f;
		}
		else if (theNPC.type == 369)
		{
			num = 2f;
		}
		else if (theNPC.type == 376)
		{
			num = 6f;
		}
		else if (theNPC.type == 579)
		{
			num = -2f;
		}
		else if (theNPC.type == 613 || theNPC.type == 612)
		{
			num = 2f;
		}
		switch (theNPC.type)
		{
		case 269:
		case 270:
		case 271:
		case 274:
		case 277:
			num -= 2f;
			break;
		}
		if (theNPC.townNPC && theNPC.ai[0] == 5f)
		{
			num -= 4f;
			if (theNPC.type == 124)
			{
				num -= 2f;
			}
			if (theNPC.type == 637 || theNPC.type == 656 || NPCID.Sets.IsTownSlime[theNPC.type])
			{
				num -= 10f;
			}
		}
		if (theNPC.type == 671 || theNPC.type == 672 || theNPC.type == 673 || theNPC.type == 674 || theNPC.type == 675)
		{
			num += 10f;
		}
		return num * theNPC.scale;
	}

	internal void DrawProjectiles()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		CurrentDrawnEntity = null;
		CurrentDrawnEntityShader = 0;
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (!projectile.active || projectile.type <= 0 || projectile.hide || projectile.drawLayer != 0)
			{
				continue;
			}
			try
			{
				DrawProj(i);
			}
			catch (Exception e)
			{
				if (!ignoreErrors)
				{
					throw;
				}
				TimeLogger.DrawException(e);
				Main.projectile[i].active = false;
			}
		}
		CurrentDrawnEntity = null;
		CurrentDrawnEntityShader = 0;
		spriteBatch.End();
		TimeLogger.Projectiles.AddTime(fromTimestamp);
	}

	public static int GetProjectileDesiredShader(Projectile proj)
	{
		int result = 0;
		if (proj.minion && proj.owner != 255)
		{
			result = player[proj.owner].cMinion;
		}
		if (projHook[proj.type] && proj.owner != 255)
		{
			result = player[proj.owner].cGrapple;
		}
		if (projPet[proj.type] && !proj.minion && proj.owner != 255 && proj.damage == 0 && !ProjectileID.Sets.LightPet[proj.type])
		{
			result = player[proj.owner].cPet;
		}
		if (!proj.minion && proj.owner != 255 && proj.damage == 0 && ProjectileID.Sets.LightPet[proj.type])
		{
			result = player[proj.owner].cLight;
		}
		if (proj.owner != 255)
		{
			switch (proj.type)
			{
			case 623:
			case 1020:
			case 1105:
				result = player[proj.owner].cPet;
				break;
			case 818:
				result = player[proj.owner].cMinion;
				break;
			}
		}
		return result;
	}

	private void RefreshPlayerDrawOrder()
	{
		_playersThatDrawBehindNPCs.Clear();
		_playersThatDrawAfterProjectiles.Clear();
		if (gameMenu)
		{
			return;
		}
		Player player = null;
		for (int i = 0; i < 255; i++)
		{
			player = Main.player[i];
			if (i != myPlayer && player.active && !player.outOfRange)
			{
				if (player.isLockedToATile)
				{
					_playersThatDrawBehindNPCs.Add(player);
				}
				else
				{
					_playersThatDrawAfterProjectiles.Add(player);
				}
			}
		}
		player = LocalPlayer;
		if (player.isLockedToATile)
		{
			_playersThatDrawBehindNPCs.Add(player);
		}
		else
		{
			_playersThatDrawAfterProjectiles.Add(player);
		}
	}

	protected void DrawPlayers_BehindNPCs()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		PotionOfReturnRenderer.DrawPlayers(Camera, _playersThatDrawBehindNPCs.Where((Player p) => p.PotionOfReturnOriginalUsePosition.HasValue));
		PlayerRenderer.DrawPlayers(Camera, _playersThatDrawBehindNPCs);
		TimeLogger.Players.AddTime(fromTimestamp);
	}

	protected void DrawPlayers_AfterProjectiles()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		PotionOfReturnRenderer.DrawPlayers(Camera, _playersThatDrawAfterProjectiles.Where((Player p) => p.PotionOfReturnOriginalUsePosition.HasValue));
		PlayerRenderer.DrawPlayers(Camera, _playersThatDrawAfterProjectiles);
		TimeLogger.Players.AddTime(fromTimestamp);
	}

	protected void DrawElderEye(SpriteBatch spriteBatch, Vector2 worldPosition, float opacity, float scale, int frameNumber, Microsoft.Xna.Framework.Color passedColor)
	{
		Texture2D value = TextureAssets.Extra[78].Value;
		Vector2 origin = new Vector2(68f, 94f);
		Microsoft.Xna.Framework.Rectangle value2 = value.Frame(1, 8, 0, frameNumber);
		Vector2 position = worldPosition - screenPosition;
		passedColor *= opacity;
		spriteBatch.Draw(value, position, value2, passedColor, 0f, origin, scale, SpriteEffects.None, 0f);
	}

	internal void DrawNPCs(bool behindTiles = false)
	{
		if (!behindTiles)
		{
			LeashedEntity.DrawEntities();
		}
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		bool flag = false;
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X - 800, (int)screenPosition.Y - 800, screenWidth + 1600, screenHeight + 1600);
		for (int num = maxNPCs - 1; num >= 0; num--)
		{
			try
			{
				if (npc[num].active && npc[num].type > 0 && npc[num].type < NPCID.Count && !npc[num].hide)
				{
					npc[num].position += npc[num].netOffset;
					if (npc[num].behindTiles == behindTiles)
					{
						if (npc[num].type == 125 || npc[num].type == 126)
						{
							if (!NPC.IsMechQueenUp && !flag)
							{
								flag = true;
								for (int i = 0; i < maxNPCs; i++)
								{
									if (!npc[i].active || num == i || (npc[i].type != 125 && npc[i].type != 126))
									{
										continue;
									}
									float scale = npc[i].scale;
									float x = npc[i].Center.X;
									float num2 = npc[i].Bottom.Y - (float)npc[i].height * 0.5f * scale;
									float x2 = npc[num].Center.X;
									float y = npc[num].Bottom.Y - (float)npc[num].height * 0.5f * scale;
									Vector2 vector = new Vector2(x2, y);
									float num3 = x - vector.X;
									float num4 = num2 - vector.Y;
									float rotation = (float)Math.Atan2(num4, num3) - 1.57f;
									bool flag2 = true;
									float num5 = (float)Math.Sqrt(num3 * num3 + num4 * num4);
									if (num5 > 2000f)
									{
										flag2 = false;
									}
									float num6 = 40f * scale;
									while (flag2)
									{
										num5 = (float)Math.Sqrt(num3 * num3 + num4 * num4);
										if (num5 < num6)
										{
											flag2 = false;
											continue;
										}
										num5 = (float)TextureAssets.Chain12.Height() * scale / num5;
										num3 *= num5;
										num4 *= num5;
										vector.X += num3;
										vector.Y += num4;
										num3 = x - vector.X;
										num4 = num2 - vector.Y;
										Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)vector.X / 16, (int)(vector.Y / 16f));
										spriteBatch.Draw(TextureAssets.Chain12.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain12.Width(), TextureAssets.Chain12.Height()), color, rotation, new Vector2((float)TextureAssets.Chain12.Width() * 0.5f, (float)TextureAssets.Chain12.Height() * 0.5f), scale, SpriteEffects.None, 0f);
									}
								}
							}
						}
						else if (npc[num].type == 263 && npc[num].aiStyle == 52 && NPC.plantBoss >= 0)
						{
							Vector2 vector2 = new Vector2(npc[num].position.X + (float)(npc[num].width / 2), npc[num].position.Y + (float)(npc[num].height / 2));
							float num7 = npc[NPC.plantBoss].Center.X - vector2.X;
							float num8 = npc[NPC.plantBoss].Center.Y - vector2.Y;
							float rotation2 = (float)Math.Atan2(num8, num7) - 1.57f;
							bool flag3 = true;
							while (flag3)
							{
								int num9 = 16;
								int num10 = 32;
								float num11 = (float)Math.Sqrt(num7 * num7 + num8 * num8);
								if (num11 < (float)num10)
								{
									num9 = (int)num11 - num10 + num9;
									flag3 = false;
								}
								num11 = (float)num9 / num11;
								num7 *= num11;
								num8 *= num11;
								vector2.X += num7;
								vector2.Y += num8;
								num7 = npc[NPC.plantBoss].Center.X - vector2.X + npc[NPC.plantBoss].netOffset.X;
								num8 = npc[NPC.plantBoss].Center.Y - vector2.Y + npc[NPC.plantBoss].netOffset.Y;
								Microsoft.Xna.Framework.Color color2 = Lighting.GetColor((int)vector2.X / 16, (int)(vector2.Y / 16f));
								spriteBatch.Draw(TextureAssets.Chain26.Value, new Vector2(vector2.X - screenPosition.X, vector2.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain26.Width(), num9), color2, rotation2, new Vector2((float)TextureAssets.Chain26.Width() * 0.5f, (float)TextureAssets.Chain26.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
							}
						}
						else if (npc[num].type == 264 && npc[num].aiStyle == 53 && NPC.plantBoss >= 0)
						{
							int num12 = NPC.plantBoss;
							if (npc[num].ai[3] > 0f)
							{
								num12 = (int)npc[num].ai[3] - 1;
							}
							Vector2 vector3 = new Vector2(npc[num].position.X + (float)(npc[num].width / 2), npc[num].position.Y + (float)(npc[num].height / 2));
							float num13 = npc[num12].Center.X - vector3.X;
							float num14 = npc[num12].Center.Y - vector3.Y;
							float rotation3 = (float)Math.Atan2(num14, num13) - 1.57f;
							bool flag4 = true;
							while (flag4)
							{
								int num15 = 16;
								int num16 = 32;
								float num17 = (float)Math.Sqrt(num13 * num13 + num14 * num14);
								if (num17 < (float)num16)
								{
									num15 = (int)num17 - num16 + num15;
									flag4 = false;
								}
								num17 = (float)num15 / num17;
								num13 *= num17;
								num14 *= num17;
								vector3.X += num13;
								vector3.Y += num14;
								num13 = npc[num12].Center.X - vector3.X + npc[num12].netOffset.X;
								num14 = npc[num12].Center.Y - vector3.Y + npc[num12].netOffset.Y;
								Microsoft.Xna.Framework.Color color3 = Lighting.GetColor((int)vector3.X / 16, (int)(vector3.Y / 16f));
								spriteBatch.Draw(TextureAssets.Chain27.Value, new Vector2(vector3.X - screenPosition.X, vector3.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain27.Width(), num15), color3, rotation3, new Vector2((float)TextureAssets.Chain27.Width() * 0.5f, (float)TextureAssets.Chain27.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
							}
						}
						if (NPCID.Sets.MustAlwaysDraw[npc[num].type] || rectangle.Intersects(new Microsoft.Xna.Framework.Rectangle((int)npc[num].position.X, (int)npc[num].position.Y, npc[num].width, npc[num].height)))
						{
							DrawNPCCheckAlt(npc[num]);
							DrawNPC(num, behindTiles);
						}
					}
					npc[num].position -= npc[num].netOffset;
				}
			}
			catch
			{
				npc[num].active = false;
			}
		}
		TimeLogger.NPCs.AddTime(fromTimestamp);
	}

	protected void DrawNPCCheckAlt(NPC n)
	{
		if (TownNPCProfiles.Instance.GetProfile(n.type, out var profile))
		{
			TextureAssets.Npc[n.type] = profile.GetTextureNPCShouldUse(n);
		}
	}

	protected void DrawNPC(int iNPCIndex, bool behindTiles)
	{
		NPC rCurrentNPC = npc[iNPCIndex];
		Vector2 screenPos = screenPosition;
		DrawNPCDirect(spriteBatch, rCurrentNPC, behindTiles, screenPos);
	}

	public void DrawNPCDirect_QueenSlimeWings(NPC rCurrentNPC, SpriteBatch mySpriteBatch, Vector2 screenPos, Vector2 drawCenter, Microsoft.Xna.Framework.Color originColor)
	{
		Texture2D value = TextureAssets.Extra[185].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 4, 0, (int)rCurrentNPC.localAI[3] / 6);
		float scale = 0.8f;
		for (int i = 0; i < 2; i++)
		{
			float x = 1f;
			float num = 0f;
			SpriteEffects effects = SpriteEffects.None;
			if (i == 1)
			{
				x = 0f;
				num = 0f - num + 2f;
				effects = SpriteEffects.FlipHorizontally;
			}
			Vector2 origin = rectangle.Size() * new Vector2(x, 0.5f);
			Vector2 vector = new Vector2(drawCenter.X + num, drawCenter.Y);
			if (rCurrentNPC.rotation != 0f)
			{
				vector = vector.RotatedBy(rCurrentNPC.rotation, rCurrentNPC.Bottom);
			}
			vector -= screenPos;
			float num2 = MathHelper.Clamp(rCurrentNPC.velocity.Y, -6f, 6f) * -0.1f;
			if (i == 0)
			{
				num2 *= -1f;
			}
			mySpriteBatch.Draw(value, vector, rectangle, originColor, rCurrentNPC.rotation + num2, origin, scale, effects, 0f);
		}
	}

	public void DrawNPCDirect(SpriteBatch mySpriteBatch, NPC rCurrentNPC, bool behindTiles, Vector2 screenPos)
	{
		int type = rCurrentNPC.type;
		rCurrentNPC.SetFrameSize();
		if (rCurrentNPC.realLife == -1 && rCurrentNPC.life >= rCurrentNPC.lifeMax && !rCurrentNPC.boss)
		{
			bool flag = Lighting.GetColor((int)((double)rCurrentNPC.position.X + (double)rCurrentNPC.width * 0.5) / 16, (int)(((double)rCurrentNPC.position.Y + (double)rCurrentNPC.height * 0.5) / 16.0)).ToVector3().Length() > 0.4325f;
			bool flag2 = false;
			if (LockOnHelper.AimedTarget == rCurrentNPC)
			{
				flag2 = true;
			}
			else if (rCurrentNPC.Distance(Main.player[myPlayer].Center) < 350f && flag)
			{
				flag2 = true;
			}
			if (flag2 && rCurrentNPC.lifeMax < 5)
			{
				flag2 = false;
			}
			if (flag2 && rCurrentNPC.aiStyle == 25 && rCurrentNPC.ai[0] == 0f)
			{
				flag2 = false;
			}
			if (flag2)
			{
				rCurrentNPC.nameOver = MathHelper.Clamp(rCurrentNPC.nameOver + 0.025f, 0f, 1f);
			}
			else
			{
				rCurrentNPC.nameOver = MathHelper.Clamp(rCurrentNPC.nameOver - 0.025f, 0f, 1f);
			}
		}
		else
		{
			rCurrentNPC.nameOver = MathHelper.Clamp(rCurrentNPC.nameOver - 0.025f, 0f, 1f);
		}
		if (type == 1 && rCurrentNPC.ai[0] == -999f)
		{
			return;
		}
		if (type == 101)
		{
			bool flag3 = true;
			Vector2 vector = new Vector2(rCurrentNPC.position.X + (float)(rCurrentNPC.width / 2), rCurrentNPC.position.Y + (float)(rCurrentNPC.height / 2));
			float num = rCurrentNPC.ai[0] * 16f + 8f - vector.X;
			float num2 = rCurrentNPC.ai[1] * 16f + 8f - vector.Y;
			float rotation = (float)Math.Atan2(num2, num) - 1.57f;
			bool flag4 = true;
			while (flag4)
			{
				float num3 = 0.75f;
				int height = 28;
				float num4 = (float)Math.Sqrt(num * num + num2 * num2);
				if (num4 < 28f * num3)
				{
					height = (int)num4 - 40 + 28;
					flag4 = false;
				}
				num4 = 20f * num3 / num4;
				num *= num4;
				num2 *= num4;
				vector.X += num;
				vector.Y += num2;
				num = rCurrentNPC.ai[0] * 16f + 8f - vector.X;
				num2 = rCurrentNPC.ai[1] * 16f + 8f - vector.Y;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)vector.X / 16, (int)(vector.Y / 16f));
				if (rCurrentNPC.IsABestiaryIconDummy)
				{
					color = rCurrentNPC.GetBestiaryEntryColor();
				}
				if (!flag3)
				{
					flag3 = true;
					mySpriteBatch.Draw(TextureAssets.Chain10.Value, new Vector2(vector.X - screenPos.X, vector.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain10.Width(), height), color, rotation, new Vector2((float)TextureAssets.Chain10.Width() * 0.5f, (float)TextureAssets.Chain10.Height() * 0.5f), num3, SpriteEffects.None, 0f);
				}
				else
				{
					flag3 = false;
					mySpriteBatch.Draw(TextureAssets.Chain11.Value, new Vector2(vector.X - screenPos.X, vector.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain10.Width(), height), color, rotation, new Vector2((float)TextureAssets.Chain10.Width() * 0.5f, (float)TextureAssets.Chain10.Height() * 0.5f), num3, SpriteEffects.None, 0f);
				}
			}
		}
		else if (rCurrentNPC.aiStyle == 13)
		{
			Vector2 vector2 = new Vector2(rCurrentNPC.position.X + (float)(rCurrentNPC.width / 2), rCurrentNPC.position.Y + (float)(rCurrentNPC.height / 2));
			float num5 = rCurrentNPC.ai[0] * 16f + 8f - vector2.X;
			float num6 = rCurrentNPC.ai[1] * 16f + 8f - vector2.Y;
			float rotation2 = (float)Math.Atan2(num6, num5) - 1.57f;
			bool flag5 = true;
			while (flag5)
			{
				int num7 = 28;
				int num8 = 40;
				if (type == 259 || type == 260)
				{
					num8 = 20;
					num7 = 12;
				}
				float num9 = (float)Math.Sqrt(num5 * num5 + num6 * num6);
				if (num9 < (float)num8)
				{
					num7 = (int)num9 - num8 + num7;
					flag5 = false;
				}
				num9 = (float)num7 / num9;
				num5 *= num9;
				num6 *= num9;
				vector2.X += num5;
				vector2.Y += num6;
				num5 = rCurrentNPC.ai[0] * 16f + 8f - vector2.X;
				num6 = rCurrentNPC.ai[1] * 16f + 8f - vector2.Y;
				Microsoft.Xna.Framework.Color color2 = Lighting.GetColor((int)vector2.X / 16, (int)(vector2.Y / 16f));
				if (rCurrentNPC.IsABestiaryIconDummy)
				{
					color2 = rCurrentNPC.GetBestiaryEntryColor();
				}
				if (type == 259 || type == 260)
				{
					color2.B = byte.MaxValue;
					if (color2.R < 100)
					{
						color2.R = 100;
					}
					if (color2.G < 150)
					{
						color2.G = 150;
					}
				}
				switch (type)
				{
				case 56:
					mySpriteBatch.Draw(TextureAssets.Chain5.Value, new Vector2(vector2.X - screenPos.X, vector2.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain4.Width(), num7), color2, rotation2, new Vector2((float)TextureAssets.Chain4.Width() * 0.5f, (float)TextureAssets.Chain4.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
					break;
				case 175:
					mySpriteBatch.Draw(TextureAssets.Chain14.Value, new Vector2(vector2.X - screenPos.X, vector2.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain14.Width(), num7), color2, rotation2, new Vector2((float)TextureAssets.Chain14.Width() * 0.5f, (float)TextureAssets.Chain14.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
					break;
				case 259:
					mySpriteBatch.Draw(TextureAssets.Chain24.Value, new Vector2(vector2.X - screenPos.X, vector2.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain24.Width(), num7), color2, rotation2, new Vector2((float)TextureAssets.Chain24.Width() * 0.5f, (float)TextureAssets.Chain24.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
					break;
				case 260:
					mySpriteBatch.Draw(TextureAssets.Chain25.Value, new Vector2(vector2.X - screenPos.X, vector2.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain25.Width(), num7), color2, rotation2, new Vector2((float)TextureAssets.Chain25.Width() * 0.5f, (float)TextureAssets.Chain25.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
					break;
				default:
					mySpriteBatch.Draw(TextureAssets.Chain4.Value, new Vector2(vector2.X - screenPos.X, vector2.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain4.Width(), num7), color2, rotation2, new Vector2((float)TextureAssets.Chain4.Width() * 0.5f, (float)TextureAssets.Chain4.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
					break;
				}
			}
		}
		if (type == 327)
		{
			float rotation3 = 0f;
			Vector2 vector3 = new Vector2(rCurrentNPC.Center.X, rCurrentNPC.Center.Y + 80f);
			int num10 = (int)rCurrentNPC.localAI[1];
			Microsoft.Xna.Framework.Color color3 = ((!rCurrentNPC.IsABestiaryIconDummy) ? Lighting.GetColor((int)vector3.X / 16, (int)(vector3.Y / 16f)) : rCurrentNPC.GetBestiaryEntryColor());
			mySpriteBatch.Draw(TextureAssets.PumpkingCloak.Value, new Vector2(vector3.X - screenPos.X, vector3.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.PumpkingCloak.Height() / 5 * num10, TextureAssets.PumpkingCloak.Width(), TextureAssets.PumpkingCloak.Height() / 5), color3, rotation3, new Vector2((float)TextureAssets.PumpkingCloak.Width() * 0.5f, (float)TextureAssets.PumpkingCloak.Height() * 0.5f / 5f), 1f, SpriteEffects.None, 0f);
		}
		if (type == 328)
		{
			Vector2 vector4 = new Vector2(rCurrentNPC.position.X + (float)rCurrentNPC.width * 0.5f - 5f * rCurrentNPC.ai[0], rCurrentNPC.position.Y + 20f);
			for (int i = 0; i < 2; i++)
			{
				float num11 = npc[(int)rCurrentNPC.ai[1]].position.X + (float)(npc[(int)rCurrentNPC.ai[1]].width / 2) - vector4.X;
				float num12 = npc[(int)rCurrentNPC.ai[1]].position.Y + (float)(npc[(int)rCurrentNPC.ai[1]].height / 2) - 30f - vector4.Y;
				float num13 = 0f;
				if (i == 0)
				{
					num11 -= 200f * rCurrentNPC.ai[0];
					num12 += 130f;
					num13 = (float)Math.Sqrt(num11 * num11 + num12 * num12);
					num13 = 92f / num13;
					vector4.X += num11 * num13;
					vector4.Y += num12 * num13;
				}
				else
				{
					num11 -= 50f * rCurrentNPC.ai[0];
					num12 += 80f;
					num13 = (float)Math.Sqrt(num11 * num11 + num12 * num12);
					num13 = 60f / num13;
					vector4.X += num11 * num13;
					vector4.Y += num12 * num13;
				}
				float rotation4 = (float)Math.Atan2(num12, num11) - 1.57f;
				Microsoft.Xna.Framework.Color color4 = Lighting.GetColor((int)vector4.X / 16, (int)(vector4.Y / 16f));
				mySpriteBatch.Draw(TextureAssets.PumpkingArm.Value, new Vector2(vector4.X - screenPos.X, vector4.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.PumpkingArm.Width(), TextureAssets.PumpkingArm.Height()), color4, rotation4, new Vector2((float)TextureAssets.PumpkingArm.Width() * 0.5f, (float)TextureAssets.PumpkingArm.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
				if (i == 0)
				{
					vector4.X += num11 * num13 / 2f;
					vector4.Y += num12 * num13 / 2f;
				}
			}
		}
		if (type == 36)
		{
			Vector2 vector5 = new Vector2(rCurrentNPC.position.X + (float)rCurrentNPC.width * 0.5f - 5f * rCurrentNPC.ai[0], rCurrentNPC.position.Y + 20f);
			for (int j = 0; j < 2; j++)
			{
				float num14 = npc[(int)rCurrentNPC.ai[1]].position.X + (float)(npc[(int)rCurrentNPC.ai[1]].width / 2) - vector5.X;
				float num15 = npc[(int)rCurrentNPC.ai[1]].position.Y + (float)(npc[(int)rCurrentNPC.ai[1]].height / 2) - vector5.Y;
				float num16 = 0f;
				if (j == 0)
				{
					num14 -= 200f * rCurrentNPC.ai[0];
					num15 += 130f;
					num16 = (float)Math.Sqrt(num14 * num14 + num15 * num15);
					num16 = 92f / num16;
					vector5.X += num14 * num16;
					vector5.Y += num15 * num16;
				}
				else
				{
					num14 -= 50f * rCurrentNPC.ai[0];
					num15 += 80f;
					num16 = (float)Math.Sqrt(num14 * num14 + num15 * num15);
					num16 = 60f / num16;
					vector5.X += num14 * num16;
					vector5.Y += num15 * num16;
				}
				float rotation5 = (float)Math.Atan2(num15, num14) - 1.57f;
				Microsoft.Xna.Framework.Color color5 = Lighting.GetColor((int)vector5.X / 16, (int)(vector5.Y / 16f));
				if (rCurrentNPC.localAI[3] == 1f)
				{
					mySpriteBatch.Draw(TextureAssets.BoneArm3.Value, new Vector2(vector5.X - screenPos.X, vector5.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.BoneArm.Width(), TextureAssets.BoneArm.Height()), color5, rotation5, new Vector2((float)TextureAssets.BoneArm.Width() * 0.5f, (float)TextureAssets.BoneArm.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
				}
				else
				{
					mySpriteBatch.Draw(TextureAssets.BoneArm.Value, new Vector2(vector5.X - screenPos.X, vector5.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.BoneArm.Width(), TextureAssets.BoneArm.Height()), color5, rotation5, new Vector2((float)TextureAssets.BoneArm.Width() * 0.5f, (float)TextureAssets.BoneArm.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
				}
				if (j == 0)
				{
					vector5.X += num14 * num16 / 2f;
					vector5.Y += num15 * num16 / 2f;
				}
				else if (base.IsActive)
				{
					vector5.X += num14 * num16 - 16f;
					vector5.Y += num15 * num16 - 6f;
					int num17 = Dust.NewDust(new Vector2(vector5.X, vector5.Y), 30, 10, 5, num14 * 0.02f, num15 * 0.02f, 0, default(Microsoft.Xna.Framework.Color), 2f);
					dust[num17].noGravity = true;
				}
			}
		}
		if (rCurrentNPC.aiStyle == 47)
		{
			float scale = rCurrentNPC.scale;
			Vector2 vector6 = new Vector2(rCurrentNPC.Center.X, rCurrentNPC.Center.Y);
			Vector2 center = rCurrentNPC.Center;
			if (NPC.golemBoss != -1)
			{
				center = npc[NPC.golemBoss].Center;
			}
			float num18 = center.X - vector6.X;
			float num19 = center.Y - vector6.Y;
			num19 -= 7f * scale;
			num18 = ((type != 247) ? (num18 + 66f * scale) : (num18 - 70f * scale));
			float rotation6 = (float)Math.Atan2(num19, num18) - 1.57f;
			bool flag6 = true;
			while (flag6)
			{
				float num20 = (float)Math.Sqrt(num18 * num18 + num19 * num19);
				if (num20 < 16f)
				{
					flag6 = false;
					continue;
				}
				num20 = 16f * scale / num20;
				num18 *= num20;
				num19 *= num20;
				vector6.X += num18;
				vector6.Y += num19;
				num18 = center.X - vector6.X;
				num19 = center.Y - vector6.Y;
				num19 -= 7f * scale;
				num18 = ((type != 247) ? (num18 + 66f * scale) : (num18 - 70f * scale));
				if (getGoodWorld)
				{
					num19 += 8f;
				}
				Microsoft.Xna.Framework.Color color6 = Lighting.GetColor((int)vector6.X / 16, (int)(vector6.Y / 16f));
				mySpriteBatch.Draw(TextureAssets.Chain21.Value, new Vector2(vector6.X - screenPos.X, vector6.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain21.Width(), TextureAssets.Chain21.Height()), color6, rotation6, new Vector2((float)TextureAssets.Chain21.Width() * 0.5f, (float)TextureAssets.Chain21.Height() * 0.5f), scale, SpriteEffects.None, 0f);
			}
		}
		if (rCurrentNPC.aiStyle >= 33 && rCurrentNPC.aiStyle <= 36)
		{
			Vector2 vector7 = new Vector2(rCurrentNPC.position.X + (float)rCurrentNPC.width * 0.5f - 5f * rCurrentNPC.ai[0], rCurrentNPC.position.Y + 20f);
			for (int k = 0; k < 2; k++)
			{
				float num21 = npc[(int)rCurrentNPC.ai[1]].position.X + (float)(npc[(int)rCurrentNPC.ai[1]].width / 2) - vector7.X;
				float num22 = npc[(int)rCurrentNPC.ai[1]].position.Y + (float)(npc[(int)rCurrentNPC.ai[1]].height / 2) - vector7.Y;
				float num23 = 0f;
				if (k == 0)
				{
					num21 -= 200f * rCurrentNPC.ai[0];
					num22 += 130f;
					num23 = (float)Math.Sqrt(num21 * num21 + num22 * num22);
					num23 = 92f / num23;
					vector7.X += num21 * num23;
					vector7.Y += num22 * num23;
				}
				else
				{
					num21 -= 50f * rCurrentNPC.ai[0];
					num22 += 80f;
					num23 = (float)Math.Sqrt(num21 * num21 + num22 * num22);
					num23 = 60f / num23;
					vector7.X += num21 * num23;
					vector7.Y += num22 * num23;
				}
				float rotation7 = (float)Math.Atan2(num22, num21) - 1.57f;
				Microsoft.Xna.Framework.Color color7 = Lighting.GetColor((int)vector7.X / 16, (int)(vector7.Y / 16f));
				mySpriteBatch.Draw(TextureAssets.BoneArm2.Value, new Vector2(vector7.X - screenPos.X, vector7.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.BoneArm.Width(), TextureAssets.BoneArm.Height()), color7, rotation7, new Vector2((float)TextureAssets.BoneArm.Width() * 0.5f, (float)TextureAssets.BoneArm.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
				if (k == 0)
				{
					vector7.X += num21 * num23 / 2f;
					vector7.Y += num22 * num23 / 2f;
				}
				else if (base.IsActive)
				{
					vector7.X += num21 * num23 - 16f;
					vector7.Y += num22 * num23 - 6f;
					int num24 = Dust.NewDust(new Vector2(vector7.X, vector7.Y), 30, 10, 6, num21 * 0.02f, num22 * 0.02f, 0, default(Microsoft.Xna.Framework.Color), 2.5f);
					dust[num24].noGravity = true;
				}
			}
		}
		if (type == 693)
		{
			float num25 = rCurrentNPC.localAI[1];
			float num26 = num25 - 60f;
			float num27 = rCurrentNPC.localAI[0];
			Texture2D value = TextureAssets.Extra[289].Value;
			float num28 = 1f;
			float num29 = rCurrentNPC.localAI[3];
			float num30 = num27 * 0.016f * num29;
			float num31 = 1f;
			float num32 = rCurrentNPC.localAI[2] / 10f;
			if (num32 > 0f)
			{
				num28 += num32 * 0.2f;
				num31 -= num32 * 0.25f;
			}
			Microsoft.Xna.Framework.Color color8 = new Microsoft.Xna.Framework.Color(num31, num31, num31, num31 / 2f);
			if (num27 < 60f)
			{
				float num33 = Utils.Remap(num27, 0f, 60f, 0f, 1f);
				byte b = (color8.R = (byte)((num28 = num33 * num33) * 255f));
				color8.G = b;
				color8.B = b;
				color8.A = (byte)(b / 2);
			}
			else if (num27 > num26)
			{
				float num34 = Utils.Remap(num27, num26, num25, 0f, 1f);
				num34 *= num34;
				num30 += num34 * 1.7f * num29;
				num28 += num34;
				byte b3 = (color8.R = (byte)((1f - num34) * 255f));
				color8.G = b3;
				color8.B = b3;
				color8.A = (byte)(b3 / 2);
			}
			mySpriteBatch.Draw(value, rCurrentNPC.Top - screenPos, null, color8, num30, value.Size() * 0.5f, num28, SpriteEffects.None, 0f);
		}
		if (rCurrentNPC.aiStyle == 20)
		{
			Vector2 vector8 = new Vector2(rCurrentNPC.position.X + (float)(rCurrentNPC.width / 2), rCurrentNPC.position.Y + (float)(rCurrentNPC.height / 2));
			float num35 = rCurrentNPC.ai[1] - vector8.X;
			float num36 = rCurrentNPC.ai[2] - vector8.Y;
			float num37 = (rCurrentNPC.rotation = (float)Math.Atan2(num36, num35) - 1.57f);
			bool flag7 = true;
			while (flag7)
			{
				int height2 = 12;
				float num38 = (float)Math.Sqrt(num35 * num35 + num36 * num36);
				if (num38 < 20f)
				{
					height2 = (int)num38 - 20 + 12;
					flag7 = false;
				}
				num38 = 12f / num38;
				num35 *= num38;
				num36 *= num38;
				vector8.X += num35;
				vector8.Y += num36;
				num35 = rCurrentNPC.ai[1] - vector8.X;
				num36 = rCurrentNPC.ai[2] - vector8.Y;
				Microsoft.Xna.Framework.Color color9 = Lighting.GetColor((int)vector8.X / 16, (int)(vector8.Y / 16f));
				mySpriteBatch.Draw(TextureAssets.Chain.Value, new Vector2(vector8.X - screenPos.X, vector8.Y - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain.Width(), height2), color9, num37, new Vector2((float)TextureAssets.Chain.Width() * 0.5f, (float)TextureAssets.Chain.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
			}
			mySpriteBatch.Draw(TextureAssets.SpikeBase.Value, new Vector2(rCurrentNPC.ai[1] - screenPos.X, rCurrentNPC.ai[2] - screenPos.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.SpikeBase.Width(), TextureAssets.SpikeBase.Height()), Lighting.GetColor((int)rCurrentNPC.ai[1] / 16, (int)(rCurrentNPC.ai[2] / 16f)), num37 - 0.75f, new Vector2((float)TextureAssets.SpikeBase.Width() * 0.5f, (float)TextureAssets.SpikeBase.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
		}
		Microsoft.Xna.Framework.Color npcColor = Lighting.GetColor((int)((double)rCurrentNPC.position.X + (double)rCurrentNPC.width * 0.5) / 16, (int)(((double)rCurrentNPC.position.Y + (double)rCurrentNPC.height * 0.5) / 16.0));
		if (rCurrentNPC.IsABestiaryIconDummy)
		{
			npcColor = rCurrentNPC.GetBestiaryEntryColor();
		}
		if (type >= 277 && type <= 280)
		{
			if (npcColor.R < byte.MaxValue)
			{
				npcColor.R = byte.MaxValue;
			}
			if (npcColor.G < 175)
			{
				npcColor.G = 175;
			}
		}
		if (type == -4)
		{
			int r = npcColor.R;
			int g = npcColor.G;
			int b5 = npcColor.B;
			r *= 2;
			if (r > 255)
			{
				r = 255;
			}
			g *= 2;
			if (g > 255)
			{
				g = 255;
			}
			b5 *= 2;
			if (b5 > 255)
			{
				b5 = 255;
			}
			npcColor = new Microsoft.Xna.Framework.Color(r, g, b5);
		}
		if (behindTiles && type != 113 && type != 114)
		{
			int num39 = (int)((rCurrentNPC.position.X - 8f) / 16f);
			int num40 = (int)((rCurrentNPC.position.X + (float)rCurrentNPC.width + 8f) / 16f);
			int num41 = (int)((rCurrentNPC.position.Y - 8f) / 16f);
			int num42 = (int)((rCurrentNPC.position.Y + (float)rCurrentNPC.height + 8f) / 16f);
			for (int l = num39; l <= num40; l++)
			{
				for (int m = num41; m <= num42; m++)
				{
					if (Lighting.Brightness(l, m) == 0f)
					{
						npcColor = Microsoft.Xna.Framework.Color.Black;
					}
				}
			}
		}
		npcColor = rCurrentNPC.GetNPCColorTintedByBuffs(npcColor);
		if (type == 50)
		{
			Vector2 zero = Vector2.Zero;
			float num43 = 0f;
			zero.Y -= rCurrentNPC.velocity.Y;
			zero.X -= rCurrentNPC.velocity.X * 2f;
			num43 += rCurrentNPC.velocity.X * 0.05f;
			if (rCurrentNPC.frame.Y == 120)
			{
				zero.Y += 2f;
			}
			if (rCurrentNPC.frame.Y == 360)
			{
				zero.Y -= 2f;
			}
			if (rCurrentNPC.frame.Y == 480)
			{
				zero.Y -= 6f;
			}
			mySpriteBatch.Draw(TextureAssets.Ninja.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) + zero.X, rCurrentNPC.position.Y - screenPos.Y + (float)(rCurrentNPC.height / 2) + zero.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Ninja.Width(), TextureAssets.Ninja.Height()), npcColor, num43, new Vector2(TextureAssets.Ninja.Width() / 2, TextureAssets.Ninja.Height() / 2), 1f, SpriteEffects.None, 0f);
		}
		if (type == 71)
		{
			Vector2 zero2 = Vector2.Zero;
			float num44 = 0f;
			zero2.Y -= rCurrentNPC.velocity.Y * 0.3f;
			zero2.X -= rCurrentNPC.velocity.X * 0.6f;
			num44 += rCurrentNPC.velocity.X * 0.09f;
			if (rCurrentNPC.frame.Y == 120)
			{
				zero2.Y += 2f;
			}
			if (rCurrentNPC.frame.Y == 360)
			{
				zero2.Y -= 2f;
			}
			if (rCurrentNPC.frame.Y == 480)
			{
				zero2.Y -= 6f;
			}
			GetItemDrawFrame(327, out var itemTexture, out var rectangle);
			mySpriteBatch.Draw(itemTexture, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) + zero2.X, rCurrentNPC.position.Y - screenPos.Y + (float)(rCurrentNPC.height / 2) + zero2.Y), rectangle, npcColor, num44, rectangle.Size() / 2f, 1f, SpriteEffects.None, 0f);
		}
		if (type == 69)
		{
			mySpriteBatch.Draw(TextureAssets.AntLion.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2), rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height + 14f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.AntLion.Width(), TextureAssets.AntLion.Height()), npcColor, (0f - rCurrentNPC.rotation) * 0.3f, new Vector2(TextureAssets.AntLion.Width() / 2, TextureAssets.AntLion.Height() / 2), 1f, SpriteEffects.None, 0f);
		}
		if (NPCID.Sets.SlimeCanContainItems[type] && rCurrentNPC.ai[1] > 0f)
		{
			DrawNPC_SlimeItem(rCurrentNPC, type, npcColor, 0f);
		}
		float num45 = 0f;
		float num46 = 0f;
		float num47 = NPCAddHeight(rCurrentNPC);
		Vector2 halfSize = new Vector2(TextureAssets.Npc[type].Width() / 2, TextureAssets.Npc[type].Height() / npcFrameCount[type] / 2);
		if (type == 108 || type == 124 || type == 625)
		{
			num46 = 2f;
		}
		else if (type == 357)
		{
			num46 = rCurrentNPC.localAI[0];
		}
		else if (type == 467)
		{
			num46 = 7f;
		}
		else if (type == 537)
		{
			num46 = 2f;
		}
		else if (type == 581)
		{
			num46 = -6f;
		}
		else if (type == 490)
		{
			num46 = 4f;
		}
		else if (type == 484)
		{
			num46 = 2f;
		}
		else if (type == 483)
		{
			num46 = 14f;
		}
		else if (type == 477)
		{
			num47 = 22f;
		}
		else if (type == 478)
		{
			num46 -= 2f;
		}
		else if (type == 606)
		{
			num46 -= 2f;
		}
		else if (type == 612 || type == 613)
		{
			num46 -= 2f;
		}
		else if (type == 469 && rCurrentNPC.ai[2] == 1f)
		{
			num46 = 14f;
		}
		else
		{
			switch (type)
			{
			case 4:
				halfSize = new Vector2(55f, 107f);
				break;
			case 125:
				halfSize = new Vector2(55f, 107f);
				break;
			case 126:
				halfSize = new Vector2(55f, 107f);
				break;
			case 626:
			case 627:
				if (rCurrentNPC.wet)
				{
					num46 = -2f;
					halfSize = rCurrentNPC.frame.Size() * new Vector2(0.5f, 0.5f) + new Vector2(0f, -4f);
				}
				else
				{
					num46 = 2f;
				}
				break;
			case 692:
				num46 = ((!rCurrentNPC.wet) ? 10f : 6f);
				break;
			case 63:
			case 64:
			case 103:
				halfSize.Y += 4f;
				break;
			case 69:
				halfSize.Y += 8f;
				break;
			case 262:
				halfSize.Y = 77f;
				num47 += 26f;
				break;
			case 264:
				halfSize.Y = 21f;
				num47 += 2f;
				break;
			case 266:
				num47 += 50f * rCurrentNPC.scale;
				break;
			case 268:
				num47 += 16f;
				break;
			case 288:
				num47 += 6f;
				break;
			case 694:
				num45 += (float)rCurrentNPC.direction;
				num46 -= 2f;
				if (rCurrentNPC.ai[3] == 3f)
				{
					num45 += 4f;
					num46 += 16f;
				}
				else if (rCurrentNPC.ai[3] == 4f)
				{
					float num48 = (float)rCurrentNPC.frame.Y / 40f;
					float num49 = 17f;
					float num50 = 1f - Math.Max(0f, Math.Min(1f, num48 / num49));
					num45 += (float)(int)(4f * num50);
					num46 += (float)(int)(16f * num50);
				}
				break;
			case 688:
				num46 += 10f;
				break;
			}
		}
		if ((rCurrentNPC.aiStyle == 10 && type != 694) || type == 72)
		{
			npcColor = Microsoft.Xna.Framework.Color.White;
		}
		SpriteEffects spriteEffects = SpriteEffects.None;
		if (rCurrentNPC.spriteDirection == 1)
		{
			spriteEffects = SpriteEffects.FlipHorizontally;
		}
		if (type == 124 && rCurrentNPC.localAI[0] == 0f)
		{
			int num51 = 0;
			if (rCurrentNPC.frame.Y > 56)
			{
				num51 += 4;
			}
			num51 += rCurrentNPC.frame.Y / 56;
			if (num51 >= OffsetsPlayerHeadgear.Length)
			{
				num51 = 0;
			}
			float y = OffsetsPlayerHeadgear[num51].Y;
			LoadProjectile(582);
			Texture2D value2 = TextureAssets.Projectile[582].Value;
			if (rCurrentNPC.townNpcVariationIndex == 1)
			{
				value2 = TextureAssets.Extra[263].Value;
			}
			Vector2 position = rCurrentNPC.Bottom - screenPos;
			Vector2 zero3 = Vector2.Zero;
			zero3 += new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY + y);
			zero3 -= new Vector2(0f, rCurrentNPC.height / 2);
			zero3 -= new Vector2(value2.Width / 2, 0f);
			zero3 += new Vector2(-rCurrentNPC.spriteDirection * 2, -2f);
			zero3 += new Vector2(-1 * rCurrentNPC.spriteDirection, 1f);
			zero3 *= rCurrentNPC.scale;
			if (rCurrentNPC.scale == 2f)
			{
				zero3.Y += -6f;
			}
			if (rCurrentNPC.scale == 3f)
			{
				zero3.Y += -12f;
			}
			position += zero3;
			mySpriteBatch.Draw(value2, position, null, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, value2.Size() * new Vector2(0f, 0.5f), rCurrentNPC.scale, spriteEffects, 0f);
		}
		switch (type)
		{
		default:
			if (type != 546 && type != 552 && type != 553 && type != 554 && type != 561 && type != 562 && type != 563 && type != 555 && type != 556 && type != 557 && type != 558 && type != 559 && type != 560 && type != 574 && type != 575 && type != 568 && type != 569 && type != 572 && type != 573 && type != 566 && type != 567 && type != 570 && type != 578 && type != 571 && type != 583 && type != 584 && type != 585 && type != 618 && type != 620 && type != 661)
			{
				switch (type)
				{
				case 551:
				{
					Texture2D value3 = TextureAssets.Npc[type].Value;
					Vector2 vector9 = rCurrentNPC.Center - screenPos;
					Microsoft.Xna.Framework.Rectangle frame = rCurrentNPC.frame;
					_ = frame.Size() / 2f;
					SpriteEffects spriteEffects2 = spriteEffects ^ SpriteEffects.FlipHorizontally;
					float rotation8 = rCurrentNPC.rotation;
					Microsoft.Xna.Framework.Color color10 = npcColor;
					Microsoft.Xna.Framework.Color color11 = Microsoft.Xna.Framework.Color.Lerp(color10, Microsoft.Xna.Framework.Color.White, 0.6f);
					color11.A = 66;
					Vector2 vector10 = new Vector2(171f, 44f);
					Vector2 vector11 = new Vector2(230f, 52f);
					Vector2 vector12 = Vector2.Lerp(vector10, vector11, 0.5f) + new Vector2(-50f, 30f);
					int num52 = (int)rCurrentNPC.localAI[0] / 4;
					Vector2 spinningpoint = vector10 - vector12;
					Vector2 spinningpoint2 = vector11 - vector12;
					Texture2D value4 = TextureAssets.Extra[82].Value;
					if ((spriteEffects2 & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
					{
						spinningpoint2.X *= -1f;
					}
					Microsoft.Xna.Framework.Rectangle value5 = value4.Frame(2, 5, num52 / 5, num52 % 5);
					Vector2 origin = new Vector2(16f, 176f);
					if ((spriteEffects2 & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
					{
						origin.X = (float)value5.Width - origin.X;
					}
					if ((spriteEffects2 & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
					{
						vector12.X = (float)frame.Width - vector12.X;
					}
					Texture2D value6 = TextureAssets.Extra[81].Value;
					if ((spriteEffects2 & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
					{
						spinningpoint.X *= -1f;
					}
					Microsoft.Xna.Framework.Rectangle value7 = value6.Frame(2, 5, num52 / 5, num52 % 5);
					Vector2 origin2 = new Vector2(215f, 170f);
					if ((spriteEffects2 & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
					{
						origin2.X = (float)value7.Width - origin2.X;
					}
					float lerpValue = Utils.GetLerpValue(0f, 30f, rCurrentNPC.localAI[1], clamped: true);
					if (lerpValue == 1f)
					{
						lerpValue = Utils.GetLerpValue(60f, 30f, rCurrentNPC.localAI[1], clamped: true);
					}
					lerpValue = 2f;
					Vector2 vector13 = rCurrentNPC.Size / 2f - screenPos;
					int num53 = -3;
					int num54 = 0;
					byte b6 = 2;
					for (int n = 9; n > num54; n += num53)
					{
						Vector2 vector14 = rCurrentNPC.oldPos[n] + vector13;
						float num55 = rCurrentNPC.oldRot[n];
						Microsoft.Xna.Framework.Color color12 = color10 * (1f - (float)n / 10f) * 0.35f;
						color12.A /= b6;
						mySpriteBatch.Draw(value4, vector14 + spinningpoint2.RotatedBy(num55), value5, color12, num55, origin, 1f, spriteEffects2, 0f);
						mySpriteBatch.Draw(value3, vector14, frame, color12, num55, vector12, 1f, spriteEffects2, 0f);
						mySpriteBatch.Draw(value6, vector14 + spinningpoint.RotatedBy(num55), value7, color12, num55, origin2, 1f, spriteEffects2, 0f);
					}
					mySpriteBatch.Draw(value4, vector9 + spinningpoint2.RotatedBy(rotation8), value5, color10, rotation8, origin, 1f, spriteEffects2, 0f);
					mySpriteBatch.Draw(value3, vector9, frame, color10, rotation8, vector12, 1f, spriteEffects2, 0f);
					mySpriteBatch.Draw(TextureAssets.GlowMask[226].Value, vector9, frame, color11 * (0.7f + 0.3f * lerpValue), rotation8, vector12, 1f, spriteEffects2, 0f);
					mySpriteBatch.Draw(value6, vector9 + spinningpoint.RotatedBy(rotation8), value7, color10, rotation8, origin2, 1f, spriteEffects2, 0f);
					return;
				}
				case 690:
				{
					LoadTiles(105);
					Texture2D value18 = TextureAssets.Tile[105].Value;
					Vector2 position10 = rCurrentNPC.Center - screenPos;
					position10.Y -= 3f;
					float rotation9 = rCurrentNPC.rotation;
					Microsoft.Xna.Framework.Color alpha2 = rCurrentNPC.GetAlpha(npcColor);
					SpriteEffects effects = SpriteEffects.None;
					int num74 = (int)rCurrentNPC.ai[1];
					int num75 = 55;
					int num76 = 3;
					int num77 = num74 % num75;
					int num78 = num74 / num75;
					if (rCurrentNPC.direction == 1)
					{
						num78 += num76;
					}
					for (int num79 = 0; num79 < 2; num79++)
					{
						for (int num80 = 0; num80 < 3; num80++)
						{
							int x = num77 * 36 + num79 * 18;
							int y2 = num78 * 54 + num80 * 18;
							Microsoft.Xna.Framework.Rectangle value19 = new Microsoft.Xna.Framework.Rectangle(x, y2, 16, 16);
							Vector2 origin8 = new Vector2(1f - (float)num79, 1.5f - (float)num80) * 16f;
							mySpriteBatch.Draw(value18, position10, value19, alpha2, rotation9, origin8, 1f, effects, 0f);
						}
					}
					return;
				}
				case 657:
				{
					Texture2D value23 = TextureAssets.Npc[type].Value;
					Vector2 position14 = rCurrentNPC.Bottom - screenPos;
					position14.Y += 2f;
					int num89 = npcFrameCount[rCurrentNPC.type];
					int num90 = rCurrentNPC.frame.Y / rCurrentNPC.frame.Height;
					Microsoft.Xna.Framework.Rectangle rectangle8 = value23.Frame(2, 16, num90 / num89, num90 % num89);
					rectangle8.Inflate(0, -2);
					Vector2 origin10 = rectangle8.Size() * new Vector2(0.5f, 1f);
					Microsoft.Xna.Framework.Color color21 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.White, npcColor, 0.5f);
					if (rCurrentNPC.life <= rCurrentNPC.lifeMax / 2)
					{
						DrawNPCDirect_QueenSlimeWings(rCurrentNPC, mySpriteBatch, screenPos, rCurrentNPC.Center, color21);
					}
					Texture2D value24 = TextureAssets.Extra[186].Value;
					Microsoft.Xna.Framework.Rectangle rectangle9 = value24.Frame();
					Vector2 origin11 = rectangle9.Size() * new Vector2(0.5f, 0.5f);
					Vector2 vector20 = new Vector2(rCurrentNPC.Center.X, rCurrentNPC.Center.Y);
					float num91 = 0f;
					switch (num90)
					{
					case 1:
					case 6:
						num91 -= 10f;
						break;
					case 3:
					case 5:
						num91 += 10f;
						break;
					case 4:
					case 12:
					case 13:
					case 14:
					case 15:
						num91 += 18f;
						break;
					case 7:
					case 8:
						num91 -= 14f;
						break;
					case 9:
						num91 -= 16f;
						break;
					case 10:
						num91 -= 18f;
						break;
					case 11:
						num91 += 20f;
						break;
					case 20:
						num91 -= 14f;
						break;
					case 21:
					case 23:
						num91 -= 18f;
						break;
					case 22:
						num91 -= 22f;
						break;
					}
					vector20.Y += num91;
					if (rCurrentNPC.rotation != 0f)
					{
						vector20 = vector20.RotatedBy(rCurrentNPC.rotation, rCurrentNPC.Bottom);
					}
					vector20 -= screenPos;
					if (!rCurrentNPC.IsABestiaryIconDummy)
					{
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, Transform);
					}
					GameShaders.Misc["QueenSlime"].Apply();
					if (rCurrentNPC.ai[0] == 4f && rCurrentNPC.velocity.Y != 0f)
					{
						float num92 = 1f;
						if (rCurrentNPC.ai[2] == 1f)
						{
							num92 = 6f;
						}
						for (int num93 = 7; num93 >= 0; num93--)
						{
							float num94 = 1f - (float)num93 / 8f;
							Vector2 vector21 = rCurrentNPC.oldPos[num93] + new Vector2((float)rCurrentNPC.width * 0.5f, rCurrentNPC.height);
							vector21 -= (rCurrentNPC.Bottom - Vector2.Lerp(vector21, rCurrentNPC.Bottom, 0.75f)) * num92;
							vector21 -= screenPos;
							Microsoft.Xna.Framework.Color color22 = color21 * num94;
							mySpriteBatch.Draw(value23, vector21, rectangle8, color22, rCurrentNPC.rotation, origin10, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						}
					}
					if (!rCurrentNPC.IsABestiaryIconDummy)
					{
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
					}
					pixelShader.CurrentTechnique.Passes[0].Apply();
					mySpriteBatch.Draw(value24, vector20, rectangle9, color21, rCurrentNPC.rotation, origin11, 1f, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					GameShaders.Misc["QueenSlime"].Apply();
					if (!rCurrentNPC.IsABestiaryIconDummy)
					{
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, Transform);
					}
					DrawData value25 = new DrawData(value23, position14, rectangle8, rCurrentNPC.GetAlpha(color21), rCurrentNPC.rotation, origin10, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally);
					GameShaders.Misc["QueenSlime"].Apply(value25);
					value25.Draw(mySpriteBatch);
					pixelShader.CurrentTechnique.Passes[0].Apply();
					if (!rCurrentNPC.IsABestiaryIconDummy)
					{
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
					}
					Texture2D value26 = TextureAssets.Extra[177].Value;
					rectangle8 = value26.Frame();
					origin10 = rectangle8.Size() * new Vector2(0.5f, 0.5f);
					position14 = new Vector2(rCurrentNPC.Center.X, rCurrentNPC.Top.Y - (float)rectangle8.Bottom + 44f);
					float num95 = 0f;
					switch (num90)
					{
					case 1:
						num95 -= 10f;
						break;
					case 3:
					case 5:
					case 6:
						num95 += 10f;
						break;
					case 4:
					case 12:
					case 13:
					case 14:
					case 15:
						num95 += 18f;
						break;
					case 7:
					case 8:
						num95 -= 14f;
						break;
					case 9:
						num95 -= 16f;
						break;
					case 10:
						num95 -= 18f;
						break;
					case 11:
						num95 += 20f;
						break;
					case 20:
						num95 -= 14f;
						break;
					case 21:
					case 23:
						num95 -= 18f;
						break;
					case 22:
						num95 -= 22f;
						break;
					}
					position14.Y += num95;
					if (rCurrentNPC.rotation != 0f)
					{
						position14 = position14.RotatedBy(rCurrentNPC.rotation, rCurrentNPC.Bottom);
					}
					position14 -= screenPos;
					mySpriteBatch.Draw(value26, position14, rectangle8, color21, rCurrentNPC.rotation, origin10, 1f, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					return;
				}
				case 576:
				case 577:
				{
					Texture2D value13 = TextureAssets.Npc[type].Value;
					Vector2 vector16 = rCurrentNPC.Bottom - screenPos;
					Microsoft.Xna.Framework.Rectangle rectangle4 = value13.Frame(5, 10, rCurrentNPC.frame.Y / 10, rCurrentNPC.frame.Y % 10);
					Vector2 origin5 = rectangle4.Size() * new Vector2(0.5f, 1f);
					origin5.Y -= 4f;
					int num67 = 94;
					if (rCurrentNPC.spriteDirection == 1)
					{
						origin5.X = num67;
					}
					else
					{
						origin5.X = rectangle4.Width - num67;
					}
					Microsoft.Xna.Framework.Color value14 = Microsoft.Xna.Framework.Color.White;
					float amount3 = 0f;
					float amount4 = 0f;
					int num68 = 0;
					float num69 = 0f;
					Microsoft.Xna.Framework.Color color17 = npcColor;
					if (rCurrentNPC.localAI[3] < 60f)
					{
						_ = 8f;
						float num70 = rCurrentNPC.localAI[3] / 60f;
						num68 = 3;
						num69 = 1f - num70 * num70;
						value14 = new Microsoft.Xna.Framework.Color(127, 0, 255, 0);
						amount4 = 1f;
						color17 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color17, num70 * num70);
					}
					for (int num71 = 0; num71 < num68; num71++)
					{
						Microsoft.Xna.Framework.Color value15 = npcColor;
						value15 = Microsoft.Xna.Framework.Color.Lerp(value15, value14, amount3);
						value15 = rCurrentNPC.GetAlpha(value15);
						value15 = Microsoft.Xna.Framework.Color.Lerp(value15, value14, amount4);
						value15 *= 1f - num69;
						Vector2 position8 = vector16;
						position8 -= new Vector2(value13.Width, value13.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position8 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value13, position8, rectangle4, value15, rCurrentNPC.rotation, origin5, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					mySpriteBatch.Draw(value13, vector16, rectangle4, rCurrentNPC.GetAlpha(color17), rCurrentNPC.rotation, origin5, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					return;
				}
				case 696:
				{
					Texture2D value16 = TextureAssets.Npc[type].Value;
					Vector2 vector17 = rCurrentNPC.Bottom - screenPos;
					Microsoft.Xna.Framework.Rectangle rectangle5 = value16.Frame(6, 27, rCurrentNPC.frame.Y / 9, rCurrentNPC.frame.Y % 9);
					Vector2 origin6 = rectangle5.Size() * new Vector2(0.5f, 1f);
					origin6.Y -= 4f;
					Microsoft.Xna.Framework.Color newColor2 = npcColor;
					mySpriteBatch.Draw(value16, vector17, rectangle5, rCurrentNPC.GetAlpha(newColor2), rCurrentNPC.rotation, origin6, rCurrentNPC.scale, spriteEffects, 0f);
					rectangle5.Y += rectangle5.Height * 18;
					ulong seed = TileFrameSeed;
					for (int num72 = 0; num72 < 2; num72++)
					{
						Vector2 vector18 = new Vector2(Utils.RandomInt(ref seed, -1, 2), Utils.RandomInt(ref seed, -1, 2));
						if (num72 == 0)
						{
							vector18 = Vector2.Zero;
						}
						mySpriteBatch.Draw(value16, vector17 + vector18, rectangle5, new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * rCurrentNPC.Opacity, rCurrentNPC.rotation, origin6, rCurrentNPC.scale, spriteEffects, 0f);
					}
					if (rCurrentNPC.ai[0] == 2f)
					{
						int num73 = 60;
						int emoteId = 0;
						if (rCurrentNPC.ai[1] < (float)num73)
						{
							EmoteBubble.DrawTemporaryBubble(spriteBatch, emoteId, num73, num73 - (int)rCurrentNPC.ai[1], rCurrentNPC);
						}
					}
					return;
				}
				case 594:
				{
					Texture2D value11 = TextureAssets.Npc[type].Value;
					Vector2 position7 = rCurrentNPC.Top - screenPos;
					Microsoft.Xna.Framework.Rectangle rectangle3 = value11.Frame(8, 1, rCurrentNPC.frame.Y);
					Microsoft.Xna.Framework.Rectangle value12 = value11.Frame(8);
					Vector2 origin4 = rectangle3.Size() * new Vector2(0.5f, 0f);
					Microsoft.Xna.Framework.Color color16 = npcColor;
					float scale3 = 1f;
					NPC nPC = rCurrentNPC.AI_113_WindyBalloon_GetSlaveNPC();
					if (nPC != null)
					{
						scale3 = nPC.scale;
						if (nPC.ai[1] > 0f)
						{
							DrawNPC_SlimeItem(nPC, nPC.type, color16, rCurrentNPC.rotation);
						}
						mySpriteBatch.Draw(value11, position7, value12, nPC.GetAlpha(color16), rCurrentNPC.rotation, origin4, scale3, spriteEffects, 0f);
						mySpriteBatch.Draw(value11, position7, value12, nPC.GetColor(color16), rCurrentNPC.rotation, origin4, scale3, spriteEffects, 0f);
					}
					mySpriteBatch.Draw(value11, position7, rectangle3, rCurrentNPC.GetAlpha(color16), rCurrentNPC.rotation, origin4, scale3, spriteEffects, 0f);
					return;
				}
				case 686:
				{
					Texture2D value17 = TextureAssets.Npc[type].Value;
					Vector2 position9 = rCurrentNPC.Top - screenPos;
					Microsoft.Xna.Framework.Rectangle rectangle6 = value17.Frame();
					Vector2 origin7 = rectangle6.Size() * new Vector2(0.5f, 0f);
					Microsoft.Xna.Framework.Color newColor3 = npcColor;
					mySpriteBatch.Draw(value17, position9, rectangle6, rCurrentNPC.GetAlpha(newColor3), rCurrentNPC.rotation, origin7, rCurrentNPC.scale, spriteEffects, 0f);
					return;
				}
				case 564:
				case 565:
				{
					Texture2D value20 = TextureAssets.Npc[type].Value;
					Vector2 vector19 = rCurrentNPC.Bottom - screenPos;
					Microsoft.Xna.Framework.Rectangle rectangle7 = value20.Frame(5, 9, rCurrentNPC.frame.Y / 9, rCurrentNPC.frame.Y % 9);
					Vector2 origin9 = rectangle7.Size() * new Vector2(0.5f, 1f);
					origin9.Y -= 10f;
					int num81 = 52;
					if (rCurrentNPC.spriteDirection == 1)
					{
						origin9.X = num81;
					}
					else
					{
						origin9.X = rectangle7.Width - num81;
					}
					Microsoft.Xna.Framework.Color value21 = Microsoft.Xna.Framework.Color.White;
					float amount5 = 0f;
					float amount6 = 0f;
					int num82 = 0;
					float num83 = 0f;
					float num84 = 0f;
					Microsoft.Xna.Framework.Color color18 = npcColor;
					if (rCurrentNPC.localAI[3] < 60f)
					{
						float num85 = rCurrentNPC.localAI[3] / 60f;
						num82 = 3;
						num83 = 1f - num85 * num85;
						num84 = 8f;
						value21 = new Microsoft.Xna.Framework.Color(127, 0, 255, 0);
						amount6 = 1f;
						color18 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color18, num85 * num85);
					}
					for (int num86 = 0; num86 < num82; num86++)
					{
						Microsoft.Xna.Framework.Color value22 = npcColor;
						value22 = Microsoft.Xna.Framework.Color.Lerp(value22, value21, amount5);
						value22 = rCurrentNPC.GetAlpha(value22);
						value22 = Microsoft.Xna.Framework.Color.Lerp(value22, value21, amount6);
						value22 *= 1f - num83;
						Vector2 position11 = vector19;
						position11 -= new Vector2(value20.Width, value20.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position11 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						position11 += ((float)num86 / (float)num82 * ((float)Math.PI * 2f)).ToRotationVector2() * num84 * num83;
						mySpriteBatch.Draw(value20, position11, rectangle7, value22, rCurrentNPC.rotation, origin9, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					Microsoft.Xna.Framework.Color alpha3 = rCurrentNPC.GetAlpha(color18);
					num82 = 4;
					num84 = 4f;
					num83 = 0.625f + (float)Math.Sin(GlobalTimeWrappedHourly * ((float)Math.PI * 2f) * 0.75f + (float)Math.PI) * 0.125f;
					for (int num87 = 0; num87 < num82; num87++)
					{
						Microsoft.Xna.Framework.Color color19 = alpha3;
						color19 *= 1f - num83;
						Vector2 position12 = vector19;
						position12 -= new Vector2(value20.Width, value20.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position12 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						position12 += ((float)num87 / (float)num82 * ((float)Math.PI * 2f)).ToRotationVector2() * num84 * num83;
						mySpriteBatch.Draw(value20, position12, rectangle7, color19, rCurrentNPC.rotation, origin9, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					mySpriteBatch.Draw(value20, vector19, rectangle7, alpha3, rCurrentNPC.rotation, origin9, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					if (rCurrentNPC.Opacity > 0f)
					{
						Microsoft.Xna.Framework.Color white2 = Microsoft.Xna.Framework.Color.White;
						white2.A /= 2;
						white2 *= rCurrentNPC.Opacity;
						mySpriteBatch.Draw(TextureAssets.GlowMask[225].Value, vector19, rectangle7, white2, rCurrentNPC.rotation, origin9, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						num82 = 4;
						num84 = 4f;
						num83 = 0.5f + (float)Math.Sin(GlobalTimeWrappedHourly * ((float)Math.PI * 2f) * 0.75f) * 0.5f;
						for (int num88 = 0; num88 < num82; num88++)
						{
							Microsoft.Xna.Framework.Color color20 = white2 * 0.35f;
							color20 *= 1f - num83;
							Vector2 position13 = vector19;
							position13 -= new Vector2(value20.Width, value20.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
							position13 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
							position13 += ((float)num88 / (float)num82 * ((float)Math.PI * 2f)).ToRotationVector2() * num84 * num83;
							mySpriteBatch.Draw(TextureAssets.GlowMask[225].Value, position13, rectangle7, color20, rCurrentNPC.rotation, origin9, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						}
					}
					return;
				}
				case 548:
				{
					Texture2D value9 = TextureAssets.Npc[type].Value;
					Vector2 vector15 = rCurrentNPC.Bottom - screenPos;
					Microsoft.Xna.Framework.Rectangle rectangle2 = value9.Frame();
					Vector2 origin3 = rectangle2.Size() / 2f;
					origin3.Y += 30f;
					origin3.Y += 8f;
					origin3.X -= 1f;
					Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
					float amount = 0f;
					float amount2 = 0f;
					int num56 = 0;
					float num57 = 0f;
					float num58 = 0f;
					Microsoft.Xna.Framework.Color newColor = npcColor;
					for (int num59 = 0; num59 < num56; num59++)
					{
						Microsoft.Xna.Framework.Color value10 = npcColor;
						value10 = Microsoft.Xna.Framework.Color.Lerp(value10, white, amount);
						value10 = rCurrentNPC.GetAlpha(value10);
						value10 = Microsoft.Xna.Framework.Color.Lerp(value10, white, amount2);
						value10 *= 1f - num57;
						Vector2 position3 = vector15;
						position3 -= new Vector2(value9.Width, value9.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position3 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						position3 += ((float)num59 / (float)num56 * ((float)Math.PI * 2f)).ToRotationVector2() * num58 * num57;
						mySpriteBatch.Draw(value9, position3, rectangle2, value10, rCurrentNPC.rotation, origin3, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					Microsoft.Xna.Framework.Color alpha = rCurrentNPC.GetAlpha(newColor);
					num56 = 4;
					num58 = 4f;
					num57 = 0.625f + (float)Math.Sin(GlobalTimeWrappedHourly * ((float)Math.PI * 2f) * 0.75f + (float)Math.PI) * 0.125f;
					for (int num60 = 0; num60 < num56; num60++)
					{
						Microsoft.Xna.Framework.Color color13 = alpha;
						color13.A = 0;
						color13 *= 1f - num57;
						Vector2 position4 = vector15;
						position4 -= new Vector2(value9.Width, value9.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position4 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						position4 += ((float)num60 / (float)num56 * ((float)Math.PI * 2f)).ToRotationVector2() * num58 * num57;
						mySpriteBatch.Draw(value9, position4, rectangle2, color13, rCurrentNPC.rotation, origin3, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					mySpriteBatch.Draw(value9, vector15, rectangle2, alpha, rCurrentNPC.rotation, origin3, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					if (rCurrentNPC.ai[1] == 2f)
					{
						float num61 = Math.Min(1f, rCurrentNPC.ai[0] / 120f);
						mySpriteBatch.Draw(value9, vector15, rectangle2, new Microsoft.Xna.Framework.Color(1f, 1f, 1f, 0f) * num61, rCurrentNPC.rotation, origin3, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						float progress = MathHelper.Clamp(rCurrentNPC.ai[0] / 450f, 0f, 1f);
						if (!Terraria.Graphics.Effects.Filters.Scene["CrystalWin"].IsActive())
						{
							Terraria.Graphics.Effects.Filters.Scene.Activate("CrystalWin", rCurrentNPC.Center);
						}
						else
						{
							Terraria.Graphics.Effects.Filters.Scene["CrystalWin"].GetShader().UseProgress(progress);
						}
						Terraria.Graphics.Effects.Filters.Scene["CrystalWin"].GetShader().UseTargetPosition(rCurrentNPC.Center);
					}
					num56 = 4;
					num58 = 4f;
					num57 = 0.625f + (float)Math.Sin(GlobalTimeWrappedHourly * ((float)Math.PI * 2f) * 0.75f) * 0.125f;
					for (int num62 = 0; num62 < num56; num62++)
					{
						Microsoft.Xna.Framework.Color color14 = alpha;
						color14.A = 0;
						color14 *= 0.3f;
						color14 *= 1f - num57;
						Vector2 position5 = vector15;
						position5 -= new Vector2(value9.Width, value9.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position5 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						position5 += ((float)num62 / (float)num56 * ((float)Math.PI * 2f)).ToRotationVector2() * num58 * num57;
						mySpriteBatch.Draw(value9, position5, rectangle2, color14, rCurrentNPC.rotation, origin3, rCurrentNPC.scale, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					if (rCurrentNPC.alpha < 255)
					{
						float num63 = GlobalTimeWrappedHourly % 3f / 3f;
						float num64 = num63;
						if (num64 > 0.5f)
						{
							num64 = 1f - num63;
						}
						if (num64 < 0f)
						{
							num64 = 0f;
						}
						float num65 = (num63 + 0.5f) % 1f;
						float num66 = num65;
						if (num66 > 0.5f)
						{
							num66 = 1f - num65;
						}
						if (num66 < 0f)
						{
							num66 = 0f;
						}
						value9 = TextureAssets.GlowMask[239].Value;
						rectangle2 = value9.Frame();
						origin3 = rectangle2.Size() / 2f;
						Vector2 position6 = vector15 + new Vector2(0f, -40f);
						Microsoft.Xna.Framework.Color color15 = new Microsoft.Xna.Framework.Color(140, 50, 255, 0);
						color15 *= 0.6f;
						mySpriteBatch.Draw(value9, position6, rectangle2, color15, rCurrentNPC.rotation, origin3, rCurrentNPC.scale * 0.75f, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						num57 = 1f + num63 * 0.75f;
						mySpriteBatch.Draw(value9, position6, rectangle2, color15 * num64, rCurrentNPC.rotation, origin3, rCurrentNPC.scale * 0.75f * num57, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						num57 = 1f + num65 * 0.75f;
						mySpriteBatch.Draw(value9, position6, rectangle2, color15 * num66, rCurrentNPC.rotation, origin3, rCurrentNPC.scale * 0.75f * num57, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						value9 = TextureAssets.Extra[89].Value;
						rectangle2 = value9.Frame();
						origin3 = rectangle2.Size() / 2f;
						Vector2 scale2 = new Vector2(0.75f, 1f + num57) * 1.5f;
						num57 = 1f + num65 * 0.75f;
						if (rCurrentNPC.dontTakeDamageFromHostiles)
						{
							scale2.Y *= 0.6f;
						}
						position6.Y -= 6f;
						mySpriteBatch.Draw(value9, position6, rectangle2, color15 * num66, rCurrentNPC.rotation + (float)Math.PI / 2f, origin3, scale2, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
						mySpriteBatch.Draw(value9, position6, rectangle2, Microsoft.Xna.Framework.Color.Lerp(color15, Microsoft.Xna.Framework.Color.White, 0.5f), rCurrentNPC.rotation + (float)Math.PI / 2f, origin3, 1.5f, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
					}
					return;
				}
				default:
					if (type < 621 || type > 623)
					{
						break;
					}
					goto case 371;
				case 371:
				case 454:
				case 455:
				case 456:
				case 457:
				case 458:
				case 459:
				{
					Texture2D value8 = TextureAssets.Npc[type].Value;
					Vector2 position2 = rCurrentNPC.Center - screenPos;
					position2 -= new Vector2(value8.Width, value8.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					position2 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(value8, position2, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					return;
				}
				}
				switch (type)
				{
				case 549:
				{
					Texture2D value77 = TextureAssets.Npc[type].Value;
					Vector2 vector66 = rCurrentNPC.Center - screenPos;
					Microsoft.Xna.Framework.Rectangle frame9 = rCurrentNPC.frame;
					Vector2 origin24 = new Vector2(70f, 127f);
					origin24.Y += 8f;
					Vector2 scale6 = new Vector2(rCurrentNPC.scale);
					float num269 = rCurrentNPC.localAI[0];
					if (num269 < 120f)
					{
						scale6 *= num269 / 240f + 0.5f;
					}
					Microsoft.Xna.Framework.Color alpha13 = rCurrentNPC.GetAlpha(npcColor);
					float lerpValue2 = Utils.GetLerpValue(0f, 120f, num269, clamped: true);
					float num270 = MathHelper.Lerp(32f, 0f, lerpValue2);
					Microsoft.Xna.Framework.Color color42 = alpha13;
					color42.A = (byte)MathHelper.Lerp((int)color42.A, 0f, lerpValue2);
					color42 *= lerpValue2;
					if (num269 >= 120f)
					{
						color42 = alpha13;
					}
					mySpriteBatch.Draw(value77, vector66, frame9, color42, rCurrentNPC.rotation, origin24, scale6, spriteEffects, 0f);
					float y4 = (((rCurrentNPC.ai[0] + 54f) % 180f - 120f) / 180f * 2f * ((float)Math.PI * 2f)).ToRotationVector2().Y;
					if (num269 >= 120f)
					{
						num270 = y4 * 0f;
						color42.A = (byte)((float)(int)color42.A * 0.5f);
						color42 *= y4 / 2f + 0.5f;
						float num271 = 1f;
						for (float num272 = 0f; num272 < num271; num272 += 1f)
						{
							mySpriteBatch.Draw(value77, vector66 + ((float)Math.PI * 2f / num271 * num272).ToRotationVector2() * num270, frame9, color42, rCurrentNPC.rotation, origin24, scale6, spriteEffects, 0f);
						}
					}
					float num273 = rCurrentNPC.ai[0] / 180f - 0.76f;
					if (num273 < 0f)
					{
						num273 += 1f;
					}
					float num274 = 0f;
					float num275 = 0f;
					float num276 = 0.6f;
					float num277 = 0.8f;
					if (num273 >= num276 && num273 <= num277)
					{
						num274 = Utils.GetLerpValue(num276, num277, num273);
						num275 = MathHelper.Lerp(0.75f, 0.85f, num274);
					}
					num276 = num277;
					num277 = num276 + 0.13f;
					if (num273 >= num276 && num273 <= num277)
					{
						num274 = 1f - Utils.GetLerpValue(num276, num277, num273);
						num275 = MathHelper.Lerp(1.3f, 0.85f, num274);
					}
					Vector2 vector67 = new Vector2(0f, -150f);
					int frameNumber = frame9.Y / frame9.Height;
					float num278 = MathHelper.Clamp((num269 - 100f) / 40f, 0f, 1f);
					DrawElderEye(mySpriteBatch, rCurrentNPC.Center + vector67, 0.75f * num278, 0.75f, frameNumber, Microsoft.Xna.Framework.Color.White);
					DrawElderEye(mySpriteBatch, rCurrentNPC.Center + vector67, 0.75f * num278, 0.75f, frameNumber, new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * (y4 / 2f + 0.5f));
					if (num274 > 0f && num275 > 0f)
					{
						DrawElderEye(mySpriteBatch, rCurrentNPC.Center + vector67, num274 * 0.5f, num275, frameNumber, new Microsoft.Xna.Framework.Color(255, 255, 255, 127));
					}
					if (num269 < 120f)
					{
						float num279 = (float)Math.PI * 2f * lerpValue2 * (float)Math.Pow(lerpValue2, 2.0) * 2f + lerpValue2;
						color42.A = (byte)((float)(int)alpha13.A * (float)Math.Pow(lerpValue2, 2.0) * 0.5f);
						float num280 = 3f;
						for (float num281 = 0f; num281 < num280; num281 += 1f)
						{
							mySpriteBatch.Draw(value77, vector66 + (num279 + (float)Math.PI * 2f / num280 * num281).ToRotationVector2() * num270, frame9, color42, rCurrentNPC.rotation, origin24, scale6, spriteEffects, 0f);
						}
					}
					break;
				}
				case 636:
					DrawNPCDirect_HallowBoss(mySpriteBatch, rCurrentNPC, ref screenPos, type, ref npcColor, ref halfSize, spriteEffects);
					break;
				case 677:
					DrawNPCDirect_Faeling(mySpriteBatch, rCurrentNPC, ref screenPos, type, ref npcColor, ref halfSize, spriteEffects);
					break;
				case 668:
					DrawNPCDirect_Deerclops(mySpriteBatch, rCurrentNPC, ref screenPos, type, ref npcColor, ref halfSize, spriteEffects);
					break;
				case 422:
				case 493:
				case 507:
				case 517:
				{
					Texture2D value74 = TextureAssets.Npc[type].Value;
					Vector2 vector64 = rCurrentNPC.Center - screenPos;
					Vector2 vector65 = vector64 - new Vector2(300f, 310f);
					vector64 -= new Vector2(value74.Width, value74.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					vector64 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(value74, vector64, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					switch (type)
					{
					case 493:
					{
						value74 = TextureAssets.GlowMask[132].Value;
						float num262 = 4f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 4f;
						for (int num263 = 0; num263 < 4; num263++)
						{
							mySpriteBatch.Draw(value74, vector64 + rCurrentNPC.velocity.RotatedBy((float)num263 * ((float)Math.PI / 2f)) * num262, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0) * rCurrentNPC.Opacity, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					case 507:
					{
						value74 = TextureAssets.GlowMask[143].Value;
						float num258 = 4f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 4f;
						for (int num259 = 0; num259 < 4; num259++)
						{
							mySpriteBatch.Draw(value74, vector64 + rCurrentNPC.velocity.RotatedBy((float)num259 * ((float)Math.PI / 2f)) * num258, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0) * rCurrentNPC.Opacity, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					case 422:
					{
						value74 = TextureAssets.GlowMask[149].Value;
						float num260 = 4f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 4f;
						for (int num261 = 0; num261 < 4; num261++)
						{
							mySpriteBatch.Draw(value74, vector64 + rCurrentNPC.velocity.RotatedBy((float)num261 * ((float)Math.PI / 2f)) * num260, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0) * rCurrentNPC.Opacity, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					case 517:
					{
						value74 = TextureAssets.GlowMask[162].Value;
						float num256 = 2f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 9f;
						for (int num257 = 0; num257 < 4; num257++)
						{
							mySpriteBatch.Draw(value74, vector64 + rCurrentNPC.velocity.RotatedBy((float)num257 * ((float)Math.PI / 2f)) * num256 + Vector2.UnitX * 2f, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0) * rCurrentNPC.Opacity, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					}
					int num264 = 0;
					string key = "";
					switch (type)
					{
					case 422:
						num264 = NPC.ShieldStrengthTowerVortex;
						key = "Vortex";
						break;
					case 507:
						num264 = NPC.ShieldStrengthTowerNebula;
						key = "Nebula";
						break;
					case 517:
						num264 = NPC.ShieldStrengthTowerSolar;
						key = "Solar";
						break;
					case 493:
						num264 = NPC.ShieldStrengthTowerStardust;
						key = "Stardust";
						break;
					}
					float num265 = (float)num264 / (float)NPC.ShieldStrengthTowerMax;
					if (rCurrentNPC.IsABestiaryIconDummy)
					{
						break;
					}
					if (num264 > 0)
					{
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointWrap, DepthStencilState.Default, RasterizerState.CullNone, null, Transform);
						float num266 = 0f;
						if (rCurrentNPC.ai[3] > 0f && rCurrentNPC.ai[3] <= 30f)
						{
							num266 = 1f - rCurrentNPC.ai[3] / 30f;
						}
						Terraria.Graphics.Effects.Filters.Scene[key].GetShader().UseIntensity(1f + num266).UseProgress(0f);
						DrawData value75 = new DrawData(Assets.Request<Texture2D>("Images/Misc/Perlin", AssetRequestMode.ImmediateLoad).Value, vector65 + new Vector2(300f, 300f), new Microsoft.Xna.Framework.Rectangle(0, 0, 600, 600), Microsoft.Xna.Framework.Color.White * (num265 * 0.8f + 0.2f), rCurrentNPC.rotation, new Vector2(300f, 300f), rCurrentNPC.scale * (1f + num266 * 0.05f), spriteEffects);
						GameShaders.Misc["ForceField"].UseColor(new Vector3(1f + num266 * 0.5f));
						GameShaders.Misc["ForceField"].Apply(value75);
						value75.Draw(mySpriteBatch);
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
					}
					else if (rCurrentNPC.ai[3] > 0f)
					{
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointWrap, DepthStencilState.Default, RasterizerState.CullNone, null, Transform);
						float num267 = rCurrentNPC.ai[3] / 120f;
						float num268 = Math.Min(rCurrentNPC.ai[3] / 30f, 1f);
						Terraria.Graphics.Effects.Filters.Scene[key].GetShader().UseIntensity(Math.Min(5f, 15f * num267) + 1f).UseProgress(num267);
						DrawData value76 = new DrawData(Assets.Request<Texture2D>("Images/Misc/Perlin", AssetRequestMode.ImmediateLoad).Value, vector65 + new Vector2(300f, 300f), new Microsoft.Xna.Framework.Rectangle(0, 0, 600, 600), new Microsoft.Xna.Framework.Color(new Vector4(1f - (float)Math.Sqrt(num268))), rCurrentNPC.rotation, new Vector2(300f, 300f), rCurrentNPC.scale * (1f + num268), spriteEffects);
						GameShaders.Misc["ForceField"].UseColor(new Vector3(2f));
						GameShaders.Misc["ForceField"].Apply(value76);
						value76.Draw(mySpriteBatch);
						mySpriteBatch.End();
						mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
					}
					else
					{
						Terraria.Graphics.Effects.Filters.Scene[key].GetShader().UseIntensity(0f).UseProgress(0f);
					}
					break;
				}
				case 402:
				{
					LoadNPC(403);
					LoadNPC(404);
					Texture2D value79 = TextureAssets.Npc[rCurrentNPC.type].Value;
					Vector2 vector69 = rCurrentNPC.Center - screenPos;
					vector69 -= new Vector2(value79.Width, value79.Height / npcFrameCount[rCurrentNPC.type]) * rCurrentNPC.scale / 2f;
					vector69 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					int num286 = 0;
					float num287 = 2f / (float)rCurrentNPC.oldPos.Length * 0.7f;
					float num288 = 600f;
					float num289 = num288 - 30f;
					float num290 = Utils.Remap(rCurrentNPC.ai[2], 0f, num288, 0f, 1f);
					float num291 = 1f - Utils.Remap(num290, 0.5f, num289 / num288, 0f, 1f) * Utils.Remap(num290, num289 / num288, 1f, 1f, 0f);
					int num292 = rCurrentNPC.oldPos.Length - 1;
					while ((float)num292 >= 1f)
					{
						for (int num293 = 0; num293 < 2; num293++)
						{
							value79 = ((num286 != 0) ? TextureAssets.Npc[403].Value : TextureAssets.Npc[404].Value);
							Vector2 position31 = vector69 + rCurrentNPC.oldPos[num292] - rCurrentNPC.position;
							float rotation11 = rCurrentNPC.oldRot[num292];
							if (num292 >= 1 && num293 == 1)
							{
								Vector2 vector70 = Vector2.Lerp(rCurrentNPC.oldPos[num292], rCurrentNPC.oldPos[num292 - 1], 0.5f) - rCurrentNPC.oldPos[num292];
								rotation11 = MathHelper.WrapAngle(rCurrentNPC.oldRot[num292 - 1] * 0.5f + rCurrentNPC.oldRot[num292] * 0.5f);
								position31 += vector70;
							}
							float scale7 = rCurrentNPC.scale;
							mySpriteBatch.Draw(value79, position31, null, rCurrentNPC.GetAlpha(npcColor) * (0.8f - num287 * (float)num292 / 2f) * num291, rotation11, halfSize, scale7, spriteEffects, 0f);
							value79 = ((num286 != 0) ? TextureAssets.GlowMask[133].Value : TextureAssets.GlowMask[134].Value);
							mySpriteBatch.Draw(value79, position31, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * (1f - num287 * (float)num292 / 2f) * num291, rotation11, halfSize, scale7, spriteEffects, 0f);
							num286++;
						}
						num292 -= 2;
					}
					value79 = TextureAssets.Npc[rCurrentNPC.type].Value;
					mySpriteBatch.Draw(value79, vector69, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					value79 = TextureAssets.GlowMask[135].Value;
					mySpriteBatch.Draw(value79, vector69, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num291, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					DrawPrettyStarSparkle(Utils.Remap(rCurrentNPC.ai[2], 0f, num288, 0f, 1f), SpriteEffects.None, vector69, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), Microsoft.Xna.Framework.Color.CornflowerBlue, num290, 0.5f, num289 / num288, num289 / num288, 1f, (float)Math.PI * 2f * num290, new Vector2(2f, 2f), new Vector2(2f, 2f));
					break;
				}
				case 519:
				{
					Texture2D value78 = TextureAssets.Npc[rCurrentNPC.type].Value;
					Vector2 vector68 = rCurrentNPC.Center - screenPos;
					vector68 -= new Vector2(value78.Width, value78.Height / npcFrameCount[rCurrentNPC.type]) * rCurrentNPC.scale / 2f;
					vector68 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					value78 = TextureAssets.Npc[rCurrentNPC.type].Value;
					mySpriteBatch.Draw(value78, vector68, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					int num282 = 0;
					float num283 = 1f / (float)rCurrentNPC.oldPos.Length * 0.7f;
					int num284 = rCurrentNPC.oldPos.Length - 1;
					while ((float)num284 >= 0f)
					{
						float num285 = (float)(rCurrentNPC.oldPos.Length - num284) / (float)rCurrentNPC.oldPos.Length;
						Microsoft.Xna.Framework.Color pink = Microsoft.Xna.Framework.Color.Pink;
						pink *= 1f - num283 * (float)num284 / 1f;
						pink.A = (byte)((float)(int)pink.A * (1f - num285));
						mySpriteBatch.Draw(value78, vector68 + rCurrentNPC.oldPos[num284] - rCurrentNPC.position, null, pink, rCurrentNPC.oldRot[num284], halfSize, rCurrentNPC.scale * MathHelper.Lerp(0.3f, 1.1f, num285), spriteEffects, 0f);
						num282++;
						num284--;
					}
					break;
				}
				case 522:
				{
					Texture2D value73 = TextureAssets.Npc[rCurrentNPC.type].Value;
					Vector2 vector63 = rCurrentNPC.Center - screenPos;
					vector63 -= new Vector2(value73.Width, value73.Height / npcFrameCount[rCurrentNPC.type]) * rCurrentNPC.scale / 2f;
					vector63 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					int num252 = 0;
					float num253 = 1f / (float)rCurrentNPC.oldPos.Length * 1.1f;
					int num254 = rCurrentNPC.oldPos.Length - 1;
					while ((float)num254 >= 0f)
					{
						float num255 = (float)(rCurrentNPC.oldPos.Length - num254) / (float)rCurrentNPC.oldPos.Length;
						Microsoft.Xna.Framework.Color white7 = Microsoft.Xna.Framework.Color.White;
						white7 *= 1f - num253 * (float)num254 / 1f;
						white7.A = (byte)((float)(int)white7.A * (1f - num255));
						mySpriteBatch.Draw(value73, vector63 + rCurrentNPC.oldPos[num254] - rCurrentNPC.position, null, white7, rCurrentNPC.oldRot[num254], halfSize, rCurrentNPC.scale * MathHelper.Lerp(0.8f, 0.3f, num255), spriteEffects, 0f);
						num252++;
						num254--;
					}
					value73 = TextureAssets.Extra[57].Value;
					mySpriteBatch.Draw(value73, vector63, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), 0f, value73.Size() / 2f, rCurrentNPC.scale, spriteEffects, 0f);
					break;
				}
				case 370:
				case 372:
				case 373:
				{
					Texture2D value63 = TextureAssets.Npc[type].Value;
					Microsoft.Xna.Framework.Color value64 = Microsoft.Xna.Framework.Color.White;
					float amount8 = 0f;
					bool flag12 = type == 370 && rCurrentNPC.ai[0] > 4f;
					bool num226 = type == 370 && rCurrentNPC.ai[0] > 9f;
					int num227 = 120;
					int num228 = 60;
					Microsoft.Xna.Framework.Color color39 = npcColor;
					if (num226)
					{
						npcColor = buffColor(npcColor, 0.4f, 0.8f, 0.4f, 1f);
					}
					else if (flag12)
					{
						npcColor = buffColor(npcColor, 0.5f, 0.7f, 0.5f, 1f);
					}
					else if (type == 370 && rCurrentNPC.ai[0] == 4f && rCurrentNPC.ai[2] > (float)num227)
					{
						float num229 = rCurrentNPC.ai[2] - (float)num227;
						num229 /= (float)num228;
						npcColor = buffColor(npcColor, 1f - 0.5f * num229, 1f - 0.3f * num229, 1f - 0.5f * num229, 1f);
					}
					int num230 = 10;
					int num231 = 2;
					switch (type)
					{
					case 370:
						if (rCurrentNPC.ai[0] == -1f)
						{
							num230 = 0;
						}
						if (rCurrentNPC.ai[0] == 0f || rCurrentNPC.ai[0] == 5f || rCurrentNPC.ai[0] == 10f)
						{
							num230 = 7;
						}
						if (rCurrentNPC.ai[0] == 1f)
						{
							value64 = Microsoft.Xna.Framework.Color.Blue;
							amount8 = 0.5f;
						}
						else
						{
							color39 = npcColor;
						}
						break;
					case 372:
					case 373:
						if (rCurrentNPC.ai[0] == 1f)
						{
							value64 = Microsoft.Xna.Framework.Color.Blue;
							amount8 = 0.5f;
						}
						break;
					}
					for (int num232 = 1; num232 < num230; num232 += num231)
					{
						_ = ref rCurrentNPC.oldPos[num232];
						Microsoft.Xna.Framework.Color value65 = color39;
						value65 = Microsoft.Xna.Framework.Color.Lerp(value65, value64, amount8);
						value65 = rCurrentNPC.GetAlpha(value65);
						value65 *= (float)(num230 - num232) / 15f;
						Vector2 position23 = rCurrentNPC.oldPos[num232] + new Vector2(rCurrentNPC.width, rCurrentNPC.height) / 2f - screenPos;
						position23 -= new Vector2(value63.Width, value63.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position23 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value63, position23, rCurrentNPC.frame, value65, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					int num233 = 0;
					float num234 = 0f;
					float num235 = 0f;
					if (type == 370)
					{
						if (rCurrentNPC.ai[0] == -1f)
						{
							num233 = 0;
						}
						if (rCurrentNPC.ai[0] == 3f || rCurrentNPC.ai[0] == 8f)
						{
							int num236 = 60;
							int num237 = 30;
							if (rCurrentNPC.ai[2] > (float)num236)
							{
								num233 = 6;
								num234 = 1f - (float)Math.Cos((rCurrentNPC.ai[2] - (float)num236) / (float)num237 * ((float)Math.PI * 2f));
								num234 /= 3f;
								num235 = 40f;
							}
						}
						if (rCurrentNPC.ai[0] == 4f && rCurrentNPC.ai[2] > (float)num227)
						{
							num233 = 6;
							num234 = 1f - (float)Math.Cos((rCurrentNPC.ai[2] - (float)num227) / (float)num228 * ((float)Math.PI * 2f));
							num234 /= 3f;
							num235 = 60f;
						}
						if (rCurrentNPC.ai[0] == 9f && rCurrentNPC.ai[2] > (float)num227)
						{
							num233 = 6;
							num234 = 1f - (float)Math.Cos((rCurrentNPC.ai[2] - (float)num227) / (float)num228 * ((float)Math.PI * 2f));
							num234 /= 3f;
							num235 = 60f;
						}
						if (rCurrentNPC.ai[0] == 12f)
						{
							num233 = 6;
							num234 = 1f - (float)Math.Cos(rCurrentNPC.ai[2] / 30f * ((float)Math.PI * 2f));
							num234 /= 3f;
							num235 = 20f;
						}
					}
					for (int num238 = 0; num238 < num233; num238++)
					{
						Microsoft.Xna.Framework.Color value66 = npcColor;
						value66 = Microsoft.Xna.Framework.Color.Lerp(value66, value64, amount8);
						value66 = rCurrentNPC.GetAlpha(value66);
						value66 *= 1f - num234;
						Vector2 position24 = rCurrentNPC.Center + ((float)num238 / (float)num233 * ((float)Math.PI * 2f) + rCurrentNPC.rotation).ToRotationVector2() * num235 * num234 - screenPos;
						position24 -= new Vector2(value63.Width, value63.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position24 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value63, position24, rCurrentNPC.frame, value66, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					Vector2 position25 = rCurrentNPC.Center - screenPos;
					position25 -= new Vector2(value63.Width, value63.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					position25 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(value63, position25, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					if (type != 370 || !(rCurrentNPC.ai[0] >= 4f))
					{
						break;
					}
					value63 = TextureAssets.DukeFishron.Value;
					Microsoft.Xna.Framework.Color color40 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.White, Microsoft.Xna.Framework.Color.Yellow, 0.5f);
					value64 = Microsoft.Xna.Framework.Color.Yellow;
					amount8 = 1f;
					num234 = 0.5f;
					num235 = 10f;
					num231 = 1;
					if (rCurrentNPC.ai[0] == 4f)
					{
						float num239 = rCurrentNPC.ai[2] - (float)num227;
						num239 /= (float)num228;
						value64 *= num239;
						color40 *= num239;
					}
					if (rCurrentNPC.ai[0] == 12f)
					{
						float num240 = rCurrentNPC.ai[2];
						num240 /= 30f;
						if (num240 > 0.5f)
						{
							num240 = 1f - num240;
						}
						num240 *= 2f;
						num240 = 1f - num240;
						value64 *= num240;
						color40 *= num240;
					}
					for (int num241 = 1; num241 < num230; num241 += num231)
					{
						_ = ref rCurrentNPC.oldPos[num241];
						Microsoft.Xna.Framework.Color value67 = color40;
						value67 = Microsoft.Xna.Framework.Color.Lerp(value67, value64, amount8);
						value67 *= (float)(num230 - num241) / 15f;
						Vector2 position26 = rCurrentNPC.oldPos[num241] + new Vector2(rCurrentNPC.width, rCurrentNPC.height) / 2f - screenPos;
						position26 -= new Vector2(value63.Width, value63.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position26 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value63, position26, rCurrentNPC.frame, value67, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					for (int num242 = 1; num242 < num233; num242++)
					{
						Microsoft.Xna.Framework.Color value68 = color40;
						value68 = Microsoft.Xna.Framework.Color.Lerp(value68, value64, amount8);
						value68 = rCurrentNPC.GetAlpha(value68);
						value68 *= 1f - num234;
						Vector2 position27 = rCurrentNPC.Center + ((float)num242 / (float)num233 * ((float)Math.PI * 2f) + rCurrentNPC.rotation).ToRotationVector2() * num235 * num234 - screenPos;
						position27 -= new Vector2(value63.Width, value63.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position27 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value63, position27, rCurrentNPC.frame, value68, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					mySpriteBatch.Draw(value63, position25, rCurrentNPC.frame, color40, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					break;
				}
				case 439:
				case 440:
				{
					int num243 = rCurrentNPC.frame.Y / (TextureAssets.Npc[type].Height() / npcFrameCount[type]);
					Texture2D value69 = TextureAssets.Npc[type].Value;
					Texture2D value70 = TextureAssets.Extra[30].Value;
					Microsoft.Xna.Framework.Rectangle rectangle12 = value70.Frame();
					rectangle12.Height /= 2;
					if (num243 >= 4)
					{
						rectangle12.Y += rectangle12.Height;
					}
					Microsoft.Xna.Framework.Color white6 = Microsoft.Xna.Framework.Color.White;
					float amount9 = 0f;
					Microsoft.Xna.Framework.Color color41 = npcColor;
					int num244 = 0;
					int num245 = 0;
					int num246 = 0;
					if (rCurrentNPC.ai[0] == -1f)
					{
						if (rCurrentNPC.ai[1] >= 320f && rCurrentNPC.ai[1] < 960f)
						{
							white6 = Microsoft.Xna.Framework.Color.White;
							amount9 = 0.5f;
							num244 = 6;
							num245 = 2;
							num246 = 1;
						}
					}
					else if (rCurrentNPC.ai[0] == 1f)
					{
						white6 = Microsoft.Xna.Framework.Color.White;
						amount9 = 0.5f;
						num244 = 4;
						num245 = 2;
						num246 = 1;
					}
					else
					{
						color41 = npcColor;
					}
					for (int num247 = num246; num247 < num244; num247 += num245)
					{
						_ = ref rCurrentNPC.oldPos[num247];
						Microsoft.Xna.Framework.Color value71 = color41;
						value71 = Microsoft.Xna.Framework.Color.Lerp(value71, white6, amount9);
						value71 = rCurrentNPC.GetAlpha(value71);
						value71 *= (float)(num244 - num247) / (float)num244;
						value71.A = 100;
						Vector2 position28 = rCurrentNPC.oldPos[num247] + new Vector2(rCurrentNPC.width, rCurrentNPC.height) / 2f - screenPos;
						position28 -= rectangle12.Size() * rCurrentNPC.scale / 2f;
						position28 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value70, position28, rectangle12, value71, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					int num248 = 0;
					float num249 = 0f;
					float num250 = 0f;
					if (rCurrentNPC.ai[0] == 5f && rCurrentNPC.ai[1] >= 0f && rCurrentNPC.ai[1] < 30f)
					{
						num248 = 4;
						num249 = 1f - (float)Math.Cos((rCurrentNPC.ai[1] - 0f) / 30f * (float)Math.PI);
						num249 /= 2f;
						num250 = 70f;
					}
					for (int num251 = 0; num251 < num248; num251++)
					{
						Microsoft.Xna.Framework.Color value72 = npcColor;
						value72 = Microsoft.Xna.Framework.Color.Lerp(value72, white6, amount9);
						value72 = rCurrentNPC.GetAlpha(value72);
						value72 *= 1f - num249;
						Vector2 position29 = rCurrentNPC.Center + ((float)num251 / (float)num248 * ((float)Math.PI * 2f) + rCurrentNPC.rotation).ToRotationVector2() * num250 * num249 - screenPos;
						position29 -= new Vector2(value69.Width, value69.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position29 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value70, position29, rectangle12, value72, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					Vector2 position30 = rCurrentNPC.Center - screenPos;
					position30 -= new Vector2(value69.Width, value69.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					position30 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(value69, position30, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					break;
				}
				case 392:
				case 393:
				case 394:
				case 395:
				{
					Texture2D value62 = TextureAssets.Npc[type].Value;
					Vector2 vec = rCurrentNPC.Center - screenPos + Vector2.UnitY * rCurrentNPC.gfxOffY;
					vec = vec.Floor();
					float num225 = 0f;
					if (type == 393)
					{
						num225 = -8f;
					}
					mySpriteBatch.Draw(value62, vec, rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize + Vector2.UnitY * num225, rCurrentNPC.scale, spriteEffects, 0f);
					if (type == 392)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[48].Value, vec, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 0), rCurrentNPC.rotation, halfSize + Vector2.UnitY * num225, rCurrentNPC.scale, spriteEffects, 0f);
					}
					if (type == 395)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[49].Value, vec, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 0), rCurrentNPC.rotation, halfSize + Vector2.UnitY * num225, rCurrentNPC.scale, spriteEffects, 0f);
					}
					if (type == 394)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[50].Value, vec, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 0), rCurrentNPC.rotation, halfSize + Vector2.UnitY * num225, rCurrentNPC.scale, spriteEffects, 0f);
					}
					break;
				}
				case 83:
				case 84:
				case 179:
					mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, Microsoft.Xna.Framework.Color.White, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					break;
				case 87:
				case 88:
				case 89:
				case 90:
				case 91:
				case 92:
				{
					Microsoft.Xna.Framework.Color alpha14 = rCurrentNPC.GetAlpha(npcColor);
					byte b7 = (byte)((tileColor.R + tileColor.G + tileColor.B) / 3);
					if (alpha14.R < b7)
					{
						alpha14.R = b7;
					}
					if (alpha14.G < b7)
					{
						alpha14.G = b7;
					}
					if (alpha14.B < b7)
					{
						alpha14.B = b7;
					}
					mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, alpha14, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					break;
				}
				default:
				{
					switch (type)
					{
					case 491:
					{
						Texture2D value42 = TextureAssets.Npc[rCurrentNPC.type].Value;
						Microsoft.Xna.Framework.Rectangle frame3 = rCurrentNPC.frame;
						Vector2 origin17 = frame3.OriginFlip(new Vector2(208f, 460f), spriteEffects);
						Vector2 vector36 = rCurrentNPC.Center - screenPos;
						Vector2 vector37 = new Vector2(((spriteEffects & SpriteEffects.FlipHorizontally) == 0) ? 1 : (-1), 1f);
						Microsoft.Xna.Framework.Color alpha8 = rCurrentNPC.GetAlpha(npcColor);
						mySpriteBatch.Draw(value42, vector36, frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						int num112 = (int)rCurrentNPC.localAI[3] / 8;
						value42 = TextureAssets.Extra[40].Value;
						frame3 = value42.Frame(1, 4, 0, num112 % 4);
						origin17 = frame3.Size() * new Vector2(0.5f, 1f);
						mySpriteBatch.Draw(value42, vector36 + (new Vector2(102f, -384f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						value42 = TextureAssets.Extra[41].Value;
						frame3 = value42.Frame(1, 8, 0, num112 % 8);
						origin17 = frame3.Size() * new Vector2(0.5f, 0f) + new Vector2(0f, 10f);
						for (int num113 = 0; num113 < 5; num113++)
						{
							mySpriteBatch.Draw(value42, vector36 + (new Vector2(-96 + 34 * num113, 40f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						}
						value42 = TextureAssets.Extra[42].Value;
						frame3 = value42.Frame(1, 4, 0, num112 % 4);
						origin17 = frame3.Size() * new Vector2(0.5f, 0f);
						for (int num114 = 0; num114 < 2; num114++)
						{
							mySpriteBatch.Draw(value42, vector36 + (new Vector2(158 - 106 * num114, -302f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						}
						value42 = TextureAssets.Extra[43].Value;
						frame3 = value42.Frame(1, 4, 0, num112 % 4);
						origin17 = frame3.Size() * new Vector2(0.5f, 0f);
						for (int num115 = 0; num115 < 2; num115++)
						{
							mySpriteBatch.Draw(value42, vector36 + (new Vector2(42 - 178 * num115, -444f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						}
						value42 = TextureAssets.Extra[44].Value;
						frame3 = value42.Frame(1, 4, 0, num112 % 4);
						origin17 = frame3.Size() * new Vector2(0.5f, 0f);
						mySpriteBatch.Draw(value42, vector36 + (new Vector2(-134f, -302f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						value42 = TextureAssets.Extra[45].Value;
						frame3 = value42.Frame(1, 4, 0, (2 + num112) % 4);
						origin17 = frame3.Size() * new Vector2(0.5f, 0f);
						mySpriteBatch.Draw(value42, vector36 + (new Vector2(-60f, -330f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
						LoadNPC(492);
						if (!TextureAssets.Npc[492].IsLoaded)
						{
							return;
						}
						value42 = TextureAssets.Npc[492].Value;
						frame3 = value42.Frame(1, 9);
						origin17 = frame3.Size() * new Vector2(0.5f, 0f) + new Vector2(0f, 10f);
						for (int num116 = 0; num116 < 4; num116++)
						{
							int num117 = (int)rCurrentNPC.ai[num116];
							if (num117 >= 0)
							{
								frame3.Y = npc[num117].frame.Y;
								mySpriteBatch.Draw(value42, vector36 + (new Vector2(-122 + 68 * num116, -20f) * vector37).RotatedBy(rCurrentNPC.rotation), frame3, alpha8, rCurrentNPC.rotation, origin17, rCurrentNPC.scale, spriteEffects, 0f);
							}
						}
						return;
					}
					case 398:
					{
						bool flag8 = false;
						Texture2D value27 = TextureAssets.Npc[type].Value;
						Texture2D value28 = TextureAssets.Extra[16].Value;
						Texture2D value29 = TextureAssets.Extra[14].Value;
						float num97 = 340f;
						float num98 = 0.5f;
						Vector2 vector22 = new Vector2(220f, -60f);
						Vector2 vector23 = new Vector2(76f, 66f);
						Texture2D value30 = TextureAssets.Extra[13].Value;
						Vector2 origin12 = new Vector2(value30.Width, 278f);
						Vector2 origin13 = new Vector2(0f, 278f);
						Vector2 vector24 = new Vector2(0f, 76f);
						Vector2 center2 = rCurrentNPC.Center;
						Microsoft.Xna.Framework.Point point = (rCurrentNPC.Center + new Vector2(0f, -150f)).ToTileCoordinates();
						Microsoft.Xna.Framework.Color alpha5 = rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.Lerp(Lighting.GetColor(point.X, point.Y), Microsoft.Xna.Framework.Color.White, 0.3f));
						for (int num99 = 0; num99 < 2; num99++)
						{
							bool flag9 = num99 == 0;
							Vector2 vector25 = new Vector2((!flag9) ? 1 : (-1), 1f);
							int num100 = -1;
							for (int num101 = 0; num101 < maxNPCs; num101++)
							{
								if (npc[num101].active && npc[num101].type == 397 && npc[num101].ai[2] == (float)num99 && npc[num101].ai[3] == (float)rCurrentNPC.whoAmI)
								{
									num100 = num101;
									break;
								}
							}
							if (num100 != -1)
							{
								Vector2 vector26 = center2 + vector22 * vector25;
								Vector2 vector27 = (npc[num100].Center + vector24 - vector26) * num98;
								if (flag8)
								{
									dust[Dust.NewDust(vector26 + vector27, 0, 0, 6)].noGravity = true;
								}
								float num102 = (float)Math.Acos(vector27.Length() / num97) * (0f - vector25.X);
								SpriteEffects effects2 = ((!flag9) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
								Vector2 origin14 = vector23;
								if (!flag9)
								{
									origin14.X = (float)value29.Width - origin14.X;
								}
								mySpriteBatch.Draw(value29, vector26 - screenPos, null, alpha5, vector27.ToRotation() - num102 - (float)Math.PI / 2f, origin14, 1f, effects2, 0f);
								if (flag8)
								{
									dust[Dust.NewDust(vector26, 0, 0, 6)].noGravity = true;
								}
								if (flag8)
								{
									dust[Dust.NewDust(center2, 0, 0, 6)].noGravity = true;
								}
								if (flag8)
								{
									dust[Dust.NewDust(vector26 + new Vector2(0f, num97).RotatedBy(vector27.ToRotation() - num102 - (float)Math.PI / 2f), 0, 0, 6)].noGravity = true;
								}
							}
						}
						mySpriteBatch.Draw(value30, center2 - screenPos, null, alpha5, 0f, origin12, 1f, SpriteEffects.None, 0f);
						mySpriteBatch.Draw(value30, center2 - screenPos, null, alpha5, 0f, origin13, 1f, SpriteEffects.FlipHorizontally, 0f);
						mySpriteBatch.Draw(value28, center2 - screenPos, null, alpha5, 0f, new Vector2(112f, 101f), 1f, SpriteEffects.None, 0f);
						mySpriteBatch.Draw(value27, center2 - screenPos, rCurrentNPC.frame, alpha5, 0f, rCurrentNPC.frame.Size() / 2f, 1f, SpriteEffects.None, 0f);
						return;
					}
					case 397:
					{
						Texture2D value43 = TextureAssets.Npc[type].Value;
						float num118 = 0.5f;
						Vector2 vector38 = new Vector2(220f, -60f);
						Vector2 vector39 = new Vector2(0f, 76f);
						Texture2D value44 = TextureAssets.Extra[15].Value;
						Vector2 vector40 = new Vector2(60f, 30f);
						float num119 = 340f;
						Vector2 center3 = npc[(int)rCurrentNPC.ai[3]].Center;
						Microsoft.Xna.Framework.Point point4 = rCurrentNPC.Center.ToTileCoordinates();
						Microsoft.Xna.Framework.Color alpha9 = rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.Lerp(Lighting.GetColor(point4.X, point4.Y), Microsoft.Xna.Framework.Color.White, 0.3f));
						bool flag10 = rCurrentNPC.ai[2] == 0f;
						Vector2 vector41 = new Vector2((!flag10) ? 1 : (-1), 1f);
						Vector2 origin18 = new Vector2(120f, 180f);
						if (!flag10)
						{
							origin18.X = (float)value43.Width - origin18.X;
						}
						Texture2D value45 = TextureAssets.Extra[17].Value;
						Texture2D value46 = TextureAssets.Extra[19].Value;
						Vector2 vector42 = new Vector2(26f, 42f);
						if (!flag10)
						{
							vector42.X = (float)value45.Width - vector42.X;
						}
						Vector2 vector43 = new Vector2(30f, 66f);
						Vector2 vector44 = new Vector2(1f * (0f - vector41.X), 3f);
						Texture2D value47 = TextureAssets.Extra[26].Value;
						Microsoft.Xna.Framework.Rectangle value48 = value47.Frame();
						value48.Height /= 4;
						Vector2 vector45 = center3 + vector38 * vector41;
						Vector2 vector46 = rCurrentNPC.Center + vector39;
						Vector2 v = vector45 - vector46;
						v *= 1f - num118;
						Vector2 origin19 = vector40;
						if (!flag10)
						{
							origin19.X = (float)value44.Width - origin19.X;
						}
						float num120 = (float)Math.Acos(v.Length() / num119) * (0f - vector41.X);
						mySpriteBatch.Draw(value44, vector46 - screenPos, null, alpha9, v.ToRotation() + num120 - (float)Math.PI / 2f, origin19, 1f, spriteEffects, 0f);
						if (rCurrentNPC.ai[0] == -2f)
						{
							int num121 = (int)rCurrentNPC.ai[1];
							num121 /= 8;
							value48.Y += value48.Height * num121;
							mySpriteBatch.Draw(value47, rCurrentNPC.Center - screenPos, value48, alpha9, 0f, vector42 - new Vector2(4f, 4f), 1f, spriteEffects, 0f);
						}
						else
						{
							mySpriteBatch.Draw(value45, rCurrentNPC.Center - screenPos, null, alpha9, 0f, vector42, 1f, spriteEffects, 0f);
							Vector2 vector47 = Utils.Vector2FromElipse(rCurrentNPC.localAI[0].ToRotationVector2(), vector43 * rCurrentNPC.localAI[1]);
							mySpriteBatch.Draw(value46, rCurrentNPC.Center - screenPos + vector47 + vector44, null, alpha9, 0f, new Vector2(value46.Width, value46.Height) / 2f, 1f, SpriteEffects.None, 0f);
						}
						mySpriteBatch.Draw(value43, rCurrentNPC.Center - screenPos, rCurrentNPC.frame, alpha9, 0f, origin18, 1f, spriteEffects, 0f);
						return;
					}
					case 396:
					{
						Texture2D value33 = TextureAssets.Npc[type].Value;
						Vector2 origin15 = new Vector2(191f, 130f) / 2f;
						Texture2D value34 = TextureAssets.Extra[18].Value;
						Texture2D value35 = TextureAssets.Extra[19].Value;
						Vector2 vector28 = new Vector2(19f, 34f);
						Vector2 vector29 = new Vector2(27f, 59f);
						Vector2 vector30 = new Vector2(0f, 0f);
						Texture2D value36 = TextureAssets.Extra[25].Value;
						Vector2 vector31 = new Vector2(0f, 214f).RotatedBy(rCurrentNPC.rotation);
						Microsoft.Xna.Framework.Rectangle rectangle10 = value36.Frame();
						rectangle10.Height /= 3;
						rectangle10.Y += rectangle10.Height * (int)(rCurrentNPC.localAI[2] / 7f);
						Texture2D value37 = TextureAssets.Extra[29].Value;
						Vector2 vector32 = new Vector2(0f, 4f).RotatedBy(rCurrentNPC.rotation);
						Microsoft.Xna.Framework.Rectangle rectangle11 = value37.Frame();
						rectangle11.Height /= 4;
						rectangle11.Y += rectangle11.Height * (int)(rCurrentNPC.localAI[3] / 5f);
						Texture2D value38 = TextureAssets.Extra[26].Value;
						Microsoft.Xna.Framework.Rectangle value39 = value38.Frame();
						value39.Height /= 4;
						_ = npc[(int)rCurrentNPC.ai[3]].Center;
						Microsoft.Xna.Framework.Point point2 = rCurrentNPC.Center.ToTileCoordinates();
						Microsoft.Xna.Framework.Color alpha6 = rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.Lerp(Lighting.GetColor(point2.X, point2.Y), Microsoft.Xna.Framework.Color.White, 0.3f));
						if (rCurrentNPC.ai[0] < 0f)
						{
							int num107 = (int)rCurrentNPC.ai[1];
							num107 /= 8;
							value39.Y += value39.Height * num107;
							mySpriteBatch.Draw(value38, rCurrentNPC.Center - screenPos, value39, alpha6, rCurrentNPC.rotation, vector28 + new Vector2(4f, 4f), 1f, spriteEffects, 0f);
						}
						else
						{
							mySpriteBatch.Draw(value34, rCurrentNPC.Center - screenPos, null, alpha6, rCurrentNPC.rotation, vector28, 1f, spriteEffects, 0f);
							Vector2 vector33 = Utils.Vector2FromElipse(rCurrentNPC.localAI[0].ToRotationVector2(), vector29 * rCurrentNPC.localAI[1]);
							mySpriteBatch.Draw(value35, rCurrentNPC.Center - screenPos + vector33 + vector30, null, alpha6, rCurrentNPC.rotation, new Vector2(value35.Width, value35.Height) / 2f, 1f, SpriteEffects.None, 0f);
						}
						mySpriteBatch.Draw(value33, rCurrentNPC.Center - screenPos, value33.Frame(3, 3, rCurrentNPC.frame.Y / 3, rCurrentNPC.frame.Y % 3), alpha6, rCurrentNPC.rotation, origin15, 2f, spriteEffects, 0f);
						mySpriteBatch.Draw(value37, (rCurrentNPC.Center - screenPos + vector32).Floor(), rectangle11, alpha6, rCurrentNPC.rotation, rectangle11.Size() / 2f, 1f, spriteEffects, 0f);
						mySpriteBatch.Draw(value36, (rCurrentNPC.Center - screenPos + vector31).Floor(), rectangle10, alpha6, rCurrentNPC.rotation, rectangle10.Size() / 2f, 1f, spriteEffects, 0f);
						return;
					}
					case 400:
					{
						Texture2D value40 = TextureAssets.Npc[type].Value;
						Texture2D value41 = TextureAssets.Extra[19].Value;
						Vector2 origin16 = new Vector2(40f, 40f);
						Vector2 vector34 = new Vector2(30f, 30f);
						_ = rCurrentNPC.Center;
						Microsoft.Xna.Framework.Point point3 = rCurrentNPC.Center.ToTileCoordinates();
						Microsoft.Xna.Framework.Color alpha7 = rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.Lerp(Lighting.GetColor(point3.X, point3.Y), Microsoft.Xna.Framework.Color.White, 0.3f));
						mySpriteBatch.Draw(value40, rCurrentNPC.Center - screenPos, rCurrentNPC.frame, alpha7, rCurrentNPC.rotation, origin16, 1f, spriteEffects, 0f);
						Vector2 vector35 = Utils.Vector2FromElipse(rCurrentNPC.localAI[0].ToRotationVector2(), vector34 * rCurrentNPC.localAI[1]);
						mySpriteBatch.Draw(value41, rCurrentNPC.Center - screenPos + vector35, null, alpha7, rCurrentNPC.rotation, value41.Size() / 2f, rCurrentNPC.localAI[2], SpriteEffects.None, 0f);
						return;
					}
					case 416:
					{
						int num108 = -1;
						int num109 = (int)rCurrentNPC.ai[0];
						Vector2 position16 = rCurrentNPC.position;
						Vector2 spinningpoint3 = Vector2.Zero;
						if (npc[num109].active && npc[num109].type == 415)
						{
							num108 = num109;
						}
						if (num108 != -1)
						{
							Vector2 position17 = rCurrentNPC.position;
							rCurrentNPC.Bottom = npc[num108].Bottom;
							position16 = rCurrentNPC.position;
							rCurrentNPC.position = position17;
							rCurrentNPC.gfxOffY = npc[num108].gfxOffY;
							spinningpoint3 = npc[num108].velocity;
						}
						Microsoft.Xna.Framework.Rectangle frame2 = rCurrentNPC.frame;
						mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(position16.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, position16.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame2, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						if (rCurrentNPC.color != default(Microsoft.Xna.Framework.Color))
						{
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(position16.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, position16.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame2, rCurrentNPC.GetColor(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						mySpriteBatch.Draw(TextureAssets.GlowMask[156].Value, position16 + rCurrentNPC.Size * new Vector2(0.5f, 1f) - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						float num110 = 0.5f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.5f;
						for (int num111 = 0; num111 < 4; num111++)
						{
							mySpriteBatch.Draw(TextureAssets.GlowMask[156].Value, position16 + rCurrentNPC.Size * new Vector2(0.5f, 1f) - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + spinningpoint3.RotatedBy((float)num111 * ((float)Math.PI / 2f)) * num110, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						return;
					}
					case 399:
					{
						Texture2D value31 = TextureAssets.Npc[type].Value;
						(rCurrentNPC.position - screenPos + Vector2.UnitY * rCurrentNPC.gfxOffY).Floor();
						float num103 = 5f;
						for (int num104 = 0; (float)num104 < num103; num104++)
						{
							float num105 = 1f - (GlobalTimeWrappedHourly + (float)num104) % num103 / num103;
							Microsoft.Xna.Framework.Color color23 = Microsoft.Xna.Framework.Color.LimeGreen;
							if (rCurrentNPC.ai[0] == 1f)
							{
								color23 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.LimeGreen, Microsoft.Xna.Framework.Color.Red, MathHelper.Clamp(rCurrentNPC.ai[1] / 20f, 0f, 1f));
							}
							if (rCurrentNPC.ai[0] == 2f)
							{
								color23 = Microsoft.Xna.Framework.Color.Red;
							}
							color23 *= 1f - num105;
							color23.A = 0;
							for (int num106 = 0; num106 < 2; num106++)
							{
								mySpriteBatch.Draw(TextureAssets.Extra[27].Value, rCurrentNPC.Center - screenPos + Vector2.UnitY * (rCurrentNPC.gfxOffY - 4f + 6f), null, color23, (float)Math.PI / 2f, new Vector2(10f, 48f), num105 * 4f, SpriteEffects.None, 0f);
							}
						}
						mySpriteBatch.Draw(value31, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						value31 = TextureAssets.GlowMask[100].Value;
						mySpriteBatch.Draw(value31, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(127 - rCurrentNPC.alpha / 2, 127 - rCurrentNPC.alpha / 2, 127 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						value31 = TextureAssets.Extra[20].Value;
						Microsoft.Xna.Framework.Rectangle value32 = value31.Frame(1, 4, 0, (int)rCurrentNPC.ai[0] + 1);
						Vector2 position15 = new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)value31.Width * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY + 18f + 6f);
						mySpriteBatch.Draw(value31, position15, value32, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						value31 = TextureAssets.GlowMask[101].Value;
						mySpriteBatch.Draw(value31, position15, value32, new Microsoft.Xna.Framework.Color(127 - rCurrentNPC.alpha / 2, 127 - rCurrentNPC.alpha / 2, 127 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						return;
					}
					case 94:
					{
						for (int num96 = 1; num96 < 6; num96 += 2)
						{
							_ = ref rCurrentNPC.oldPos[num96];
							Microsoft.Xna.Framework.Color alpha4 = rCurrentNPC.GetAlpha(npcColor);
							alpha4.R = (byte)(alpha4.R * (10 - num96) / 15);
							alpha4.G = (byte)(alpha4.G * (10 - num96) / 15);
							alpha4.B = (byte)(alpha4.B * (10 - num96) / 15);
							alpha4.A = (byte)(alpha4.A * (10 - num96) / 15);
							alpha4 = rCurrentNPC.GetShimmerColor(alpha4);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num96].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num96].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, alpha4, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					case 384:
						return;
					}
					if (type == 125 || type == 126 || type == 127 || type == 128 || type == 129 || type == 130 || type == 131 || (type == 139 && rCurrentNPC.ai[3] == 0f) || type == 140)
					{
						for (int num122 = 9; num122 >= 0; num122 -= 2)
						{
							_ = ref rCurrentNPC.oldPos[num122];
							Microsoft.Xna.Framework.Color alpha10 = rCurrentNPC.GetAlpha(npcColor);
							alpha10.R = (byte)(alpha10.R * (10 - num122) / 20);
							alpha10.G = (byte)(alpha10.G * (10 - num122) / 20);
							alpha10.B = (byte)(alpha10.B * (10 - num122) / 20);
							alpha10.A = (byte)(alpha10.A * (10 - num122) / 20);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num122].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num122].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, alpha10, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					if (type == 417 && rCurrentNPC.ai[0] >= 6f && rCurrentNPC.ai[0] <= 6f)
					{
						for (int num123 = 5; num123 >= 0; num123--)
						{
							_ = ref rCurrentNPC.oldPos[num123];
							Microsoft.Xna.Framework.Color alpha11 = rCurrentNPC.GetAlpha(npcColor);
							alpha11.R = (byte)(alpha11.R * (10 - num123) / 20);
							alpha11.G = (byte)(alpha11.G * (10 - num123) / 20);
							alpha11.B = (byte)(alpha11.B * (10 - num123) / 20);
							alpha11.A = (byte)(alpha11.A * (10 - num123) / 20);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num123].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num123].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, alpha11, rCurrentNPC.oldRot[num123], halfSize, MathHelper.Lerp(0.5f, 1f, (5f - (float)num123) / 6f), spriteEffects, 0f);
						}
					}
					if (type == 419 && rCurrentNPC.ai[2] <= -9f)
					{
						int num124 = TextureAssets.GlowMask[154].Height() / npcFrameCount[type];
						int num125 = rCurrentNPC.frame.Y / num124;
						for (int num126 = 6; num126 >= 0; num126--)
						{
							_ = ref rCurrentNPC.oldPos[num126];
							Microsoft.Xna.Framework.Color white3 = Microsoft.Xna.Framework.Color.White;
							white3.R = (byte)(255 * (10 - num126) / 20);
							white3.G = (byte)(255 * (10 - num126) / 20);
							white3.B = (byte)(255 * (10 - num126) / 20);
							white3.A = 0;
							Microsoft.Xna.Framework.Rectangle frame4 = rCurrentNPC.frame;
							int num127 = (num125 - 3 - num126) % 3;
							if (num127 < 0)
							{
								num127 += 3;
							}
							num127 += 5;
							frame4.Y = num124 * num127;
							mySpriteBatch.Draw(TextureAssets.GlowMask[154].Value, new Vector2(rCurrentNPC.oldPos[num126].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num126].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), frame4, white3, rCurrentNPC.oldRot[num126], halfSize, MathHelper.Lerp(0.75f, 1.2f, (10f - (float)num126) / 10f), spriteEffects, 0f);
						}
					}
					if (type == 418 && (rCurrentNPC.ai[0] == 2f || rCurrentNPC.ai[0] == 4f))
					{
						Texture2D value49 = TextureAssets.Extra[55].Value;
						Vector2 origin20 = new Vector2(value49.Width / 2, value49.Height / 8 + 14);
						int num128 = (int)rCurrentNPC.ai[1] / 2;
						float num129 = -(float)Math.PI / 2f * (float)rCurrentNPC.spriteDirection;
						float num130 = rCurrentNPC.ai[1] / 45f;
						if (num130 > 1f)
						{
							num130 = 1f;
						}
						num128 %= 4;
						for (int num131 = 6; num131 >= 0; num131--)
						{
							_ = ref rCurrentNPC.oldPos[num131];
							Microsoft.Xna.Framework.Color value50 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Gold, Microsoft.Xna.Framework.Color.OrangeRed, num130);
							value50 = Microsoft.Xna.Framework.Color.Lerp(value50, Microsoft.Xna.Framework.Color.Blue, (float)num131 / 12f);
							value50.A = (byte)(64f * num130);
							value50.R = (byte)(value50.R * (10 - num131) / 20);
							value50.G = (byte)(value50.G * (10 - num131) / 20);
							value50.B = (byte)(value50.B * (10 - num131) / 20);
							value50.A = (byte)(value50.A * (10 - num131) / 20);
							value50 *= num130;
							int num132 = (num128 - num131) % 4;
							if (num132 < 0)
							{
								num132 += 4;
							}
							Microsoft.Xna.Framework.Rectangle value51 = value49.Frame(1, 4, 0, num132);
							mySpriteBatch.Draw(value49, new Vector2(rCurrentNPC.oldPos[num131].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num131].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), value51, value50, rCurrentNPC.oldRot[num131] + num129, origin20, MathHelper.Lerp(0.1f, 1.2f, (10f - (float)num131) / 10f), spriteEffects, 0f);
						}
					}
					if (type == 516)
					{
						int num133 = TextureAssets.Npc[type].Height() / npcFrameCount[type];
						int num134 = rCurrentNPC.frame.Y / num133;
						for (int num135 = 6; num135 >= 0; num135--)
						{
							_ = ref rCurrentNPC.oldPos[num135];
							Microsoft.Xna.Framework.Color white4 = Microsoft.Xna.Framework.Color.White;
							white4.R = (byte)(255 * (10 - num135) / 20);
							white4.G = (byte)(255 * (10 - num135) / 20);
							white4.B = (byte)(255 * (10 - num135) / 20);
							white4.A = (byte)(255 * (10 - num135) / 20);
							white4 = Microsoft.Xna.Framework.Color.Lerp(white4, Microsoft.Xna.Framework.Color.Transparent, (float)num135 / 6f);
							Microsoft.Xna.Framework.Rectangle frame5 = rCurrentNPC.frame;
							int num136 = (num134 - 4 - num135) % 4;
							if (num136 < 0)
							{
								num136 += 4;
							}
							frame5.Y = num133 * num136;
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num135].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num135].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), frame5, white4, rCurrentNPC.rotation, halfSize, MathHelper.Lerp(0.35f, 1.2f, (10f - (float)num135) / 10f), spriteEffects, 0f);
						}
					}
					if (rCurrentNPC.type == 390 && rCurrentNPC.IsABestiaryIconDummy)
					{
						LoadNPC(391);
						Texture2D value52 = TextureAssets.Npc[391].Value;
						Microsoft.Xna.Framework.Rectangle value53 = value52.Frame(1, npcFrameCount[391], 0, (int)rCurrentNPC.localAI[3]);
						Vector2 vector48 = new Vector2(-rCurrentNPC.width - 8, 10f);
						mySpriteBatch.Draw(value52, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY) + vector48, value53, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					Microsoft.Xna.Framework.Rectangle frame6 = rCurrentNPC.frame;
					if (type == 182 || type == 289)
					{
						frame6.Height -= 2;
					}
					switch (type)
					{
					case 420:
					case 421:
					case 423:
					case 424:
					{
						float num140 = 9f + 3f * (float)Math.Cos((float)Math.PI * 2f * GlobalTimeWrappedHourly);
						Vector2 spinningpoint5 = Vector2.UnitX * num140;
						Microsoft.Xna.Framework.Color color25 = Microsoft.Xna.Framework.Color.Teal * (num140 / 12f) * 0.8f;
						color25.A /= 2;
						for (float num141 = 0f; num141 < (float)Math.PI * 2f; num141 += (float)Math.PI / 2f)
						{
							Vector2 vector51 = rCurrentNPC.position + spinningpoint5.RotatedBy(num141);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(vector51.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, vector51.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, color25, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					case 662:
					{
						float num137 = 4f + 2f * (float)Math.Cos((float)Math.PI * 2f * GlobalTimeWrappedHourly);
						Vector2 spinningpoint4 = Vector2.UnitX * num137;
						Microsoft.Xna.Framework.Color color24 = Microsoft.Xna.Framework.Color.Cyan * (num137 / 12f) * 0.4f;
						color24.A /= 4;
						for (float num138 = 0.9f; num138 >= 0f; num138 -= 0.125f)
						{
							Vector2 vector49 = rCurrentNPC.position - rCurrentNPC.velocity * 10f * num138;
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(vector49.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, vector49.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, color24 * (1f - num138), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						for (float num139 = 0f; num139 < (float)Math.PI * 2f; num139 += (float)Math.PI / 2f)
						{
							Vector2 vector50 = rCurrentNPC.position + spinningpoint4.RotatedBy(num139);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(vector50.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, vector50.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, color24, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						break;
					}
					}
					if (rCurrentNPC.aiStyle == 7)
					{
						DrawNPCExtras(rCurrentNPC, beforeDraw: true, num47, num46, npcColor, halfSize, spriteEffects, screenPos);
					}
					if (type == 346 && (double)rCurrentNPC.life < (double)rCurrentNPC.lifeMax * 0.5)
					{
						mySpriteBatch.Draw(TextureAssets.SantaTank.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 356)
					{
						frame6.Height--;
						mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 360)
					{
						int num142 = 0;
						if (rCurrentNPC.ai[2] == 0f)
						{
							if (rCurrentNPC.rotation == 3.14f || rCurrentNPC.rotation == -3.14f)
							{
								num47 = 2f;
							}
							if (rCurrentNPC.direction < 0 && (rCurrentNPC.rotation == 1.57f || rCurrentNPC.rotation == 4.71f))
							{
								num142 = 1;
							}
							if (rCurrentNPC.direction > 0 && (rCurrentNPC.rotation == 1.57f || rCurrentNPC.rotation == 4.71f))
							{
								num142 = -1;
							}
						}
						mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale + (float)num142, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 655)
					{
						int num143 = 0;
						if (rCurrentNPC.ai[2] == 0f)
						{
							if (rCurrentNPC.rotation == 3.14f || rCurrentNPC.rotation == -3.14f)
							{
								num47 = 2f;
							}
							if (rCurrentNPC.direction < 0 && (rCurrentNPC.rotation == 1.57f || rCurrentNPC.rotation == 4.71f))
							{
								num143 = 1;
							}
							if (rCurrentNPC.direction > 0 && (rCurrentNPC.rotation == 1.57f || rCurrentNPC.rotation == 4.71f))
							{
								num143 = -1;
							}
						}
						mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale + (float)num143, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.Orange), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 266 && rCurrentNPC.life < rCurrentNPC.lifeMax && (expertMode || getGoodWorld))
					{
						Microsoft.Xna.Framework.Color alpha12 = rCurrentNPC.GetAlpha(npcColor);
						float num144 = 1f - (float)rCurrentNPC.life / (float)rCurrentNPC.lifeMax;
						if (expertMode)
						{
							num144 *= 2f;
						}
						num144 *= num144;
						if (getGoodWorld)
						{
							num144 = 1f;
						}
						num144 = MathHelper.Clamp(num144, 0f, 1f);
						alpha12.R = (byte)((float)(int)alpha12.R * num144);
						alpha12.G = (byte)((float)(int)alpha12.G * num144);
						alpha12.B = (byte)((float)(int)alpha12.B * num144);
						alpha12.A = (byte)((float)(int)alpha12.A * num144);
						for (int num145 = 0; num145 < 4; num145++)
						{
							Vector2 position18 = rCurrentNPC.position;
							float num146 = Math.Abs(rCurrentNPC.Center.X - Main.player[myPlayer].Center.X);
							float num147 = Math.Abs(rCurrentNPC.Center.Y - Main.player[myPlayer].Center.Y);
							if (num145 == 0 || num145 == 2)
							{
								position18.X = Main.player[myPlayer].Center.X + num146;
							}
							else
							{
								position18.X = Main.player[myPlayer].Center.X - num146;
							}
							position18.X -= rCurrentNPC.width / 2;
							if (num145 == 0 || num145 == 1)
							{
								position18.Y = Main.player[myPlayer].Center.Y + num147;
							}
							else
							{
								position18.Y = Main.player[myPlayer].Center.Y - num147;
							}
							position18.Y -= rCurrentNPC.height / 2;
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(position18.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, position18.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, alpha12, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 421 && rCurrentNPC.ai[0] == 5f)
					{
						Player player = Main.player[rCurrentNPC.target];
						if (player.gravDir == -1f)
						{
							spriteEffects |= SpriteEffects.FlipVertically;
						}
						mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(player.direction * 4, player.gfxOffY) + ((player.gravDir == 1f) ? player.Top : player.Bottom) - screenPos, frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, frame6.Size() / 2f, rCurrentNPC.scale, spriteEffects, 0f);
						mySpriteBatch.Draw(TextureAssets.GlowMask[146].Value, new Vector2(player.direction * 4, player.gfxOffY) + ((player.gravDir == 1f) ? player.Top : player.Bottom) - screenPos, frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, frame6.Size() / 2f, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else
					{
						switch (type)
						{
						case 518:
						{
							Vector2 vector55 = new Vector2(-10f, 0f);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize + vector55, rCurrentNPC.scale, spriteEffects, 0f);
							if (rCurrentNPC.color != default(Microsoft.Xna.Framework.Color))
							{
								mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetColor(npcColor), rCurrentNPC.rotation, halfSize + vector55, rCurrentNPC.scale, spriteEffects, 0f);
							}
							break;
						}
						case 676:
						case 681:
						{
							if (rCurrentNPC.IsAPortraitDummy)
							{
								Matrix uIScaleMatrix = UIScaleMatrix;
								Microsoft.Xna.Framework.Rectangle scissorRectangle = mySpriteBatch.GraphicsDevice.ScissorRectangle;
								mySpriteBatch.End();
								mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, ScissorState, null, uIScaleMatrix);
								mySpriteBatch.GraphicsDevice.ScissorRectangle = scissorRectangle;
							}
							else if (!rCurrentNPC.IsABestiaryIconDummy)
							{
								RasterizerState rasterizerState = mySpriteBatch.GraphicsDevice.RasterizerState;
								mySpriteBatch.End();
								mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, rasterizerState, null, Transform);
							}
							DrawData value54 = new DrawData(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects);
							GameShaders.Misc["RainbowTownSlime"].Apply(value54);
							value54.Draw(mySpriteBatch);
							pixelShader.CurrentTechnique.Passes[0].Apply();
							if (rCurrentNPC.IsAPortraitDummy)
							{
								Matrix uIScaleMatrix2 = UIScaleMatrix;
								Microsoft.Xna.Framework.Rectangle scissorRectangle2 = mySpriteBatch.GraphicsDevice.ScissorRectangle;
								mySpriteBatch.End();
								mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, ScissorState, null, uIScaleMatrix2);
								mySpriteBatch.GraphicsDevice.ScissorRectangle = scissorRectangle2;
							}
							else if (!rCurrentNPC.IsABestiaryIconDummy)
							{
								mySpriteBatch.End();
								mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
							}
							break;
						}
						case 685:
						{
							Vector2 scale4 = new Vector2(rCurrentNPC.scale);
							float num154 = rCurrentNPC.rotation;
							int num155 = 9;
							Vector2 vector52 = rCurrentNPC.oldPos[num155];
							if (vector52 != Vector2.Zero && rCurrentNPC.velocity.Y == 0f)
							{
								Vector2 position20 = rCurrentNPC.position;
								Vector2 vector53 = vector52 - position20;
								float num156 = (float)Math.Sin(vector53.X / 30f * ((float)Math.PI * 2f));
								float num157 = (float)Math.Sin(vector53.Y / 30f * ((float)Math.PI * 2f));
								float num158 = Utils.Remap(vector53.Length(), 0f, 30f, 0f, 1f);
								scale4.X += num156 * num158 * 0.25f;
								scale4.Y += num157 * num158 * 0.25f;
								float num159 = (float)Math.Sin(Utils.Remap(vector53.Length(), 0f, 20f, 0f, 1f) * ((float)Math.PI * 2f));
								num154 += num159 * ((float)Math.PI / 4f) * 0.1f * (float)rCurrentNPC.spriteDirection;
							}
							Vector2 vector54 = new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - 2f - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY);
							if (rCurrentNPC.velocity.Y == 0f)
							{
								vector54 = vector54.Floor();
								int num160 = 2;
								float num161 = vector54.X % 16f;
								if (num161 < (float)num160)
								{
									vector54.X -= num161;
								}
								if (num161 > (float)(16 - num160))
								{
									vector54.X += 16f - num161;
								}
							}
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, vector54, frame6, rCurrentNPC.GetAlpha(npcColor), num154, halfSize, scale4, spriteEffects, 0f);
							break;
						}
						case 267:
						{
							Vector2 position21 = rCurrentNPC.Center + new Vector2(0f, num47 + num46 + rCurrentNPC.gfxOffY) - screenPos;
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, position21, frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							if (rCurrentNPC.color != default(Microsoft.Xna.Framework.Color))
							{
								mySpriteBatch.Draw(TextureAssets.Npc[type].Value, position21, frame6, rCurrentNPC.GetColor(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							}
							break;
						}
						default:
							if (rCurrentNPC.aiStyle == 7 && rCurrentNPC.ai[0] == 25f)
							{
								int num148 = type;
								float num149 = Utils.Remap(rCurrentNPC.ai[1], 0f, 60f, 0f, 1f);
								mySpriteBatch.End();
								mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, Transform);
								DrawData drawData = new DrawData(TextureAssets.Npc[num148].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, Microsoft.Xna.Framework.Color.White * Utils.Remap(num149, 0f, 1f, 0f, 1f) * ((float)(int)rCurrentNPC.GetAlpha(npcColor).A / 255f), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects);
								drawData.shader = ContentSamples.DyeShaderIDs.ColorOnlyShaderIndex;
								GameShaders.Armor.Apply(ContentSamples.DyeShaderIDs.ColorOnlyShaderIndex, rCurrentNPC, drawData);
								float num150 = Utils.Remap(rCurrentNPC.ai[1], 45f, 90f, 0f, 1f);
								for (float num151 = 0f; num151 < 1f; num151 += 1f / 6f)
								{
									DrawData drawData2 = drawData;
									drawData2.color = hslToRgb(num151, 0.9f, 0.65f) * num150 * 0.5f;
									drawData2.position += ((GlobalTimeWrappedHourly + num151) * ((float)Math.PI * 2f)).ToRotationVector2() * 4f * num150;
									drawData2.Draw(mySpriteBatch);
								}
								drawData.Draw(mySpriteBatch);
								pixelShader.CurrentTechnique.Passes[0].Apply();
								Microsoft.Xna.Framework.Color drawColor = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
								float num152 = (float)Math.Sin(timeForVisualEffects * 6.2831854820251465 / 20.0);
								DrawPrettyStarSparkle(num149, SpriteEffects.None, drawData.position, drawColor, hslToRgb(GlobalTimeWrappedHourly % 1f, 1f, 0.65f, 127), Utils.Remap(rCurrentNPC.ai[1], 30f, 60f, 0f, 30f), 0f, 30f, 30f, 36f, 0f, new Vector2(1.5f, 2.5f) * (1f + num152 * 0.025f), new Vector2(2f, 2f));
								DrawPrettyStarSparkle(num149, SpriteEffects.None, drawData.position, drawColor, hslToRgb(GlobalTimeWrappedHourly % 1f, 1f, 0.65f, 127), Utils.Remap(rCurrentNPC.ai[1], 30f, 60f, 0f, 30f), 0f, 30f, 30f, 36f, (float)Math.PI / 4f, new Vector2(2.5f, 2.5f) * (1f + num152 * 0.025f), new Vector2(1f, 1f));
								mySpriteBatch.End();
								mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
							}
							else
							{
								int num153 = type;
								if (NPC.IsMechQueenUp && num153 == 134)
								{
									num153 = 136;
									LoadNPC(num153);
								}
								Vector2 position19 = new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale + num45, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY);
								mySpriteBatch.Draw(TextureAssets.Npc[num153].Value, position19, frame6, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								if (rCurrentNPC.color != default(Microsoft.Xna.Framework.Color))
								{
									mySpriteBatch.Draw(TextureAssets.Npc[num153].Value, position19, frame6, rCurrentNPC.GetColor(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								}
							}
							break;
						}
					}
					if (rCurrentNPC.type == 695 && rCurrentNPC.ai[0] == 2f)
					{
						int num162 = 60;
						int emoteId2 = 0;
						if (rCurrentNPC.ai[1] < (float)num162)
						{
							EmoteBubble.DrawTemporaryBubble(spriteBatch, emoteId2, num162, num162 - (int)rCurrentNPC.ai[1], rCurrentNPC);
						}
					}
					if (rCurrentNPC.confused)
					{
						mySpriteBatch.Draw(TextureAssets.Confuse.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 - (float)TextureAssets.Confuse.Height() - 20f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Confuse.Width(), TextureAssets.Confuse.Height()), rCurrentNPC.GetShimmerColor(new Microsoft.Xna.Framework.Color(250, 250, 250, 70)), rCurrentNPC.velocity.X * -0.05f, new Vector2(TextureAssets.Confuse.Width() / 2, TextureAssets.Confuse.Height() / 2), essScale + 0.2f, SpriteEffects.None, 0f);
					}
					if (type == 247 || type == 248)
					{
						Vector2 vector56 = new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY);
						Texture2D value55 = TextureAssets.Npc[type].Value;
						if (rCurrentNPC.ai[0] == 1f)
						{
							for (int num163 = 0; num163 < 3; num163++)
							{
								int num164 = num163 * 5;
								int num165 = num164 + 15;
								float num166 = Utils.Remap(rCurrentNPC.ai[1], num164, num165, 0f, 1f);
								if (num166 != 0f)
								{
									float num167 = Utils.Remap(num166, 0f, 1f, 2f, 1.1f + 0.1f * (float)num163);
									float num168 = num166;
									mySpriteBatch.Draw(color: new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num168, texture: value55, position: vector56, sourceRectangle: frame6, rotation: rCurrentNPC.rotation, origin: halfSize, scale: rCurrentNPC.scale * num167, effects: spriteEffects, layerDepth: 0f);
								}
							}
						}
						if (rCurrentNPC.ai[0] == 2f)
						{
							Microsoft.Xna.Framework.Color color26 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * Utils.Remap(rCurrentNPC.ai[1], 0f, 30f, 1f, 0f);
							for (int num169 = 0; num169 < 3; num169++)
							{
								float num170 = 1f;
								Vector2 position22 = vector56 + rCurrentNPC.velocity * num169 * -2f;
								float num171 = Utils.Remap(num169, 0f, 3f, 1f, 0f);
								mySpriteBatch.Draw(value55, position22, frame6, color26 * num171, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale * num170, spriteEffects, 0f);
							}
							for (int num172 = 0; num172 < 3; num172++)
							{
								float num173 = 1.1f + 0.1f * (float)num172;
								mySpriteBatch.Draw(value55, vector56, frame6, color26, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale * num173, spriteEffects, 0f);
							}
						}
					}
					if (type == 24)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[360].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.White), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					if (type >= 639 && type <= 645)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[286].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.White), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					if (type >= 646 && type <= 652)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[287].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, rCurrentNPC.GetAlpha(Microsoft.Xna.Framework.Color.White), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					if (type >= 134 && type <= 136 && npcColor != Microsoft.Xna.Framework.Color.Black)
					{
						mySpriteBatch.Draw(TextureAssets.Dest[type - 134].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * (1f - (float)rCurrentNPC.alpha / 255f), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 125)
					{
						mySpriteBatch.Draw(TextureAssets.EyeLaser.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 139)
					{
						mySpriteBatch.Draw(TextureAssets.Probe.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 127)
					{
						if (NPC.IsMechQueenUp)
						{
							rCurrentNPC.whoAmI = rCurrentNPC.whoAmI;
							for (int num174 = 0; num174 < maxNPCs; num174++)
							{
								if (!npc[num174].active || (npc[num174].type != 125 && npc[num174].type != 126))
								{
									continue;
								}
								float scale5 = npc[num174].scale;
								float x2 = npc[num174].Center.X;
								float y3 = npc[num174].Center.Y;
								Vector2 mechQueenCenter = rCurrentNPC.GetMechQueenCenter();
								Vector2 vector57 = new Vector2((npc[num174].type == 125) ? (-18) : 20, -18f);
								vector57 = vector57.RotatedBy(rCurrentNPC.rotation);
								Vector2 vector58 = mechQueenCenter + vector57;
								float num175 = x2 - vector58.X;
								float num176 = y3 - vector58.Y;
								float rotation10 = (float)Math.Atan2(num176, num175) - 1.57f;
								bool flag11 = true;
								float num177 = (float)Math.Sqrt(num175 * num175 + num176 * num176);
								if (num177 > 2000f)
								{
									flag11 = false;
								}
								float num178 = 40f * scale5;
								while (flag11)
								{
									num177 = (float)Math.Sqrt(num175 * num175 + num176 * num176);
									if (num177 < num178)
									{
										flag11 = false;
										continue;
									}
									num177 = (float)TextureAssets.Chain12.Height() * scale5 / num177;
									num175 *= num177;
									num176 *= num177;
									Microsoft.Xna.Framework.Color color27 = Lighting.GetColor((int)vector58.X / 16, (int)(vector58.Y / 16f));
									spriteBatch.Draw(TextureAssets.Chain12.Value, new Vector2(vector58.X - screenPosition.X, vector58.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain12.Width(), TextureAssets.Chain12.Height()), color27, rotation10, new Vector2((float)TextureAssets.Chain12.Width() * 0.5f, 0f), scale5, SpriteEffects.None, 0f);
									vector58.X += num175;
									vector58.Y += num176;
									num175 = x2 - vector58.X;
									num176 = y3 - vector58.Y;
								}
							}
						}
						else
						{
							mySpriteBatch.Draw(TextureAssets.BoneEyes.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 131)
					{
						mySpriteBatch.Draw(TextureAssets.BoneLaser.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 120)
					{
						for (int num179 = 1; num179 < rCurrentNPC.oldPos.Length; num179++)
						{
							_ = ref rCurrentNPC.oldPos[num179];
							Microsoft.Xna.Framework.Color shimmerColor = rCurrentNPC.GetShimmerColor(new Microsoft.Xna.Framework.Color
							{
								R = (byte)(150 * (10 - num179) / 15),
								G = (byte)(100 * (10 - num179) / 15),
								B = (byte)(150 * (10 - num179) / 15),
								A = (byte)(50 * (10 - num179) / 15)
							});
							mySpriteBatch.Draw(TextureAssets.Chaos.Value, new Vector2(rCurrentNPC.oldPos[num179].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num179].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, shimmerColor, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 137 || type == 138)
					{
						for (int num180 = 1; num180 < rCurrentNPC.oldPos.Length; num180++)
						{
							_ = ref rCurrentNPC.oldPos[num180];
							Microsoft.Xna.Framework.Color shimmerColor2 = rCurrentNPC.GetShimmerColor(new Microsoft.Xna.Framework.Color
							{
								R = (byte)(150 * (10 - num180) / 15),
								G = (byte)(100 * (10 - num180) / 15),
								B = (byte)(150 * (10 - num180) / 15),
								A = (byte)(50 * (10 - num180) / 15)
							});
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num180].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num180].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, shimmerColor2, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 327)
					{
						mySpriteBatch.Draw(TextureAssets.PumpkingFace.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, Microsoft.Xna.Framework.Color.White, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						for (int num181 = 1; num181 < 10; num181++)
						{
							Microsoft.Xna.Framework.Color color28 = new Microsoft.Xna.Framework.Color(110 - num181 * 10, 110 - num181 * 10, 110 - num181 * 10, 110 - num181 * 10);
							Vector2 vector59 = new Vector2((float)rand.Next(-10, 11) * 0.2f, (float)rand.Next(-10, 11) * 0.2f);
							mySpriteBatch.Draw(TextureAssets.PumpkingFace.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47) + vector59, rCurrentNPC.frame, color28, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 325)
					{
						mySpriteBatch.Draw(TextureAssets.TreeFace.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, Microsoft.Xna.Framework.Color.White, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						for (int num182 = 1; num182 < 10; num182++)
						{
							Microsoft.Xna.Framework.Color color29 = new Microsoft.Xna.Framework.Color(110 - num182 * 10, 110 - num182 * 10, 110 - num182 * 10, 110 - num182 * 10);
							Vector2 vector60 = new Vector2((float)rand.Next(-10, 11) * 0.2f, (float)rand.Next(-10, 11) * 0.2f);
							mySpriteBatch.Draw(TextureAssets.TreeFace.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47) + vector60, rCurrentNPC.frame, color29, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 345)
					{
						mySpriteBatch.Draw(TextureAssets.IceQueen.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, Microsoft.Xna.Framework.Color.White, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						for (int num183 = 1; num183 < 5; num183++)
						{
							mySpriteBatch.Draw(color: new Microsoft.Xna.Framework.Color(100 - num183 * 10, 100 - num183 * 10, 100 - num183 * 10, 100 - num183 * 10), texture: TextureAssets.IceQueen.Value, position: new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47) - rCurrentNPC.velocity * num183 * 0.2f, sourceRectangle: rCurrentNPC.frame, rotation: rCurrentNPC.rotation, origin: halfSize, scale: rCurrentNPC.scale, effects: spriteEffects, layerDepth: 0f);
						}
					}
					else if (type == 355)
					{
						mySpriteBatch.Draw(TextureAssets.Firefly.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 358)
					{
						mySpriteBatch.Draw(TextureAssets.Lightningbug.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 654)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[290].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 653)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[288].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 3f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 82)
					{
						mySpriteBatch.Draw(TextureAssets.WraithEye.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, Microsoft.Xna.Framework.Color.White, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						for (int num184 = 1; num184 < 10; num184++)
						{
							mySpriteBatch.Draw(color: new Microsoft.Xna.Framework.Color(110 - num184 * 10, 110 - num184 * 10, 110 - num184 * 10, 110 - num184 * 10), texture: TextureAssets.WraithEye.Value, position: new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47) - rCurrentNPC.velocity * num184 * 0.5f, sourceRectangle: rCurrentNPC.frame, rotation: rCurrentNPC.rotation, origin: halfSize, scale: rCurrentNPC.scale, effects: spriteEffects, layerDepth: 0f);
						}
					}
					else if (type == 253)
					{
						mySpriteBatch.Draw(TextureAssets.ReaperEye.Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 3f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, Microsoft.Xna.Framework.Color.White, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						for (int num185 = 1; num185 < 20; num185++)
						{
							mySpriteBatch.Draw(color: new Microsoft.Xna.Framework.Color(210 - num185 * 20, 210 - num185 * 20, 210 - num185 * 20, 210 - num185 * 20), texture: TextureAssets.ReaperEye.Value, position: new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 3f + halfSize.Y * rCurrentNPC.scale + num47) - rCurrentNPC.velocity * num185 * 0.5f, sourceRectangle: rCurrentNPC.frame, rotation: rCurrentNPC.rotation, origin: halfSize, scale: rCurrentNPC.scale, effects: spriteEffects, layerDepth: 0f);
						}
					}
					else if (type == 245 && rCurrentNPC.alpha == 0 && !getGoodWorld)
					{
						mySpriteBatch.Draw(color: new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, 0), texture: TextureAssets.Golem[3].Value, position: new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), sourceRectangle: frame6, rotation: rCurrentNPC.rotation, origin: halfSize, scale: rCurrentNPC.scale, effects: spriteEffects, layerDepth: 0f);
					}
					else if (type == 246 && !getGoodWorld)
					{
						Microsoft.Xna.Framework.Color color30 = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, 0);
						if (rCurrentNPC.frame.Y < 222)
						{
							if (!getGoodWorld)
							{
								mySpriteBatch.Draw(TextureAssets.Golem[1].Value, new Vector2(rCurrentNPC.Center.X - screenPos.X - 20f, rCurrentNPC.Center.Y - screenPos.Y - 27f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Golem[1].Width(), TextureAssets.Golem[1].Height() / 2), color30, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
							}
							Microsoft.Xna.Framework.Rectangle value56 = frame6;
							value56.Y = 0;
							mySpriteBatch.Draw(TextureAssets.Extra[107].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), value56, color30, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
						else if (!getGoodWorld && rCurrentNPC.frame.Y < 444)
						{
							mySpriteBatch.Draw(TextureAssets.Golem[2].Value, new Vector2(rCurrentNPC.Center.X - screenPos.X + 26f, rCurrentNPC.Center.Y - screenPos.Y - 28f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Golem[2].Width(), TextureAssets.Golem[2].Height() / 4), color30, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						}
						else if (!getGoodWorld)
						{
							mySpriteBatch.Draw(TextureAssets.Golem[2].Value, new Vector2(rCurrentNPC.Center.X - screenPos.X - 38f, rCurrentNPC.Center.Y - screenPos.Y - 28f), new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.Golem[2].Height() / 2, TextureAssets.Golem[2].Width(), TextureAssets.Golem[2].Height() / 4), color30, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						}
					}
					else if (type == 249 && !getGoodWorld)
					{
						Microsoft.Xna.Framework.Color color31 = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, 0);
						if (!getGoodWorld)
						{
							mySpriteBatch.Draw(TextureAssets.Golem[1].Value, new Vector2(rCurrentNPC.Center.X - screenPos.X - 20f, rCurrentNPC.Center.Y - screenPos.Y - 47f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Golem[1].Width(), TextureAssets.Golem[1].Height() / 2), color31, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						}
						int num186 = (int)rCurrentNPC.frameCounter / 4;
						Texture2D value57 = TextureAssets.Extra[106].Value;
						Microsoft.Xna.Framework.Rectangle value58 = value57.Frame(1, 8);
						_ = Microsoft.Xna.Framework.Color.White;
						value58.Y += value58.Height * 2 * num186 + frame6.Y;
						mySpriteBatch.Draw(value57, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), value58, color31, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						value57 = TextureAssets.Extra[107].Value;
						value58 = frame6;
						mySpriteBatch.Draw(value57, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), value58, color31, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 383)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[11].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						if (rCurrentNPC.ai[2] != 0f && npc[(int)rCurrentNPC.ai[2] - 1].active && npc[(int)rCurrentNPC.ai[2] - 1].type == 384)
						{
							_ = rCurrentNPC.ai[2];
							mySpriteBatch.Draw(TextureAssets.Npc[384].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), null, new Microsoft.Xna.Framework.Color(100, 100, 100, 0), rCurrentNPC.rotation, new Vector2(TextureAssets.Npc[384].Width(), TextureAssets.Npc[384].Height()) / 2f, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 381)
					{
						Vector2 zero4 = Vector2.Zero;
						Vector2 origin21 = Vector2.Zero;
						int num187 = TextureAssets.Npc[type].Height() / npcFrameCount[type];
						int num188 = rCurrentNPC.frame.Y / num187;
						Microsoft.Xna.Framework.Rectangle value59 = new Microsoft.Xna.Framework.Rectangle(0, 0, 32, 42);
						switch (num188)
						{
						case 0:
							zero4 += new Vector2(8f, 32f);
							break;
						case 1:
							zero4 += new Vector2(6f, 72f);
							break;
						case 2:
							zero4 += new Vector2(8f, 126f);
							break;
						case 3:
							zero4 += new Vector2(6f, 174f);
							break;
						case 4:
							zero4 += new Vector2(6f, 224f);
							break;
						case 5:
							zero4 += new Vector2(8f, 272f);
							break;
						case 6:
							zero4 += new Vector2(10f, 318f);
							break;
						case 7:
							zero4 += new Vector2(14f, 366f);
							break;
						case 8:
							zero4 += new Vector2(10f, 414f);
							break;
						}
						zero4.Y -= num187 * num188;
						zero4 -= halfSize;
						int num189 = 2;
						if (rCurrentNPC.ai[2] > 0f)
						{
							num189 = (int)rCurrentNPC.ai[2] - 1;
						}
						if (rCurrentNPC.velocity.Y != 0f)
						{
							num189 = 3;
						}
						value59.Y += 44 * num189;
						switch (num189)
						{
						case 0:
							origin21 = new Vector2(10f, 18f);
							break;
						case 1:
							origin21 = new Vector2(8f, 20f);
							break;
						case 2:
							origin21 = new Vector2(8f, 20f);
							break;
						case 3:
							origin21 = new Vector2(8f, 20f);
							break;
						case 4:
							origin21 = new Vector2(6f, 18f);
							break;
						}
						if ((spriteEffects & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
						{
							zero4.X *= -1f;
							origin21.X = (float)value59.Width - origin21.X;
						}
						zero4 += rCurrentNPC.Center;
						zero4 -= screenPos;
						zero4.Y += rCurrentNPC.gfxOffY;
						mySpriteBatch.Draw(TextureAssets.Extra[0].Value, zero4, value59, npcColor, rCurrentNPC.rotation, origin21, rCurrentNPC.scale, spriteEffects, 0f);
						mySpriteBatch.Draw(TextureAssets.GlowMask[24].Value, zero4, value59, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, origin21, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 382)
					{
						Vector2 zero5 = Vector2.Zero;
						Vector2 origin22 = Vector2.Zero;
						int num190 = TextureAssets.Npc[type].Height() / npcFrameCount[type];
						int num191 = rCurrentNPC.frame.Y / num190;
						Microsoft.Xna.Framework.Rectangle value60 = new Microsoft.Xna.Framework.Rectangle(0, 0, 30, 42);
						switch (num191)
						{
						case 0:
							zero5 += new Vector2(8f, 30f);
							break;
						case 1:
							zero5 += new Vector2(6f, 68f);
							break;
						case 2:
							zero5 += new Vector2(8f, 120f);
							break;
						case 3:
							zero5 += new Vector2(6f, 166f);
							break;
						case 4:
							zero5 += new Vector2(6f, 214f);
							break;
						case 5:
							zero5 += new Vector2(8f, 260f);
							break;
						case 6:
							zero5 += new Vector2(14f, 304f);
							break;
						case 7:
							zero5 += new Vector2(14f, 350f);
							break;
						case 8:
							zero5 += new Vector2(10f, 396f);
							break;
						}
						zero5.Y -= num190 * num191;
						zero5 -= halfSize;
						int num192 = 2;
						if (rCurrentNPC.ai[2] > 0f)
						{
							num192 = (int)rCurrentNPC.ai[2] - 1;
						}
						if (rCurrentNPC.velocity.Y != 0f)
						{
							num192 = 3;
						}
						value60.Y += 44 * num192;
						switch (num192)
						{
						case 0:
							origin22 = new Vector2(10f, 18f);
							break;
						case 1:
							origin22 = new Vector2(8f, 20f);
							break;
						case 2:
							origin22 = new Vector2(8f, 20f);
							break;
						case 3:
							origin22 = new Vector2(8f, 20f);
							break;
						case 4:
							origin22 = new Vector2(6f, 18f);
							break;
						}
						if ((spriteEffects & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
						{
							zero5.X *= -1f;
							origin22.X = (float)value60.Width - origin22.X;
						}
						zero5 += rCurrentNPC.Center;
						zero5 -= screenPos;
						zero5.Y += rCurrentNPC.gfxOffY;
						mySpriteBatch.Draw(TextureAssets.Extra[1].Value, zero5, value60, npcColor, rCurrentNPC.rotation, origin22, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 520)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[164].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						Vector2 zero6 = Vector2.Zero;
						Vector2 origin23 = new Vector2(4f, 4f);
						int num193 = TextureAssets.Npc[type].Height() / npcFrameCount[type];
						_ = rCurrentNPC.frame.Y / num193;
						if ((spriteEffects & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
						{
							zero6.X *= -1f;
							origin23.X = (float)TextureAssets.Extra[56].Width() - origin23.X;
						}
						zero6 += rCurrentNPC.Top + new Vector2(0f, 20f);
						zero6 -= screenPos;
						zero6.Y += rCurrentNPC.gfxOffY;
						float num194 = rCurrentNPC.localAI[3];
						if ((spriteEffects & SpriteEffects.FlipHorizontally) != SpriteEffects.None)
						{
							num194 += (float)Math.PI;
						}
						mySpriteBatch.Draw(TextureAssets.Extra[56].Value, zero6, null, npcColor, num194, origin23, rCurrentNPC.scale, spriteEffects, 0f);
						mySpriteBatch.Draw(TextureAssets.GlowMask[165].Value, zero6, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), num194, origin23, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 386)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[31].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 387)
					{
						Microsoft.Xna.Framework.Color color32 = new Microsoft.Xna.Framework.Color(1f, 1f, 1f, 1f) * 0.75f;
						if (rCurrentNPC.ai[0] > 0f)
						{
							float amount7 = (rCurrentNPC.ai[0] + 1f) / 60f;
							color32 = Microsoft.Xna.Framework.Color.Lerp(color32, Microsoft.Xna.Framework.Color.White, amount7);
							color32.A = (byte)MathHelper.Lerp((int)color32.A, 0f, amount7);
						}
						color32 *= (255f - (float)rCurrentNPC.alpha) / 255f;
						mySpriteBatch.Draw(TextureAssets.GlowMask[32].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, color32, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 388)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[33].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 389)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[34].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 4 && rCurrentNPC.ai[1] >= 4f && rCurrentNPC.ai[0] == 3f)
					{
						for (int num195 = 1; num195 < rCurrentNPC.oldPos.Length; num195++)
						{
							_ = ref rCurrentNPC.oldPos[num195];
							Microsoft.Xna.Framework.Color color33 = npcColor;
							color33.R = (byte)(0.5 * (double)(int)color33.R * (double)(10 - num195) / 20.0);
							color33.G = (byte)(0.5 * (double)(int)color33.G * (double)(10 - num195) / 20.0);
							color33.B = (byte)(0.5 * (double)(int)color33.B * (double)(10 - num195) / 20.0);
							color33.A = (byte)(0.5 * (double)(int)color33.A * (double)(10 - num195) / 20.0);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num195].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num195].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, color33, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 437)
					{
						Microsoft.Xna.Framework.Color white5 = Microsoft.Xna.Framework.Color.White;
						white5.A = 200;
						mySpriteBatch.Draw(TextureAssets.GlowMask[109].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), frame6, white5, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						mySpriteBatch.Draw(TextureAssets.GlowMask[108].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + num46 + rCurrentNPC.gfxOffY), null, white5, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (type == 471 && rCurrentNPC.ai[3] < 0f)
					{
						for (int num196 = 1; num196 < rCurrentNPC.oldPos.Length; num196++)
						{
							_ = ref rCurrentNPC.oldPos[num196];
							Microsoft.Xna.Framework.Color color34 = npcColor;
							color34.R = (byte)(0.5 * (double)(int)color34.R * (double)(10 - num196) / 20.0);
							color34.G = (byte)(0.5 * (double)(int)color34.G * (double)(10 - num196) / 20.0);
							color34.B = (byte)(0.5 * (double)(int)color34.B * (double)(10 - num196) / 20.0);
							color34.A = (byte)(0.5 * (double)(int)color34.A * (double)(10 - num196) / 20.0);
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num196].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num196].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, color34, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 477 && rCurrentNPC.velocity.Length() > 9f)
					{
						for (int num197 = 1; num197 < rCurrentNPC.oldPos.Length; num197++)
						{
							_ = ref rCurrentNPC.oldPos[num197];
							Microsoft.Xna.Framework.Color color35 = npcColor;
							color35.R = (byte)(0.5 * (double)(int)color35.R * (double)(10 - num197) / 20.0);
							color35.G = (byte)(0.5 * (double)(int)color35.G * (double)(10 - num197) / 20.0);
							color35.B = (byte)(0.5 * (double)(int)color35.B * (double)(10 - num197) / 20.0);
							color35.A = (byte)(0.5 * (double)(int)color35.A * (double)(10 - num197) / 20.0);
							Microsoft.Xna.Framework.Rectangle frame7 = rCurrentNPC.frame;
							int num198 = TextureAssets.Npc[type].Height() / npcFrameCount[type];
							frame7.Y -= num198 * num197;
							while (frame7.Y < 0)
							{
								frame7.Y += num198 * npcFrameCount[type];
							}
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num197].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num197].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), frame7, color35, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					if (type == 479 && (double)rCurrentNPC.velocity.Length() > 6.5)
					{
						for (int num199 = 1; num199 < rCurrentNPC.oldPos.Length; num199++)
						{
							_ = ref rCurrentNPC.oldPos[num199];
							Microsoft.Xna.Framework.Color color36 = npcColor;
							color36.R = (byte)(0.5 * (double)(int)color36.R * (double)(10 - num199) / 20.0);
							color36.G = (byte)(0.5 * (double)(int)color36.G * (double)(10 - num199) / 20.0);
							color36.B = (byte)(0.5 * (double)(int)color36.B * (double)(10 - num199) / 20.0);
							color36.A = (byte)(0.5 * (double)(int)color36.A * (double)(10 - num199) / 20.0);
							Microsoft.Xna.Framework.Rectangle frame8 = rCurrentNPC.frame;
							int num200 = TextureAssets.Npc[type].Height() / npcFrameCount[type];
							frame8.Y -= num200 * num199;
							while (frame8.Y < 0)
							{
								frame8.Y += num200 * npcFrameCount[type];
							}
							mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num199].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num199].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), frame8, color36, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
						}
					}
					else if (type == 472)
					{
						mySpriteBatch.Draw(TextureAssets.GlowMask[110].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
					}
					else if (rCurrentNPC.aiStyle == 87)
					{
						if ((int)rCurrentNPC.ai[0] == 4 || rCurrentNPC.ai[0] == 5f || rCurrentNPC.ai[0] == 6f)
						{
							for (int num201 = 1; num201 < rCurrentNPC.oldPos.Length; num201++)
							{
								_ = ref rCurrentNPC.oldPos[num201];
								Microsoft.Xna.Framework.Color newColor4 = npcColor;
								newColor4.R = (byte)(0.5 * (double)(int)newColor4.R * (double)(10 - num201) / 20.0);
								newColor4.G = (byte)(0.5 * (double)(int)newColor4.G * (double)(10 - num201) / 20.0);
								newColor4.B = (byte)(0.5 * (double)(int)newColor4.B * (double)(10 - num201) / 20.0);
								newColor4.A = (byte)(0.5 * (double)(int)newColor4.A * (double)(10 - num201) / 20.0);
								newColor4 = rCurrentNPC.GetShimmerColor(newColor4);
								mySpriteBatch.Draw(TextureAssets.Npc[type].Value, new Vector2(rCurrentNPC.oldPos[num201].X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[type].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.oldPos[num201].Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[type].Height() * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47), rCurrentNPC.frame, newColor4, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							}
						}
					}
					else
					{
						switch (type)
						{
						case 50:
						{
							Texture2D value61 = TextureAssets.Extra[39].Value;
							Vector2 center4 = rCurrentNPC.Center;
							float num223 = 0f;
							switch (rCurrentNPC.frame.Y / (TextureAssets.Npc[type].Height() / npcFrameCount[type]))
							{
							case 0:
								num223 = 2f;
								break;
							case 1:
								num223 = -6f;
								break;
							case 2:
								num223 = 2f;
								break;
							case 3:
								num223 = 10f;
								break;
							case 4:
								num223 = 2f;
								break;
							case 5:
								num223 = 0f;
								break;
							}
							center4.Y += rCurrentNPC.gfxOffY - (70f - num223) * rCurrentNPC.scale;
							mySpriteBatch.Draw(value61, center4 - screenPos, null, npcColor, 0f, value61.Size() / 2f, 1f, spriteEffects, 0f);
							break;
						}
						case 411:
							mySpriteBatch.Draw(TextureAssets.GlowMask[136].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 409:
							mySpriteBatch.Draw(TextureAssets.GlowMask[138].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 410:
							mySpriteBatch.Draw(TextureAssets.GlowMask[137].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 407:
							mySpriteBatch.Draw(TextureAssets.GlowMask[139].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 405:
							mySpriteBatch.Draw(TextureAssets.GlowMask[141].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 406:
							mySpriteBatch.Draw(TextureAssets.GlowMask[142].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 424:
							mySpriteBatch.Draw(TextureAssets.GlowMask[144].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 423:
							mySpriteBatch.Draw(TextureAssets.GlowMask[145].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 421:
							mySpriteBatch.Draw(TextureAssets.GlowMask[146].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 420:
							mySpriteBatch.Draw(TextureAssets.GlowMask[147].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 425:
						{
							Vector2 vector62 = rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY);
							mySpriteBatch.Draw(TextureAssets.GlowMask[150].Value, vector62, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							Vector2 drawpos = vector62 + new Vector2(27 * -rCurrentNPC.spriteDirection, 0f);
							float num224 = rCurrentNPC.ai[3];
							DrawPrettyStarSparkle(Utils.Remap(num224, 0f, 15f, 0f, 1f), SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), Microsoft.Xna.Framework.Color.Green, num224, 0f, 30f, 30f, 36f, 0f, new Vector2(3f, 1.5f), new Vector2(2f, 2f));
							break;
						}
						case 429:
							mySpriteBatch.Draw(TextureAssets.GlowMask[151].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						case 418:
						{
							mySpriteBatch.Draw(TextureAssets.GlowMask[161].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							float num221 = 0.25f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.25f;
							for (int num222 = 0; num222 < 4; num222++)
							{
								mySpriteBatch.Draw(TextureAssets.GlowMask[161].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + rCurrentNPC.velocity.RotatedBy((float)num222 * ((float)Math.PI / 2f)) * num221, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							}
							break;
						}
						case 412:
						case 413:
						case 414:
						{
							Microsoft.Xna.Framework.Color color38 = new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 0);
							int num218 = 157 + type - 412;
							if (type == 414 && rCurrentNPC.localAI[2] != 0f)
							{
								int num219 = (int)rCurrentNPC.localAI[2];
								if (rCurrentNPC.localAI[2] < 0f)
								{
									num219 = 128 + (int)rCurrentNPC.localAI[2];
								}
								int num220 = 255 - num219;
								color38 = new Microsoft.Xna.Framework.Color(num220, num219, num219, num220);
							}
							mySpriteBatch.Draw(TextureAssets.GlowMask[num218].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, color38, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
							break;
						}
						default:
							switch (type)
							{
							case 415:
							{
								mySpriteBatch.Draw(TextureAssets.GlowMask[155].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								float num202 = 0.5f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.5f;
								for (int num203 = 0; num203 < 4; num203++)
								{
									mySpriteBatch.Draw(TextureAssets.GlowMask[155].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + rCurrentNPC.velocity.RotatedBy((float)num203 * ((float)Math.PI / 2f)) * num202, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								}
								break;
							}
							case 419:
								mySpriteBatch.Draw(TextureAssets.GlowMask[154].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								if (rCurrentNPC.ai[2] >= -6f)
								{
									float num208 = 0.5f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.5f;
									for (int num209 = 0; num209 < 4; num209++)
									{
										mySpriteBatch.Draw(TextureAssets.GlowMask[154].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + rCurrentNPC.velocity.RotatedBy((float)num209 * ((float)Math.PI / 2f)) * num208, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
									}
								}
								else
								{
									float num210 = 4f;
									for (int num211 = 0; num211 < 4; num211++)
									{
										mySpriteBatch.Draw(TextureAssets.GlowMask[154].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + Vector2.UnitX.RotatedBy((float)num211 * ((float)Math.PI / 2f)) * num210, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
									}
								}
								break;
							case 417:
							{
								mySpriteBatch.Draw(TextureAssets.GlowMask[160].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								float num212 = 0.25f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.25f;
								for (int num213 = 0; num213 < 4; num213++)
								{
									mySpriteBatch.Draw(TextureAssets.GlowMask[160].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + rCurrentNPC.velocity.RotatedBy((float)num213 * ((float)Math.PI / 2f)) * num212, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								}
								break;
							}
							case 516:
							{
								mySpriteBatch.Draw(TextureAssets.Npc[type].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								float num204 = 0.5f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.5f;
								for (int num205 = 0; num205 < 4; num205++)
								{
									mySpriteBatch.Draw(TextureAssets.Npc[type].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + rCurrentNPC.velocity.RotatedBy((float)num205 * ((float)Math.PI / 2f)) * num204, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								}
								break;
							}
							case 518:
							{
								Vector2 vector61 = new Vector2(-10f, 0f);
								mySpriteBatch.Draw(TextureAssets.GlowMask[163].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha), rCurrentNPC.rotation, halfSize + vector61, rCurrentNPC.scale, spriteEffects, 0f);
								float num216 = 0.5f + (rCurrentNPC.GetAlpha(npcColor).ToVector3() - new Vector3(0.5f)).Length() * 0.5f;
								for (int num217 = 0; num217 < 4; num217++)
								{
									mySpriteBatch.Draw(TextureAssets.GlowMask[163].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + rCurrentNPC.velocity.RotatedBy((float)num217 * ((float)Math.PI / 2f)) * num216, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize + vector61, rCurrentNPC.scale, spriteEffects, 0f);
								}
								break;
							}
							case 344:
								mySpriteBatch.Draw(TextureAssets.GlowMask[253].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 100) * 0.5f, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							case 346:
							{
								float num214 = 4f;
								for (int num215 = 0; num215 < 4; num215++)
								{
									mySpriteBatch.Draw(TextureAssets.GlowMask[254].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + Vector2.UnitX.RotatedBy((float)num215 * ((float)Math.PI / 2f)) * num214, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								}
								mySpriteBatch.Draw(TextureAssets.GlowMask[254].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 100), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							}
							case 315:
							{
								float num206 = 2f;
								for (int num207 = 0; num207 < 4; num207++)
								{
									mySpriteBatch.Draw(TextureAssets.GlowMask[255].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY) + Vector2.UnitX.RotatedBy((float)num207 * ((float)Math.PI / 2f)) * num206, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(64, 64, 64, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								}
								mySpriteBatch.Draw(TextureAssets.GlowMask[255].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 200), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							}
							case 525:
								mySpriteBatch.Draw(TextureAssets.GlowMask[169].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 100), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							case 526:
								mySpriteBatch.Draw(TextureAssets.GlowMask[170].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 100), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							case 527:
								mySpriteBatch.Draw(TextureAssets.GlowMask[171].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(200, 200, 200, 100), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							case 533:
								mySpriteBatch.Draw(TextureAssets.GlowMask[172].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 100), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							case 160:
							{
								Texture2D texture2D2 = null;
								texture2D2 = ((rCurrentNPC.townNpcVariationIndex != 1) ? TextureAssets.GlowMask[166].Value : TextureAssets.GlowMask[352].Value);
								Microsoft.Xna.Framework.Color color37 = new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0);
								if (rCurrentNPC.shimmerTransparency > 0f)
								{
									color37.R = (byte)((float)(int)color37.R * (1f - rCurrentNPC.shimmerTransparency));
									color37.G = (byte)((float)(int)color37.G * (1f - rCurrentNPC.shimmerTransparency));
									color37.B = (byte)((float)(int)color37.B * (1f - rCurrentNPC.shimmerTransparency));
								}
								mySpriteBatch.Draw(texture2D2, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, color37, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							}
							case 209:
							{
								Texture2D texture2D = null;
								texture2D = ((rCurrentNPC.townNpcVariationIndex != 1) ? TextureAssets.GlowMask[167].Value : ((rCurrentNPC.altTexture != 1) ? TextureAssets.GlowMask[350].Value : TextureAssets.GlowMask[351].Value));
								mySpriteBatch.Draw(texture2D, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
								break;
							}
							}
							break;
						}
					}
					if (rCurrentNPC.aiStyle == 7)
					{
						DrawNPCExtras(rCurrentNPC, beforeDraw: false, num47, num46, npcColor, halfSize, spriteEffects, screenPos);
					}
					break;
				}
				case 488:
					break;
				}
				break;
			}
			goto case 426;
		case 426:
		case 427:
		case 428:
		case 521:
		case 523:
		case 541:
		case 542:
		case 543:
		case 544:
		case 545:
		case 581:
		{
			Texture2D value80 = TextureAssets.Npc[type].Value;
			Microsoft.Xna.Framework.Color color43 = Microsoft.Xna.Framework.Color.White;
			float amount10 = 0f;
			float amount11 = 0f;
			int num294 = 0;
			int num295 = 0;
			int num296 = 1;
			int num297 = 15;
			int num298 = 0;
			float scale8 = rCurrentNPC.scale;
			float value81 = rCurrentNPC.scale;
			int num299 = 0;
			float num300 = 0f;
			float num301 = 0f;
			float num302 = 0f;
			Microsoft.Xna.Framework.Color color44 = npcColor;
			Vector2 origin25 = halfSize;
			switch (type)
			{
			case 558:
			case 559:
			case 560:
			case 574:
			case 575:
				if (rCurrentNPC.ai[0] != 2f)
				{
					num294 = 0;
					break;
				}
				num294 = 6;
				num295 = 2;
				num297 = num294 * 3;
				num298 = 1;
				break;
			case 566:
			case 567:
			case 578:
				num294 = 0;
				num47 = -2f;
				break;
			case 552:
			case 553:
			case 554:
			case 555:
			case 556:
			case 557:
			case 561:
			case 562:
			case 563:
			case 568:
			case 569:
			case 570:
			case 571:
			case 572:
			case 573:
				num294 = 0;
				if (type == 561 || type == 562 || type == 563)
				{
					num47 = -8f;
				}
				if (type == 555 || type == 556 || type == 557)
				{
					num47 = -5f;
				}
				if (type == 572 || type == 573)
				{
					num47 = -4f;
				}
				if (type == 570 || type == 571)
				{
					spriteEffects ^= SpriteEffects.FlipHorizontally;
					num47 = -2f;
				}
				if (type == 568 || type == 569)
				{
					spriteEffects ^= SpriteEffects.FlipHorizontally;
					num47 = -3f;
					num299 = 4;
					num301 = 4f;
					num300 = (float)Math.Cos(GlobalTimeWrappedHourly % 1.5f / 1.5f * ((float)Math.PI * 2f)) / 6f + 0.75f;
					color43 = Microsoft.Xna.Framework.Color.HotPink;
					color43.A = 127;
					amount10 = 0.5f;
				}
				if (rCurrentNPC.localAI[3] < 60f)
				{
					float num315 = rCurrentNPC.localAI[3] / 60f;
					num299 = 3;
					num300 = 1f - num315 * num315;
					num301 = 8f;
					color43 = new Microsoft.Xna.Framework.Color(127, 0, 255, 0);
					amount11 = 1f;
					color44 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color44, num315 * num315);
				}
				break;
			case 541:
				num299 = 4;
				num301 = 6f;
				num300 = (float)Math.Cos(GlobalTimeWrappedHourly % 2.4f / 2.4f * ((float)Math.PI * 2f)) / 2f + 0.5f;
				color43 = Microsoft.Xna.Framework.Color.Gold;
				amount10 = 0.5f;
				break;
			case 661:
				num299 = 6;
				num301 = 6f;
				num300 = (float)Math.Cos(GlobalTimeWrappedHourly % 2.4f / 2.4f * ((float)Math.PI * 2f)) / 2f + 0.5f;
				num300 = MathHelper.Max(num300, Utils.GetLerpValue(0f, 60f, rCurrentNPC.ai[2], clamped: true));
				amount10 = 0.5f;
				break;
			case 426:
				num299 = 4;
				num301 = 4f;
				num300 = (float)Math.Cos(GlobalTimeWrappedHourly % 1.2f / 1.2f * ((float)Math.PI * 2f)) / 2f + 0.5f;
				color43 = Microsoft.Xna.Framework.Color.Turquoise;
				amount10 = 0.5f;
				num294 = 6;
				num295 = 2;
				num297 = num294;
				break;
			case 427:
				num294 = 8;
				num295 = 2;
				num297 = num294 * 3;
				break;
			case 546:
				num294 = 8;
				num295 = 2;
				num297 = num294 * 3;
				break;
			case 542:
			case 543:
			case 544:
			case 545:
				num294 = 6;
				num295 = 3;
				num297 = num294 * 2;
				break;
			case 581:
				num294 = 6;
				num295 = 2;
				num297 = num294 * 3;
				break;
			case 521:
				num294 = 10;
				num295 = 2;
				num297 = num294;
				num298 = 1;
				value81 = 0.3f;
				break;
			case 523:
				num299 = 3;
				num301 = 10f * rCurrentNPC.scale;
				amount10 = 0.5f;
				amount11 = 0.8f;
				color43 = Microsoft.Xna.Framework.Color.HotPink;
				color43.A = 128;
				num302 = rCurrentNPC.localAI[0];
				num300 = rCurrentNPC.localAI[1];
				break;
			case 620:
				num47 = -9f;
				origin25 = rCurrentNPC.frame.Size() * new Vector2(0.5f, 0.5f) + new Vector2(-4 * rCurrentNPC.spriteDirection, 0f);
				num299 = 4;
				num301 = 6f;
				num300 = (float)Math.Cos(GlobalTimeWrappedHourly % 2.4f / 2.4f * ((float)Math.PI * 2f)) / 2f + 0.5f;
				color43 = Microsoft.Xna.Framework.Color.Gold;
				amount10 = 0.5f;
				num294 = 6;
				num295 = 2;
				num297 = num294 * 3;
				num298 = 1;
				break;
			case 618:
			{
				float num303 = 90f;
				float num304 = 180f;
				if (rCurrentNPC.ai[0] == 1f && rCurrentNPC.ai[1] < num303)
				{
					int num305 = 3;
					float num306 = num303 / (float)num305;
					float num307 = rCurrentNPC.ai[1] % num306 / num306;
					num299 = 6;
					num301 = 15f;
					num300 = num307 * 0.8f + 0.2f;
				}
				if (rCurrentNPC.ai[0] == 3f && rCurrentNPC.ai[1] < num304)
				{
					int num308 = 1;
					float num309 = num304 / (float)num308;
					float num310 = rCurrentNPC.ai[1] % num309 / num309;
					num299 = 4;
					num301 = 25f;
					num300 = num310;
					Vector2 vector71 = rCurrentNPC.scale * new Vector2(1f, 0.5f + num310 * 0.75f);
					Texture2D value82 = TextureAssets.Extra[59].Value;
					Microsoft.Xna.Framework.Rectangle rectangle13 = value82.Frame();
					Vector2 origin26 = rectangle13.Size() * new Vector2(0.5f, 0.5f);
					for (int num311 = 0; num311 < num299; num311++)
					{
						Microsoft.Xna.Framework.Color white8 = Microsoft.Xna.Framework.Color.White;
						white8 *= Utils.GetLerpValue(0f, 0.5f, num300) * Utils.GetLerpValue(1f, 0.5f, num300) * 0.25f;
						white8.A = 0;
						white8.G = 0;
						white8.B = 0;
						float num312 = (float)num311 / (float)num299 * ((float)Math.PI * 2f) + rCurrentNPC.rotation + num302;
						Vector2 position32 = rCurrentNPC.Center + num312.ToRotationVector2() * num301 * num300 - screenPos;
						position32 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position32 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value82, position32, rectangle13, white8, num312, origin26, vector71 * 1.8f, spriteEffects, 0f);
					}
					for (int num313 = 0; num313 < num299; num313++)
					{
						Microsoft.Xna.Framework.Color white9 = Microsoft.Xna.Framework.Color.White;
						white9 *= Utils.GetLerpValue(0f, 0.5f, num300) * Utils.GetLerpValue(1f, 0.5f, num300) * 0.25f;
						white9.A = 0;
						float num314 = (float)num313 / (float)num299 * ((float)Math.PI * 2f) + rCurrentNPC.rotation + num302;
						Vector2 position33 = rCurrentNPC.Center + num314.ToRotationVector2() * num301 * num300 - screenPos;
						position33 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
						position33 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
						mySpriteBatch.Draw(value82, position33, rectangle13, white9, num314, origin26, vector71 * 1.5f, spriteEffects, 0f);
					}
				}
				break;
			}
			}
			for (int num316 = num296; num316 < num294; num316 += num295)
			{
				_ = ref rCurrentNPC.oldPos[num316];
				Microsoft.Xna.Framework.Color value83 = color44;
				value83 = Microsoft.Xna.Framework.Color.Lerp(value83, color43, amount10);
				value83 = rCurrentNPC.GetAlpha(value83);
				value83 *= (float)(num294 - num316) / (float)num297;
				_ = rCurrentNPC.rotation;
				if (num298 == 1)
				{
					_ = rCurrentNPC.oldRot[num316];
				}
				float scale9 = MathHelper.Lerp(scale8, value81, 1f - (float)(num294 - num316) / (float)num297);
				Vector2 position34 = rCurrentNPC.oldPos[num316] + new Vector2(rCurrentNPC.width, rCurrentNPC.height) / 2f - screenPos;
				position34 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
				position34 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
				mySpriteBatch.Draw(value80, position34, rCurrentNPC.frame, value83, rCurrentNPC.rotation, halfSize, scale9, spriteEffects, 0f);
			}
			for (int num317 = 0; num317 < num299; num317++)
			{
				Microsoft.Xna.Framework.Color value84 = npcColor;
				value84 = Microsoft.Xna.Framework.Color.Lerp(value84, color43, amount10);
				value84 = rCurrentNPC.GetAlpha(value84);
				value84 = Microsoft.Xna.Framework.Color.Lerp(value84, color43, amount11);
				value84 *= 1f - num300;
				Vector2 position35 = rCurrentNPC.Center + ((float)num317 / (float)num299 * ((float)Math.PI * 2f) + rCurrentNPC.rotation + num302).ToRotationVector2() * num301 * num300 - screenPos;
				position35 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
				position35 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
				mySpriteBatch.Draw(value80, position35, rCurrentNPC.frame, value84, rCurrentNPC.rotation, origin25, rCurrentNPC.scale, spriteEffects, 0f);
			}
			Vector2 vector72 = rCurrentNPC.Center - screenPos;
			vector72 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
			vector72 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
			mySpriteBatch.Draw(value80, vector72, rCurrentNPC.frame, rCurrentNPC.GetAlpha(color44), rCurrentNPC.rotation, origin25, rCurrentNPC.scale, spriteEffects, 0f);
			switch (type)
			{
			case 427:
				mySpriteBatch.Draw(TextureAssets.GlowMask[152].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 255 - rCurrentNPC.alpha, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
				break;
			case 426:
				mySpriteBatch.Draw(TextureAssets.GlowMask[153].Value, rCurrentNPC.Bottom - screenPos + new Vector2((float)(-TextureAssets.Npc[type].Width()) * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, (float)(-TextureAssets.Npc[type].Height()) * rCurrentNPC.scale / (float)npcFrameCount[type] + 4f + halfSize.Y * rCurrentNPC.scale + num47 + rCurrentNPC.gfxOffY), rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 128 - rCurrentNPC.alpha / 2, 0), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
				break;
			}
			if (type == 541)
			{
				Microsoft.Xna.Framework.Color color45 = new Microsoft.Xna.Framework.Color(127 - rCurrentNPC.alpha, 127 - rCurrentNPC.alpha, 127 - rCurrentNPC.alpha, 0).MultiplyRGBA(Microsoft.Xna.Framework.Color.Gold);
				for (int num318 = 0; num318 < num299; num318++)
				{
					Microsoft.Xna.Framework.Color newColor5 = color45;
					newColor5 = rCurrentNPC.GetAlpha(newColor5);
					newColor5 *= 1f - num300;
					Vector2 position36 = rCurrentNPC.Center + ((float)num318 / (float)num299 * ((float)Math.PI * 2f) + rCurrentNPC.rotation + num302).ToRotationVector2() * (4f * num300 + 2f) - screenPos;
					position36 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					position36 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(TextureAssets.GlowMask[216].Value, position36, rCurrentNPC.frame, newColor5, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
				}
				mySpriteBatch.Draw(TextureAssets.GlowMask[216].Value, vector72, rCurrentNPC.frame, color45, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
			}
			if (type == 661)
			{
				num302 = MathHelper.Lerp(0f, 3f, Utils.GetLerpValue(0f, 60f, rCurrentNPC.ai[2], clamped: true));
				for (int num319 = 0; num319 < num299; num319++)
				{
					Microsoft.Xna.Framework.Color newColor6 = new Microsoft.Xna.Framework.Color(127 - rCurrentNPC.alpha, 127 - rCurrentNPC.alpha, 127 - rCurrentNPC.alpha, 0).MultiplyRGBA(hslToRgb((GlobalTimeWrappedHourly + (float)num319 / (float)num299) % 1f, 1f, 0.5f));
					newColor6 = rCurrentNPC.GetAlpha(newColor6);
					newColor6 *= 1f - num300 * 0.5f;
					newColor6.A = 0;
					float num320 = 2f + rCurrentNPC.ai[2];
					Vector2 position37 = rCurrentNPC.Center + ((float)num319 / (float)num299 * ((float)Math.PI * 2f) + rCurrentNPC.rotation + num302).ToRotationVector2() * (num320 * num300 + 2f) - screenPos;
					position37 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					position37 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(value80, position37, rCurrentNPC.frame, newColor6, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
				}
				mySpriteBatch.Draw(value80, vector72, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.1f, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
			}
			if ((type == 568 || type == 569) && rCurrentNPC.localAI[3] >= 60f)
			{
				Microsoft.Xna.Framework.Color color46 = new Microsoft.Xna.Framework.Color(127 - rCurrentNPC.alpha, 127 - rCurrentNPC.alpha, 127 - rCurrentNPC.alpha, 0).MultiplyRGBA(color43);
				for (int num321 = 0; num321 < num299; num321++)
				{
					Microsoft.Xna.Framework.Color newColor7 = color46;
					newColor7 = rCurrentNPC.GetAlpha(newColor7);
					newColor7 *= 1f - num300;
					Vector2 position38 = rCurrentNPC.Center + ((float)num321 / (float)num299 * ((float)Math.PI * 2f) + rCurrentNPC.rotation + num302).ToRotationVector2() * (4f * num300 + 2f) - screenPos;
					position38 -= new Vector2(value80.Width, value80.Height / npcFrameCount[type]) * rCurrentNPC.scale / 2f;
					position38 += halfSize * rCurrentNPC.scale + new Vector2(0f, num46 + num47 + rCurrentNPC.gfxOffY);
					mySpriteBatch.Draw(TextureAssets.GlowMask[224].Value, position38, rCurrentNPC.frame, newColor7, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
				}
				mySpriteBatch.Draw(TextureAssets.GlowMask[224].Value, vector72, rCurrentNPC.frame, color46, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
				float num322 = rCurrentNPC.localAI[0];
				if (num322 > 0f)
				{
					byte a = (byte)((Math.Cos(num322 * ((float)Math.PI * 2f) / 60f) * 0.5 + 0.5) * 32.0 + 0.0);
					Microsoft.Xna.Framework.Color color47 = new Microsoft.Xna.Framework.Color(180, 90, 255, a) * 0.75f;
					float num323 = 1f;
					if (num322 < 60f)
					{
						float lerpValue3 = Utils.GetLerpValue(0f, 60f, num322);
						color47 *= lerpValue3;
						num323 = MathHelper.Lerp(1f, 0.5f, 1f - lerpValue3 * lerpValue3);
					}
					Texture2D value85 = TextureAssets.Extra[89].Value;
					Vector2 origin27 = value85.Size() / 2f;
					Vector2 scale10 = new Vector2(num323);
					float num324 = num322 * 0.0041887905f;
					float num325 = (float)Math.PI / 2f;
					scale10.Y *= 1f;
					scale10.X *= 1f;
					for (float num326 = 0f; num326 < 16f; num326 += 1f)
					{
						float num327 = num324 + (float)Math.PI * 2f * (num326 / 16f);
						Vector2 position39 = rCurrentNPC.Center - screenPos + num327.ToRotationVector2() * 400f * num323;
						mySpriteBatch.Draw(value85, position39, null, color47, num327 + (float)Math.PI / 2f + num325, origin27, scale10, SpriteEffects.None, 0f);
					}
				}
			}
			if (type == 546)
			{
				mySpriteBatch.Draw(TextureAssets.Extra[76].Value, vector72, rCurrentNPC.frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 200), MathHelper.Clamp(rCurrentNPC.velocity.X * 0.1f, -(float)Math.PI / 8f, (float)Math.PI / 8f), halfSize, rCurrentNPC.scale, spriteEffects, 0f);
			}
			if ((type == 566 || type == 567) && rCurrentNPC.localAI[3] >= 115f)
			{
				int frameY = (int)(GlobalTimeWrappedHourly % 0.5f / 0.5f * 4f);
				Texture2D value86 = TextureAssets.Extra[80].Value;
				Microsoft.Xna.Framework.Rectangle rectangle14 = value86.Frame(1, 4, 0, frameY);
				Vector2 vector73 = new Vector2(rCurrentNPC.spriteDirection * 8, -26f) * rCurrentNPC.scale;
				int num328 = rCurrentNPC.frame.Y / rCurrentNPC.frame.Height;
				int num329 = 0;
				switch (num328)
				{
				case 0:
					num329 = 6;
					break;
				case 1:
					num329 = 4;
					break;
				case 2:
					num329 = 2;
					break;
				case 3:
					num329 = 6;
					break;
				case 4:
					num329 = 8;
					break;
				case 5:
					num329 = 6;
					break;
				case 6:
					num329 = 4;
					break;
				case 7:
					num329 = 6;
					break;
				case 8:
					num329 = 2;
					break;
				}
				Microsoft.Xna.Framework.Color color48 = new Microsoft.Xna.Framework.Color(255, 255, 255, 130);
				vector73.Y += num329;
				mySpriteBatch.Draw(value86, vector72 + vector73 * rCurrentNPC.scale, rectangle14, color48, MathHelper.Clamp(rCurrentNPC.velocity.X * 0.1f, -(float)Math.PI / 8f, (float)Math.PI / 8f), rectangle14.Size() / 2f, rCurrentNPC.scale * 0.7f, spriteEffects ^ SpriteEffects.FlipHorizontally, 0f);
			}
			if (type == 618)
			{
				mySpriteBatch.Draw(TextureAssets.Extra[129].Value, vector72, rCurrentNPC.frame, rCurrentNPC.GetAlpha(color44), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, spriteEffects, 0f);
			}
			break;
		}
		}
	}

	private static void DrawNPCDirect_Deerclops(SpriteBatch mySpriteBatch, NPC rCurrentNPC, ref Vector2 screenPos, int typeCache, ref Microsoft.Xna.Framework.Color npcColor, ref Vector2 halfSize, SpriteEffects npcSpriteEffect)
	{
		Texture2D value = TextureAssets.Npc[typeCache].Value;
		Vector2 vector = rCurrentNPC.Bottom - screenPos;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(5, 5, rCurrentNPC.frame.Y / 5, rCurrentNPC.frame.Y % 5, 2, 2);
		Vector2 origin = rectangle.Size() * new Vector2(0.5f, 1f);
		origin.Y -= 4f;
		int num = 106;
		if (rCurrentNPC.spriteDirection == 1)
		{
			origin.X = num;
		}
		else
		{
			origin.X = rectangle.Width - num;
		}
		Microsoft.Xna.Framework.Color value2 = Microsoft.Xna.Framework.Color.White;
		float amount = 0f;
		float amount2 = 0f;
		int num2 = 0;
		float num3 = 0f;
		float num4 = 0f;
		float num5 = 10f;
		Microsoft.Xna.Framework.Color color = npcColor;
		if (rCurrentNPC.localAI[3] > 0f)
		{
			float num6 = rCurrentNPC.localAI[3] / 36f;
			num2 = 2;
			num3 = num6 * num6;
			num4 = 20f;
			value2 = new Microsoft.Xna.Framework.Color(80, 0, 0, 255) * 0.5f;
			amount2 = 1f;
			color = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color, 1f - num6 * num6);
		}
		for (int i = 0; i < num2; i++)
		{
			Microsoft.Xna.Framework.Color value3 = npcColor;
			value3 = Microsoft.Xna.Framework.Color.Lerp(value3, value2, amount);
			value3 = rCurrentNPC.GetAlpha(value3);
			value3 = Microsoft.Xna.Framework.Color.Lerp(value3, value2, amount2);
			value3 *= 1f - num3 * 0.5f;
			Vector2 vector2 = vector;
			mySpriteBatch.Draw(value, vector2 + new Vector2(0f, 1f).RotatedBy((float)i * ((float)Math.PI * 2f) / (float)num2 + GlobalTimeWrappedHourly * num5) * num3 * num4, rectangle, value3, rCurrentNPC.rotation, origin, rCurrentNPC.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
		}
		Microsoft.Xna.Framework.Color color2 = rCurrentNPC.GetAlpha(color);
		Microsoft.Xna.Framework.Color value4 = new Microsoft.Xna.Framework.Color(50, 0, 160);
		float num7 = 0f;
		if (rCurrentNPC.localAI[3] > 0f)
		{
			float amount3 = Utils.Remap(rCurrentNPC.localAI[3], 0f, 20f, 0f, 1f);
			color2 = Microsoft.Xna.Framework.Color.Lerp(color2, value4, amount3);
		}
		if (rCurrentNPC.ai[0] == 7f || rCurrentNPC.ai[0] == 8f)
		{
			num7 = Utils.Remap(rCurrentNPC.ai[1], 20f, 60f, 0f, 2f);
			if (num7 > 1f)
			{
				num7 = 2f - num7;
			}
			color2 = Microsoft.Xna.Framework.Color.Lerp(color2, value4, num7);
			color2 *= 1f - num7;
			float num8 = 5f;
			for (int j = 0; (float)j < num8; j++)
			{
				Vector2 vector3 = vector;
				float num9 = num7 * num7;
				float num10 = 80f * num9;
				float num11 = 80f * num9 + (float)(30 * j) * num9;
				Vector2 vector4 = Vector2.UnitX.RotatedBy((float)j * ((float)Math.PI * 2f) / num8 + GlobalTimeWrappedHourly * 6f) * num10;
				Vector2 vector5 = Vector2.UnitX.RotatedBy((float)j * ((float)Math.PI * 2f) / num8 + GlobalTimeWrappedHourly * 3f * ((float)j * 0.5f)) * num11;
				mySpriteBatch.Draw(value, vector3 + vector4 + vector5, rectangle, color2 * 0.5f, rCurrentNPC.rotation, origin, rCurrentNPC.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
			}
		}
		mySpriteBatch.Draw(value, vector, rectangle, color2, rCurrentNPC.rotation, origin, rCurrentNPC.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
		if (rCurrentNPC.localAI[3] > 0f)
		{
			Texture2D value5 = TextureAssets.Extra[245].Value;
			float num12 = Utils.Remap(rCurrentNPC.localAI[3], 0f, 20f, 0f, 1f);
			Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(255, 30, 30, 66) * rCurrentNPC.Opacity * num12 * 0.25f * (1f - num7);
			for (int k = 0; k < num2; k++)
			{
				Vector2 vector6 = vector;
				mySpriteBatch.Draw(value5, vector6 + new Vector2(0f, 1f).RotatedBy((float)k * ((float)Math.PI * 2f) / (float)num2 + GlobalTimeWrappedHourly * num5) * num3 * 4f, rectangle, color3, rCurrentNPC.rotation, origin, rCurrentNPC.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
			}
		}
	}

	private static void DrawNPCDirect_DeerclopsLeg(SpriteBatch mySpriteBatch, NPC rCurrentNPC, ref Vector2 screenPos, int typeCache, ref Microsoft.Xna.Framework.Color npcColor, ref Vector2 halfSize, SpriteEffects npcSpriteEffect)
	{
		Microsoft.Xna.Framework.Rectangle? sourceRectangle = null;
		int num = 0;
		int num2 = 0;
		mySpriteBatch.Draw(TextureAssets.Npc[typeCache].Value, new Vector2(rCurrentNPC.position.X - screenPos.X + (float)(rCurrentNPC.width / 2) - (float)TextureAssets.Npc[typeCache].Width() * rCurrentNPC.scale / 2f + halfSize.X * rCurrentNPC.scale, rCurrentNPC.position.Y - screenPos.Y + (float)rCurrentNPC.height - (float)TextureAssets.Npc[typeCache].Height() * rCurrentNPC.scale / (float)npcFrameCount[typeCache] + 4f + halfSize.Y * rCurrentNPC.scale + (float)num2 + (float)num + rCurrentNPC.gfxOffY), sourceRectangle, rCurrentNPC.GetAlpha(npcColor), rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
	}

	private static void DrawNPCDirect_Faeling(SpriteBatch mySpriteBatch, NPC rCurrentNPC, ref Vector2 screenPos, int typeCache, ref Microsoft.Xna.Framework.Color npcColor, ref Vector2 halfSize, SpriteEffects npcSpriteEffect)
	{
		Texture2D value = TextureAssets.Npc[typeCache].Value;
		Vector2 vector = rCurrentNPC.Center - screenPos;
		int num = 5;
		int horizontalFrames = 4;
		float num2 = ((float)rCurrentNPC.whoAmI * 0.11f + (float)timeForVisualEffects / 360f) % 1f;
		Microsoft.Xna.Framework.Color color = hslToRgb(num2, 1f, 0.65f);
		color.A /= 2;
		float rotation = rCurrentNPC.rotation;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(horizontalFrames, num, 0, rCurrentNPC.frame.Y);
		Vector2 origin = rectangle.Size() / 2f;
		float scale = rCurrentNPC.scale;
		Microsoft.Xna.Framework.Rectangle value2 = value.Frame(horizontalFrames, num, 2);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 1f;
		int num3 = rCurrentNPC.oldPos.Length;
		int num4 = num3 - 1 - 5;
		int num5 = 5;
		int num6 = 3;
		float num7 = 32f;
		float num8 = 16f;
		float fromMax = new Vector2(num7, num8).Length();
		float num9 = Utils.Remap(Vector2.Distance(rCurrentNPC.oldPos[num4], rCurrentNPC.position), 0f, fromMax, 0f, 100f);
		num9 = (int)num9 / 5;
		num9 *= 5f;
		num9 /= 100f;
		num8 *= num9;
		num7 *= num9;
		float num10 = 9f;
		float num11 = 0.5f;
		float num12 = (float)Math.PI;
		for (int num13 = num4; num13 >= num5; num13 -= num6)
		{
			Vector2 vector2 = rCurrentNPC.oldPos[num13] - rCurrentNPC.position;
			float num14 = Utils.Remap(num13, 0f, num3, 1f, 0f);
			float num15 = 1f - num14;
			Vector2 spinningpoint = new Vector2((float)Math.Sin((double)((float)rCurrentNPC.whoAmI / 17f) + timeForVisualEffects / (double)num10 + (double)(num14 * 2f * ((float)Math.PI * 2f))) * num8, 0f - num7) * num15;
			vector2 += spinningpoint.RotatedBy(num12);
			Microsoft.Xna.Framework.Color color3 = hslToRgb((num2 + num15 * num11) % 1f, 1f, 0.5f);
			color3.A = 0;
			mySpriteBatch.Draw(value, vector + vector2, value2, color3 * num14 * 0.16f, rotation, origin, scale * Utils.Remap(num14 * num14, 0f, 1f, 0f, 2.5f), npcSpriteEffect, 0f);
		}
		mySpriteBatch.Draw(value, vector, value2, color2, rotation, origin, scale, npcSpriteEffect, 0f);
		Microsoft.Xna.Framework.Rectangle value3 = value.Frame(horizontalFrames, num, 1, rCurrentNPC.frame.Y);
		Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
		white.A /= 2;
		mySpriteBatch.Draw(value, vector, value3, white, rotation, origin, scale, npcSpriteEffect, 0f);
		mySpriteBatch.Draw(value, vector, rectangle, color, rotation, origin, scale, npcSpriteEffect, 0f);
		float num16 = MathHelper.Clamp((float)Math.Sin(timeForVisualEffects / 60.0) * 0.3f + 0.3f, 0f, 1f);
		float num17 = 0.8f + (float)Math.Sin(timeForVisualEffects / 15.0 * 6.2831854820251465) * 0.3f;
		Microsoft.Xna.Framework.Rectangle value4 = value.Frame(horizontalFrames, num, 3, rCurrentNPC.whoAmI % num);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.Lerp(color, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), 0.5f) * num16;
		mySpriteBatch.Draw(value, vector, value4, color4, rotation, origin, scale * num17, SpriteEffects.None, 0f);
		Microsoft.Xna.Framework.Rectangle value5 = value.Frame(horizontalFrames, num, 3, 1);
		Microsoft.Xna.Framework.Color color5 = Microsoft.Xna.Framework.Color.Lerp(color, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), 0.5f) * num16;
		mySpriteBatch.Draw(value, vector, value5, color5, rotation, origin, scale * num17, SpriteEffects.None, 0f);
	}

	private static void DrawNPCDirect_HallowBoss(SpriteBatch mySpriteBatch, NPC rCurrentNPC, ref Vector2 screenPos, int typeCache, ref Microsoft.Xna.Framework.Color npcColor, ref Vector2 halfSize, SpriteEffects npcSpriteEffect)
	{
		Texture2D value = TextureAssets.Npc[typeCache].Value;
		Vector2 vector = rCurrentNPC.Center - screenPos;
		bool flag = rCurrentNPC.AI_120_HallowBoss_IsInPhase2();
		int num = (int)rCurrentNPC.ai[0];
		Texture2D value2 = TextureAssets.Extra[159].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value2.Frame(1, 11, 0, (int)(rCurrentNPC.localAI[0] / 4f) % 11);
		Microsoft.Xna.Framework.Color color = rCurrentNPC.GetAlpha(npcColor);
		Texture2D value3 = TextureAssets.Extra[158].Value;
		Texture2D value4 = TextureAssets.Extra[160].Value;
		Texture2D value5 = TextureAssets.Extra[157].Value;
		DrawNPCDirect_GetHallowBossArmFrame(rCurrentNPC, out var armFrame_Count, out var armFrameToUseLeft, out var armFrameToUseRight);
		Microsoft.Xna.Framework.Rectangle rectangle2 = value3.Frame(1, armFrame_Count, 0, armFrameToUseLeft);
		Microsoft.Xna.Framework.Rectangle rectangle3 = value4.Frame(1, armFrame_Count, 0, armFrameToUseRight);
		Vector2 origin = rectangle2.Size() / 2f;
		Vector2 origin2 = rectangle3.Size() / 2f;
		int num2 = 0;
		int num3 = 0;
		if (armFrameToUseLeft == 5)
		{
			num2 = 1;
		}
		if (armFrameToUseRight == 5)
		{
			num3 = 1;
		}
		float num4 = 1f;
		int num5 = 0;
		int num6 = 0;
		float num7 = 0f;
		float num8 = 0f;
		float num9 = 0f;
		if (num == 8 || num == 9)
		{
			num7 = Utils.GetLerpValue(0f, 30f, rCurrentNPC.ai[1], clamped: true) * Utils.GetLerpValue(90f, 30f, rCurrentNPC.ai[1], clamped: true);
			num8 = Utils.GetLerpValue(0f, 30f, rCurrentNPC.ai[1], clamped: true) * Utils.GetLerpValue(90f, 70f, rCurrentNPC.ai[1], clamped: true);
			num9 = Utils.GetLerpValue(0f, 15f, rCurrentNPC.ai[1], clamped: true) * Utils.GetLerpValue(45f, 30f, rCurrentNPC.ai[1], clamped: true);
			color = Microsoft.Xna.Framework.Color.Lerp(color, Microsoft.Xna.Framework.Color.White, num7);
			num4 *= 1f - num9;
			num5 = 4;
			num6 = 3;
		}
		if (num == 10)
		{
			num7 = Utils.GetLerpValue(30f, 90f, rCurrentNPC.ai[1], clamped: true) * Utils.GetLerpValue(165f, 90f, rCurrentNPC.ai[1], clamped: true);
			num8 = Utils.GetLerpValue(0f, 60f, rCurrentNPC.ai[1], clamped: true) * Utils.GetLerpValue(180f, 120f, rCurrentNPC.ai[1], clamped: true);
			num9 = Utils.GetLerpValue(0f, 60f, rCurrentNPC.ai[1], clamped: true) * Utils.GetLerpValue(180f, 120f, rCurrentNPC.ai[1], clamped: true);
			color = Microsoft.Xna.Framework.Color.Lerp(color, Microsoft.Xna.Framework.Color.White, num7);
			num4 *= 1f - num9;
			num6 = 4;
		}
		if (num6 + num5 > 0)
		{
			for (int i = -num6; i <= num6 + num5; i++)
			{
				if (i == 0)
				{
					continue;
				}
				Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.White;
				Vector2 position = vector;
				if (num == 8 || num == 9)
				{
					float hue = ((float)i + 5f) / 10f;
					float num10 = 200f;
					float num11 = (float)timeForVisualEffects / 60f;
					Vector3 vector2 = Vector3.Transform(matrix: Matrix.CreateRotationX((num11 - 0.3f + (float)i * 0.1f) * 0.7f * ((float)Math.PI * 2f)) * Matrix.CreateRotationY((num11 - 0.8f + (float)i * 0.3f) * 0.7f * ((float)Math.PI * 2f)) * Matrix.CreateRotationZ((num11 + (float)i * 0.5f) * 0.1f * ((float)Math.PI * 2f)), position: Vector3.Forward);
					num10 += Utils.GetLerpValue(-1f, 1f, vector2.Z, clamped: true) * 150f;
					Vector2 spinningpoint = new Vector2(vector2.X, vector2.Y) * num10 * num7;
					float lerpValue = Utils.GetLerpValue(90f, 0f, rCurrentNPC.ai[1], clamped: true);
					color2 = hslToRgb(hue, 1f, MathHelper.Lerp(0.5f, 1f, lerpValue)) * 0.8f * num8;
					color2.A /= 3;
					position += spinningpoint.RotatedBy(rCurrentNPC.ai[1] / 180f * ((float)Math.PI * 2f));
				}
				if (num == 10)
				{
					if (rCurrentNPC.ai[1] >= 90f)
					{
						float num12 = (float)timeForVisualEffects / 90f;
						int num13 = i;
						if (num13 < 0)
						{
							num13++;
						}
						Vector2 vector3 = (((float)num13 + 0.5f) * ((float)Math.PI / 4f) + (float)Math.PI * 2f * num12).ToRotationVector2();
						position += vector3 * new Vector2(600f * num7, 150f * num7);
					}
					else
					{
						position += 200f * new Vector2(i, 0f) * num7;
					}
					color2 = Microsoft.Xna.Framework.Color.White * 0.8f * num8 * num4;
					color2.A /= 3;
				}
				if (i > num6)
				{
					float lerpValue2 = Utils.GetLerpValue(30f, 70f, rCurrentNPC.ai[1], clamped: true);
					if (lerpValue2 == 0f)
					{
						continue;
					}
					position = vector + rCurrentNPC.velocity * -3f * ((float)i - 4f) * lerpValue2;
					color2 *= 1f - num9;
				}
				mySpriteBatch.Draw(value2, position, rectangle, color2, rCurrentNPC.rotation, rectangle.Size() / 2f, rCurrentNPC.scale * 2f, npcSpriteEffect, 0f);
				mySpriteBatch.Draw(value5, position, rectangle, color2, rCurrentNPC.rotation, rectangle.Size() / 2f, rCurrentNPC.scale * 2f, npcSpriteEffect, 0f);
				if (flag)
				{
					Texture2D value6 = TextureAssets.Extra[187].Value;
					Microsoft.Xna.Framework.Rectangle value7 = value6.Frame(1, 8, 0, (int)(rCurrentNPC.localAI[0] / 4f) % 8);
					mySpriteBatch.Draw(value6, position, value7, color2, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
				}
				mySpriteBatch.Draw(value, position, rCurrentNPC.frame, color2, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
				for (int j = 0; j < 2; j++)
				{
					if (j == num2)
					{
						mySpriteBatch.Draw(value3, position, rectangle2, color2, rCurrentNPC.rotation, origin, rCurrentNPC.scale, npcSpriteEffect, 0f);
					}
					if (j == num3)
					{
						mySpriteBatch.Draw(value4, position, rectangle3, color2, rCurrentNPC.rotation, origin2, rCurrentNPC.scale, npcSpriteEffect, 0f);
					}
				}
			}
		}
		color *= num4;
		mySpriteBatch.Draw(value2, vector, rectangle, color, rCurrentNPC.rotation, rectangle.Size() / 2f, rCurrentNPC.scale * 2f, npcSpriteEffect, 0f);
		if (!rCurrentNPC.IsABestiaryIconDummy)
		{
			mySpriteBatch.End();
			mySpriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, Transform);
		}
		DrawData value8 = new DrawData(value5, vector, rectangle, color, rCurrentNPC.rotation, rectangle.Size() / 2f, rCurrentNPC.scale * 2f, npcSpriteEffect);
		GameShaders.Misc["HallowBoss"].Apply(value8);
		value8.Draw(mySpriteBatch);
		pixelShader.CurrentTechnique.Passes[0].Apply();
		if (!rCurrentNPC.IsABestiaryIconDummy)
		{
			mySpriteBatch.End();
			mySpriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		}
		float num14 = (float)Math.Sin(GlobalTimeWrappedHourly * ((float)Math.PI * 2f) * 0.5f) * 0.5f + 0.5f;
		Microsoft.Xna.Framework.Color color3 = hslToRgb((num14 * 0.08f + 0.6f) % 1f, 1f, 0.5f);
		color3.A = 0;
		color3 *= 0.6f;
		if (NPC.ShouldEmpressBeEnraged())
		{
			color3 = OurFavoriteColor;
			color3.A = 0;
			color3 *= 0.3f;
		}
		color3 *= num4 * rCurrentNPC.Opacity;
		if (flag)
		{
			Texture2D value9 = TextureAssets.Extra[187].Value;
			Microsoft.Xna.Framework.Rectangle value10 = value9.Frame(1, 8, 0, (int)(rCurrentNPC.localAI[0] / 4f) % 8);
			mySpriteBatch.Draw(value9, vector, value10, color, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
			for (float num15 = 0f; num15 < 1f; num15 += 0.25f)
			{
				Vector2 vector4 = rCurrentNPC.rotation.ToRotationVector2().RotatedBy(num15 * ((float)Math.PI * 2f) + (float)Math.PI / 4f) * MathHelper.Lerp(2f, 8f, num14);
				mySpriteBatch.Draw(value9, vector + vector4, value10, color3, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
			}
		}
		mySpriteBatch.Draw(value, vector, rCurrentNPC.frame, color, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
		if (flag)
		{
			Texture2D value11 = TextureAssets.Extra[188].Value;
			for (float num16 = 0f; num16 < 1f; num16 += 0.25f)
			{
				Vector2 vector5 = rCurrentNPC.rotation.ToRotationVector2().RotatedBy(num16 * ((float)Math.PI * 2f) + (float)Math.PI / 4f) * MathHelper.Lerp(2f, 8f, num14);
				mySpriteBatch.Draw(value11, vector + vector5, null, color3, rCurrentNPC.rotation, halfSize, rCurrentNPC.scale, npcSpriteEffect, 0f);
			}
		}
		for (int k = 0; k < 2; k++)
		{
			if (k == num2)
			{
				mySpriteBatch.Draw(value3, vector, rectangle2, color, rCurrentNPC.rotation, origin, rCurrentNPC.scale, npcSpriteEffect, 0f);
			}
			if (k == num3)
			{
				mySpriteBatch.Draw(value4, vector, rectangle3, color, rCurrentNPC.rotation, origin2, rCurrentNPC.scale, npcSpriteEffect, 0f);
			}
		}
	}

	private static void DrawNPCDirect_GetHallowBossArmFrame(NPC rCurrentNPC, out int armFrame_Count, out int armFrameToUseLeft, out int armFrameToUseRight)
	{
		int num = 0;
		int num2 = 1;
		int num3 = 2;
		int num4 = 3;
		int num5 = 4;
		int num6 = 5;
		int num7 = 6;
		armFrame_Count = 7;
		armFrameToUseLeft = num;
		armFrameToUseRight = num;
		float num8 = rCurrentNPC.ai[1];
		int num9 = num;
		switch ((int)rCurrentNPC.ai[0])
		{
		case 6:
			armFrameToUseRight = (armFrameToUseLeft = ((num8 < 6f) ? num3 : ((num8 < 174f) ? num4 : ((!(num8 < 180f)) ? num : num3))));
			break;
		case 0:
			armFrameToUseRight = (armFrameToUseLeft = ((num8 < 106f) ? num2 : ((!(num8 < 110f)) ? num : num3)));
			break;
		case 2:
		case 11:
			num9 = ((num8 < 5f) ? num3 : ((!(num8 < 65f)) ? num3 : num4));
			armFrameToUseLeft = num9;
			break;
		case 5:
			num9 = ((num8 < 6f) ? num3 : ((!(num8 < 54f)) ? num3 : num4));
			armFrameToUseRight = num9;
			break;
		case 4:
		case 10:
			armFrameToUseRight = (armFrameToUseLeft = ((num8 < 6f) ? num3 : ((!(num8 < 54f)) ? num3 : num4)));
			break;
		case 8:
		case 9:
		{
			num9 = ((num8 < 10f) ? num3 : ((num8 < 20f) ? num4 : ((!(num8 < 30f)) ? num6 : num3)));
			int num13 = num9;
			int num14 = num9;
			int num15 = (int)rCurrentNPC.ai[3];
			int num16 = -1;
			if (num8 < 30f)
			{
				if (num15 == -1 * num16)
				{
					num14 = num2;
				}
				if (num15 == num16)
				{
					num13 = num2;
				}
			}
			int num17 = num6;
			int num18 = num7;
			if (num15 == num16 && num14 == num17)
			{
				num14 = num18;
			}
			if (num15 == -1 * num16 && num13 == num17)
			{
				num13 = num18;
			}
			armFrameToUseLeft = num14;
			armFrameToUseRight = num13;
			break;
		}
		case 7:
		{
			int num10 = (expertMode ? 40 : 60);
			int num11 = 0;
			int num12 = 5;
			if (num8 < (float)(num11 + num12))
			{
				armFrameToUseLeft = num3;
				break;
			}
			num11 += num12;
			if (num8 < (float)(num11 + num10 - num12))
			{
				armFrameToUseLeft = num4;
				break;
			}
			num11 += num10 - num12;
			if (num8 < (float)(num11 + num12))
			{
				armFrameToUseLeft = num4;
				armFrameToUseRight = num3;
				break;
			}
			num11 += num12;
			if (num8 < (float)(num11 + num10 - num12))
			{
				armFrameToUseLeft = num4;
				armFrameToUseRight = num4;
				break;
			}
			num11 += num10 - num12;
			if (num8 < (float)(num11 + num10))
			{
				armFrameToUseLeft = num5;
				armFrameToUseRight = num4;
				break;
			}
			num11 += num10;
			if (num8 < (float)(num11 + num10))
			{
				armFrameToUseLeft = num5;
				armFrameToUseRight = num5;
				break;
			}
			num11 += num10;
			if (expertMode)
			{
				if (num8 < (float)(num11 + num12))
				{
					armFrameToUseLeft = num4;
					armFrameToUseRight = num5;
					break;
				}
				num11 += num12;
				if (num8 < (float)(num11 + num10 - num12))
				{
					armFrameToUseLeft = num2;
					armFrameToUseRight = num5;
					break;
				}
				num11 += num10 - num12;
				if (num8 < (float)(num11 + num12))
				{
					armFrameToUseLeft = num2;
					armFrameToUseRight = num4;
					break;
				}
				num11 += num12;
				if (num8 < (float)(num11 + num10 - num12))
				{
					armFrameToUseLeft = num2;
					armFrameToUseRight = num2;
					break;
				}
				num11 += num10 - num12;
			}
			if (num8 >= (float)num11)
			{
				armFrameToUseLeft = num3;
				armFrameToUseRight = num3;
			}
			break;
		}
		case 1:
		case 3:
			break;
		}
	}

	private static void DrawNPC_SlimeItem(NPC rCurrentNPC, int typeCache, Microsoft.Xna.Framework.Color npcColor, float addedRotation)
	{
		int num = (int)rCurrentNPC.ai[1];
		float num2 = 1f;
		float num3 = 22f * rCurrentNPC.scale;
		float num4 = 18f * rCurrentNPC.scale;
		GetItemDrawFrame(num, out var itemTexture, out var rectangle);
		float num5 = rectangle.Width;
		float num6 = rectangle.Height;
		bool num7 = (int)rCurrentNPC.ai[0] == -999;
		if (num7)
		{
			num3 = 14f * rCurrentNPC.scale;
			num4 = 14f * rCurrentNPC.scale;
		}
		if (num5 > num3)
		{
			num2 *= num3 / num5;
			num5 *= num2;
			num6 *= num2;
		}
		if (num6 > num4)
		{
			num2 *= num4 / num6;
			num5 *= num2;
			num6 *= num2;
		}
		float num8 = -1f;
		float num9 = 1f;
		int num10 = rCurrentNPC.frame.Y / (TextureAssets.Npc[typeCache].Height() / npcFrameCount[typeCache]);
		float num11 = 0.2f;
		if (rCurrentNPC.type == 537)
		{
			num11 = 0f;
			num10 = 0;
			num9 += 4f;
		}
		num9 -= (float)num10;
		num8 += (float)(num10 * 2);
		num11 -= 0.3f * (float)num10;
		if (num7)
		{
			if (rCurrentNPC.velocity.X < 0f)
			{
				num11 *= -1f;
			}
			num9 -= 6f;
			if ((double)num2 >= 0.8)
			{
				num9 -= 1f;
			}
			if (num2 >= 1f)
			{
				num9 -= 3f;
			}
			if (num != 1345)
			{
				addedRotation = ((!(addedRotation < 0f)) ? (addedRotation * 4.5f) : (addedRotation * 5.5f));
			}
			else
			{
				num9 -= 4f * num2;
			}
			if (num == 150)
			{
				addedRotation *= 2f;
				num9 -= 3f;
			}
			if (num == 1345)
			{
				addedRotation *= 5f;
			}
			num8 -= num5 * addedRotation;
		}
		if (num == 75)
		{
			npcColor = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
			num11 *= 0.3f;
			num9 -= 2f;
		}
		npcColor = rCurrentNPC.GetShimmerColor(npcColor);
		SpriteEffects effects = SpriteEffects.None;
		if (num == 539 && rCurrentNPC.direction < 0)
		{
			effects = SpriteEffects.FlipHorizontally;
		}
		spriteBatch.Draw(itemTexture, new Vector2(rCurrentNPC.Center.X - screenPosition.X + num8, rCurrentNPC.Center.Y - screenPosition.Y + rCurrentNPC.gfxOffY + num9), rectangle, npcColor, num11, rectangle.Size() / 2f, num2, effects, 0f);
	}

	public static void GetItemDrawFrame(int item, out Texture2D itemTexture, out Microsoft.Xna.Framework.Rectangle itemFrame)
	{
		instance.LoadItem(item);
		itemTexture = TextureAssets.Item[item].Value;
		if (itemAnimations[item] != null)
		{
			itemFrame = itemAnimations[item].GetFrame(itemTexture);
		}
		else
		{
			itemFrame = itemTexture.Frame();
		}
	}

	protected void DrawNPCExtras(NPC n, bool beforeDraw, float addHeight, float addY, Microsoft.Xna.Framework.Color npcColor, Vector2 halfSize, SpriteEffects npcSpriteEffect, Vector2 screenPosition)
	{
		if (!beforeDraw && n.UsesPartyHat())
		{
			int num = n.frame.Y / n.frame.Height;
			int[] array = NPCID.Sets.TownNPCsFramingGroups[NPCID.Sets.NPCFramingGroup[n.type]];
			if (num >= array.Length)
			{
				num = 0;
			}
			Texture2D value = TextureAssets.Extra[72].Value;
			int num2 = 0;
			switch (n.GetPartyHatColor())
			{
			case PartyHatColor.Pink:
				num2 = 16;
				break;
			case PartyHatColor.Cyan:
				num2 = 17;
				break;
			case PartyHatColor.Purple:
				num2 = 18;
				break;
			case PartyHatColor.White:
				num2 = 19;
				break;
			}
			Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(20, 1, num2 % 20);
			rectangle.Width -= 2;
			rectangle.Height -= 2;
			int num3 = 0;
			int num4 = 0;
			int num5 = n.spriteDirection;
			if (n.type == 663)
			{
				num3 = 1;
			}
			if (n.type == 637)
			{
				num3 = 6;
				switch (num)
				{
				case 19:
				case 22:
				case 23:
				case 24:
				case 25:
				case 26:
				case 27:
					num3 -= 2;
					break;
				case 11:
				case 12:
				case 13:
				case 14:
				case 15:
					num3 += 2;
					break;
				}
			}
			if (n.type == 638)
			{
				num3 = 12;
			}
			if (n.type == 656)
			{
				num3 = 6;
				switch (num)
				{
				case 1:
				case 2:
				case 3:
					num3 -= 2;
					break;
				case 18:
				case 19:
				case 20:
				case 21:
				case 22:
				case 23:
				case 24:
				case 25:
					num3 -= 4;
					break;
				case 8:
					num3 -= 2;
					break;
				}
			}
			if (NPCID.Sets.IsTownSlime[n.type])
			{
				num5 *= -1;
				switch (n.type)
				{
				default:
					num3 = 1;
					break;
				case 670:
				case 679:
					num3 = -1;
					break;
				case 681:
					num3 = -2;
					break;
				case 682:
					num3 = -1;
					num4 = 2;
					break;
				case 683:
					num3 = -1;
					num4 = -2;
					break;
				case 684:
					num3 = -4;
					break;
				}
			}
			if (n.IsShimmerVariant)
			{
				switch (n.type)
				{
				case 38:
					num3 += 2;
					num4 = -2;
					break;
				case 178:
				case 228:
					num3 = -4;
					num4 = -4;
					break;
				case 107:
					num3 = 2;
					num4 = -6;
					break;
				case 54:
					num4 = -6;
					break;
				case 160:
					num4 = -2;
					break;
				case 108:
				case 124:
				case 208:
				case 209:
				case 227:
					num4 = -4;
					break;
				}
			}
			Vector2 bottom = n.Bottom;
			Vector2 vector = -new Vector2(0f, n.height) + new Vector2(-2 * num5, n.gfxOffY);
			vector.X += num3 * num5;
			vector.Y += array[num];
			vector.Y += num4;
			vector.Y += NPCID.Sets.HatOffsetY[n.type];
			int num6 = 0;
			if (n.ai[0] == 5f)
			{
				num6 = -4;
				if (n.type == 38)
				{
					num6 = -8;
				}
				if (n.type == 124)
				{
					num6 = -2;
				}
				if (n.type == 550)
				{
					num6 = -4;
				}
				if (n.type == 588)
				{
					num6 = -4;
				}
				if (n.type == 108 || n.type == 178)
				{
					num6 = -6;
				}
				if (n.type == 637)
				{
					num6 = -12;
				}
				if (n.type == 663)
				{
					num6 = -8;
				}
			}
			vector.Y += num6;
			if (n.type == 229 && n.ai[0] == 12f)
			{
				vector.X -= num5 * 4;
			}
			if (n.type == 550 && n.ai[0] == 5f)
			{
				vector.X += num5 * 7;
			}
			Vector2 origin = rectangle.Size() - new Vector2(rectangle.Width / 2, 12f);
			int num7 = 0;
			switch (n.type)
			{
			case 550:
				num7 = -4;
				break;
			case 588:
				num7 = 0;
				break;
			case 227:
				num7 = -4;
				break;
			case 228:
			case 678:
			case 681:
			case 682:
				num7 = -2;
				break;
			case 17:
			case 18:
			case 19:
			case 20:
			case 22:
			case 124:
			case 229:
			case 353:
			case 633:
			case 637:
			case 638:
			case 656:
			case 670:
			case 679:
			case 680:
			case 683:
			case 684:
				num7 = -1;
				break;
			case 37:
			case 38:
			case 54:
			case 107:
			case 108:
			case 160:
			case 207:
			case 209:
				num7 = -3;
				break;
			case 178:
			case 208:
			case 369:
				num7 = 1;
				break;
			}
			vector.X += num7 * num5;
			vector.X += 4 * num5;
			vector *= n.scale;
			bottom += vector;
			SpriteEffects spriteEffects = npcSpriteEffect;
			if (NPCID.Sets.IsTownSlime[n.type])
			{
				spriteEffects ^= SpriteEffects.FlipHorizontally;
			}
			float num8 = 1f;
			if (n.shimmerTransparency > 0f)
			{
				num8 *= 1f - n.shimmerTransparency;
			}
			if (n.IsAPortraitDummy)
			{
				if (n.scale == 2f)
				{
					bottom.Y -= 4f;
				}
				if (n.scale == 3f)
				{
					bottom.Y -= 8f;
				}
			}
			bottom -= screenPosition;
			spriteBatch.Draw(value, bottom, rectangle, npcColor * n.Opacity * num8, 0f, origin, n.scale, spriteEffects, 0f);
		}
		if (!beforeDraw && n.type == 681)
		{
			spriteBatch.Draw(TextureAssets.Extra[250].Value, new Vector2(n.position.X - screenPosition.X + (float)(n.width / 2) - (float)TextureAssets.Npc[n.type].Width() * n.scale / 2f + halfSize.X * n.scale, n.position.Y - screenPosition.Y + (float)n.height - (float)TextureAssets.Npc[n.type].Height() * n.scale / (float)npcFrameCount[n.type] + 4f + halfSize.Y * n.scale + addHeight + addY + n.gfxOffY), n.frame, n.GetAlpha(npcColor), n.rotation, halfSize, n.scale, npcSpriteEffect, 0f);
		}
		if (NPCID.Sets.AttackType[n.type] == 1 && n.ai[0] == 12f && !beforeDraw)
		{
			if (n.type == 228 || n.type == 229 || n.type == 209)
			{
				return;
			}
			float num9 = n.ai[2];
			Vector2 vector2 = OffsetsNPCOffhand[2];
			if (n.spriteDirection == 1)
			{
				vector2.X *= -1f;
			}
			Vector2 vector3 = n.Bottom - vector2;
			if (n.type == 22 && n.ai[2] > -0.1f)
			{
				vector3.Y += 4f;
			}
			if (n.type == 368 && hardMode && n.ai[2] > -0.1f)
			{
				vector3.Y += 4f;
			}
			if (n.type == 368 && !hardMode && n.ai[2] < -0.1f)
			{
				vector3.Y -= 8f;
			}
			float rotation = num9 * ((float)Math.PI / 2f) * (float)n.spriteDirection;
			float num10 = 1f;
			int itemtype = 0;
			int num11 = 4;
			if (n.type == 19)
			{
				itemtype = (hardMode ? 98 : 95);
				if (hardMode)
				{
					vector3.X -= 10 * n.direction;
					vector3.Y += 4f;
				}
			}
			else if (n.type == 22)
			{
				itemtype = 39;
				num11 = 18;
			}
			else if (n.type == 178)
			{
				itemtype = 434;
			}
			else if (n.type == 227)
			{
				itemtype = 3350;
				num11 = 16;
				num10 = 0.85f;
			}
			else if (n.type == 368)
			{
				itemtype = (hardMode ? 2223 : 2269);
				if (hardMode)
				{
					num11 = 18;
				}
				else
				{
					if (n.ai[2] < -0.1f)
					{
						num11 = 28;
					}
					num10 = 0.75f;
				}
			}
			Vector2 vector4 = DrawPlayerItemPos(1f, itemtype);
			GetItemDrawFrame(itemtype, out var itemTexture, out var value2);
			int num12 = (int)vector4.X - num11;
			Vector2 origin2 = new Vector2(-num12, value2.Height / 2);
			if (n.spriteDirection == -1)
			{
				origin2 = new Vector2(value2.Width + num12, value2.Height / 2);
			}
			spriteBatch.Draw(itemTexture, new Vector2((int)(vector3.X - screenPosition.X), (int)(vector3.Y - screenPosition.Y)), value2, npcColor, rotation, origin2, n.scale * num10, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
			if (n.type == 22 && n.frame.Y / (TextureAssets.Npc[n.type].Height() / npcFrameCount[n.type]) >= 21)
			{
				Texture2D value3 = TextureAssets.Extra[52].Value;
				if (n.IsShimmerVariant)
				{
					value3 = TextureAssets.Extra[264].Value;
				}
				Microsoft.Xna.Framework.Rectangle value4 = value3.Frame(1, 5, 0, n.frame.Y / (TextureAssets.Npc[n.type].Height() / npcFrameCount[n.type]) - 21);
				spriteBatch.Draw(value3, new Vector2(n.position.X - screenPosition.X + (float)(n.width / 2) - (float)TextureAssets.Npc[n.type].Width() * n.scale / 2f + halfSize.X * n.scale, n.position.Y - screenPosition.Y + (float)n.height - (float)TextureAssets.Npc[n.type].Height() * n.scale / (float)npcFrameCount[n.type] + 4f + halfSize.Y * n.scale + addHeight + addY + n.gfxOffY), value4, n.GetAlpha(npcColor), n.rotation, halfSize, n.scale, npcSpriteEffect, 0f);
			}
			else if (n.type == 368 && n.frame.Y / (TextureAssets.Npc[n.type].Height() / npcFrameCount[n.type]) >= 21)
			{
				Texture2D value5 = TextureAssets.Extra[53].Value;
				if (n.IsShimmerVariant)
				{
					value5 = TextureAssets.Extra[265].Value;
				}
				Microsoft.Xna.Framework.Rectangle value6 = value5.Frame(1, 5, 0, n.frame.Y / (TextureAssets.Npc[n.type].Height() / npcFrameCount[n.type]) - 21);
				spriteBatch.Draw(value5, new Vector2(n.position.X - screenPosition.X + (float)(n.width / 2) - (float)TextureAssets.Npc[n.type].Width() * n.scale / 2f + halfSize.X * n.scale, n.position.Y - screenPosition.Y + (float)n.height - (float)TextureAssets.Npc[n.type].Height() * n.scale / (float)npcFrameCount[n.type] + 4f + halfSize.Y * n.scale + addHeight + addY + n.gfxOffY), value6, n.GetAlpha(npcColor), n.rotation, halfSize, n.scale, npcSpriteEffect, 0f);
			}
		}
		if (NPCID.Sets.AttackType[n.type] == 2 && (n.ai[0] == 14f || (n.ai[0] == 24f && n.frameCounter < 240.0)) && !beforeDraw)
		{
			Texture2D value7 = TextureAssets.Extra[51].Value;
			Vector2 vector5 = n.Bottom + new Vector2(0f, n.gfxOffY + 4f);
			Microsoft.Xna.Framework.Rectangle rectangle2 = value7.Frame(1, 4, 0, (int)n.frameCounter % 48 / 12);
			Vector2 origin3 = rectangle2.Size() * new Vector2(0.5f, 1f);
			spriteBatch.Draw(value7, new Vector2((int)(vector5.X - screenPosition.X), (int)(vector5.Y - screenPosition.Y)), rectangle2, n.GetMagicAuraColor(), 0f, origin3, n.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
		}
		if (NPCID.Sets.AttackType[n.type] == 3 && n.ai[0] == 15f)
		{
			int num13 = 32;
			float num14 = 0f;
			Vector2 zero = Vector2.Zero;
			short num15 = 4;
			if (n.type == 207)
			{
				num15 = 3349;
				num14 = 0.15f;
				if (beforeDraw)
				{
					return;
				}
				if (n.ai[1] > (float)NPCID.Sets.AttackTime[n.type] * 0.66f)
				{
					zero.Y = 12f;
				}
			}
			else if (n.type == 353)
			{
				num15 = 3352;
				num14 = 0.15f;
				if (!beforeDraw)
				{
					return;
				}
				if (n.ai[1] > (float)NPCID.Sets.AttackTime[n.type] * 0.66f)
				{
					zero.Y = 12f;
				}
			}
			else if (n.type == 441)
			{
				num15 = 3351;
				num13 = 28;
				num14 = 0.1f;
				if (!beforeDraw)
				{
					return;
				}
				if (n.ai[1] > (float)NPCID.Sets.AttackTime[n.type] * 0.66f)
				{
					zero.Y = 12f;
				}
			}
			GetItemDrawFrame(num15, out var itemTexture2, out var rectangle3);
			Tuple<Vector2, float> swingStats = n.GetSwingStats(NPCID.Sets.AttackTime[n.type] * 2, (int)n.ai[1], n.spriteDirection, num13, num13);
			Vector2 vector6 = swingStats.Item1 + (swingStats.Item1 - n.Center) * num14 + zero;
			Vector2 origin4 = rectangle3.Size() * new Vector2((n.spriteDirection != 1) ? 1 : 0, 1f);
			spriteBatch.Draw(itemTexture2, new Vector2((int)(vector6.X - screenPosition.X), (int)(vector6.Y - screenPosition.Y)), rectangle3, n.GetAlpha(npcColor), swingStats.Item2, origin4, n.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
		}
		if (n.type == 550 && n.ai[0] == 18f)
		{
			if (beforeDraw)
			{
				return;
			}
			instance.LoadItem(353);
			Texture2D value8 = TextureAssets.Item[353].Value;
			int num16 = 32;
			float num17 = 0.15f;
			Vector2 zero2 = Vector2.Zero;
			Microsoft.Xna.Framework.Rectangle rectangle4 = value8.Frame(1, 3, 0, 1);
			int num18 = (int)n.ai[2];
			if (num18 >= 0 && num18 < 255)
			{
				Player player = Main.player[num18];
				bool flag = player.HeldItem.type == 353 && player.direction == Math.Sign(n.Center.X - player.Center.X);
				float num19 = player.Hitbox.Distance(n.Center);
				float num20 = n.localAI[3];
				if (num19 < 46f && flag)
				{
					n.localAI[3] = 1f;
					if (n.localAI[3] != num20)
					{
						Vector2 vector7 = n.Center + new Vector2(n.spriteDirection * 30, -6f);
						Vector2 vector8 = new Vector2(10f, 10f);
						for (int i = 0; i < 30; i++)
						{
							Dust obj = Dust.NewDustDirect(vector7 - vector8 / 2f, (int)vector8.X, (int)vector8.Y, 4, 0f, 0f, 50, new Microsoft.Xna.Framework.Color(245, 200, 30, 155), 0.7f);
							obj.noGravity = true;
							obj.velocity *= 1f;
							Dust.NewDustDirect(vector7 - vector8 / 2f, (int)vector8.X, (int)vector8.Y, 4, 0f, 0f, 50, new Microsoft.Xna.Framework.Color(245, 200, 30, 155), 0.6f).velocity *= 2f;
						}
					}
				}
				else if (n.localAI[3] == 1f)
				{
					n.localAI[3] = 2f;
				}
			}
			Tuple<Vector2, float> swingStats2 = n.GetSwingStats(40, 12, n.spriteDirection, num16, num16);
			Vector2 vector9 = swingStats2.Item1 + (swingStats2.Item1 - n.Center) * num17 + zero2;
			Vector2 origin5 = rectangle4.Size() * new Vector2((n.spriteDirection != 1) ? 1 : 0, 1f);
			spriteBatch.Draw(value8, new Vector2((int)(vector9.X - screenPosition.X), (int)(vector9.Y - screenPosition.Y)), rectangle4, n.GetAlpha(npcColor), swingStats2.Item2, origin5, n.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
		}
		if (beforeDraw || n.ai[0] != 23f)
		{
			return;
		}
		int num21 = (int)n.ai[2];
		if (num21 <= 0 || num21 > ItemID.Count)
		{
			return;
		}
		GetItemDrawFrame(num21, out var itemTexture3, out var rectangle5);
		int num22 = 0;
		num22 = (((int)n.frameCounter < 6) ? 1 : 2);
		if (n.ai[1] < 6f)
		{
			num22 = 1;
		}
		if (num22 == 0)
		{
			return;
		}
		Vector2 vector10 = Vector2.Zero;
		if (num22 == 1)
		{
			vector10 = new Vector2(10f, 6f);
		}
		if (num22 == 2)
		{
			vector10 = new Vector2(16f, 0f);
		}
		if ((npcSpriteEffect & SpriteEffects.FlipHorizontally) == 0)
		{
			vector10.X *= -1f;
		}
		if (n.type == 369)
		{
			vector10.X *= 0.5f;
			vector10.Y += 4f;
		}
		if (n.type == 453)
		{
			vector10.Y += 8f;
		}
		if (n.type == 550)
		{
			if (num21 == 353)
			{
				rectangle5 = itemTexture3.Frame(1, 3, 0, 1);
			}
			vector10.Y += 6f;
		}
		Vector2 vector11 = n.Center + vector10;
		Vector2 origin6 = rectangle5.Size() * new Vector2((n.spriteDirection != 1) ? 1 : 0, 1f);
		Vector2 position = new Vector2((int)(vector11.X - screenPosition.X), (int)(vector11.Y - screenPosition.Y));
		Microsoft.Xna.Framework.Color alpha = n.GetAlpha(npcColor);
		spriteBatch.Draw(itemTexture3, position, rectangle5, alpha, 0f, origin6, n.scale, npcSpriteEffect ^ SpriteEffects.FlipHorizontally, 0f);
	}

	private void DrawProj_LightsBane(Projectile proj)
	{
		spriteBatch.End();
		if (_multiplyBlendState == null)
		{
			_ = BlendState.AlphaBlend;
			_ = BlendState.Additive;
			_multiplyBlendState = new BlendState
			{
				ColorBlendFunction = BlendFunction.ReverseSubtract,
				ColorDestinationBlend = Blend.One,
				ColorSourceBlend = Blend.SourceAlpha,
				AlphaBlendFunction = BlendFunction.ReverseSubtract,
				AlphaDestinationBlend = Blend.One,
				AlphaSourceBlend = Blend.SourceAlpha
			};
		}
		BlendState multiplyBlendState = _multiplyBlendState;
		spriteBatch.Begin(SpriteSortMode.Deferred, multiplyBlendState, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		Vector2 position = proj.Center - screenPosition;
		LoadProjectile(proj.type);
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 13, 0, proj.frame);
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = new Vector2(0.7f, 0.7f) * proj.scale;
		float num = Utils.Remap(proj.frame, 0f, 3f, 0f, 1f) * Utils.Remap(proj.frame, 4f, 12f, 1f, 0f);
		Microsoft.Xna.Framework.Rectangle value = asset.Frame(1, 13, 0, 12);
		Vector2 origin = vector + new Vector2(0f, 0f);
		spriteBatch.Draw(asset.Value, position, value, Microsoft.Xna.Framework.Color.White * 0.3f * num, proj.rotation, origin, new Vector2(1f, 6f) * vector2, SpriteEffects.None, 0f);
		spriteBatch.Draw(asset.Value, position, value, Microsoft.Xna.Framework.Color.White * 0.3f * num, proj.rotation, origin, new Vector2(2f, 2f) * vector2, SpriteEffects.None, 0f);
		spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.White, proj.rotation, vector, vector2, SpriteEffects.None, 0f);
		spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.White, proj.rotation, vector, vector2, SpriteEffects.None, 0f);
		spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.White, proj.rotation, vector, vector2, SpriteEffects.None, 0f);
		spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.White, proj.rotation, vector, vector2, SpriteEffects.None, 0f);
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.Additive, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.Magenta, proj.rotation, vector, vector2, SpriteEffects.None, 0f);
		spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.Magenta, proj.rotation, vector, vector2, SpriteEffects.None, 0f);
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
	}

	private void DrawProj_NightsEdge(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = proj.localAI[0] / proj.ai[1];
		float num3 = Utils.Remap(num2, 0f, 0.6f, 0f, 1f) * Utils.Remap(num2, 0.6f, 1f, 1f, 0f);
		float num4 = 0.975f;
		float fromValue = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		fromValue = Utils.Remap(fromValue, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(40, 20, 60);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * fromValue * num3, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * -1f * (1f - num2), origin, num * num4, effects, 0f);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(80, 40, 180);
		Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.White * num3 * 0.5f;
		color3.A = (byte)((float)(int)color3.A * (1f - fromValue));
		Microsoft.Xna.Framework.Color color4 = color3 * fromValue * 0.5f;
		color4.G = (byte)((float)(int)color4.G * fromValue);
		color4.R = (byte)((float)(int)color4.R * (0.25f + fromValue * 0.75f));
		spriteBatch.Draw(asset.Value, vector, rectangle, color4 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, new Microsoft.Xna.Framework.Color(80, 30, 160) * fromValue * num3 * 0.3f, proj.rotation, origin, num * 0.8f, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * fromValue * num3 * 0.7f, proj.rotation, origin, num * num4, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.3f * num3 * (1f - fromValue * 0.7f), proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		Vector2 drawpos = vector + (proj.rotation + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 2f) * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * 0.5f, color2, num2, 0f, 0.5f, 0.5f, 1f, (float)Math.PI / 4f, new Vector2(2f, 2f), Vector2.One);
	}

	private void DrawProj_DeadCellsFlintSlash(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = proj.localAI[0] / proj.ai[1];
		float num3 = Utils.Remap(num2, 0f, 0.6f, 0f, 1f) * Utils.Remap(num2, 0.6f, 1f, 1f, 0f);
		float num4 = 0.975f;
		float fromValue = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		fromValue = Utils.Remap(fromValue, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(227, 177, 140);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(255, 230, 120);
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(255, 255, 255);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * fromValue * num3, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * -1f * (1f - num2), origin, num * num4, effects, 0f);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * num3 * 0.5f;
		color4.A = (byte)((float)(int)color4.A * (1f - fromValue));
		Microsoft.Xna.Framework.Color color5 = color4 * fromValue * 0.5f;
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * fromValue * num3 * 0.3f, proj.rotation, origin, num * 0.8f, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * fromValue * num3 * 0.7f, proj.rotation, origin, num * num4, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.3f * num3 * (1f - fromValue * 0.7f), proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		Vector2 drawpos = vector + (proj.rotation + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 2f) * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * 0.5f, new Microsoft.Xna.Framework.Color(255, 150, 0), num2, 0f, 0.5f, 0.5f, 1f, (float)Math.PI / 4f, new Vector2(2f, 2f), Vector2.One);
	}

	private void DrawProj_Excalibur(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = proj.localAI[0] / proj.ai[1];
		float num3 = Utils.Remap(num2, 0f, 0.6f, 0f, 1f) * Utils.Remap(num2, 0.6f, 1f, 1f, 0f);
		float num4 = 0.975f;
		float fromValue = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		fromValue = Utils.Remap(fromValue, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(180, 160, 60);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * fromValue * num3, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * -1f * (1f - num2), origin, num, effects, 0f);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(255, 240, 150);
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(255, 255, 80);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * num3 * 0.5f;
		color4.A = (byte)((float)(int)color4.A * (1f - fromValue));
		Microsoft.Xna.Framework.Color color5 = color4 * fromValue * 0.5f;
		color5.G = (byte)((float)(int)color5.G * fromValue);
		color5.B = (byte)((float)(int)color5.R * (0.25f + fromValue * 0.75f));
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * fromValue * num3 * 0.3f, proj.rotation, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * fromValue * num3 * 0.5f, proj.rotation, origin, num * num4, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.6f * num3, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.5f * num3, proj.rotation + proj.ai[0] * -0.05f, origin, num * 0.8f, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.4f * num3, proj.rotation + proj.ai[0] * -0.1f, origin, num * 0.6f, effects, 0f);
		for (float num5 = 0f; num5 < 8f; num5 += 1f)
		{
			float num6 = proj.rotation + proj.ai[0] * num5 * ((float)Math.PI * -2f) * 0.025f + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 4f) * proj.ai[0];
			Vector2 drawpos = vector + num6.ToRotationVector2() * ((float)asset.Width() * 0.5f - 6f) * num;
			float num7 = num5 / 9f;
			DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * num7, color3, num2, 0f, 0.5f, 0.5f, 1f, num6, new Vector2(0f, Utils.Remap(num2, 0f, 1f, 3f, 0f)) * num, Vector2.One * num);
		}
		Vector2 drawpos2 = vector + (proj.rotation + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 4f) * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos2, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * 0.5f, color3, num2, 0f, 0.5f, 0.5f, 1f, 0f, new Vector2(2f, Utils.Remap(num2, 0f, 1f, 4f, 1f)) * num, Vector2.One * num);
	}

	private void DrawProj_TheHorsemansBlade(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = proj.localAI[0] / proj.ai[1];
		float num3 = Utils.Remap(num2, 0f, 0.6f, 0f, 1f) * Utils.Remap(num2, 0.6f, 1f, 1f, 0f);
		float num4 = 0.975f;
		float fromValue = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		fromValue = Utils.Remap(fromValue, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(193, 43, 43);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * fromValue * num3, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * -1f * (1f - num2), origin, num, effects, 0f);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(247, 115, 0);
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(255, 202, 130);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * num3 * 0.5f;
		color4.A = (byte)((float)(int)color4.A * (1f - fromValue));
		Microsoft.Xna.Framework.Color color5 = color4 * fromValue * 0.5f;
		color5.G = (byte)((float)(int)color5.G * fromValue);
		color5.B = (byte)((float)(int)color5.R * (0.25f + fromValue * 0.75f));
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * fromValue * num3 * 0.3f, proj.rotation, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * fromValue * num3 * 0.5f, proj.rotation, origin, num * num4, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.6f * num3, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.5f * num3, proj.rotation + proj.ai[0] * -0.05f, origin, num * 0.8f, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.4f * num3, proj.rotation + proj.ai[0] * -0.1f, origin, num * 0.6f, effects, 0f);
		for (float num5 = 0f; num5 < 8f; num5 += 1f)
		{
			float num6 = proj.rotation + proj.ai[0] * num5 * ((float)Math.PI * -2f) * 0.025f + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 4f) * proj.ai[0];
			Vector2 drawpos = vector + num6.ToRotationVector2() * ((float)asset.Width() * 0.5f - 6f) * num;
			float num7 = num5 / 9f;
			DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * num7, color3, num2, 0f, 0.5f, 0.5f, 1f, num6, new Vector2(0f, Utils.Remap(num2, 0f, 1f, 3f, 0f)) * num, Vector2.One * num);
		}
		Vector2 drawpos2 = vector + (proj.rotation + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 4f) * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos2, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * 0.5f, color3, num2, 0f, 0.5f, 0.5f, 1f, (float)Math.PI / 4f, new Vector2(Utils.Remap(num2, 0f, 1f, 4f, 1f)) * num, Vector2.One * num);
	}

	private void DrawProj_TrueExcalibur(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = proj.localAI[0] / proj.ai[1];
		float num3 = Utils.Remap(num2, 0f, 0.6f, 0f, 1f) * Utils.Remap(num2, 0.6f, 1f, 1f, 0f);
		float num4 = 0.975f;
		float amount = num3;
		float fromValue = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		fromValue = Utils.Remap(fromValue, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(180, 50, 90), new Microsoft.Xna.Framework.Color(180, 30, 60), amount);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * fromValue * num3, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * -1f * (1f - num2), origin, num, effects, 0f);
		Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(255, 240, 150), new Microsoft.Xna.Framework.Color(255, 60, 170), amount);
		Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(255, 255, 80), new Microsoft.Xna.Framework.Color(255, 60, 190), amount);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * num3 * 0.5f;
		color4.A = (byte)((float)(int)color4.A * (1f - fromValue));
		Microsoft.Xna.Framework.Color color5 = color4 * fromValue * 0.5f;
		color5.G = (byte)((float)(int)color5.G * fromValue);
		color5.B = (byte)((float)(int)color5.R * (0.25f + fromValue * 0.75f));
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * fromValue * num3 * 0.3f, proj.rotation, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * fromValue * num3 * 0.5f, proj.rotation, origin, num * num4, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.6f * num3, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.5f * num3, proj.rotation + proj.ai[0] * -0.05f, origin, num * 0.8f, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.4f * num3, proj.rotation + proj.ai[0] * -0.1f, origin, num * 0.6f, effects, 0f);
		float num5 = num * 0.75f;
		for (float num6 = 0f; num6 < 12f; num6 += 1f)
		{
			float num7 = proj.rotation + proj.ai[0] * num6 * ((float)Math.PI * -2f) * 0.025f + Utils.Remap(num2, 0f, 0.6f, 0f, 0.95504415f) * proj.ai[0];
			Vector2 drawpos = vector + num7.ToRotationVector2() * ((float)asset.Width() * 0.5f - 6f) * num;
			float num8 = num6 / 12f;
			DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * num8, color3, num2, 0f, 0.5f, 0.5f, 1f, num7, new Vector2(0f, Utils.Remap(num2, 0f, 1f, 3f, 0f)) * num5, Vector2.One * num5);
		}
		Vector2 drawpos2 = vector + (proj.rotation + Utils.Remap(num2, 0f, 0.6f, 0f, 0.95504415f) * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos2, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * 0.5f, color3, num2, 0f, 0.5f, 0.5f, 1f, 0f, new Vector2(2f, Utils.Remap(num2, 0f, 1f, 4f, 1f)) * num5, Vector2.One * num5);
	}

	private void DrawProj_TrueNightsEdge(Projectile proj)
	{
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = 0.975f;
		float fromValue = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		fromValue = Utils.Remap(fromValue, 0.2f, 1f, 0f, 1f);
		float num3 = MathHelper.Min(0.15f + fromValue * 0.85f, Utils.Remap(proj.localAI[0], 30f, 96f, 1f, 0f));
		_ = proj.Size / 2f;
		float num4 = 2f;
		for (float num5 = num4; num5 >= 0f; num5 -= 1f)
		{
			if (!(proj.oldPos[(int)num5] == Vector2.Zero))
			{
				Vector2 vector = proj.Center - proj.velocity * 0.5f * num5;
				float num6 = proj.oldRot[(int)num5] + proj.ai[0] * ((float)Math.PI * 2f) * 0.1f * (0f - num5);
				Vector2 position = vector - screenPosition;
				float num7 = 1f - num5 / num4;
				float num8 = proj.Opacity * num7 * num7 * 0.85f;
				float amount = proj.Opacity * proj.Opacity;
				Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(40, 20, 60, 120), new Microsoft.Xna.Framework.Color(80, 160, 50, 120), amount);
				spriteBatch.Draw(asset.Value, position, rectangle, color * num3 * num8, num6 + proj.ai[0] * ((float)Math.PI / 4f) * -1f, origin, num * num2, effects, 0f);
				Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(80, 40, 180), new Microsoft.Xna.Framework.Color(155, 255, 100), amount);
				Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.White * num8 * 0.5f;
				color3.A = (byte)((float)(int)color3.A * (1f - num3));
				Microsoft.Xna.Framework.Color color4 = color3 * num3 * 0.5f;
				color4.G = (byte)((float)(int)color4.G * num3);
				color4.R = (byte)((float)(int)color4.R * (0.25f + num3 * 0.75f));
				float num9 = 3f;
				for (float num10 = (float)Math.PI * -2f + (float)Math.PI * 2f / num9; num10 < 0f; num10 += (float)Math.PI * 2f / num9)
				{
					float num11 = Utils.Remap(num10, (float)Math.PI * -2f, 0f, 0f, 0.5f);
					spriteBatch.Draw(asset.Value, position, rectangle, color4 * 0.15f * num11, num6 + proj.ai[0] * 0.01f + num10, origin, num, effects, 0f);
					spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(80, 30, 160), new Microsoft.Xna.Framework.Color(200, 255, 0), amount) * fromValue * num8 * num11, num6 + num10, origin, num * 0.8f, effects, 0f);
					spriteBatch.Draw(asset.Value, position, rectangle, color2 * fromValue * num8 * MathHelper.Lerp(0.05f, 0.4f, fromValue) * num11, num6 + num10, origin, num * num2, effects, 0f);
					spriteBatch.Draw(asset.Value, position, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * MathHelper.Lerp(0.05f, 0.5f, fromValue) * num8 * num11, num6 + num10, origin, num, effects, 0f);
				}
				spriteBatch.Draw(asset.Value, position, rectangle, color4 * 0.15f, num6 + proj.ai[0] * 0.01f, origin, num, effects, 0f);
				spriteBatch.Draw(asset.Value, position, rectangle, Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(80, 30, 160), new Microsoft.Xna.Framework.Color(200, 255, 0), amount) * num3 * num8, num6, origin, num * 0.8f, effects, 0f);
				spriteBatch.Draw(asset.Value, position, rectangle, color2 * fromValue * num8 * MathHelper.Lerp(0.05f, 0.4f, num3), num6, origin, num * num2, effects, 0f);
				spriteBatch.Draw(asset.Value, position, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * MathHelper.Lerp(0.05f, 0.5f, num3) * num8, num6, origin, num, effects, 0f);
			}
		}
		float num12 = 1f - proj.localAI[0] * 1f / 80f;
		if (num12 < 0.5f)
		{
			num12 = 0.5f;
		}
		Vector2 drawpos = proj.Center - screenPosition + (proj.rotation + 0.47123894f * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num * num12;
		float num13 = MathHelper.Min(num3, MathHelper.Lerp(1f, fromValue, Utils.Remap(proj.localAI[0], 0f, 80f, 0f, 1f)));
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * proj.Opacity * 0.5f * num13, new Microsoft.Xna.Framework.Color(150, 255, 100) * num13, proj.Opacity, 0f, 1f, 1f, 2f, (float)Math.PI / 4f, new Vector2(2f, 2f), Vector2.One);
	}

	private void DrawProj_TerraBlade2(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float num = proj.scale * 1.1f;
		SpriteEffects effects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		float num2 = proj.localAI[0] / proj.ai[1];
		float num3 = Utils.Remap(num2, 0f, 0.6f, 0f, 1f) * Utils.Remap(num2, 0.6f, 1f, 1f, 0f);
		float num4 = 0.975f;
		float num5 = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		num5 = 0.5f + num5 * 0.5f;
		num5 = Utils.Remap(num5, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(45, 124, 205);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * num5 * num3, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * -1f * (1f - num2), origin, num * 0.95f, effects, 0f);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(181, 230, 29);
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(34, 177, 76);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * num3 * 0.5f;
		color4.A = (byte)((float)(int)color4.A * (1f - num5));
		Microsoft.Xna.Framework.Color color5 = color4 * num5 * 0.5f;
		color5.G = (byte)((float)(int)color5.G * num5);
		color5.B = (byte)((float)(int)color5.R * (0.25f + num5 * 0.75f));
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * num5 * num3 * 0.3f, proj.rotation, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * num5 * num3 * 0.5f, proj.rotation, origin, num * num4, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.6f * num3, proj.rotation + proj.ai[0] * 0.01f, origin, num, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.5f * num3, proj.rotation + proj.ai[0] * -0.05f, origin, num * 0.8f, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.4f * num3, proj.rotation + proj.ai[0] * -0.1f, origin, num * 0.6f, effects, 0f);
		for (float num6 = 0f; num6 < 12f; num6 += 1f)
		{
			float num7 = proj.rotation + proj.ai[0] * (num6 - 2f) * ((float)Math.PI * -2f) * 0.025f + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 4f) * proj.ai[0];
			Vector2 drawpos = vector + num7.ToRotationVector2() * ((float)asset.Width() * 0.5f - 6f) * num;
			float num8 = num6 / 12f;
			DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * num8, color3, num2, 0f, 0.5f, 0.5f, 1f, num7, new Vector2(0f, Utils.Remap(num2, 0f, 1f, 3f, 0f)) * num, Vector2.One * num);
		}
		Vector2 drawpos2 = vector + (proj.rotation + Utils.Remap(num2, 0f, 1f, 0f, (float)Math.PI / 4f) * proj.ai[0]).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * num;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos2, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num3 * 0.5f, color3, num2, 0f, 0.5f, 0.5f, 1f, 0f, new Vector2(2f, Utils.Remap(num2, 0f, 1f, 4f, 1f)) * num, Vector2.One * num * 1.5f);
	}

	private void DrawProj_TerraBlade2Shot(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle rectangle = asset.Frame(1, 4);
		Vector2 origin = rectangle.Size() / 2f;
		float scale = proj.scale;
		SpriteEffects spriteEffects = ((!(proj.ai[0] >= 0f)) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		SpriteEffects effects = spriteEffects ^ SpriteEffects.FlipVertically;
		float num = Utils.Remap(proj.localAI[0], 0f, proj.ai[1] + 30f, 0f, 1f);
		float opacity = proj.Opacity;
		float num2 = 0.975f;
		float num3 = Lighting.GetColor(proj.Center.ToTileCoordinates()).ToVector3().Length() / (float)Math.Sqrt(3.0);
		num3 = 0.5f + num3 * 0.5f;
		num3 = Utils.Remap(num3, 0.2f, 1f, 0f, 1f);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(45, 124, 205);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * num3 * opacity, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * 0.5f * -1f * (1f - num), origin, scale * 0.95f, spriteEffects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color * num3 * opacity, proj.rotation + proj.ai[0] * ((float)Math.PI / 4f) * 0.5f * 1f * (1f - num), origin, scale * 0.95f, effects, 0f);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(181, 230, 29);
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(34, 177, 76);
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * opacity * 0.5f;
		color4.A = (byte)((float)(int)color4.A * (1f - num3));
		Microsoft.Xna.Framework.Color color5 = color4 * num3 * 0.5f;
		color5.G = (byte)((float)(int)color5.G * num3);
		color5.B = (byte)((float)(int)color5.R * (0.25f + num3 * 0.75f));
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * 0.01f, origin, scale, spriteEffects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color5 * 0.15f, proj.rotation + proj.ai[0] * -0.01f, origin, scale, effects, 0f);
		float num4 = 1f - num;
		float num5 = 0.25f;
		float num6 = 0.15f;
		float num7 = 0.05f;
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * num3 * opacity * 0.3f, proj.rotation + proj.ai[0] * num5 * num4, origin, scale, spriteEffects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color3 * num3 * opacity * 0.3f, proj.rotation + (0f - proj.ai[0]) * num5 * num4, origin, scale, effects, 0f);
		spriteBatch.Draw(asset.Value, vector, rectangle, color2 * num3 * opacity * 0.5f, proj.rotation + proj.ai[0] * num6 * num4, origin, scale * num2, spriteEffects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.6f * opacity, proj.rotation + proj.ai[0] * num7 * num4, origin, scale, spriteEffects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.5f * opacity, proj.rotation + proj.ai[0] * -0.05f, origin, scale * 0.8f, spriteEffects, 0f);
		spriteBatch.Draw(asset.Value, vector, asset.Frame(1, 4, 0, 3), Microsoft.Xna.Framework.Color.White * 0.4f * opacity, proj.rotation + proj.ai[0] * -0.1f, origin, scale * 0.6f, spriteEffects, 0f);
		for (float num8 = -9f; num8 < 9f; num8 += 1f)
		{
			float num9 = proj.rotation + proj.ai[0] * num8 * ((float)Math.PI * -2f) * 0.025f;
			Vector2 drawpos = vector + num9.ToRotationVector2() * ((float)asset.Width() * 0.5f - 6f) * scale;
			float num10 = Math.Abs(num8) / 9f;
			DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * opacity * num10, color3, num, 0f, 0.5f, 0.5f, 1f, num9, new Vector2(0f, Utils.Remap(num, 0f, 1f, 3f, 0f)) * scale, Vector2.One * scale);
		}
		for (float num11 = -1f; num11 <= 1f; num11 += 0.5f)
		{
			if (num11 != 0f)
			{
				Vector2 drawpos2 = vector + (proj.rotation + num11 * (float)Math.PI * 0.75f * num).ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * scale;
				float num12 = Utils.Remap(Math.Abs(num11), 0f, 1f, 1f, 0.5f);
				DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos2, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * opacity * 0.5f, color3, num, 0f, 0.5f, 0.5f, 0.75f, (float)Math.PI / 4f, new Vector2(Utils.Remap(num, 0f, 1f, 4f, 1f)) * scale * num12, Vector2.One * scale * num12);
				DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos2, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * opacity * 0.5f, color3, num, 0f, 0.5f, 0.5f, 0.75f, 0f, new Vector2(2f, Utils.Remap(num, 0f, 1f, 4f, 1f)) * scale * num12, Vector2.One * scale * num12);
			}
		}
		Vector2 drawpos3 = vector + proj.rotation.ToRotationVector2() * ((float)asset.Width() * 0.5f - 4f) * scale;
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos3, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * opacity * 0.5f, color3, num, 0f, 0.5f, 0.5f, 1f, (float)Math.PI / 4f, new Vector2(Utils.Remap(num, 0f, 1f, 4f, 1f)) * scale, Vector2.One * scale * 1.5f);
		DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, drawpos3, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * opacity * 0.5f, color3, num, 0f, 0.5f, 0.5f, 1f, 0f, new Vector2(2f, Utils.Remap(num, 0f, 1f, 4f, 1f)) * scale, Vector2.One * scale * 1.5f);
	}

	public void DrawProj(int i)
	{
		int num = ProjectileID.Sets.DrawScreenCheckFluff[projectile[i].type];
		if (new Microsoft.Xna.Framework.Rectangle((int)Camera.ScaledPosition.X - num, (int)Camera.ScaledPosition.Y - num, (int)Camera.ScaledSize.X + num * 2, (int)Camera.ScaledSize.Y + num * 2).Intersects(projectile[i].Hitbox))
		{
			Projectile proj = projectile[i];
			DrawProjDirect(proj);
		}
	}

	private void DrawContinuousTrail(Projectile proj)
	{
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 255, 255, 255);
		bool flag = player[proj.owner].cPet == 0;
		DrawTrail(proj, new Vector2(10f, 2f), flag ? new Microsoft.Xna.Framework.Color(177, 255, 32, 127) : color);
		DrawTrail(proj, new Vector2(-10f, 2f), flag ? new Microsoft.Xna.Framework.Color(177, 255, 32, 127) : color);
	}

	private static void DrawTrail(Projectile proj, Vector2 rotatableOffsetFromCenter, Microsoft.Xna.Framework.Color baseColor)
	{
		Vector2 vector = proj.Size / 2f;
		Texture2D value = TextureAssets.MagicPixel.Value;
		Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1);
		Vector2[] oldPos = proj.oldPos;
		float[] oldRot = proj.oldRot;
		int num = oldPos.Length;
		for (int num2 = num - 1; num2 > 0; num2--)
		{
			if (!(oldPos[num2] == Vector2.Zero))
			{
				Vector2 vector2 = oldPos[num2] + vector + rotatableOffsetFromCenter.RotatedBy(oldRot[num2]);
				Vector2 v = oldPos[num2 - 1] + vector + rotatableOffsetFromCenter.RotatedBy(oldRot[num2 - 1]) - vector2;
				float y = v.Length();
				float num3 = v.ToRotation();
				float num4 = Utils.Remap(num2, 0f, num, 1f, 0f);
				EntitySpriteDraw(value, vector2 - screenPosition, value2, baseColor * num4, num3 + (float)Math.PI / 2f, new Vector2((float)value2.Width / 2f, value2.Height), new Vector2(4f, y), SpriteEffects.None);
			}
		}
	}

	public void DrawProjDirect(Projectile proj, Player overridePlayer = null)
	{
		PrepareDrawnProjectileDrawing(proj);
		Player player = Main.player[proj.owner];
		if (overridePlayer != null)
		{
			player = overridePlayer;
		}
		if (proj.type == 734)
		{
			VoidLensHelper voidLensHelper = new VoidLensHelper(proj);
			_voidLensData.Clear();
			int selectionMode = TryInteractingWithVoidLens(proj);
			voidLensHelper.DrawToDrawData(_voidLensData, selectionMode);
			{
				foreach (DrawData voidLensDatum in _voidLensData)
				{
					EntitySpriteDraw(voidLensDatum);
				}
				return;
			}
		}
		float polePosX = 0f;
		float polePosY = 0f;
		LoadProjectile(proj.type);
		Vector2 mountedCenter = player.MountedCenter;
		if (player.mount.Active && player.mount.Type == 52)
		{
			mountedCenter += new Vector2(player.direction * 14, -10f);
		}
		if (proj.aiStyle == 99 && proj.ai[0] != -2f)
		{
			Vector2 pos = mountedCenter;
			pos.Y += player.gfxOffY;
			player.ApplyItemPositionOffsetFromMount(ref pos);
			float num = proj.Center.X - pos.X;
			float num2 = proj.Center.Y - pos.Y;
			Math.Sqrt(num * num + num2 * num2);
			float num3 = (float)Math.Atan2(num2, num) - 1.57f;
			bool flag = true;
			bool flag2 = true;
			if (num == 0f && num2 == 0f)
			{
				flag = false;
			}
			else
			{
				float num4 = (float)Math.Sqrt(num * num + num2 * num2);
				num4 = 12f / num4;
				num *= num4;
				num2 *= num4;
				pos.X -= num * 0.1f;
				pos.Y -= num2 * 0.1f;
				num = proj.position.X + (float)proj.width * 0.5f - pos.X;
				num2 = proj.position.Y + (float)proj.height * 0.5f - pos.Y;
			}
			while (flag)
			{
				float num5 = 12f;
				float num6 = (float)Math.Sqrt(num * num + num2 * num2);
				float num7 = num6;
				if (float.IsNaN(num6) || float.IsNaN(num7))
				{
					flag = false;
					continue;
				}
				if (num6 < 20f)
				{
					num5 = num6 - 8f;
					flag = false;
				}
				num6 = 12f / num6;
				num *= num6;
				num2 *= num6;
				if (flag2)
				{
					flag2 = false;
				}
				else
				{
					pos.X += num;
					pos.Y += num2;
				}
				num = proj.position.X + (float)proj.width * 0.5f - pos.X;
				num2 = proj.position.Y + (float)proj.height * 0.1f - pos.Y;
				if (num7 > 12f)
				{
					float num8 = 0.3f;
					float num9 = Math.Abs(proj.velocity.X) + Math.Abs(proj.velocity.Y);
					if (num9 > 16f)
					{
						num9 = 16f;
					}
					num9 = 1f - num9 / 16f;
					num8 *= num9;
					num9 = num7 / 80f;
					if (num9 > 1f)
					{
						num9 = 1f;
					}
					num8 *= num9;
					if (num8 < 0f)
					{
						num8 = 0f;
					}
					num8 *= num9;
					num8 *= 0.5f;
					if (num2 > 0f)
					{
						num2 *= 1f + num8;
						num *= 1f - num8;
					}
					else
					{
						num9 = Math.Abs(proj.velocity.X) / 3f;
						if (num9 > 1f)
						{
							num9 = 1f;
						}
						num9 -= 0.5f;
						num8 *= num9;
						if (num8 > 0f)
						{
							num8 *= 2f;
						}
						num2 *= 1f + num8;
						num *= 1f - num8;
					}
				}
				num3 = (float)Math.Atan2(num2, num) - 1.57f;
				Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
				white.A = (byte)((float)(int)white.A * 0.4f);
				white = TryApplyingPlayerStringColor(player.stringColor, white);
				float num10 = 0.5f;
				if (player.stringColor != 29)
				{
					white = Lighting.GetColor((int)pos.X / 16, (int)(pos.Y / 16f), white);
				}
				EntitySpriteDraw(color: new Microsoft.Xna.Framework.Color((byte)((float)(int)white.R * num10), (byte)((float)(int)white.G * num10), (byte)((float)(int)white.B * num10), (byte)((float)(int)white.A * num10)), texture: TextureAssets.FishingLine.Value, position: new Vector2(pos.X - screenPosition.X + (float)TextureAssets.FishingLine.Width() * 0.5f, pos.Y - screenPosition.Y + (float)TextureAssets.FishingLine.Height() * 0.5f) - new Vector2(6f, 0f), sourceRectangle: new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.FishingLine.Width(), (int)num5), rotation: num3, origin: new Vector2((float)TextureAssets.FishingLine.Width() * 0.5f, 0f), scale: 1f, effects: SpriteEffects.None);
			}
			if (proj.ai[0] == -3f)
			{
				return;
			}
		}
		else
		{
			if (proj.aiStyle == 160)
			{
				DrawKite(proj, GetPlayerArmPosition(proj, player) + Main.player[proj.owner].netOffset);
				return;
			}
			if (proj.aiStyle == 165)
			{
				DrawWhip(proj, player);
				return;
			}
		}
		if (proj.aiStyle == 174)
		{
			DrawMultisegmentPet(proj);
			return;
		}
		if (proj.type == 1020)
		{
			DrawContinuousTrail(proj);
		}
		else if (proj.type == 1091)
		{
			Vector2 position = proj.Center - screenPosition;
			Texture2D value = TextureAssets.Projectile[proj.type].Value;
			Vector2 origin = value.Frame().Size() / 2f;
			int num11 = 240;
			if (num11 == 0)
			{
				num11 = 1;
			}
			float num12 = Utils.Remap(proj.ai[1], 0f, num11, 0f, 1f);
			float num13 = Utils.Remap(num12, 0f, 0.25f, 0f, 1f);
			float num14 = (float)Math.Sin(num13 * ((float)Math.PI / 2f)) * 0.6f;
			Microsoft.Xna.Framework.Color color = proj.AI_203_GetLightningColor();
			Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(color.R, color.G, color.B, 0) * num14;
			Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num14;
			float num15 = Utils.Remap(num13, 0f, 0.7f, 0f, 1f);
			num15 *= num15;
			num15 *= Utils.Remap(num12, 0.7f, 1f, 0.7f, 1f);
			num15 *= Utils.Remap(num12, 0.6f, 0.8f, 1f, 0.7f);
			num15 *= Utils.Remap(num12, 0.8f, 1f, 1f, 2f);
			num15 *= 0.75f;
			float num16 = (1f - num12 * num12 * 20f) * Utils.Remap(num12, 0f, 0.035f, 0f, 1f);
			if (num16 > 0f)
			{
				float num17 = 1.3f;
				spriteBatch.Draw(value, position, null, Microsoft.Xna.Framework.Color.Black * num16, proj.rotation, origin, num17, SpriteEffects.None, 0f);
				spriteBatch.Draw(value, position, null, Microsoft.Xna.Framework.Color.Black * num16, proj.rotation + (float)Math.PI / 2f, origin, num17 * 0.7f, SpriteEffects.None, 0f);
				float num18 = num17 * 0.65f;
				spriteBatch.Draw(value, position, null, color * num16 * 0.6f, proj.rotation, origin, num18, SpriteEffects.None, 0f);
				spriteBatch.Draw(value, position, null, color * num16 * 0.6f, proj.rotation + (float)Math.PI / 2f, origin, num18 * 0.7f, SpriteEffects.None, 0f);
			}
			spriteBatch.Draw(value, position, null, color2, proj.rotation, origin, num15 + (float)Math.Sin((float)Math.PI * 2f * num12 * 8f) * 0.09f, SpriteEffects.None, 0f);
			spriteBatch.Draw(value, position, null, color3, proj.rotation, origin, num15 * 0.7f + (float)Math.Sin((float)Math.PI * 2f * num12 * 24f) * 0.09f, SpriteEffects.None, 0f);
			return;
		}
		if (proj.type == 1024)
		{
			DrawTrail(proj, Vector2.Zero, new Microsoft.Xna.Framework.Color(140, 234, 180));
		}
		if (proj.type == 1026)
		{
			DrawTrail(proj, Vector2.Zero, new Microsoft.Xna.Framework.Color(140, 234, 180));
		}
		bool flag3 = true;
		switch (proj.type)
		{
		default:
			flag3 = false;
			break;
		case 932:
			DrawProj_FairyQueenRangedItemShot(proj);
			break;
		case 919:
			DrawProj_FairyQueenLance(proj);
			break;
		case 974:
			DrawProj_LightsBane(proj);
			break;
		case 972:
			DrawProj_NightsEdge(proj);
			break;
		case 973:
			DrawProj_TrueNightsEdge(proj);
			break;
		case 982:
			DrawProj_Excalibur(proj);
			break;
		case 997:
			DrawProj_TheHorsemansBlade(proj);
			break;
		case 984:
			DrawProj_TerraBlade2(proj);
			break;
		case 985:
			DrawProj_TerraBlade2Shot(proj);
			break;
		case 983:
			DrawProj_TrueExcalibur(proj);
			break;
		case 995:
			_stardewAnimation.Draw(spriteBatch, (int)proj.ai[0], proj.Center - screenPosition);
			flag3 = false;
			break;
		case 1043:
			DrawProj_DeadCellsFlintSlash(proj);
			break;
		}
		if (flag3)
		{
			return;
		}
		if (proj.type == 34)
		{
			default(FlameLashDrawer).Draw(proj);
		}
		if (proj.type == 16)
		{
			default(MagicMissileDrawer).Draw(proj);
		}
		if (proj.type == 106)
		{
			default(LightDiscDrawer).Draw(proj);
		}
		if (proj.type == 933 || proj.type == 1100)
		{
			default(FinalFractalHelper).Draw(proj);
		}
		if (proj.type == 79)
		{
			default(RainbowRodDrawer).Draw(proj);
		}
		if (proj.type == 946)
		{
			EmpressBladeDrawer empressBladeDrawer = default(EmpressBladeDrawer);
			float num19 = GlobalTimeWrappedHourly % 3f / 3f;
			Player player2 = player;
			float num20 = MathHelper.Max(1f, player2.maxMinions);
			float num21 = (float)proj.identity % num20 / num20 + num19;
			Microsoft.Xna.Framework.Color fairyQueenWeaponsColor = proj.GetFairyQueenWeaponsColor(0f, 0f, num21 % 1f);
			Microsoft.Xna.Framework.Color fairyQueenWeaponsColor2 = proj.GetFairyQueenWeaponsColor(0f, 0f, (num21 + 0.5f) % 1f);
			empressBladeDrawer.ColorStart = fairyQueenWeaponsColor;
			empressBladeDrawer.ColorEnd = fairyQueenWeaponsColor2;
			empressBladeDrawer.Draw(proj);
			DrawProj_EmpressBlade(proj, num21);
			return;
		}
		if (proj.type == 927)
		{
			DrawProj_PiercingStarlight(proj);
			return;
		}
		if (proj.type == 917)
		{
			DrawProj_CoolWhipMinion(proj);
			return;
		}
		if (proj.type == 923)
		{
			Vector2 position2 = proj.Center - screenPosition;
			Texture2D value2 = TextureAssets.Projectile[proj.type].Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value2.Frame(1, 2);
			Microsoft.Xna.Framework.Rectangle value3 = value2.Frame(1, 2, 0, 1);
			Vector2 origin2 = rectangle.Size() * new Vector2(0.03f, 0.5f);
			float num22 = 180f;
			float num23 = proj.ai[0] / ((float)Math.PI * 2f) + proj.localAI[0] / num22;
			float num24 = Utils.GetLerpValue(0f, 30f, proj.localAI[0], clamped: true) * Utils.GetLerpValue(num22, num22 - 30f, proj.localAI[0], clamped: true);
			Microsoft.Xna.Framework.Color color4 = hslToRgb(num23 % 1f, 1f, 1f) * num24;
			float lerpValue = Utils.GetLerpValue(40f, 60f, proj.localAI[0], clamped: true);
			Vector2 vector = new Vector2(1f, MathHelper.Lerp(0.25f, 0.7f, lerpValue)) * proj.scale;
			Microsoft.Xna.Framework.Color value4 = hslToRgb((num23 + 0.3f) % 1f, 1f, MathHelper.Lerp(0.3f, 0.66f, lerpValue)) * num24;
			if (NPC.ShouldEmpressBeEnraged())
			{
				value4 = OurFavoriteColor * num24;
			}
			value4 = Microsoft.Xna.Framework.Color.Lerp(value4, Microsoft.Xna.Framework.Color.White, 0.1f);
			value4.A /= 2;
			spriteBatch.Draw(value2, position2, value3, value4, proj.rotation, origin2, vector * 1.2f, SpriteEffects.None, 0f);
			Microsoft.Xna.Framework.Color value5 = hslToRgb((num23 + 0.15f) % 1f, 1f, MathHelper.Lerp(0.3f, 0.5f, lerpValue)) * num24;
			if (NPC.ShouldEmpressBeEnraged())
			{
				value5 = OurFavoriteColor * num24;
			}
			value5 = Microsoft.Xna.Framework.Color.Lerp(value5, Microsoft.Xna.Framework.Color.White, 0.1f);
			value5.A /= 2;
			spriteBatch.Draw(value2, position2, value3, value5, proj.rotation, origin2, vector * 1.1f, SpriteEffects.None, 0f);
			spriteBatch.Draw(value2, position2, rectangle, color4 * 0.5f, proj.rotation, origin2, vector, SpriteEffects.None, 0f);
			spriteBatch.Draw(value2, position2, value3, color4 * lerpValue, proj.rotation, origin2, vector, SpriteEffects.None, 0f);
			return;
		}
		if (proj.type == 950)
		{
			Vector2 position3 = proj.Center - screenPosition;
			Texture2D value6 = TextureAssets.Projectile[proj.type].Value;
			Microsoft.Xna.Framework.Rectangle rectangle2 = value6.Frame();
			Vector2 origin3 = rectangle2.Size() * new Vector2(0.5f, 0.5f);
			Microsoft.Xna.Framework.Color color5 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * proj.Opacity;
			float hue = ((proj.ai[2] == 1f) ? 0.96f : 0.92f);
			if (proj.ai[2] == 1f)
			{
				color5 = new Microsoft.Xna.Framework.Color(255, 0, 30, 180) * proj.Opacity;
			}
			Microsoft.Xna.Framework.Color color6 = hslToRgb(hue, 1f, 0.5f) * proj.Opacity;
			color6.A = 0;
			color5 *= 0.6f;
			color6 *= 0.6f;
			float scale = proj.scale;
			float num25 = proj.localAI[0];
			spriteBatch.Draw(value6, position3, rectangle2, color5, proj.rotation, origin3, num25, SpriteEffects.None, 0f);
			spriteBatch.Draw(value6, position3, rectangle2, color6, proj.rotation, origin3, num25 * 0.95f, SpriteEffects.None, 0f);
			spriteBatch.Draw(value6, position3, rectangle2, color5, proj.rotation, origin3, scale, SpriteEffects.None, 0f);
			spriteBatch.Draw(value6, position3, rectangle2, color6, proj.rotation, origin3, scale * 0.95f, SpriteEffects.None, 0f);
			return;
		}
		if (proj.type == 888)
		{
			DrawTwinsPet(proj);
			return;
		}
		if (proj.type == 874)
		{
			DrawMurderAurora(proj);
			return;
		}
		if (proj.type == 871)
		{
			Texture2D value7 = TextureAssets.Projectile[proj.type].Value;
			Microsoft.Xna.Framework.Rectangle rectangle3 = value7.Frame(1, 4);
			Vector2 origin4 = rectangle3.Size() / 2f;
			Microsoft.Xna.Framework.Color color7 = Microsoft.Xna.Framework.Color.White * proj.Opacity;
			SpriteEffects effects = SpriteEffects.None;
			color7.A /= 2;
			Microsoft.Xna.Framework.Color color8 = proj.AI_171_GetColor();
			color8.A /= 2;
			float num26 = proj.scale * 1.3f;
			float num27 = 1f;
			int num28 = proj.AI_172_GetPelletStormsCount();
			bool flag4 = false;
			float num29 = float.PositiveInfinity;
			for (int i = 0; i < num28; i++)
			{
				Projectile.HallowBossPelletStormInfo hallowBossPelletStormInfo = proj.AI_172_GetPelletStormInfo(i);
				for (int j = 0; j < hallowBossPelletStormInfo.BulletsInStorm; j++)
				{
					float bulletProgress = hallowBossPelletStormInfo.GetBulletProgress(j);
					if (bulletProgress < num29)
					{
						num29 = bulletProgress;
					}
					if (hallowBossPelletStormInfo.IsValid(j))
					{
						if (i == num28 - 1 && bulletProgress > 0f)
						{
							flag4 = true;
						}
						rectangle3 = value7.Frame(1, 4, 0, (int)((double)(j + i * 6) + timeForVisualEffects / 4.0) % 4);
						float num30 = Utils.GetLerpValue(0f, 0.1f, bulletProgress, clamped: true) * Utils.GetLerpValue(1f, 0.8f, bulletProgress, clamped: true);
						Vector2 bulletPosition = hallowBossPelletStormInfo.GetBulletPosition(j, proj.Center);
						EntitySpriteDraw(value7, bulletPosition - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle3, color8 * num30, proj.rotation, origin4, num26 * num27, effects);
						EntitySpriteDraw(value7, bulletPosition - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle3, color7 * num30, proj.rotation, origin4, proj.scale * num27, effects);
					}
				}
			}
			if (!flag4 && num29 <= 1f)
			{
				EntitySpriteDraw(value7, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle3, color8, proj.rotation, origin4, num26, effects);
				EntitySpriteDraw(value7, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle3, color7, proj.rotation, origin4, proj.scale, effects);
			}
			return;
		}
		if (proj.bobber && player.inventory[player.selectedItem].holdStyle != 0)
		{
			DrawProj_FishingLine(proj, player, ref polePosX, ref polePosY, mountedCenter);
		}
		else if (proj.type == 32)
		{
			Vector2 vector2 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num31 = mountedCenter.X - vector2.X;
			float num32 = mountedCenter.Y - vector2.Y;
			float rotation = (float)Math.Atan2(num32, num31) - 1.57f;
			bool flag5 = true;
			if (num31 == 0f && num32 == 0f)
			{
				flag5 = false;
			}
			else
			{
				float num33 = (float)Math.Sqrt(num31 * num31 + num32 * num32);
				num33 = 8f / num33;
				num31 *= num33;
				num32 *= num33;
				vector2.X -= num31;
				vector2.Y -= num32;
				num31 = mountedCenter.X - vector2.X;
				num32 = mountedCenter.Y - vector2.Y;
			}
			while (flag5)
			{
				float num34 = (float)Math.Sqrt(num31 * num31 + num32 * num32);
				if (num34 < 28f)
				{
					flag5 = false;
					continue;
				}
				if (float.IsNaN(num34))
				{
					flag5 = false;
					continue;
				}
				num34 = 28f / num34;
				num31 *= num34;
				num32 *= num34;
				vector2.X += num31;
				vector2.Y += num32;
				num31 = mountedCenter.X - vector2.X;
				num32 = mountedCenter.Y - vector2.Y;
				Microsoft.Xna.Framework.Color color9 = Lighting.GetColor((int)vector2.X / 16, (int)(vector2.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain5.Value, new Vector2(vector2.X - screenPosition.X, vector2.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain5.Width(), TextureAssets.Chain5.Height()), color9, rotation, new Vector2((float)TextureAssets.Chain5.Width() * 0.5f, (float)TextureAssets.Chain5.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 73)
		{
			Vector2 vector3 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num35 = mountedCenter.X - vector3.X;
			float num36 = mountedCenter.Y - vector3.Y;
			float rotation2 = (float)Math.Atan2(num36, num35) - 1.57f;
			bool flag6 = true;
			while (flag6)
			{
				float num37 = (float)Math.Sqrt(num35 * num35 + num36 * num36);
				if (num37 < 25f)
				{
					flag6 = false;
					continue;
				}
				if (float.IsNaN(num37))
				{
					flag6 = false;
					continue;
				}
				num37 = 12f / num37;
				num35 *= num37;
				num36 *= num37;
				vector3.X += num35;
				vector3.Y += num36;
				num35 = mountedCenter.X - vector3.X;
				num36 = mountedCenter.Y - vector3.Y;
				Microsoft.Xna.Framework.Color color10 = Lighting.GetColor((int)vector3.X / 16, (int)(vector3.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain8.Value, new Vector2(vector3.X - screenPosition.X, vector3.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain8.Width(), TextureAssets.Chain8.Height()), color10, rotation2, new Vector2((float)TextureAssets.Chain8.Width() * 0.5f, (float)TextureAssets.Chain8.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 186)
		{
			Vector2 vector4 = new Vector2(proj.localAI[0], proj.localAI[1]);
			float num38 = Vector2.Distance(proj.Center, vector4) - proj.velocity.Length();
			float num39 = (float)TextureAssets.Chain17.Height() - num38;
			if (num38 > 0f && proj.ai[1] > 0f)
			{
				Microsoft.Xna.Framework.Color color11 = Lighting.GetColor((int)proj.position.X / 16, (int)proj.position.Y / 16);
				EntitySpriteDraw(TextureAssets.Chain17.Value, vector4 - screenPosition, new Microsoft.Xna.Framework.Rectangle(0, (int)num39, TextureAssets.Chain17.Width(), (int)num38), color11, proj.rotation, new Vector2(TextureAssets.Chain17.Width() / 2, 0f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 74)
		{
			Vector2 vector5 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num40 = mountedCenter.X - vector5.X;
			float num41 = mountedCenter.Y - vector5.Y;
			float rotation3 = (float)Math.Atan2(num41, num40) - 1.57f;
			bool flag7 = true;
			while (flag7)
			{
				float num42 = (float)Math.Sqrt(num40 * num40 + num41 * num41);
				if (num42 < 25f)
				{
					flag7 = false;
					continue;
				}
				if (float.IsNaN(num42))
				{
					flag7 = false;
					continue;
				}
				num42 = 12f / num42;
				num40 *= num42;
				num41 *= num42;
				vector5.X += num40;
				vector5.Y += num41;
				num40 = mountedCenter.X - vector5.X;
				num41 = mountedCenter.Y - vector5.Y;
				Microsoft.Xna.Framework.Color color12 = Lighting.GetColor((int)vector5.X / 16, (int)(vector5.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain9.Value, new Vector2(vector5.X - screenPosition.X, vector5.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain8.Width(), TextureAssets.Chain8.Height()), color12, rotation3, new Vector2((float)TextureAssets.Chain8.Width() * 0.5f, (float)TextureAssets.Chain8.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 171)
		{
			Vector2 vector6 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num43 = 0f - proj.velocity.X;
			float num44 = 0f - proj.velocity.Y;
			float num45 = 1f;
			if (proj.ai[0] <= 17f)
			{
				num45 = proj.ai[0] / 17f;
			}
			int num46 = (int)(30f * num45);
			float num47 = 1f;
			if (proj.ai[0] <= 30f)
			{
				num47 = proj.ai[0] / 30f;
			}
			float num48 = 0.4f * num47;
			float num49 = num48;
			num44 += num49;
			Vector2[] array = new Vector2[num46];
			float[] array2 = new float[num46];
			for (int k = 0; k < num46; k++)
			{
				float num50 = (float)Math.Sqrt(num43 * num43 + num44 * num44);
				float num51 = 5.6f;
				if (Math.Abs(num43) + Math.Abs(num44) < 1f)
				{
					num51 *= Math.Abs(num43) + Math.Abs(num44) / 1f;
				}
				num50 = num51 / num50;
				num43 *= num50;
				num44 *= num50;
				float num52 = (float)Math.Atan2(num44, num43) - 1.57f;
				array[k].X = vector6.X;
				array[k].Y = vector6.Y;
				array2[k] = num52;
				vector6.X += num43;
				vector6.Y += num44;
				num43 = 0f - proj.velocity.X;
				num44 = 0f - proj.velocity.Y;
				num49 += num48;
				num44 += num49;
			}
			for (int num53 = --num46; num53 >= 0; num53--)
			{
				vector6.X = array[num53].X;
				vector6.Y = array[num53].Y;
				float rotation4 = array2[num53];
				Microsoft.Xna.Framework.Color color13 = Lighting.GetColor((int)vector6.X / 16, (int)(vector6.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain16.Value, new Vector2(vector6.X - screenPosition.X, vector6.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain16.Width(), TextureAssets.Chain16.Height()), color13, rotation4, new Vector2((float)TextureAssets.Chain16.Width() * 0.5f, (float)TextureAssets.Chain16.Height() * 0.5f), 0.8f, SpriteEffects.None);
			}
		}
		else if (proj.type == 475)
		{
			Vector2 vector7 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num54 = 0f - proj.velocity.X;
			float num55 = 0f - proj.velocity.Y;
			float num56 = 1f;
			if (proj.ai[0] <= 17f)
			{
				num56 = proj.ai[0] / 17f;
			}
			int num57 = (int)(30f * num56);
			float num58 = 1f;
			if (proj.ai[0] <= 30f)
			{
				num58 = proj.ai[0] / 30f;
			}
			float num59 = 0.4f * num58;
			float num60 = num59;
			num55 += num60;
			Vector2[] array3 = new Vector2[num57];
			float[] array4 = new float[num57];
			for (int l = 0; l < num57; l++)
			{
				float num61 = (float)Math.Sqrt(num54 * num54 + num55 * num55);
				float num62 = 5.6f;
				if (Math.Abs(num54) + Math.Abs(num55) < 1f)
				{
					num62 *= Math.Abs(num54) + Math.Abs(num55) / 1f;
				}
				num61 = num62 / num61;
				num54 *= num61;
				num55 *= num61;
				float num63 = (float)Math.Atan2(num55, num54) - 1.57f;
				array3[l].X = vector7.X;
				array3[l].Y = vector7.Y;
				array4[l] = num63;
				vector7.X += num54;
				vector7.Y += num55;
				num54 = 0f - proj.velocity.X;
				num55 = 0f - proj.velocity.Y;
				num60 += num59;
				num55 += num60;
			}
			int num64 = 0;
			for (int num65 = --num57; num65 >= 0; num65--)
			{
				vector7.X = array3[num65].X;
				vector7.Y = array3[num65].Y;
				float rotation5 = array4[num65];
				Microsoft.Xna.Framework.Color color14 = Lighting.GetColor((int)vector7.X / 16, (int)(vector7.Y / 16f));
				if (num64 % 2 == 0)
				{
					EntitySpriteDraw(TextureAssets.Chain38.Value, new Vector2(vector7.X - screenPosition.X, vector7.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain38.Width(), TextureAssets.Chain38.Height()), color14, rotation5, new Vector2((float)TextureAssets.Chain38.Width() * 0.5f, (float)TextureAssets.Chain38.Height() * 0.5f), 0.8f, SpriteEffects.None);
				}
				else
				{
					EntitySpriteDraw(TextureAssets.Chain39.Value, new Vector2(vector7.X - screenPosition.X, vector7.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain39.Width(), TextureAssets.Chain39.Height()), color14, rotation5, new Vector2((float)TextureAssets.Chain39.Width() * 0.5f, (float)TextureAssets.Chain39.Height() * 0.5f), 0.8f, SpriteEffects.None);
				}
				num64++;
			}
		}
		else if (proj.type == 505 || proj.type == 506)
		{
			Vector2 vector8 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num66 = 0f - proj.velocity.X;
			float num67 = 0f - proj.velocity.Y;
			float num68 = 1f;
			if (proj.ai[0] <= 17f)
			{
				num68 = proj.ai[0] / 17f;
			}
			int num69 = (int)(30f * num68);
			float num70 = 1f;
			if (proj.ai[0] <= 30f)
			{
				num70 = proj.ai[0] / 30f;
			}
			float num71 = 0.4f * num70;
			float num72 = num71;
			num67 += num72;
			Vector2[] array5 = new Vector2[num69];
			float[] array6 = new float[num69];
			for (int m = 0; m < num69; m++)
			{
				float num73 = (float)Math.Sqrt(num66 * num66 + num67 * num67);
				float num74 = 5.6f;
				if (Math.Abs(num66) + Math.Abs(num67) < 1f)
				{
					num74 *= Math.Abs(num66) + Math.Abs(num67) / 1f;
				}
				num73 = num74 / num73;
				num66 *= num73;
				num67 *= num73;
				float num75 = (float)Math.Atan2(num67, num66) - 1.57f;
				array5[m].X = vector8.X;
				array5[m].Y = vector8.Y;
				array6[m] = num75;
				vector8.X += num66;
				vector8.Y += num67;
				num66 = 0f - proj.velocity.X;
				num67 = 0f - proj.velocity.Y;
				num72 += num71;
				num67 += num72;
			}
			int num76 = 0;
			for (int num77 = --num69; num77 >= 0; num77--)
			{
				vector8.X = array5[num77].X;
				vector8.Y = array5[num77].Y;
				float rotation6 = array6[num77];
				Microsoft.Xna.Framework.Color color15 = Lighting.GetColor((int)vector8.X / 16, (int)(vector8.Y / 16f));
				int num78 = 4;
				if (proj.type == 506)
				{
					num78 = 6;
				}
				num78 += num76 % 2;
				EntitySpriteDraw(TextureAssets.Chains[num78].Value, new Vector2(vector8.X - screenPosition.X, vector8.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chains[num78].Width(), TextureAssets.Chains[num78].Height()), color15, rotation6, new Vector2((float)TextureAssets.Chains[num78].Width() * 0.5f, (float)TextureAssets.Chains[num78].Height() * 0.5f), 0.8f, SpriteEffects.None);
				num76++;
			}
		}
		else if (proj.type == 165)
		{
			Vector2 vector9 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num79 = mountedCenter.X - vector9.X;
			float num80 = mountedCenter.Y - vector9.Y;
			float rotation7 = (float)Math.Atan2(num80, num79) - 1.57f;
			bool flag8 = true;
			while (flag8)
			{
				float num81 = (float)Math.Sqrt(num79 * num79 + num80 * num80);
				if (num81 < 25f)
				{
					flag8 = false;
					continue;
				}
				if (float.IsNaN(num81))
				{
					flag8 = false;
					continue;
				}
				num81 = 24f / num81;
				num79 *= num81;
				num80 *= num81;
				vector9.X += num79;
				vector9.Y += num80;
				num79 = mountedCenter.X - vector9.X;
				num80 = mountedCenter.Y - vector9.Y;
				Microsoft.Xna.Framework.Color color16 = Lighting.GetColor((int)vector9.X / 16, (int)(vector9.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain15.Value, new Vector2(vector9.X - screenPosition.X, vector9.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain15.Width(), TextureAssets.Chain15.Height()), color16, rotation7, new Vector2((float)TextureAssets.Chain15.Width() * 0.5f, (float)TextureAssets.Chain15.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type >= 230 && proj.type <= 235)
		{
			int num82 = proj.type - 229;
			Vector2 vector10 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num83 = mountedCenter.X - vector10.X;
			float num84 = mountedCenter.Y - vector10.Y;
			float rotation8 = (float)Math.Atan2(num84, num83) - 1.57f;
			bool flag9 = true;
			while (flag9)
			{
				float num85 = (float)Math.Sqrt(num83 * num83 + num84 * num84);
				if (num85 < 25f)
				{
					flag9 = false;
					continue;
				}
				if (float.IsNaN(num85))
				{
					flag9 = false;
					continue;
				}
				num85 = (float)TextureAssets.GemChain[num82].Height() / num85;
				num83 *= num85;
				num84 *= num85;
				vector10.X += num83;
				vector10.Y += num84;
				num83 = mountedCenter.X - vector10.X;
				num84 = mountedCenter.Y - vector10.Y;
				Microsoft.Xna.Framework.Color color17 = Lighting.GetColor((int)vector10.X / 16, (int)(vector10.Y / 16f));
				EntitySpriteDraw(TextureAssets.GemChain[num82].Value, new Vector2(vector10.X - screenPosition.X, vector10.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.GemChain[num82].Width(), TextureAssets.GemChain[num82].Height()), color17, rotation8, new Vector2((float)TextureAssets.GemChain[num82].Width() * 0.5f, (float)TextureAssets.GemChain[num82].Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 753)
		{
			Vector2 vector11 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num86 = mountedCenter.X - vector11.X;
			float num87 = mountedCenter.Y - vector11.Y;
			float rotation9 = (float)Math.Atan2(num87, num86) - 1.57f;
			bool flag10 = true;
			Texture2D value8 = TextureAssets.Extra[95].Value;
			while (flag10)
			{
				float num88 = (float)Math.Sqrt(num86 * num86 + num87 * num87);
				if (num88 < 25f)
				{
					flag10 = false;
					continue;
				}
				if (float.IsNaN(num88))
				{
					flag10 = false;
					continue;
				}
				num88 = (float)value8.Height / num88;
				num86 *= num88;
				num87 *= num88;
				vector11.X += num86;
				vector11.Y += num87;
				num86 = mountedCenter.X - vector11.X;
				num87 = mountedCenter.Y - vector11.Y;
				Microsoft.Xna.Framework.Color color18 = Lighting.GetColor((int)vector11.X / 16, (int)(vector11.Y / 16f));
				EntitySpriteDraw(value8, new Vector2(vector11.X - screenPosition.X, vector11.Y - screenPosition.Y), null, color18, rotation9, value8.Size() / 2f, 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 865)
		{
			Vector2 vector12 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num89 = mountedCenter.X - vector12.X;
			float num90 = mountedCenter.Y - vector12.Y;
			float rotation10 = (float)Math.Atan2(num90, num89) - 1.57f;
			bool flag11 = true;
			bool flag12 = true;
			Texture2D value9 = TextureAssets.Extra[154].Value;
			while (flag11)
			{
				float num91 = (float)Math.Sqrt(num89 * num89 + num90 * num90);
				if (num91 < 25f)
				{
					flag11 = false;
					continue;
				}
				if (float.IsNaN(num91))
				{
					flag11 = false;
					continue;
				}
				num91 = (float)value9.Height / num91;
				num89 *= num91;
				num90 *= num91;
				vector12.X += num89;
				vector12.Y += num90;
				num89 = mountedCenter.X - vector12.X;
				num90 = mountedCenter.Y - vector12.Y;
				if (!flag12)
				{
					Microsoft.Xna.Framework.Color color19 = Lighting.GetColor((int)vector12.X / 16, (int)(vector12.Y / 16f));
					EntitySpriteDraw(value9, new Vector2(vector12.X - screenPosition.X, vector12.Y - screenPosition.Y), null, color19, rotation10, value9.Size() / 2f, 1f, SpriteEffects.None);
				}
				flag12 = false;
			}
		}
		else if (proj.type == 935)
		{
			Vector2 vector13 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num92 = mountedCenter.X - vector13.X;
			float num93 = mountedCenter.Y - vector13.Y;
			float rotation11 = (float)Math.Atan2(num93, num92) - 1.57f;
			bool flag13 = true;
			bool flag14 = true;
			Texture2D value10 = TextureAssets.Extra[208].Value;
			while (flag13)
			{
				float num94 = (float)Math.Sqrt(num92 * num92 + num93 * num93);
				if (num94 < 8f)
				{
					flag13 = false;
					continue;
				}
				if (float.IsNaN(num94))
				{
					flag13 = false;
					continue;
				}
				num94 = (float)value10.Height / num94;
				num92 *= num94;
				num93 *= num94;
				vector13.X += num92;
				vector13.Y += num93;
				num92 = mountedCenter.X - vector13.X;
				num93 = mountedCenter.Y - vector13.Y;
				if (!flag14)
				{
					Microsoft.Xna.Framework.Color color20 = Lighting.GetColor((int)vector13.X / 16, (int)(vector13.Y / 16f));
					EntitySpriteDraw(value10, new Vector2(vector13.X - screenPosition.X, vector13.Y - screenPosition.Y), null, color20, rotation11, value10.Size() / 2f, 1f, SpriteEffects.None);
				}
				flag14 = false;
			}
		}
		else if (proj.type == 256)
		{
			Vector2 vector14 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num95 = mountedCenter.X - vector14.X;
			float num96 = mountedCenter.Y - vector14.Y;
			float num97 = (float)Math.Atan2(num96, num95) - 1.57f;
			bool flag15 = true;
			while (flag15)
			{
				float num98 = (float)Math.Sqrt(num95 * num95 + num96 * num96);
				if (num98 < 26f)
				{
					flag15 = false;
					continue;
				}
				if (float.IsNaN(num98))
				{
					flag15 = false;
					continue;
				}
				num98 = 26f / num98;
				num95 *= num98;
				num96 *= num98;
				vector14.X += num95;
				vector14.Y += num96;
				num95 = player.position.X + (float)(player.width / 2) - vector14.X;
				num96 = player.position.Y + (float)(player.height / 2) - vector14.Y;
				Microsoft.Xna.Framework.Color color21 = Lighting.GetColor((int)vector14.X / 16, (int)(vector14.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain20.Value, new Vector2(vector14.X - screenPosition.X, vector14.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain20.Width(), TextureAssets.Chain20.Height()), color21, num97 - 0.785f, new Vector2((float)TextureAssets.Chain20.Width() * 0.5f, (float)TextureAssets.Chain20.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 322)
		{
			Vector2 vector15 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num99 = mountedCenter.X - vector15.X;
			float num100 = mountedCenter.Y - vector15.Y;
			float rotation12 = (float)Math.Atan2(num100, num99) - 1.57f;
			bool flag16 = true;
			while (flag16)
			{
				float num101 = (float)Math.Sqrt(num99 * num99 + num100 * num100);
				if (num101 < 22f)
				{
					flag16 = false;
					continue;
				}
				if (float.IsNaN(num101))
				{
					flag16 = false;
					continue;
				}
				num101 = 22f / num101;
				num99 *= num101;
				num100 *= num101;
				vector15.X += num99;
				vector15.Y += num100;
				num99 = mountedCenter.X - vector15.X;
				num100 = mountedCenter.Y - vector15.Y;
				Microsoft.Xna.Framework.Color color22 = Lighting.GetColor((int)vector15.X / 16, (int)(vector15.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain29.Value, new Vector2(vector15.X - screenPosition.X, vector15.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain29.Width(), TextureAssets.Chain29.Height()), color22, rotation12, new Vector2((float)TextureAssets.Chain29.Width() * 0.5f, (float)TextureAssets.Chain29.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 315)
		{
			Vector2 vector16 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num102 = mountedCenter.X - vector16.X;
			float num103 = mountedCenter.Y - vector16.Y;
			float rotation13 = (float)Math.Atan2(num103, num102) - 1.57f;
			bool flag17 = true;
			while (flag17)
			{
				float num104 = (float)Math.Sqrt(num102 * num102 + num103 * num103);
				if (num104 < 50f)
				{
					flag17 = false;
					continue;
				}
				if (float.IsNaN(num104))
				{
					flag17 = false;
					continue;
				}
				num104 = 40f / num104;
				num102 *= num104;
				num103 *= num104;
				vector16.X += num102;
				vector16.Y += num103;
				num102 = mountedCenter.X - vector16.X;
				num103 = mountedCenter.Y - vector16.Y;
				Microsoft.Xna.Framework.Color color23 = Lighting.GetColor((int)vector16.X / 16, (int)(vector16.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain28.Value, new Vector2(vector16.X - screenPosition.X, vector16.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain28.Width(), TextureAssets.Chain28.Height()), color23, rotation13, new Vector2((float)TextureAssets.Chain28.Width() * 0.5f, (float)TextureAssets.Chain28.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 331)
		{
			Vector2 vector17 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num105 = mountedCenter.X - vector17.X;
			float num106 = mountedCenter.Y - vector17.Y;
			float rotation14 = (float)Math.Atan2(num106, num105) - 1.57f;
			bool flag18 = true;
			while (flag18)
			{
				float num107 = (float)Math.Sqrt(num105 * num105 + num106 * num106);
				if (num107 < 30f)
				{
					flag18 = false;
					continue;
				}
				if (float.IsNaN(num107))
				{
					flag18 = false;
					continue;
				}
				num107 = 24f / num107;
				num105 *= num107;
				num106 *= num107;
				vector17.X += num105;
				vector17.Y += num106;
				num105 = mountedCenter.X - vector17.X;
				num106 = mountedCenter.Y - vector17.Y;
				Microsoft.Xna.Framework.Color color24 = Lighting.GetColor((int)vector17.X / 16, (int)(vector17.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain30.Value, new Vector2(vector17.X - screenPosition.X, vector17.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain30.Width(), TextureAssets.Chain30.Height()), color24, rotation14, new Vector2((float)TextureAssets.Chain30.Width() * 0.5f, (float)TextureAssets.Chain30.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 332)
		{
			int num108 = 0;
			Vector2 vector18 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num109 = mountedCenter.X - vector18.X;
			float num110 = mountedCenter.Y - vector18.Y;
			float rotation15 = (float)Math.Atan2(num110, num109) - 1.57f;
			bool flag19 = true;
			while (flag19)
			{
				float num111 = (float)Math.Sqrt(num109 * num109 + num110 * num110);
				if (num111 < 30f)
				{
					flag19 = false;
					continue;
				}
				if (float.IsNaN(num111))
				{
					flag19 = false;
					continue;
				}
				int i2 = (int)vector18.X / 16;
				int j2 = (int)vector18.Y / 16;
				if (num108 == 0)
				{
					Lighting.AddLight(i2, j2, 0f, 0.2f, 0.2f);
				}
				if (num108 == 1)
				{
					Lighting.AddLight(i2, j2, 0.1f, 0.2f, 0f);
				}
				if (num108 == 2)
				{
					Lighting.AddLight(i2, j2, 0.2f, 0.1f, 0f);
				}
				if (num108 == 3)
				{
					Lighting.AddLight(i2, j2, 0.2f, 0f, 0.2f);
				}
				num111 = 16f / num111;
				num109 *= num111;
				num110 *= num111;
				vector18.X += num109;
				vector18.Y += num110;
				num109 = mountedCenter.X - vector18.X;
				num110 = mountedCenter.Y - vector18.Y;
				Microsoft.Xna.Framework.Color color25 = Lighting.GetColor((int)vector18.X / 16, (int)(vector18.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain31.Value, new Vector2(vector18.X - screenPosition.X, vector18.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.Chain31.Height() / 4 * num108, TextureAssets.Chain31.Width(), TextureAssets.Chain31.Height() / 4), color25, rotation15, new Vector2((float)TextureAssets.Chain30.Width() * 0.5f, TextureAssets.Chain30.Height() / 8), 1f, SpriteEffects.None);
				EntitySpriteDraw(TextureAssets.Chain32.Value, new Vector2(vector18.X - screenPosition.X, vector18.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.Chain31.Height() / 4 * num108, TextureAssets.Chain31.Width(), TextureAssets.Chain31.Height() / 4), new Microsoft.Xna.Framework.Color(200, 200, 200, 0), rotation15, new Vector2((float)TextureAssets.Chain30.Width() * 0.5f, TextureAssets.Chain30.Height() / 8), 1f, SpriteEffects.None);
				num108++;
				if (num108 > 3)
				{
					num108 = 0;
				}
			}
		}
		else if (proj.type == 372 || proj.type == 383 || proj.type == 396 || proj.type == 403 || proj.type == 404 || proj.type == 1058 || proj.type == 446 || (proj.type >= 486 && proj.type <= 489) || (proj.type >= 646 && proj.type <= 649) || proj.type == 652)
		{
			Texture2D texture2D = null;
			Microsoft.Xna.Framework.Color color26 = Microsoft.Xna.Framework.Color.Transparent;
			Texture2D value11 = TextureAssets.Chain33.Value;
			if (proj.type == 383)
			{
				value11 = TextureAssets.Chain34.Value;
			}
			if (proj.type == 396)
			{
				value11 = TextureAssets.Chain35.Value;
			}
			if (proj.type == 403)
			{
				value11 = TextureAssets.Chain36.Value;
			}
			if (proj.type == 404 || proj.type == 1058)
			{
				value11 = TextureAssets.Chain37.Value;
			}
			if (proj.type == 446)
			{
				value11 = TextureAssets.Extra[3].Value;
			}
			if (proj.type >= 486 && proj.type <= 489)
			{
				value11 = TextureAssets.Chains[proj.type - 486].Value;
			}
			if (proj.type >= 646 && proj.type <= 649)
			{
				value11 = TextureAssets.Chains[proj.type - 646 + 8].Value;
				texture2D = TextureAssets.Chains[proj.type - 646 + 12].Value;
				color26 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127);
			}
			if (proj.type == 652)
			{
				value11 = TextureAssets.Chains[16].Value;
			}
			Vector2 center = proj.Center;
			Microsoft.Xna.Framework.Rectangle? sourceRectangle = null;
			Vector2 origin5 = new Vector2((float)value11.Width * 0.5f, (float)value11.Height * 0.5f);
			float num112 = value11.Height;
			float num113 = 0f;
			if (proj.type == 446)
			{
				int num114 = 7;
				int num115 = (int)proj.localAI[0] / num114;
				sourceRectangle = new Microsoft.Xna.Framework.Rectangle(0, value11.Height / 4 * num115, value11.Width, value11.Height / 4);
				origin5.Y /= 4f;
				num112 /= 4f;
			}
			switch (proj.type)
			{
			case 383:
				num113 = 14f;
				break;
			case 446:
				num113 = 20f;
				break;
			case 489:
				num113 = 10f;
				break;
			case 487:
				num113 = 8f;
				break;
			}
			if (num113 != 0f)
			{
				float num116 = -1.57f;
				Vector2 vector19 = new Vector2((float)Math.Cos(proj.rotation + num116), (float)Math.Sin(proj.rotation + num116));
				center -= vector19 * num113;
				vector19 = mountedCenter - center;
				vector19.Normalize();
				center -= vector19 * num112 / 2f;
			}
			Vector2 vector20 = mountedCenter - center;
			float rotation16 = (float)Math.Atan2(vector20.Y, vector20.X) - 1.57f;
			bool flag20 = true;
			if (float.IsNaN(center.X) && float.IsNaN(center.Y))
			{
				flag20 = false;
			}
			if (float.IsNaN(vector20.X) && float.IsNaN(vector20.Y))
			{
				flag20 = false;
			}
			if (proj.type == 383)
			{
				if (proj.ai[0] == 0f)
				{
					proj.localAI[1] = (0f - proj.velocity.X + proj.localAI[1]) / 2f;
					proj.localAI[2] = (0f - proj.velocity.Y + proj.localAI[2]) / 2f;
				}
				else
				{
					proj.localAI[1] = (proj.velocity.X + proj.localAI[1] * 4f) / 5f;
					proj.localAI[2] = (proj.velocity.Y + proj.localAI[2] * 4f) / 5f;
				}
			}
			while (flag20)
			{
				if (vector20.Length() < num112 + 1f)
				{
					flag20 = false;
					continue;
				}
				Vector2 vector21 = vector20;
				vector21.Normalize();
				if (proj.type == 383)
				{
					float num117 = vector20.Length();
					if (num117 > 12f)
					{
						float num118 = num117 / 1000f;
						if ((double)num118 > 0.4)
						{
							num118 = 0.4f;
						}
						Vector2 vector22 = mountedCenter - center;
						Vector2 vector23 = new Vector2(proj.localAI[1], proj.localAI[2]);
						vector22.Length();
						vector22.Normalize();
						vector23.Normalize();
						vector21.X = vector22.X * (1f - num118) + vector23.X * num118;
						vector21.Y = vector22.Y * (1f - num118) + vector23.Y * num118;
						rotation16 = (float)Math.Atan2(vector21.Y, vector21.X) - 1.57f;
					}
				}
				center += vector21 * num112;
				vector20 = mountedCenter - center;
				Microsoft.Xna.Framework.Color color27 = Lighting.GetColor((int)center.X / 16, (int)(center.Y / 16f));
				if (proj.type == 396)
				{
					color27 *= (float)(255 - proj.alpha) / 255f;
				}
				if (proj.type == 446)
				{
					color27 = proj.GetAlpha(color27);
				}
				if (proj.type == 488)
				{
					Lighting.AddLight(center, 0.2f, 0f, 0.175f);
					color27 = new Microsoft.Xna.Framework.Color(255, 255, 255, 255);
				}
				if (proj.type >= 646 && proj.type <= 649)
				{
					color27 = proj.GetAlpha(color27);
				}
				EntitySpriteDraw(value11, center - screenPosition, sourceRectangle, color27, rotation16, origin5, 1f, SpriteEffects.None);
				if (texture2D != null)
				{
					EntitySpriteDraw(texture2D, center - screenPosition, sourceRectangle, color26, rotation16, origin5, 1f, SpriteEffects.None);
				}
			}
		}
		else if (proj.aiStyle == 7)
		{
			Vector2 vector24 = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
			float num119 = mountedCenter.X - vector24.X;
			float num120 = mountedCenter.Y - vector24.Y;
			float rotation17 = (float)Math.Atan2(num120, num119) - 1.57f;
			bool flag21 = true;
			while (flag21)
			{
				float num121 = (float)Math.Sqrt(num119 * num119 + num120 * num120);
				if (num121 < 25f)
				{
					flag21 = false;
					continue;
				}
				if (float.IsNaN(num121))
				{
					flag21 = false;
					continue;
				}
				num121 = 12f / num121;
				num119 *= num121;
				num120 *= num121;
				vector24.X += num119;
				vector24.Y += num120;
				num119 = mountedCenter.X - vector24.X;
				num120 = mountedCenter.Y - vector24.Y;
				Microsoft.Xna.Framework.Color color28 = Lighting.GetColor((int)vector24.X / 16, (int)(vector24.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain.Value, new Vector2(vector24.X - screenPosition.X, vector24.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain.Width(), TextureAssets.Chain.Height()), color28, rotation17, new Vector2((float)TextureAssets.Chain.Width() * 0.5f, (float)TextureAssets.Chain.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 262)
		{
			float x = proj.Center.X;
			float y = proj.Center.Y;
			float x2 = proj.velocity.X;
			float y2 = proj.velocity.Y;
			float num122 = (float)Math.Sqrt(x2 * x2 + y2 * y2);
			num122 = 4f / num122;
			if (proj.ai[0] == 0f)
			{
				x -= proj.velocity.X * num122;
				y -= proj.velocity.Y * num122;
			}
			else
			{
				x += proj.velocity.X * num122;
				y += proj.velocity.Y * num122;
			}
			Vector2 vector25 = new Vector2(x, y);
			x2 = mountedCenter.X - vector25.X;
			y2 = mountedCenter.Y - vector25.Y;
			float rotation18 = (float)Math.Atan2(y2, x2) - 1.57f;
			bool flag22 = true;
			while (flag22)
			{
				float num123 = (float)Math.Sqrt(x2 * x2 + y2 * y2);
				if (num123 < 25f)
				{
					flag22 = false;
					continue;
				}
				if (float.IsNaN(num123))
				{
					flag22 = false;
					continue;
				}
				num123 = 12f / num123;
				x2 *= num123;
				y2 *= num123;
				vector25.X += x2;
				vector25.Y += y2;
				x2 = mountedCenter.X - vector25.X;
				y2 = mountedCenter.Y - vector25.Y;
				Microsoft.Xna.Framework.Color color29 = Lighting.GetColor((int)vector25.X / 16, (int)(vector25.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain22.Value, new Vector2(vector25.X - screenPosition.X, vector25.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain22.Width(), TextureAssets.Chain22.Height()), color29, rotation18, new Vector2((float)TextureAssets.Chain22.Width() * 0.5f, (float)TextureAssets.Chain22.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 273)
		{
			float x3 = proj.Center.X;
			float y3 = proj.Center.Y;
			float x4 = proj.velocity.X;
			float y4 = proj.velocity.Y;
			float num124 = (float)Math.Sqrt(x4 * x4 + y4 * y4);
			num124 = 4f / num124;
			if (proj.ai[0] == 0f)
			{
				x3 -= proj.velocity.X * num124;
				y3 -= proj.velocity.Y * num124;
			}
			else
			{
				x3 += proj.velocity.X * num124;
				y3 += proj.velocity.Y * num124;
			}
			Vector2 vector26 = new Vector2(x3, y3);
			x4 = mountedCenter.X - vector26.X;
			y4 = mountedCenter.Y - vector26.Y;
			float rotation19 = (float)Math.Atan2(y4, x4) - 1.57f;
			bool flag23 = true;
			while (flag23)
			{
				float num125 = (float)Math.Sqrt(x4 * x4 + y4 * y4);
				if (num125 < 25f)
				{
					flag23 = false;
					continue;
				}
				if (float.IsNaN(num125))
				{
					flag23 = false;
					continue;
				}
				num125 = 12f / num125;
				x4 *= num125;
				y4 *= num125;
				vector26.X += x4;
				vector26.Y += y4;
				x4 = mountedCenter.X - vector26.X;
				y4 = mountedCenter.Y - vector26.Y;
				Microsoft.Xna.Framework.Color color30 = Lighting.GetColor((int)vector26.X / 16, (int)(vector26.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain23.Value, new Vector2(vector26.X - screenPosition.X, vector26.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain23.Width(), TextureAssets.Chain23.Height()), color30, rotation19, new Vector2((float)TextureAssets.Chain23.Width() * 0.5f, (float)TextureAssets.Chain23.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.type == 481)
		{
			float x5 = proj.Center.X;
			float y5 = proj.Center.Y;
			float x6 = proj.velocity.X;
			float y6 = proj.velocity.Y;
			float num126 = (float)Math.Sqrt(x6 * x6 + y6 * y6);
			num126 = 4f / num126;
			if (proj.ai[0] == 0f)
			{
				x5 -= proj.velocity.X * num126;
				y5 -= proj.velocity.Y * num126;
			}
			else
			{
				x5 += proj.velocity.X * num126;
				y5 += proj.velocity.Y * num126;
			}
			Vector2 origin6 = new Vector2(x5, y5);
			x6 = mountedCenter.X - origin6.X;
			y6 = mountedCenter.Y - origin6.Y;
			float rotation20 = (float)Math.Atan2(y6, x6) - 1.57f;
			bool flag24 = true;
			while (flag24)
			{
				float num127 = 0.85f;
				float num128 = origin6.Distance(mountedCenter);
				float num129 = num128;
				if ((double)num128 < (double)TextureAssets.Chain40.Height() * 1.5)
				{
					flag24 = false;
					continue;
				}
				if (float.IsNaN(num128))
				{
					flag24 = false;
					continue;
				}
				num128 = (float)TextureAssets.Chain40.Height() * num127 / num128;
				x6 *= num128;
				y6 *= num128;
				origin6.X += x6;
				origin6.Y += y6;
				x6 = mountedCenter.X - origin6.X;
				y6 = mountedCenter.Y - origin6.Y;
				if (num129 > (float)(TextureAssets.Chain40.Height() * 2))
				{
					for (int n = 0; n < 2; n++)
					{
						float num130 = 0.75f;
						float num131 = 1f;
						num131 = ((n != 0) ? Math.Abs(player.velocity.Y) : Math.Abs(player.velocity.X));
						if (num131 > 10f)
						{
							num131 = 10f;
						}
						num131 /= 10f;
						num130 *= num131;
						num131 = num129 / 80f;
						if (num131 > 1f)
						{
							num131 = 1f;
						}
						num130 *= num131;
						if (num130 < 0f)
						{
							num130 = 0f;
						}
						if (float.IsNaN(num130))
						{
							continue;
						}
						if (n == 0)
						{
							if (player.velocity.X < 0f && proj.Center.X < mountedCenter.X)
							{
								y6 *= 1f - num130;
							}
							if (player.velocity.X > 0f && proj.Center.X > mountedCenter.X)
							{
								y6 *= 1f - num130;
							}
						}
						else
						{
							if (player.velocity.Y < 0f && proj.Center.Y < mountedCenter.Y)
							{
								x6 *= 1f - num130;
							}
							if (player.velocity.Y > 0f && proj.Center.Y > mountedCenter.Y)
							{
								x6 *= 1f - num130;
							}
						}
					}
				}
				Microsoft.Xna.Framework.Color color31 = Lighting.GetColor((int)origin6.X / 16, (int)(origin6.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain40.Value, new Vector2(origin6.X - screenPosition.X, origin6.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain40.Width(), TextureAssets.Chain40.Height()), color31, rotation20, new Vector2((float)TextureAssets.Chain40.Width() * 0.5f, (float)TextureAssets.Chain40.Height() * 0.5f), num127, SpriteEffects.None);
			}
		}
		else if (proj.type == 271)
		{
			float x7 = proj.Center.X;
			float y7 = proj.Center.Y;
			float x8 = proj.velocity.X;
			float y8 = proj.velocity.Y;
			float num132 = (float)Math.Sqrt(x8 * x8 + y8 * y8);
			num132 = 4f / num132;
			if (proj.ai[0] == 0f)
			{
				x7 -= proj.velocity.X * num132;
				y7 -= proj.velocity.Y * num132;
			}
			else
			{
				x7 += proj.velocity.X * num132;
				y7 += proj.velocity.Y * num132;
			}
			Vector2 vector27 = new Vector2(x7, y7);
			x8 = mountedCenter.X - vector27.X;
			y8 = mountedCenter.Y - vector27.Y;
			float rotation21 = (float)Math.Atan2(y8, x8) - 1.57f;
			bool flag25 = true;
			while (flag25)
			{
				float num133 = (float)Math.Sqrt(x8 * x8 + y8 * y8);
				if (num133 < 25f)
				{
					flag25 = false;
					continue;
				}
				if (float.IsNaN(num133))
				{
					flag25 = false;
					continue;
				}
				num133 = 12f / num133;
				x8 *= num133;
				y8 *= num133;
				vector27.X += x8;
				vector27.Y += y8;
				x8 = mountedCenter.X - vector27.X;
				y8 = mountedCenter.Y - vector27.Y;
				Microsoft.Xna.Framework.Color color32 = Lighting.GetColor((int)vector27.X / 16, (int)(vector27.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain18.Value, new Vector2(vector27.X - screenPosition.X, vector27.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain18.Width(), TextureAssets.Chain18.Height()), color32, rotation21, new Vector2((float)TextureAssets.Chain18.Width() * 0.5f, (float)TextureAssets.Chain18.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.aiStyle == 13)
		{
			float num134 = proj.position.X + 8f;
			float num135 = proj.position.Y + 2f;
			float x9 = proj.velocity.X;
			float num136 = proj.velocity.Y;
			if (x9 == 0f && num136 == 0f)
			{
				num136 = 0.0001f;
				num136 = 0.0001f;
			}
			float num137 = (float)Math.Sqrt(x9 * x9 + num136 * num136);
			num137 = ((proj.type != 23) ? (20f / num137) : (40f / num137));
			if (proj.ai[0] == 0f)
			{
				num134 -= proj.velocity.X * num137;
				num135 -= proj.velocity.Y * num137;
			}
			else
			{
				num134 += proj.velocity.X * num137;
				num135 += proj.velocity.Y * num137;
			}
			Vector2 vector28 = new Vector2(num134, num135);
			if (proj.type == 23)
			{
				if (proj.ai[0] == 0f)
				{
					proj.localAI[1] = (0f - proj.velocity.X + proj.localAI[1]) / 2f;
					proj.localAI[2] = (0f - proj.velocity.Y + proj.localAI[2]) / 2f;
				}
				else
				{
					proj.localAI[1] = (proj.velocity.X + proj.localAI[1] * 4f) / 5f;
					proj.localAI[2] = (proj.velocity.Y + proj.localAI[2] * 4f) / 5f;
				}
			}
			if (proj.type == 23)
			{
				Vector2 vector29 = vector28 - mountedCenter;
				if (vector29.Length() > 20f)
				{
					vector29.Normalize();
					vector29 *= 20f;
					mountedCenter.X += vector29.X;
					mountedCenter.Y += vector29.Y;
				}
				x9 = mountedCenter.X - vector28.X;
				num136 = mountedCenter.Y - vector28.Y;
				float num138 = (float)Math.Sqrt(x9 * x9 + num136 * num136);
				num138 = 12f / num138;
				x9 *= num138;
				num136 *= num138;
				vector28.X -= x9 / 2f;
				vector28.Y -= num136 / 2f;
			}
			x9 = mountedCenter.X - vector28.X;
			num136 = mountedCenter.Y - vector28.Y;
			float rotation22 = (float)Math.Atan2(num136, x9) - 1.57f;
			bool flag26 = true;
			while (flag26)
			{
				float num139 = (float)Math.Sqrt(x9 * x9 + num136 * num136);
				if (num139 < 25f)
				{
					flag26 = false;
					continue;
				}
				if (float.IsNaN(num139))
				{
					flag26 = false;
					continue;
				}
				float num140 = num139;
				num139 = 12f / num139;
				x9 *= num139;
				num136 *= num139;
				vector28.X += x9;
				vector28.Y += num136;
				x9 = mountedCenter.X - vector28.X;
				num136 = mountedCenter.Y - vector28.Y;
				if (proj.type == 23 && num140 > 12f)
				{
					float num141 = num140 / 1000f;
					if ((double)num141 > 0.5)
					{
						num141 = 0.5f;
					}
					Vector2 vector30 = mountedCenter - vector28;
					Vector2 vector31 = new Vector2(proj.localAI[1], proj.localAI[2]);
					float num142 = vector30.Length();
					vector30.Normalize();
					vector31.Normalize();
					vector30 *= num142;
					vector31 *= num142;
					x9 = vector30.X * (1f - num141) + vector31.X * num141;
					num136 = vector30.Y * (1f - num141) + vector31.Y * num141;
					rotation22 = (float)Math.Atan2(num136, x9) - 1.57f;
				}
				Microsoft.Xna.Framework.Color color33 = Lighting.GetColor((int)vector28.X / 16, (int)(vector28.Y / 16f));
				EntitySpriteDraw(TextureAssets.Chain.Value, new Vector2(vector28.X - screenPosition.X, vector28.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain.Width(), TextureAssets.Chain.Height()), color33, rotation22, new Vector2((float)TextureAssets.Chain.Width() * 0.5f, (float)TextureAssets.Chain.Height() * 0.5f), 1f, SpriteEffects.None);
			}
		}
		else if (proj.aiStyle == 15)
		{
			DrawProj_FlailChains(proj, player, mountedCenter);
		}
		Microsoft.Xna.Framework.Color projectileColor = Lighting.GetColor((int)((double)proj.position.X + (double)proj.width * 0.5) / 16, (int)(((double)proj.position.Y + (double)proj.height * 0.5) / 16.0));
		if (proj.usesOwnerLight)
		{
			projectileColor = Lighting.GetColor((int)mountedCenter.X / 16, (int)(mountedCenter.Y / 16f));
		}
		if (proj.type == 14)
		{
			projectileColor = Microsoft.Xna.Framework.Color.White;
		}
		int num143 = 0;
		int num144 = 0;
		if (proj.type == 1022)
		{
			num143++;
		}
		if (proj.type == 175)
		{
			num143 = 10;
		}
		if (proj.type == 392)
		{
			num143 = -2;
		}
		if (proj.type == 1036)
		{
			num143 = -4;
		}
		if (proj.type == 1025)
		{
			num143 = 22;
		}
		if (proj.type == 499)
		{
			num143 = 12;
		}
		if (proj.type == 765)
		{
			num143 = 22;
			num144 = -16;
		}
		if (proj.type == 966)
		{
			num143 = -26;
			num144 = -6;
		}
		if (proj.bobber)
		{
			num143 = 8;
		}
		if (proj.type == 519)
		{
			num143 = 6;
			num144 -= 6;
		}
		if (proj.type == 520)
		{
			num143 = 12;
		}
		if (proj.type == 492)
		{
			num144 -= 4;
			num143 += 5;
		}
		if (proj.type == 498)
		{
			num143 = 6;
		}
		if (proj.type == 489)
		{
			num143 = -2;
		}
		if (proj.type == 486)
		{
			num143 = -6;
		}
		if (proj.type == 525)
		{
			num143 = 5;
		}
		if (proj.type == 488)
		{
			num144 -= 8;
		}
		if (proj.type == 373)
		{
			num144 = -10;
			num143 = 6;
		}
		if (proj.type == 375)
		{
			num144 = -11;
			num143 = 12;
		}
		if (proj.type == 423)
		{
			num144 = -5;
		}
		if (proj.type == 346)
		{
			num143 = 4;
		}
		if (proj.type == 331)
		{
			num144 = -4;
		}
		if (proj.type == 254)
		{
			num143 = 3;
		}
		if (proj.type == 273)
		{
			num144 = 2;
		}
		if (proj.type == 335)
		{
			num143 = 6;
		}
		if (proj.type == 162)
		{
			num143 = 1;
			num144 = 1;
		}
		if (proj.type == 377)
		{
			num143 = -6;
		}
		if (proj.type == 353)
		{
			num143 = 36;
			num144 = -12;
		}
		if (proj.type == 324)
		{
			num143 = 22;
			num144 = -6;
		}
		if (proj.type == 266)
		{
			num143 = 6;
			num144 = -13;
		}
		if (proj.type == 319)
		{
			num143 = 10;
			num144 = -12;
		}
		if (proj.type == 315)
		{
			num143 = -13;
			num144 = -6;
		}
		if (proj.type == 313 && proj.height != 54)
		{
			num144 = -12;
			num143 = 20;
		}
		if (proj.type == 314)
		{
			num144 = -8;
			num143 = 0;
		}
		if (proj.type == 269)
		{
			num143 = 18;
			num144 = -14;
		}
		if (proj.type == 268)
		{
			num143 = 22;
			num144 = -2;
		}
		if (proj.type == 18)
		{
			num143 = 3;
			num144 = 3;
		}
		if (proj.type == 16)
		{
			num143 = 6;
		}
		if (proj.type == 17 || proj.type == 31)
		{
			num143 = 2;
		}
		if (proj.type == 25 || proj.type == 26 || proj.type == 35 || proj.type == 63 || proj.type == 154)
		{
			num143 = 6;
			num144 -= 6;
		}
		if (proj.type == 947 || proj.type == 948)
		{
			num143 = 4;
			num144 -= 4;
		}
		if (proj.type == 28 || proj.type == 37 || proj.type == 75 || proj.type == 1077)
		{
			num143 = 8;
		}
		if (proj.type == 29 || proj.type == 470 || proj.type == 637)
		{
			num143 = 11;
		}
		if (proj.type == 43)
		{
			num143 = 4;
		}
		if (proj.type == 208)
		{
			num143 = 2;
			num144 -= 12;
		}
		if (proj.type == 209)
		{
			num143 = 4;
			num144 -= 8;
		}
		if (proj.type == 210)
		{
			num143 = 2;
			num144 -= 22;
		}
		if (proj.type == 251)
		{
			num143 = 18;
			num144 -= 10;
		}
		if (proj.type == 163 || proj.type == 310 || proj.type == 1009 || proj.type == 1010 || proj.type == 1011 || proj.type == 1008)
		{
			num143 = 10;
		}
		if (proj.type == 69 || proj.type == 70)
		{
			num143 = 4;
			num144 = 4;
		}
		float num145 = (float)(TextureAssets.Projectile[proj.type].Width() - proj.width) * 0.5f + (float)proj.width * 0.5f;
		if (proj.type == 50 || proj.type == 53 || proj.type == 515 || proj.type == 870)
		{
			num144 = -8;
		}
		if (proj.type == 473)
		{
			num144 = -6;
			num143 = 2;
		}
		if (proj.type == 72 || proj.type == 86 || proj.type == 87)
		{
			num144 = -16;
			num143 = 8;
		}
		if (proj.type == 74)
		{
			num144 = -6;
		}
		if (proj.type == 99 || proj.type == 727 || proj.type == 1013 || proj.type == 1014 || proj.type == 1047 || proj.type == 1048 || proj.type == 1053 || proj.type == 1054 || proj.type == 1055 || proj.type == 1057)
		{
			num143 = 1;
		}
		if (proj.type == 655)
		{
			num143 = 1;
		}
		if (proj.type == 111)
		{
			num143 = 18;
			num144 = -16;
		}
		if (proj.type == 875)
		{
			num143 = 16;
			num144 = -16;
		}
		if (proj.type == 881)
		{
			num143 = 14;
			num144 = -8;
		}
		if (proj.type == 934)
		{
			num143 = 14;
			num144 = -20;
		}
		if (proj.type == 934)
		{
			num143 = 14;
			num144 = -20;
		}
		if (proj.type == 884)
		{
			num143 = 16;
			num144 = -12;
		}
		if (proj.type == 890)
		{
			num143 = 26;
			num144 = -9;
		}
		if (proj.type == 891)
		{
			num143 = 30;
			num144 = -12;
		}
		if (proj.type == 897)
		{
			num143 = 38;
			num144 = -13;
		}
		if (proj.type == 899)
		{
			num143 = 28;
			num144 = -12;
		}
		if (proj.type == 900)
		{
			num143 = 54;
			num144 = -30;
		}
		if (proj.type == 334)
		{
			num144 = -18;
			num143 = 8;
		}
		if (proj.type == 816)
		{
			num144 = -19;
			num143 = 6;
		}
		if (proj.type == 821)
		{
			num144 = -10;
			num143 = 6;
		}
		if (proj.type == 825)
		{
			num144 = -19;
			num143 = 14;
		}
		if (proj.type == 854)
		{
			num144 = -14;
			num143 = 10;
		}
		if (proj.type == 858)
		{
			num144 = -8;
			num143 = 16;
		}
		if (proj.type == 859)
		{
			num144 = -8;
			num143 = 8;
		}
		if (proj.type == 860)
		{
			num144 = -8;
			num143 = 34;
		}
		if (proj.type == 958)
		{
			num144 = -20;
			num143 = 48;
		}
		if (proj.type == 960)
		{
			num144 = -14;
			num143 = 24;
		}
		if (proj.type == 956)
		{
			num144 = -12;
			num143 = 16;
		}
		if (proj.type == 959)
		{
			num144 = -14 + ((proj.spriteDirection == -1) ? (-8) : 0);
			num143 = 40;
		}
		if (proj.type == 1095 || proj.type == 1096)
		{
			num144 = -14 + ((proj.spriteDirection == -1) ? (-8) : 0);
			num143 = 40;
		}
		if (proj.type == 994)
		{
			num144 = -10;
			num143 = 18;
		}
		if (proj.type == 998)
		{
			num144 = -10;
			num143 = 14;
		}
		if (proj.type == 1003)
		{
			num144 = -18 + ((proj.spriteDirection == 1) ? 8 : 0);
			num143 = 22;
		}
		if (proj.type == 1004)
		{
			num144 = -18 + ((proj.spriteDirection == 1) ? 6 : 0);
			num143 = 26;
		}
		if (proj.type == 1027)
		{
			num144 = -6;
			num143 = 4;
		}
		if (proj.type == 200)
		{
			num143 = 12;
			num144 = -12;
		}
		if (proj.type == 211)
		{
			num143 = 14;
			num144 = 0;
		}
		if (proj.type == 236)
		{
			num143 = 30;
			num144 = -14;
		}
		if (proj.type >= 191 && proj.type <= 194)
		{
			num143 = 26;
			num144 = ((proj.direction != 1) ? (-22) : (-10));
		}
		if (proj.type >= 390 && proj.type <= 392)
		{
			num144 = 4 * proj.direction;
		}
		if (proj.type == 112)
		{
			num143 = 14;
			num144 = -8 + 4 * proj.spriteDirection;
		}
		_ = proj.type;
		_ = 118;
		if (proj.type == 517 || proj.type == 681)
		{
			num143 = 6;
		}
		if (proj.type == 516)
		{
			num143 = 6;
		}
		if (proj.type == 127)
		{
			num143 = 8;
		}
		if (proj.type == 155)
		{
			num143 = 3;
			num144 = 3;
		}
		if (proj.type == 397)
		{
			num145 -= 1f;
			num143 = -2;
			num144 = -2;
		}
		SpriteEffects dir = SpriteEffects.None;
		if (proj.spriteDirection == -1)
		{
			dir = SpriteEffects.FlipHorizontally;
		}
		if (proj.type == 681 && proj.velocity.X > 0f)
		{
			dir ^= SpriteEffects.FlipHorizontally;
		}
		if (proj.type == 221)
		{
			for (int num146 = 1; num146 < 10; num146++)
			{
				float num147 = proj.velocity.X * (float)num146 * 0.5f;
				float num148 = proj.velocity.Y * (float)num146 * 0.5f;
				Microsoft.Xna.Framework.Color alpha = proj.GetAlpha(projectileColor);
				float num149 = 0f;
				if (num146 == 1)
				{
					num149 = 0.9f;
				}
				if (num146 == 2)
				{
					num149 = 0.8f;
				}
				if (num146 == 3)
				{
					num149 = 0.7f;
				}
				if (num146 == 4)
				{
					num149 = 0.6f;
				}
				if (num146 == 5)
				{
					num149 = 0.5f;
				}
				if (num146 == 6)
				{
					num149 = 0.4f;
				}
				if (num146 == 7)
				{
					num149 = 0.3f;
				}
				if (num146 == 8)
				{
					num149 = 0.2f;
				}
				if (num146 == 9)
				{
					num149 = 0.1f;
				}
				alpha.R = (byte)((float)(int)alpha.R * num149);
				alpha.G = (byte)((float)(int)alpha.G * num149);
				alpha.B = (byte)((float)(int)alpha.B * num149);
				alpha.A = (byte)((float)(int)alpha.A * num149);
				int num150 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y9 = num150 * proj.frame;
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144 - num147, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY - num148), new Microsoft.Xna.Framework.Rectangle(0, y9, TextureAssets.Projectile[proj.type].Width(), num150), alpha, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
			}
		}
		if (proj.type == 408 || proj.type == 435 || proj.type == 436 || proj.type == 438 || proj.type == 452 || proj.type == 454 || proj.type == 459 || proj.type == 462 || proj.type == 503 || proj.type == 532 || proj.type == 533 || proj.type == 573 || proj.type == 582 || proj.type == 585 || proj.type == 592 || proj.type == 601 || proj.type == 636 || proj.type == 638 || proj.type == 640 || proj.type == 639 || proj.type == 424 || proj.type == 425 || proj.type == 426 || proj.type == 1037 || proj.type == 1049 || proj.type == 660 || proj.type == 661 || proj.type == 671 || proj.type == 664 || proj.type == 666 || proj.type == 668 || proj.type == 675 || proj.type == 680 || proj.type == 682 || proj.type == 684 || proj.type == 686 || proj.type == 700 || proj.type == 706 || proj.type == 709 || proj.type == 710 || proj.type == 711 || proj.type == 261 || ProjectileID.Sets.IsAGolfBall[proj.type] || proj.type == 729 || proj.type == 732 || proj.type == 731 || proj.type == 755 || proj.type == 811 || proj.type == 814 || proj.type == 819 || proj.type == 864 || proj.type == 873 || proj.type == 872 || proj.type == 833 || proj.type == 834 || proj.type == 835 || proj.type == 818 || proj.type == 902 || proj.type == 894 || proj.type == 901 || proj.type == 909 || proj.type == 916 || proj.type == 931 || proj.type == 933 || proj.type == 1100 || proj.type == 964 || proj.type == 965 || proj.type == 977 || proj.type == 976 || proj.type == 1001 || proj.type == 1039 || proj.type == 1026 || proj.type == 1045 || proj.type == 1055 || proj.type == 1097)
		{
			Texture2D value12 = TextureAssets.Projectile[proj.type].Value;
			int num151 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
			int y10 = num151 * proj.frame;
			Microsoft.Xna.Framework.Rectangle rectangle4 = new Microsoft.Xna.Framework.Rectangle(0, y10, value12.Width, num151);
			Vector2 origin7 = rectangle4.Size() / 2f;
			Vector2 zero = Vector2.Zero;
			float num152 = 0f;
			if (proj.type == 503)
			{
				origin7.Y = 70f;
			}
			if (proj.type == 686 || proj.type == 711 || proj.type == 1097)
			{
				origin7.Y = rectangle4.Height - 70;
			}
			if (proj.type == 438)
			{
				rectangle4.Y = 0;
			}
			if (proj.type == 452)
			{
				rectangle4.Y = 0;
			}
			if (proj.type == 408)
			{
				rectangle4.Y = num151;
			}
			if (proj.type == 636)
			{
				origin7.Y = 10f;
			}
			if (proj.type == 638)
			{
				origin7.Y = 2f;
			}
			if (proj.type == 640 || proj.type == 639 || proj.type == 710)
			{
				origin7.Y = 5f;
			}
			if (proj.type == 700)
			{
				origin7.X = ((proj.spriteDirection == 1) ? (rectangle4.Width - 20) : 20);
			}
			if (proj.type == 965 || proj.type == 964)
			{
				origin7.X = ((proj.spriteDirection == 1) ? (rectangle4.Width - 20) : 20);
			}
			if (proj.type == 872)
			{
				rectangle4.Width /= 2;
				origin7.X /= 2f;
			}
			if (proj.type == 933 || proj.type == 1100)
			{
				int num153 = (int)proj.ai[1];
				if (TextureAssets.Item.IndexInRange(num153))
				{
					instance.LoadItem(num153);
					value12 = TextureAssets.Item[num153].Value;
					rectangle4 = value12.Frame();
					origin7 = rectangle4.Size() / 2f;
					num152 = -(float)Math.PI / 4f * (float)proj.spriteDirection;
				}
			}
			if (proj.type == 833 && proj.frame != 8)
			{
				zero.Y += proj.height / 2;
				origin7 = rectangle4.Size() * new Vector2(0.5f, 1f);
				origin7.Y -= 4f;
				origin7.X -= 7 * ((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt();
			}
			if ((proj.type == 834 || proj.type == 835) && proj.frame != 10)
			{
				zero.Y += proj.height / 2;
				origin7 = rectangle4.Size() * new Vector2(0.5f, 1f);
				origin7.Y -= 4f;
				origin7.X -= 2 * ((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt();
			}
			int num154 = 8;
			int num155 = 2;
			int num156 = 1;
			float value13 = 1f;
			float num157 = 15f;
			float num158 = 0f;
			Microsoft.Xna.Framework.Rectangle value14 = rectangle4;
			UnifiedRandom unifiedRandom = null;
			if (proj.type == 1055)
			{
				num155 = 1;
				num154 = proj.frame;
				if (proj.frame == 8)
				{
					num154--;
				}
				if (proj.frame == 9)
				{
					num154 -= 2;
				}
			}
			if (proj.type == 1026)
			{
				num156 = 8;
				num154 = 0;
				num155 = -2;
				value13 = 0.5f;
			}
			else if (proj.type == 909)
			{
				num156 = 5;
				num154 = 0;
				num155 = -1;
			}
			else if (proj.type == 503)
			{
				num154 = 9;
				num155 = 3;
				value13 = 0.5f;
			}
			else if (proj.type == 261)
			{
				num156 = 18;
				num154 = 0;
				num155 = -2;
				value13 = 1.3f;
			}
			else if (proj.type == 833 || proj.type == 834 || proj.type == 835)
			{
				num156 = 6;
				num154 = 0;
				num155 = -1;
				value13 = 1.5f;
			}
			else if (proj.type == 818)
			{
				num156 = 18;
				num154 = 0;
				num155 = -2;
				value13 = 1f;
			}
			else if (proj.type == 729)
			{
				num156 = 18;
				num154 = 0;
				num155 = -2;
				value13 = 1.3f;
			}
			else if (proj.type == 977)
			{
				num156 = 18;
				num154 = 0;
				num155 = -2;
				value13 = 1.3f;
			}
			else if (proj.type == 1045)
			{
				num156 = 18;
				num154 = 0;
				num155 = -2;
				value13 = 1.3f;
			}
			else if (proj.type == 1001)
			{
				num156 = 10;
				num154 = 0;
				num155 = -2;
				value13 = 1.3f;
				dir = ((proj.spriteDirection != 1) ? SpriteEffects.FlipVertically : SpriteEffects.None);
			}
			else if (proj.type == 976)
			{
				num156 = 18;
				num154 = 0;
				num155 = -3;
				value13 = 1.3f;
				rectangle4 = new Microsoft.Xna.Framework.Rectangle(0, 20 * proj.frame, 32, 18);
				value14 = rectangle4;
				origin7 = rectangle4.Size() / 2f;
			}
			else if (proj.type == 686 || proj.type == 711 || proj.type == 1097)
			{
				num156 = 19;
				num154 = 0;
				num155 = -3;
				value13 = 0.5f;
			}
			else if (ProjectileID.Sets.IsAGolfBall[proj.type])
			{
				num156 = 0;
				num154 = 0;
				num155 = -1;
				value13 = 2f;
			}
			else if (proj.type == 671)
			{
				num156 = 5;
				num154 = 0;
				num155 = -1;
				value13 = 2.6f;
			}
			else if (proj.type == 811)
			{
				num156 = 5;
				num154 = 0;
				num155 = -1;
				value13 = 2.6f;
				projectileColor = Microsoft.Xna.Framework.Color.Lerp(projectileColor, Microsoft.Xna.Framework.Color.White, Utils.Remap(proj.ai[0], 0f, 15f, 1f, 0.3f));
			}
			else if (proj.type == 814)
			{
				num156 = 18;
				num154 = 0;
				num155 = -1;
				value13 = 1f;
				projectileColor = Microsoft.Xna.Framework.Color.Lerp(projectileColor, Microsoft.Xna.Framework.Color.White, 0.35f);
			}
			else if (proj.type == 755)
			{
				num156 = 5;
				num154 = 0;
				num155 = -1;
				value13 = 2.6f;
			}
			else if (proj.type == 700)
			{
				num154 = 5;
				num155 = 1;
				value13 = 2.6f;
			}
			else if (proj.type == 965 || proj.type == 964)
			{
				num154 = 5;
				num155 = 1;
				value13 = 2.6f;
			}
			else if (proj.type == 731)
			{
				num156 = 19;
				num154 = 0;
				num155 = -1;
				value13 = 0.5f;
			}
			else if (proj.type == 864)
			{
				num156 = 12;
				num154 = 0;
				num155 = -1;
				value13 = 1.4f;
				value14.Y += value14.Height;
			}
			else if (proj.type == 916)
			{
				num156 = 19;
				num154 = 0;
				num155 = -1;
				value13 = 1.4f;
				value14.Y += value14.Height;
				unifiedRandom = _tempSeededRandom;
				unifiedRandom.SetSeed(proj.timeLeft);
			}
			else if (proj.type == 873)
			{
				num156 = 39;
				num157 = 40f;
				num154 = 0;
				num155 = -1;
				value13 = 1.4f;
			}
			else if (proj.type == 931)
			{
				num156 = 19;
				num157 = 20f;
				num154 = 0;
				num155 = -1;
				value13 = 0.7f;
			}
			else if (proj.type == 1039)
			{
				num156 = 19;
				num157 = 20f;
				num154 = 0;
				num155 = -1;
				value13 = 0.7f;
			}
			else if (proj.type == 933 || proj.type == 1100)
			{
				num156 = 60;
				num157 = 60f;
				num154 = 0;
				num155 = -15;
				value13 = 1f;
			}
			else if (proj.type == 872)
			{
				num156 = 79;
				num157 = 10f;
				num154 = 0;
				num155 = -1;
				value13 = 1f;
				value14.X += value14.Width;
			}
			else if (proj.type == 664 || proj.type == 666 || proj.type == 668)
			{
				num154 = 8;
				num155 = 2;
				value13 = 0.4f;
			}
			else if (proj.type == 582 || proj.type == 902)
			{
				if (proj.ai[2] == 1f)
				{
					value12 = TextureAssets.Extra[263].Value;
				}
				num154 = 10;
				num155 = 2;
				value13 = 0.7f;
				num158 = 0.2f;
			}
			else if (proj.type == 675)
			{
				num154 = 5;
				num155 = 1;
				value13 = 0.4f;
			}
			else if (proj.type == 638)
			{
				num154 = 5;
				num155 = 1;
				value13 = 1f;
			}
			else if (proj.type == 660)
			{
				num154 = 3;
				num155 = 1;
				value13 = 8f;
				rectangle4 = new Microsoft.Xna.Framework.Rectangle(38 * proj.frame, 0, 38, 38);
				value14 = rectangle4;
				origin7 = rectangle4.Size() / 2f;
			}
			else if (proj.type == 684)
			{
				num154 = 8;
				num155 = 1;
				value13 = 0.75f;
			}
			else if (proj.type == 639)
			{
				num154 = 10;
				num155 = 1;
				value13 = 1f;
			}
			else if (proj.type == 710)
			{
				num156 = 9;
				num154 = 0;
				num155 = -2;
				value13 = 0.5f;
			}
			else if (proj.type == 640)
			{
				num154 = 20;
				num155 = 1;
				value13 = 1f;
			}
			else if (proj.type == 436)
			{
				num155 = 2;
				value13 = 0.5f;
			}
			else if (proj.type == 424 || proj.type == 425 || proj.type == 426)
			{
				num154 = 10;
				num155 = 2;
				value13 = 0.6f;
			}
			else if (proj.type == 1037 || proj.type == 1049)
			{
				num154 = 10;
				num155 = 2;
				value13 = 0.6f;
			}
			else if (proj.type == 438)
			{
				num154 = 10;
				num155 = 2;
				value13 = 1f;
			}
			else if (proj.type == 452)
			{
				num154 = 10;
				num155 = 3;
				value13 = 0.5f;
			}
			else if (proj.type == 454)
			{
				num154 = 5;
				num155 = 1;
				value13 = 0.2f;
			}
			else if (proj.type == 462)
			{
				num154 = 7;
				num155 = 1;
				value13 = 0.2f;
			}
			else if (proj.type == 661)
			{
				num154 = 0;
				num155 = 1;
				value13 = 0.5f;
			}
			else if (proj.type == 706)
			{
				num156 = 9;
				num154 = 0;
				num155 = -2;
				value13 = 0.5f;
			}
			else if (proj.type == 585)
			{
				num154 = 7;
				num155 = 1;
				value13 = 0.2f;
			}
			else if (proj.type == 459)
			{
				num154 = (int)(proj.scale * 8f);
				num155 = num154 / 4;
				if (num155 < 1)
				{
					num155 = 1;
				}
				value13 = 0.3f;
			}
			else if (proj.type == 709)
			{
				num154 = 8;
				num155 = num154 / 4;
				if (num155 < 1)
				{
					num155 = 1;
				}
				value13 = 0.5f;
			}
			else if (proj.type == 532)
			{
				num154 = 10;
				num155 = 1;
				value13 = 0.7f;
				num158 = 0.2f;
			}
			else if (proj.type == 592)
			{
				num154 = 10;
				num155 = 2;
				value13 = 1f;
			}
			else if (proj.type == 601)
			{
				num154 = 8;
				num155 = 1;
				value13 = 0.3f;
			}
			else if (proj.type == 636)
			{
				num154 = 20;
				num155 = 3;
				value13 = 0.5f;
			}
			else if (proj.type == 680)
			{
				num154 = 9;
				num155 = 3;
				value13 = 0.5f;
			}
			else if (proj.type == 533)
			{
				if (proj.ai[0] >= 6f && proj.ai[0] <= 8f)
				{
					num154 = ((proj.ai[0] == 6f) ? 8 : 4);
					num155 = 1;
					if (proj.ai[0] != 7f)
					{
						num158 = 0.2f;
					}
				}
				else
				{
					num154 = (num155 = 0);
				}
			}
			for (int num159 = num156; (num155 > 0 && num159 < num154) || (num155 < 0 && num159 > num154); num159 += num155)
			{
				if (num159 >= proj.oldPos.Length)
				{
					continue;
				}
				Microsoft.Xna.Framework.Color color34 = projectileColor;
				if (proj.type == 408 || proj.type == 435 || proj.type == 682 || proj.type == 732 || proj.type == 731 || proj.type == 1026)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.Blue, 0.5f);
				}
				else if (proj.type == 436)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.LimeGreen, 0.5f);
				}
				else if (proj.type >= 424 && proj.type <= 426)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.Red, 0.5f);
				}
				else if (proj.type == 1037 || proj.type == 1049)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.Red, 0.5f);
				}
				else if (proj.type == 640 || proj.type == 639)
				{
					color34.A = 127;
				}
				else if (proj.type == 671)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.Purple, (float)num159 / (float)num154);
				}
				else if (proj.type == 811)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.Crimson * 0.5f, (float)num159 / (float)num154);
				}
				else if (proj.type == 814)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, color34 * 0.5f, (float)num159 / (float)num154);
				}
				else if (proj.type == 261)
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, new Microsoft.Xna.Framework.Color(60, 60, 60, 60), (float)num159 / (float)num154);
				}
				else if (ProjectileID.Sets.IsAGolfBall[proj.type])
				{
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, new Microsoft.Xna.Framework.Color(255, 230, 40, 20), (float)num159 / (float)num154);
				}
				color34 = proj.GetAlpha(color34);
				if (proj.type == 438)
				{
					color34.G /= (byte)num159;
					color34.B /= (byte)num159;
				}
				else if (proj.type == 755)
				{
					color34 = proj.AI_156_GetColor();
				}
				else if (proj.type == 873)
				{
					color34 = proj.AI_171_GetColor();
					color34.A /= 2;
					color34 *= Utils.GetLerpValue(0f, 20f, proj.timeLeft, clamped: true);
				}
				else if (proj.type == 931)
				{
					color34 = proj.GetFairyQueenWeaponsColor(0.5f);
					color34 *= Utils.GetLerpValue(0f, 20f, proj.timeLeft, clamped: true);
				}
				else if (proj.type == 1039)
				{
					color34 = proj.GetConstellationColor(0.5f);
					color34 *= Utils.GetLerpValue(0f, 20f, proj.timeLeft, clamped: true);
				}
				else if (proj.type == 872)
				{
					color34 = proj.AI_173_GetColor();
					color34 *= 0.4f;
					color34.A = (byte)((float)(int)color34.A * 0.6f);
					if (num159 > 80)
					{
						color34 *= 0.15f * Utils.GetLerpValue(120f, 80f, num159, clamped: true);
					}
				}
				else if (proj.type == 864)
				{
					color34 = proj.GetFloatingDaggerMinionGlowColor();
					color34.A /= 4;
				}
				else if (proj.type == 682)
				{
					color34.G /= (byte)num159;
				}
				else if (proj.type == 686)
				{
					if (proj.oldPos[num159] == Vector2.Zero)
					{
						continue;
					}
					float num160 = (float)num159 / (float)num156;
					color34 = ((!(num160 < 0.5f)) ? Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Purple, Microsoft.Xna.Framework.Color.Black, Utils.GetLerpValue(0.5f, 1f, num160)) : Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.Purple, Utils.GetLerpValue(0f, 0.5f, num160)));
				}
				else if (proj.type == 1097)
				{
					if (proj.oldPos[num159] == Vector2.Zero)
					{
						continue;
					}
					float num161 = (float)num159 / (float)num156;
					color34 = ((!(num161 < 0.5f)) ? Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.OrangeRed, Microsoft.Xna.Framework.Color.Red, Utils.GetLerpValue(0.5f, 1f, num161)) : Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.OrangeRed, Utils.GetLerpValue(0f, 0.5f, num161)));
				}
				else if (proj.type == 711)
				{
					if (proj.oldPos[num159] == Vector2.Zero)
					{
						continue;
					}
					float num162 = (float)num159 / (float)num156;
					color34 = ((!(num162 < 0.5f)) ? Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(128, 0, 255, 180), Microsoft.Xna.Framework.Color.Black, Utils.GetLerpValue(0.5f, 1f, num162)) : Microsoft.Xna.Framework.Color.Lerp(color34, new Microsoft.Xna.Framework.Color(128, 0, 255, 180), Utils.GetLerpValue(0f, 0.5f, num162)));
				}
				else if (proj.type == 684)
				{
					if (num159 == 1)
					{
						color34.B /= 2;
						color34.G /= 2;
						color34.A /= 2;
					}
					color34.B /= (byte)num159;
					color34.G /= (byte)num159;
					color34.A /= (byte)num159;
				}
				else if (proj.type == 706 || proj.type == 710)
				{
					color34.B /= (byte)num159;
					color34.G /= (byte)num159;
					color34.A /= (byte)num159;
				}
				else if (proj.type == 818)
				{
					float num163 = 0.3f;
					float num164 = Utils.GetLerpValue(0f, num163, proj.ai[0], clamped: true) * Utils.GetLerpValue(1f, 1f - num163, proj.ai[0], clamped: true);
					Utils.GetLerpValue(0f, num155 * -3, num159, clamped: true);
					Utils.GetLerpValue(num156, num156 + num155 * 3, num159, clamped: true);
					Microsoft.Xna.Framework.Color value15 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
					Microsoft.Xna.Framework.Color ourFavoriteColor = OurFavoriteColor;
					ourFavoriteColor.A = 0;
					ourFavoriteColor *= num164;
					color34 = Microsoft.Xna.Framework.Color.Lerp(ourFavoriteColor, value15, num164);
				}
				else if (proj.type == 833 || proj.type == 834 || proj.type == 835)
				{
					float lerpValue2 = Utils.GetLerpValue(0f, 6f, proj.velocity.Length(), clamped: true);
					color34 = Microsoft.Xna.Framework.Color.Lerp(color34, Microsoft.Xna.Framework.Color.White, lerpValue2 * 0.5f);
					color34.A = 0;
					color34 *= lerpValue2;
				}
				else if (proj.type == 592)
				{
					color34.R /= (byte)num159;
					color34.G /= (byte)num159;
				}
				else if (proj.type == 640)
				{
					color34.R /= (byte)num159;
					color34.A /= (byte)num159;
				}
				else if (proj.type >= 424 && proj.type <= 426)
				{
					color34.B /= (byte)num159;
					color34.G /= (byte)num159;
					color34.A /= (byte)num159;
				}
				else if (proj.type == 1037 || proj.type == 1049)
				{
					color34.B /= (byte)num159;
					color34.G /= (byte)num159;
					color34.A /= (byte)num159;
				}
				else if (proj.type == 964 || proj.type == 965)
				{
					color34 = Microsoft.Xna.Framework.Color.Black * proj.Opacity;
				}
				float num165 = num154 - num159;
				if (num155 < 0)
				{
					num165 = num156 - num159;
				}
				color34 *= num165 / ((float)ProjectileID.Sets.TrailCacheLength[proj.type] * 1.5f);
				Vector2 vector32 = proj.oldPos[num159];
				float num166 = proj.rotation;
				SpriteEffects spriteEffects = dir;
				if (ProjectileID.Sets.TrailingMode[proj.type] == 2 || ProjectileID.Sets.TrailingMode[proj.type] == 3 || ProjectileID.Sets.TrailingMode[proj.type] == 4)
				{
					num166 = proj.oldRot[num159];
					SpriteEffects spriteEffects2 = ((proj.oldSpriteDirection[num159] == -1) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
					spriteEffects ^= spriteEffects2;
				}
				if (vector32 == Vector2.Zero)
				{
					continue;
				}
				if (proj.type == 916)
				{
					value14.Y += value14.Height;
					value14.Y %= value14.Height * projFrames[proj.type];
					_ = num165 / ((float)ProjectileID.Sets.TrailCacheLength[proj.type] * 1.5f);
					Microsoft.Xna.Framework.Color color35 = new Microsoft.Xna.Framework.Color(0, 0, 0, 255);
					int num167 = unifiedRandom.Next(3);
					if (num167 == 2 || num167 == 1)
					{
						color35 = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(106, 90, 205, 127), Microsoft.Xna.Framework.Color.Black, 0.2f + 0.8f * unifiedRandom.NextFloat());
					}
					color34 = color35;
					float num168 = num165 / (float)ProjectileID.Sets.TrailCacheLength[proj.type];
					num168 = Utils.GetLerpValue(0f, (float)ProjectileID.Sets.TrailCacheLength[proj.type] * 0.75f, num165, clamped: true);
					color34 *= num168;
					vector32 += unifiedRandom.NextVector2Circular(8f, 8f);
				}
				if (proj.type == 976)
				{
					int num169 = value14.Height + 2;
					value14.Y += num169;
					value14.Y %= num169 * 7;
					color34 *= Lighting.GetColor((vector32 + zero + proj.Size / 2f).ToTileCoordinates()).ToVector3().Length() / 1.74f;
				}
				if (proj.type == 933 || proj.type == 1100)
				{
					float t = proj.localAI[0] - (float)num159;
					float num170 = Utils.GetLerpValue(0f, 20f, t, clamped: true) * Utils.GetLerpValue(68f, 60f, t, clamped: true);
					float lerpValue3 = Utils.GetLerpValue(0f, ProjectileID.Sets.TrailCacheLength[proj.type], num165, clamped: true);
					color34 = Microsoft.Xna.Framework.Color.White * lerpValue3 * proj.Opacity * num170;
				}
				Vector2 position4 = vector32 + zero + proj.Size / 2f - screenPosition + new Vector2(0f, proj.gfxOffY);
				EntitySpriteDraw(value12, position4, value14, color34, num166 + num152 + proj.rotation * num158 * (float)(num159 - 1) * (float)(-((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt()), origin7, MathHelper.Lerp(proj.scale, value13, (float)num159 / num157), spriteEffects);
			}
			if (proj.type == 661)
			{
				Microsoft.Xna.Framework.Color color36 = new Microsoft.Xna.Framework.Color(120, 40, 222, 120);
				for (int num171 = 0; num171 < 4; num171++)
				{
					EntitySpriteDraw(TextureAssets.Extra[75].Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI / 2f * (float)num171) * 4f, rectangle4, color36, proj.rotation, origin7, proj.scale, dir);
				}
			}
			if (proj.type == 864)
			{
				Microsoft.Xna.Framework.Color floatingDaggerMinionGlowColor = proj.GetFloatingDaggerMinionGlowColor();
				floatingDaggerMinionGlowColor.A /= 4;
				Microsoft.Xna.Framework.Rectangle value16 = rectangle4;
				value16.Y += value16.Height;
				for (int num172 = 0; num172 < 4; num172++)
				{
					EntitySpriteDraw(value12, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI / 2f * (float)num172) * 2f, value16, floatingDaggerMinionGlowColor, proj.rotation, origin7, proj.scale, dir);
				}
			}
			if (proj.type == 873 || proj.type == 931 || proj.type == 1039)
			{
				Microsoft.Xna.Framework.Color color37 = proj.AI_171_GetColor() * 0.5f;
				color37.A = 0;
				if (proj.type == 931)
				{
					color37 = proj.GetFairyQueenWeaponsColor(0f);
				}
				if (proj.type == 1039)
				{
					color37 = proj.GetConstellationColor(0f);
				}
				Vector2 vector33 = proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY);
				EntitySpriteDraw(value12, vector33, rectangle4, color37, proj.rotation, origin7, proj.scale * 0.9f, dir);
				Texture2D value17 = TextureAssets.Extra[98].Value;
				Microsoft.Xna.Framework.Color color38 = color37;
				Vector2 origin8 = value17.Size() / 2f;
				Microsoft.Xna.Framework.Color color39 = color37 * 0.5f;
				float num173 = Utils.GetLerpValue(15f, 30f, proj.timeLeft, clamped: true) * Utils.GetLerpValue(240f, 200f, proj.timeLeft, clamped: true) * (1f + 0.2f * (float)Math.Cos(GlobalTimeWrappedHourly % 30f / 0.5f * ((float)Math.PI * 2f) * 3f)) * 0.8f;
				Vector2 position5 = vector33 + proj.velocity.SafeNormalize(Vector2.Zero) * MathHelper.Lerp(0.5f, 1f, proj.localAI[0] / 60f);
				Vector2 vector34 = new Vector2(0.5f, 5f) * num173;
				Vector2 vector35 = new Vector2(0.5f, 2f) * num173;
				color38 *= num173;
				color39 *= num173;
				if (proj.type == 931 || proj.type == 1039)
				{
					vector34 *= 0.4f;
					vector35 *= 0.4f;
				}
				EntitySpriteDraw(value17, position5, null, color38, (float)Math.PI / 2f, origin8, vector34, dir);
				EntitySpriteDraw(value17, position5, null, color38, 0f, origin8, vector35, dir);
				EntitySpriteDraw(value17, position5, null, color39, (float)Math.PI / 2f, origin8, vector34 * 0.6f, dir);
				EntitySpriteDraw(value17, position5, null, color39, 0f, origin8, vector35 * 0.6f, dir);
			}
			if (proj.type == 755)
			{
				Microsoft.Xna.Framework.Color color40 = proj.AI_156_GetColor();
				color40.A = 120;
				for (int num174 = 0; num174 < 4; num174++)
				{
					EntitySpriteDraw(value12, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI / 2f * (float)num174) * 2f, rectangle4, color40, proj.rotation, origin7, proj.scale, dir);
				}
			}
			else if (proj.type == 684)
			{
				float x10 = (proj.localAI[0] * ((float)Math.PI * 2f) / 30f).ToRotationVector2().X;
				Microsoft.Xna.Framework.Color color41 = new Microsoft.Xna.Framework.Color(220, 40, 30, 40);
				color41 *= 0.75f + 0.25f * x10;
				for (int num175 = 0; num175 < 8; num175++)
				{
					EntitySpriteDraw(value12, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI / 4f * (float)num175) * (4f + 1f * x10), rectangle4, color41, proj.rotation, origin7, proj.scale, dir);
				}
			}
			else if (ProjectileID.Sets.IsAGolfBall[proj.type])
			{
				Player player3 = player;
				bool flag27 = GolfHelper.IsPlayerHoldingClub(player3);
				bool flag28 = false;
				if (flag27)
				{
					flag28 |= player3.ownedProjectileCounts[722] > 0 && player3.itemAnimation >= player3.itemAnimationMax;
					flag28 |= player3.itemAnimation == 0;
					flag28 &= player3.velocity.Y == 0f;
				}
				Vector2 shotVector = MouseWorld - proj.Center;
				if (proj.owner == myPlayer && flag27 && flag28 && GolfHelper.IsGolfBallResting(proj) && GolfHelper.ValidateShot(proj, player3, ref shotVector))
				{
					projectileColor = Microsoft.Xna.Framework.Color.White;
					Projectile projectile = null;
					for (int num176 = 0; num176 < 1000; num176++)
					{
						Projectile projectile2 = Main.projectile[num176];
						if (projectile2.active && projectile2.owner == player3.whoAmI && projectile2.type == 722)
						{
							projectile = projectile2;
							break;
						}
					}
					if (projectile != null)
					{
						GolfHelper.ShotStrength shotStrength = GolfHelper.CalculateShotStrength(projectile, proj);
						Vector2 impactVelocity = Vector2.Normalize(shotVector) * shotStrength.AbsoluteStrength;
						if (impactVelocity.Length() > 0.05f)
						{
							GolfHelper.DrawPredictionLine(proj, impactVelocity, shotStrength.RelativeStrength, shotStrength.RoughLandResistance);
						}
					}
				}
				if (!GolfHelper.IsGolfBallResting(proj))
				{
					Microsoft.Xna.Framework.Color golfTrailColor = Projectile.GetGolfTrailColor(proj);
					float num177 = proj.velocity.Length() / 16f;
					if (num177 > 1f)
					{
						num177 = 1f;
					}
					golfTrailColor *= num177;
					if (proj.oldPos[4] != Vector2.Zero)
					{
						projectileColor = Microsoft.Xna.Framework.Color.White;
						for (float num178 = 0f; num178 <= 1f; num178 += 0.04f)
						{
							EntitySpriteDraw(value12, Vector2.Lerp(proj.oldPos[4], proj.position, num178) + proj.Size / 2f - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, golfTrailColor * num178, proj.rotation, origin7, proj.scale * MathHelper.Lerp(0.7f, 1.5f, num178), dir);
						}
					}
					EntitySpriteDraw(value12, proj.position + proj.Size / 2f - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, golfTrailColor, proj.rotation, origin7, proj.scale * 1.5f, dir);
				}
			}
			else if (proj.type == 1049)
			{
				DrawProjWithStarryTrail(proj, player, projectileColor, dir);
			}
			if (proj.type == 964 || proj.type == 965)
			{
				Microsoft.Xna.Framework.Color color42 = Microsoft.Xna.Framework.Color.Violet;
				if (proj.type == 965)
				{
					color42 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Red, Microsoft.Xna.Framework.Color.White, 0.5f);
				}
				Microsoft.Xna.Framework.Color color43 = color42 * 0.5f * proj.Opacity;
				float num179 = ((proj.type == 964) ? 60 : 30);
				for (int num180 = 0; num180 < 4; num180++)
				{
					EntitySpriteDraw(value12, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) + proj.rotation.ToRotationVector2().RotatedBy(proj.ai[0] / num179 * ((float)Math.PI * 2f) + (float)Math.PI / 2f * (float)num180) * 6f, rectangle4, color43, proj.rotation, origin7, proj.scale, dir);
				}
			}
			Microsoft.Xna.Framework.Color color44 = proj.GetAlpha(projectileColor);
			float num181 = proj.scale;
			float rotation23 = proj.rotation + num152;
			if (proj.type == 640)
			{
				color44 = Microsoft.Xna.Framework.Color.Transparent;
			}
			if (proj.type == 684)
			{
				color44.A = 127;
			}
			if (proj.type == 873)
			{
				color44.A /= 2;
			}
			if (proj.type == 931 || proj.type == 1039)
			{
				color44.A /= 2;
			}
			if (proj.type == 872)
			{
				color44 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * proj.Opacity;
				num181 *= 0.9f;
			}
			if (proj.type == 818)
			{
				color44 = Microsoft.Xna.Framework.Color.Transparent;
			}
			if (proj.type == 916)
			{
				color44 = Microsoft.Xna.Framework.Color.Black;
			}
			if (proj.type == 964 || proj.type == 965)
			{
				color44 = Microsoft.Xna.Framework.Color.Black * proj.Opacity;
			}
			if (proj.type == 933 || proj.type == 1100)
			{
				float t2 = proj.localAI[0];
				float num182 = Utils.GetLerpValue(0f, 20f, t2, clamped: true) * Utils.GetLerpValue(68f, 60f, t2, clamped: true);
				color44 *= num182;
			}
			EntitySpriteDraw(value12, proj.Center + zero - screenPosition + new Vector2(0f, proj.gfxOffY + (float)num143), rectangle4, color44, rotation23, origin7, num181, dir);
			if (proj.type == 894)
			{
				float num183 = Utils.WrappedLerp(0.6f, 1f, (float)((int)timeForVisualEffects % 70) / 70f);
				EntitySpriteDraw(color: new Microsoft.Xna.Framework.Color(num183, num183, num183, 150f), texture: TextureAssets.GlowMask[282].Value, position: proj.Center + zero - screenPosition + new Vector2(0f, proj.gfxOffY), sourceRectangle: rectangle4, rotation: proj.rotation, origin: origin7, scale: proj.scale, effects: dir);
			}
			if (proj.type == 503)
			{
				EntitySpriteDraw(TextureAssets.Extra[36].Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, Microsoft.Xna.Framework.Color.White, proj.localAI[0], origin7, proj.scale, dir);
			}
			else if (proj.type == 533)
			{
				EntitySpriteDraw(TextureAssets.GlowMask[128].Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, Microsoft.Xna.Framework.Color.White * 0.3f, proj.rotation, origin7, proj.scale, dir);
			}
			else if (proj.type == 261)
			{
				float num184 = 0.7f;
				float num185 = proj.velocity.Length();
				if (num185 < 0.3f && proj.velocity.Y == 0f)
				{
					num184 = Utils.GetLerpValue(0.02f, 0.3f, num185, clamped: true) * 0.7f;
				}
				EntitySpriteDraw(TextureAssets.GlowMask[252].Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, Microsoft.Xna.Framework.Color.White * num184, proj.rotation, origin7, proj.scale, dir);
			}
			else if (proj.type == 601)
			{
				Microsoft.Xna.Framework.Color white2 = Microsoft.Xna.Framework.Color.White;
				white2.A = 0;
				EntitySpriteDraw(value12, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, white2, proj.rotation, origin7, proj.scale * 0.7f, dir);
			}
			else if (ProjectileID.Sets.IsAGolfBall[proj.type] && GolfHelper.IsGolfBallResting(proj) && GolfHelper.IsPlayerHoldingClub(LocalPlayer) && GolfHelper.IsGolfShotValid(proj, LocalPlayer) && proj.owner == myPlayer)
			{
				EntitySpriteDraw(TextureAssets.GolfBallOutline.Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, Microsoft.Xna.Framework.Color.White, proj.rotation, origin7, proj.scale, dir);
			}
			if (proj.type == 933 || proj.type == 1100)
			{
				float t3 = proj.localAI[0];
				float num186 = Utils.GetLerpValue(0f, 20f, t3, clamped: true) * Utils.GetLerpValue(68f, 60f, t3, clamped: true);
				EntitySpriteDraw(value12, proj.Center + zero - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle4, new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * proj.Opacity * num186, rotation23, origin7, num181 * 1.25f, dir);
				FinalFractalHelper.FinalFractalProfile finalFractalProfile = FinalFractalHelper.GetFinalFractalProfile((int)proj.ai[1]);
				Microsoft.Xna.Framework.Color trailColor = finalFractalProfile.trailColor;
				trailColor.A /= 2;
				DrawPrettyStarSparkle(proj.Opacity, dir, proj.Center + zero - screenPosition + new Vector2(0f, proj.gfxOffY) + (proj.rotation - (float)Math.PI / 2f).ToRotationVector2() * finalFractalProfile.trailWidth, Microsoft.Xna.Framework.Color.White * num186, trailColor * num186, proj.localAI[0], 15f, 30f, 30f, 45f, 0f, new Vector2(5f, 2f), Vector2.One);
			}
		}
		else if (proj.type == 672)
		{
			Vector2 position6 = proj.Center - screenPosition;
			if (proj.localAI[1] == 0f)
			{
				position6.Y += 60f;
				float num187 = proj.localAI[0] / 120f;
				for (int num188 = 0; num188 < 4; num188++)
				{
					float value18 = num187 * 2f - (float)num188 / 3f;
					value18 = MathHelper.Clamp(value18, 0f, 1f);
					float num189 = 1f - MathHelper.Clamp((num187 - 0.8f) / 0.2f, 0f, 1f);
					EntitySpriteDraw(TextureAssets.MagicPixel.Value, position6, null, new Microsoft.Xna.Framework.Color(0.4f, 0.17f, 0.4f, 0f) * (value18 * num189) * 1.3f, 0f, new Vector2((float)TextureAssets.MagicPixel.Width() / 2f, TextureAssets.MagicPixel.Height()), new Vector2((float)Math.Sqrt(value18) * 100f, value18 * 2f), SpriteEffects.None);
				}
			}
			else if (proj.localAI[1] == 1f)
			{
				_ = proj.localAI[0] / 300f;
				float num190 = Math.Min(1f, proj.localAI[0] / 30f);
				int num191 = (int)(GlobalTimeWrappedHourly * 10f) % 8;
				DrawElderEye(spriteBatch, proj.Center, 1f, 1f, num191, Microsoft.Xna.Framework.Color.White * num190);
				DrawElderEye(spriteBatch, proj.Center, 1f, 1f, (num191 + 1) % 8, new Microsoft.Xna.Framework.Color(0.2f, 0.2f, 0.2f, 0f) * num190);
			}
			else if (proj.localAI[1] == 2f)
			{
				int num192 = (int)(GlobalTimeWrappedHourly * 10f) % 8;
				DrawElderEye(spriteBatch, proj.Center, 1f, 1f, num192, Microsoft.Xna.Framework.Color.White);
				DrawElderEye(spriteBatch, proj.Center, 1f, 1f, (num192 + 1) % 8, new Microsoft.Xna.Framework.Color(0.2f, 0.2f, 0.2f, 0f));
			}
		}
		else
		{
			if (proj.type == 713)
			{
				return;
			}
			if (proj.type == 754)
			{
				Texture2D value19 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle rectangle5 = value19.Frame(5, 2, proj.frame);
				rectangle5.Width -= 2;
				rectangle5.Height -= 2;
				Vector2 origin9 = new Vector2(rectangle5.Width / 2, 0f);
				float y11 = proj.position.Y;
				float num193 = proj.ai[0] + 8f + 2f - (float)rectangle5.Height + 2f;
				Microsoft.Xna.Framework.Color alpha2 = proj.GetAlpha(projectileColor);
				Vector2 top = proj.Top;
				if (proj.ai[1] == 2f)
				{
					rectangle5 = value19.Frame(5, 2, 4);
					rectangle5.Width -= 2;
					rectangle5.Height -= 2;
					origin9 = new Vector2(rectangle5.Width / 2, 0f);
					alpha2 = proj.GetAlpha(Lighting.GetColor((int)(top.X + (float)(rectangle5.Width / 2)) / 16, (int)((num193 - 2f + (float)(rectangle5.Height / 2)) / 16f)));
					EntitySpriteDraw(value19, new Vector2(top.X, num193 - 2f) - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle5, alpha2, proj.rotation, origin9, proj.scale, dir);
					return;
				}
				for (float num194 = y11; num194 < num193; num194 += (float)rectangle5.Height)
				{
					Vector2 vector36 = top;
					vector36.Y = num194;
					Microsoft.Xna.Framework.Rectangle value20 = rectangle5;
					float num195 = num193 - num194;
					if (num195 < (float)value20.Height)
					{
						value20.Height = (int)num195;
					}
					alpha2 = proj.GetAlpha(Lighting.GetColor((int)(vector36.X + (float)(value20.Width / 2)) / 16, (int)((vector36.Y + (float)(value20.Height / 2)) / 16f)));
					EntitySpriteDraw(value19, vector36 - screenPosition + new Vector2(0f, proj.gfxOffY), value20, alpha2, proj.rotation, origin9, proj.scale, dir);
					if (rectangle5.Y == 0)
					{
						rectangle5.Y += rectangle5.Height + 2;
					}
				}
				rectangle5 = value19.Frame(5, 2, 4);
				rectangle5.Width -= 2;
				rectangle5.Height -= 2;
				origin9 = new Vector2(rectangle5.Width / 2, 0f);
				alpha2 = proj.GetAlpha(Lighting.GetColor((int)(top.X + (float)(rectangle5.Width / 2)) / 16, (int)((num193 - 2f + (float)(rectangle5.Height / 2)) / 16f)));
				EntitySpriteDraw(value19, new Vector2(top.X, num193 - 2f) - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle5, alpha2, proj.rotation, origin9, proj.scale, dir);
				return;
			}
			if (proj.type == 12 || proj.type == 728 || proj.type == 955)
			{
				Texture2D value21 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle rectangle6 = new Microsoft.Xna.Framework.Rectangle(0, 0, value21.Width, value21.Height);
				Vector2 origin10 = rectangle6.Size() / 2f;
				Microsoft.Xna.Framework.Color alpha3 = proj.GetAlpha(projectileColor);
				Texture2D value22 = TextureAssets.Extra[91].Value;
				Microsoft.Xna.Framework.Rectangle value23 = value22.Frame();
				Vector2 origin11 = new Vector2((float)value23.Width / 2f, 10f);
				Vector2 vector37 = new Vector2(0f, proj.gfxOffY);
				Vector2 spinningpoint = new Vector2(0f, -10f);
				float num196 = (float)timeForVisualEffects / 60f;
				Vector2 vector38 = proj.Center + proj.velocity;
				Microsoft.Xna.Framework.Color color45 = Microsoft.Xna.Framework.Color.Blue * 0.2f;
				Microsoft.Xna.Framework.Color color46 = Microsoft.Xna.Framework.Color.White * 0.5f;
				color46.A = 0;
				float num197 = 0f;
				if (tenthAnniversaryWorld)
				{
					color45 = Microsoft.Xna.Framework.Color.HotPink * 0.3f;
					color46 = Microsoft.Xna.Framework.Color.White * 0.75f;
					color46.A = 0;
					num197 = -0.1f;
				}
				if (proj.type == 728)
				{
					color45 = Microsoft.Xna.Framework.Color.Orange * 0.2f;
					color46 = Microsoft.Xna.Framework.Color.Gold * 0.5f;
					color46.A = 50;
					num197 = -0.2f;
				}
				Microsoft.Xna.Framework.Color color47 = color45;
				color47.A = 0;
				Microsoft.Xna.Framework.Color color48 = color45;
				color48.A = 0;
				Microsoft.Xna.Framework.Color color49 = color45;
				color49.A = 0;
				EntitySpriteDraw(value22, vector38 - screenPosition + vector37 + spinningpoint.RotatedBy((float)Math.PI * 2f * num196), value23, color47, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin11, 1.5f + num197, SpriteEffects.None);
				EntitySpriteDraw(value22, vector38 - screenPosition + vector37 + spinningpoint.RotatedBy((float)Math.PI * 2f * num196 + (float)Math.PI * 2f / 3f), value23, color48, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin11, 1.1f + num197, SpriteEffects.None);
				EntitySpriteDraw(value22, vector38 - screenPosition + vector37 + spinningpoint.RotatedBy((float)Math.PI * 2f * num196 + 4.1887903f), value23, color49, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin11, 1.3f + num197, SpriteEffects.None);
				Vector2 vector39 = proj.Center - proj.velocity * 0.5f;
				for (float num198 = 0f; num198 < 1f; num198 += 0.5f)
				{
					float num199 = num196 % 0.5f / 0.5f;
					num199 = (num199 + num198) % 1f;
					float num200 = num199 * 2f;
					if (num200 > 1f)
					{
						num200 = 2f - num200;
					}
					EntitySpriteDraw(value22, vector39 - screenPosition + vector37, value23, color46 * num200, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin11, 0.3f + num199 * 0.5f, SpriteEffects.None);
				}
				EntitySpriteDraw(value21, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle6, alpha3, proj.rotation, origin10, proj.scale + 0.1f, dir);
				return;
			}
			if (proj.type == 756)
			{
				Texture2D value24 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle value25 = value24.Frame(1, 6, 0, proj.frame);
				Vector2 origin12 = new Vector2(16f, value25.Height / 2);
				Microsoft.Xna.Framework.Color alpha4 = proj.GetAlpha(projectileColor);
				Vector2 scale2 = new Vector2(proj.scale);
				float lerpValue4 = Utils.GetLerpValue(35f, 35f - 5f, proj.ai[0], clamped: true);
				scale2.Y *= lerpValue4;
				Vector4 vector40 = projectileColor.ToVector4();
				Vector4 vector41 = new Microsoft.Xna.Framework.Color(67, 17, 17).ToVector4();
				vector41 *= vector40;
				EntitySpriteDraw(TextureAssets.Extra[98].Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) - proj.velocity * proj.scale * 0.5f, null, proj.GetAlpha(new Microsoft.Xna.Framework.Color(vector41.X, vector41.Y, vector41.Z, vector41.W)) * 1f, proj.rotation + (float)Math.PI / 2f, TextureAssets.Extra[98].Value.Size() / 2f, proj.scale * 0.9f, dir);
				EntitySpriteDraw(value24, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), value25, alpha4, proj.rotation, origin12, scale2, dir);
				return;
			}
			if (proj.type == 961)
			{
				Texture2D value26 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle value27 = value26.Frame(1, 5, 0, proj.frame);
				Vector2 origin13 = new Vector2(16f, value27.Height / 2);
				Microsoft.Xna.Framework.Color alpha5 = proj.GetAlpha(projectileColor);
				Vector2 vector42 = new Vector2(proj.scale);
				float lerpValue5 = Utils.GetLerpValue(30f, 25f, proj.ai[0], clamped: true);
				vector42.Y *= lerpValue5;
				Vector4 vector43 = projectileColor.ToVector4();
				Vector4 vector44 = new Microsoft.Xna.Framework.Color(67, 17, 17).ToVector4();
				vector44 *= vector43;
				EntitySpriteDraw(TextureAssets.Extra[98].Value, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) - proj.velocity * proj.scale * 0.5f, null, proj.GetAlpha(new Microsoft.Xna.Framework.Color(vector44.X, vector44.Y, vector44.Z, vector44.W)) * 1f, proj.rotation + (float)Math.PI / 2f, TextureAssets.Extra[98].Value.Size() / 2f, proj.scale * 0.9f, dir);
				Microsoft.Xna.Framework.Color color50 = proj.GetAlpha(Microsoft.Xna.Framework.Color.White) * Utils.Remap(proj.ai[0], 0f, 20f, 0.5f, 0f);
				color50.A = 0;
				for (int num201 = 0; num201 < 4; num201++)
				{
					EntitySpriteDraw(value26, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY) + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI / 2f * (float)num201) * 2f * vector42, value27, color50, proj.rotation, origin13, vector42, dir);
				}
				EntitySpriteDraw(value26, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), value27, alpha5, proj.rotation, origin13, vector42, dir);
				return;
			}
			if (proj.type == 1041)
			{
				Texture2D value28 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle value29 = value28.Frame(1, 8, 0, proj.frame);
				Vector2 origin14 = new Vector2(16f, value29.Height / 2);
				Microsoft.Xna.Framework.Color alpha6 = proj.GetAlpha(projectileColor);
				Vector2 scale3 = new Vector2(proj.scale);
				float lerpValue6 = Utils.GetLerpValue(30f, 25f, proj.ai[0], clamped: true);
				scale3.Y *= lerpValue6;
				Vector4 vector45 = projectileColor.ToVector4();
				_ = new Microsoft.Xna.Framework.Color(67, 17, 17).ToVector4() * vector45;
				float num202 = Utils.Remap(proj.ai[0], 0f, 17f, 1f, 0f);
				Microsoft.Xna.Framework.Color color51 = proj.GetAlpha(Microsoft.Xna.Framework.Color.White) * num202;
				color51.A = 0;
				EntitySpriteDraw(value28, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), value29, alpha6, proj.rotation, origin14, scale3, dir);
				return;
			}
			if (proj.type == 723 || proj.type == 726 || proj.type == 725 || proj.type == 724 || proj.type == 9)
			{
				Texture2D value30 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle rectangle7 = new Microsoft.Xna.Framework.Rectangle(0, 0, value30.Width, value30.Height);
				Vector2 origin15 = rectangle7.Size() / 2f;
				Microsoft.Xna.Framework.Color color52 = proj.GetAlpha(projectileColor);
				Texture2D value31 = TextureAssets.Extra[91].Value;
				Microsoft.Xna.Framework.Rectangle value32 = value31.Frame();
				Vector2 origin16 = new Vector2((float)value32.Width / 2f, 10f);
				_ = Microsoft.Xna.Framework.Color.White * 0.2f;
				Vector2 vector46 = new Vector2(0f, proj.gfxOffY);
				Vector2 spinningpoint2 = new Vector2(0f, -5f);
				float num203 = (float)timeForVisualEffects / 60f;
				Vector2 vector47 = proj.Center + proj.velocity;
				float num204 = 1.5f;
				float num205 = 1.1f;
				float num206 = 1.3f;
				Microsoft.Xna.Framework.Color color53 = Microsoft.Xna.Framework.Color.Blue * 0.1f;
				Microsoft.Xna.Framework.Color color54 = Microsoft.Xna.Framework.Color.White * 0.3f;
				color54.A = 0;
				byte a = 0;
				float num207 = 1f;
				bool flag29 = true;
				float num208 = proj.scale + 0.1f;
				if (proj.type == 726)
				{
					Microsoft.Xna.Framework.Color color55 = new Microsoft.Xna.Framework.Color(180, 20, 255);
					color53 = color55 * 0.3f;
					color54 = color55 * 0.3f;
					a = 60;
					float num209 = 0.6f;
					num204 -= num209;
					num205 -= num209;
					num206 -= num209;
				}
				if (proj.type == 725)
				{
					Microsoft.Xna.Framework.Color value33 = new Microsoft.Xna.Framework.Color(255, 80, 255);
					Microsoft.Xna.Framework.Color value34 = new Microsoft.Xna.Framework.Color(255, 255, 0);
					color53 = Microsoft.Xna.Framework.Color.Lerp(value33, value34, 0.2f) * 0.3f;
					color54 = Microsoft.Xna.Framework.Color.Lerp(value33, value34, 0.8f) * 0.4f;
					a = 50;
					float num210 = 0.5f;
					num204 -= num210;
					num205 -= num210;
					num206 -= num210;
				}
				if (proj.type == 724)
				{
					Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Black, Microsoft.Xna.Framework.Color.Orange, 0.75f);
					Microsoft.Xna.Framework.Color color56 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Black, Microsoft.Xna.Framework.Color.Yellow, 0.5f);
					Microsoft.Xna.Framework.Color value35 = Microsoft.Xna.Framework.Color.Orange * 0.75f;
					color56 = Microsoft.Xna.Framework.Color.Yellow * 0.5f;
					color53 = Microsoft.Xna.Framework.Color.Lerp(value35, color56, 0.2f) * 0.3f;
					color54 = Microsoft.Xna.Framework.Color.Lerp(value35, color56, 0.8f) * 0.4f;
					a = 0;
					float num211 = 0.5f;
					num204 -= num211;
					num205 -= num211;
					num206 -= num211;
				}
				if (proj.type == 9)
				{
					num204 = 0.9f;
					num205 = 0f;
					num206 = 0f;
					flag29 = false;
					spinningpoint2 = Vector2.Zero;
					vector46 += proj.velocity.SafeNormalize(Vector2.Zero) * 8f;
					num207 *= 0.75f;
					vector47 -= proj.velocity;
					Microsoft.Xna.Framework.Color value36 = new Microsoft.Xna.Framework.Color(194, 22, 134);
					value36 *= 0.75f;
					value36.A /= 2;
					Microsoft.Xna.Framework.Color value37 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Gold, Microsoft.Xna.Framework.Color.White, 0.5f);
					value37.A /= 4;
					value37 *= 0.85f;
					value37 *= 0.75f;
					Microsoft.Xna.Framework.Color gold = Microsoft.Xna.Framework.Color.Gold;
					gold.A = 180;
					Microsoft.Xna.Framework.Color value38 = new Microsoft.Xna.Framework.Color(194, 22, 134, 127);
					Microsoft.Xna.Framework.Color value39 = new Microsoft.Xna.Framework.Color(180, 20, 255) * 0.75f * 0.3f;
					Microsoft.Xna.Framework.Color value40 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f * 0.3f;
					float num212 = 0.5f;
					float num213 = proj.rotation * num212 % ((float)Math.PI * 2f);
					if (num213 < 0f)
					{
						num213 += (float)Math.PI * 2f;
					}
					num213 /= (float)Math.PI * 2f;
					float num214 = Utils.Remap(num213, 0.15f, 0.5f, 0f, 1f) * Utils.Remap(num213, 0.5f, 0.85f, 1f, 0f);
					num214 = 1f - num214;
					color52 = Microsoft.Xna.Framework.Color.Lerp(gold, value38, num214);
					color53 = Microsoft.Xna.Framework.Color.Lerp(value36, value39, num214);
					color54 = Microsoft.Xna.Framework.Color.Lerp(value37, value40, num214);
					num208 += num214 * 0.2f;
				}
				if (proj.type == 1037 || proj.type == 1049)
				{
					int num215 = 424 + Math.Max(0, Math.Min(2, (int)proj.ai[0]));
					instance.LoadProjectile(num215);
					value30 = TextureAssets.Projectile[num215].Value;
					rectangle7 = new Microsoft.Xna.Framework.Rectangle(0, 0, value30.Width, value30.Height);
					origin15 = rectangle7.Size() / 2f;
					num204 = 0.9f;
					num205 = 0f;
					num206 = 0f;
					flag29 = false;
					spinningpoint2 = Vector2.Zero;
					vector46 += proj.velocity.SafeNormalize(Vector2.Zero) * 8f;
					num207 *= 0.75f;
					vector47 -= proj.velocity;
					Microsoft.Xna.Framework.Color value41 = new Microsoft.Xna.Framework.Color(194, 134, 22);
					value41 *= 0.75f;
					value41.A /= 2;
					Microsoft.Xna.Framework.Color value42 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Gold, Microsoft.Xna.Framework.Color.White, 0.5f);
					value42.A /= 4;
					value42 *= 0.85f;
					value42 *= 0.75f;
					Microsoft.Xna.Framework.Color gold2 = Microsoft.Xna.Framework.Color.Gold;
					gold2.A = 180;
					Microsoft.Xna.Framework.Color value43 = new Microsoft.Xna.Framework.Color(255, 150, 150, 127);
					Microsoft.Xna.Framework.Color value44 = new Microsoft.Xna.Framework.Color(180, 140, 50) * 0.75f * 0.3f;
					Microsoft.Xna.Framework.Color value45 = new Microsoft.Xna.Framework.Color(255, 50, 50, 0) * 0.5f * 0.3f;
					float num216 = 0.5f;
					float num217 = proj.rotation * num216 % ((float)Math.PI * 2f);
					if (num217 < 0f)
					{
						num217 += (float)Math.PI * 2f;
					}
					num217 /= (float)Math.PI * 2f;
					float num218 = Utils.Remap(num217, 0.15f, 0.5f, 0f, 1f) * Utils.Remap(num217, 0.5f, 0.85f, 1f, 0f);
					num218 = 1f - num218;
					color52 = Microsoft.Xna.Framework.Color.Lerp(gold2, value43, num218);
					color53 = Microsoft.Xna.Framework.Color.Lerp(value41, value44, num218);
					color54 = Microsoft.Xna.Framework.Color.Lerp(value42, value45, num218);
					num208 += num218 * 0.2f;
				}
				Microsoft.Xna.Framework.Color color57 = color53;
				Microsoft.Xna.Framework.Color color58 = color53;
				Microsoft.Xna.Framework.Color color59 = color53;
				if (flag29)
				{
					color57.A = a;
					color58.A = a;
					color59.A = a;
				}
				EntitySpriteDraw(value31, vector47 - screenPosition + vector46 + spinningpoint2.RotatedBy((float)Math.PI * 2f * num203), value32, color57, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin16, num204, SpriteEffects.None);
				EntitySpriteDraw(value31, vector47 - screenPosition + vector46 + spinningpoint2.RotatedBy((float)Math.PI * 2f * num203 + (float)Math.PI * 2f / 3f), value32, color58, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin16, num205, SpriteEffects.None);
				EntitySpriteDraw(value31, vector47 - screenPosition + vector46 + spinningpoint2.RotatedBy((float)Math.PI * 2f * num203 + 4.1887903f), value32, color59, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin16, num206, SpriteEffects.None);
				Vector2 vector48 = proj.Center - proj.velocity * 0.5f;
				for (float num219 = 0f; num219 < 1f; num219 += 0.5f)
				{
					float num220 = num203 % 0.5f / 0.5f;
					num220 = (num220 + num219) % 1f;
					float num221 = num220 * 2f;
					if (num221 > 1f)
					{
						num221 = 2f - num221;
					}
					EntitySpriteDraw(value31, vector48 - screenPosition + vector46, value32, color54 * num221, proj.velocity.ToRotation() + (float)Math.PI / 2f, origin16, (0.5f + num220 * 0.5f) * num207, SpriteEffects.None);
				}
				EntitySpriteDraw(value30, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), rectangle7, color52, proj.rotation, origin15, num208, dir);
				return;
			}
			if (proj.type == 674)
			{
				Texture2D value46 = TextureAssets.Extra[60].Value;
				Vector2 origin17 = new Vector2(66f, 86f);
				Vector2 position7 = proj.Center - screenPosition;
				Vector2 one = Vector2.One;
				one = new Vector2(4f, 1f) * 1.4f;
				Microsoft.Xna.Framework.Color color60 = new Microsoft.Xna.Framework.Color(115, 0, 155, 0);
				Microsoft.Xna.Framework.Color color61 = new Microsoft.Xna.Framework.Color(255, 180, 255, 0);
				float num222 = 0f;
				if (proj.ai[0] < 30f)
				{
					num222 = Utils.GetLerpValue(0f, 30f, proj.ai[0], clamped: true);
				}
				else if (proj.ai[0] < 40f)
				{
					num222 = 1f + Utils.GetLerpValue(30f, 40f, proj.ai[0], clamped: true);
				}
				Vector2 vector49 = new Vector2(1f, 1f);
				Vector2 vector50 = new Vector2(0.8f, 2f);
				if (num222 < 1f)
				{
					vector49.X *= num222;
				}
				one *= num222;
				if (num222 < 1f)
				{
					color60 *= num222;
					color61 *= num222;
				}
				if (num222 > 1.5f)
				{
					float lerpValue7 = Utils.GetLerpValue(2f, 1.5f, num222, clamped: true);
					color60 *= lerpValue7;
					color61 *= lerpValue7;
				}
				float num223 = 0.42f;
				color60 *= num223;
				color61 *= num223;
				EntitySpriteDraw(value46, position7, null, color60, 0f, origin17, one * vector49, SpriteEffects.None);
				EntitySpriteDraw(value46, position7, null, color61, 0f, origin17, one * vector50, SpriteEffects.None);
				EntitySpriteDraw(TextureAssets.Extra[59].Value, position7, null, color60, 0f, origin17, one * vector49 * new Vector2(1f, 0.3f), SpriteEffects.None);
				return;
			}
			if (proj.type == 440 || proj.type == 449 || proj.type == 606)
			{
				Microsoft.Xna.Framework.Rectangle value47 = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X - 500, (int)screenPosition.Y - 500, screenWidth + 1000, screenHeight + 1000);
				if (proj.getRect().Intersects(value47))
				{
					Vector2 vector51 = new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY);
					float num224 = 100f;
					float num225 = 3f;
					if (proj.type == 606)
					{
						num224 = 150f;
						num225 = 3f;
					}
					if (proj.ai[1] == 1f)
					{
						num224 = (int)proj.localAI[0];
					}
					for (int num226 = 1; num226 <= (int)proj.localAI[0]; num226++)
					{
						Vector2 vector52 = Vector2.Normalize(proj.velocity) * num226 * num225;
						Microsoft.Xna.Framework.Color alpha7 = proj.GetAlpha(projectileColor);
						alpha7 *= (num224 - (float)num226) / num224;
						alpha7.A = 0;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, vector51 - vector52, null, alpha7, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					}
				}
				return;
			}
			if (proj.type == 85)
			{
				DrawProj_Flamethrower(proj);
				return;
			}
			if (proj.type == 1106)
			{
				DrawProj_Flamethrower_Foxsparks(proj, player);
				return;
			}
			if (proj.type == 687)
			{
				Vector2 center2 = proj.Center;
				center2 -= screenPosition;
				float num227 = 40f;
				float num228 = num227 * 2f;
				float num229 = (float)proj.frameCounter / num227;
				Texture2D value48 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Color transparent = Microsoft.Xna.Framework.Color.Transparent;
				Microsoft.Xna.Framework.Color color62 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
				Microsoft.Xna.Framework.Color color63 = new Microsoft.Xna.Framework.Color(180, 30, 30, 200);
				Microsoft.Xna.Framework.Color color64 = new Microsoft.Xna.Framework.Color(0, 0, 0, 30);
				ulong seed = 1uL;
				for (float num230 = 0f; num230 < 15f; num230 += 1f)
				{
					float num231 = Utils.RandomFloat(ref seed) * 0.25f - 0.125f;
					Vector2 vector53 = (proj.rotation + num231).ToRotationVector2();
					Vector2 value49 = center2 + vector53 * 400f;
					float num232 = num229 + num230 * (1f / 15f);
					int num233 = (int)(num232 / (1f / 15f));
					num232 %= 1f;
					if ((!(num232 > num229 % 1f) || !((float)proj.frameCounter < num227)) && (!(num232 < num229 % 1f) || !((float)proj.frameCounter >= num228 - num227)))
					{
						transparent = ((num232 < 0.1f) ? Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color62, Utils.GetLerpValue(0f, 0.1f, num232, clamped: true)) : ((num232 < 0.35f) ? color62 : ((num232 < 0.7f) ? Microsoft.Xna.Framework.Color.Lerp(color62, color63, Utils.GetLerpValue(0.35f, 0.7f, num232, clamped: true)) : ((num232 < 0.9f) ? Microsoft.Xna.Framework.Color.Lerp(color63, color64, Utils.GetLerpValue(0.7f, 0.9f, num232, clamped: true)) : ((!(num232 < 1f)) ? Microsoft.Xna.Framework.Color.Transparent : Microsoft.Xna.Framework.Color.Lerp(color64, Microsoft.Xna.Framework.Color.Transparent, Utils.GetLerpValue(0.9f, 1f, num232, clamped: true)))))));
						float num234 = 0.9f + num232 * 0.8f;
						num234 *= num234;
						num234 *= 0.8f;
						Vector2 position8 = Vector2.SmoothStep(center2, value49, num232);
						Microsoft.Xna.Framework.Rectangle rectangle8 = value48.Frame(1, 7, 0, (int)(num232 * 7f));
						EntitySpriteDraw(value48, position8, rectangle8, transparent, proj.rotation + (float)Math.PI * 2f * (num232 + GlobalTimeWrappedHourly * 1.2f) * 0.2f + (float)num233 * ((float)Math.PI * 2f / 5f), rectangle8.Size() / 2f, num234, SpriteEffects.None);
					}
				}
				return;
			}
			if (proj.type == 651)
			{
				if (proj.owner != myPlayer)
				{
					return;
				}
				Player player4 = player;
				Microsoft.Xna.Framework.Point point = new Vector2(proj.ai[0], proj.ai[1]).ToPoint();
				Microsoft.Xna.Framework.Point point2 = proj.Center.ToTileCoordinates();
				Microsoft.Xna.Framework.Color color65 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
				Microsoft.Xna.Framework.Color color66 = new Microsoft.Xna.Framework.Color(127, 127, 127, 0);
				int num235 = 1;
				float num236 = 0f;
				WiresUI.Settings.MultiToolMode toolMode = WiresUI.Settings.ToolMode;
				bool flag30 = (toolMode & WiresUI.Settings.MultiToolMode.Actuator) != 0;
				if ((toolMode & WiresUI.Settings.MultiToolMode.Red) != 0)
				{
					num236 += 1f;
					color66 = Microsoft.Xna.Framework.Color.Lerp(color66, Microsoft.Xna.Framework.Color.Red, 1f / num236);
				}
				if ((toolMode & WiresUI.Settings.MultiToolMode.Blue) != 0)
				{
					num236 += 1f;
					color66 = Microsoft.Xna.Framework.Color.Lerp(color66, Microsoft.Xna.Framework.Color.Blue, 1f / num236);
				}
				if ((toolMode & WiresUI.Settings.MultiToolMode.Green) != 0)
				{
					num236 += 1f;
					color66 = Microsoft.Xna.Framework.Color.Lerp(color66, new Microsoft.Xna.Framework.Color(0, 255, 0), 1f / num236);
				}
				if ((toolMode & WiresUI.Settings.MultiToolMode.Yellow) != 0)
				{
					num236 += 1f;
					color66 = Microsoft.Xna.Framework.Color.Lerp(color66, new Microsoft.Xna.Framework.Color(255, 255, 0), 1f / num236);
				}
				if ((toolMode & WiresUI.Settings.MultiToolMode.Cutter) != 0)
				{
					color65 = new Microsoft.Xna.Framework.Color(50, 50, 50, 255);
				}
				color66.A = 0;
				if (point == point2)
				{
					Vector2 position9 = point2.ToVector2() * 16f - screenPosition;
					Microsoft.Xna.Framework.Rectangle value50 = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16);
					if (flag30)
					{
						EntitySpriteDraw(TextureAssets.WireUi[11].Value, position9, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position9, value50, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					value50.Y = 18;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position9, value50, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					return;
				}
				if (point.X == point2.X)
				{
					int num237 = point2.Y - point.Y;
					int num238 = Math.Sign(num237);
					Vector2 position10 = point.ToVector2() * 16f - screenPosition;
					Microsoft.Xna.Framework.Rectangle value51 = new Microsoft.Xna.Framework.Rectangle((num237 * num235 > 0) ? 72 : 18, 0, 16, 16);
					if (flag30)
					{
						EntitySpriteDraw(TextureAssets.WireUi[11].Value, position10, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position10, value51, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					value51.Y = 18;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position10, value51, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					for (int num239 = point.Y + num238; num239 != point2.Y; num239 += num238)
					{
						position10 = new Vector2(point.X * 16, num239 * 16) - screenPosition;
						value51.Y = 0;
						value51.X = 90;
						if (flag30)
						{
							EntitySpriteDraw(TextureAssets.WireUi[11].Value, position10, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						}
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position10, value51, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						value51.Y = 18;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position10, value51, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					position10 = point2.ToVector2() * 16f - screenPosition;
					value51 = new Microsoft.Xna.Framework.Rectangle((num237 * num235 > 0) ? 18 : 72, 0, 16, 16);
					if (flag30)
					{
						EntitySpriteDraw(TextureAssets.WireUi[11].Value, position10, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position10, value51, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					value51.Y = 18;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position10, value51, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					return;
				}
				if (point.Y == point2.Y)
				{
					int num240 = point2.X - point.X;
					int num241 = Math.Sign(num240);
					Vector2 position11 = point.ToVector2() * 16f - screenPosition;
					Microsoft.Xna.Framework.Rectangle value52 = new Microsoft.Xna.Framework.Rectangle((num240 > 0) ? 36 : 144, 0, 16, 16);
					if (flag30)
					{
						EntitySpriteDraw(TextureAssets.WireUi[11].Value, position11, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position11, value52, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					value52.Y = 18;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position11, value52, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					for (int num242 = point.X + num241; num242 != point2.X; num242 += num241)
					{
						position11 = new Vector2(num242 * 16, point.Y * 16) - screenPosition;
						value52.Y = 0;
						value52.X = 180;
						if (flag30)
						{
							EntitySpriteDraw(TextureAssets.WireUi[11].Value, position11, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						}
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position11, value52, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						value52.Y = 18;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position11, value52, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					position11 = point2.ToVector2() * 16f - screenPosition;
					value52 = new Microsoft.Xna.Framework.Rectangle((num240 > 0) ? 144 : 36, 0, 16, 16);
					if (flag30)
					{
						EntitySpriteDraw(TextureAssets.WireUi[11].Value, position11, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position11, value52, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					value52.Y = 18;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position11, value52, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					return;
				}
				Math.Abs(point.X - point2.X);
				Math.Abs(point.Y - point2.Y);
				int num243 = Math.Sign(point2.X - point.X);
				int num244 = Math.Sign(point2.Y - point.Y);
				Microsoft.Xna.Framework.Point p = default(Microsoft.Xna.Framework.Point);
				bool flag31 = false;
				bool flag32 = player4.direction == 1;
				int num245;
				int num246;
				int num247;
				if (flag32)
				{
					p.X = point.X;
					num245 = point.Y;
					num246 = point2.Y;
					num247 = num244;
				}
				else
				{
					p.Y = point.Y;
					num245 = point.X;
					num246 = point2.X;
					num247 = num243;
				}
				Vector2 position12 = point.ToVector2() * 16f - screenPosition;
				Microsoft.Xna.Framework.Rectangle value53 = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16);
				if (!flag32)
				{
					value53.X = ((num247 > 0) ? 36 : 144);
				}
				else
				{
					value53.X = ((num247 > 0) ? 72 : 18);
				}
				if (flag30)
				{
					EntitySpriteDraw(TextureAssets.WireUi[11].Value, position12, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				}
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				value53.Y = 18;
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				for (int num248 = num245 + num247; num248 != num246; num248 += num247)
				{
					if (flag31)
					{
						break;
					}
					if (flag32)
					{
						p.Y = num248;
					}
					else
					{
						p.X = num248;
					}
					if (WorldGen.InWorld(p.X, p.Y, 1) && tile[p.X, p.Y] != null)
					{
						position12 = p.ToVector2() * 16f - screenPosition;
						value53.Y = 0;
						if (!flag32)
						{
							value53.X = 180;
						}
						else
						{
							value53.X = 90;
						}
						if (flag30)
						{
							EntitySpriteDraw(TextureAssets.WireUi[11].Value, position12, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						}
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						value53.Y = 18;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
				}
				if (flag32)
				{
					p.Y = point2.Y;
					num245 = point.X;
					num246 = point2.X;
					num247 = num243;
				}
				else
				{
					p.X = point2.X;
					num245 = point.Y;
					num246 = point2.Y;
					num247 = num244;
				}
				position12 = p.ToVector2() * 16f - screenPosition;
				value53 = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16);
				if (!flag32)
				{
					value53.X += ((num243 > 0) ? 144 : 36);
					value53.X += ((num244 * num235 > 0) ? 72 : 18);
				}
				else
				{
					value53.X += ((num243 > 0) ? 36 : 144);
					value53.X += ((num244 * num235 > 0) ? 18 : 72);
				}
				if (flag30)
				{
					EntitySpriteDraw(TextureAssets.WireUi[11].Value, position12, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				}
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				value53.Y = 18;
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				for (int num249 = num245 + num247; num249 != num246; num249 += num247)
				{
					if (flag31)
					{
						break;
					}
					if (!flag32)
					{
						p.Y = num249;
					}
					else
					{
						p.X = num249;
					}
					if (WorldGen.InWorld(p.X, p.Y, 1) && tile[p.X, p.Y] != null)
					{
						position12 = p.ToVector2() * 16f - screenPosition;
						value53.Y = 0;
						if (!flag32)
						{
							value53.X = 90;
						}
						else
						{
							value53.X = 180;
						}
						if (flag30)
						{
							EntitySpriteDraw(TextureAssets.WireUi[11].Value, position12, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						}
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
						value53.Y = 18;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
					}
				}
				position12 = point2.ToVector2() * 16f - screenPosition;
				value53 = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16);
				if (!flag32)
				{
					value53.X += ((num244 * num235 > 0) ? 18 : 72);
				}
				else
				{
					value53.X += ((num243 > 0) ? 144 : 36);
				}
				if (flag30)
				{
					EntitySpriteDraw(TextureAssets.WireUi[11].Value, position12, null, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				}
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color66, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				value53.Y = 18;
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, position12, value53, color65, 0f, Vector2.Zero, 1f, SpriteEffects.None);
				return;
			}
			if (proj.type == 586)
			{
				float num250 = 300f;
				if (proj.ai[0] >= 100f)
				{
					num250 = MathHelper.Lerp(300f, 600f, (proj.ai[0] - 100f) / 200f);
				}
				if (num250 > 600f)
				{
					num250 = 600f;
				}
				if (proj.ai[0] >= 500f)
				{
					num250 = MathHelper.Lerp(600f, 1200f, (proj.ai[0] - 500f) / 100f);
				}
				float rotation24 = proj.rotation;
				Texture2D value54 = TextureAssets.Projectile[proj.type].Value;
				int num251 = (int)(proj.ai[0] / 6f);
				Vector2 spinningpoint3 = new Vector2(0f, 0f - num250);
				for (int num252 = 0; (float)num252 < 10f; num252++)
				{
					Microsoft.Xna.Framework.Rectangle rectangle9 = value54.Frame(1, 5, 0, (num251 + num252) % 5);
					float num253 = rotation24 + (float)Math.PI / 5f * (float)num252;
					Vector2 vector54 = spinningpoint3.RotatedBy(num253) / 3f + proj.Center;
					Microsoft.Xna.Framework.Color alpha8 = proj.GetAlpha(Lighting.GetColor(vector54.ToTileCoordinates()));
					alpha8.A /= 2;
					EntitySpriteDraw(value54, vector54 - screenPosition, rectangle9, alpha8, num253, rectangle9.Size() / 2f, proj.scale, SpriteEffects.None);
				}
				for (int num254 = 0; (float)num254 < 20f; num254++)
				{
					Microsoft.Xna.Framework.Rectangle rectangle10 = value54.Frame(1, 5, 0, (num251 + num254) % 5);
					float num255 = 0f - rotation24 + (float)Math.PI / 10f * (float)num254;
					num255 *= 2f;
					Vector2 vector55 = spinningpoint3.RotatedBy(num255) + proj.Center;
					Microsoft.Xna.Framework.Color alpha8 = proj.GetAlpha(Lighting.GetColor(vector55.ToTileCoordinates()));
					alpha8.A /= 2;
					EntitySpriteDraw(value54, vector55 - screenPosition, rectangle10, alpha8, num255, rectangle10.Size() / 2f, proj.scale, SpriteEffects.None);
				}
				return;
			}
			if (proj.type == 536 || proj.type == 607)
			{
				Texture2D value55 = TextureAssets.Projectile[proj.type].Value;
				Vector2 position13 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				EntitySpriteDraw(scale: new Vector2(1f, proj.velocity.Length() / (float)value55.Height), texture: value55, position: position13, sourceRectangle: null, color: proj.GetAlpha(projectileColor), rotation: proj.rotation, origin: value55.Frame().Bottom(), effects: dir);
				return;
			}
			if (proj.type == 591)
			{
				Texture2D value56 = TextureAssets.Projectile[proj.type].Value;
				Vector2 position14 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Vector2 scale4 = new Vector2(1f, proj.velocity.Length() / (float)value56.Height);
				LoadNPC(139);
				Texture2D value57 = TextureAssets.Npc[139].Value;
				bool num256 = proj.velocity.X >= 0f;
				float rotation25 = proj.velocity.ToRotation() + (float)Math.PI;
				SpriteEffects effects2 = (num256 ? SpriteEffects.FlipVertically : SpriteEffects.None);
				float fromValue = 1f - proj.Opacity;
				float num257 = Utils.Remap(fromValue, 0f, 0.2f, 0f, 1f) * Utils.Remap(fromValue, 0.2f, 1f, 1f, 0f);
				EntitySpriteDraw(value57, position14, null, projectileColor * num257, rotation25, value57.Size() / 2f, 0.65f, effects2);
				Microsoft.Xna.Framework.Color color67 = new Microsoft.Xna.Framework.Color(255, 189, 163, 127) * num257;
				Microsoft.Xna.Framework.Color color68 = new Microsoft.Xna.Framework.Color(255, 21, 21, 127) * num257;
				Microsoft.Xna.Framework.Rectangle rectangle11 = value56.Frame(2);
				Vector2 origin18 = rectangle11.Bottom();
				EntitySpriteDraw(value56, position14, rectangle11, color67, proj.rotation, origin18, scale4, dir);
				rectangle11 = value56.Frame(2, 1, 1);
				EntitySpriteDraw(value56, position14, rectangle11, color68, proj.rotation, origin18, scale4, dir);
				return;
			}
			if (proj.type == 688 || proj.type == 689 || proj.type == 690)
			{
				Texture2D value58 = TextureAssets.Projectile[proj.type].Value;
				Vector2 position15 = proj.Top + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Microsoft.Xna.Framework.Rectangle rectangle12 = value58.Frame(1, projFrames[proj.type], 0, proj.frame);
				Vector2 origin19 = rectangle12.Size() * new Vector2(0.5f, 0f);
				Microsoft.Xna.Framework.Color color69 = Microsoft.Xna.Framework.Color.Lerp(proj.GetAlpha(projectileColor), Microsoft.Xna.Framework.Color.White, 0.5f);
				Microsoft.Xna.Framework.Color color70 = color69;
				color70.A = 127;
				Texture2D texture2D2 = null;
				Texture2D texture2D3 = null;
				switch (proj.type)
				{
				case 688:
					texture2D2 = TextureAssets.GlowMask[228].Value;
					texture2D3 = TextureAssets.Extra[86].Value;
					break;
				case 689:
					texture2D2 = TextureAssets.GlowMask[229].Value;
					texture2D3 = TextureAssets.Extra[87].Value;
					break;
				case 690:
					texture2D2 = TextureAssets.GlowMask[230].Value;
					texture2D3 = TextureAssets.Extra[88].Value;
					break;
				}
				EntitySpriteDraw(value58, position15, rectangle12, color69, proj.rotation, origin19, proj.scale, dir);
				if (texture2D2 != null)
				{
					EntitySpriteDraw(texture2D2, position15, rectangle12, color70, proj.rotation, origin19, proj.scale, dir);
				}
				if (texture2D3 != null)
				{
					Vector2 position16 = proj.Center + Vector2.UnitY * proj.gfxOffY - screenPosition;
					rectangle12 = texture2D3.Frame();
					origin19 = rectangle12.Size() * new Vector2(0.5f, 1f);
					origin19.Y -= 2f;
					EntitySpriteDraw(texture2D3, position16, rectangle12, color69, proj.rotation, origin19, proj.scale, dir);
				}
				return;
			}
			if (proj.type == 694 || proj.type == 695 || proj.type == 696)
			{
				Texture2D value59 = TextureAssets.Projectile[proj.type].Value;
				Vector2 position17 = proj.Bottom + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Microsoft.Xna.Framework.Rectangle rectangle13 = value59.Frame(1, projFrames[proj.type], 0, proj.frame);
				Vector2 origin20 = rectangle13.Size() * new Vector2(0.5f, 1f);
				origin20.Y -= 8f;
				int type = proj.type;
				if ((uint)(type - 694) <= 1u)
				{
					origin20.X += 3f;
				}
				Microsoft.Xna.Framework.Color color71 = Microsoft.Xna.Framework.Color.Lerp(proj.GetAlpha(projectileColor), Microsoft.Xna.Framework.Color.White, 0f);
				EntitySpriteDraw(value59, position17, rectangle13, color71, proj.rotation, origin20, proj.scale, dir);
				EntitySpriteDraw(value59, position17, rectangle13, color71 * 0.3f, proj.rotation, origin20, proj.scale * 1.1f, dir);
				return;
			}
			if (proj.type == 409)
			{
				Texture2D value60 = TextureAssets.Projectile[proj.type].Value;
				int num258 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y12 = num258 * proj.frame;
				int num259 = 10;
				int num260 = 2;
				float value61 = 0.5f;
				for (int num261 = 1; num261 < num259; num261 += num260)
				{
					_ = ref proj.oldPos[num261];
					Microsoft.Xna.Framework.Color newColor = projectileColor;
					newColor = proj.GetAlpha(newColor);
					newColor *= (float)(num259 - num261) / 15f;
					_ = proj.oldPos[num261] - screenPosition + new Vector2(num145 + (float)num144, (float)(proj.height / 2) + proj.gfxOffY);
					EntitySpriteDraw(value60, proj.oldPos[num261] + new Vector2(proj.width, proj.height) / 2f - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y12, value60.Width, num258), newColor, proj.rotation, new Vector2((float)value60.Width / 2f, (float)num258 / 2f), MathHelper.Lerp(proj.scale, value61, (float)num261 / 15f), dir);
				}
				EntitySpriteDraw(value60, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y12, value60.Width, num258), proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value60.Width / 2f, (float)num258 / 2f), proj.scale, dir);
				return;
			}
			if (proj.type == 437)
			{
				Texture2D value62 = TextureAssets.Projectile[proj.type].Value;
				int num262 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y13 = num262 * proj.frame;
				int num263 = 10;
				int num264 = 2;
				float value63 = 0.2f;
				for (int num265 = 1; num265 < num263; num265 += num264)
				{
					_ = ref proj.oldPos[num265];
					Microsoft.Xna.Framework.Color newColor2 = projectileColor;
					newColor2 = proj.GetAlpha(newColor2);
					newColor2 *= (float)(num263 - num265) / 15f;
					_ = proj.oldPos[num265] - screenPosition + new Vector2(num145 + (float)num144, (float)(proj.height / 2) + proj.gfxOffY);
					EntitySpriteDraw(value62, proj.oldPos[num265] + new Vector2(proj.width, proj.height) / 2f - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y13, value62.Width, num262), newColor2, proj.rotation, new Vector2((float)value62.Width / 2f, (float)num262 / 2f), MathHelper.Lerp(proj.scale, value63, (float)num265 / 15f), dir);
				}
				EntitySpriteDraw(value62, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y13, value62.Width, num262), Microsoft.Xna.Framework.Color.White, proj.rotation, new Vector2((float)value62.Width / 2f, (float)num262 / 2f), proj.scale + 0.2f, dir);
				EntitySpriteDraw(value62, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y13, value62.Width, num262), proj.GetAlpha(Microsoft.Xna.Framework.Color.White), proj.rotation, new Vector2((float)value62.Width / 2f, (float)num262 / 2f), proj.scale + 0.2f, dir);
				return;
			}
			if (proj.type == 384 || proj.type == 386)
			{
				Texture2D value64 = TextureAssets.Projectile[proj.type].Value;
				int num266 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y14 = num266 * proj.frame;
				EntitySpriteDraw(value64, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y14, value64.Width, num266), proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value64.Width / 2f, (float)num266 / 2f), proj.scale, dir);
				return;
			}
			if (proj.type == 439 || proj.type == 460 || proj.type == 600 || proj.type == 615 || proj.type == 630 || proj.type == 633 || proj.type == 705 || proj.type == 714)
			{
				Texture2D value65 = TextureAssets.Projectile[proj.type].Value;
				if (player.gravDir == -1f)
				{
					if (proj.type == 705)
					{
						dir |= SpriteEffects.FlipVertically;
					}
					if (proj.type == 615 || proj.type == 714)
					{
						if (player.direction == 1)
						{
							dir = SpriteEffects.FlipVertically;
						}
						else if (player.direction == -1)
						{
							dir = SpriteEffects.FlipHorizontally | SpriteEffects.FlipVertically;
						}
					}
					else if (proj.type == 600 || proj.type == 439)
					{
						if (player.direction == 1)
						{
							dir = SpriteEffects.FlipHorizontally;
						}
						else if (player.direction == -1)
						{
							dir = SpriteEffects.None;
						}
					}
				}
				int num267 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y15 = num267 * proj.frame;
				Vector2 vector56 = (proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition).Floor();
				float num268 = 1f;
				if (player.shroomiteStealth && player.inventory[player.selectedItem].ranged)
				{
					float num269 = player.stealth;
					if ((double)num269 < 0.03)
					{
						num269 = 0.03f;
					}
					_ = (1f + num269 * 10f) / 11f;
					projectileColor *= num269;
					num268 = num269;
				}
				if (player.setVortex && player.inventory[player.selectedItem].ranged)
				{
					float num270 = player.stealth;
					if ((double)num270 < 0.03)
					{
						num270 = 0.03f;
					}
					_ = (1f + num270 * 10f) / 11f;
					projectileColor = projectileColor.MultiplyRGBA(new Microsoft.Xna.Framework.Color(Vector4.Lerp(Vector4.One, new Vector4(0f, 0.12f, 0.16f, 0f), 1f - num270)));
					num268 = num270;
				}
				if (proj.type == 714)
				{
					y15 = 0;
					instance.LoadItem(3930);
					value65 = TextureAssets.Item[3930].Value;
				}
				EntitySpriteDraw(value65, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
				if (proj.type == 439)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[35].Value, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * num268, proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
				}
				else if (proj.type == 714)
				{
					y15 = num267 * proj.frame;
					Microsoft.Xna.Framework.Color color72 = hslToRgb(proj.ai[0] / 90f % 1f, 1f, 0.5f);
					color72.A = 120;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), color72 * num268, proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
				}
				else if (proj.type == 615)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[192].Value, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * num268, proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
				}
				else if (proj.type == 630)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[200].Value, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * num268, proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
					if (proj.localAI[0] > 0f)
					{
						int frameY = 6 - (int)(proj.localAI[0] / 1f);
						value65 = TextureAssets.Extra[65].Value;
						EntitySpriteDraw(value65, vector56 + Vector2.Normalize(proj.velocity) * 2f, value65.Frame(1, 6, 0, frameY), new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * num268, proj.rotation, new Vector2(((dir & SpriteEffects.FlipHorizontally) != SpriteEffects.None) ? value65.Width : 0, (float)num267 / 2f - 2f), proj.scale, dir);
					}
				}
				else if (proj.type == 600)
				{
					Microsoft.Xna.Framework.Color portalColor = PortalHelper.GetPortalColor(proj.owner, (int)proj.ai[1]);
					portalColor.A = 70;
					EntitySpriteDraw(TextureAssets.GlowMask[173].Value, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), portalColor, proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
				}
				else if (proj.type == 460)
				{
					if (Math.Abs(proj.rotation - (float)Math.PI / 2f) > (float)Math.PI / 2f)
					{
						dir |= SpriteEffects.FlipVertically;
					}
					EntitySpriteDraw(TextureAssets.GlowMask[102].Value, vector56, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), new Microsoft.Xna.Framework.Color(255, 255, 255, 0), proj.rotation - (float)Math.PI / 2f, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
					if (proj.ai[0] > 180f && Main.projectile[(int)proj.ai[1]].type == 461)
					{
						DrawProj((int)proj.ai[1]);
					}
				}
				else if (proj.type == 633)
				{
					float num271 = (float)Math.Cos((float)Math.PI * 2f * (proj.ai[0] / 30f)) * 2f + 2f;
					if (proj.ai[0] > 120f)
					{
						num271 = 4f;
					}
					for (float num272 = 0f; num272 < 4f; num272 += 1f)
					{
						EntitySpriteDraw(value65, vector56 + Vector2.UnitY.RotatedBy(num272 * ((float)Math.PI * 2f) / 4f) * num271, new Microsoft.Xna.Framework.Rectangle(0, y15, value65.Width, num267), proj.GetAlpha(projectileColor).MultiplyRGBA(new Microsoft.Xna.Framework.Color(255, 255, 255, 0)) * 0.03f, proj.rotation, new Vector2((float)value65.Width / 2f, (float)num267 / 2f), proj.scale, dir);
					}
				}
				return;
			}
			if (proj.type == 442)
			{
				Texture2D value66 = TextureAssets.Projectile[proj.type].Value;
				int num273 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y16 = num273 * proj.frame;
				Vector2 position18 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				EntitySpriteDraw(value66, position18, new Microsoft.Xna.Framework.Rectangle(0, y16, value66.Width, num273), proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value66.Width / 2f, (float)num273 / 2f), proj.scale, dir);
				EntitySpriteDraw(TextureAssets.GlowMask[37].Value, position18, new Microsoft.Xna.Framework.Rectangle(0, y16, value66.Width, num273), new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * (1f - (float)proj.alpha / 255f), proj.rotation, new Vector2((float)value66.Width / 2f, (float)num273 / 2f), proj.scale, dir);
				return;
			}
			if (proj.type == 447)
			{
				Texture2D value67 = TextureAssets.Projectile[proj.type].Value;
				Texture2D value68 = TextureAssets.Extra[4].Value;
				int num274 = value67.Height / projFrames[proj.type];
				int y17 = num274 * proj.frame;
				int num275 = value68.Height / projFrames[proj.type];
				int num276 = num275 * proj.frame;
				Microsoft.Xna.Framework.Rectangle value69 = new Microsoft.Xna.Framework.Rectangle(0, num276, value68.Width, num275);
				Vector2 vector57 = proj.position + new Vector2(proj.width, 0f) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				EntitySpriteDraw(TextureAssets.Extra[4].Value, vector57, value69, proj.GetAlpha(projectileColor), proj.rotation, new Vector2(value68.Width / 2, 0f), proj.scale, dir);
				int num277 = proj.height - num274 - 14;
				if (num277 < 0)
				{
					num277 = 0;
				}
				if (num277 > 0)
				{
					if (num276 == num275 * 3)
					{
						num276 = num275 * 2;
					}
					EntitySpriteDraw(TextureAssets.Extra[4].Value, vector57 + Vector2.UnitY * (num275 - 1), new Microsoft.Xna.Framework.Rectangle(0, num276 + num275 - 1, value68.Width, 1), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(value68.Width / 2, 0f), new Vector2(1f, num277), dir);
				}
				value69.Width = value67.Width;
				value69.Y = y17;
				EntitySpriteDraw(value67, vector57 + Vector2.UnitY * (num275 - 1 + num277), value69, proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value67.Width / 2f, 0f), proj.scale, dir);
				return;
			}
			if (proj.type == 455)
			{
				if (proj.velocity == Vector2.Zero)
				{
					return;
				}
				Texture2D value70 = TextureAssets.Projectile[proj.type].Value;
				Texture2D value71 = TextureAssets.Extra[21].Value;
				Texture2D value72 = TextureAssets.Extra[22].Value;
				float num278 = proj.localAI[1];
				Microsoft.Xna.Framework.Color color73 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.9f;
				EntitySpriteDraw(value70, proj.Center - screenPosition, null, color73, proj.rotation, value70.Size() / 2f, proj.scale, SpriteEffects.None);
				num278 -= (float)(value70.Height / 2 + value72.Height) * proj.scale;
				Vector2 center3 = proj.Center;
				center3 += proj.velocity * proj.scale * value70.Height / 2f;
				if (num278 > 0f)
				{
					float num279 = 0f;
					Microsoft.Xna.Framework.Rectangle value73 = new Microsoft.Xna.Framework.Rectangle(0, 16 * (proj.timeLeft / 3 % 5), value71.Width, 16);
					while (num279 + 1f < num278)
					{
						if (num278 - num279 < (float)value73.Height)
						{
							value73.Height = (int)(num278 - num279);
						}
						EntitySpriteDraw(value71, center3 - screenPosition, value73, color73, proj.rotation, new Vector2(value73.Width / 2, 0f), proj.scale, SpriteEffects.None);
						num279 += (float)value73.Height * proj.scale;
						center3 += proj.velocity * value73.Height * proj.scale;
						value73.Y += 16;
						if (value73.Y + value73.Height > value71.Height)
						{
							value73.Y = 0;
						}
					}
				}
				EntitySpriteDraw(value72, center3 - screenPosition, null, color73, proj.rotation, value72.Frame().Top(), proj.scale, SpriteEffects.None);
				return;
			}
			if (proj.type == 461)
			{
				if (proj.velocity == Vector2.Zero)
				{
					return;
				}
				Texture2D value74 = TextureAssets.Projectile[proj.type].Value;
				float num280 = proj.localAI[1];
				Microsoft.Xna.Framework.Color color74 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.9f;
				Microsoft.Xna.Framework.Rectangle rectangle14 = new Microsoft.Xna.Framework.Rectangle(0, 0, value74.Width, 22);
				EntitySpriteDraw(value74, proj.Center.Floor() - screenPosition, rectangle14, color74, proj.rotation, rectangle14.Size() / 2f, proj.scale, SpriteEffects.None);
				num280 -= 33f * proj.scale;
				Vector2 vector58 = proj.Center.Floor();
				vector58 += proj.velocity * proj.scale * 10.5f;
				rectangle14 = new Microsoft.Xna.Framework.Rectangle(0, 25, value74.Width, 28);
				if (num280 > 0f)
				{
					float num281 = 0f;
					while (num281 + 1f < num280)
					{
						if (num280 - num281 < (float)rectangle14.Height)
						{
							rectangle14.Height = (int)(num280 - num281);
						}
						EntitySpriteDraw(value74, vector58 - screenPosition, rectangle14, color74, proj.rotation, new Vector2(rectangle14.Width / 2, 0f), proj.scale, SpriteEffects.None);
						num281 += (float)rectangle14.Height * proj.scale;
						vector58 += proj.velocity * rectangle14.Height * proj.scale;
					}
				}
				EntitySpriteDraw(sourceRectangle: new Microsoft.Xna.Framework.Rectangle(0, 56, value74.Width, 22), texture: value74, position: vector58 - screenPosition, color: color74, rotation: proj.rotation, origin: value74.Frame().Top(), scale: proj.scale, effects: SpriteEffects.None);
				return;
			}
			if (proj.type == 632)
			{
				if (!(proj.velocity == Vector2.Zero))
				{
					Texture2D value75 = TextureAssets.Projectile[proj.type].Value;
					float num282 = proj.localAI[1];
					float laserLuminance = 0.5f;
					float laserAlphaMultiplier = 0f;
					Microsoft.Xna.Framework.Color color75 = hslToRgb(proj.GetLastPrismHue(proj.ai[0], ref laserLuminance, ref laserAlphaMultiplier), 1f, laserLuminance);
					color75.A = (byte)((float)(int)color75.A * laserAlphaMultiplier);
					Vector2 vector59 = proj.Center.Floor();
					vector59 += proj.velocity * proj.scale * 10.5f;
					num282 -= proj.scale * 14.5f * proj.scale;
					Vector2 vector60 = new Vector2(proj.scale);
					DelegateMethods.f_1 = 1f;
					DelegateMethods.c_1 = color75 * 0.75f * proj.Opacity;
					_ = proj.oldPos[0] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
					Utils.DrawLaser(spriteBatch, value75, vector59 - screenPosition, vector59 + proj.velocity * num282 - screenPosition, vector60, DelegateMethods.RainbowLaserDraw);
					DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * 0.75f * proj.Opacity;
					Utils.DrawLaser(spriteBatch, value75, vector59 - screenPosition, vector59 + proj.velocity * num282 - screenPosition, vector60 / 2f, DelegateMethods.RainbowLaserDraw);
				}
				return;
			}
			if (proj.type == 642)
			{
				if (!(proj.velocity == Vector2.Zero))
				{
					Texture2D value76 = TextureAssets.Projectile[proj.type].Value;
					float num283 = proj.localAI[1];
					Microsoft.Xna.Framework.Color c_ = new Microsoft.Xna.Framework.Color(255, 255, 255, 127);
					Vector2 vector61 = proj.Center.Floor();
					num283 -= proj.scale * 10.5f;
					Vector2 vector62 = new Vector2(proj.scale);
					DelegateMethods.f_1 = 1f;
					DelegateMethods.c_1 = c_;
					DelegateMethods.i_1 = 54000 - (int)time / 2;
					_ = proj.oldPos[0] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
					Utils.DrawLaser(spriteBatch, value76, vector61 - screenPosition, vector61 + proj.velocity * num283 - screenPosition, vector62, DelegateMethods.TurretLaserDraw);
					DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * 0.75f * proj.Opacity;
					Utils.DrawLaser(spriteBatch, value76, vector61 - screenPosition, vector61 + proj.velocity * num283 - screenPosition, vector62 / 2f, DelegateMethods.TurretLaserDraw);
				}
				return;
			}
			if (proj.type == 611)
			{
				Texture2D value77 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Color alpha9 = proj.GetAlpha(projectileColor);
				if (proj.velocity == Vector2.Zero)
				{
					return;
				}
				float num284 = proj.velocity.Length() + 16f;
				bool flag33 = num284 < 100f;
				Vector2 vector63 = Vector2.Normalize(proj.velocity);
				Microsoft.Xna.Framework.Rectangle rectangle15 = new Microsoft.Xna.Framework.Rectangle(0, 2, value77.Width, 40);
				float rotation26 = proj.rotation + (float)Math.PI;
				EntitySpriteDraw(value77, proj.Center.Floor() - screenPosition, rectangle15, alpha9, rotation26, rectangle15.Size() / 2f - Vector2.UnitY * 4f, proj.scale, SpriteEffects.None);
				num284 -= 40f * proj.scale;
				Vector2 vector64 = proj.Center.Floor();
				vector64 += vector63 * proj.scale * 24f;
				rectangle15 = new Microsoft.Xna.Framework.Rectangle(0, 68, value77.Width, 18);
				if (num284 > 0f)
				{
					float num285 = 0f;
					while (num285 + 1f < num284)
					{
						if (num284 - num285 < (float)rectangle15.Height)
						{
							rectangle15.Height = (int)(num284 - num285);
						}
						EntitySpriteDraw(value77, vector64 - screenPosition, rectangle15, alpha9, rotation26, new Vector2(rectangle15.Width / 2, 0f), proj.scale, SpriteEffects.None);
						num285 += (float)rectangle15.Height * proj.scale;
						vector64 += vector63 * rectangle15.Height * proj.scale;
					}
				}
				Vector2 vector65 = vector64;
				vector64 = proj.Center.Floor();
				vector64 += vector63 * proj.scale * 24f;
				rectangle15 = new Microsoft.Xna.Framework.Rectangle(0, 46, value77.Width, 18);
				int num286 = 18;
				if (flag33)
				{
					num286 = 9;
				}
				float num287 = num284;
				if (num284 > 0f)
				{
					float num288 = 0f;
					float num289 = num287 / (float)num286;
					num288 += num289 * 0.25f;
					vector64 += vector63 * num289 * 0.25f;
					for (int num290 = 0; num290 < num286; num290++)
					{
						float num291 = num289;
						if (num290 == 0)
						{
							num291 *= 0.75f;
						}
						EntitySpriteDraw(value77, vector64 - screenPosition, rectangle15, alpha9, rotation26, new Vector2(rectangle15.Width / 2, 0f), proj.scale, SpriteEffects.None);
						num288 += num291;
						vector64 += vector63 * num291;
					}
				}
				EntitySpriteDraw(sourceRectangle: new Microsoft.Xna.Framework.Rectangle(0, 90, value77.Width, 48), texture: value77, position: vector65 - screenPosition, color: alpha9, rotation: rotation26, origin: value77.Frame().Top(), scale: proj.scale, effects: SpriteEffects.None);
				return;
			}
			if (proj.type == 537)
			{
				if (proj.velocity == Vector2.Zero)
				{
					return;
				}
				Texture2D value78 = TextureAssets.Projectile[proj.type].Value;
				float num292 = proj.localAI[1];
				float fromValue2 = Utils.Remap(proj.localAI[0], 20f, 30f, 0f, 1f) * Utils.Remap(proj.localAI[0], 60f, 90f, 1f, 0f);
				float toMax = 1.5f;
				float num293 = Utils.Remap(fromValue2, 0f, 1f, 0.25f, toMax);
				Microsoft.Xna.Framework.Color color76 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.9f;
				Microsoft.Xna.Framework.Rectangle rectangle16 = new Microsoft.Xna.Framework.Rectangle(0, 0, value78.Width, 22);
				Vector2 vector66 = new Vector2(0f, npc[(int)proj.ai[1]].gfxOffY);
				EntitySpriteDraw(value78, proj.Center.Floor() - screenPosition + vector66, rectangle16, color76, proj.rotation, rectangle16.Size() / 2f, num293, SpriteEffects.None);
				num292 -= 33f * proj.scale;
				Vector2 vector67 = proj.Center.Floor();
				vector67 += proj.velocity * num293 * 10.5f;
				rectangle16 = new Microsoft.Xna.Framework.Rectangle(0, 25, value78.Width, 28);
				if (num292 > 0f)
				{
					float num294 = 0f;
					while (num294 + 1f < num292)
					{
						if (num292 - num294 < (float)rectangle16.Height)
						{
							rectangle16.Height = (int)(num292 - num294);
						}
						EntitySpriteDraw(value78, vector67 - screenPosition + vector66, rectangle16, color76, proj.rotation, new Vector2(rectangle16.Width / 2, 0f), num293, SpriteEffects.None);
						num294 += (float)rectangle16.Height * num293;
						vector67 += proj.velocity * rectangle16.Height * num293;
					}
				}
				EntitySpriteDraw(sourceRectangle: new Microsoft.Xna.Framework.Rectangle(0, 56, value78.Width, 22), texture: value78, position: vector67 - screenPosition + vector66, color: color76, rotation: proj.rotation, origin: value78.Frame().Top(), scale: num293, effects: SpriteEffects.None);
				return;
			}
			if (proj.type == 456)
			{
				Texture2D value79 = TextureAssets.Projectile[proj.type].Value;
				Texture2D value80 = TextureAssets.Extra[23].Value;
				Texture2D value81 = TextureAssets.Extra[24].Value;
				Vector2 vector68 = new Vector2(0f, 216f);
				Vector2 value82 = npc[(int)Math.Abs(proj.ai[0]) - 1].Center - proj.Center + vector68;
				float num295 = value82.Length();
				Vector2 vector69 = Vector2.Normalize(value82);
				Microsoft.Xna.Framework.Rectangle rectangle17 = value79.Frame();
				rectangle17.Height /= 4;
				rectangle17.Y += proj.frame * rectangle17.Height;
				EntitySpriteDraw(color: proj.GetAlpha(Microsoft.Xna.Framework.Color.Lerp(projectileColor, Microsoft.Xna.Framework.Color.White, 0.3f)), texture: value79, position: proj.Center - screenPosition, sourceRectangle: rectangle17, rotation: proj.rotation, origin: rectangle17.Size() / 2f, scale: proj.scale, effects: SpriteEffects.None);
				num295 -= (float)(rectangle17.Height / 2 + value81.Height) * proj.scale;
				Vector2 center4 = proj.Center;
				center4 += vector69 * proj.scale * rectangle17.Height / 2f;
				if (num295 > 0f)
				{
					float num296 = 0f;
					Microsoft.Xna.Framework.Rectangle rectangle18 = new Microsoft.Xna.Framework.Rectangle(0, 0, value80.Width, value80.Height);
					while (num296 + 1f < num295)
					{
						if (num295 - num296 < (float)rectangle18.Height)
						{
							rectangle18.Height = (int)(num295 - num296);
						}
						Microsoft.Xna.Framework.Point point3 = center4.ToTileCoordinates();
						Microsoft.Xna.Framework.Color color77 = Lighting.GetColor(point3.X, point3.Y);
						color77 = Microsoft.Xna.Framework.Color.Lerp(color77, Microsoft.Xna.Framework.Color.White, 0.3f);
						EntitySpriteDraw(value80, center4 - screenPosition, rectangle18, proj.GetAlpha(color77), proj.rotation, rectangle18.Bottom(), proj.scale, SpriteEffects.None);
						num296 += (float)rectangle18.Height * proj.scale;
						center4 += vector69 * rectangle18.Height * proj.scale;
					}
				}
				Microsoft.Xna.Framework.Point point4 = center4.ToTileCoordinates();
				Microsoft.Xna.Framework.Color color78 = Lighting.GetColor(point4.X, point4.Y);
				color78 = Microsoft.Xna.Framework.Color.Lerp(color78, Microsoft.Xna.Framework.Color.White, 0.3f);
				Microsoft.Xna.Framework.Rectangle value83 = value81.Frame();
				if (num295 < 0f)
				{
					value83.Height += (int)num295;
				}
				EntitySpriteDraw(value81, center4 - screenPosition, value83, color78, proj.rotation, new Vector2((float)value83.Width / 2f, value83.Height), proj.scale, SpriteEffects.None);
				return;
			}
			if (proj.type == 443 || proj.type == 1110)
			{
				Texture2D value84 = TextureAssets.Projectile[proj.type].Value;
				float num297 = 30f;
				float num298 = num297 * 4f;
				float num299 = (float)Math.PI * 2f * proj.ai[0] / num297;
				float num300 = (float)Math.PI * 2f * proj.ai[0] / num298;
				Vector2 vector70 = -Vector2.UnitY.RotatedBy(num299);
				float scale5 = 0.75f + vector70.Y * 0.25f;
				float scale6 = 0.8f - vector70.Y * 0.2f;
				int num301 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y18 = num301 * proj.frame;
				Vector2 position19 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				EntitySpriteDraw(value84, position19, new Microsoft.Xna.Framework.Rectangle(0, y18, value84.Width, num301), proj.GetAlpha(projectileColor), proj.rotation + num300, new Vector2((float)value84.Width / 2f, (float)num301 / 2f), scale5, dir);
				EntitySpriteDraw(value84, position19, new Microsoft.Xna.Framework.Rectangle(0, y18, value84.Width, num301), proj.GetAlpha(projectileColor), proj.rotation + ((float)Math.PI * 2f - num300), new Vector2((float)value84.Width / 2f, (float)num301 / 2f), scale6, dir);
				return;
			}
			if (proj.type == 656 || proj.type == 657)
			{
				float num302 = 900f;
				if (proj.type == 657)
				{
					num302 = 300f;
				}
				float num303 = 15f;
				float num304 = 15f;
				float num305 = proj.ai[0];
				float num306 = MathHelper.Clamp(num305 / 30f, 0f, 1f);
				if (num305 > num302 - 60f)
				{
					num306 = MathHelper.Lerp(1f, 0f, (num305 - (num302 - 60f)) / 60f);
				}
				Microsoft.Xna.Framework.Point point5 = proj.Center.ToTileCoordinates();
				Collision.ExpandVertically(point5.X, point5.Y, out var topY, out var bottomY, (int)num303, (int)num304);
				topY++;
				bottomY--;
				float num307 = 0.2f;
				Vector2 value85 = new Vector2(point5.X, topY) * 16f + new Vector2(8f);
				Vector2 value86 = new Vector2(point5.X, bottomY) * 16f + new Vector2(8f);
				Vector2.Lerp(value85, value86, 0.5f);
				Vector2 vector71 = new Vector2(0f, value86.Y - value85.Y);
				vector71.X = vector71.Y * num307;
				new Vector2(value85.X - vector71.X / 2f, value85.Y);
				Texture2D value87 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle rectangle19 = value87.Frame();
				Vector2 origin21 = rectangle19.Size() / 2f;
				float num308 = -(float)Math.PI / 50f * num305;
				Vector2 spinningpoint4 = Vector2.UnitY.RotatedBy(num305 * 0.1f);
				float num309 = 0f;
				float num310 = 5.1f;
				Microsoft.Xna.Framework.Color value88 = new Microsoft.Xna.Framework.Color(212, 192, 100);
				for (float num311 = (int)value86.Y; num311 > (float)(int)value85.Y; num311 -= num310)
				{
					num309 += num310;
					float num312 = num309 / vector71.Y;
					float num313 = num309 * ((float)Math.PI * 2f) / -20f;
					float num314 = num312 - 0.15f;
					Vector2 position20 = spinningpoint4.RotatedBy(num313);
					Vector2 vector72 = new Vector2(0f, num312 + 1f);
					vector72.X = vector72.Y * num307;
					Microsoft.Xna.Framework.Color color79 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, value88, num312 * 2f);
					if (num312 > 0.5f)
					{
						color79 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, value88, 2f - num312 * 2f);
					}
					color79.A = (byte)((float)(int)color79.A * 0.5f);
					color79 *= num306;
					position20 *= vector72 * 100f;
					position20.Y = 0f;
					position20.X = 0f;
					position20 += new Vector2(value86.X, num311) - screenPosition;
					EntitySpriteDraw(value87, position20, rectangle19, color79, num308 + num313, origin21, 1f + num314, SpriteEffects.None);
				}
				return;
			}
			if (proj.type == 704)
			{
				float num315 = 300f;
				float num316 = proj.ai[0];
				float num317 = MathHelper.Clamp(num316 / 30f, 0f, 1f);
				if (num316 > num315 - 60f)
				{
					num317 = MathHelper.Lerp(1f, 0f, (num316 - (num315 - 60f)) / 60f);
				}
				float num318 = 0.2f;
				Vector2 top2 = proj.Top;
				Vector2 bottom = proj.Bottom;
				Vector2.Lerp(top2, bottom, 0.5f);
				Vector2 vector73 = new Vector2(0f, bottom.Y - top2.Y);
				vector73.X = vector73.Y * num318;
				new Vector2(top2.X - vector73.X / 2f, top2.Y);
				Texture2D value89 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle rectangle20 = value89.Frame();
				Vector2 origin22 = rectangle20.Size() / 2f;
				float num319 = -(float)Math.PI / 20f * num316 * (float)((!(proj.velocity.X > 0f)) ? 1 : (-1));
				SpriteEffects effects3 = ((proj.velocity.X > 0f) ? SpriteEffects.FlipVertically : SpriteEffects.None);
				bool flag34 = proj.velocity.X > 0f;
				Vector2 spinningpoint5 = Vector2.UnitY.RotatedBy(num316 * 0.14f);
				float num320 = 0f;
				float num321 = 5.01f + num316 / 150f * -0.9f;
				if (num321 < 4.11f)
				{
					num321 = 4.11f;
				}
				Microsoft.Xna.Framework.Color value90 = new Microsoft.Xna.Framework.Color(160, 140, 100, 127);
				Microsoft.Xna.Framework.Color color80 = new Microsoft.Xna.Framework.Color(140, 160, 255, 127);
				float num322 = num316 % 60f;
				if (num322 < 30f)
				{
					color80 *= Utils.GetLerpValue(22f, 30f, num322, clamped: true);
				}
				else
				{
					color80 *= Utils.GetLerpValue(38f, 30f, num322, clamped: true);
				}
				bool flag35 = color80 != Microsoft.Xna.Framework.Color.Transparent;
				for (float num323 = (int)bottom.Y; num323 > (float)(int)top2.Y; num323 -= num321)
				{
					num320 += num321;
					float num324 = num320 / vector73.Y;
					float num325 = num320 * ((float)Math.PI * 2f) / -20f;
					if (flag34)
					{
						num325 *= -1f;
					}
					float num326 = num324 - 0.35f;
					Vector2 position21 = spinningpoint5.RotatedBy(num325);
					Vector2 vector74 = new Vector2(0f, num324 + 1f);
					vector74.X = vector74.Y * num318;
					Microsoft.Xna.Framework.Color color81 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, value90, num324 * 2f);
					if (num324 > 0.5f)
					{
						color81 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, value90, 2f - num324 * 2f);
					}
					color81.A = (byte)((float)(int)color81.A * 0.5f);
					color81 *= num317;
					position21 *= vector74 * 100f;
					position21.Y = 0f;
					position21.X = 0f;
					position21 += new Vector2(bottom.X, num323) - screenPosition;
					if (flag35)
					{
						Microsoft.Xna.Framework.Color color82 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color80, num324 * 2f);
						if (num324 > 0.5f)
						{
							color82 = Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color80, 2f - num324 * 2f);
						}
						color82.A = (byte)((float)(int)color82.A * 0.5f);
						color82 *= num317;
						EntitySpriteDraw(value89, position21, rectangle20, color82, num319 + num325, origin22, (1f + num326) * 0.8f, effects3);
					}
					EntitySpriteDraw(value89, position21, rectangle20, color81, num319 + num325, origin22, 1f + num326, effects3);
				}
				return;
			}
			if (proj.type == 444 || proj.type == 446 || proj.type == 490 || proj.type == 464 || proj.type == 502 || proj.type == 538 || proj.type == 540 || proj.type == 579 || proj.type == 578 || proj.type == 813 || proj.type == 583 || proj.type == 584 || proj.type == 616 || proj.type == 617 || proj.type == 618 || proj.type == 641 || (proj.type >= 646 && proj.type <= 649) || proj.type == 653 || proj.type == 186 || proj.type == 662 || proj.type == 685 || proj.type == 673 || proj.type == 676 || proj.type == 697 || proj.type == 699 || proj.type == 707 || proj.type == 708 || proj.type == 719 || proj.type == 761 || proj.type == 762 || proj.type == 763 || proj.type == 772 || proj.type == 802 || proj.type == 842 || proj.type == 865 || proj.type == 921 || proj.type == 926 || proj.type == 757 || proj.type == 25 || proj.type == 35 || proj.type == 63 || proj.type == 154 || proj.type == 247 || proj.type == 26 || proj.type == 928 || proj.type == 16 || proj.type == 34 || proj.type == 79 || proj.type == 936 || proj.type == 937 || proj.type == 938 || proj.type == 939 || proj.type == 940 || proj.type == 941 || proj.type == 942 || proj.type == 943 || proj.type == 944 || proj.type == 945 || proj.type == 971 || proj.type == 975 || proj.type == 1000 || proj.type == 1012 || proj.type == 1018 || proj.type == 1056 || proj.type == 1020 || proj.type == 1023 || proj.type == 1047 || proj.type == 1048 || proj.type == 1053 || proj.type == 1054 || proj.type == 1089 || proj.type == 1090 || proj.type == 1099 || (((proj.type >= 776 && proj.type <= 801) || (proj.type >= 803 && proj.type <= 810)) && proj.type != 779 && proj.type != 783 && proj.type != 862 && proj.type != 863))
			{
				Vector2 vector75 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Texture2D value91 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Color color83 = proj.GetAlpha(projectileColor);
				Vector2 origin23 = new Vector2(value91.Width, value91.Height) / 2f;
				float num327 = proj.rotation;
				Vector2 vector76 = Vector2.One * proj.scale;
				Microsoft.Xna.Framework.Rectangle? sourceRectangle2 = null;
				if (proj.type == 1056)
				{
					vector75.Y += 2f;
				}
				if (proj.type == 446)
				{
					origin23.Y = 4f;
				}
				if (proj.type == 1020)
				{
					origin23.Y = 14f;
				}
				if (proj.type == 865)
				{
					vector75 += new Vector2(1f, -1f);
					dir = ((proj.DirectionFrom(player.Center).SafeNormalize(Vector2.Zero).X > 0f) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
				}
				if (proj.type == 16)
				{
					float lerpValue8 = Utils.GetLerpValue(0f, 8f, proj.velocity.Length(), clamped: true);
					num327 *= lerpValue8;
					vector76 *= 0.6f;
					vector76.Y *= MathHelper.Lerp(1f, 0.8f, lerpValue8);
					vector76.X *= MathHelper.Lerp(1f, 1.5f, lerpValue8);
				}
				if (proj.type == 1047)
				{
					_rainbowBoulderMusicFramesCounter = 6;
					vector76 *= 2f;
					sourceRectangle2 = value91.Frame(5, 20, proj.frame / 20, proj.frame % 20);
					origin23 = sourceRectangle2.Value.Size() / 2f;
				}
				if (proj.type == 1090 && proj.ai[0] == 1f)
				{
					LoadProjectile(1047);
					value91 = TextureAssets.Projectile[1047].Value;
					vector76 *= 2f;
					sourceRectangle2 = value91.Frame(5, 20, proj.frame / 20, proj.frame % 20);
					origin23 = sourceRectangle2.Value.Size() / 2f;
				}
				if (proj.type == 34)
				{
					float lerpValue9 = Utils.GetLerpValue(0f, 8f, proj.velocity.Length(), clamped: true);
					num327 *= lerpValue9;
					vector76.X *= MathHelper.Lerp(1f, 0.8f, lerpValue9);
					num327 += -(float)Math.PI / 2f * lerpValue9;
					sourceRectangle2 = value91.Frame(1, projFrames[proj.type], 0, proj.frame);
					origin23 = sourceRectangle2.Value.Size() / 2f;
					vector75 -= proj.velocity * 1f;
					vector75 = proj.oldPos[0] + proj.Size / 2f - screenPosition - proj.velocity / 2f;
				}
				if (proj.type == 79)
				{
					num327 = 0f;
					vector76 *= Utils.GetLerpValue(32f, 0f, proj.position.Distance(proj.oldPos[12]), clamped: true);
					color83 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
				}
				if (proj.type == 761 || proj.type == 762)
				{
					dir = ((proj.spriteDirection <= 0) ? SpriteEffects.FlipVertically : SpriteEffects.None);
				}
				if (proj.type == 662 || proj.type == 685)
				{
					origin23 = new Vector2(6f, 6f);
				}
				if (proj.type == 699 || proj.type == 708)
				{
					Player player5 = player;
					origin23 = new Vector2((proj.spriteDirection == 1) ? ((float)value91.Width - -8f) : (-8f), (player5.gravDir == 1f) ? (-8f) : ((float)value91.Height - -8f));
					if (player5.gravDir == -1f)
					{
						dir |= SpriteEffects.FlipVertically;
						num327 += (float)Math.PI / 2f * (float)(-proj.spriteDirection);
					}
				}
				if (proj.type == 938 || proj.type == 939 || proj.type == 940 || proj.type == 941 || proj.type == 942 || proj.type == 943 || proj.type == 944 || proj.type == 945)
				{
					num327 -= (float)Math.PI / 4f * (float)proj.spriteDirection;
				}
				if (proj.type == 1089)
				{
					LoadProjectile(250);
					Texture2D value92 = TextureAssets.MagicPixel.Value;
					float num328 = 2f;
					Vector2 origin24 = new Vector2(value92.Width / 2, 0f);
					Vector2 vector77 = new Vector2(proj.width, proj.height) / 2f;
					Microsoft.Xna.Framework.Color color84 = new Microsoft.Xna.Framework.Color(DiscoR, DiscoG, DiscoB, 127);
					float num329 = 1f;
					float num330 = 1f;
					float num331 = 0f;
					float num332 = 13f;
					float num333 = 1f / num332;
					int num334 = -1;
					for (int num335 = proj.oldPos.Length - 1; num335 > 0; num335--)
					{
						Vector2 vector78 = proj.oldPos[num335] + vector77;
						if (!(vector78 == vector77))
						{
							if (num334 == -1)
							{
								num334 = num335;
							}
							Vector2 vector79 = proj.oldPos[num335 - 1] + vector77;
							float rotation27 = (vector79 - vector78).ToRotation() - (float)Math.PI / 2f;
							Vector2 scale7 = new Vector2(2.2f * num328, Vector2.Distance(vector78, vector79) / (float)value92.Height);
							Microsoft.Xna.Framework.Color color85 = color84 * num331 * num329 * num330;
							if (num335 <= 10)
							{
								num329 -= 0.1f;
								if (num329 <= 0f)
								{
									num329 = 0f;
								}
							}
							if ((float)num335 >= (float)num334 - num332)
							{
								num331 += num333;
								if (num331 >= 1f)
								{
									num331 = 1f;
								}
							}
							EntitySpriteDraw(value92, vector78 - screenPosition, null, color85, rotation27, origin24, scale7, dir);
						}
					}
				}
				if (proj.type == 502)
				{
					LoadProjectile(250);
					Texture2D value93 = TextureAssets.Projectile[250].Value;
					Vector2 origin25 = new Vector2(value93.Width / 2, 0f);
					Vector2 vector80 = new Vector2(proj.width, proj.height) / 2f;
					Microsoft.Xna.Framework.Color white3 = Microsoft.Xna.Framework.Color.White;
					white3.A = 127;
					for (int num336 = proj.oldPos.Length - 1; num336 > 0; num336--)
					{
						Vector2 vector81 = proj.oldPos[num336] + vector80;
						if (!(vector81 == vector80))
						{
							Vector2 vector82 = proj.oldPos[num336 - 1] + vector80;
							float rotation28 = (vector82 - vector81).ToRotation() - (float)Math.PI / 2f;
							Vector2 scale8 = new Vector2(1f, Vector2.Distance(vector81, vector82) / (float)value93.Height);
							Microsoft.Xna.Framework.Color color86 = white3 * (1f - (float)num336 / (float)proj.oldPos.Length);
							EntitySpriteDraw(value93, vector81 - screenPosition, null, color86, rotation28, origin25, scale8, dir);
						}
					}
				}
				if (proj.type == 1047 || proj.type == 1090)
				{
					float num337 = 0.5f;
					float num338 = 1f;
					if (proj.type == 1090)
					{
						bool flag36 = proj.ai[0] == 1f;
						num338 = MathHelper.Clamp(proj.localAI[2], 0f, 1f);
						if (num338 > 0f && flag36)
						{
							num338 *= Utils.GetLerpValue(3f, 5f, proj.velocity.Length(), clamped: true);
						}
						if (!flag36)
						{
							Texture2D value94 = TextureAssets.Extra[283].Value;
							for (float num339 = 0f; num339 < 1f; num339 += 1f / 3f)
							{
								float num340 = GlobalTimeWrappedHourly % 2f / 2f;
								Microsoft.Xna.Framework.Color color87 = hslToRgb((num340 + num339) % 1f, 1f, 0.5f);
								color87.A = 0;
								color87 *= 0.3f;
								Vector2 position22 = vector75 + (((num340 + num339) * ((float)Math.PI * 2f)).ToRotationVector2() * 4f).Floor();
								EntitySpriteDraw(value94, position22, null, color87, num327, origin23, vector76, dir);
							}
						}
					}
					Vector2 vector83 = new Vector2(proj.width, proj.height) / 2f;
					if (num338 > 0f)
					{
						LoadProjectile(250);
						Texture2D value95 = TextureAssets.Projectile[250].Value;
						Vector2 origin26 = new Vector2(value95.Width / 2, 0f);
						Microsoft.Xna.Framework.Color white4 = Microsoft.Xna.Framework.Color.White;
						white4.A = 127;
						white4 *= num338;
						for (int num341 = proj.oldPos.Length - 1; num341 > 0; num341--)
						{
							Vector2 vector84 = proj.oldPos[num341] + vector83;
							if (!(vector84 == vector83))
							{
								Vector2 vector85 = proj.oldPos[num341 - 1] + vector83;
								float rotation29 = (vector85 - vector84).ToRotation() - (float)Math.PI / 2f;
								Vector2 scale9 = new Vector2(2.2f * num337, Vector2.Distance(vector84, vector85) / (float)value95.Height);
								float num342 = (float)num341 / (float)proj.oldPos.Length;
								Microsoft.Xna.Framework.Color color88 = white4 * (1f - num342) * (1f - num342);
								EntitySpriteDraw(value95, vector84 - screenPosition, null, color88, rotation29, origin26, scale9, dir);
							}
						}
						Texture2D value96 = TextureAssets.Extra[55].Value;
						Vector2 origin27 = new Vector2(value96.Width / 2, value96.Height / 8 + 14);
						int frame = proj.frame;
						float num343 = -(float)Math.PI / 2f;
						frame %= 4;
						for (int num344 = 3; num344 >= 0; num344--)
						{
							if (proj.oldPos[num344] != Vector2.Zero)
							{
								Vector2 vector86 = proj.oldPos[num344] + vector83;
								Microsoft.Xna.Framework.Color white5 = Microsoft.Xna.Framework.Color.White;
								white5.A = 0;
								white5 *= 1f - (float)num344 / 3f;
								white5 *= num338;
								int num345 = (frame - num344) % 4;
								if (num345 < 0)
								{
									num345 += 4;
								}
								Microsoft.Xna.Framework.Rectangle value97 = value96.Frame(1, 4, 0, num345);
								EntitySpriteDraw(value96, vector86 - screenPosition, value97, white5, proj.velocity.ToRotation() + num343, origin27, MathHelper.Lerp(0.1f, 0.8f, (10f - (float)num344) / 10f) * num337, SpriteEffects.None);
							}
						}
					}
				}
				else if (proj.type == 540 && proj.velocity != Vector2.Zero)
				{
					float num346 = 0f;
					if (proj.ai[0] >= 10f)
					{
						num346 = (proj.ai[0] - 10f) / 10f;
					}
					if (proj.ai[0] >= 20f)
					{
						num346 = (20f - proj.ai[0]) / 10f;
					}
					if (num346 > 1f)
					{
						num346 = 1f;
					}
					if (num346 < 0f)
					{
						num346 = 0f;
					}
					if (num346 != 0f)
					{
						Texture2D value98 = TextureAssets.Extra[47].Value;
						Vector2 origin28 = new Vector2(value98.Width / 2, 0f);
						Microsoft.Xna.Framework.Color color89 = color83 * num346 * 0.7f;
						Vector2 position23 = proj.Center - screenPosition;
						Vector2 vector87 = proj.velocity.ToRotation().ToRotationVector2() * value91.Width / 3f;
						vector87 = Vector2.Zero;
						position23 += vector87;
						float rotation30 = proj.velocity.ToRotation() - (float)Math.PI / 2f;
						Vector2 scale10 = new Vector2(1f, (proj.velocity.Length() - vector87.Length() * 2f) / (float)value98.Height);
						EntitySpriteDraw(value98, position23, null, color89, rotation30, origin28, scale10, SpriteEffects.None);
					}
				}
				if (proj.type == 578 || proj.type == 579 || proj.type == 641 || proj.type == 813)
				{
					Microsoft.Xna.Framework.Color color90 = color83 * 0.8f;
					color90.A /= 2;
					Microsoft.Xna.Framework.Color color91 = Microsoft.Xna.Framework.Color.Lerp(color83, Microsoft.Xna.Framework.Color.Black, 0.5f);
					color91.A = color83.A;
					float num347 = 0.95f + (proj.rotation * 0.75f).ToRotationVector2().Y * 0.1f;
					color91 *= num347;
					float scale11 = 0.6f + proj.scale * 0.6f * num347;
					Texture2D value99 = TextureAssets.Extra[50].Value;
					bool flag37 = true;
					if (proj.type == 813)
					{
						flag37 = false;
						value99 = TextureAssets.Extra[131].Value;
					}
					Vector2 origin29 = value99.Size() / 2f;
					EntitySpriteDraw(value99, vector75, null, color91, 0f - num327 + 0.35f, origin29, scale11, dir ^ SpriteEffects.FlipHorizontally);
					EntitySpriteDraw(value99, vector75, null, color83, 0f - num327, origin29, proj.scale, dir ^ SpriteEffects.FlipHorizontally);
					if (flag37)
					{
						EntitySpriteDraw(value91, vector75, null, color90, (0f - num327) * 0.7f, origin23, proj.scale, dir ^ SpriteEffects.FlipHorizontally);
					}
					EntitySpriteDraw(value99, vector75, null, color83 * 0.8f, num327 * 0.5f, origin29, proj.scale * 0.9f, dir);
					color83.A = 0;
					if (proj.type == 813)
					{
						num327 = 0f;
					}
				}
				if (proj.type == 617)
				{
					Microsoft.Xna.Framework.Color color92 = color83 * 0.8f;
					color92.A /= 2;
					Microsoft.Xna.Framework.Color color93 = Microsoft.Xna.Framework.Color.Lerp(color83, Microsoft.Xna.Framework.Color.Black, 0.5f);
					color93.A = color83.A;
					float num348 = 0.95f + (proj.rotation * 0.75f).ToRotationVector2().Y * 0.1f;
					color93 *= num348;
					float scale12 = 0.6f + proj.scale * 0.6f * num348;
					EntitySpriteDraw(TextureAssets.Extra[50].Value, vector75, null, color93, 0f - proj.rotation + 0.35f, origin23, scale12, dir ^ SpriteEffects.FlipHorizontally);
					EntitySpriteDraw(TextureAssets.Extra[50].Value, vector75, null, color83, 0f - proj.rotation, origin23, proj.scale, dir ^ SpriteEffects.FlipHorizontally);
					EntitySpriteDraw(value91, vector75, null, color92, (0f - proj.rotation) * 0.7f, origin23, proj.scale, dir ^ SpriteEffects.FlipHorizontally);
					EntitySpriteDraw(TextureAssets.Extra[50].Value, vector75, null, color83 * 0.8f, proj.rotation * 0.5f, origin23, proj.scale * 0.9f, dir);
					color83.A = 0;
				}
				if (proj.type == 757 || proj.type == 25 || proj.type == 35 || proj.type == 63 || proj.type == 154 || proj.type == 247 || proj.type == 26)
				{
					if (proj.ai[0] == 1f)
					{
						Microsoft.Xna.Framework.Color color94 = color83;
						color94.A = 127;
						color94 *= 0.5f;
						int num349 = (int)proj.ai[1];
						if (num349 > 5)
						{
							num349 = 5;
						}
						for (float num350 = 1f; num350 >= 0f; num350 -= 0.125f)
						{
							float num351 = 1f - num350;
							Vector2 vector88 = proj.velocity * -num349 * num350;
							EntitySpriteDraw(value91, vector75 + vector88, null, color94 * num351, num327, origin23, proj.scale * 1.15f * MathHelper.Lerp(0.5f, 1f, num351), dir);
						}
					}
				}
				else if (proj.type == 79)
				{
					Vector2 scale13 = vector76 * 1.4f;
					Vector2 spinningpoint6 = new Vector2(2f * scale13.X + (float)Math.Cos(GlobalTimeWrappedHourly * ((float)Math.PI * 2f)) * 0.4f, 0f).RotatedBy(num327 + GlobalTimeWrappedHourly * ((float)Math.PI * 2f));
					for (float num352 = 0f; num352 < 1f; num352 += 1f / 6f)
					{
						Microsoft.Xna.Framework.Color color95 = hslToRgb(num352, 1f, 0.5f) * 0.3f;
						color95.A = 0;
						EntitySpriteDraw(value91, vector75 + spinningpoint6.RotatedBy(num352 * ((float)Math.PI * 2f)), null, color95, num327, origin23, scale13, dir);
					}
					EntitySpriteDraw(value91, vector75, null, color83, num327, origin23, vector76, dir);
				}
				if ((0u | ((proj.type == 464 && proj.ai[1] != 1f) ? 1u : 0u)) == 0)
				{
					EntitySpriteDraw(value91, vector75, sourceRectangle2, color83, num327, origin23, vector76, dir);
				}
				if (proj.type == 464 && proj.ai[1] != 1f)
				{
					value91 = TextureAssets.Extra[35].Value;
					Microsoft.Xna.Framework.Rectangle rectangle21 = value91.Frame(1, 3);
					origin23 = rectangle21.Size() / 2f;
					Vector2 vector89 = new Vector2(0f, -720f).RotatedBy(proj.velocity.ToRotation());
					float num353 = proj.ai[0] % 45f / 45f;
					Vector2 spinningpoint7 = vector89 * num353;
					for (int num354 = 0; num354 < 6; num354++)
					{
						float num355 = (float)num354 * ((float)Math.PI * 2f) / 6f;
						Vector2 vector90 = proj.Center + spinningpoint7.RotatedBy(num355);
						EntitySpriteDraw(value91, vector90 - screenPosition, rectangle21, color83, num355 + proj.velocity.ToRotation() + (float)Math.PI, origin23, proj.scale, dir);
						rectangle21.Y += rectangle21.Height;
						if (rectangle21.Y >= value91.Height)
						{
							rectangle21.Y = 0;
						}
					}
				}
				else if (proj.type == 490)
				{
					EntitySpriteDraw(TextureAssets.Extra[34].Value, vector75, null, color83, 0f - proj.rotation, TextureAssets.Extra[34].Value.Size() / 2f, proj.scale, dir);
					EntitySpriteDraw(value91, vector75, null, color83, proj.rotation, origin23, proj.scale * 0.42f, dir);
					EntitySpriteDraw(TextureAssets.Extra[34].Value, vector75, null, color83, 0f - proj.rotation, TextureAssets.Extra[34].Value.Size() / 2f, proj.scale * 0.42f, dir);
				}
				else if (proj.type == 1023)
				{
					Texture2D value100 = TextureAssets.GlowMask[356].Value;
					Microsoft.Xna.Framework.Rectangle rectangle22 = value100.Frame();
					EntitySpriteDraw(origin: rectangle22.Center(), color: new Microsoft.Xna.Framework.Color(255, 255, 255, 100) * proj.Opacity, texture: value100, position: vector75, sourceRectangle: rectangle22, rotation: num327, scale: vector76, effects: dir);
				}
				else if (proj.type == 616)
				{
					value91 = TextureAssets.GlowMask[193].Value;
					EntitySpriteDraw(value91, vector75, null, new Microsoft.Xna.Framework.Color(127, 127, 127, 0), proj.rotation, origin23, proj.scale, dir);
				}
				else if (proj.type >= 646 && proj.type <= 649)
				{
					value91 = TextureAssets.GlowMask[203 + proj.type - 646].Value;
					EntitySpriteDraw(value91, vector75, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 127), proj.rotation, origin23, proj.scale, dir);
				}
				else if (proj.type == 699)
				{
					value91 = TextureAssets.GlowMask[231].Value;
					EntitySpriteDraw(value91, vector75, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 127), num327, origin23, proj.scale, dir);
				}
				else if (proj.type == 707 || proj.type == 708)
				{
					float num356 = 0.5f;
					value91 = TextureAssets.GlowMask[232].Value;
					Microsoft.Xna.Framework.Rectangle value101 = value91.Frame(1, 3, 0, (int)(proj.ai[0] % 9f) / 3);
					if (proj.type == 708)
					{
						value101 = value91.Frame(1, 3, 0, player.itemAnimation % 9 / 3);
						num356 = 0.75f;
					}
					if (proj.isAPreviewDisplayDoll)
					{
						value101 = value91.Frame(1, 3, 0, (int)timeForVisualEffects % 12 / 4);
					}
					Microsoft.Xna.Framework.Color color96 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * num356;
					Vector2 spinningpoint8 = new Vector2(2f, 0f).RotatedBy(proj.rotation);
					for (float num357 = 0f; num357 < 4f; num357 += 1f)
					{
						EntitySpriteDraw(value91, vector75 + spinningpoint8.RotatedBy(num357 * ((float)Math.PI / 2f)), value101, color96 * 0.5f, proj.rotation, origin23, proj.scale, dir);
					}
					EntitySpriteDraw(value91, vector75, value101, color96, proj.rotation, origin23, proj.scale, dir);
				}
				else if (proj.type == 719)
				{
					float num358 = 0.3f;
					Microsoft.Xna.Framework.Color color97 = new Microsoft.Xna.Framework.Color(80, 80, 80, 255) * num358;
					float num359 = proj.scale * 1.5f;
					Vector2 spinningpoint9 = new Vector2(2f * num359, 0f).RotatedBy(proj.rotation);
					for (float num360 = 0f; num360 < 4f; num360 += 1f)
					{
						EntitySpriteDraw(value91, vector75 + -proj.velocity * num360 * 1.25f, null, color97 * 0.7f, proj.rotation, origin23, num359, dir);
					}
					for (float num361 = 0f; num361 < 3f; num361 += 1f)
					{
						EntitySpriteDraw(value91, vector75 + spinningpoint9.RotatedBy(num361 * ((float)Math.PI / 2f)), null, color97 * 0.9f, proj.rotation, origin23, num359, dir);
					}
					EntitySpriteDraw(value91, vector75, null, color83, proj.rotation, origin23, proj.scale, dir);
				}
				else if (proj.type == 16)
				{
					Microsoft.Xna.Framework.Color color98 = new Microsoft.Xna.Framework.Color(80, 80, 80, 0);
					Vector2 scale14 = vector76 + vector76 * (float)Math.Cos(GlobalTimeWrappedHourly * ((float)Math.PI * 2f)) * 0.4f;
					Vector2 spinningpoint10 = new Vector2(2f * scale14.X, 0f).RotatedBy(num327);
					for (float num362 = 0f; num362 < 1f; num362 += 0.25f)
					{
						EntitySpriteDraw(value91, vector75 + spinningpoint10.RotatedBy(num362 * ((float)Math.PI * 2f)), null, color98, num327, origin23, scale14, dir);
					}
					EntitySpriteDraw(value91, vector75, null, color83, num327, origin23, vector76, dir);
				}
				else if (proj.type == 34)
				{
					float lerpValue10 = Utils.GetLerpValue(0f, 6f, proj.localAI[0], clamped: true);
					Microsoft.Xna.Framework.Color color99 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * 0.75f;
					Vector2 scale15 = new Vector2(lerpValue10);
					Vector2 spinningpoint11 = new Vector2(4f * scale15.X, 0f).RotatedBy(num327);
					for (float num363 = 0f; num363 < 1f; num363 += 0.25f)
					{
						EntitySpriteDraw(value91, vector75 + spinningpoint11.RotatedBy(num363 * ((float)Math.PI * 2f)), sourceRectangle2, color99, num327, origin23, scale15, dir);
					}
				}
				return;
			}
			if (proj.type == 465 || proj.type == 467 || proj.type == 468 || proj.type == 500 || proj.type == 518 || proj.type == 535 || proj.type == 539 || proj.type == 575 || proj.type == 574 || proj.type == 589 || proj.type == 590 || proj.type == 593 || proj.type == 602 || proj.type == 596 || proj.type == 612 || proj.type == 953 || proj.type == 613 || proj.type == 614 || proj.type == 623 || proj.type == 625 || proj.type == 626 || proj.type == 627 || proj.type == 628 || proj.type == 634 || proj.type == 635 || proj.type == 643 || proj.type == 644 || proj.type == 645 || proj.type == 650 || proj.type == 652 || proj.type == 658 || proj.type == 659 || proj.type == 663 || proj.type == 665 || proj.type == 667 || proj.type == 677 || proj.type == 678 || proj.type == 679 || proj.type == 691 || proj.type == 692 || proj.type == 693 || proj.type == 702 || proj.type == 703 || proj.type == 701 || proj.type == 712 || proj.type == 715 || proj.type == 716 || proj.type == 717 || proj.type == 718 || proj.type == 758 || proj.type == 759 || proj.type == 764 || proj.type == 779 || proj.type == 783 || proj.type == 773 || proj.type == 820 || proj.type == 831 || proj.type == 970 || proj.type == 836 || proj.type == 851 || proj.type == 855 || proj.type == 856 || proj.type == 857 || proj.type == 861 || proj.type == 862 || proj.type == 863 || proj.type == 866 || proj.type == 870 || proj.type == 882 || proj.type == 885 || proj.type == 889 || proj.type == 895 || proj.type == 896 || proj.type == 898 || proj.type == 903 || proj.type == 904 || proj.type == 905 || proj.type == 906 || proj.type == 908 || proj.type == 910 || proj.type == 911 || proj.type == 951 || proj.type == 957 || proj.type == 962 || proj.type == 963 || proj.type == 967 || proj.type == 968 || proj.type == 978 || proj.type == 995 || proj.type == 886 || proj.type == 892 || proj.type == 1024 || proj.type == 1044 || proj.type == 1038 || proj.type == 1050 || proj.type == 1086 || proj.type == 1087 || proj.type == 1088 || proj.type == 1092 || proj.type == 1098 || proj.type == 1105 || proj.type == 1094)
			{
				Vector2 vector91 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Texture2D texture2D4 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Rectangle rectangle23 = texture2D4.Frame(1, projFrames[proj.type], 0, proj.frame);
				if (proj.type == 963)
				{
					rectangle23 = texture2D4.Frame(4, projFrames[proj.type], 0, proj.frame);
				}
				if (proj.type == 957)
				{
					int horizontalFrames = 3;
					int frameX = proj.frame / projFrames[proj.type];
					int frameY2 = proj.frame % projFrames[proj.type];
					rectangle23 = texture2D4.Frame(horizontalFrames, projFrames[proj.type], frameX, frameY2);
				}
				if (proj.type == 962)
				{
					int verticalFrames = 4;
					int frameY3 = proj.frame / projFrames[proj.type];
					int frameX2 = proj.frame % projFrames[proj.type];
					rectangle23 = texture2D4.Frame(projFrames[proj.type], verticalFrames, frameX2, frameY3);
				}
				if (proj.type == 1092)
				{
					int frameX3 = proj.frame / 9;
					int frameY4 = proj.frame % 9;
					rectangle23 = texture2D4.Frame(6, 9, frameX3, frameY4);
				}
				if (proj.type == 1094)
				{
					TryPetting(proj, 5664);
					int num364 = 9;
					int num365 = proj.frame / num364;
					int num366 = proj.frame % num364;
					rectangle23 = new Microsoft.Xna.Framework.Rectangle(num365 * 64, num366 * 46, 62, 44);
					if (proj.ai[0] >= 1000f)
					{
						dir ^= SpriteEffects.FlipHorizontally;
					}
					vector91.Y -= 11f;
					int num367 = 60;
					int emoteId = 0;
					if (proj.localAI[2] < (float)num367 && proj.localAI[2] > 1f)
					{
						EmoteBubble.DrawTemporaryBubble(spriteBatch, emoteId, num367, (int)proj.localAI[2], proj);
					}
				}
				Microsoft.Xna.Framework.Color color100 = proj.GetAlpha(projectileColor);
				if (proj.type == 623 && CurrentDrawnEntityShader != 0)
				{
					color100.A = 127;
				}
				if (proj.type == 995)
				{
					Projectile.AI_192_GetJuminoFall(proj, out var timeSinceFall, out var fall);
					vector91.Y -= 4f;
					vector91.Y += fall;
					float amount = Utils.Remap(timeSinceFall, 0f, 10f, 1f, 0f);
					color100 = Microsoft.Xna.Framework.Color.Lerp(color100, Microsoft.Xna.Framework.Color.White * proj.Opacity, amount);
				}
				if (proj.type == 1098)
				{
					vector91.Y -= 2f;
				}
				if (proj.type == 1105)
				{
					vector91.Y -= 2f;
					if (proj.velocity.Y == 0f)
					{
						vector91.Y += 4f * Utils.GetLerpValue(0f, (float)Math.PI / 4f, Math.Abs(proj.rotation), clamped: true);
					}
					else
					{
						vector91.Y += 4f;
					}
				}
				Vector2 origin30 = rectangle23.Size() / 2f;
				if (proj.type == 703)
				{
					rectangle23.Height -= 2;
				}
				if (proj.type == 1094)
				{
					origin30.X += dir.HasFlag(SpriteEffects.FlipHorizontally).ToDirectionInt() * -8;
					if (proj.ai[0] >= 1000f)
					{
						texture2D4 = TextureAssets.Extra[303].Value;
						rectangle23 = texture2D4.Frame(1, 3);
						origin30 = rectangle23.Size() / 2f;
						origin30.X += proj.spriteDirection * -10;
						origin30.Y += -6f;
					}
				}
				if (proj.type == 957)
				{
					float num368 = (float)(Math.Cos((float)(int)mouseTextColor / 255f * ((float)Math.PI * 2f) * 2f) * 4.0);
					num368 *= Math.Max(0f, Math.Min(1f, proj.localAI[0] / 100f));
					float num369 = 0f;
					if (proj.frame > projFrames[proj.type] * 2)
					{
						switch (proj.frame % projFrames[proj.type])
						{
						case 5:
						case 11:
							num369 = 2f;
							break;
						case 6:
						case 10:
							num369 = 6f;
							break;
						case 7:
							num369 = 8f;
							break;
						case 8:
						case 9:
							num369 = 10f;
							break;
						}
					}
					vector91.Y += -2f + num368 + num369;
				}
				if (proj.type == 895 || proj.type == 896 || proj.type == 898 || proj.type == 963)
				{
					float num370 = 2f;
					if (proj.isAPreviewDummy)
					{
						num370 = 0.5f;
					}
					vector91.Y += 0f - num370 + (float)(Math.Cos((float)(int)mouseTextColor / 255f * ((float)Math.PI * 2f) * 2f) * (double)(num370 * 2f));
				}
				if (proj.type == 963 && proj.localAI[1] >= 0f)
				{
					float num371 = proj.localAI[1];
					float num372 = 1f - num371;
					Microsoft.Xna.Framework.Color color101 = proj.GetAlpha(new Microsoft.Xna.Framework.Color(255, 220, 220)) * num372 * num372 * 0.8f;
					color101.A = 0;
					short num373 = 536;
					LoadProjectile(num373);
					Texture2D value102 = TextureAssets.Projectile[num373].Value;
					Vector2 origin31 = value102.Size() * new Vector2(0.5f, 1f);
					float num374 = 9f;
					float num375 = proj.velocity.ToRotation();
					if (proj.velocity.Length() < 0.1f)
					{
						num375 = ((proj.direction == 1) ? 0f : ((float)Math.PI));
					}
					Vector2 value103 = (num375 + (float)Math.PI / 2f).ToRotationVector2();
					for (int num376 = 0; (float)num376 < num374; num376++)
					{
						float num377 = ((num376 % 2 != 0) ? 1 : (-1));
						float num378 = ((float)num376 + 1f) * num377 * 0.2f * (0.2f + 2f * num371) + num375 + (float)Math.PI / 2f;
						float num379 = Utils.Remap(Vector2.Dot(num378.ToRotationVector2(), value103), -1f, 1f, 0f, 1f);
						float num380 = proj.scale * (0.15f + 0.6f * (float)Math.Sin(GlobalTimeWrappedHourly + (float)num376 * 0.739f)) * num379;
						EntitySpriteDraw(value102, vector91 + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI * 2f * (1f / num374) * (float)num376 + GlobalTimeWrappedHourly) * 4f * proj.scale, null, color101 * num379, num378, origin31, new Vector2(num380 * 1.5f, num380), SpriteEffects.None);
					}
				}
				if (proj.type == 962)
				{
					float num381 = Utils.Remap(proj.ai[0], 0f, 30f, 1f, 0f);
					Microsoft.Xna.Framework.Color color102 = proj.GetAlpha(Microsoft.Xna.Framework.Color.White) * num381 * num381 * 0.3f;
					color102.A = 0;
					for (int num382 = 0; num382 < 4; num382++)
					{
						EntitySpriteDraw(texture2D4, vector91 + proj.rotation.ToRotationVector2().RotatedBy((float)Math.PI / 2f * (float)num382) * 2f * proj.scale, rectangle23, color102, proj.rotation, origin30, proj.scale, dir);
					}
				}
				if (proj.type == 855)
				{
					float y19 = (GlobalTimeWrappedHourly % 6f / 6f * ((float)Math.PI * 2f)).ToRotationVector2().Y;
					float num383 = y19 * 0.3f + 0.7f;
					Microsoft.Xna.Framework.Color color103 = color100 * num383 * 0.3f;
					for (int num384 = 0; num384 < 4; num384++)
					{
						float x11 = 0f;
						float y20 = 0f;
						switch (num384)
						{
						case 0:
							x11 = 4f;
							break;
						case 1:
							x11 = -4f;
							break;
						case 2:
							y20 = 4f;
							break;
						case 3:
							y20 = -4f;
							break;
						}
						Vector2 vector92 = new Vector2(x11, y20).RotatedBy(proj.rotation) * y19;
						spriteBatch.Draw(texture2D4, vector91 + vector92, rectangle23, color103, proj.rotation, rectangle23.Size() / 2f, 1f, SpriteEffects.None, 0f);
					}
				}
				else if (proj.type == 908)
				{
					PlayerTitaniumStormBuffTextureContent playerTitaniumStormBuff = TextureAssets.RenderTargets.PlayerTitaniumStormBuff;
					vector91 += (GlobalTimeWrappedHourly * 8f + (float)proj.whoAmI).ToRotationVector2() * 4f;
					playerTitaniumStormBuff.Request();
					if (playerTitaniumStormBuff.IsReady)
					{
						texture2D4 = playerTitaniumStormBuff.GetTarget();
					}
					rectangle23 = texture2D4.Frame(projFrames[proj.type], 1, proj.frame);
					origin30 = rectangle23.Size() / 2f;
				}
				else if (proj.type == 764)
				{
					DrawProjWithStarryTrail(proj, player, projectileColor, dir);
				}
				else if (proj.type == 856)
				{
					DrawProjWithStarryTrail(proj, player, projectileColor, dir);
				}
				else if (proj.type == 857)
				{
					DrawProjWithStarryTrail(proj, player, projectileColor, dir);
					color100 = Microsoft.Xna.Framework.Color.White * proj.Opacity * 0.9f;
					color100.A /= 2;
					rectangle23 = texture2D4.Frame(15, 1, proj.frame);
					origin30 = rectangle23.Size() / 2f;
					DrawPrettyStarSparkle(proj.Opacity, dir, vector91, color100, proj.GetFirstFractalColor(), proj.localAI[0], 15f, 30f, 30f, 45f, 0f, new Vector2(5f, 2f), Vector2.One);
				}
				else if (proj.type == 539)
				{
					if (proj.ai[0] >= 210f)
					{
						float num385 = proj.ai[0] - 210f;
						num385 /= 20f;
						if (num385 > 1f)
						{
							num385 = 1f;
						}
						EntitySpriteDraw(TextureAssets.Extra[46].Value, vector91, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 128) * num385, proj.rotation, new Vector2(17f, 22f), proj.scale, dir);
					}
				}
				else if (proj.type == 773)
				{
					origin30.Y = rectangle23.Height - 12;
				}
				else if (proj.type == 866)
				{
					origin30.X += 14f;
				}
				else if (proj.type == 759)
				{
					origin30.Y = rectangle23.Height - 2;
					origin30.X += (((dir & SpriteEffects.FlipHorizontally) != SpriteEffects.None) ? 1 : (-1));
				}
				else if (proj.type == 758)
				{
					vector91.Y += proj.height / 2;
					origin30 = rectangle23.Size() * new Vector2(0.5f, 1f);
					origin30.Y -= 4f;
				}
				else if (proj.type == 951)
				{
					vector91.Y += proj.height / 2;
					vector91.Y -= (float)rectangle23.Height * 0.5f;
					vector91.Y += 4f;
					origin30 = rectangle23.Size() * new Vector2(0.5f, 0.5f);
				}
				else if (proj.type == 833)
				{
					if (proj.frame != 8)
					{
						vector91.Y += proj.height / 2;
						origin30 = rectangle23.Size() * new Vector2(0.5f, 1f);
						origin30.Y -= 4f;
						origin30.X -= 7 * ((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt();
					}
				}
				else if (proj.type == 834 || proj.type == 835)
				{
					if (proj.frame != 10)
					{
						vector91.Y += proj.height / 2;
						origin30 = rectangle23.Size() * new Vector2(0.5f, 1f);
						origin30.Y -= 4f;
						origin30.X -= 2 * ((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt();
					}
				}
				else if (proj.type == 715 || proj.type == 716 || proj.type == 717 || proj.type == 718)
				{
					rectangle23 = texture2D4.Frame(3);
					origin30 = rectangle23.Size() / 2f;
					int num386 = (int)proj.ai[0];
					Vector2 origin32 = new Vector2(rectangle23.Width / 2, 0f);
					Vector2 vector93 = proj.Size / 2f;
					Microsoft.Xna.Framework.Color celeb2Color = proj.GetCeleb2Color();
					celeb2Color.A = 127;
					celeb2Color *= 0.8f;
					Microsoft.Xna.Framework.Rectangle value104 = rectangle23;
					value104.X += value104.Width * 2;
					for (int num387 = proj.oldPos.Length - 1; num387 > 0; num387--)
					{
						Vector2 vector94 = proj.oldPos[num387] + vector93;
						if (!(vector94 == vector93))
						{
							Vector2 value105 = proj.oldPos[num387 - 1] + vector93;
							float num388 = proj.oldRot[num387];
							Vector2 scale16 = new Vector2(Vector2.Distance(vector94, value105) / (float)rectangle23.Width, 1f);
							Microsoft.Xna.Framework.Color color104 = celeb2Color * (1f - (float)num387 / (float)proj.oldPos.Length);
							switch (num386)
							{
							case 2:
							{
								Vector2 vector95 = num388.ToRotationVector2();
								int num389 = num387 + proj.timeLeft;
								if (num389 < 0)
								{
									num389 += 20 * (num389 / -20) + 20;
								}
								num389 %= 20;
								float num390 = 0f;
								scale16 *= 0.6f;
								switch (num389)
								{
								case 1:
									num390 = 1f;
									break;
								case 2:
									num390 = 2f;
									break;
								case 3:
									num390 = 3f;
									break;
								case 4:
									num390 = 2f;
									break;
								case 5:
									num390 = 1f;
									break;
								case 7:
									num390 = -1f;
									break;
								case 8:
									num390 = -2f;
									break;
								case 9:
									num390 = -3f;
									break;
								case 10:
									num390 = -2f;
									break;
								case 11:
									num390 = -1f;
									break;
								}
								vector94 += vector95 * num390 * 4f;
								break;
							}
							case 5:
								scale16 *= 0.5f;
								break;
							}
							EntitySpriteDraw(texture2D4, vector94 - screenPosition, value104, color104, num388, origin32, scale16, dir);
						}
					}
				}
				else if (proj.type == 663 || proj.type == 665 || proj.type == 667)
				{
					vector91 = proj.Bottom + Vector2.UnitY * proj.gfxOffY - screenPosition;
					origin30 = rectangle23.Size() * new Vector2(0.5f, 1f);
					origin30.Y -= 2f;
					origin30.Y -= 2f;
				}
				else if (proj.type == 691 || proj.type == 692 || proj.type == 693)
				{
					vector91 = proj.Bottom + Vector2.UnitY * proj.gfxOffY - screenPosition;
					origin30 = rectangle23.Size() * new Vector2(0.5f, 1f);
					origin30.Y -= 2f;
					origin30.Y -= 2f;
				}
				else if (proj.type == 677 || proj.type == 678 || proj.type == 679)
				{
					if (proj.spriteDirection == -1)
					{
						dir ^= SpriteEffects.FlipHorizontally | SpriteEffects.FlipVertically;
					}
					Texture2D value106 = TextureAssets.Extra[83].Value;
					if (proj.type == 678)
					{
						value106 = TextureAssets.Extra[84].Value;
					}
					if (proj.type == 679)
					{
						value106 = TextureAssets.Extra[85].Value;
					}
					Vector2 position24 = proj.Bottom + Vector2.UnitY * proj.gfxOffY - screenPosition;
					Vector2 origin33 = value106.Size() * new Vector2(0.5f, 1f);
					origin33.Y -= 2f;
					EntitySpriteDraw(value106, position24, null, color100, 0f, origin33, 1f, dir & SpriteEffects.FlipHorizontally);
					origin30.X += ((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt();
					vector91.Y += 1f;
					vector91.Y += 2f;
					if (proj.type == 678)
					{
						vector91.Y += -4f;
					}
					if (proj.type == 679)
					{
						vector91.Y -= 2f;
						if ((dir & SpriteEffects.FlipVertically) == 0)
						{
							origin30.Y += 4f;
						}
						else
						{
							origin30.Y -= 4f;
						}
						origin30.X += ((dir & SpriteEffects.FlipHorizontally) != 0).ToDirectionInt() * 4;
					}
				}
				else if (proj.type == 602)
				{
					origin30.X = rectangle23.Width - 6;
					origin30.Y -= 1f;
					rectangle23.Height -= 2;
				}
				else if (proj.type == 589)
				{
					rectangle23 = texture2D4.Frame(5, 1, (int)proj.ai[1]);
					origin30 = rectangle23.Size() / 2f;
				}
				else if (proj.type == 590)
				{
					if (proj.ai[2] == 1f && proj.frame < 3)
					{
						proj.frame = 3;
					}
					rectangle23 = texture2D4.Frame(6, 1, proj.frame);
					origin30 = rectangle23.Size() / 2f;
				}
				else if (proj.type == 836)
				{
					rectangle23 = texture2D4.Frame(4, 1, proj.frame);
					origin30 = rectangle23.Size() / 2f;
				}
				else if (proj.type == 650 || proj.type == 882 || proj.type == 888 || proj.type == 894 || proj.type == 895 || proj.type == 896 || proj.type == 898 || proj.type == 901 || proj.type == 957)
				{
					origin30.Y -= 4f;
				}
				else if (proj.type == 623)
				{
					if (!gamePaused && proj.ai[0] == 2f)
					{
						vector91 += rand.NextVector2Circular(2f, 2f);
					}
					if (CurrentDrawnEntityShader == 0)
					{
						color100.A /= 2;
					}
				}
				else if (proj.type >= 625 && proj.type <= 628)
				{
					color100.A /= 2;
				}
				else if (proj.type == 644)
				{
					Microsoft.Xna.Framework.Color color105 = hslToRgb(proj.ai[0], 1f, 0.5f).MultiplyRGBA(new Microsoft.Xna.Framework.Color(255, 255, 255, 0));
					EntitySpriteDraw(texture2D4, vector91, rectangle23, color105, proj.rotation, origin30, proj.scale * 2f, dir);
					EntitySpriteDraw(texture2D4, vector91, rectangle23, color105, 0f, origin30, proj.scale * 2f, dir);
					if (proj.ai[1] != -1f && proj.Opacity > 0.3f)
					{
						Vector2 vector96 = Main.projectile[(int)proj.ai[1]].Center - proj.Center;
						Vector2 vector97 = new Vector2(1f, vector96.Length() / (float)texture2D4.Height);
						float rotation31 = vector96.ToRotation() + (float)Math.PI / 2f;
						float value107 = MathHelper.Distance(30f, proj.localAI[1]) / 20f;
						value107 = MathHelper.Clamp(value107, 0f, 1f);
						if (value107 > 0f)
						{
							EntitySpriteDraw(texture2D4, vector91 + vector96 / 2f, rectangle23, color105 * value107, rotation31, origin30, vector97, dir);
							EntitySpriteDraw(texture2D4, vector91 + vector96 / 2f, rectangle23, color100 * value107, rotation31, origin30, vector97 / 2f, dir);
						}
					}
				}
				else if (proj.type == 658)
				{
					Microsoft.Xna.Framework.Color color106 = hslToRgb(0.136f, 1f, 0.5f).MultiplyRGBA(new Microsoft.Xna.Framework.Color(255, 255, 255, 0));
					EntitySpriteDraw(texture2D4, vector91, rectangle23, color106, 0f, origin30, new Vector2(1f, 5f) * proj.scale * 2f, dir);
				}
				EntitySpriteDraw(texture2D4, vector91, rectangle23, color100, proj.rotation, origin30, proj.scale, dir);
				if (proj.type == 896)
				{
					Texture2D value108 = TextureAssets.GlowMask[278].Value;
					Microsoft.Xna.Framework.Color color107 = new Microsoft.Xna.Framework.Color(150, 150, 150, 100);
					for (int num391 = 0; num391 < 2; num391++)
					{
						Vector2 position25 = vector91 + new Vector2((float)rand.Next(-10, 11) * 0.1f, (float)rand.Next(-10, 11) * 0.1f);
						EntitySpriteDraw(value108, position25, rectangle23, color107, proj.rotation, origin30, proj.scale, dir);
					}
					EntitySpriteDraw(value108, vector91, rectangle23, Microsoft.Xna.Framework.Color.White, proj.rotation, origin30, proj.scale, dir);
				}
				if (proj.type == 1098)
				{
					Texture2D value109 = TextureAssets.GlowMask[377].Value;
					Microsoft.Xna.Framework.Color color108 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127);
					float num392 = 1f;
					if (proj.frame == 0)
					{
						color108 = Microsoft.Xna.Framework.Color.Lerp(color108, new Microsoft.Xna.Framework.Color(100, 210, 255, 127), Utils.Remap(proj.Opacity, 0f, 0.7f, 0f, 1f));
						color108 *= Utils.Remap(proj.Opacity, 0f, 0.7f, 0f, 1f) * Utils.Remap(proj.Opacity, 0.7f, 1f, 1f, 0f);
						num392 = Utils.Remap(proj.Opacity, 0f, 1f, 1f, 1.05f);
					}
					else
					{
						color108 *= Utils.Remap(proj.localAI[1], 5f, 10f, 0f, 1f);
					}
					TryPetting(proj, 5667);
					EntitySpriteDraw(value109, vector91, rectangle23, color108, proj.rotation, origin30, proj.scale * num392, dir);
					proj.direction = -proj.spriteDirection;
					int num393 = 60;
					if (proj.ai[0] == 5f)
					{
						if (proj.ai[1] < (float)num393)
						{
							EmoteBubble.DrawTemporaryBubble(spriteBatch, 0, num393, num393 - (int)proj.ai[1], proj);
						}
					}
					else if (proj.ai[0] == 4f)
					{
						if (proj.ai[1] < (float)num393)
						{
							EmoteBubble.DrawTemporaryBubble(spriteBatch, 17, num393, num393 - (int)proj.ai[1], proj);
						}
					}
					else if (proj.ai[0] != 0f && proj.ai[1] < 40f)
					{
						EmoteBubble.DrawTemporaryBubble(spriteBatch, 3, num393, 40 - (int)proj.ai[1], proj);
					}
					proj.direction = proj.spriteDirection;
				}
				if (proj.type == 889)
				{
					Texture2D value110 = TextureAssets.GlowMask[276].Value;
					Microsoft.Xna.Framework.Color color109 = Microsoft.Xna.Framework.Color.White * (int)mouseTextColor;
					EntitySpriteDraw(value110, vector91, rectangle23, color109, proj.rotation, origin30, proj.scale, dir);
					if (!proj.isAPreviewDummy)
					{
						for (int num394 = 0; num394 < 4; num394++)
						{
							int num395 = 28;
							int num396 = 7 + num394;
							float num397 = 100f;
							bool flag38 = num396 == 8;
							Microsoft.Xna.Framework.Rectangle value111 = texture2D4.Frame(1, projFrames[proj.type], 0, num396);
							Vector2 value112 = vector91;
							Vector2 vector98 = vector91;
							SpriteEffects effects4 = SpriteEffects.None;
							float num398 = 0f;
							float num399 = GlobalTimeWrappedHourly * 2f;
							switch (num394)
							{
							case 1:
								num399 += (float)Math.PI / 2f;
								break;
							case 2:
								num399 += (float)Math.PI;
								break;
							case 3:
								num399 += 4.712389f;
								break;
							}
							num399 *= 3f;
							num398 = num399;
							vector98 += num399.ToRotationVector2() * num395;
							if (proj.localAI[0] == num397)
							{
								EntitySpriteDraw(texture2D4, vector98, value111, color100, num398, origin30, proj.scale, effects4);
								if (flag38)
								{
									EntitySpriteDraw(value110, vector98, value111, color109, num398, origin30, proj.scale, effects4);
								}
								continue;
							}
							Vector2 vector99 = new Vector2(num395, -16f) + proj.velocity * 1.5f;
							float num400 = 4f;
							float num401 = -0.35f;
							switch (num394)
							{
							case 1:
								vector99.X *= -1f;
								effects4 = SpriteEffects.FlipHorizontally;
								num401 = 0.35f;
								num400 = -3f;
								break;
							case 2:
								vector99.Y = 16f;
								num401 = 0.35f;
								num400 = 2f;
								break;
							case 3:
								vector99.X *= -1f;
								vector99.Y = 16f;
								effects4 = SpriteEffects.FlipHorizontally;
								num401 = -0.35f;
								num400 = -1f;
								break;
							}
							vector99 += (GlobalTimeWrappedHourly * num400).ToRotationVector2() * 4f;
							value112 += vector99;
							float num402 = proj.localAI[0] / num397;
							value112 = Vector2.Lerp(value112, vector98, num402);
							num398 = ((num402 > 0.5f) ? num399 : num401);
							EntitySpriteDraw(texture2D4, value112, value111, color100, num398, origin30, proj.scale, effects4);
							if (flag38)
							{
								EntitySpriteDraw(value110, value112, value111, color109, num398, origin30, proj.scale, effects4);
							}
						}
					}
				}
				if (proj.type == 885 && !proj.isAPreviewDummy)
				{
					for (int num403 = 0; num403 < 2; num403++)
					{
						SpriteEffects effects5 = SpriteEffects.None;
						int num404 = -30;
						if (num403 == 1)
						{
							num404 = 30;
							effects5 = SpriteEffects.FlipHorizontally;
						}
						int num405 = (int)proj.localAI[0];
						if (proj.frame == 6)
						{
							num405 = 0;
						}
						else if (num403 == 1)
						{
							num405 = 2 - num405;
						}
						num405 += 7;
						Microsoft.Xna.Framework.Rectangle value113 = texture2D4.Frame(1, projFrames[proj.type], 0, num405);
						Vector2 position26 = vector91 + new Vector2(num404, 0f);
						Vector2 vector100 = (GlobalTimeWrappedHourly * 2f).ToRotationVector2() * 4f;
						vector100 += proj.velocity * -1.5f;
						Vector2 vector101 = (GlobalTimeWrappedHourly * 1f).ToRotationVector2() * 3f;
						if (num403 == 1)
						{
							position26 += vector100 + vector101;
						}
						else
						{
							position26 -= vector100;
						}
						EntitySpriteDraw(texture2D4, position26, value113, color100, 0f, origin30, proj.scale, effects5);
					}
				}
				if (proj.type == 535)
				{
					for (int num406 = 0; num406 < 1000; num406++)
					{
						if (Main.projectile[num406].active && Main.projectile[num406].owner == proj.owner && Main.projectile[num406].type == 536)
						{
							DrawProj(num406);
						}
					}
				}
				if (proj.type == 1038)
				{
					DrawPrettyStarSparkle(shineColor: new Microsoft.Xna.Framework.Color(255, 0, 77), opacity: proj.Opacity, dir: SpriteEffects.None, drawpos: vector91, drawColor: new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f, flareCounter: proj.ai[0], fadeInStart: 0f, fadeInEnd: 5f, fadeOutStart: 5f, fadeOutEnd: 20f, rotation: (float)Math.PI / 2f, scale: new Vector2(0.7f, 1.5f), fatness: Vector2.One);
				}
				else if (proj.type == 715 || proj.type == 716 || proj.type == 717 || proj.type == 718)
				{
					rectangle23.X += rectangle23.Width;
					Microsoft.Xna.Framework.Color celeb2Color2 = proj.GetCeleb2Color();
					celeb2Color2.A = 80;
					EntitySpriteDraw(texture2D4, vector91, rectangle23, celeb2Color2, proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 702)
				{
					Texture2D value114 = TextureAssets.Flames[5].Value;
					Vector2 origin34 = value114.Size() / 2f;
					Vector2 vector102 = new Vector2(5 * proj.spriteDirection, -10f).RotatedBy(proj.rotation);
					ulong seed2 = (ulong)(proj.localAI[0] / 4f);
					for (int num407 = 0; num407 < 5; num407++)
					{
						Microsoft.Xna.Framework.Color color110 = new Microsoft.Xna.Framework.Color(100, 100, 100, 0);
						float x12 = (float)Utils.RandomInt(ref seed2, -10, 11) * 0.15f;
						float y21 = (float)Utils.RandomInt(ref seed2, -10, 1) * 0.35f;
						EntitySpriteDraw(value114, vector91 + vector102 + new Vector2(x12, y21), null, color110, proj.rotation, origin34, 1f, dir);
					}
				}
				else if (proj.type == 663 || proj.type == 665 || proj.type == 667)
				{
					Texture2D value115 = TextureAssets.GlowMask[221].Value;
					switch (proj.type)
					{
					case 665:
						value115 = TextureAssets.GlowMask[222].Value;
						break;
					case 667:
						value115 = TextureAssets.GlowMask[223].Value;
						break;
					}
					float num408 = (proj.localAI[0] / 100f * ((float)Math.PI * 2f)).ToRotationVector2().X * 1f + 1f;
					Microsoft.Xna.Framework.Color color111 = new Microsoft.Xna.Framework.Color(140, 100, 40, 0) * (num408 / 4f + 0.5f) * 1f;
					for (float num409 = 0f; num409 < 4f; num409 += 1f)
					{
						EntitySpriteDraw(value115, vector91 + (num409 * ((float)Math.PI / 2f)).ToRotationVector2() * num408, rectangle23, color111, proj.rotation, origin30, proj.scale, dir);
					}
				}
				else if (proj.type == 644)
				{
					EntitySpriteDraw(texture2D4, vector91, rectangle23, color100, 0f, origin30, proj.scale, dir);
				}
				else if (proj.type == 963)
				{
					int num410 = player.ownedProjectileCounts[970] - 1;
					int num411 = (num410 + 3) % 3;
					int num412 = num410 / 3;
					Vector3 vector103 = rgbToHsl(new Microsoft.Xna.Framework.Color(250, 150, 180));
					vector103 = new Vector3(0f, 1f, 0.6f);
					if (num412 == 1)
					{
						vector103 = rgbToHsl(Microsoft.Xna.Framework.Color.HotPink);
						vector103.Z += 0.1f;
						vector103.X -= 0.05f;
					}
					vector103.X = (vector103.X - (float)num412 * 0.13f + 1f) % 1f;
					Microsoft.Xna.Framework.Color oldColor = hslToRgb(vector103);
					Microsoft.Xna.Framework.Color color112 = Lighting.GetColor((int)(proj.Center.X / 16f), (int)(proj.Center.Y / 16f), oldColor);
					rectangle23.X += rectangle23.Width * (1 + num411);
					EntitySpriteDraw(texture2D4, vector91, rectangle23, color112, proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 773 && proj.velocity.Length() == 0f)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[266].Value, color: Microsoft.Xna.Framework.Color.White * (int)mouseTextColor, position: vector91, sourceRectangle: rectangle23, rotation: proj.rotation, origin: origin30, scale: proj.scale, effects: dir);
				}
				else if (proj.type == 658)
				{
					EntitySpriteDraw(texture2D4, vector91, rectangle23, color100, 0f, origin30, new Vector2(1f, 8f) * proj.scale, dir);
				}
				else if (proj.type == 602)
				{
					texture2D4 = TextureAssets.Extra[60].Value;
					Microsoft.Xna.Framework.Color color113 = color100;
					color113.A = 0;
					color113 *= 0.3f;
					origin30 = texture2D4.Size() / 2f;
					EntitySpriteDraw(texture2D4, vector91, null, color113, proj.rotation - (float)Math.PI / 2f, origin30, proj.scale, dir);
					texture2D4 = TextureAssets.Extra[59].Value;
					color113 = color100;
					color113.A = 0;
					color113 *= 0.13f;
					origin30 = texture2D4.Size() / 2f;
					EntitySpriteDraw(texture2D4, vector91, null, color113, proj.rotation - (float)Math.PI / 2f, origin30, proj.scale * 0.9f, dir);
				}
				else if (proj.type == 539)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[140].Value, vector91, rectangle23, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 613)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[189].Value, vector91, rectangle23, new Microsoft.Xna.Framework.Color(128 - proj.alpha / 2, 128 - proj.alpha / 2, 128 - proj.alpha / 2, 0), proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 614)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[190].Value, vector91, rectangle23, new Microsoft.Xna.Framework.Color(128 - proj.alpha / 2, 128 - proj.alpha / 2, 128 - proj.alpha / 2, 0), proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 574)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[148].Value, vector91, rectangle23, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 691 || proj.type == 692 || proj.type == 693)
				{
					Texture2D value116 = TextureAssets.GlowMask[235].Value;
					switch (proj.type)
					{
					case 692:
						value116 = TextureAssets.GlowMask[236].Value;
						break;
					case 693:
						value116 = TextureAssets.GlowMask[237].Value;
						break;
					}
					EntitySpriteDraw(value116, vector91, rectangle23, new Microsoft.Xna.Framework.Color(255, 255, 255, 127), proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 590)
				{
					EntitySpriteDraw(TextureAssets.GlowMask[168].Value, vector91, rectangle23, new Microsoft.Xna.Framework.Color(127 - proj.alpha / 2, 127 - proj.alpha / 2, 127 - proj.alpha / 2, 0), proj.rotation, origin30, proj.scale, dir);
				}
				else if (proj.type == 623 || (proj.type >= 625 && proj.type <= 628))
				{
					if (player.ghostFade != 0f)
					{
						float num413 = player.ghostFade * 5f;
						for (float num414 = 0f; num414 < 4f; num414 += 1f)
						{
							EntitySpriteDraw(texture2D4, vector91 + Vector2.UnitY.RotatedBy(num414 * ((float)Math.PI * 2f) / 4f) * num413, rectangle23, color100 * 0.1f, proj.rotation, origin30, proj.scale, dir);
						}
					}
					if (proj.type == 623 && proj.ai[0] == 2f && proj.frame >= 14)
					{
						DrawProj_StardustGuardianPunching(proj);
					}
				}
				else if (proj.type == 643)
				{
					float num415 = (float)Math.Cos((float)Math.PI * 2f * (proj.localAI[0] / 60f)) + 3f + 3f;
					for (float num416 = 0f; num416 < 4f; num416 += 1f)
					{
						EntitySpriteDraw(texture2D4, vector91 + Vector2.UnitY.RotatedBy(num416 * ((float)Math.PI / 2f)) * num415, rectangle23, color100 * 0.2f, proj.rotation, origin30, proj.scale, dir);
					}
				}
				else if (proj.type == 650)
				{
					int num417 = (int)(proj.localAI[0] / ((float)Math.PI * 2f));
					float f = proj.localAI[0] % ((float)Math.PI * 2f) - (float)Math.PI;
					float num418 = (float)Math.IEEERemainder(proj.localAI[1], 1.0);
					if (num418 < 0f)
					{
						num418 += 1f;
					}
					int num419 = (int)Math.Floor(proj.localAI[1]);
					float num420 = 1f;
					float num421 = 5f;
					num420 = 1f + (float)num419 * 0.02f;
					if ((float)num417 == 1f)
					{
						num421 = 7f;
					}
					Vector2 vector104 = f.ToRotationVector2() * num418 * num421 * proj.scale;
					texture2D4 = TextureAssets.Extra[66].Value;
					EntitySpriteDraw(texture2D4, vector91 + vector104, null, color100, proj.rotation, texture2D4.Size() / 2f, num420, SpriteEffects.None);
				}
				else if (proj.type == 1092)
				{
					float a2 = Utils.Remap(proj.ai[1], 100f, 120f, 0f, 1f);
					EntitySpriteDraw(color: new Microsoft.Xna.Framework.Color(1f, 1f, 1f, a2), texture: texture2D4, position: vector91, sourceRectangle: rectangle23, rotation: proj.rotation, origin: origin30, scale: proj.scale, effects: dir);
				}
				if (proj.type != 1094)
				{
					return;
				}
				Microsoft.Xna.Framework.Rectangle value117 = rectangle23;
				int num422 = 414;
				if (proj.ai[0] >= 1000f)
				{
					num422 = rectangle23.Height + 2;
				}
				value117.Offset(0, num422 * 2);
				ulong seed3 = TileFrameSeed;
				for (int num423 = 0; num423 < 2; num423++)
				{
					Vector2 vector105 = new Vector2(Utils.RandomInt(ref seed3, -1, 2), Utils.RandomInt(ref seed3, -1, 2));
					if (num423 == 0)
					{
						vector105 = Vector2.Zero;
					}
					EntitySpriteDraw(texture2D4, vector91 + vector105, value117, new Microsoft.Xna.Framework.Color(255, 255, 255, 127) * proj.Opacity, proj.rotation, origin30, proj.scale, dir);
				}
				if (proj.alpha > 0)
				{
					Microsoft.Xna.Framework.Color value118 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127);
					value118 = Microsoft.Xna.Framework.Color.Lerp(value118, new Microsoft.Xna.Framework.Color(100, 210, 255, 127), Utils.Remap(proj.Opacity, 0f, 0.7f, 0f, 1f));
					value118 *= Utils.Remap(proj.Opacity, 0f, 0.7f, 0f, 1f) * Utils.Remap(proj.Opacity, 0.7f, 1f, 1f, 0f);
					Microsoft.Xna.Framework.Rectangle value119 = rectangle23;
					value119.Offset(0, num422);
					EntitySpriteDraw(texture2D4, vector91, value119, value118, proj.rotation, origin30, proj.scale, dir);
				}
				return;
			}
			if (proj.type == 466)
			{
				Vector2 end = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Texture2D value120 = TextureAssets.Extra[33].Value;
				proj.GetAlpha(projectileColor);
				Vector2 vector106 = new Vector2(proj.scale) / 2f;
				for (int num424 = 0; num424 < 3; num424++)
				{
					switch (num424)
					{
					case 0:
						vector106 = new Vector2(proj.scale) * 0.6f;
						DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(115, 204, 219, 0) * 0.5f;
						break;
					case 1:
						vector106 = new Vector2(proj.scale) * 0.4f;
						DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(113, 251, 255, 0) * 0.5f;
						break;
					default:
						vector106 = new Vector2(proj.scale) * 0.2f;
						DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f;
						break;
					}
					DelegateMethods.f_1 = 1f;
					for (int num425 = proj.oldPos.Length - 1; num425 > 0; num425--)
					{
						if (!(proj.oldPos[num425] == Vector2.Zero))
						{
							Vector2 start = proj.oldPos[num425] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
							Vector2 end2 = proj.oldPos[num425 - 1] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
							Utils.DrawLaser(spriteBatch, value120, start, end2, vector106, DelegateMethods.LightningLaserDraw);
						}
					}
					if (proj.oldPos[0] != Vector2.Zero)
					{
						DelegateMethods.f_1 = 1f;
						Vector2 start2 = proj.oldPos[0] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
						Utils.DrawLaser(spriteBatch, value120, start2, end, vector106, DelegateMethods.LightningLaserDraw);
					}
				}
				return;
			}
			if (proj.type == 580)
			{
				Vector2 end3 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Texture2D value121 = TextureAssets.Extra[33].Value;
				proj.GetAlpha(projectileColor);
				Vector2 vector107 = new Vector2(proj.scale) / 2f;
				for (int num426 = 0; num426 < 2; num426++)
				{
					float num427 = ((proj.localAI[1] == -1f || proj.localAI[1] == 1f) ? (-0.2f) : 0f);
					if (num426 == 0)
					{
						vector107 = new Vector2(proj.scale) * (0.5f + num427);
						DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(115, 244, 219, 0) * 0.5f;
					}
					else
					{
						vector107 = new Vector2(proj.scale) * (0.3f + num427);
						DelegateMethods.c_1 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f;
					}
					DelegateMethods.f_1 = 1f;
					for (int num428 = proj.oldPos.Length - 1; num428 > 0; num428--)
					{
						if (!(proj.oldPos[num428] == Vector2.Zero))
						{
							Vector2 start3 = proj.oldPos[num428] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
							Vector2 end4 = proj.oldPos[num428 - 1] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
							Utils.DrawLaser(spriteBatch, value121, start3, end4, vector107, DelegateMethods.LightningLaserDraw);
						}
					}
					if (proj.oldPos[0] != Vector2.Zero)
					{
						DelegateMethods.f_1 = 1f;
						Vector2 start4 = proj.oldPos[0] + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
						Utils.DrawLaser(spriteBatch, value121, start4, end3, vector107, DelegateMethods.LightningLaserDraw);
					}
				}
				return;
			}
			if (proj.type == 445)
			{
				if (player.gravDir == -1f)
				{
					dir |= SpriteEffects.FlipVertically;
				}
				Vector2 vector108 = proj.position + new Vector2(proj.width, proj.height) / 2f + Vector2.UnitY * proj.gfxOffY - screenPosition;
				Texture2D value122 = TextureAssets.Projectile[proj.type].Value;
				Microsoft.Xna.Framework.Color alpha10 = proj.GetAlpha(projectileColor);
				Vector2 vector109 = player.RotatedRelativePoint(mountedCenter) + Vector2.UnitY * player.gfxOffY;
				Vector2 vector110 = vector108 + screenPosition - vector109;
				Vector2 vector111 = Vector2.Normalize(vector110);
				float num429 = vector110.Length();
				float num430 = vector110.ToRotation() + (float)Math.PI / 2f;
				float num431 = -5f;
				float num432 = num431 + 30f;
				new Vector2(2f, num429 - num432);
				Vector2 vector112 = Vector2.Lerp(vector108 + screenPosition, vector109 + vector111 * num432, 0.5f);
				Vector2 vector113 = -Vector2.UnitY.RotatedBy(proj.localAI[0] / 60f * (float)Math.PI);
				Vector2[] array7 = new Vector2[4]
				{
					vector113,
					vector113.RotatedBy(1.5707963705062866),
					vector113.RotatedBy(3.1415927410125732),
					vector113.RotatedBy(4.71238899230957)
				};
				if (num429 > num432)
				{
					for (int num433 = 0; num433 < 2; num433++)
					{
						Microsoft.Xna.Framework.Color white6 = Microsoft.Xna.Framework.Color.White;
						if (num433 % 2 == 0)
						{
							white6 = Microsoft.Xna.Framework.Color.LimeGreen;
							white6.A = 128;
							white6 *= 0.5f;
						}
						else
						{
							white6 = Microsoft.Xna.Framework.Color.CornflowerBlue;
							white6.A = 128;
							white6 *= 0.5f;
						}
						Vector2 vector114 = new Vector2(array7[num433].X, 0f).RotatedBy(num430) * 4f;
						EntitySpriteDraw(TextureAssets.MagicPixel.Value, vector112 - screenPosition + vector114, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), white6, num430, Vector2.One / 2f, new Vector2(2f, num429 - num432), dir);
					}
				}
				int type2 = player.inventory[player.selectedItem].type;
				instance.LoadItem(type2);
				Texture2D value123 = TextureAssets.Item[type2].Value;
				Microsoft.Xna.Framework.Color color114 = Lighting.GetColor((int)vector109.X / 16, (int)vector109.Y / 16);
				EntitySpriteDraw(value123, vector109 - screenPosition + vector111 * num431, null, color114, proj.rotation + (float)Math.PI / 2f + ((dir == SpriteEffects.None || dir == SpriteEffects.FlipVertically) ? ((float)Math.PI) : 0f), new Vector2((dir != SpriteEffects.None && dir != SpriteEffects.FlipVertically) ? value123.Width : 0, (float)value123.Height / 2f) + Vector2.UnitY * 1f, player.inventory[player.selectedItem].scale, dir);
				EntitySpriteDraw(TextureAssets.GlowMask[39].Value, vector109 - screenPosition + vector111 * num431, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 0), proj.rotation + (float)Math.PI / 2f + ((dir == SpriteEffects.None || dir == SpriteEffects.FlipVertically) ? ((float)Math.PI) : 0f), new Vector2((dir != SpriteEffects.None && dir != SpriteEffects.FlipVertically) ? value123.Width : 0, (float)value123.Height / 2f) + Vector2.UnitY * 1f, player.inventory[player.selectedItem].scale, dir);
				if (num429 > num432)
				{
					for (int num434 = 2; num434 < 4; num434++)
					{
						Microsoft.Xna.Framework.Color white7 = Microsoft.Xna.Framework.Color.White;
						if (num434 % 2 == 0)
						{
							white7 = Microsoft.Xna.Framework.Color.LimeGreen;
							white7.A = 128;
							white7 *= 0.5f;
						}
						else
						{
							white7 = Microsoft.Xna.Framework.Color.CornflowerBlue;
							white7.A = 128;
							white7 *= 0.5f;
						}
						Vector2 vector115 = new Vector2(array7[num434].X, 0f).RotatedBy(num430) * 4f;
						EntitySpriteDraw(TextureAssets.MagicPixel.Value, vector112 - screenPosition + vector115, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), white7, num430, Vector2.One / 2f, new Vector2(2f, num429 - num432), dir);
					}
				}
				float num435 = proj.localAI[0] / 60f;
				if (num435 > 0.5f)
				{
					num435 = 1f - num435;
				}
				EntitySpriteDraw(value122, vector108, null, alpha10 * num435 * 2f, proj.rotation, new Vector2(value122.Width, value122.Height) / 2f, proj.scale, dir);
				EntitySpriteDraw(TextureAssets.GlowMask[40].Value, vector108, null, alpha10 * (0.5f - num435) * 2f, proj.rotation, new Vector2(value122.Width, value122.Height) / 2f, proj.scale, dir);
				return;
			}
			if ((proj.type >= 393 && proj.type <= 395) || proj.type == 398 || proj.type == 423 || proj.type == 1022 || proj.type == 1036 || proj.type == 450 || proj.type == 1093)
			{
				Texture2D value124 = TextureAssets.Projectile[proj.type].Value;
				int num436 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int num437 = num436 * proj.frame;
				int num438 = 2;
				if (proj.type == 1093)
				{
					num438 = 5;
				}
				EntitySpriteDraw(value124, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY - (float)num438), new Microsoft.Xna.Framework.Rectangle(0, num437, value124.Width, num436), proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value124.Width / 2f, (float)num436 / 2f + (float)num143), proj.scale, dir);
				if (proj.type == 423)
				{
					value124 = TextureAssets.GlowMask[0].Value;
					EntitySpriteDraw(value124, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY - (float)num438), new Microsoft.Xna.Framework.Rectangle(0, num437, value124.Width, num436), new Microsoft.Xna.Framework.Color(250, 250, 250, proj.alpha), proj.rotation, new Vector2((float)value124.Width / 2f, (float)num436 / 2f + (float)num143), proj.scale, dir);
				}
				if (proj.type == 1022)
				{
					value124 = TextureAssets.GlowMask[354].Value;
					EntitySpriteDraw(value124, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY - (float)num438), new Microsoft.Xna.Framework.Rectangle(0, num437, value124.Width, num436), new Microsoft.Xna.Framework.Color(250, 250, 250, proj.alpha), proj.rotation, new Vector2((float)value124.Width / 2f, (float)num436 / 2f + (float)num143), proj.scale, dir);
				}
				if (proj.type != 1093)
				{
					return;
				}
				TryPetting(proj, 5663);
				int num439 = 60;
				int num440 = ((!player.petting.isPetting || player.petting.proj != proj.whoAmI) ? 3 : 0);
				if (proj.localAI[0] < (float)num439 && proj.localAI[0] > 1f)
				{
					if (num440 == 0)
					{
						EmoteBubble.DrawTemporaryBubble(spriteBatch, num440, num439, (int)proj.localAI[0], proj);
					}
					else
					{
						Utils.DrawNotificationIcon(spriteBatch, Utils.CenteredRectangle(proj.Center + new Vector2(8f, -14f), Vector2.Zero), 0f, worldSpace: true);
					}
				}
				if (proj.alpha > 0)
				{
					Microsoft.Xna.Framework.Color value125 = new Microsoft.Xna.Framework.Color(255, 255, 255, 127);
					value125 = Microsoft.Xna.Framework.Color.Lerp(value125, new Microsoft.Xna.Framework.Color(100, 210, 255, 127), Utils.Remap(proj.Opacity, 0f, 0.7f, 0f, 1f));
					value125 *= Utils.Remap(proj.Opacity, 0f, 0.7f, 0f, 1f) * Utils.Remap(proj.Opacity, 0.7f, 1f, 1f, 0f);
					EntitySpriteDraw(value124, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY - (float)num438), new Microsoft.Xna.Framework.Rectangle(0, num437 + 13 * num436, value124.Width, num436), value125, proj.rotation, new Vector2((float)value124.Width / 2f, (float)num436 / 2f + (float)num143), proj.scale, dir);
				}
				int head = player.head;
				if (head == 12)
				{
					LoadArmorHead(head);
					Texture2D value126 = TextureAssets.ArmorHead[head].Value;
					Microsoft.Xna.Framework.Rectangle value127 = value126.Frame(1, 21);
					int num441 = 4;
					int num442 = -4;
					if (proj.spriteDirection == 1)
					{
						num441 = -2;
					}
					int num443 = 0;
					if (proj.frame == 7 || proj.frame == 11 || proj.frame == 12)
					{
						num443--;
					}
					if (proj.frame == 4 || proj.frame == 3)
					{
						num443++;
					}
					if (proj.frame == 2)
					{
						num442 -= 2;
					}
					num441 += num443 * 2;
					EntitySpriteDraw(value126, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY - (float)num438) + new Vector2(num441 * proj.spriteDirection, num442), value127, proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value124.Width / 2f, (float)num436 / 2f + (float)num143), proj.scale, dir);
					EntitySpriteDraw(value126, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY - (float)num438) + new Vector2((num441 - 6) * proj.spriteDirection, num442), value127, proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value124.Width / 2f, (float)num436 / 2f + (float)num143), proj.scale, dir);
				}
				return;
			}
			if (proj.type == 385)
			{
				Texture2D value128 = TextureAssets.Projectile[proj.type].Value;
				int num444 = value128.Height / projFrames[proj.type];
				int y22 = num444 * proj.frame;
				int num445 = 8;
				int num446 = 2;
				float value129 = 0.4f;
				for (int num447 = 1; num447 < num445; num447 += num446)
				{
					_ = ref proj.oldPos[num447];
					Microsoft.Xna.Framework.Color newColor3 = projectileColor;
					newColor3 = proj.GetAlpha(newColor3);
					newColor3 *= (float)(num445 - num447) / 15f;
					Microsoft.Xna.Framework.Color alpha11 = proj.GetAlpha(projectileColor);
					_ = proj.oldPos[num447] - screenPosition + new Vector2(num145 + (float)num144, (float)(proj.height / 2) + proj.gfxOffY);
					EntitySpriteDraw(value128, proj.oldPos[num447] + new Vector2(proj.width, proj.height) / 2f - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y22, value128.Width, num444), Microsoft.Xna.Framework.Color.Lerp(alpha11, newColor3, 0.3f), proj.rotation, new Vector2((float)value128.Width / 2f, (float)num444 / 2f), MathHelper.Lerp(proj.scale, value129, (float)num447 / 15f), dir);
				}
				EntitySpriteDraw(value128, proj.Center - screenPosition + new Vector2(0f, proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y22, value128.Width, num444), proj.GetAlpha(projectileColor), proj.rotation, new Vector2((float)value128.Width / 2f, (float)num444 / 2f), proj.scale, dir);
				return;
			}
			if (proj.type == 388)
			{
				Texture2D value130 = TextureAssets.Projectile[proj.type].Value;
				int num448 = value130.Height / projFrames[proj.type];
				int y23 = num448 * proj.frame;
				int num449 = 0;
				int num450 = 0;
				if (proj.ai[0] == 2f)
				{
					num449 = 10;
					num450 = 1;
				}
				else
				{
					num449 = 3;
					num450 = 1;
				}
				for (int num451 = 1; num451 < num449; num451 += num450)
				{
					_ = ref proj.oldPos[num451];
					Microsoft.Xna.Framework.Color newColor4 = projectileColor;
					newColor4 = proj.GetAlpha(newColor4);
					newColor4 *= (float)(num449 - num451) / 15f;
					Vector2 position27 = proj.oldPos[num451] - screenPosition + new Vector2(num145 + (float)num144, (float)(proj.height / 2) + proj.gfxOffY);
					EntitySpriteDraw(value130, position27, new Microsoft.Xna.Framework.Rectangle(0, y23, value130.Width, num448), newColor4, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				EntitySpriteDraw(value130, proj.position - screenPosition + new Vector2(num145 + (float)num144, (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y23, value130.Width, num448), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				return;
			}
			if (projFrames[proj.type] > 1)
			{
				int num452 = TextureAssets.Projectile[proj.type].Height() / projFrames[proj.type];
				int y24 = num452 * proj.frame;
				if (proj.type == 1025)
				{
					float num453 = 0f;
					Microsoft.Xna.Framework.Color alpha12 = proj.GetAlpha(projectileColor);
					if (proj.ai[0] == 0f)
					{
						float num454 = (float)LocalPlayer.miscCounter % 75f / 75f;
						float num455 = (float)LocalPlayer.miscCounter % 100f / 100f;
						num453 += (float)Math.Sin(num455 * ((float)Math.PI * 2f)) * 2f;
						instance.LoadNPC(594);
						Texture2D value131 = TextureAssets.Npc[594].Value;
						Vector2 vector116 = new Vector2(0f, -10f);
						Vector2 position28 = proj.Center + new Vector2(0f, proj.gfxOffY + num453) + vector116 - screenPosition;
						for (int num456 = 0; num456 < 3; num456++)
						{
							Microsoft.Xna.Framework.Rectangle value132 = value131.Frame(8, 1, 1 + num456 switch
							{
								1 => 4, 
								0 => 1, 
								_ => 6, 
							});
							Vector2 origin35 = new Vector2((float)value132.Width / 2f, (float)value132.Height + (float)(num143 - 22));
							float num457 = num456 switch
							{
								1 => 0f, 
								0 => (float)Math.PI / 9f, 
								_ => -(float)Math.PI / 9f, 
							};
							float num458 = ((num456 == 1) ? ((float)Math.Sin(num454 * ((float)Math.PI * 2f))) : ((float)Math.Cos(num454 * ((float)Math.PI * 2f))));
							num458 *= 0.025f;
							num457 += num458;
							EntitySpriteDraw(value131, position28, value132, alpha12, num457, origin35, proj.scale, dir);
						}
					}
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY + num453), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), alpha12, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					return;
				}
				if (proj.type == 111)
				{
					int r = player.shirtColor.R;
					int g = player.shirtColor.G;
					int b = player.shirtColor.B;
					projectileColor = Lighting.GetColor(oldColor: new Microsoft.Xna.Framework.Color((byte)r, (byte)g, (byte)b), x: (int)((double)proj.position.X + (double)proj.width * 0.5) / 16, y: (int)(((double)proj.position.Y + (double)proj.height * 0.5) / 16.0));
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					return;
				}
				Microsoft.Xna.Framework.Color alpha13 = proj.GetAlpha(projectileColor);
				if (proj.type == 211 && CurrentDrawnEntityShader != 0)
				{
					alpha13.A = 127;
				}
				if (proj.type == 344)
				{
					float num459 = MathHelper.Min(60f, proj.ai[0]) / 2f;
					for (float num460 = 0.9f; num460 > 0f; num460 -= 0.25f)
					{
						Vector2 vector117 = num460 * (proj.velocity * 0.33f) * num459;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY) - vector117, new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), alpha13 * (1f - num460) * 0.75f, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale * (0.4f + (1f - num460) * 0.6f), dir);
					}
				}
				if (proj.type == 920 || proj.type == 921)
				{
					for (float num461 = 0.25f; num461 < 1f; num461 += 0.5f)
					{
						Vector2 vector118 = num461 * proj.velocity * 4f;
						EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY) - vector118, new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), alpha13 * (1f - num461) * 0.75f, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					}
				}
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), alpha13, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				if (proj.type == 966)
				{
					Vector2 vector119 = new Vector2(0f, -30f);
					vector119.Y += -1f + (float)(Math.Cos((float)(int)mouseTextColor / 255f * ((float)Math.PI * 2f) * 2f) * 2.0);
					Vector2 vector120 = new Vector2(-1f, -1f);
					float num462 = 3f;
					Vector2 vector121 = proj.Center + vector119;
					Vector2 vector122 = proj.Center;
					int num463 = (int)proj.ai[1];
					if (num463 >= 0)
					{
						if (npc[num463].active)
						{
							vector122 = npc[num463].Center;
						}
						else
						{
							num463 = -1;
						}
					}
					if (num463 <= -1)
					{
						Player player6 = player;
						vector122 = ((!player6.dead) ? player6.Center : (vector121 + new Vector2(2f, 0f)));
					}
					vector120 += (vector122 - vector121).SafeNormalize(Vector2.Zero) * num462;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY) + vector119, new Microsoft.Xna.Framework.Rectangle(0, num452, TextureAssets.Projectile[proj.type].Width(), num452 - 1), alpha13, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY) + vector119 + vector120, new Microsoft.Xna.Framework.Rectangle(0, num452 * 2, TextureAssets.Projectile[proj.type].Width(), num452 - 1), alpha13, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				if (proj.type == 335)
				{
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), new Microsoft.Xna.Framework.Color(100, 100, 100, 0), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				if (proj.type == 897 || proj.type == 899)
				{
					int num464 = 279;
					if (proj.type == 899)
					{
						num464 = 281;
					}
					EntitySpriteDraw(TextureAssets.GlowMask[num464].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), Microsoft.Xna.Framework.Color.White, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				if (proj.type == 891)
				{
					float num465 = Utils.WrappedLerp(0.6f, 1f, (float)((int)timeForVisualEffects % 100) / 100f);
					EntitySpriteDraw(color: new Microsoft.Xna.Framework.Color(num465, num465, num465, 150f), texture: TextureAssets.GlowMask[277].Value, position: new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), sourceRectangle: new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), rotation: proj.rotation, origin: new Vector2(num145, proj.height / 2 + num143), scale: proj.scale, effects: dir);
				}
				if (proj.type == 595)
				{
					Player player7 = player;
					if (player7.active && player7.body == 208)
					{
						for (float num466 = 0f; num466 <= 1f; num466 += 0.2f)
						{
							Microsoft.Xna.Framework.Color underShirtColor = player7.underShirtColor;
							underShirtColor.A = (byte)(120f * (1f - num466 * 0.5f));
							EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), underShirtColor, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale * MathHelper.Lerp(0.8f, 1.3f, num466), dir);
						}
					}
				}
				if (proj.type == 387)
				{
					EntitySpriteDraw(TextureAssets.EyeLaserSmall.Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452), new Microsoft.Xna.Framework.Color(255, 255, 255, 0), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				if (proj.type != 525 && proj.type != 960)
				{
					return;
				}
				int num467 = TryInteractingWithMoneyTrough(proj);
				if (num467 == 0)
				{
					return;
				}
				int num468 = (projectileColor.R + projectileColor.G + projectileColor.B) / 3;
				if (num468 > 10)
				{
					int num469 = 94;
					if (proj.type == 960)
					{
						num469 = 244;
					}
					Microsoft.Xna.Framework.Color selectionGlowColor = Colors.GetSelectionGlowColor(num467 == 2, num468);
					EntitySpriteDraw(TextureAssets.Extra[num469].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, y24, TextureAssets.Projectile[proj.type].Width(), num452 - 1), selectionGlowColor, proj.rotation, new Vector2(num145, proj.height / 2 + num143), 1f, dir);
				}
				return;
			}
			if (proj.type == 383 || proj.type == 399)
			{
				Texture2D value133 = TextureAssets.Projectile[proj.type].Value;
				EntitySpriteDraw(value133, proj.Center - screenPosition, null, proj.GetAlpha(projectileColor), proj.rotation, new Vector2(value133.Width, value133.Height) / 2f, proj.scale, dir);
				return;
			}
			if (proj.type == 157 || proj.type == 378)
			{
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + (float)(proj.width / 2), proj.position.Y - screenPosition.Y + (float)(proj.height / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(TextureAssets.Projectile[proj.type].Width() / 2, TextureAssets.Projectile[proj.type].Height() / 2), proj.scale, dir);
				return;
			}
			if (proj.type == 306)
			{
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + (float)(proj.width / 2), proj.position.Y - screenPosition.Y + (float)(proj.height / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(TextureAssets.Projectile[proj.type].Width() / 2, TextureAssets.Projectile[proj.type].Height() / 2), proj.scale, dir);
				return;
			}
			if (proj.type == 256)
			{
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + (float)(proj.width / 2), proj.position.Y - screenPosition.Y + (float)(proj.height / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(TextureAssets.Projectile[proj.type].Width() / 2, TextureAssets.Projectile[proj.type].Height() / 2), proj.scale, dir);
				return;
			}
			if (proj.aiStyle == 27)
			{
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + (float)(proj.width / 2), proj.position.Y - screenPosition.Y + (float)(proj.height / 2)), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(TextureAssets.Projectile[proj.type].Width(), 0f), proj.scale, dir);
				return;
			}
			if (proj.aiStyle == 19)
			{
				DrawProj_Spear(proj, player, ref projectileColor, ref dir);
				return;
			}
			if (proj.type == 451)
			{
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, proj.Center - screenPosition, null, proj.GetAlpha(projectileColor), proj.rotation, new Vector2(TextureAssets.Projectile[proj.type].Width(), 0f), proj.scale, dir);
				return;
			}
			if (proj.type == 434)
			{
				Vector2 vector123 = new Vector2(proj.ai[0], proj.ai[1]);
				Vector2 v = proj.position - vector123;
				float num470 = (float)Math.Sqrt(v.X * v.X + v.Y * v.Y);
				new Vector2(4f, num470);
				float rotation32 = v.ToRotation() + (float)Math.PI / 2f;
				Vector2 vector124 = Vector2.Lerp(proj.position, vector123, 0.5f);
				Microsoft.Xna.Framework.Color red = Microsoft.Xna.Framework.Color.Red;
				red.A = 0;
				Microsoft.Xna.Framework.Color white8 = Microsoft.Xna.Framework.Color.White;
				red *= proj.localAI[0];
				white8 *= proj.localAI[0];
				float num471 = (float)Math.Sqrt(proj.damage / 50);
				EntitySpriteDraw(TextureAssets.MagicPixel.Value, vector124 - screenPosition, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), red, rotation32, Vector2.One / 2f, new Vector2(2f * num471, num470 + 8f), dir);
				EntitySpriteDraw(TextureAssets.MagicPixel.Value, vector124 - screenPosition, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), red, rotation32, Vector2.One / 2f, new Vector2(4f * num471, num470), dir);
				EntitySpriteDraw(TextureAssets.MagicPixel.Value, vector124 - screenPosition, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), white8, rotation32, Vector2.One / 2f, new Vector2(2f * num471, num470), dir);
				return;
			}
			if (proj.type == 94 && proj.ai[1] > 6f)
			{
				for (int num472 = 0; num472 < 10; num472++)
				{
					Microsoft.Xna.Framework.Color alpha14 = proj.GetAlpha(projectileColor);
					float num473 = (float)(9 - num472) / 9f;
					alpha14.R = (byte)((float)(int)alpha14.R * num473);
					alpha14.G = (byte)((float)(int)alpha14.G * num473);
					alpha14.B = (byte)((float)(int)alpha14.B * num473);
					alpha14.A = (byte)((float)(int)alpha14.A * num473);
					float num474 = (float)(9 - num472) / 9f;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.oldPos[num472].X - screenPosition.X + num145 + (float)num144, proj.oldPos[num472].Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha14, proj.rotation, new Vector2(num145, proj.height / 2 + num143), num474 * proj.scale, dir);
				}
			}
			if (proj.type == 301)
			{
				for (int num475 = 0; num475 < 10; num475++)
				{
					Microsoft.Xna.Framework.Color alpha15 = proj.GetAlpha(projectileColor);
					float num476 = (float)(9 - num475) / 9f;
					alpha15.R = (byte)((float)(int)alpha15.R * num476);
					alpha15.G = (byte)((float)(int)alpha15.G * num476);
					alpha15.B = (byte)((float)(int)alpha15.B * num476);
					alpha15.A = (byte)((float)(int)alpha15.A * num476);
					float num477 = (float)(9 - num475) / 9f;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.oldPos[num475].X - screenPosition.X + num145 + (float)num144, proj.oldPos[num475].Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha15, proj.rotation, new Vector2(num145, proj.height / 2 + num143), num477 * proj.scale, dir);
				}
			}
			if (proj.type == 323 && proj.alpha == 0)
			{
				for (int num478 = 1; num478 < 8; num478++)
				{
					float num479 = proj.velocity.X * (float)num478;
					float num480 = proj.velocity.Y * (float)num478;
					Microsoft.Xna.Framework.Color alpha16 = proj.GetAlpha(projectileColor);
					float num481 = 0f;
					if (num478 == 1)
					{
						num481 = 0.7f;
					}
					if (num478 == 2)
					{
						num481 = 0.6f;
					}
					if (num478 == 3)
					{
						num481 = 0.5f;
					}
					if (num478 == 4)
					{
						num481 = 0.4f;
					}
					if (num478 == 5)
					{
						num481 = 0.3f;
					}
					if (num478 == 6)
					{
						num481 = 0.2f;
					}
					if (num478 == 7)
					{
						num481 = 0.1f;
					}
					alpha16.R = (byte)((float)(int)alpha16.R * num481);
					alpha16.G = (byte)((float)(int)alpha16.G * num481);
					alpha16.B = (byte)((float)(int)alpha16.B * num481);
					alpha16.A = (byte)((float)(int)alpha16.A * num481);
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144 - num479, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY - num480), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha16, proj.rotation, new Vector2(num145, proj.height / 2 + num143), num481 + 0.2f, dir);
				}
			}
			if (proj.type == 117 && proj.ai[0] > 3f)
			{
				for (int num482 = 1; num482 < 5; num482++)
				{
					float num483 = proj.velocity.X * (float)num482;
					float num484 = proj.velocity.Y * (float)num482;
					Microsoft.Xna.Framework.Color alpha17 = proj.GetAlpha(projectileColor);
					float num485 = 0f;
					if (num482 == 1)
					{
						num485 = 0.4f;
					}
					if (num482 == 2)
					{
						num485 = 0.3f;
					}
					if (num482 == 3)
					{
						num485 = 0.2f;
					}
					if (num482 == 4)
					{
						num485 = 0.1f;
					}
					alpha17.R = (byte)((float)(int)alpha17.R * num485);
					alpha17.G = (byte)((float)(int)alpha17.G * num485);
					alpha17.B = (byte)((float)(int)alpha17.B * num485);
					alpha17.A = (byte)((float)(int)alpha17.A * num485);
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144 - num483, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY - num484), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha17, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
			}
			if (proj.bobber)
			{
				if (proj.ai[1] > 0f && proj.ai[1] < (float)ItemID.Count && proj.ai[0] == 1f)
				{
					int num486 = (int)proj.ai[1];
					Vector2 center5 = proj.Center;
					float rotation33 = proj.rotation;
					Vector2 vector125 = center5;
					float num487 = polePosX - vector125.X;
					float num488 = polePosY - vector125.Y;
					rotation33 = (float)Math.Atan2(num488, num487);
					if (proj.velocity.X > 0f)
					{
						dir = SpriteEffects.None;
						rotation33 = (float)Math.Atan2(num488, num487);
						rotation33 += 0.785f;
						if (proj.ai[1] == 2342f)
						{
							rotation33 -= 0.785f;
						}
					}
					else
					{
						dir = SpriteEffects.FlipHorizontally;
						rotation33 = (float)Math.Atan2(0f - num488, 0f - num487);
						rotation33 -= 0.785f;
						if (proj.ai[1] == 2342f)
						{
							rotation33 += 0.785f;
						}
					}
					instance.LoadItem(num486);
					Texture2D value134 = TextureAssets.Item[num486].Value;
					Microsoft.Xna.Framework.Rectangle value135 = value134.Frame();
					if (ItemID.Sets.IsFood[num486] && itemAnimations[num486] != null)
					{
						value135 = itemAnimations[num486].GetFrame(value134, 0);
					}
					EntitySpriteDraw(value134, new Vector2(center5.X - screenPosition.X, center5.Y - screenPosition.Y), value135, projectileColor, rotation33, new Vector2(value135.Width / 2, value135.Height / 2), proj.scale, dir);
				}
				else if (proj.ai[0] <= 1f)
				{
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					if (proj.glowMask != -1)
					{
						Texture2D value136 = TextureAssets.GlowMask[proj.glowMask].Value;
						Microsoft.Xna.Framework.Color newColor5 = Microsoft.Xna.Framework.Color.White;
						if (proj.type == 993)
						{
							newColor5 = new Microsoft.Xna.Framework.Color(DiscoR, DiscoG, DiscoB);
						}
						EntitySpriteDraw(value136, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, value136.Width, value136.Height), proj.GetAlpha(newColor5), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					}
				}
			}
			else
			{
				if (proj.ownerHitCheck && player.gravDir == -1f)
				{
					if (player.direction == 1)
					{
						dir = SpriteEffects.FlipHorizontally;
					}
					else if (player.direction == -1)
					{
						dir = SpriteEffects.None;
					}
				}
				EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				if (proj.glowMask != -1)
				{
					Microsoft.Xna.Framework.Color color115 = new Microsoft.Xna.Framework.Color(250, 250, 250, proj.alpha);
					if (proj.type == 1101 || proj.type == 1102)
					{
						color115 = Item.GetPhaseColor(proj.type);
						EntitySpriteDraw(TextureAssets.GlowMask[proj.glowMask].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), color115, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
						color115 = Item.GetPhaseColor(proj.type, drawColor: true);
					}
					EntitySpriteDraw(TextureAssets.GlowMask[proj.glowMask].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), color115, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				if (proj.type == 473)
				{
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), new Microsoft.Xna.Framework.Color(255, 255, 0, 0), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
				if (proj.type >= 511 && proj.type <= 513)
				{
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), proj.GetAlpha(projectileColor) * 0.25f, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale * (1f + proj.Opacity * 1.75f), dir);
				}
				if (proj.type == 312)
				{
					ulong seed4 = TileFrameSeed;
					for (int num489 = 0; num489 < 4; num489++)
					{
						Vector2 vector126 = new Vector2(Utils.RandomInt(ref seed4, -2, 3), Utils.RandomInt(ref seed4, -2, 3));
						EntitySpriteDraw(TextureAssets.GlowMask[proj.glowMask].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY) + vector126, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), new Microsoft.Xna.Framework.Color(255, 255, 255, 255) * 0.2f, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
					}
				}
			}
			if (proj.type == 106)
			{
				Texture2D value137 = TextureAssets.LightDisc.Value;
				Vector2 position29 = new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2));
				Microsoft.Xna.Framework.Rectangle value138 = value137.Frame();
				EntitySpriteDraw(value137, position29, value138, new Microsoft.Xna.Framework.Color(200, 200, 200, 0), proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
			}
			if (proj.type >= 326 && proj.type <= 328)
			{
				ulong seed5 = TileFrameSeed;
				for (int num490 = 0; num490 < 4; num490++)
				{
					Vector2 vector127 = new Vector2(Utils.RandomInt(ref seed5, -2, 3), Utils.RandomInt(ref seed5, -2, 3));
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144, proj.position.Y - screenPosition.Y + (float)(proj.height / 2)) + vector127 - proj.velocity * 0.25f * num490, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), new Microsoft.Xna.Framework.Color(120, 120, 120, 60) * 1f, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale - (float)num490 * 0.2f, dir);
				}
			}
			if (proj.type == 554 || proj.type == 603)
			{
				for (int num491 = 1; num491 < 5; num491++)
				{
					float num492 = proj.velocity.X * (float)num491 * 0.5f;
					float num493 = proj.velocity.Y * (float)num491 * 0.5f;
					Microsoft.Xna.Framework.Color alpha18 = proj.GetAlpha(projectileColor);
					float num494 = 0f;
					if (num491 == 1)
					{
						num494 = 0.4f;
					}
					if (num491 == 2)
					{
						num494 = 0.3f;
					}
					if (num491 == 3)
					{
						num494 = 0.2f;
					}
					if (num491 == 4)
					{
						num494 = 0.1f;
					}
					alpha18.R = (byte)((float)(int)alpha18.R * num494);
					alpha18.G = (byte)((float)(int)alpha18.G * num494);
					alpha18.B = (byte)((float)(int)alpha18.B * num494);
					alpha18.A = (byte)((float)(int)alpha18.A * num494);
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144 - num492, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY - num493), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha18, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
			}
			else if (proj.type == 604)
			{
				int num495 = (int)proj.ai[1] + 1;
				if (num495 > 7)
				{
					num495 = 7;
				}
				for (int num496 = 1; num496 < num495; num496++)
				{
					float num497 = proj.velocity.X * (float)num496 * 1.5f;
					float num498 = proj.velocity.Y * (float)num496 * 1.5f;
					Microsoft.Xna.Framework.Color alpha19 = proj.GetAlpha(projectileColor);
					float num499 = 0f;
					if (num496 == 1)
					{
						num499 = 0.4f;
					}
					if (num496 == 2)
					{
						num499 = 0.3f;
					}
					if (num496 == 3)
					{
						num499 = 0.2f;
					}
					if (num496 == 4)
					{
						num499 = 0.1f;
					}
					num499 = 0.4f - (float)num496 * 0.06f;
					num499 *= 1f - (float)proj.alpha / 255f;
					alpha19.R = (byte)((float)(int)alpha19.R * num499);
					alpha19.G = (byte)((float)(int)alpha19.G * num499);
					alpha19.B = (byte)((float)(int)alpha19.B * num499);
					alpha19.A = (byte)((float)(int)alpha19.A * num499 / 2f);
					float scale17 = proj.scale;
					scale17 -= (float)num496 * 0.1f;
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144 - num497, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY - num498), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha19, proj.rotation, new Vector2(num145, proj.height / 2 + num143), scale17, dir);
				}
			}
			else
			{
				if (proj.type != 553)
				{
					return;
				}
				for (int num500 = 1; num500 < 5; num500++)
				{
					float num501 = proj.velocity.X * (float)num500 * 0.4f;
					float num502 = proj.velocity.Y * (float)num500 * 0.4f;
					Microsoft.Xna.Framework.Color alpha20 = proj.GetAlpha(projectileColor);
					float num503 = 0f;
					if (num500 == 1)
					{
						num503 = 0.4f;
					}
					if (num500 == 2)
					{
						num503 = 0.3f;
					}
					if (num500 == 3)
					{
						num503 = 0.2f;
					}
					if (num500 == 4)
					{
						num503 = 0.1f;
					}
					alpha20.R = (byte)((float)(int)alpha20.R * num503);
					alpha20.G = (byte)((float)(int)alpha20.G * num503);
					alpha20.B = (byte)((float)(int)alpha20.B * num503);
					alpha20.A = (byte)((float)(int)alpha20.A * num503);
					EntitySpriteDraw(TextureAssets.Projectile[proj.type].Value, new Vector2(proj.position.X - screenPosition.X + num145 + (float)num144 - num501, proj.position.Y - screenPosition.Y + (float)(proj.height / 2) + proj.gfxOffY - num502), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Projectile[proj.type].Width(), TextureAssets.Projectile[proj.type].Height()), alpha20, proj.rotation, new Vector2(num145, proj.height / 2 + num143), proj.scale, dir);
				}
			}
		}
	}

	private static void DrawProj_Flamethrower(Projectile proj)
	{
		bool flag = proj.ai[0] == 1f;
		float num = 60f;
		float num2 = 12f;
		float fromMax = num + num2;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Color transparent = Microsoft.Xna.Framework.Color.Transparent;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 80, 20, 200);
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(255, 255, 20, 70);
		Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(255, 80, 20, 100), color2, 0.25f);
		Microsoft.Xna.Framework.Color color4 = new Microsoft.Xna.Framework.Color(80, 80, 80, 100);
		float num3 = 0.35f;
		float num4 = 0.7f;
		float num5 = 0.85f;
		float num6 = ((proj.localAI[0] > num - 10f) ? 0.175f : 0.2f);
		if (flag)
		{
			color = new Microsoft.Xna.Framework.Color(95, 120, 255, 200);
			color2 = new Microsoft.Xna.Framework.Color(50, 180, 255, 70);
			color3 = new Microsoft.Xna.Framework.Color(95, 160, 255, 100);
			color4 = new Microsoft.Xna.Framework.Color(33, 125, 202, 100);
		}
		int num7 = 3;
		int num8 = 2;
		int verticalFrames = 7;
		float num9 = Utils.Remap(proj.localAI[0], num, fromMax, 1f, 0f);
		float num10 = Math.Min(proj.localAI[0], 20f);
		float num11 = Utils.Remap(proj.localAI[0], 0f, fromMax, 0f, 1f);
		float num12 = Utils.Remap(num11, 0.2f, 0.5f, 0.25f, 1f);
		Microsoft.Xna.Framework.Rectangle rectangle = ((!flag) ? value.Frame(1, verticalFrames, 0, 3) : value.Frame(1, verticalFrames, 0, (int)Utils.Remap(num11, 0.5f, 1f, 3f, 5f)));
		if (!(num11 < 1f))
		{
			return;
		}
		for (int i = 0; i < 2; i++)
		{
			for (float num13 = 1f; num13 >= 0f; num13 -= num6)
			{
				transparent = ((num11 < 0.1f) ? Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color, Utils.GetLerpValue(0f, 0.1f, num11, clamped: true)) : ((num11 < 0.2f) ? Microsoft.Xna.Framework.Color.Lerp(color, color2, Utils.GetLerpValue(0.1f, 0.2f, num11, clamped: true)) : ((num11 < num3) ? color2 : ((num11 < num4) ? Microsoft.Xna.Framework.Color.Lerp(color2, color3, Utils.GetLerpValue(num3, num4, num11, clamped: true)) : ((num11 < num5) ? Microsoft.Xna.Framework.Color.Lerp(color3, color4, Utils.GetLerpValue(num4, num5, num11, clamped: true)) : ((!(num11 < 1f)) ? Microsoft.Xna.Framework.Color.Transparent : Microsoft.Xna.Framework.Color.Lerp(color4, Microsoft.Xna.Framework.Color.Transparent, Utils.GetLerpValue(num5, 1f, num11, clamped: true))))))));
				float num14 = (1f - num13) * Utils.Remap(num11, 0f, 0.2f, 0f, 1f);
				Vector2 vector = proj.Center - screenPosition + proj.velocity * (0f - num10) * num13;
				Microsoft.Xna.Framework.Color color5 = transparent * num14;
				Microsoft.Xna.Framework.Color color6 = color5;
				if (!flag)
				{
					color6.G /= 2;
					color6.B /= 2;
					color6.A = (byte)Math.Min((float)(int)color5.A + 80f * num14, 255f);
					Utils.Remap(proj.localAI[0], 20f, fromMax, 0f, 1f);
				}
				float num15 = 1f / num6 * (num13 + 1f);
				float num16 = proj.rotation + num13 * ((float)Math.PI / 2f) + GlobalTimeWrappedHourly * num15 * 2f;
				float num17 = proj.rotation - num13 * ((float)Math.PI / 2f) - GlobalTimeWrappedHourly * num15 * 2f;
				switch (i)
				{
				case 0:
					EntitySpriteDraw(value, vector + proj.velocity * (0f - num10) * num6 * 0.5f, rectangle, color6 * num9 * 0.25f, num16 + (float)Math.PI / 4f, rectangle.Size() / 2f, num12, SpriteEffects.None);
					EntitySpriteDraw(value, vector, rectangle, color6 * num9, num17, rectangle.Size() / 2f, num12, SpriteEffects.None);
					break;
				case 1:
					if (!flag)
					{
						EntitySpriteDraw(value, vector + proj.velocity * (0f - num10) * num6 * 0.2f, rectangle, color5 * num9 * 0.25f, num16 + (float)Math.PI / 2f, rectangle.Size() / 2f, num12 * 0.75f, SpriteEffects.None);
						EntitySpriteDraw(value, vector, rectangle, color5 * num9, num17 + (float)Math.PI / 2f, rectangle.Size() / 2f, num12 * 0.75f, SpriteEffects.None);
					}
					break;
				}
			}
		}
	}

	private static void DrawProj_Flamethrower_Foxsparks(Projectile proj, Player theOwner)
	{
		bool flag = proj.ai[0] == 1f;
		float num = 60f;
		float num2 = 12f;
		float fromMax = num + num2;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Color transparent = Microsoft.Xna.Framework.Color.Transparent;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 80, 20, 200);
		Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Lerp(value2: new Microsoft.Xna.Framework.Color(255, 255, 20, 70), value1: new Microsoft.Xna.Framework.Color(255, 80, 20, 100), amount: 0.25f);
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(80, 80, 80, 100);
		float num3 = 0.35f;
		float num4 = 0.7f;
		float num5 = 0.85f;
		float num6 = ((proj.localAI[0] > num - 10f) ? 0.175f : 0.2f);
		num6 *= 0.7f;
		color = new Microsoft.Xna.Framework.Color(95, 120, 255, 200);
		Microsoft.Xna.Framework.Color color4 = new Microsoft.Xna.Framework.Color(50, 180, 255, 70);
		int num7 = 3;
		int num8 = 2;
		int verticalFrames = 7;
		float num9 = Utils.Remap(proj.localAI[0], num, fromMax, 1f, 0f);
		float num10 = Math.Min(proj.localAI[0], 20f);
		float num11 = Utils.Remap(proj.localAI[0], 0f, fromMax, 0f, 1f);
		float num12 = Utils.Remap(num11, 0.2f, 0.5f, 0.25f, 1f) * 0.5f;
		Microsoft.Xna.Framework.Rectangle rectangle = ((!flag) ? value.Frame(1, verticalFrames, 0, 3) : value.Frame(1, verticalFrames, 0, (int)Utils.Remap(num11, 0.5f, 1f, 3f, 5f)));
		if (!(num11 < 1f))
		{
			return;
		}
		for (int i = 0; i < 2; i++)
		{
			for (float num13 = 1f; num13 >= 0f; num13 -= num6)
			{
				transparent = ((num11 < 0.1f) ? Microsoft.Xna.Framework.Color.Lerp(Microsoft.Xna.Framework.Color.Transparent, color, Utils.GetLerpValue(0f, 0.1f, num11, clamped: true)) : ((num11 < 0.2f) ? Microsoft.Xna.Framework.Color.Lerp(color, color4, Utils.GetLerpValue(0.1f, 0.2f, num11, clamped: true)) : ((num11 < num3) ? color4 : ((num11 < num4) ? Microsoft.Xna.Framework.Color.Lerp(color4, color2, Utils.GetLerpValue(num3, num4, num11, clamped: true)) : ((num11 < num5) ? Microsoft.Xna.Framework.Color.Lerp(color2, color3, Utils.GetLerpValue(num4, num5, num11, clamped: true)) : ((!(num11 < 1f)) ? Microsoft.Xna.Framework.Color.Transparent : Microsoft.Xna.Framework.Color.Lerp(color3, Microsoft.Xna.Framework.Color.Transparent, Utils.GetLerpValue(num5, 1f, num11, clamped: true))))))));
				float num14 = (1f - num13) * Utils.Remap(num11, 0f, 0.2f, 0f, 1f);
				float num15 = proj.Distance(theOwner.Center) / 120f;
				if (num15 > 1f)
				{
					num15 = 1f;
				}
				Vector2 vector = proj.DirectionTo(theOwner.Center + proj.velocity * 6f).SafeNormalize(Vector2.Zero) * (0f - proj.velocity.Length());
				Vector2 vector2 = proj.Center - screenPosition + vector * (0f - num10) * num13 * num15;
				Microsoft.Xna.Framework.Color color5 = transparent * num14;
				Microsoft.Xna.Framework.Color color6 = color5;
				if (!flag)
				{
					color6.G /= 2;
					color6.B /= 2;
					color6.A = (byte)Math.Min((float)(int)color5.A + 80f * num14, 255f);
					float num16 = Utils.Remap(proj.localAI[0], 20f, fromMax, 0f, 1f);
					num16 *= num16 * num16;
					vector2 += new Vector2(0f, -46f) * num16;
				}
				float num17 = 1f / num6 * (num13 + 1f);
				float num18 = proj.rotation + num13 * ((float)Math.PI / 2f) + GlobalTimeWrappedHourly * num17 * 2f;
				float num19 = proj.rotation - num13 * ((float)Math.PI / 2f) - GlobalTimeWrappedHourly * num17 * 2f;
				switch (i)
				{
				case 0:
					EntitySpriteDraw(value, vector2 + proj.velocity * (0f - num10) * num6 * 0.5f, rectangle, color6 * num9 * 0.25f, num18 + (float)Math.PI / 4f, rectangle.Size() / 2f, num12, SpriteEffects.None);
					EntitySpriteDraw(value, vector2, rectangle, color6 * num9, num19, rectangle.Size() / 2f, num12, SpriteEffects.None);
					break;
				case 1:
					if (!flag)
					{
						EntitySpriteDraw(value, vector2 + proj.velocity * (0f - num10) * num6 * 0.2f, rectangle, color5 * num9 * 0.25f, num18 + (float)Math.PI / 2f, rectangle.Size() / 2f, num12 * 0.75f, SpriteEffects.None);
						EntitySpriteDraw(value, vector2, rectangle, color5 * num9, num19 + (float)Math.PI / 2f, rectangle.Size() / 2f, num12 * 0.75f, SpriteEffects.None);
					}
					break;
				}
			}
		}
	}

	private static void DrawProj_Spear(Projectile proj, Player theOwner, ref Microsoft.Xna.Framework.Color projectileColor, ref SpriteEffects dir)
	{
		dir = SpriteEffects.None;
		float num = (float)Math.Atan2(proj.velocity.Y, proj.velocity.X) + 2.355f;
		Asset<Texture2D> asset = TextureAssets.Projectile[proj.type];
		Microsoft.Xna.Framework.Rectangle value = asset.Frame();
		Microsoft.Xna.Framework.Rectangle rect = proj.getRect();
		Vector2 vector = Vector2.Zero;
		if (theOwner.direction > 0)
		{
			dir = SpriteEffects.FlipHorizontally;
			vector.X = asset.Width();
			num -= (float)Math.PI / 2f;
		}
		if (theOwner.gravDir == -1f)
		{
			if (proj.direction == 1)
			{
				dir = SpriteEffects.FlipHorizontally | SpriteEffects.FlipVertically;
				vector = new Vector2(asset.Width(), asset.Height());
				num -= (float)Math.PI / 2f;
			}
			else if (proj.direction == -1)
			{
				dir = SpriteEffects.FlipVertically;
				vector = new Vector2(0f, asset.Height());
				num += (float)Math.PI / 2f;
			}
		}
		Vector2.Lerp(vector, value.Center.ToVector2(), 0.25f);
		float num2 = 0f;
		Vector2 vector2 = proj.Center + new Vector2(0f, proj.gfxOffY);
		if (!theOwner.isDisplayDollOrInanimate && proj.AI_019_Spears_GetExtensionHitbox(theOwner, out var extensionBox))
		{
			Vector2 value2 = theOwner.RotatedRelativePoint(theOwner.MountedCenter);
			float num3 = extensionBox.Size().Length() / proj.Hitbox.Size().Length();
			_ = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 1f;
			float num4 = Utils.Remap(theOwner.itemAnimation, theOwner.itemAnimationMax, (float)theOwner.itemAnimationMax / 3f, 0f, 1f);
			float num5 = Utils.Remap(num4, 0f, 0.3f, 0f, 1f) * Utils.Remap(num4, 0.3f, 1f, 1f, 0f);
			num5 = 1f - (1f - num5) * (1f - num5);
			Vector2 vector3 = extensionBox.Center.ToVector2() + new Vector2(0f, proj.gfxOffY);
			Vector2.Lerp(value2, vector3, 1.1f);
			Texture2D value3 = TextureAssets.Extra[98].Value;
			Vector2 origin = value3.Size() / 2f;
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f;
			switch (proj.type)
			{
			case 105:
				color = new Microsoft.Xna.Framework.Color(255, 220, 80, 0);
				break;
			case 46:
				color = new Microsoft.Xna.Framework.Color(180, 80, 255, 0);
				break;
			case 342:
				color = new Microsoft.Xna.Framework.Color(80, 140, 255, 0);
				break;
			case 153:
				color = new Microsoft.Xna.Framework.Color(255, 50, 30, 15);
				break;
			}
			float num6 = num - (float)Math.PI / 4f * (float)proj.spriteDirection;
			if (theOwner.gravDir < 0f)
			{
				num6 -= (float)Math.PI / 2f * (float)proj.spriteDirection;
			}
			EntitySpriteDraw(value3, Vector2.Lerp(vector3, vector2, 0.5f) - screenPosition, null, color * num5, num6, origin, new Vector2(num5 * num3, num3) * proj.scale * num3, dir);
			EntitySpriteDraw(value3, Vector2.Lerp(vector3, vector2, 1f) - screenPosition, null, color * num5, num6, origin, new Vector2(num5 * num3, num3 * 1.5f) * proj.scale * num3, dir);
			EntitySpriteDraw(value3, Vector2.Lerp(value2, vector2, num4 * 1.5f - 0.5f) - screenPosition + new Vector2(0f, 2f), null, color * num5, num6, origin, new Vector2(num5 * num3 * 1f * num5, num3 * 2f * num5) * proj.scale * num3, dir);
			for (float num7 = 0.4f; num7 <= 1f; num7 += 0.1f)
			{
				Vector2 vector4 = Vector2.Lerp(value2, vector3, num7 + 0.2f);
				EntitySpriteDraw(value3, vector4 - screenPosition + new Vector2(0f, 2f), null, color * num5 * 0.75f * num7, num6, origin, new Vector2(num5 * num3 * 1f * num5, num3 * 2f * num5) * proj.scale * num3, dir);
			}
			extensionBox.Offset((int)(0f - screenPosition.X), (int)(0f - screenPosition.Y));
		}
		EntitySpriteDraw(asset.Value, vector2 - screenPosition, value, proj.GetAlpha(projectileColor), num, vector, proj.scale, dir);
		rect.Offset((int)(0f - screenPosition.X), (int)(0f - screenPosition.Y));
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, rect, Microsoft.Xna.Framework.Color.White * num2);
	}

	private static void DrawPrettyStarSparkle(float opacity, SpriteEffects dir, Vector2 drawpos, Microsoft.Xna.Framework.Color drawColor, Microsoft.Xna.Framework.Color shineColor, float flareCounter, float fadeInStart, float fadeInEnd, float fadeOutStart, float fadeOutEnd, float rotation, Vector2 scale, Vector2 fatness)
	{
		Texture2D value = TextureAssets.Extra[98].Value;
		Microsoft.Xna.Framework.Color color = shineColor * opacity * 0.5f;
		color.A = 0;
		Vector2 origin = value.Size() / 2f;
		Microsoft.Xna.Framework.Color color2 = drawColor * 0.5f;
		float num = Utils.GetLerpValue(fadeInStart, fadeInEnd, flareCounter, clamped: true) * Utils.GetLerpValue(fadeOutEnd, fadeOutStart, flareCounter, clamped: true);
		Vector2 vector = new Vector2(fatness.X * 0.5f, scale.X) * num;
		Vector2 vector2 = new Vector2(fatness.Y * 0.5f, scale.Y) * num;
		color *= num;
		color2 *= num;
		EntitySpriteDraw(value, drawpos, null, color, (float)Math.PI / 2f + rotation, origin, vector, dir);
		EntitySpriteDraw(value, drawpos, null, color, 0f + rotation, origin, vector2, dir);
		EntitySpriteDraw(value, drawpos, null, color2, (float)Math.PI / 2f + rotation, origin, vector * 0.6f, dir);
		EntitySpriteDraw(value, drawpos, null, color2, 0f + rotation, origin, vector2 * 0.6f, dir);
	}

	private static void DrawProj_FlailChains(Projectile proj, Player theOwner, Vector2 mountedCenter)
	{
		Vector2 playerArmPosition = GetPlayerArmPosition(proj, theOwner);
		Asset<Texture2D> asset = null;
		Microsoft.Xna.Framework.Rectangle? sourceRectangle = null;
		float num = 0f;
		switch (proj.type)
		{
		default:
			asset = TextureAssets.Chain3;
			break;
		case 25:
			asset = TextureAssets.Chain2;
			break;
		case 35:
			asset = TextureAssets.Chain6;
			break;
		case 63:
			asset = TextureAssets.Chain7;
			break;
		case 154:
			asset = TextureAssets.Chain13;
			break;
		case 247:
			asset = TextureAssets.Chain19;
			break;
		case 757:
			asset = TextureAssets.Extra[99];
			sourceRectangle = asset.Frame(1, 6);
			num = -2f;
			break;
		case 947:
			asset = TextureAssets.Chain41;
			break;
		case 948:
			asset = TextureAssets.Chain43;
			break;
		}
		Vector2 origin = (sourceRectangle.HasValue ? (sourceRectangle.Value.Size() / 2f) : (asset.Size() / 2f));
		Vector2 center = proj.Center;
		Vector2 v = playerArmPosition.MoveTowards(center, 4f) - center;
		Vector2 vector = v.SafeNormalize(Vector2.Zero);
		float num2 = (float)(sourceRectangle.HasValue ? sourceRectangle.Value.Height : asset.Height()) + num;
		float rotation = vector.ToRotation() + (float)Math.PI / 2f;
		int num3 = 0;
		float num4 = v.Length() + num2 / 2f;
		int num5 = 0;
		while (num4 > 0f)
		{
			Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)center.X / 16, (int)(center.Y / 16f));
			switch (proj.type)
			{
			case 757:
				sourceRectangle = asset.Frame(1, 6, 0, num3 % 6);
				break;
			case 948:
				if (num5 >= 6)
				{
					asset = (asset = TextureAssets.Chain41);
				}
				else if (num5 >= 4)
				{
					asset = (asset = TextureAssets.Chain42);
					byte b = 140;
					if (color.R < b)
					{
						color.R = b;
					}
					if (color.G < b)
					{
						color.G = b;
					}
					if (color.B < b)
					{
						color.B = b;
					}
				}
				else
				{
					color = Microsoft.Xna.Framework.Color.White;
				}
				num5++;
				break;
			}
			spriteBatch.Draw(asset.Value, center - screenPosition, sourceRectangle, color, rotation, origin, 1f, SpriteEffects.None, 0f);
			center += vector * num2;
			num3++;
			num4 -= num2;
		}
	}

	private static void DrawProj_FlailChains_Old(Projectile proj, Vector2 mountedCenter)
	{
		Vector2 vector = new Vector2(proj.position.X + (float)proj.width * 0.5f, proj.position.Y + (float)proj.height * 0.5f);
		float num = mountedCenter.X - vector.X;
		float num2 = mountedCenter.Y - vector.Y;
		float rotation = (float)Math.Atan2(num2, num) - 1.57f;
		bool flag = true;
		int num3 = 0;
		int num4 = 25;
		if (proj.type == 757)
		{
			num4 = 12;
		}
		while (flag)
		{
			float num5 = (float)Math.Sqrt(num * num + num2 * num2);
			if (num5 < (float)num4)
			{
				flag = false;
			}
			else if (float.IsNaN(num5))
			{
				flag = false;
			}
			else
			{
				num5 = ((proj.type == 154 || proj.type == 247) ? (18f / num5) : ((proj.type != 757) ? (12f / num5) : (16f / num5)));
				num *= num5;
				num2 *= num5;
				vector.X += num;
				vector.Y += num2;
				num = mountedCenter.X - vector.X;
				num2 = mountedCenter.Y - vector.Y;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)vector.X / 16, (int)(vector.Y / 16f));
				if (proj.type == 25)
				{
					EntitySpriteDraw(TextureAssets.Chain2.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain2.Width(), TextureAssets.Chain2.Height()), color, rotation, new Vector2((float)TextureAssets.Chain2.Width() * 0.5f, (float)TextureAssets.Chain2.Height() * 0.5f), 1f, SpriteEffects.None);
				}
				else if (proj.type == 35)
				{
					EntitySpriteDraw(TextureAssets.Chain6.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain6.Width(), TextureAssets.Chain6.Height()), color, rotation, new Vector2((float)TextureAssets.Chain6.Width() * 0.5f, (float)TextureAssets.Chain6.Height() * 0.5f), 1f, SpriteEffects.None);
				}
				else if (proj.type == 757)
				{
					Texture2D value = TextureAssets.Extra[99].Value;
					Microsoft.Xna.Framework.Rectangle r = value.Frame(1, 6, 0, num3 % 6);
					EntitySpriteDraw(value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), value.Frame(1, 6, 0, num3 % 6), color, rotation, r.Size() / 2f, 1f, SpriteEffects.None);
				}
				else if (proj.type == 247)
				{
					EntitySpriteDraw(TextureAssets.Chain19.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain19.Width(), TextureAssets.Chain19.Height()), color, rotation, new Vector2((float)TextureAssets.Chain19.Width() * 0.5f, (float)TextureAssets.Chain19.Height() * 0.5f), 1f, SpriteEffects.None);
				}
				else if (proj.type == 63)
				{
					EntitySpriteDraw(TextureAssets.Chain7.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain7.Width(), TextureAssets.Chain7.Height()), color, rotation, new Vector2((float)TextureAssets.Chain7.Width() * 0.5f, (float)TextureAssets.Chain7.Height() * 0.5f), 1f, SpriteEffects.None);
				}
				else if (proj.type == 154)
				{
					EntitySpriteDraw(TextureAssets.Chain13.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain13.Width(), TextureAssets.Chain13.Height()), color, rotation, new Vector2((float)TextureAssets.Chain13.Width() * 0.5f, (float)TextureAssets.Chain13.Height() * 0.5f), 1f, SpriteEffects.None);
				}
				else
				{
					EntitySpriteDraw(TextureAssets.Chain3.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain3.Width(), TextureAssets.Chain3.Height()), color, rotation, new Vector2((float)TextureAssets.Chain3.Width() * 0.5f, (float)TextureAssets.Chain3.Height() * 0.5f), 1f, SpriteEffects.None);
				}
			}
			num3++;
		}
	}

	private static Microsoft.Xna.Framework.Color TryApplyingPlayerStringColor(int playerStringColor, Microsoft.Xna.Framework.Color stringColor)
	{
		if (playerStringColor > 0)
		{
			stringColor = WorldGen.paintColor(playerStringColor);
			if (stringColor.R < 75)
			{
				stringColor.R = 75;
			}
			if (stringColor.G < 75)
			{
				stringColor.G = 75;
			}
			if (stringColor.B < 75)
			{
				stringColor.B = 75;
			}
			switch (playerStringColor)
			{
			case 13:
				stringColor = new Microsoft.Xna.Framework.Color(20, 20, 20);
				break;
			case 0:
			case 14:
				stringColor = new Microsoft.Xna.Framework.Color(200, 200, 200);
				break;
			case 28:
				stringColor = new Microsoft.Xna.Framework.Color(163, 116, 91);
				break;
			case 27:
				stringColor = new Microsoft.Xna.Framework.Color(DiscoR, DiscoG, DiscoB);
				break;
			case 30:
				stringColor = new Microsoft.Xna.Framework.Color(226, 228, 142);
				break;
			}
			stringColor.A = (byte)((float)(int)stringColor.A * 0.4f);
			if (playerStringColor == 29)
			{
				float num = (float)(((double)(int)mouseTextColor - 190.0) / 65.0);
				num += (float)rand.Next(-100, 101) * 0.005f;
				num = Utils.Clamp(num, 0f, 1f);
				float num2 = 1f - num;
				byte b = (byte)(184f * num + 255f * num2);
				byte b2 = (byte)(116f * num + 184f * num2);
				byte b3 = (byte)(255f * num + 116f * num2);
				b = (byte)(b + rand.Next(-40, 41));
				b2 = (byte)(b2 + rand.Next(-40, 41));
				b3 = (byte)(b3 + rand.Next(-40, 41));
				stringColor = new Microsoft.Xna.Framework.Color(b, b2, b3, 0);
			}
		}
		return stringColor;
	}

	private static void DrawProj_FishingLine(Projectile proj, Player theOwner, ref float polePosX, ref float polePosY, Vector2 mountedCenter)
	{
		polePosX = mountedCenter.X;
		polePosY = mountedCenter.Y;
		if (theOwner.mount.Active)
		{
			if (theOwner.mount.Type == 52)
			{
				polePosX -= theOwner.direction * 14;
				polePosY -= -10f;
			}
			theOwner.ApplyItemPositionOffsetFromMount(ref mountedCenter);
			polePosX = mountedCenter.X;
			polePosY = mountedCenter.Y;
		}
		polePosY += theOwner.gfxOffY;
		int type = theOwner.inventory[theOwner.selectedItem].type;
		Microsoft.Xna.Framework.Color stringColor = new Microsoft.Xna.Framework.Color(200, 200, 200, 100);
		if (type == 2294)
		{
			stringColor = new Microsoft.Xna.Framework.Color(100, 180, 230, 100);
		}
		if (type == 2295)
		{
			stringColor = new Microsoft.Xna.Framework.Color(250, 90, 70, 100);
		}
		if (type == 2293)
		{
			stringColor = new Microsoft.Xna.Framework.Color(203, 190, 210, 100);
		}
		if (type == 2421)
		{
			stringColor = new Microsoft.Xna.Framework.Color(183, 77, 112, 100);
		}
		if (type == 2422)
		{
			stringColor = new Microsoft.Xna.Framework.Color(255, 226, 116, 100);
		}
		if (type == 4325)
		{
			stringColor = new Microsoft.Xna.Framework.Color(200, 100, 100, 100);
		}
		if (type == 4442)
		{
			stringColor = new Microsoft.Xna.Framework.Color(100, 100, 200, 100);
		}
		stringColor = TryApplyingPlayerStringColor(theOwner.stringColor, stringColor);
		float gravDir = theOwner.gravDir;
		switch (type)
		{
		case 2289:
			polePosX += 43 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 36f * gravDir;
			break;
		case 2291:
			polePosX += 43 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 34f * gravDir;
			break;
		case 2292:
			polePosX += 46 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 34f * gravDir;
			break;
		case 2293:
			polePosX += 43 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 34f * gravDir;
			break;
		case 2294:
			polePosX += 43 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 30f * gravDir;
			break;
		case 2295:
			polePosX += 43 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 30f * gravDir;
			break;
		case 2296:
			polePosX += 43 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 30f * gravDir;
			break;
		case 2421:
			polePosX += 47 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 36f * gravDir;
			break;
		case 2422:
			polePosX += 47 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 32f * gravDir;
			break;
		case 4325:
			polePosX += 44 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 32f * gravDir;
			break;
		case 4442:
			polePosX += 44 * theOwner.direction;
			if (theOwner.direction < 0)
			{
				polePosX -= 13f;
			}
			polePosY -= 32f * gravDir;
			break;
		}
		if (gravDir == -1f)
		{
			polePosY -= 12f;
		}
		Vector2 vector = new Vector2(polePosX, polePosY);
		vector = theOwner.RotatedRelativePoint(vector + new Vector2(8f)) - new Vector2(8f);
		float num = proj.position.X + (float)proj.width * 0.5f - vector.X;
		float num2 = proj.position.Y + (float)proj.height * 0.5f - vector.Y;
		Math.Sqrt(num * num + num2 * num2);
		float num3 = (float)Math.Atan2(num2, num) - 1.57f;
		bool flag = true;
		if (num == 0f && num2 == 0f)
		{
			flag = false;
		}
		else
		{
			float num4 = (float)Math.Sqrt(num * num + num2 * num2);
			num4 = 12f / num4;
			num *= num4;
			num2 *= num4;
			vector.X -= num;
			vector.Y -= num2;
			num = proj.position.X + (float)proj.width * 0.5f - vector.X;
			num2 = proj.position.Y + (float)proj.height * 0.5f - vector.Y;
		}
		while (flag)
		{
			float num5 = 12f;
			float num6 = (float)Math.Sqrt(num * num + num2 * num2);
			float num7 = num6;
			if (float.IsNaN(num6) || float.IsNaN(num7))
			{
				flag = false;
				continue;
			}
			if (num6 < 20f)
			{
				num5 = num6 - 8f;
				flag = false;
			}
			num6 = 12f / num6;
			num *= num6;
			num2 *= num6;
			vector.X += num;
			vector.Y += num2;
			num = proj.position.X + (float)proj.width * 0.5f - vector.X;
			num2 = proj.position.Y + (float)proj.height * 0.1f - vector.Y;
			if (num7 > 12f)
			{
				float num8 = 0.3f;
				float num9 = Math.Abs(proj.velocity.X) + Math.Abs(proj.velocity.Y);
				if (num9 > 16f)
				{
					num9 = 16f;
				}
				num9 = 1f - num9 / 16f;
				num8 *= num9;
				num9 = num7 / 80f;
				if (num9 > 1f)
				{
					num9 = 1f;
				}
				num8 *= num9;
				if (num8 < 0f)
				{
					num8 = 0f;
				}
				num9 = 1f - proj.localAI[0] / 100f;
				num8 *= num9;
				if (num2 > 0f)
				{
					num2 *= 1f + num8;
					num *= 1f - num8;
				}
				else
				{
					num9 = Math.Abs(proj.velocity.X) / 3f;
					if (num9 > 1f)
					{
						num9 = 1f;
					}
					num9 -= 0.5f;
					num8 *= num9;
					if (num8 > 0f)
					{
						num8 *= 2f;
					}
					num2 *= 1f + num8;
					num *= 1f - num8;
				}
			}
			num3 = (float)Math.Atan2(num2, num) - 1.57f;
			Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)vector.X / 16, (int)(vector.Y / 16f), stringColor);
			if (theOwner.stringColor == 29)
			{
				color = stringColor;
			}
			EntitySpriteDraw(TextureAssets.FishingLine.Value, new Vector2(vector.X - screenPosition.X + (float)TextureAssets.FishingLine.Width() * 0.5f, vector.Y - screenPosition.Y + (float)TextureAssets.FishingLine.Height() * 0.5f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.FishingLine.Width(), (int)num5), color, num3, new Vector2((float)TextureAssets.FishingLine.Width() * 0.5f, 0f), 1f, SpriteEffects.None);
		}
	}

	private void DrawProj_StardustGuardianPunching(Projectile proj)
	{
		if (!gamePaused)
		{
			int num = 6;
			Texture2D value = TextureAssets.Extra[46].Value;
			int num2 = 20;
			Vector2 vector = proj.Center - proj.rotation.ToRotationVector2() * num2 * proj.spriteDirection;
			for (int i = 0; i < num; i++)
			{
				float num3 = rand.NextFloat();
				float num4 = Utils.GetLerpValue(0f, 0.3f, num3, clamped: true) * Utils.GetLerpValue(1f, 0.5f, num3, clamped: true);
				float amount = Utils.GetLerpValue(0f, 0.3f, num3, clamped: true) * Utils.GetLerpValue(1f, 0.5f, num3, clamped: true);
				float num5 = MathHelper.Lerp(0.6f, 1f, amount);
				Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 255, 255, 127);
				color *= num4 * 0.5f;
				Vector2 origin = value.Size() / 2f;
				Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.White * num4;
				color2.A /= 2;
				Microsoft.Xna.Framework.Color color3 = color2 * 0.5f;
				float num6 = 1f;
				float num7 = 1f + rand.NextFloat() * 0.5f;
				float num8 = rand.NextFloatDirection();
				Vector2 vector2 = new Vector2(0.8f) * num7 * num6 * num5;
				float num9 = 20f + MathHelper.Lerp(0f, 20f, num3) + num7 * 16f;
				float num10 = proj.rotation + ((proj.direction == 1) ? 0f : ((float)Math.PI)) + num8 * ((float)Math.PI * 2f) * 0.04f;
				float rotation = num10 + (float)Math.PI / 2f;
				Vector2 position = vector + num10.ToRotationVector2() * num9 + rand.NextVector2Circular(20f, 20f) - screenPosition;
				color *= num6;
				color3 *= num6;
				SpriteEffects effects = SpriteEffects.None;
				spriteBatch.Draw(value, position, null, color, rotation, origin, vector2, effects, 0f);
				spriteBatch.Draw(value, position, null, color3, rotation, origin, vector2 * 0.8f, effects, 0f);
			}
		}
	}

	private void DrawProj_PiercingStarlight(Projectile proj)
	{
		int seed = (int)proj.localAI[0];
		_drawRand.SetSeed(seed);
		float num = proj.ai[1];
		if (num == 0f)
		{
			num = 1f;
		}
		int num2 = (int)Math.Ceiling(3f * num);
		LoadProjectile(proj.type);
		LoadItem(4923);
		int num3 = 2;
		Vector2 vector = proj.Center - proj.rotation.ToRotationVector2() * num3;
		bool isAPreviewDisplayDoll = proj.isAPreviewDisplayDoll;
		int num4 = 2;
		if (isAPreviewDisplayDoll)
		{
			num4 = 1;
		}
		for (int i = 0; i < num4; i++)
		{
			for (int j = 0; j < 1; j++)
			{
				float num5 = _drawRand.NextFloat();
				float num6 = Utils.GetLerpValue(0f, 0.3f, num5, clamped: true) * Utils.GetLerpValue(1f, 0.5f, num5, clamped: true);
				Microsoft.Xna.Framework.Color color = proj.GetAlpha(Lighting.GetColor(proj.Center.ToTileCoordinates())) * num6;
				Texture2D value = TextureAssets.Item[4923].Value;
				Vector2 origin = value.Size() / 2f;
				float num7 = _drawRand.NextFloatDirection();
				float num8 = 8f + MathHelper.Lerp(0f, 20f, num5) + _drawRand.NextFloat() * 6f;
				if (isAPreviewDisplayDoll)
				{
					num7 = 0f;
					num8 = 8f + MathHelper.Lerp(0f, 20f, num5);
				}
				float num9 = proj.rotation + num7 * ((float)Math.PI * 2f) * 0.04f;
				float num10 = num9 + (float)Math.PI / 4f;
				Vector2 vector2 = vector + num9.ToRotationVector2() * num8;
				if (!isAPreviewDisplayDoll)
				{
					vector2 += _drawRand.NextVector2Circular(8f, 8f);
				}
				Vector2 position = vector2 - screenPosition;
				SpriteEffects spriteEffects = SpriteEffects.None;
				if (proj.rotation < -(float)Math.PI / 2f || proj.rotation > (float)Math.PI / 2f)
				{
					num10 += (float)Math.PI / 2f;
					spriteEffects |= SpriteEffects.FlipHorizontally;
				}
				spriteBatch.Draw(value, position, null, color, num10, origin, 1f, spriteEffects, 0f);
			}
			if (!proj.isAPreviewDisplayDoll)
			{
				for (int k = 0; k < num2; k++)
				{
					float num11 = _drawRand.NextFloat();
					float num12 = Utils.GetLerpValue(0f, 0.3f, num11, clamped: true) * Utils.GetLerpValue(1f, 0.5f, num11, clamped: true);
					float amount = Utils.GetLerpValue(0f, 0.3f, num11, clamped: true) * Utils.GetLerpValue(1f, 0.5f, num11, clamped: true);
					float num13 = MathHelper.Lerp(0.6f, 1f, amount);
					Microsoft.Xna.Framework.Color fairyQueenWeaponsColor = proj.GetFairyQueenWeaponsColor(0.25f, 0f, (_drawRand.NextFloat() * 0.33f + GlobalTimeWrappedHourly) % 1f);
					Texture2D value2 = TextureAssets.Projectile[proj.type].Value;
					Microsoft.Xna.Framework.Color color2 = fairyQueenWeaponsColor;
					color2 *= num12 * 0.5f;
					Vector2 origin2 = value2.Size() / 2f;
					Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.White * num12;
					color3.A /= 2;
					Microsoft.Xna.Framework.Color color4 = color3 * 0.5f;
					float num14 = 1f;
					float num15 = (num - 1f) / 2f;
					float num16 = _drawRand.NextFloat() * 2f * num;
					num16 += num15;
					float num17 = _drawRand.NextFloatDirection();
					Vector2 vector3 = new Vector2(2.8f + num16 * (1f + num15), 1f) * num14 * num13;
					float value3 = 50f * num;
					Vector2 vector4 = proj.rotation.ToRotationVector2() * ((k >= 1) ? 56 : 0);
					float num18 = 0.03f - (float)k * 0.012f;
					num18 /= num;
					float num19 = 30f + MathHelper.Lerp(0f, value3, num11) + num16 * 16f;
					float num20 = proj.rotation + num17 * ((float)Math.PI * 2f) * num18;
					float rotation = num20;
					Vector2 position2 = vector + num20.ToRotationVector2() * num19 + _drawRand.NextVector2Circular(20f, 20f) + vector4 - screenPosition;
					color2 *= num14;
					color4 *= num14;
					SpriteEffects effects = SpriteEffects.None;
					spriteBatch.Draw(value2, position2, null, color2, rotation, origin2, vector3, effects, 0f);
					spriteBatch.Draw(value2, position2, null, color4, rotation, origin2, vector3 * 0.6f, effects, 0f);
				}
			}
		}
	}

	private void DrawProj_FairyQueenLance(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		int num = 40;
		int num2 = 180 * num;
		num2 /= 2;
		Microsoft.Xna.Framework.Color color = proj.AI_171_GetColor();
		Microsoft.Xna.Framework.Color color2 = color;
		color.A = 0;
		color2.A /= 2;
		Texture2D value = TextureAssets.Extra[178].Value;
		Vector2 origin = value.Frame().Size() * new Vector2(0f, 0.5f);
		Vector2 scale = new Vector2(num2 / value.Width, 2f);
		Vector2 scale2 = new Vector2((float)(num2 / value.Width) * 0.5f, 2f);
		Microsoft.Xna.Framework.Color color3 = color * Utils.GetLerpValue(60f, 55f, proj.localAI[0], clamped: true) * Utils.GetLerpValue(0f, 10f, proj.localAI[0], clamped: true);
		spriteBatch.Draw(value, vector, null, color3, proj.rotation, origin, scale2, SpriteEffects.None, 0f);
		spriteBatch.Draw(value, vector, null, color3 * 0.3f, proj.rotation, origin, scale, SpriteEffects.None, 0f);
		Texture2D value2 = TextureAssets.Projectile[proj.type].Value;
		Vector2 origin2 = value2.Frame().Size() / 2f;
		Microsoft.Xna.Framework.Color color4 = Microsoft.Xna.Framework.Color.White * Utils.GetLerpValue(0f, 20f, proj.localAI[0], clamped: true);
		color4.A /= 2;
		float num3 = MathHelper.Lerp(0.7f, 1f, Utils.GetLerpValue(55f, 60f, proj.localAI[0], clamped: true));
		float lerpValue = Utils.GetLerpValue(10f, 60f, proj.localAI[0]);
		if (lerpValue > 0f)
		{
			float lerpValue2 = Utils.GetLerpValue(0f, 1f, proj.velocity.Length(), clamped: true);
			for (float num4 = 1f; num4 > 0f; num4 -= 1f / 6f)
			{
				Vector2 vector2 = proj.rotation.ToRotationVector2() * -120f * num4 * lerpValue2;
				spriteBatch.Draw(value2, vector + vector2, null, color * lerpValue * (1f - num4), proj.rotation, origin2, num3, SpriteEffects.None, 0f);
				spriteBatch.Draw(value2, vector + vector2, null, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.15f * lerpValue * (1f - num4), proj.rotation, origin2, num3 * 0.85f, SpriteEffects.None, 0f);
			}
			for (float num5 = 0f; num5 < 1f; num5 += 0.25f)
			{
				Vector2 vector3 = (num5 * ((float)Math.PI * 2f) + proj.rotation).ToRotationVector2() * 2f * num3;
				spriteBatch.Draw(value2, vector + vector3, null, color2 * lerpValue, proj.rotation, origin2, num3, SpriteEffects.None, 0f);
			}
			spriteBatch.Draw(value2, vector, null, color2 * lerpValue, proj.rotation, origin2, num3 * 1.1f, SpriteEffects.None, 0f);
		}
		spriteBatch.Draw(value2, vector, null, color4, proj.rotation, origin2, num3, SpriteEffects.None, 0f);
	}

	private void DrawProj_FairyQueenRangedItemShot(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Microsoft.Xna.Framework.Color fairyQueenWeaponsColor = proj.GetFairyQueenWeaponsColor(0f);
		Microsoft.Xna.Framework.Color fairyQueenWeaponsColor2 = proj.GetFairyQueenWeaponsColor(0.5f);
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Vector2 origin = value.Frame().Size() / 2f;
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White * proj.Opacity;
		color.A /= 2;
		float num = MathHelper.Lerp(0.7f, 1f, Utils.GetLerpValue(0f, 5f, proj.ai[0], clamped: true));
		float opacity = proj.Opacity;
		if (opacity > 0f)
		{
			float lerpValue = Utils.GetLerpValue(0f, 1f, proj.velocity.Length(), clamped: true);
			for (float num2 = 0f; num2 < 1f; num2 += 1f / 6f)
			{
				Vector2 vector2 = proj.rotation.ToRotationVector2() * -120f * num2 * lerpValue;
				spriteBatch.Draw(value, vector + vector2, null, fairyQueenWeaponsColor * opacity * (1f - num2), proj.rotation, origin, num, SpriteEffects.None, 0f);
			}
			for (float num3 = 0f; num3 < 1f; num3 += 0.25f)
			{
				Vector2 vector3 = (num3 * ((float)Math.PI * 2f) + proj.rotation).ToRotationVector2() * 4f * num;
				spriteBatch.Draw(value, vector + vector3, null, fairyQueenWeaponsColor2 * opacity, proj.rotation, origin, num, SpriteEffects.None, 0f);
			}
		}
		spriteBatch.Draw(value, vector, null, color, proj.rotation, origin, num, SpriteEffects.None, 0f);
	}

	private void DrawProj_EmpressBlade(Projectile proj, float hueOverride)
	{
		CurrentDrawnEntityShader = -1;
		PrepareDrawnProjectileDrawing(proj);
		Vector2 vector = proj.Center - screenPosition;
		proj.GetFairyQueenWeaponsColor(0f, 0f, hueOverride);
		Microsoft.Xna.Framework.Color fairyQueenWeaponsColor = proj.GetFairyQueenWeaponsColor(0.5f, 0f, hueOverride);
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Vector2 origin = value.Frame().Size() / 2f;
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White * proj.Opacity;
		color.A = (byte)((float)(int)color.A * 0.7f);
		fairyQueenWeaponsColor.A /= 2;
		float scale = proj.scale;
		float num = proj.rotation - (float)Math.PI / 2f;
		float num2 = proj.Opacity * 0.3f;
		if (num2 > 0f)
		{
			float lerpValue = Utils.GetLerpValue(60f, 50f, proj.ai[0], clamped: true);
			float num3 = Utils.GetLerpValue(70f, 50f, proj.ai[0], clamped: true) * Utils.GetLerpValue(40f, 45f, proj.ai[0], clamped: true);
			for (float num4 = 0f; num4 < 1f; num4 += 1f / 6f)
			{
				Vector2 vector2 = num.ToRotationVector2() * -120f * num4 * lerpValue;
				EntitySpriteDraw(value, vector + vector2, null, fairyQueenWeaponsColor * num2 * (1f - num4) * num3, num, origin, scale * 1.5f, SpriteEffects.None);
			}
			for (float num5 = 0f; num5 < 1f; num5 += 0.25f)
			{
				Vector2 vector3 = (num5 * ((float)Math.PI * 2f) + num).ToRotationVector2() * 4f * scale;
				EntitySpriteDraw(value, vector + vector3, null, fairyQueenWeaponsColor * num2, num, origin, scale, SpriteEffects.None);
			}
		}
		EntitySpriteDraw(value, vector, null, color, num, origin, scale, SpriteEffects.None);
		EntitySpriteDraw(value, vector, null, fairyQueenWeaponsColor * num2 * 0.5f, num, origin, scale, SpriteEffects.None);
	}

	private void DrawProj_CoolWhipMinion(Projectile proj)
	{
		Vector2 vector = proj.Center - screenPosition;
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White * 0.5f;
		color.A = 0;
		Microsoft.Xna.Framework.Color color2 = color;
		color2.A = 127;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Vector2 origin = value.Frame().Size() / 2f;
		Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.White * proj.Opacity;
		color3.A /= 2;
		int num = 1;
		float opacity = proj.Opacity;
		if (opacity > 0f)
		{
			for (float num2 = 0f; num2 < 4f; num2 += 1f)
			{
				Vector2 vector2 = proj.velocity * (0f - num2);
				spriteBatch.Draw(value, vector + vector2, null, color * opacity * ((4f - num2) / 4f), proj.rotation, origin, num, SpriteEffects.None, 0f);
			}
			for (float num3 = 0f; num3 < 1f; num3 += 0.25f)
			{
				Vector2 vector3 = (num3 * ((float)Math.PI * 2f) + proj.rotation).ToRotationVector2() * 4f * num;
				spriteBatch.Draw(value, vector + vector3, null, color2 * opacity, proj.rotation, origin, num, SpriteEffects.None, 0f);
			}
		}
		spriteBatch.Draw(value, vector, null, color3, proj.rotation, origin, num, SpriteEffects.None, 0f);
	}

	private void DrawMurderAurora(Projectile proj)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Vector2 origin = value.Size() / 2f;
		float num = GlobalTimeWrappedHourly % 10f / 10f;
		Vector2 vector = proj.Center - screenPosition;
		int num2 = 15;
		float num3 = 0.5f;
		int num4 = 210;
		num3 = Utils.GetLerpValue(0f, 60f, proj.timeLeft, clamped: true) * Utils.GetLerpValue(num4, num4 - 60, proj.timeLeft, clamped: true);
		float amount = Utils.GetLerpValue(0f, 60f, proj.timeLeft, clamped: true) * Utils.GetLerpValue(num4, 90f, proj.timeLeft, clamped: true);
		amount = MathHelper.Lerp(0.2f, 0.5f, amount);
		float num5 = 800f / (float)value.Width;
		float num6 = num5 * 0.8f;
		float num7 = (num5 - num6) / (float)num2;
		float num8 = 30f;
		float num9 = 300f;
		Vector2 vector2 = new Vector2(3f, 6f);
		for (int i = 0; i < num2; i++)
		{
			_ = (float)(i + 1) / 50f;
			float num10 = (float)Math.Sin(num * ((float)Math.PI * 2f) + (float)Math.PI / 2f + (float)i / 2f);
			float x = num10 * (num9 - (float)i * 3f);
			float num11 = (float)Math.Sin(num * ((float)Math.PI * 2f) * 2f + (float)Math.PI / 3f + (float)i) * num8;
			num11 -= (float)i * 3f;
			_ = (float)i / (float)num2;
			float num12 = (num10 * 0.5f + 0.5f) * 0.6f + num;
			Math.Pow(1f * (float)i / (float)num2, 2.0);
			float num13 = num6 + (float)(i + 1) * num7;
			num13 *= 0.3f;
			Microsoft.Xna.Framework.Color color = hslToRgb(num12 % 1f, 1f, 0.5f) * num3 * amount;
			color.A /= 4;
			float rotation = (float)Math.PI / 2f + num10 * ((float)Math.PI / 4f) * -0.3f + (float)Math.PI * (float)i;
			EntitySpriteDraw(value, vector + new Vector2(x, num11), null, color, rotation, origin, new Vector2(num13, num13) * vector2, SpriteEffects.None);
		}
	}

	private void DrawWhip(Projectile proj, Player theOwner)
	{
		List<Vector2> list = new List<Vector2>();
		Projectile.FillWhipControlPoints(proj, list, theOwner);
		Texture2D value = TextureAssets.FishingLine.Value;
		Microsoft.Xna.Framework.Rectangle value2 = value.Frame();
		Vector2 origin = new Vector2(value2.Width / 2, 2f);
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White;
		bool flag = false;
		bool flag2 = true;
		bool flag3 = false;
		switch (proj.type)
		{
		case 847:
			color = Microsoft.Xna.Framework.Color.OrangeRed;
			break;
		case 849:
			color = Microsoft.Xna.Framework.Color.SlateBlue;
			color = Microsoft.Xna.Framework.Color.Black;
			break;
		case 848:
			color = Microsoft.Xna.Framework.Color.DarkBlue;
			break;
		case 912:
			color = Microsoft.Xna.Framework.Color.LightBlue;
			break;
		case 913:
			color = Microsoft.Xna.Framework.Color.Firebrick;
			break;
		case 914:
			color = Microsoft.Xna.Framework.Color.ForestGreen;
			break;
		case 915:
			color = Microsoft.Xna.Framework.Color.White;
			break;
		case 952:
			color = Microsoft.Xna.Framework.Color.Tan;
			break;
		case 1028:
			flag = true;
			color = Microsoft.Xna.Framework.Color.Gray;
			break;
		case 1029:
			flag = true;
			color = Microsoft.Xna.Framework.Color.Purple;
			break;
		case 1030:
			flag = true;
			color = Microsoft.Xna.Framework.Color.Red;
			break;
		case 1031:
			flag = true;
			color = new Microsoft.Xna.Framework.Color(88, 85, 155);
			break;
		case 1032:
			flag = true;
			color = new Microsoft.Xna.Framework.Color(143, 215, 29);
			break;
		case 1033:
			flag = true;
			color = Microsoft.Xna.Framework.Color.Blue;
			break;
		case 1034:
			flag = true;
			color = hslToRgb(0.6f, 1f, 0.5f, 20) * 0.6f;
			flag3 = true;
			break;
		case 1035:
			flag = true;
			color = Microsoft.Xna.Framework.Color.Lime;
			flag2 = false;
			break;
		case 1104:
			color = new Microsoft.Xna.Framework.Color(78, 136, 255);
			break;
		}
		Vector2 vector = list[0];
		int num = list.Count - 1;
		if (flag)
		{
			num--;
		}
		if (flag2)
		{
			for (int i = 0; i < num; i++)
			{
				Vector2 vector2 = list[i];
				Vector2 vector3 = list[i + 1] - vector2;
				float rotation = vector3.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color2 = Lighting.GetColor(vector2.ToTileCoordinates(), color);
				Vector2 scale = new Vector2(1f, (vector3.Length() + 2f) / (float)value2.Height);
				if (flag3)
				{
					color2 = color;
				}
				if (proj.type == 1104)
				{
					color2 *= 0.5f;
				}
				spriteBatch.Draw(value, vector - screenPosition, value2, color2, rotation, origin, scale, SpriteEffects.None, 0f);
				vector += vector3;
			}
		}
		switch (proj.type)
		{
		case 847:
			vector = DrawWhip_WhipSword(proj, list);
			break;
		case 841:
			vector = DrawWhip_WhipBland(proj, list);
			break;
		case 848:
			vector = DrawWhip_WhipMace(proj, list);
			break;
		case 849:
			vector = DrawWhip_WhipScythe(proj, list);
			break;
		case 912:
			vector = DrawWhip_CoolWhip(proj, list);
			break;
		case 913:
			vector = DrawWhip_FireWhip(proj, list);
			break;
		case 914:
			vector = DrawWhip_ThornWhip(proj, list);
			break;
		case 915:
			vector = DrawWhip_RainbowWhip(proj, theOwner, list);
			break;
		case 952:
			vector = DrawWhip_BoneWhip(proj, list);
			break;
		case 1028:
			vector = DrawWhip_GenericWhip(proj, list, 6);
			break;
		case 1029:
			vector = DrawWhip_GenericWhip(proj, list, 6, 0.5f);
			break;
		case 1030:
			vector = DrawWhip_GenericWhip(proj, list, 6, 0.5f);
			break;
		case 1031:
			vector = DrawWhip_MeteorWhip(proj, list);
			break;
		case 1032:
			vector = DrawWhip_FlowerWhip(proj, list, 5, 0.5f);
			break;
		case 1033:
			vector = DrawWhip_EelWhip(proj, list);
			break;
		case 1034:
			vector = DrawWhip_Constellation(proj, list, 6);
			break;
		case 1035:
			vector = DrawWhip_MoonLordWhip(proj, list);
			break;
		case 1104:
			vector = DrawWhip_SlimeWhip(proj, list);
			break;
		}
	}

	public static Vector2 DrawWhip_SlimeWhip(Projectile proj, List<Vector2> controlPoints)
	{
		int num = 5;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, num);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		int num2 = 1;
		int num3 = (int)MathHelper.Max(1f, num - 2);
		int num4 = controlPoints.Count - 1;
		for (int i = 0; i < num4; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			if (i == 0)
			{
				rectangle.Y = 0;
			}
			else if (i == num4 - 1)
			{
				rectangle.Y = height * (num - 1);
			}
			else
			{
				float amount = ((float)i - 1f) / ((float)num4 - 2f);
				int num5 = (int)Math.Round(MathHelper.Lerp(num2, num3, amount));
				rectangle.Y = height * num5;
				if (i % 3 != 0)
				{
					flag = false;
				}
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				color *= 0.5f;
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, 1f, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_GenericWhip(Projectile proj, List<Vector2> controlPoints, int segmentCount, float startWidth = 1f, float endWidth = 1f)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, segmentCount);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		int num = 1;
		int num2 = (int)MathHelper.Max(1f, segmentCount - 1);
		int num3 = controlPoints.Count - 1;
		bool flag = false;
		for (int i = 0; i < num3; i++)
		{
			int num4 = i;
			if (num4 == 1)
			{
				continue;
			}
			if (flag)
			{
				num4++;
				if (i == num3 - 1)
				{
					num4 = 0;
				}
			}
			Vector2 origin = vector;
			if (num4 == 0)
			{
				origin.Y -= 4f;
			}
			else if (num4 == num3 - 1)
			{
				rectangle.Y = height * (segmentCount - 1);
			}
			else
			{
				int num5 = num4 % (num2 - num);
				rectangle.Y = height * (num + num5);
			}
			Vector2 vector2 = controlPoints[num4];
			Vector2 v = controlPoints[num4 + 1] - vector2;
			if (true)
			{
				float rotation = v.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector2.ToTileCoordinates());
				Vector2 scale = new Vector2(Utils.Remap(num4, 5f, (float)num3 * 0.75f, startWidth, endWidth), 1f);
				if (num4 == 0)
				{
					scale = Vector2.One;
				}
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, SpriteEffects.None, 0f);
			}
		}
		return controlPoints[num3 - 1];
	}

	public static Vector2 DrawWhip_FlowerWhip(Projectile proj, List<Vector2> controlPoints, int segmentCount, float startWidth = 1f, float endWidth = 1f)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, segmentCount);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		int num = 1;
		int num2 = (int)MathHelper.Max(1f, segmentCount - 1);
		int num3 = controlPoints.Count - 1;
		bool flag = false;
		for (int i = 0; i < num3; i++)
		{
			int num4 = i;
			if (flag)
			{
				num4++;
				if (i == num3 - 1)
				{
					num4 = 0;
				}
			}
			bool flag2 = true;
			Vector2 origin = vector;
			if (num4 == 0)
			{
				origin.Y -= 4f;
			}
			else if (num4 == num3 - 1)
			{
				rectangle.Y = height * (segmentCount - 1);
				origin.Y -= 8f;
			}
			else
			{
				int num5 = num4 % (num2 - num);
				rectangle.Y = height * (num + num5);
				if (i % 2 != 0)
				{
					continue;
				}
			}
			Vector2 vector2 = controlPoints[num4];
			Vector2 v = controlPoints[num4 + 1] - vector2;
			if (flag2)
			{
				float rotation = v.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector2.ToTileCoordinates());
				Vector2 scale = new Vector2(Utils.Remap(num4, 5f, (float)num3 * 0.75f, startWidth, endWidth), 1f);
				if (num4 == 0)
				{
					scale = Vector2.One;
				}
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, SpriteEffects.None, 0f);
			}
		}
		return controlPoints[num3 - 1];
	}

	public static Vector2 DrawWhip_Constellation(Projectile proj, List<Vector2> controlPoints, int segmentCount, float startWidth = 1f, float endWidth = 1f)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, segmentCount);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		int num = 1;
		int num2 = (int)MathHelper.Max(1f, segmentCount - 1);
		Projectile.GetWhipSettings(proj, out var timeToFlyOut, out var _, out var _);
		float num3 = proj.ai[0] / timeToFlyOut;
		int num4 = controlPoints.Count - 1;
		bool flag = false;
		for (int i = 0; i < num4; i++)
		{
			int num5 = i;
			if (num5 == 1)
			{
				continue;
			}
			Vector2 fatness = Vector2.One;
			if (flag)
			{
				num5++;
				if (i == num4 - 1)
				{
					num5 = 0;
				}
			}
			Vector2 origin = vector;
			if (num5 == 0)
			{
				origin.Y -= 4f;
				fatness = Vector2.Zero;
			}
			else if (num5 == num4 - 1)
			{
				rectangle.Y = height * (segmentCount - 1);
				fatness *= 2f;
			}
			else
			{
				int num6 = num5 % (num2 - num);
				rectangle.Y = height * (num + num6);
			}
			Vector2 vector2 = controlPoints[num5];
			Vector2 v = controlPoints[num5 + 1] - vector2;
			if (true)
			{
				float rotation = v.ToRotation() - (float)Math.PI / 2f;
				float rotation2 = (float)Math.PI / 2f;
				fatness *= 1f + (float)i * 0.03f;
				Microsoft.Xna.Framework.Color shineColor = hslToRgb(0.6f, 1f, 0.5f);
				Vector2 scale = new Vector2(Utils.Remap(num5, 5f, (float)num4 * 0.75f, startWidth, endWidth), 1f);
				if (num5 == 0)
				{
					scale = Vector2.One;
				}
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector2.ToTileCoordinates());
				if (num5 != 0 && num5 != num4 - 1)
				{
					color = new Microsoft.Xna.Framework.Color(255, 255, 255, 50);
					scale *= 0.5f;
				}
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, SpriteEffects.None, 0f);
				if ((i + 1) % 3 == 0)
				{
					DrawPrettyStarSparkle(proj.Opacity, SpriteEffects.None, vector2 - screenPosition, new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f, shineColor, num3, 0f, 0.5f, 0.5f, 1f, rotation2, new Vector2(Utils.Remap(num3, 0f, 1f, 2f, 0f), Utils.Remap(num3, 0f, 1f, 4f, 0f)), fatness);
				}
			}
		}
		return controlPoints[num4 - 1];
	}

	public static Vector2 DrawWhip_MoonLordWhip(Projectile proj, List<Vector2> controlPoints)
	{
		int verticalFrames = 7;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(4, verticalFrames);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		int num = 1;
		int num2 = 4;
		int num3 = 4 + (int)(proj.localAI[1] - 1f);
		bool flag = proj.ai[2] >= 10f;
		int num4 = controlPoints.Count - 1;
		for (int i = 0; i < num4; i++)
		{
			Vector2 origin = vector;
			if (i == 0)
			{
				origin.Y -= 4f;
			}
			else if (i == num4 - 1)
			{
				rectangle.Y = height * num3;
			}
			else
			{
				int num5 = i % (num2 - num);
				rectangle.Y = height * (num + num5);
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (true)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Vector2 scale = new Vector2(1f, 1.25f);
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0) * 0.5f;
				Microsoft.Xna.Framework.Rectangle rectangle2 = rectangle;
				rectangle2.X += rectangle2.Width * 2;
				if (flag)
				{
					color2 = hslToRgb((proj.ai[2] / 15f + (float)timeForVisualEffects % 60f / 60f) % 1f, 1f, 0.5f);
					color2.A = 0;
				}
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_MeteorWhip(Projectile proj, List<Vector2> controlPoints)
	{
		int num = 6;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, num);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		int num2 = 1;
		int num3 = (int)MathHelper.Max(1f, num - 2);
		int num4 = controlPoints.Count - 1;
		for (int i = 0; i < num4; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			if (i == 0)
			{
				rectangle.Y = 0;
			}
			else if (i == num4 - 1)
			{
				rectangle.Y = height * (num - 1);
			}
			else
			{
				float amount = ((float)i - 1f) / ((float)num4 - 2f);
				int num5 = (int)Math.Round(MathHelper.Lerp(num2, num3, amount));
				rectangle.Y = height * num5;
				if (i % 3 != 0)
				{
					flag = false;
				}
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 255, 255, 255);
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, 1f, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_EelWhip(Projectile proj, List<Vector2> controlPoints)
	{
		int num = 5;
		SpriteEffects spriteEffects = SpriteEffects.None;
		if (proj.spriteDirection == 1)
		{
			spriteEffects ^= SpriteEffects.FlipHorizontally;
		}
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, num);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		float whipAnimationPercent = Projectile.GetWhipAnimationPercent(proj);
		int num2 = controlPoints.Count - 1;
		for (int i = 0; i < num2; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			Vector2 spinningpoint = Vector2.Zero;
			switch (i)
			{
			case 0:
				flag = false;
				break;
			case 1:
				rectangle.Y = 0;
				spinningpoint = new Vector2(-6f * Utils.MultiLerp(whipAnimationPercent, 0f, 1f, 0f), 0f);
				break;
			default:
			{
				if (i == num2 - 1)
				{
					rectangle.Y = height * (num - 1);
					break;
				}
				int num3 = ((i < 25) ? 1 : ((i < 35) ? 2 : 3));
				rectangle.Y = height * num3;
				break;
			}
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float num4 = vector4.ToRotation();
				float rotation = num4 - (float)Math.PI / 2f;
				Vector2 scale = new Vector2(Utils.Remap(i, 2f, num2 - 5, 0.5f, 1f), 1f) * proj.scale;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition + spinningpoint.RotatedBy(num4), rectangle, color, rotation, origin, scale, spriteEffects, 0f);
				Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(255, 255, 255, 0);
				spriteBatch.Draw(TextureAssets.GlowMask[358].Value, vector2 - screenPosition + spinningpoint.RotatedBy(num4), rectangle, color2, rotation, origin, scale, spriteEffects, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_BoneWhip(Projectile proj, List<Vector2> controlPoints)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			switch (i)
			{
			case 0:
				origin.Y -= 4f;
				break;
			case 19:
				rectangle.Y = height * 4;
				break;
			default:
				rectangle.Y = height * (1 + i % 3);
				break;
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, 1f, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_CoolWhip(Projectile proj, List<Vector2> controlPoints)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			switch (i)
			{
			case 0:
				origin.Y -= 4f;
				break;
			case 3:
			case 5:
			case 7:
				rectangle.Y = height;
				break;
			case 9:
			case 11:
			case 13:
				rectangle.Y = height * 2;
				break;
			case 15:
			case 17:
				rectangle.Y = height * 3;
				break;
			case 19:
				rectangle.Y = height * 4;
				break;
			default:
				flag = false;
				break;
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color alpha = proj.GetAlpha(Lighting.GetColor(vector3.ToTileCoordinates()));
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, alpha, rotation, origin, 1f, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_FireWhip(Projectile proj, List<Vector2> controlPoints)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			switch (i)
			{
			case 0:
				origin.Y -= 4f;
				break;
			case 3:
			case 5:
			case 7:
				rectangle.Y = height;
				break;
			case 9:
			case 11:
			case 13:
				rectangle.Y = height * 2;
				break;
			case 15:
			case 17:
				rectangle.Y = height * 3;
				break;
			case 19:
				rectangle.Y = height * 4;
				break;
			default:
				flag = false;
				break;
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color alpha = proj.GetAlpha(Lighting.GetColor(vector3.ToTileCoordinates()));
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, alpha, rotation, origin, 1f, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_RainbowWhip(Projectile proj, Player theOwner, List<Vector2> controlPoints)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		float miscCounterNormalized = theOwner.miscCounterNormalized;
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			switch (i)
			{
			case 0:
				origin.Y -= 4f;
				break;
			case 39:
				rectangle.Y = height * 4;
				break;
			default:
				flag = i % 2 == 0;
				rectangle.Y = height * (1 + i % 3);
				break;
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				Microsoft.Xna.Framework.Color color = hslToRgb((miscCounterNormalized * 5f + (float)i * 0.05f) % 1f, 1f, 0.5f);
				Microsoft.Xna.Framework.Color color2 = color;
				float lerpValue = Utils.GetLerpValue(controlPoints.Count - 10, controlPoints.Count - 2, i, clamped: true);
				float num = MathHelper.Lerp(1f, 1f, lerpValue);
				color2.A /= 2;
				color2.A = (byte)((float)(int)color2.A * lerpValue);
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color3 = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, Microsoft.Xna.Framework.Color.Lerp(color3, color2, 0.5f), rotation, origin, num, SpriteEffects.None, 0f);
				color2.A = 0;
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color2 * 0.1f, rotation, origin, num * 1.2f, SpriteEffects.None, 0f);
				if (i == 39)
				{
					color2 = color;
					color2.A = 127;
					spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color2 * 0.3f, rotation, origin, num * 1.4f, SpriteEffects.None, 0f);
				}
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_ThornWhip(Projectile proj, List<Vector2> controlPoints)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			float scale = 1f;
			switch (i)
			{
			case 0:
				origin.Y -= 4f;
				break;
			case 19:
				rectangle.Y = height * 4;
				scale = 1.1f;
				break;
			default:
				rectangle.Y = height * (1 + i % 3);
				scale = 0.8f;
				break;
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_WhipSword(Projectile proj, List<Vector2> controlPoints)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = true;
			Vector2 origin = vector;
			switch (i)
			{
			case 0:
				origin.Y -= 4f;
				break;
			case 3:
			case 5:
			case 7:
				rectangle.Y = height;
				break;
			case 9:
			case 11:
			case 13:
				rectangle.Y = height * 2;
				break;
			case 15:
			case 17:
				rectangle.Y = height * 3;
				break;
			case 19:
				rectangle.Y = height * 4;
				break;
			default:
				flag = false;
				break;
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, 1f, SpriteEffects.None, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_WhipMace(Projectile proj, List<Vector2> controlPoints)
	{
		SpriteEffects spriteEffects = SpriteEffects.None;
		if (proj.spriteDirection == 1)
		{
			spriteEffects ^= SpriteEffects.FlipHorizontally;
		}
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = false;
			Vector2 origin = vector;
			float scale = 1f;
			if (i == 0)
			{
				origin.Y -= 4f;
				flag = true;
			}
			else if (i % 2 == 0)
			{
				flag = true;
				int num = 1;
				if (i > 10)
				{
					num = 2;
				}
				if (i > 20)
				{
					num = 3;
				}
				rectangle.Y = height * num;
			}
			if (i == controlPoints.Count - 2)
			{
				flag = true;
				rectangle.Y = height * 4;
				scale = 1.3f;
				Projectile.GetWhipSettings(proj, out var timeToFlyOut, out var _, out var _);
				float t = proj.ai[0] / timeToFlyOut;
				float amount = Utils.GetLerpValue(0.1f, 0.7f, t, clamped: true) * Utils.GetLerpValue(0.9f, 0.7f, t, clamped: true);
				scale = MathHelper.Lerp(0.5f, 2f, amount);
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, spriteEffects, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_WhipScythe(Projectile proj, List<Vector2> controlPoints)
	{
		SpriteEffects spriteEffects = SpriteEffects.None;
		if (proj.spriteDirection == 1)
		{
			spriteEffects ^= SpriteEffects.FlipHorizontally;
		}
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = false;
			Vector2 origin = vector;
			float scale = 1f;
			if (i == 0)
			{
				origin.Y -= 4f;
				flag = true;
			}
			else if (i % 2 == 0)
			{
				flag = true;
				int num = 1;
				if (i > 10)
				{
					num = 2;
				}
				if (i > 20)
				{
					num = 3;
				}
				rectangle.Y = height * num;
			}
			if (i == controlPoints.Count - 2)
			{
				flag = true;
				rectangle.Y = height * 4;
				scale = 1.3f;
				Projectile.GetWhipSettings(proj, out var timeToFlyOut, out var _, out var _);
				float t = proj.ai[0] / timeToFlyOut;
				float amount = Utils.GetLerpValue(0.1f, 0.7f, t, clamped: true) * Utils.GetLerpValue(0.9f, 0.7f, t, clamped: true);
				scale = MathHelper.Lerp(0.5f, 1.5f, amount);
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, spriteEffects, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	public static Vector2 DrawWhip_WhipBland(Projectile proj, List<Vector2> controlPoints)
	{
		SpriteEffects spriteEffects = SpriteEffects.None;
		if (proj.spriteDirection == 1)
		{
			spriteEffects ^= SpriteEffects.FlipHorizontally;
		}
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 5);
		int height = rectangle.Height;
		rectangle.Height -= 2;
		Vector2 vector = rectangle.Size() / 2f;
		Vector2 vector2 = controlPoints[0];
		for (int i = 0; i < controlPoints.Count - 1; i++)
		{
			bool flag = false;
			Vector2 origin = vector;
			float scale = 1f;
			if (i == 0)
			{
				origin.Y -= 4f;
				flag = true;
			}
			else
			{
				flag = true;
				int num = 1;
				if (i > 10)
				{
					num = 2;
				}
				if (i > 20)
				{
					num = 3;
				}
				rectangle.Y = height * num;
			}
			if (i == controlPoints.Count - 2)
			{
				flag = true;
				rectangle.Y = height * 4;
				scale = 1.3f;
				Projectile.GetWhipSettings(proj, out var timeToFlyOut, out var _, out var _);
				float t = proj.ai[0] / timeToFlyOut;
				float amount = Utils.GetLerpValue(0.1f, 0.7f, t, clamped: true) * Utils.GetLerpValue(0.9f, 0.7f, t, clamped: true);
				scale = MathHelper.Lerp(0.5f, 1.5f, amount);
			}
			Vector2 vector3 = controlPoints[i];
			Vector2 vector4 = controlPoints[i + 1] - vector3;
			if (flag)
			{
				float rotation = vector4.ToRotation() - (float)Math.PI / 2f;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(vector3.ToTileCoordinates());
				spriteBatch.Draw(value, vector2 - screenPosition, rectangle, color, rotation, origin, scale, spriteEffects, 0f);
			}
			vector2 += vector4;
		}
		return vector2;
	}

	private void DrawTwinsPet(Projectile proj)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		SpriteEffects effects = ((proj.spriteDirection != 1) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, projFrames[proj.type], 0, proj.frame);
		Vector2 origin = rectangle.Size() / 2f;
		Vector2 vector = proj.Center - screenPosition;
		Microsoft.Xna.Framework.Color alpha = proj.GetAlpha(Lighting.GetColor(proj.Center.ToTileCoordinates()));
		float num = 18f;
		if (proj.isAPreviewDummy)
		{
			num = 8f;
		}
		Vector2 position = vector + (GlobalTimeWrappedHourly * 2f).ToRotationVector2() * num;
		EntitySpriteDraw(value, position, rectangle, alpha, proj.rotation, origin, proj.scale, effects);
		position = vector - (GlobalTimeWrappedHourly * 2f).ToRotationVector2() * num;
		rectangle = value.Frame(1, projFrames[proj.type], 0, proj.frame + 18);
		EntitySpriteDraw(value, position, rectangle, alpha, proj.rotation, origin, proj.scale, effects);
	}

	private void DrawMultisegmentPet(Projectile proj)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Texture2D texture2D = null;
		if (proj.type == 887)
		{
			texture2D = TextureAssets.GlowMask[275].Value;
		}
		int num = 5;
		int num2 = 16;
		switch (proj.type)
		{
		case 883:
			num = 5;
			num2 = 16;
			break;
		case 887:
			num = 6;
			num2 = 16;
			break;
		case 893:
			num = 8;
			num2 = 20;
			break;
		}
		SpriteEffects effects = ((proj.spriteDirection != 1) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, projFrames[proj.type]);
		Vector2 origin = rectangle.Size() / 2f;
		Vector2 position = proj.Center - screenPosition;
		Microsoft.Xna.Framework.Color alpha = proj.GetAlpha(Lighting.GetColor(proj.Center.ToTileCoordinates()));
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White * ((float)(int)mouseTextColor / 255f);
		Vector2 vector = proj.Center;
		int num3 = 1;
		int num4 = projFrames[proj.type] - 1;
		for (int i = 1; i < num; i++)
		{
			int frameY = num3;
			if (i == num - 1)
			{
				frameY = num4;
			}
			else if (proj.type == 893 && i != 2 && i != 5)
			{
				frameY = 2;
			}
			Microsoft.Xna.Framework.Rectangle value2 = value.Frame(1, projFrames[proj.type], 0, frameY);
			Vector2 vector2 = proj.oldPos[i * 10] + proj.Size / 2f;
			float num5 = (vector - vector2).ToRotation();
			vector2 = vector - new Vector2(num2, 0f).RotatedBy(num5, Vector2.Zero);
			num5 = (vector - vector2).ToRotation() + (float)Math.PI / 2f;
			Vector2 position2 = vector2 - screenPosition;
			SpriteEffects effects2 = ((!(vector2.X < vector.X)) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
			vector = vector2;
			EntitySpriteDraw(value, position2, value2, proj.GetAlpha(Lighting.GetColor(vector2.ToTileCoordinates())), num5, origin, proj.scale, effects2);
			if (texture2D != null)
			{
				EntitySpriteDraw(texture2D, position2, value2, proj.GetAlpha(color), num5, origin, proj.scale, effects2);
			}
		}
		EntitySpriteDraw(value, position, rectangle, alpha, proj.rotation, origin, proj.scale, effects);
		if (texture2D != null)
		{
			EntitySpriteDraw(texture2D, position, rectangle, color, proj.rotation, origin, proj.scale, effects);
		}
	}

	public static void DrawKite(Projectile proj, Vector2 anchorPos)
	{
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		Texture2D value2 = TextureAssets.Extra[103].Value;
		int num = 15;
		float num2 = 0f;
		int num3 = 10;
		int num4 = 5;
		float num5 = 10f;
		float num6 = 0f;
		int num7 = -14;
		float num8 = -2f;
		int num9 = -1;
		float num10 = -1f;
		int num11 = 8;
		int num12 = 0;
		int num13 = 1;
		float num14 = 0f;
		float num15 = 0f;
		bool flag = true;
		bool flag2 = false;
		float num16 = 0f;
		float num17 = Math.Abs(WindForVisuals);
		float num18 = Utils.Remap(num17, 0.24f, 0.2f, 0f, 1f);
		num18 = 0f;
		num18 = Utils.Remap(proj.localAI[0], 0f, 300f, 0f, 1f);
		float num19 = proj.localAI[1];
		switch (proj.type)
		{
		case 771:
			value2 = TextureAssets.Extra[104].Value;
			num = 12;
			num12 = 12;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 12;
			num5 = 22f;
			num6 += (float)Math.PI / 8f * (float)proj.spriteDirection;
			num7 = -8;
			num8 = -6f;
			num9 = 10;
			num10 = 8f;
			num11 = 12;
			num16 = (float)Math.PI / 16f;
			break;
		case 822:
			value2 = TextureAssets.Extra[132].Value;
			num = 7;
			num12 = 7;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 7;
			num5 = 22f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num7 = -20;
			num8 = -6f;
			num11 = 12;
			num16 = (float)Math.PI / 16f;
			break;
		case 850:
			value2 = TextureAssets.Extra[147].Value;
			num = 8;
			num12 = 8;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 8;
			num5 = 22f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num7 = -20;
			num8 = -38f;
			num11 = 12;
			num14 = 6f;
			num15 = 2f;
			flag = false;
			num16 = (float)Math.PI * 5f / 32f;
			break;
		case 823:
		case 846:
			value2 = TextureAssets.Extra[133].Value;
			if (proj.type == 846)
			{
				value2 = TextureAssets.Extra[146].Value;
			}
			num = 6;
			num12 = 6;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 6;
			num5 = 40f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num7 = -16;
			num8 = -10f;
			num11 = 30;
			num16 = (float)Math.PI * 3f / 16f;
			break;
		case 827:
		case 844:
			value2 = TextureAssets.Extra[135].Value;
			if (proj.type == 844)
			{
				value2 = TextureAssets.Extra[144].Value;
			}
			num = 4;
			num12 = 3;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 16;
			num5 = 10f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num8 = -4f;
			num4 = 4;
			flag2 = true;
			num16 = (float)Math.PI / 32f;
			break;
		case 828:
		case 829:
			value2 = TextureAssets.Extra[136].Value;
			if (proj.type == 829)
			{
				value2 = TextureAssets.Extra[137].Value;
			}
			num = 2;
			num12 = 1;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 6;
			num5 = 10f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num11 = 10;
			num8 = -4f;
			num13 = 3;
			flag = false;
			flag2 = true;
			num16 = (float)Math.PI * 3f / 16f;
			break;
		case 852:
			value2 = TextureAssets.Extra[148].Value;
			num = 2;
			num12 = 1;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 6;
			num5 = 10f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num11 = 10;
			num8 = -4f;
			num13 = 4;
			flag = false;
			flag2 = true;
			num16 = (float)Math.PI * 5f / 16f;
			break;
		case 830:
		case 838:
			value2 = TextureAssets.Extra[138].Value;
			if (proj.type == 838)
			{
				value2 = TextureAssets.Extra[139].Value;
			}
			num = 3;
			num12 = 3;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 3;
			num5 = 60f;
			num10 = 40f;
			num9 = 3;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num11 = 50;
			num8 = -20f;
			num14 = -10f;
			num16 = (float)Math.PI / 4f;
			break;
		case 843:
			value2 = TextureAssets.Extra[140].Value;
			num = 2;
			num12 = 2;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 2;
			num5 = 30f;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num11 = 20;
			num8 = -16f;
			num14 = -10f;
			num16 = (float)Math.PI / 4f;
			break;
		case 845:
			value2 = TextureAssets.Extra[145].Value;
			num = 3;
			num12 = 3;
			num2 = ((proj.spriteDirection == 1) ? ((float)Math.PI / 2f) : (-(float)Math.PI / 2f));
			num3 = 3;
			num5 = 42f;
			num10 = 50f;
			num9 = 2;
			num6 += (float)Math.PI / 12f * (float)proj.spriteDirection;
			num11 = 30;
			num8 = -8f;
			num14 = -10f;
			break;
		case 824:
		case 826:
		case 839:
		case 840:
		case 853:
			num13 = 0;
			num6 = num18 * num19 * ((float)Math.PI * 2f) * -0.125f * (float)proj.spriteDirection;
			num6 = 0f;
			break;
		case 766:
		case 767:
		case 768:
		case 769:
		case 770:
			num12 = (proj.type - 766) * 3 + 3;
			break;
		}
		SpriteEffects effects = ((proj.spriteDirection != 1) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(projFrames[proj.type], 1, proj.frame);
		Vector2 origin = rectangle.Size() / 2f;
		Vector2 position = proj.Center - screenPosition;
		Microsoft.Xna.Framework.Color color = Lighting.GetColor(proj.Center.ToTileCoordinates());
		Microsoft.Xna.Framework.Color alpha = proj.GetAlpha(color);
		Texture2D value3 = TextureAssets.FishingLine.Value;
		Microsoft.Xna.Framework.Rectangle value4 = value3.Frame();
		Vector2 origin2 = new Vector2(value4.Width / 2, 2f);
		Microsoft.Xna.Framework.Rectangle rectangle2 = value2.Frame(num);
		int width = rectangle2.Width;
		rectangle2.Width -= 2;
		Vector2 origin3 = rectangle2.Size() / 2f;
		rectangle2.X = width * (num - 1);
		origin.X += -2 * proj.spriteDirection;
		Vector2 center = proj.Center;
		Vector2.Distance(center, anchorPos);
		float num20 = 12f;
		_ = (anchorPos - center).SafeNormalize(Vector2.Zero) * num20;
		Vector2 vector = anchorPos;
		Vector2 vector2 = center - vector;
		Vector2 velocity = proj.velocity;
		if (Math.Abs(velocity.X) > Math.Abs(velocity.Y))
		{
			Utils.Swap(ref velocity.X, ref velocity.Y);
		}
		float num21 = vector2.Length();
		float num22 = Vector2.Distance(proj.Center, anchorPos);
		if (num22 == 0f)
		{
			num22 = 1f;
		}
		float num23 = 16f;
		float num24 = 80f;
		bool flag3 = true;
		if (num21 == 0f)
		{
			flag3 = false;
		}
		else
		{
			vector2 *= 12f / num21;
			vector -= vector2;
			vector2 = center - vector;
		}
		while (flag3)
		{
			float num25 = 12f;
			float num26 = vector2.Length();
			float num27 = num26;
			if (float.IsNaN(num26) || num26 == 0f)
			{
				flag3 = false;
				continue;
			}
			if (num26 < 20f)
			{
				flag3 = false;
				vector += vector2.SafeNormalize(Vector2.Zero) * num25;
				vector2 = center - vector;
				num25 = vector2.Length() + 4f;
			}
			else
			{
				num26 = 12f / num26;
				vector2 *= num26;
				vector += vector2;
				vector2 = center - vector;
				if (num27 > 12f)
				{
					float num28 = 0.3f;
					float num29 = Math.Abs(velocity.X) + Math.Abs(velocity.Y);
					if (num29 > num23)
					{
						num29 = num23;
					}
					num29 = 1f - num29 / num23;
					num28 *= num29;
					num29 = num27 / num24;
					if (num29 > 1f)
					{
						num29 = 1f;
					}
					num28 *= num29;
					if (num28 < 0f)
					{
						num28 = 0f;
					}
					num29 = 1f;
					num28 *= num29;
					if (vector2.Y > 0f)
					{
						vector2.Y *= 1f + num28;
						vector2.X *= 1f - num28;
					}
					else
					{
						num29 = Math.Abs(velocity.X) / 3f;
						if (num29 > 1f)
						{
							num29 = 1f;
						}
						num29 -= 0.5f;
						num28 *= num29;
						if (num28 > 0f)
						{
							num28 *= 2f;
						}
						vector2.Y *= 1f + num28;
						vector2.X *= 1f - num28;
					}
				}
			}
			float rotation = vector2.ToRotation() - (float)Math.PI / 2f;
			if (!flag3)
			{
				value4.Height = (int)num25;
			}
			Microsoft.Xna.Framework.Color color2 = Lighting.GetColor(center.ToTileCoordinates());
			color2 *= 0.42745098f;
			float num30 = Vector2.Distance(proj.Center, vector);
			float fromValue = 1f - num30 / num22;
			color2 *= Utils.Remap(fromValue, 0f, 1f, 0.5f, 1f);
			EntitySpriteDraw(scale: new Vector2(0.8f, 1f), texture: value3, position: vector - screenPosition, sourceRectangle: value4, color: color2, rotation: rotation, origin: origin2, effects: SpriteEffects.None);
		}
		Vector2 vector3 = proj.Size / 2f;
		float num31 = MathHelper.Lerp(0.5f, 1f, num17);
		float num32 = num17;
		if (vector2.Y >= -0.02f && vector2.Y < 1f)
		{
			num32 = Utils.GetLerpValue(0.2f, 0.5f, num17, clamped: true);
		}
		int num33 = num4;
		int num34 = num3 + 1;
		for (int i = 0; i < num13; i++)
		{
			rectangle2.X = width * (num - 1);
			List<Vector2> list = new List<Vector2>();
			Vector2 vector4 = new Vector2(num31 * (float)num11 * (float)proj.spriteDirection, (float)Math.Sin(timeForVisualEffects / 300.0 * 6.2831854820251465) * num32) * 2f;
			float num35 = (float)num7 + num14;
			float num36 = num8 + num15;
			float num37 = 0.5f;
			switch (i)
			{
			case 1:
				vector4 = new Vector2(num31 * (float)num11 * (float)proj.spriteDirection, (float)Math.Sin(timeForVisualEffects / 300.0 * 6.2831854820251465) * num32 + 0.5f * (1f - num18)) * 2f;
				num35 -= 8f;
				num36 -= 8f;
				break;
			case 2:
				vector4 = new Vector2(num31 * (float)num11 * (float)proj.spriteDirection, (float)Math.Sin(timeForVisualEffects / 300.0 * 6.2831854820251465) * num32 + 1f * (1f - num18)) * 2f;
				num35 -= 4f;
				num36 -= 4f;
				break;
			case 3:
				vector4 = new Vector2(num31 * (float)num11 * (float)proj.spriteDirection, (float)Math.Sin(timeForVisualEffects / 300.0 * 6.2831854820251465) * num32 + 1.5f * (1f - num18)) * 2f;
				num35 -= 12f;
				num36 -= 12f;
				break;
			}
			if (num18 > 0f)
			{
				vector4 = vector4.RotatedBy(num18 * ((float)Math.PI / 2f) * (float)proj.spriteDirection);
				num8 *= 1f - num18;
				num14 *= 1f - num18;
				num15 *= 1f - num18;
				float num38 = 1f - num19;
				num38 *= num18;
				num6 *= 1f - num38;
				num6 -= (float)Math.PI / 4f * num38 * (float)proj.spriteDirection;
				num6 += num38 * num16 * (float)proj.spriteDirection;
				if (num5 != -1f)
				{
					num5 *= MathHelper.Lerp(1f, 0.7f, num18);
				}
				num10 *= MathHelper.Lerp(1f, 0.7f, num18);
			}
			Vector2 vector5 = proj.Center + new Vector2(((float)rectangle.Width * num37 + num35) * (float)proj.spriteDirection, num36).RotatedBy(proj.rotation + num6);
			list.Add(vector5);
			int num39 = num33;
			int num40 = 1;
			while (num39 < num34 * num33)
			{
				if (num9 != -1 && num9 == num40)
				{
					num5 = num10;
				}
				Vector2 vector6 = proj.oldPos[num39];
				if (vector6.X == 0f && vector6.Y == 0f)
				{
					list.Add(vector5);
				}
				else
				{
					Vector2 spinningpoint = new Vector2(((float)rectangle.Width * num37 + num35) * (float)proj.oldSpriteDirection[num39], num36);
					float num41 = proj.oldRot[num39] + num6;
					vector6 += vector3 + spinningpoint.RotatedBy(num41);
					vector6 += vector4 * (num40 + 1);
					Vector2 vector7 = vector5 - vector6;
					float num42 = vector7.Length();
					if (num42 > num5)
					{
						vector7 *= num5 / num42;
					}
					vector6 = vector5 - vector7;
					list.Add(vector6);
					vector5 = vector6;
				}
				num39 += num33;
				num40++;
			}
			if (flag)
			{
				Microsoft.Xna.Framework.Rectangle value5 = value3.Frame();
				for (int num43 = list.Count - 2; num43 >= 0; num43--)
				{
					Vector2 vector8 = list[num43];
					Vector2 v = list[num43 + 1] - vector8;
					float num44 = v.Length();
					if (!(num44 < 2f))
					{
						float rotation2 = v.ToRotation() - (float)Math.PI / 2f;
						EntitySpriteDraw(value3, vector8 - screenPosition, value5, alpha * 0.42745098f, rotation2, origin2, new Vector2(1f, num44 / (float)value5.Height), SpriteEffects.None);
					}
				}
			}
			for (int num45 = list.Count - 2; num45 >= 0; num45--)
			{
				Vector2 vector9 = list[num45];
				Vector2 vector10 = list[num45 + 1];
				Vector2 v2 = vector10 - vector9;
				v2.Length();
				float rotation3 = v2.ToRotation() - (float)Math.PI / 2f + num2;
				EntitySpriteDraw(value2, vector10 - screenPosition, rectangle2, alpha, rotation3, origin3, proj.scale, effects);
				rectangle2.X -= width;
				if (rectangle2.X < 0)
				{
					int num46 = num12;
					if (flag2)
					{
						num46--;
					}
					rectangle2.X = num46 * width;
				}
			}
		}
		EntitySpriteDraw(value, position, rectangle, alpha, proj.rotation + num6, origin, proj.scale, effects);
	}

	public static Vector2 GetPlayerArmPosition(Projectile proj, Player theOwner)
	{
		Vector2 vector = OffsetsPlayerOnhand[theOwner.bodyFrame.Y / 56] * 2f;
		if (theOwner.direction != 1)
		{
			vector.X = (float)theOwner.bodyFrame.Width - vector.X;
		}
		if (theOwner.gravDir != 1f)
		{
			vector.Y = (float)theOwner.bodyFrame.Height - vector.Y;
		}
		vector -= new Vector2(theOwner.bodyFrame.Width - theOwner.width, (float)theOwner.bodyFrame.Height - theOwner.BaseHeight) / 2f;
		Vector2 pos = theOwner.MountedCenter - new Vector2(theOwner.width, theOwner.BaseHeight) / 2f + vector;
		if (theOwner.mount.Active && theOwner.mount.Type == 52)
		{
			pos.Y -= theOwner.mount.PlayerOffsetHitbox;
			pos += new Vector2(12 * theOwner.direction, -12f);
		}
		theOwner.ApplyItemPositionOffsetFromMount(ref pos);
		return theOwner.RotatedRelativePoint(pos);
	}

	private void DrawProjWithStarryTrail(Projectile proj, Player theOwner, Microsoft.Xna.Framework.Color projectileColor, SpriteEffects dir)
	{
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 255, 255, projectileColor.A - proj.alpha);
		Vector2 vector = proj.velocity;
		Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Blue * 0.1f;
		Vector2 spinningpoint = new Vector2(0f, -4f);
		float num = 0f;
		float t = vector.Length();
		float num2 = Utils.GetLerpValue(3f, 5f, t, clamped: true);
		bool flag = true;
		if (proj.type == 1049)
		{
			flag = false;
		}
		if (proj.type == 856 || proj.type == 857)
		{
			vector = proj.position - proj.oldPos[1];
			float num3 = vector.Length();
			if (num3 == 0f)
			{
				vector = Vector2.UnitY;
			}
			else
			{
				vector *= 5f / num3;
			}
			Vector2 origin = new Vector2(proj.ai[0], proj.ai[1]);
			Vector2 center = theOwner.Center;
			float lerpValue = Utils.GetLerpValue(0f, 120f, origin.Distance(center), clamped: true);
			float num4 = 90f;
			if (proj.type == 857)
			{
				num4 = 60f;
				flag = false;
			}
			float lerpValue2 = Utils.GetLerpValue(num4, num4 * (5f / 6f), proj.localAI[0], clamped: true);
			float lerpValue3 = Utils.GetLerpValue(0f, 120f, proj.Center.Distance(center), clamped: true);
			lerpValue *= lerpValue3;
			lerpValue2 *= Utils.GetLerpValue(0f, 15f, proj.localAI[0], clamped: true);
			color2 = Microsoft.Xna.Framework.Color.HotPink * 0.15f * (lerpValue2 * lerpValue);
			if (proj.type == 857)
			{
				color2 = proj.GetFirstFractalColor() * 0.15f * (lerpValue2 * lerpValue);
			}
			spinningpoint = new Vector2(0f, -2f);
			float lerpValue4 = Utils.GetLerpValue(num4, num4 * (2f / 3f), proj.localAI[0], clamped: true);
			lerpValue4 *= Utils.GetLerpValue(0f, 20f, proj.localAI[0], clamped: true);
			num = -0.3f * (1f - lerpValue4);
			num += -1f * Utils.GetLerpValue(15f, 0f, proj.localAI[0], clamped: true);
			num *= lerpValue;
			num2 = lerpValue2 * lerpValue;
		}
		if (proj.type == 1049)
		{
			color2 = new Microsoft.Xna.Framework.Color(250, 150, 100) * 0.1f;
		}
		Vector2 vector2 = proj.Center + vector;
		Texture2D value = TextureAssets.Projectile[proj.type].Value;
		_ = new Microsoft.Xna.Framework.Rectangle(0, 0, value.Width, value.Height).Size() / 2f;
		Texture2D value2 = TextureAssets.Extra[91].Value;
		Microsoft.Xna.Framework.Rectangle value3 = value2.Frame();
		Vector2 origin2 = new Vector2((float)value3.Width / 2f, 10f);
		_ = Microsoft.Xna.Framework.Color.Cyan * 0.5f * num2;
		Vector2 vector3 = new Vector2(0f, proj.gfxOffY);
		float num5 = (float)timeForVisualEffects / 60f;
		Vector2 vector4 = vector2 + vector * 0.5f;
		Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.White * 0.5f * num2;
		color3.A = 0;
		Microsoft.Xna.Framework.Color color4 = color2 * num2;
		color4.A = 0;
		Microsoft.Xna.Framework.Color color5 = color2 * num2;
		color5.A = 0;
		Microsoft.Xna.Framework.Color color6 = color2 * num2;
		color6.A = 0;
		float num6 = vector.ToRotation();
		EntitySpriteDraw(value2, vector4 - screenPosition + vector3 + spinningpoint.RotatedBy((float)Math.PI * 2f * num5), value3, color4, num6 + (float)Math.PI / 2f, origin2, 1.5f + num, SpriteEffects.None);
		EntitySpriteDraw(value2, vector4 - screenPosition + vector3 + spinningpoint.RotatedBy((float)Math.PI * 2f * num5 + (float)Math.PI * 2f / 3f), value3, color5, num6 + (float)Math.PI / 2f, origin2, 1.1f + num, SpriteEffects.None);
		EntitySpriteDraw(value2, vector4 - screenPosition + vector3 + spinningpoint.RotatedBy((float)Math.PI * 2f * num5 + 4.1887903f), value3, color6, num6 + (float)Math.PI / 2f, origin2, 1.3f + num, SpriteEffects.None);
		Vector2 vector5 = vector2 - vector * 0.5f;
		for (float num7 = 0f; num7 < 1f; num7 += 0.5f)
		{
			float num8 = num5 % 0.5f / 0.5f;
			num8 = (num8 + num7) % 1f;
			float num9 = num8 * 2f;
			if (num9 > 1f)
			{
				num9 = 2f - num9;
			}
			EntitySpriteDraw(value2, vector5 - screenPosition + vector3, value3, color3 * num9, num6 + (float)Math.PI / 2f, origin2, 0.3f + num8 * 0.5f, SpriteEffects.None);
		}
		if (flag)
		{
			float rotation = proj.rotation + proj.localAI[1];
			_ = (float)timeForVisualEffects / 240f;
			_ = GlobalTimeWrappedHourly;
			float globalTimeWrappedHourly = GlobalTimeWrappedHourly;
			globalTimeWrappedHourly %= 5f;
			globalTimeWrappedHourly /= 2.5f;
			if (globalTimeWrappedHourly >= 1f)
			{
				globalTimeWrappedHourly = 2f - globalTimeWrappedHourly;
			}
			globalTimeWrappedHourly = globalTimeWrappedHourly * 0.5f + 0.5f;
			Vector2 position = proj.Center - screenPosition;
			instance.LoadItem(75);
			Texture2D value4 = TextureAssets.Item[75].Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value4.Frame(1, 8);
			EntitySpriteDraw(origin: rectangle.Size() / 2f, texture: value4, position: position, sourceRectangle: rectangle, color: color, rotation: rotation, scale: proj.scale, effects: SpriteEffects.None);
		}
	}

	private static int TryInteractingWithVoidLens(Projectile proj)
	{
		if (gamePaused || gameMenu)
		{
			return 0;
		}
		bool flag = !SmartCursorIsUsed && !PlayerInput.UsingGamepad;
		Player localPlayer = LocalPlayer;
		Microsoft.Xna.Framework.Point point = proj.Center.ToTileCoordinates();
		Vector2 compareSpot = localPlayer.Center;
		if (!localPlayer.IsProjectileInteractibleAndInInteractionRange(proj, ref compareSpot))
		{
			return 0;
		}
		Vector2 v = ReverseGravitySupport(MouseScreen) + screenPosition;
		bool flag2 = proj.Hitbox.Contains(v.ToPoint());
		if (!((flag2 || SmartInteractProj == proj.whoAmI) & !localPlayer.lastMouseInterface))
		{
			if (!flag)
			{
				return 1;
			}
			return 0;
		}
		HasInteractibleObjectThatIsNotATile = true;
		if (flag2)
		{
			localPlayer.noThrow = 2;
			localPlayer.cursorItemIconEnabled = true;
			localPlayer.cursorItemIconID = 4131;
		}
		if (PlayerInput.UsingGamepad)
		{
			localPlayer.GamepadEnableGrappleCooldown();
		}
		if (mouseRight && mouseRightRelease && Player.BlockInteractionWithProjectiles == 0)
		{
			mouseRightRelease = false;
			localPlayer.tileInteractAttempted = true;
			localPlayer.tileInteractionHappened = true;
			localPlayer.releaseUseTile = false;
			if (localPlayer.chest == -5)
			{
				localPlayer.chest = -1;
				SoundEngine.PlaySound(SoundID.Item130);
			}
			else if (localPlayer.disableVoidBag < 0)
			{
				stackSplit = 600;
				localPlayer.chest = -5;
				Chest currentContainer = localPlayer.GetCurrentContainer();
				if (currentContainer != null)
				{
					ItemSlot.SetGlowForChest(currentContainer);
				}
				localPlayer.voidLensChest.Set(proj);
				localPlayer.chestX = point.X;
				localPlayer.chestY = point.Y;
				localPlayer.SetTalkNPC(-1);
				SetNPCShopIndex(0);
				playerInventory = true;
				SoundEngine.PlaySound(SoundID.Item130);
			}
		}
		if (!SmartCursorIsUsed && !PlayerInput.UsingGamepad)
		{
			return 0;
		}
		if (!flag)
		{
			return 2;
		}
		return 0;
	}

	private static int TryInteractingWithMoneyTrough(Projectile proj)
	{
		if (gamePaused || gameMenu)
		{
			return 0;
		}
		bool flag = !SmartCursorIsUsed && !PlayerInput.UsingGamepad;
		Player localPlayer = LocalPlayer;
		Microsoft.Xna.Framework.Point point = proj.Center.ToTileCoordinates();
		Vector2 compareSpot = localPlayer.Center;
		if (!localPlayer.IsProjectileInteractibleAndInInteractionRange(proj, ref compareSpot))
		{
			return 0;
		}
		Vector2 v = ReverseGravitySupport(MouseScreen) + screenPosition;
		bool flag2 = proj.Hitbox.Contains(v.ToPoint());
		if (!((flag2 || SmartInteractProj == proj.whoAmI) & !localPlayer.lastMouseInterface))
		{
			if (!flag)
			{
				return 1;
			}
			return 0;
		}
		HasInteractibleObjectThatIsNotATile = true;
		if (flag2)
		{
			localPlayer.noThrow = 4;
			localPlayer.cursorItemIconEnabled = true;
			localPlayer.cursorItemIconID = 3213;
			if (proj.type == 960)
			{
				localPlayer.cursorItemIconID = 5098;
			}
		}
		if (PlayerInput.UsingGamepad)
		{
			localPlayer.GamepadEnableGrappleCooldown();
		}
		if (mouseRight && mouseRightRelease && Player.BlockInteractionWithProjectiles == 0)
		{
			mouseRightRelease = false;
			localPlayer.tileInteractAttempted = true;
			localPlayer.tileInteractionHappened = true;
			localPlayer.releaseUseTile = false;
			if (localPlayer.chest == -2)
			{
				localPlayer.chest = -1;
				PlayInteractiveProjectileOpenCloseSound(proj.type, open: false);
			}
			else
			{
				stackSplit = 600;
				localPlayer.chest = -2;
				Chest currentContainer = localPlayer.GetCurrentContainer();
				if (currentContainer != null)
				{
					ItemSlot.SetGlowForChest(currentContainer);
				}
				localPlayer.piggyBankProjTracker.Set(proj);
				localPlayer.chestX = point.X;
				localPlayer.chestY = point.Y;
				localPlayer.SetTalkNPC(-1);
				SetNPCShopIndex(0);
				playerInventory = true;
				PlayInteractiveProjectileOpenCloseSound(proj.type, open: true);
			}
		}
		if (!SmartCursorIsUsed && !PlayerInput.UsingGamepad)
		{
			return 0;
		}
		if (!flag)
		{
			return 2;
		}
		return 0;
	}

	private static int TryPetting(Projectile proj, int itemIcon)
	{
		if (gamePaused || gameMenu)
		{
			return 0;
		}
		Player localPlayer = LocalPlayer;
		Vector2 compareSpot = localPlayer.Center;
		if (!localPlayer.IsProjectileInteractibleAndInInteractionRange(proj, ref compareSpot))
		{
			return 0;
		}
		Vector2 v = ReverseGravitySupport(MouseScreen) + screenPosition;
		Microsoft.Xna.Framework.Rectangle hitbox = proj.Hitbox;
		if (proj.type == 1094)
		{
			hitbox.Inflate(6, 6);
		}
		bool flag = hitbox.Contains(v.ToPoint());
		bool num = (flag || SmartInteractProj == proj.whoAmI) & !localPlayer.lastMouseInterface;
		bool flag2 = !SmartCursorIsUsed && !PlayerInput.UsingGamepad;
		if (!num)
		{
			if (!flag2)
			{
				return 1;
			}
			return 0;
		}
		HasInteractibleObjectThatIsNotATile = true;
		if (flag)
		{
			localPlayer.noThrow = 4;
			localPlayer.cursorItemIconEnabled = true;
			localPlayer.cursorItemIconID = itemIcon;
		}
		if (PlayerInput.UsingGamepad)
		{
			localPlayer.GamepadEnableGrappleCooldown();
		}
		if (mouseRight && mouseRightRelease && Player.BlockInteractionWithProjectiles == 0)
		{
			mouseRightRelease = false;
			localPlayer.tileInteractAttempted = true;
			localPlayer.tileInteractionHappened = true;
			localPlayer.releaseUseTile = false;
			localPlayer.PetAnimal(proj.GetPettingInfo(localPlayer));
		}
		if (!SmartCursorIsUsed && !PlayerInput.UsingGamepad)
		{
			return 0;
		}
		if (!flag2)
		{
			return 2;
		}
		return 0;
	}

	public static void PlayInteractiveProjectileOpenCloseSound(int projType, bool open)
	{
		switch (projType)
		{
		case 525:
			SoundEngine.PlaySound(SoundID.Item59);
			break;
		case 960:
			SoundEngine.PlaySound(open ? SoundID.ChesterOpen : SoundID.ChesterClose);
			break;
		}
	}

	public static void PrintTimedMessage(string message, params object[] arguments)
	{
		Console.WriteLine($"{(int)time} {string.Format(message, arguments)}");
	}

	public void PrepareDrawnProjectileDrawing(Projectile proj)
	{
		CurrentDrawnEntity = proj;
		int projectileDesiredShader = GetProjectileDesiredShader(proj);
		Matrix value = Transform;
		if (proj.isAPreviewDummy)
		{
			value = UIScaleMatrix;
		}
		PrepareDrawnEntityDrawing(proj, projectileDesiredShader, value);
	}

	public void PrepareDrawnEntityDrawing(Entity entity, int intendedShader, Matrix? overrideMatrix)
	{
		CurrentDrawnEntity = entity;
		Matrix transformMatrix = Transform;
		if (overrideMatrix.HasValue)
		{
			transformMatrix = overrideMatrix.Value;
		}
		if (intendedShader != 0)
		{
			if (CurrentDrawnEntityShader == 0 || CurrentDrawnEntityShader == -1)
			{
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, base.GraphicsDevice.RasterizerState, null, transformMatrix);
			}
		}
		else if (CurrentDrawnEntityShader != 0 && CurrentDrawnEntityShader != -1)
		{
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, base.GraphicsDevice.RasterizerState, null, transformMatrix);
		}
		CurrentDrawnEntityShader = intendedShader;
	}

	public static void EntitySpriteDraw(Texture2D texture, Vector2 position, Microsoft.Xna.Framework.Rectangle? sourceRectangle, Microsoft.Xna.Framework.Color color, float rotation, Vector2 origin, float scale, SpriteEffects effects, float worthless = 0f)
	{
		EntitySpriteDraw(texture, position, sourceRectangle, color, rotation, origin, new Vector2(scale), effects, worthless);
	}

	public static void EntitySpriteDraw(Texture2D texture, Vector2 position, Microsoft.Xna.Framework.Rectangle? sourceRectangle, Microsoft.Xna.Framework.Color color, float rotation, Vector2 origin, Vector2 scale, SpriteEffects effects, float worthless = 0f)
	{
		if (CurrentDrawnEntityShader > 0)
		{
			DrawData value = new DrawData(texture, position, sourceRectangle, color, rotation, origin, scale, effects, worthless);
			GameShaders.Armor.Apply(CurrentDrawnEntityShader, CurrentDrawnEntity, value);
			value.Draw(spriteBatch);
		}
		else
		{
			spriteBatch.Draw(texture, position, sourceRectangle, color, rotation, origin, scale, effects, worthless);
		}
	}

	public static void EntitySpriteDraw(DrawData data)
	{
		if (CurrentDrawnEntityShader > 0)
		{
			GameShaders.Armor.Apply(CurrentDrawnEntityShader, CurrentDrawnEntity, data);
			data.Draw(spriteBatch);
		}
		else
		{
			data.Draw(spriteBatch);
		}
	}

	public static Microsoft.Xna.Framework.Color buffColor(Microsoft.Xna.Framework.Color newColor, float R, float G, float B, float A)
	{
		newColor.R = (byte)((float)(int)newColor.R * R);
		newColor.G = (byte)((float)(int)newColor.G * G);
		newColor.B = (byte)((float)(int)newColor.B * B);
		newColor.A = (byte)((float)(int)newColor.A * A);
		return newColor;
	}

	protected void CacheNPCDraws()
	{
		DrawCacheNPCsMoonMoon.Clear();
		DrawCacheNPCsOverPlayers.Clear();
		DrawCacheNPCProjectiles.Clear();
		DrawCacheNPCsBehindNonSolidTiles.Clear();
		for (int i = 0; i < maxNPCs; i++)
		{
			if (!npc[i].active)
			{
				continue;
			}
			if (npc[i].type == 398 && npc[i].ai[0] >= 0f)
			{
				int num = i;
				int num2 = -1;
				int num3 = -1;
				int num4 = -1;
				for (int j = 0; j < maxNPCs; j++)
				{
					if (npc[j].active && npc[j].ai[3] == (float)num)
					{
						if (num2 == -1 && npc[j].type == 397 && npc[j].ai[2] == 0f)
						{
							num2 = j;
						}
						if (num3 == -1 && npc[j].type == 397 && npc[j].ai[2] == 1f)
						{
							num3 = j;
						}
						if (num4 == -1 && npc[j].type == 396)
						{
							num4 = j;
						}
						if (num2 != -1 && num3 != -1 && num4 != -1)
						{
							break;
						}
					}
				}
				if (num2 != -1 && num3 != -1 && num4 != -1)
				{
					DrawCacheNPCsMoonMoon.Add(num);
					if (num2 != -1)
					{
						DrawCacheNPCsMoonMoon.Add(num2);
					}
					if (num3 != -1)
					{
						DrawCacheNPCsMoonMoon.Add(num3);
					}
					if (num4 != -1)
					{
						DrawCacheNPCsMoonMoon.Add(num4);
					}
				}
			}
			else if (npc[i].type == 421 && npc[i].ai[0] == 5f)
			{
				DrawCacheNPCsOverPlayers.Add(i);
			}
			else if (npc[i].type == 516 || npc[i].type == 519)
			{
				DrawCacheNPCProjectiles.Add(i);
			}
			else if (npc[i].type == 548)
			{
				DrawCacheNPCsBehindNonSolidTiles.Add(i);
			}
		}
	}

	protected void CacheProjDraws()
	{
		DrawCacheProjsBehindNPCsAndTiles.Clear();
		DrawCacheProjsBehindNPCs.Clear();
		DrawCacheProjsBehindProjectiles.Clear();
		DrawCacheProjsOverWiresUI.Clear();
		DrawCacheProjsOverPlayers.Clear();
		DrawCacheFirstFractals.Clear();
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile = Main.projectile[i];
			if (projectile.active)
			{
				switch (projectile.drawLayer)
				{
				case 1:
					DrawCacheProjsBehindNPCsAndTiles.Add(i);
					break;
				case 2:
					DrawCacheProjsBehindNPCs.Add(i);
					break;
				case 3:
					DrawCacheProjsBehindProjectiles.Add(i);
					break;
				case 4:
					DrawCacheProjsOverPlayers.Add(i);
					break;
				case 5:
					DrawCacheProjsOverWiresUI.Add(i);
					break;
				case 6:
					DrawCacheFirstFractals.Add(i);
					break;
				}
			}
		}
	}

	internal void DrawCachedNPCs(List<int> npcCache, bool behindTiles)
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		for (int i = 0; i < npcCache.Count; i++)
		{
			try
			{
				DrawNPC(npcCache[i], behindTiles);
			}
			catch
			{
				npc[npcCache[i]].active = false;
			}
		}
		TimeLogger.NPCs.AddTime(fromTimestamp);
	}

	internal void DrawCachedProjs(List<int> projCache, bool startSpriteBatch = true)
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		if (startSpriteBatch)
		{
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		}
		CurrentDrawnEntity = null;
		CurrentDrawnEntityShader = 0;
		for (int i = 0; i < projCache.Count; i++)
		{
			try
			{
				DrawProj(projCache[i]);
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				projectile[projCache[i]].active = false;
			}
		}
		CurrentDrawnEntity = null;
		CurrentDrawnEntityShader = 0;
		if (startSpriteBatch)
		{
			spriteBatch.End();
		}
		TimeLogger.Projectiles.AddTime(fromTimestamp);
	}

	internal void DrawSuperSpecialProjectiles(List<int> projCache, bool startSpriteBatch = true)
	{
		if (startSpriteBatch)
		{
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		}
		for (int i = 0; i < projCache.Count; i++)
		{
			try
			{
				int num = projCache[i];
				Projectile projectile = Main.projectile[num];
				int owner = projectile.owner;
				Player other = Main.player[owner];
				if (playerVisualClone[owner] == null)
				{
					playerVisualClone[owner] = new Player();
				}
				Player player = playerVisualClone[owner];
				player.CopyVisuals(other);
				player.isFirstFractalAfterImage = true;
				player.firstFractalAfterImageOpacity = projectile.Opacity * 1f;
				player.ResetEffects();
				player.ResetVisibleAccessories();
				player.UpdateDyes();
				player.DisplayDollUpdate();
				player.UpdateSocialShadow();
				player.itemAnimationMax = 60;
				player.itemAnimation = (int)projectile.localAI[0];
				player.itemRotation = projectile.velocity.ToRotation();
				player.heldProj = num;
				player.Center = projectile.Center - projectile.velocity.SafeNormalize(Vector2.Zero) * 42f;
				player.direction = ((projectile.velocity.X > 0f) ? 1 : (-1));
				player.itemRotation = (float)Math.Atan2(projectile.velocity.Y * (float)player.direction, projectile.velocity.X * (float)player.direction);
				player.velocity.Y = 0.01f;
				player.wingFrame = 2;
				player.PlayerFrame();
				player.socialIgnoreLight = true;
				PlayerRenderer.DrawPlayer(Camera, player, player.position, 0f, player.fullRotationOrigin);
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				Main.projectile[projCache[i]].active = false;
			}
		}
		if (startSpriteBatch)
		{
			spriteBatch.End();
		}
	}

	protected void SortDrawCacheWorms()
	{
		SortBabyBirdProjectiles(DrawCacheProjsOverPlayers);
		SortStardustDragonProjectiles(DrawCacheProjsBehindProjectiles);
	}

	private void SortBabyBirdProjectiles(List<int> list)
	{
		List<int> list2 = new List<int>();
		for (int num = list.Count - 1; num >= 0; num--)
		{
			int num2 = list[num];
			if (Main.projectile[num2].type == 759)
			{
				list2.Add(num2);
				list.RemoveAt(num);
				Projectile projectile = Main.projectile[num2];
				Player master = player[projectile.owner];
				int stackedIndex = (int)projectile.localAI[0];
				if (projectile.frame == projFrames[projectile.type] - 1)
				{
					projectile.Center = Projectile.AI_158_GetHomeLocation(master, stackedIndex);
					projectile.velocity = Vector2.Zero;
				}
			}
		}
		list.AddRange(list2);
		list2.Clear();
	}

	private void SortStardustDragonProjectiles(List<int> list)
	{
		List<List<int>> list2 = new List<List<int>>();
		for (int i = 0; i < list.Count; i++)
		{
			int num = list[i];
			if (Main.projectile[num].type == 628)
			{
				list.Remove(num);
				List<int> list3 = new List<int>();
				list3.Insert(0, num);
				int byUUID = Projectile.GetByUUID(Main.projectile[num].owner, Main.projectile[num].ai[0]);
				while (byUUID >= 0 && !list3.Contains(byUUID) && Main.projectile[byUUID].active && Main.projectile[byUUID].type >= 625 && Main.projectile[byUUID].type <= 627)
				{
					list3.Add(byUUID);
					list.Remove(byUUID);
					byUUID = Projectile.GetByUUID(Main.projectile[byUUID].owner, Main.projectile[byUUID].ai[0]);
				}
				List<int> list4 = new List<int>();
				for (int num2 = list3.Count - 2; num2 >= 0; num2--)
				{
					list4.Add(list3[num2]);
				}
				list4.Add(list3[list3.Count - 1]);
				list2.Add(list4);
				i = -1;
			}
		}
		List<int> list5 = new List<int>(list);
		list2.Add(list5);
		list.Clear();
		for (int j = 0; j < list2.Count; j++)
		{
			for (int k = 0; k < list2[j].Count; k++)
			{
				list.Add(list2[j][k]);
			}
		}
		for (int l = 0; l < list.Count; l++)
		{
			Projectile projectile = Main.projectile[list[l]];
			int byUUID2 = Projectile.GetByUUID(projectile.owner, projectile.ai[0]);
			if (projectile.type < 626 || projectile.type > 628 || byUUID2 < 0 || !ProjectileID.Sets.StardustDragon[Main.projectile[byUUID2].type])
			{
				continue;
			}
			Vector2 vector = Main.projectile[byUUID2].Center - projectile.Center;
			if (vector != Vector2.Zero)
			{
				float num3 = Main.projectile[byUUID2].scale * 16f;
				float num4 = vector.Length();
				float num5 = num3 - num4;
				if (num5 != 0f)
				{
					projectile.Center += Vector2.Normalize(vector) * (0f - num5);
				}
			}
		}
	}

	protected void DrawWoF()
	{
		if (wofNPCIndex < 0 || !npc[wofNPCIndex].active || npc[wofNPCIndex].life <= 0)
		{
			return;
		}
		for (int i = 0; i < 255; i++)
		{
			if (player[i].active && player[i].tongued && !player[i].dead)
			{
				DrawWOFTongueToPlayer(i);
			}
		}
		for (int j = 0; j < maxNPCs; j++)
		{
			if (npc[j].active && npc[j].aiStyle == 29)
			{
				DrawWOFRopeToTheHungry(j);
			}
		}
		DrawWOFBody();
	}

	private static void DrawWOFBody()
	{
		int num = TextureAssets.Wof.Height() / 3;
		float num2 = wofDrawAreaTop;
		float num3 = wofDrawAreaBottom;
		num3 = screenPosition.Y + (float)screenHeight;
		float num4 = (int)((num2 - screenPosition.Y) / (float)num) + 1;
		if (num4 > 12f)
		{
			return;
		}
		float num5 = num4 * (float)num;
		if (num5 > 0f)
		{
			num2 -= num5;
		}
		float num6 = npc[wofNPCIndex].position.X;
		if (npc[wofNPCIndex].direction > 0)
		{
			num6 -= 80f;
		}
		SpriteEffects effects = SpriteEffects.None;
		if (npc[wofNPCIndex].spriteDirection == 1)
		{
			effects = SpriteEffects.FlipHorizontally;
		}
		int num7 = wofDrawFrameIndex / 6 * num;
		if (!gamePaused && ++wofDrawFrameIndex >= 18)
		{
			wofDrawFrameIndex = 0;
		}
		float num8 = num3 - num2;
		for (int i = (int)num2; (float)i < num3; i += num)
		{
			num8 = num3 - (float)i;
			if (num8 > (float)num)
			{
				num8 = num;
			}
			for (int j = 0; (float)j < num8; j += 16)
			{
				int x = (int)(num6 + (float)(TextureAssets.Wof.Width() / 2)) / 16;
				int y = (i + j) / 16;
				spriteBatch.Draw(TextureAssets.Wof.Value, new Vector2(num6 - screenPosition.X, (float)(i + j) - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, num7 + j, TextureAssets.Wof.Width(), 16), Lighting.GetColor(x, y), 0f, default(Vector2), 1f, effects, 0f);
			}
		}
	}

	private static void DrawWOFRopeToTheHungry(int i)
	{
		float num = npc[wofNPCIndex].position.X + (float)(npc[wofNPCIndex].width / 2);
		float y = npc[wofNPCIndex].position.Y;
		float num2 = wofDrawAreaBottom - wofDrawAreaTop;
		bool flag = false;
		if (npc[i].frameCounter > 7.0)
		{
			flag = true;
		}
		y = (float)wofDrawAreaTop + num2 * npc[i].ai[0];
		float scale = npc[i].scale;
		float x = npc[i].Center.X;
		float y2 = npc[i].Bottom.Y - (float)npc[i].height * 0.5f * scale;
		Vector2 vector = new Vector2(x, y2);
		vector += npc[i].netOffset;
		float num3 = num - vector.X;
		float num4 = y - vector.Y;
		float rotation = (float)Math.Atan2(num4, num3) - 1.57f;
		bool flag2 = true;
		while (flag2)
		{
			SpriteEffects effects = SpriteEffects.None;
			if (flag)
			{
				effects = SpriteEffects.FlipHorizontally;
				flag = false;
			}
			else
			{
				flag = true;
			}
			int height = 28;
			int num5 = (int)(40f * scale);
			float num6 = (float)Math.Sqrt(num3 * num3 + num4 * num4);
			if (num6 < (float)num5)
			{
				height = (int)num6 - num5 + 28;
				flag2 = false;
			}
			num6 = 28f * scale / num6;
			num3 *= num6;
			num4 *= num6;
			vector.X += num3;
			vector.Y += num4;
			num3 = num - vector.X;
			num4 = y - vector.Y;
			Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)vector.X / 16, (int)(vector.Y / 16f));
			spriteBatch.Draw(TextureAssets.Chain12.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain4.Width(), height), color, rotation, new Vector2((float)TextureAssets.Chain4.Width() * 0.5f, (float)TextureAssets.Chain4.Height() * 0.5f), scale, effects, 0f);
		}
	}

	private static void DrawWOFTongueToPlayer(int i)
	{
		float num = npc[wofNPCIndex].position.X + (float)(npc[wofNPCIndex].width / 2);
		float num2 = npc[wofNPCIndex].position.Y + (float)(npc[wofNPCIndex].height / 2);
		Vector2 vector = new Vector2(player[i].position.X + (float)player[i].width * 0.5f, player[i].position.Y + (float)player[i].height * 0.5f);
		float num3 = num - vector.X;
		float num4 = num2 - vector.Y;
		float rotation = (float)Math.Atan2(num4, num3) - 1.57f;
		bool flag = true;
		while (flag)
		{
			float num5 = (float)Math.Sqrt(num3 * num3 + num4 * num4);
			if (num5 < 40f)
			{
				flag = false;
				continue;
			}
			num5 = (float)TextureAssets.Chain12.Height() / num5;
			num3 *= num5;
			num4 *= num5;
			vector.X += num3;
			vector.Y += num4;
			num3 = num - vector.X;
			num4 = num2 - vector.Y;
			Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)vector.X / 16, (int)(vector.Y / 16f));
			spriteBatch.Draw(TextureAssets.Chain12.Value, new Vector2(vector.X - screenPosition.X, vector.Y - screenPosition.Y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chain12.Width(), TextureAssets.Chain12.Height()), color, rotation, new Vector2((float)TextureAssets.Chain12.Width() * 0.5f, (float)TextureAssets.Chain12.Height() * 0.5f), 1f, SpriteEffects.None, 0f);
		}
	}

	public static Microsoft.Xna.Framework.Color quickAlpha(Microsoft.Xna.Framework.Color oldColor, float Alpha)
	{
		Microsoft.Xna.Framework.Color result = oldColor;
		result.R = (byte)((float)(int)result.R * Alpha);
		result.G = (byte)((float)(int)result.G * Alpha);
		result.B = (byte)((float)(int)result.B * Alpha);
		result.A = (byte)((float)(int)result.A * Alpha);
		return result;
	}

	public void DrawItem_GetBasics(Item item, int slot, out Texture2D texture, out Microsoft.Xna.Framework.Rectangle frame, out Microsoft.Xna.Framework.Rectangle glowmaskFrame)
	{
		LoadItem(item.type);
		if (ItemID.Sets.AnimatesAsSoul[item.type] || ItemID.Sets.NebulaPickup[item.type])
		{
			DrawItem_AnimateSlot(slot, itemAnimations[item.type].TicksPerFrame, itemAnimations[item.type].FrameCount);
			texture = TextureAssets.Item[item.type].Value;
		}
		else if (ItemID.Sets.IsFood[item.type])
		{
			texture = TextureAssets.Item[item.type].Value;
		}
		else
		{
			switch (item.type)
			{
			case 71:
			case 72:
			case 73:
			case 74:
			{
				int num = item.type - 71;
				texture = TextureAssets.Coin[num].Value;
				DrawItem_AnimateSlot(slot, 6, 8);
				frame = (glowmaskFrame = _coinOnWorldAnimation.GetFrame(texture, itemFrameCounter[slot]));
				return;
			}
			case 3858:
				texture = TextureAssets.Item[item.type].Value;
				DrawItem_AnimateSlot(slot, 5, 3);
				frame = texture.Frame();
				glowmaskFrame = TextureAssets.GlowMask[233].Value.Frame(1, 3, 0, itemFrameCounter[slot] / 5);
				glowmaskFrame.Height -= 2;
				return;
			case 75:
				texture = TextureAssets.Item[item.type].Value;
				DrawItem_AnimateSlot(slot, itemAnimations[item.type].TicksPerFrame, itemAnimations[item.type].FrameCount * 2 - 1);
				break;
			case 5644:
				texture = TextureAssets.Item[item.type].Value;
				itemFrameCounter[slot] = -1;
				break;
			default:
				texture = TextureAssets.Item[item.type].Value;
				break;
			}
		}
		if (itemAnimations[item.type] != null)
		{
			frame = (glowmaskFrame = itemAnimations[item.type].GetFrame(texture, itemFrameCounter[slot]));
		}
		else
		{
			frame = (glowmaskFrame = texture.Frame());
		}
	}

	private void DrawItem_AnimateSlot(int slot, int gameFramesPerSpriteFrame, int spriteFramesAmount)
	{
		if (++itemFrameCounter[slot] >= gameFramesPerSpriteFrame * spriteFramesAmount)
		{
			itemFrameCounter[slot] = 0;
		}
	}

	protected void DrawItem(WorldItem item, int whoami)
	{
		if (!item.active || item.IsAir)
		{
			return;
		}
		instance.LoadItem(item.type);
		DrawItem_GetBasics(item.inner, whoami, out var texture, out var frame, out var glowmaskFrame);
		Vector2 vector = frame.Size() / 2f;
		Vector2 vector2 = new Vector2((float)(item.width / 2) - vector.X, item.height - frame.Height);
		Vector2 vector3 = item.position - screenPosition + vector + vector2;
		float num = ((!item.onConveyor) ? (item.velocity.X * 0.2f) : 0f);
		if (item.shimmered)
		{
			num = 0f;
		}
		float scale = 1f;
		Microsoft.Xna.Framework.Color color = Lighting.GetColor(item.Center.ToTileCoordinates());
		Microsoft.Xna.Framework.Color currentColor = item.GetAlpha(color);
		if (item.shimmered)
		{
			currentColor.R = (byte)(255f * (1f - item.shimmerTime));
			currentColor.G = (byte)(255f * (1f - item.shimmerTime));
			currentColor.B = (byte)(255f * (1f - item.shimmerTime));
			currentColor.A = (byte)(255f * (1f - item.shimmerTime));
		}
		else if (item.shimmerTime > 0f)
		{
			currentColor.R = (byte)((float)(int)currentColor.R * (1f - item.shimmerTime));
			currentColor.G = (byte)((float)(int)currentColor.G * (1f - item.shimmerTime));
			currentColor.B = (byte)((float)(int)currentColor.B * (1f - item.shimmerTime));
			currentColor.A = (byte)((float)(int)currentColor.A * (1f - item.shimmerTime));
		}
		ItemSlot.GetItemLight(ref currentColor, ref scale, item.inner);
		int num2 = item.glowMask;
		if (!gamePaused && base.IsActive && (item.IsACoin || item.type == 58 || item.type == 109) && color.R > 60 && (float)rand.Next(500) - (Math.Abs(item.velocity.X) + Math.Abs(item.velocity.Y)) * 10f < (float)(color.R / 50))
		{
			int type = 43;
			Microsoft.Xna.Framework.Color newColor = Microsoft.Xna.Framework.Color.White;
			int alpha = 254;
			float scale2 = 0.5f;
			if (item.IsACoin)
			{
				newColor = default(Microsoft.Xna.Framework.Color);
				alpha = 0;
				scale2 = 1f;
			}
			switch (item.type)
			{
			case 71:
				type = 244;
				break;
			case 72:
				type = 245;
				break;
			case 73:
				type = 246;
				break;
			case 74:
				type = 247;
				break;
			}
			int num3 = Dust.NewDust(item.position, item.width, item.height, type, 0f, 0f, alpha, newColor, scale2);
			dust[num3].velocity *= 0f;
		}
		if (ItemID.Sets.BossBag[item.type])
		{
			float num4 = (float)item.timeSinceItemSpawned / 240f + GlobalTimeWrappedHourly * 0.04f;
			float globalTimeWrappedHourly = GlobalTimeWrappedHourly;
			globalTimeWrappedHourly %= 4f;
			globalTimeWrappedHourly /= 2f;
			if (globalTimeWrappedHourly >= 1f)
			{
				globalTimeWrappedHourly = 2f - globalTimeWrappedHourly;
			}
			globalTimeWrappedHourly = globalTimeWrappedHourly * 0.5f + 0.5f;
			for (float num5 = 0f; num5 < 1f; num5 += 0.25f)
			{
				spriteBatch.Draw(texture, vector3 + new Vector2(0f, 8f).RotatedBy((num5 + num4) * ((float)Math.PI * 2f)) * globalTimeWrappedHourly, frame, new Microsoft.Xna.Framework.Color(90, 70, 255, 50), num, vector, scale, SpriteEffects.None, 0f);
			}
			for (float num6 = 0f; num6 < 1f; num6 += 0.34f)
			{
				spriteBatch.Draw(texture, vector3 + new Vector2(0f, 4f).RotatedBy((num6 + num4) * ((float)Math.PI * 2f)) * globalTimeWrappedHourly, frame, new Microsoft.Xna.Framework.Color(140, 120, 255, 77), num, vector, scale, SpriteEffects.None, 0f);
			}
		}
		else if (item.type == 75)
		{
			float num7 = (float)item.timeSinceItemSpawned / 240f + GlobalTimeWrappedHourly * 0.04f;
			float globalTimeWrappedHourly2 = GlobalTimeWrappedHourly;
			globalTimeWrappedHourly2 %= 5f;
			globalTimeWrappedHourly2 /= 2.5f;
			if (globalTimeWrappedHourly2 >= 1f)
			{
				globalTimeWrappedHourly2 = 2f - globalTimeWrappedHourly2;
			}
			globalTimeWrappedHourly2 = globalTimeWrappedHourly2 * 0.5f + 0.5f;
			for (float num8 = 0f; num8 < 1f; num8 += 0.25f)
			{
				spriteBatch.Draw(TextureAssets.Item[item.type].Value, vector3 + new Vector2(0f, 8f).RotatedBy((num8 + num7) * ((float)Math.PI * 2f)) * globalTimeWrappedHourly2, frame, new Microsoft.Xna.Framework.Color(50, 50, 255, 50), num, vector, scale, SpriteEffects.None, 0f);
			}
			for (float num9 = 0f; num9 < 1f; num9 += 0.34f)
			{
				spriteBatch.Draw(TextureAssets.Item[item.type].Value, vector3 + new Vector2(0f, 4f).RotatedBy((num9 + num7) * ((float)Math.PI * 2f)) * globalTimeWrappedHourly2, frame, new Microsoft.Xna.Framework.Color(120, 120, 255, 127), num, vector, scale, SpriteEffects.None, 0f);
			}
		}
		else if (item.type == 4143)
		{
			float num10 = (float)item.timeSinceItemSpawned / 240f + GlobalTimeWrappedHourly * 0.04f;
			float globalTimeWrappedHourly3 = GlobalTimeWrappedHourly;
			globalTimeWrappedHourly3 %= 5f;
			globalTimeWrappedHourly3 /= 2.5f;
			if (globalTimeWrappedHourly3 >= 1f)
			{
				globalTimeWrappedHourly3 = 2f - globalTimeWrappedHourly3;
			}
			globalTimeWrappedHourly3 = globalTimeWrappedHourly3 * 0.5f + 0.5f;
			for (float num11 = 0f; num11 < 1f; num11 += 0.34f)
			{
				spriteBatch.Draw(TextureAssets.Item[item.type].Value, vector3 + new Vector2(0f, 8f).RotatedBy((num11 + num10) * ((float)Math.PI * 2f)) * globalTimeWrappedHourly3, frame, new Microsoft.Xna.Framework.Color(30, 30, 155, 60), num, vector, scale, SpriteEffects.None, 0f);
			}
			for (float num12 = 0f; num12 < 1f; num12 += 0.34f)
			{
				spriteBatch.Draw(TextureAssets.Item[item.type].Value, vector3 + new Vector2(0f, 4f).RotatedBy((num12 + num10) * ((float)Math.PI * 2f)) * globalTimeWrappedHourly3, frame, new Microsoft.Xna.Framework.Color(60, 60, 127, 57), num, vector, scale, SpriteEffects.None, 0f);
			}
			spriteBatch.Draw(texture, vector3, frame, new Microsoft.Xna.Framework.Color(255, 255, 255, 128), num, vector, scale, SpriteEffects.None, 0f);
		}
		if ((item.type >= 1522 && item.type <= 1527) || item.type == 3643)
		{
			currentColor = ((!(item.shimmerTime > 0f)) ? new Microsoft.Xna.Framework.Color(250, 250, 250, mouseTextColor / 2) : new Microsoft.Xna.Framework.Color((int)(250f * (1f - item.shimmerTime)), (int)(250f * (1f - item.shimmerTime)), (int)(250f * (1f - item.shimmerTime)), (int)((float)(mouseTextColor / 2) * (1f - item.shimmerTime))));
			scale = (float)(int)mouseTextColor / 1000f + 0.8f;
		}
		if (item.type == 3779)
		{
			num2 = -1;
		}
		spriteBatch.Draw(texture, vector3, frame, currentColor, num, vector, scale, SpriteEffects.None, 0f);
		if (item.shimmered)
		{
			spriteBatch.Draw(texture, vector3, frame, new Microsoft.Xna.Framework.Color(currentColor.R, currentColor.G, currentColor.B, 0), num, vector, scale, SpriteEffects.None, 0f);
		}
		if (item.color != Microsoft.Xna.Framework.Color.Transparent)
		{
			spriteBatch.Draw(texture, vector3, frame, item.GetColor(color), num, vector, scale, SpriteEffects.None, 0f);
		}
		if (num2 != -1 && item.type != 46 && item.type != 5462)
		{
			Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.White;
			switch (item.type)
			{
			case 5670:
			case 5671:
				color2 = Item.GetPhaseColor(item.shoot);
				break;
			case 5146:
				color2 = new Microsoft.Xna.Framework.Color(DiscoR, DiscoG, DiscoB);
				break;
			case 5462:
				color2 = new Microsoft.Xna.Framework.Color(255, 140, 0, 5);
				break;
			case 5669:
			{
				float amount = Utils.WrappedLerp(0.5f, 1f, (float)(LocalPlayer.miscCounter % 100) / 100f);
				color2 = Microsoft.Xna.Framework.Color.Lerp(color2, new Microsoft.Xna.Framework.Color(180, 85, 30), amount);
				color2.A = (byte)item.alpha;
				break;
			}
			case 3858:
				color2 = new Microsoft.Xna.Framework.Color(255, 255, 255, 63) * 0.75f;
				break;
			}
			if (item.type == 5670 || item.type == 5671)
			{
				spriteBatch.Draw(TextureAssets.GlowMask[num2].Value, vector3, glowmaskFrame, color2, num, glowmaskFrame.Size() / 2f, scale, SpriteEffects.None, 0f);
				color2 = Item.GetPhaseColor(item.shoot, drawColor: true);
			}
			spriteBatch.Draw(TextureAssets.GlowMask[num2].Value, vector3, glowmaskFrame, color2, num, glowmaskFrame.Size() / 2f, scale, SpriteEffects.None, 0f);
		}
		if (ItemID.Sets.TrapSigned[item.type])
		{
			spriteBatch.Draw(TextureAssets.Wire.Value, vector3 + frame.Size().RotatedBy(num - (float)Math.PI / 2f) * 0.45f * item.scale, new Microsoft.Xna.Framework.Rectangle(4, 58, 8, 8), currentColor, 0f, new Vector2(4f), 1f, SpriteEffects.None, 0f);
		}
		if (ItemID.Sets.DrawUnsafeIndicator[item.type])
		{
			Vector2 spinningpoint = frame.Size() * 0.45f + new Vector2(-4f, -4f);
			Texture2D value = TextureAssets.Extra[258].Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value.Frame();
			spriteBatch.Draw(value, vector3 + spinningpoint.RotatedBy(num - (float)Math.PI / 2f) * item.scale, rectangle, currentColor, num, rectangle.Size() / 2f, 1f, SpriteEffects.None, 0f);
		}
	}

	public void DrawItems()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		for (int i = 0; i < 400; i++)
		{
			DrawItem(item[i], i);
		}
		TimeLogger.Items.AddTime(fromTimestamp);
	}

	protected void DrawRain()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		bool flag = base.IsActive || netMode == 1 || DebugOptions.noPause;
		Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(0, 0, 2, 40);
		Texture2D value2 = TextureAssets.Rain.Value;
		Vector2 zero = Vector2.Zero;
		for (int i = 0; i < maxRain; i++)
		{
			Rain rain = Main.rain[i];
			if (rain.active)
			{
				value.X = rain.type * 4;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)(rain.position.X + 4f) >> 4, (int)(rain.position.Y + 4f) >> 4) * 0.85f;
				if (shimmerAlpha > 0f)
				{
					color *= 1f - shimmerAlpha;
				}
				spriteBatch.Draw(value2, rain.position - screenPosition, value, color, rain.rotation, zero, rain.scale, SpriteEffects.None, 0f);
				if (flag)
				{
					rain.Update();
				}
			}
		}
		TimeLogger.Rain.AddTime(fromTimestamp);
	}

	internal void DrawDust()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X - 500, (int)screenPosition.Y - 50, screenWidth + 1000, screenHeight + 100);
		rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X - 1000, (int)screenPosition.Y - 1050, screenWidth + 2000, screenHeight + 2100);
		Microsoft.Xna.Framework.Rectangle rectangle2 = rectangle;
		ArmorShaderData armorShaderData = null;
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullNone, null, Transform);
		for (int i = 0; i < maxDustToDraw; i++)
		{
			Dust dust = Main.dust[i];
			if (!dust.active)
			{
				continue;
			}
			if ((dust.type >= 130 && dust.type <= 134) || (dust.type >= 219 && dust.type <= 223) || dust.type == 226 || dust.type == 278)
			{
				rectangle = rectangle2;
			}
			if (new Microsoft.Xna.Framework.Rectangle((int)dust.position.X, (int)dust.position.Y, 4, 4).Intersects(rectangle))
			{
				float scale = dust.GetVisualScale();
				if (dust.shader != armorShaderData)
				{
					spriteBatch.End();
					armorShaderData = dust.shader;
					if (armorShaderData == null)
					{
						spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullNone, null, Transform);
					}
					else
					{
						spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullNone, null, Transform);
						dust.shader.Apply(null);
					}
				}
				if (dust.type >= 130 && dust.type <= 134)
				{
					float num = Math.Abs(dust.velocity.X) + Math.Abs(dust.velocity.Y);
					num *= 0.3f;
					num *= 10f;
					if (num > 10f)
					{
						num = 10f;
					}
					for (int j = 0; (float)j < num; j++)
					{
						Vector2 velocity = dust.velocity;
						Vector2 vector = dust.position - velocity * j;
						float scale2 = dust.scale * (1f - (float)j / 10f);
						Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)((double)dust.position.X + 4.0) / 16, (int)((double)dust.position.Y + 4.0) / 16);
						color = dust.GetAlpha(color);
						spriteBatch.Draw(TextureAssets.Dust.Value, vector - screenPosition, dust.frame, color, dust.rotation, new Vector2(4f, 4f), scale2, SpriteEffects.None, 0f);
					}
				}
				else if (dust.type == 278)
				{
					float num2 = Math.Abs(dust.velocity.X) + Math.Abs(dust.velocity.Y);
					num2 *= 0.3f;
					num2 *= 10f;
					if (num2 > 10f)
					{
						num2 = 10f;
					}
					Vector2 origin = new Vector2(4f, 4f);
					for (int k = 0; (float)k < num2; k++)
					{
						Vector2 velocity2 = dust.velocity;
						Vector2 vector2 = dust.position - velocity2 * k;
						float scale3 = dust.scale * (1f - (float)k / 10f);
						Microsoft.Xna.Framework.Color color2 = Lighting.GetColor((int)(dust.position.X + 4f) / 16, (int)(dust.position.Y + 4f) / 16);
						color2 = dust.GetAlpha(color2);
						spriteBatch.Draw(TextureAssets.Dust.Value, vector2 - screenPosition, dust.frame, color2, dust.rotation, origin, scale3, SpriteEffects.None, 0f);
					}
				}
				else if (dust.type >= 219 && dust.type <= 223 && dust.fadeIn == 0f)
				{
					float num3 = Math.Abs(dust.velocity.X) + Math.Abs(dust.velocity.Y);
					num3 *= 0.3f;
					num3 *= 10f;
					if (num3 > 10f)
					{
						num3 = 10f;
					}
					for (int l = 0; (float)l < num3; l++)
					{
						Vector2 velocity3 = dust.velocity;
						Vector2 vector3 = dust.position - velocity3 * l;
						float scale4 = dust.scale * (1f - (float)l / 10f);
						Microsoft.Xna.Framework.Color color3 = Lighting.GetColor((int)((double)dust.position.X + 4.0) / 16, (int)((double)dust.position.Y + 4.0) / 16);
						color3 = dust.GetAlpha(color3);
						spriteBatch.Draw(TextureAssets.Dust.Value, vector3 - screenPosition, dust.frame, color3, dust.rotation, new Vector2(4f, 4f), scale4, SpriteEffects.None, 0f);
					}
				}
				else if (dust.type == 264 && dust.fadeIn == 0f)
				{
					float num4 = Math.Abs(dust.velocity.X) + Math.Abs(dust.velocity.Y);
					num4 *= 10f;
					if (num4 > 10f)
					{
						num4 = 10f;
					}
					for (int m = 0; (float)m < num4; m++)
					{
						Vector2 velocity4 = dust.velocity;
						Vector2 vector4 = dust.position - velocity4 * m;
						float scale5 = dust.scale * (1f - (float)m / 10f);
						Microsoft.Xna.Framework.Color color4 = Lighting.GetColor((int)((double)dust.position.X + 4.0) / 16, (int)((double)dust.position.Y + 4.0) / 16);
						color4 = dust.GetAlpha(color4) * 0.3f;
						spriteBatch.Draw(TextureAssets.Dust.Value, vector4 - screenPosition, dust.frame, color4, dust.rotation, new Vector2(5f), scale5, SpriteEffects.None, 0f);
						color4 = dust.GetColor(color4);
						spriteBatch.Draw(TextureAssets.Dust.Value, vector4 - screenPosition, dust.frame, color4, dust.rotation, new Vector2(5f), scale5, SpriteEffects.None, 0f);
					}
				}
				else if ((dust.type == 226 || dust.type == 272) && dust.fadeIn == 0f)
				{
					float num5 = Math.Abs(dust.velocity.X) + Math.Abs(dust.velocity.Y);
					num5 *= 0.3f;
					num5 *= 10f;
					if (num5 > 10f)
					{
						num5 = 10f;
					}
					for (int n = 0; (float)n < num5; n++)
					{
						Vector2 velocity5 = dust.velocity;
						Vector2 vector5 = dust.position - velocity5 * n;
						float scale6 = dust.scale * (1f - (float)n / 10f);
						Microsoft.Xna.Framework.Color color5 = Lighting.GetColor((int)((double)dust.position.X + 4.0) / 16, (int)((double)dust.position.Y + 4.0) / 16);
						color5 = dust.GetAlpha(color5);
						if (dust.customData != null && dust.customData is Microsoft.Xna.Framework.Color)
						{
							_ = (Microsoft.Xna.Framework.Color)dust.customData;
							color5 = dust.GetColor(color5);
						}
						spriteBatch.Draw(TextureAssets.Dust.Value, vector5 - screenPosition, dust.frame, color5, dust.rotation, new Vector2(4f, 4f), scale6, SpriteEffects.None, 0f);
					}
				}
				Microsoft.Xna.Framework.Color newColor = Lighting.GetColor((int)((double)dust.position.X + 4.0) / 16, (int)((double)dust.position.Y + 4.0) / 16);
				if (dust.type == 6 || dust.type == 15 || (dust.type >= 59 && dust.type <= 64))
				{
					newColor = Microsoft.Xna.Framework.Color.White;
				}
				newColor = dust.GetAlpha(newColor);
				if (dust.type == 213)
				{
					scale = 1f;
				}
				spriteBatch.Draw(TextureAssets.Dust.Value, dust.position - screenPosition, dust.frame, newColor, dust.GetVisualRotation(), new Vector2(4f, 4f), scale, SpriteEffects.None, 0f);
				if (dust.color.PackedValue != 0)
				{
					Microsoft.Xna.Framework.Color color6 = dust.GetColor(newColor);
					if (color6.PackedValue != 0)
					{
						spriteBatch.Draw(TextureAssets.Dust.Value, dust.position - screenPosition, dust.frame, color6, dust.GetVisualRotation(), new Vector2(4f, 4f), scale, SpriteEffects.None, 0f);
					}
				}
				if (newColor == Microsoft.Xna.Framework.Color.Black)
				{
					dust.active = false;
				}
			}
			else
			{
				dust.active = false;
			}
		}
		spriteBatch.End();
		pixelShader.CurrentTechnique.Passes[0].Apply();
		TimeLogger.Dust.AddTime(fromTimestamp);
	}

	public static void HelpText()
	{
		bool flag = false;
		if (player[myPlayer].statLifeMax > 100)
		{
			flag = true;
		}
		bool flag2 = false;
		if (player[myPlayer].statManaMax > 20)
		{
			flag2 = true;
		}
		bool flag3 = LocalPlayer.difficulty == 3;
		short num = (short)(flag3 ? 1 : 3509);
		short num2 = (short)(flag3 ? 10 : 3506);
		bool flag4 = true;
		bool flag5 = false;
		bool flag6 = false;
		bool flag7 = false;
		bool flag8 = false;
		bool flag9 = false;
		bool flag10 = !LocalPlayer.miscEquips[4].IsAir;
		bool flag11 = false;
		bool flag12 = false;
		bool flag13 = false;
		bool flag14 = false;
		for (int i = 0; i < 58; i++)
		{
			Item item = LocalPlayer.inventory[i];
			if (!item.IsAir)
			{
				if (item.pick > 0 && item.type != num)
				{
					flag4 = false;
				}
				if (item.axe > 0 && item.type != num2)
				{
					flag4 = false;
				}
				if (item.hammer > 0 && (!flag3 || item.type != 7))
				{
					flag4 = false;
				}
				if (item.type == 11 || item.type == 12 || item.type == 13 || item.type == 14 || item.type == 699 || item.type == 700 || item.type == 701 || item.type == 702)
				{
					flag5 = true;
				}
				if (item.type == 19 || item.type == 20 || item.type == 21 || item.type == 22 || item.type == 703 || item.type == 704 || item.type == 705 || item.type == 706)
				{
					flag6 = true;
				}
				if (item.type == 75)
				{
					flag7 = true;
				}
				if (item.type == 38)
				{
					flag8 = true;
				}
				if (item.type == 68 || item.type == 70 || item.type == 1330 || item.type == 1331 || item.type == 67 || item.type == 2886)
				{
					flag9 = true;
				}
				if (!flag10 && item.shoot > 0 && projHook[item.shoot])
				{
					flag10 = true;
				}
				if (item.type == 3347)
				{
					flag11 = true;
				}
				if (item.type == 174)
				{
					flag12 = true;
				}
				if (item.type == 1141)
				{
					flag13 = true;
				}
				if (item.type == 1533 || item.type == 1534 || item.type == 1535 || item.type == 1536 || item.type == 1537 || item.type == 4714)
				{
					flag14 = true;
				}
			}
		}
		bool flag15 = false;
		bool flag16 = false;
		bool flag17 = false;
		bool flag18 = false;
		bool flag19 = false;
		bool flag20 = false;
		bool flag21 = false;
		bool flag22 = false;
		bool flag23 = false;
		bool flag24 = false;
		bool flag25 = false;
		bool flag26 = false;
		bool flag27 = false;
		bool flag28 = false;
		bool flag29 = false;
		bool flag30 = false;
		bool flag31 = false;
		bool flag32 = false;
		bool flag33 = false;
		bool flag34 = false;
		bool flag35 = false;
		bool flag36 = false;
		bool flag37 = false;
		bool flag38 = false;
		bool flag39 = false;
		int num3 = 0;
		for (int j = 0; j < maxNPCs; j++)
		{
			if (npc[j].active)
			{
				if (npc[j].townNPC && npc[j].type != 37)
				{
					num3++;
				}
				if (npc[j].type == 17)
				{
					flag15 = true;
				}
				if (npc[j].type == 18)
				{
					flag16 = true;
				}
				if (npc[j].type == 19)
				{
					flag18 = true;
				}
				if (npc[j].type == 20)
				{
					flag17 = true;
				}
				if (npc[j].type == 54)
				{
					flag23 = true;
				}
				if (npc[j].type == 124)
				{
					flag20 = true;
				}
				if (npc[j].type == 38)
				{
					flag19 = true;
				}
				if (npc[j].type == 108)
				{
					flag21 = true;
				}
				if (npc[j].type == 107)
				{
					flag22 = true;
				}
				if (npc[j].type == 228)
				{
					flag24 = true;
				}
				if (npc[j].type == 178)
				{
					flag25 = true;
				}
				if (npc[j].type == 209)
				{
					flag26 = true;
				}
				if (npc[j].type == 353)
				{
					flag27 = true;
				}
				if (npc[j].type == 633)
				{
					flag39 = true;
				}
				if (npc[j].type == 369)
				{
					flag28 = true;
				}
				if (npc[j].type == 441)
				{
					flag29 = true;
				}
				if (npc[j].type == 229)
				{
					flag30 = true;
				}
				if (npc[j].type == 207)
				{
					flag31 = true;
				}
				if (npc[j].type == 160)
				{
					flag32 = true;
				}
				if (npc[j].type == 588)
				{
					flag33 = true;
				}
				if (npc[j].type == 227)
				{
					flag34 = true;
				}
				if (npc[j].type == 208)
				{
					flag35 = true;
				}
				if (npc[j].type == 550)
				{
					flag36 = true;
				}
				if (npc[j].type == 368)
				{
					flag37 = true;
				}
				if (npc[j].type == 453)
				{
					flag38 = true;
				}
			}
		}
		while (true)
		{
			helpText++;
			if (Language.Exists("GuideHelpText.Help_" + helpText) && Language.GetText("GuideHelpText.Help_" + helpText).GetValueIfConditionsMet(out npcChatText))
			{
				return;
			}
			if (flag4)
			{
				if (helpText == 1)
				{
					npcChatText = Lang.dialog(177);
					return;
				}
				if (helpText == 2)
				{
					npcChatText = Lang.dialog(178);
					return;
				}
				if (helpText == 3)
				{
					npcChatText = Lang.dialog(179);
					return;
				}
				if (helpText == 4)
				{
					npcChatText = Lang.dialog(180);
					return;
				}
				if (helpText == 5)
				{
					npcChatText = Lang.dialog(181);
					return;
				}
				if (helpText == 6)
				{
					npcChatText = Lang.dialog(182);
					return;
				}
			}
			if (flag4 && !flag5 && !flag6 && helpText == 11)
			{
				npcChatText = Lang.dialog(183);
				return;
			}
			if (flag4 && flag5 && !flag6)
			{
				if (helpText == 21)
				{
					npcChatText = Lang.dialog(184);
					return;
				}
				if (helpText == 22)
				{
					npcChatText = Lang.dialog(185);
					return;
				}
			}
			if (flag4 && flag6)
			{
				if (helpText == 31)
				{
					npcChatText = Lang.dialog(186);
					return;
				}
				if (helpText == 32)
				{
					npcChatText = Lang.dialog(187);
					return;
				}
			}
			if (!flag && helpText == 41)
			{
				npcChatText = Lang.dialog(188);
				return;
			}
			if (!flag2 && helpText == 42)
			{
				npcChatText = Lang.dialog(189);
				return;
			}
			if (!flag2 && !flag7 && helpText == 43)
			{
				npcChatText = Lang.dialog(190);
				return;
			}
			if (!flag15 && !flag16)
			{
				if (helpText == 51)
				{
					npcChatText = Lang.dialog(191);
					return;
				}
				if (helpText == 52)
				{
					npcChatText = Lang.dialog(192);
					return;
				}
				if (helpText == 53)
				{
					npcChatText = Lang.dialog(193);
					return;
				}
				if (helpText == 54)
				{
					npcChatText = Lang.dialog(194);
					return;
				}
				if (helpText == 55)
				{
					npcChatText = Language.GetTextValue("GuideHelpText.Help_1065");
					return;
				}
			}
			if (!flag15 && helpText == 61)
			{
				npcChatText = Lang.dialog(195);
				return;
			}
			if (!flag16 && helpText == 62)
			{
				npcChatText = Lang.dialog(196);
				return;
			}
			if (!flag18 && helpText == 63)
			{
				npcChatText = Lang.dialog(197);
				return;
			}
			if (!flag17 && helpText == 64)
			{
				npcChatText = Lang.dialog(198);
				return;
			}
			if (!flag20 && helpText == 65 && NPC.downedBoss3)
			{
				npcChatText = Lang.dialog(199);
				return;
			}
			if (!flag23 && helpText == 66 && NPC.downedBoss3)
			{
				npcChatText = Lang.dialog(200);
				return;
			}
			if (!flag19 && helpText == 67)
			{
				npcChatText = Lang.dialog(201);
				return;
			}
			if (!flag22 && NPC.downedBoss2 && helpText == 68)
			{
				npcChatText = Lang.dialog(202);
				return;
			}
			if (!flag21 && hardMode && helpText == 69)
			{
				npcChatText = Lang.dialog(203);
				return;
			}
			if (!flag24 && helpText == 70 && NPC.downedBoss2)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1100");
				return;
			}
			if (!flag25 && helpText == 71 && hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1101");
				return;
			}
			if (!flag26 && helpText == 72 && NPC.downedMechBoss1 && NPC.downedMechBoss2 && NPC.downedMechBoss3)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1102");
				return;
			}
			if (!flag27 && helpText == 73)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1103");
				return;
			}
			if (!flag28 && helpText == 74)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1104");
				return;
			}
			if (!flag29 && helpText == 75 && hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1105");
				return;
			}
			if (!flag30 && helpText == 76 && hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1106");
				return;
			}
			if (!flag31 && helpText == 77)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1107");
				return;
			}
			if (!flag32 && helpText == 78 && hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1108");
				return;
			}
			if (!flag33 && helpText == 79)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1109");
				return;
			}
			if (!flag34 && helpText == 80 && num3 >= 5)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1110");
				return;
			}
			if (!flag35 && helpText == 81 && num3 >= 17)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1111");
				return;
			}
			if (!flag36 && NPC.downedBoss2 && helpText == 82)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1112");
				return;
			}
			if (!flag37 && helpText == 83 && flag15)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1113");
				return;
			}
			if (!flag38 && helpText == 84 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1114");
				return;
			}
			if (!flag39 && helpText == 85 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1115");
				return;
			}
			if (flag8 && !WorldGen.crimson && helpText == 100)
			{
				npcChatText = Lang.dialog(204);
				return;
			}
			if (flag9 && helpText == 101)
			{
				npcChatText = Lang.dialog(WorldGen.crimson ? 403 : 205);
				return;
			}
			if ((flag8 || flag9) && helpText == 102)
			{
				npcChatText = Lang.dialog(WorldGen.crimson ? 402 : 206);
				return;
			}
			if (flag8 && WorldGen.crimson && helpText == 103)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1159");
				return;
			}
			if (!flag10 && helpText == 201 && !hardMode && !NPC.downedBoss3 && !NPC.downedBoss2)
			{
				npcChatText = Lang.dialog(207);
				return;
			}
			if (helpText == 202 && !hardMode && player[myPlayer].statLifeMax >= 140)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1120");
				return;
			}
			if (helpText == 203 && hardMode && NPC.downedMechBossAny)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1121");
				return;
			}
			if (helpText == 204 && !NPC.downedGoblins && player[myPlayer].statLifeMax >= 200 && WorldGen.shadowOrbSmashed)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1122");
				return;
			}
			if (helpText == 205 && hardMode && !NPC.downedPirates && player[myPlayer].statLifeMax >= 200)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1123");
				return;
			}
			if (helpText == 206 && hardMode && NPC.downedGolemBoss && !NPC.downedMartians)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1124");
				return;
			}
			if (helpText == 207 && (NPC.downedBoss1 || NPC.downedBoss2 || NPC.downedBoss3))
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1125");
				return;
			}
			if (helpText == 208 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1130");
				return;
			}
			if (helpText == 209 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1131");
				return;
			}
			if (helpText == 210 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1132");
				return;
			}
			if (helpText == 211 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1133");
				return;
			}
			if (helpText == 212 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1134");
				return;
			}
			if (helpText == 213 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1135");
				return;
			}
			if (helpText == 214 && !hardMode && (flag5 || flag6))
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1136");
				return;
			}
			if (helpText == 215 && LocalPlayer.anglerQuestsFinished < 1)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1137");
				return;
			}
			if (helpText == 216 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1138");
				return;
			}
			if (helpText == 1000 && !NPC.downedBoss1 && !NPC.downedBoss2)
			{
				npcChatText = Lang.dialog(208);
				return;
			}
			if (helpText == 1001 && !NPC.downedBoss1 && !NPC.downedBoss2)
			{
				npcChatText = Lang.dialog(209);
				return;
			}
			if (helpText == 1002 && !NPC.downedBoss2)
			{
				if (WorldGen.crimson)
				{
					npcChatText = Lang.dialog(331);
				}
				else
				{
					npcChatText = Lang.dialog(210);
				}
				return;
			}
			if (helpText == 1050 && !NPC.downedBoss1 && player[myPlayer].statLifeMax < 200)
			{
				npcChatText = Lang.dialog(211);
				return;
			}
			if (helpText == 1051 && !NPC.downedBoss1 && player[myPlayer].statDefense <= 10)
			{
				npcChatText = Lang.dialog(212);
				return;
			}
			if (helpText == 1052 && !NPC.downedBoss1 && player[myPlayer].statLifeMax >= 200 && player[myPlayer].statDefense > 10)
			{
				npcChatText = Lang.dialog(WorldGen.crimson ? 404 : 213);
				return;
			}
			if (helpText == 1053 && NPC.downedBoss1 && !NPC.downedBoss2 && player[myPlayer].statLifeMax < 300)
			{
				npcChatText = Lang.dialog(214);
				return;
			}
			if (helpText == 1054 && NPC.downedBoss1 && !NPC.downedBoss2 && !WorldGen.crimson && player[myPlayer].statLifeMax >= 300)
			{
				npcChatText = Lang.dialog(215);
				return;
			}
			if (helpText == 1055 && NPC.downedBoss1 && !NPC.downedBoss2 && !WorldGen.crimson && player[myPlayer].statLifeMax >= 300)
			{
				npcChatText = Lang.dialog(216);
				return;
			}
			if (helpText == 1056 && NPC.downedBoss1 && NPC.downedBoss2 && !NPC.downedBoss3)
			{
				npcChatText = Lang.dialog(217);
				return;
			}
			if (helpText == 1057 && NPC.downedBoss1 && NPC.downedBoss2 && NPC.downedBoss3 && !hardMode && player[myPlayer].statLifeMax < 400)
			{
				npcChatText = Lang.dialog(218);
				return;
			}
			if (helpText == 1058 && NPC.downedBoss1 && NPC.downedBoss2 && NPC.downedBoss3 && !hardMode && player[myPlayer].statLifeMax >= 400)
			{
				npcChatText = Lang.dialog(219);
				return;
			}
			if (helpText == 1059 && NPC.downedBoss1 && NPC.downedBoss2 && NPC.downedBoss3 && !hardMode && player[myPlayer].statLifeMax >= 400)
			{
				npcChatText = Lang.dialog(220);
				return;
			}
			if (helpText == 1060 && NPC.downedBoss1 && NPC.downedBoss2 && NPC.downedBoss3 && !hardMode && player[myPlayer].statLifeMax >= 400)
			{
				npcChatText = Lang.dialog(221);
				return;
			}
			if (helpText == 1061 && hardMode && !NPC.downedPlantBoss)
			{
				npcChatText = Lang.dialog(WorldGen.crimson ? 401 : 222);
				return;
			}
			if (helpText == 1062 && hardMode && !NPC.downedPlantBoss)
			{
				npcChatText = Lang.dialog(223);
				return;
			}
			if (helpText == 1140 && NPC.downedBoss1 && !NPC.downedBoss2 && WorldGen.crimson && player[myPlayer].statLifeMax >= 300)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1140");
				return;
			}
			if (helpText == 1141 && NPC.downedBoss1 && !NPC.downedBoss2 && WorldGen.crimson && player[myPlayer].statLifeMax >= 300)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1141");
				return;
			}
			if (helpText == 1142 && NPC.downedBoss2 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1142");
				return;
			}
			if (helpText == 1143 && NPC.downedBoss2 && !NPC.downedQueenBee && player[myPlayer].statLifeMax >= 300)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1143");
				return;
			}
			if (helpText == 1144 && flag11)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1144");
				return;
			}
			if (helpText == 1145 && flag12 && !hardMode)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1145");
				return;
			}
			if (helpText == 1146 && hardMode && player[myPlayer].wingsLogic == 0 && !LocalPlayer.mount.Active && !NPC.downedPlantBoss)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1146");
				return;
			}
			if (helpText == 1147 && hardMode && WorldGen.SavedOreTiers.Adamantite == 111 && !NPC.downedMechBossAny)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1147");
				return;
			}
			if (helpText == 1148 && hardMode && WorldGen.SavedOreTiers.Adamantite == 223 && !NPC.downedMechBossAny)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1148");
				return;
			}
			if (helpText == 1149 && hardMode && NPC.downedMechBossAny && player[myPlayer].statLifeMax < 500)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1149");
				return;
			}
			if (helpText == 1150 && hardMode && NPC.downedMechBoss1 && NPC.downedMechBoss2 && NPC.downedMechBoss3 && !NPC.downedPlantBoss)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1150");
				return;
			}
			if (helpText == 1151 && hardMode && NPC.downedPlantBoss && !NPC.downedGolemBoss && flag13)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1151");
				return;
			}
			if (helpText == 1152 && hardMode && NPC.downedPlantBoss && !NPC.downedGolemBoss && !flag13)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1152");
				return;
			}
			if (helpText == 1153 && hardMode && flag14)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1153");
				return;
			}
			if (helpText == 1154 && hardMode && !NPC.downedFishron)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1154");
				return;
			}
			if (helpText == 1155 && hardMode && NPC.downedGolemBoss && !NPC.downedHalloweenTree && !NPC.downedHalloweenKing)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1155");
				return;
			}
			if (helpText == 1156 && hardMode && NPC.downedGolemBoss && !NPC.downedChristmasIceQueen && !NPC.downedChristmasTree && !NPC.downedChristmasSantank)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1156");
				return;
			}
			if (helpText == 1157 && hardMode && NPC.downedGolemBoss && NPC.AnyNPCs(437) && !NPC.downedMoonlord)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1157");
				return;
			}
			if (helpText == 1158 && hardMode && NPC.LunarApocalypseIsUp && !NPC.downedMoonlord)
			{
				npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1158");
				return;
			}
			if (helpText == 1159 && NPC.downedBoss1 && NPC.downedBoss2 && !NPC.downedDeerclops)
			{
				break;
			}
			if (helpText > 1200)
			{
				helpText = 0;
			}
		}
		npcChatText = Language.GetTextValue("GuideHelpTextSpecific.Help_1160");
	}

	protected void GUIChatDrawInner()
	{
		_newChatPanel.Draw();
	}

	public static void DrawNPCChatBottomRightItem(Vector2 bottomRight)
	{
		if (npcChatCornerItem > 0)
		{
			bottomRight -= Vector2.One * 8f;
			Item item = new Item();
			item.SetDefaults(npcChatCornerItem);
			float num = 1f;
			GetItemDrawFrame(item.type, out var itemTexture, out var rectangle);
			if (rectangle.Width > 32 || rectangle.Height > 32)
			{
				num = ((rectangle.Width <= rectangle.Height) ? (32f / (float)rectangle.Height) : (32f / (float)rectangle.Width));
			}
			spriteBatch.Draw(itemTexture, bottomRight, rectangle, item.GetAlpha(Microsoft.Xna.Framework.Color.White), 0f, rectangle.Size(), num, SpriteEffects.None, 0f);
			if (item.color != default(Microsoft.Xna.Framework.Color))
			{
				spriteBatch.Draw(itemTexture, bottomRight, rectangle, item.GetColor(item.color), 0f, rectangle.Size(), num, SpriteEffects.None, 0f);
			}
			if (!new Microsoft.Xna.Framework.Rectangle((int)bottomRight.X - (int)((float)rectangle.Width * num), (int)bottomRight.Y - (int)((float)rectangle.Height * num), (int)((float)rectangle.Width * num), (int)((float)rectangle.Height * num)).Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)))
			{
				return;
			}
			cursorOverride = 2;
			if (mouseLeftRelease && mouseLeft)
			{
				if (!drawingPlayerChat)
				{
					OpenPlayerChat();
				}
				if (ChatManager.AddChatText(FontAssets.MouseText.Value, ItemTagHandler.GenerateTag(item), Vector2.One))
				{
					SoundEngine.PlaySound(12);
				}
			}
			instance.MouseText(item.Name, -11, 0);
		}
		else
		{
			if (npcChatCornerItem != -1)
			{
				return;
			}
			bottomRight -= Vector2.One * 12f;
			Texture2D value = TextureAssets.EquipPage[5].Value;
			float num2 = 1f;
			Microsoft.Xna.Framework.Rectangle rectangle2 = value.Frame();
			if (rectangle2.Width > 32 || rectangle2.Height > 32)
			{
				num2 = ((rectangle2.Width <= rectangle2.Height) ? (32f / (float)rectangle2.Height) : (32f / (float)rectangle2.Width));
			}
			_ = Microsoft.Xna.Framework.Color.White;
			if (new Microsoft.Xna.Framework.Rectangle((int)bottomRight.X - (int)((float)rectangle2.Width * num2), (int)bottomRight.Y - (int)((float)rectangle2.Height * num2), (int)((float)rectangle2.Width * num2), (int)((float)rectangle2.Height * num2)).Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)))
			{
				spriteBatch.Draw(TextureAssets.EquipPage[7].Value, bottomRight, null, OurFavoriteColor, 0f, rectangle2.Size() + new Vector2(2f), num2, SpriteEffects.None, 0f);
				if (mouseLeftRelease && mouseLeft)
				{
					CloseNPCChatOrSign(quiet: true);
					Player.OpenInventory();
					EquipPageSelected = 1;
				}
			}
			spriteBatch.Draw(value, bottomRight, rectangle2, Microsoft.Xna.Framework.Color.White, 0f, rectangle2.Size(), num2, SpriteEffects.None, 0f);
		}
	}

	public static string GetCoinValueText_Nurse(ref Microsoft.Xna.Framework.Color chatColor, ref int healCost)
	{
		string text = "";
		int num = 0;
		int num2 = 0;
		int num3 = 0;
		int num4 = 0;
		int num5 = healCost;
		if (num5 > 0 && num5 < 1)
		{
			num5 = 1;
		}
		if (num5 < 0)
		{
			num5 = 0;
		}
		healCost = num5;
		if (num5 >= 1000000)
		{
			num = num5 / 1000000;
			num5 -= num * 1000000;
		}
		if (num5 >= 10000)
		{
			num2 = num5 / 10000;
			num5 -= num2 * 10000;
		}
		if (num5 >= 100)
		{
			num3 = num5 / 100;
			num5 -= num3 * 100;
		}
		if (num5 >= 1)
		{
			num4 = num5;
		}
		if (num > 0)
		{
			text = text + num + " " + Lang.inter[15].Value + " ";
		}
		if (num2 > 0)
		{
			text = text + num2 + " " + Lang.inter[16].Value + " ";
		}
		if (num3 > 0)
		{
			text = text + num3 + " " + Lang.inter[17].Value + " ";
		}
		if (num4 > 0)
		{
			text = text + num4 + " " + Lang.inter[18].Value + " ";
		}
		float num6 = (float)(int)mouseTextColor / 255f;
		if (num > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(220f * num6), (byte)(220f * num6), (byte)(198f * num6), mouseTextColor);
		}
		else if (num2 > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(224f * num6), (byte)(201f * num6), (byte)(92f * num6), mouseTextColor);
		}
		else if (num3 > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(181f * num6), (byte)(192f * num6), (byte)(193f * num6), mouseTextColor);
		}
		else if (num4 > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(246f * num6), (byte)(138f * num6), (byte)(96f * num6), mouseTextColor);
		}
		return text;
	}

	public static string GetCoinValueText_TaxCollector(ref Microsoft.Xna.Framework.Color chatColor, ref int healCost)
	{
		string text = "";
		int num = 0;
		int num2 = 0;
		int num3 = 0;
		int num4 = 0;
		int taxMoney = player[myPlayer].taxMoney;
		taxMoney = (int)((float)taxMoney / player[myPlayer].currentShoppingSettings.PriceAdjustment);
		if (taxMoney < 0)
		{
			taxMoney = 0;
		}
		healCost = taxMoney;
		if (taxMoney >= 1000000)
		{
			num = taxMoney / 1000000;
			taxMoney -= num * 1000000;
		}
		if (taxMoney >= 10000)
		{
			num2 = taxMoney / 10000;
			taxMoney -= num2 * 10000;
		}
		if (taxMoney >= 100)
		{
			num3 = taxMoney / 100;
			taxMoney -= num3 * 100;
		}
		if (taxMoney >= 1)
		{
			num4 = taxMoney;
		}
		if (num > 0)
		{
			text = text + num + " " + Lang.inter[15].Value + " ";
		}
		if (num2 > 0)
		{
			text = text + num2 + " " + Lang.inter[16].Value + " ";
		}
		if (num3 > 0)
		{
			text = text + num3 + " " + Lang.inter[17].Value + " ";
		}
		if (num4 > 0)
		{
			text = text + num4 + " " + Lang.inter[18].Value + " ";
		}
		float num5 = (float)(int)mouseTextColor / 255f;
		if (num > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(220f * num5), (byte)(220f * num5), (byte)(198f * num5), mouseTextColor);
		}
		else if (num2 > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(224f * num5), (byte)(201f * num5), (byte)(92f * num5), mouseTextColor);
		}
		else if (num3 > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(181f * num5), (byte)(192f * num5), (byte)(193f * num5), mouseTextColor);
		}
		else if (num4 > 0)
		{
			chatColor = new Microsoft.Xna.Framework.Color((byte)(246f * num5), (byte)(138f * num5), (byte)(96f * num5), mouseTextColor);
		}
		return text;
	}

	public static void NPCChatText_TavernkeepAdvice()
	{
		SoundEngine.PlaySound(12);
		HelpText();
		npcChatText = Lang.BartenderHelpText(npc[player[myPlayer].talkNPC]);
		DoNPCPortraitHop();
	}

	public static void NPCChatText_DyeTraderRarePlant()
	{
		npcChatCornerItem = 0;
		SoundEngine.PlaySound(12);
		bool gotDye = false;
		int num = player[myPlayer].FindItem(ItemID.Sets.ExoticPlantsForDyeTrade);
		if (num != -1)
		{
			player[myPlayer].inventory[num].stack--;
			if (player[myPlayer].inventory[num].stack <= 0)
			{
				player[myPlayer].inventory[num] = new Item();
			}
			gotDye = true;
			SoundEngine.PlaySound(24);
			player[myPlayer].GetDyeTraderReward(npc[player[myPlayer].talkNPC]);
		}
		npcChatText = Lang.DyeTraderQuestChat(gotDye);
	}

	public static void NPCChatText_TinkererReforge()
	{
		playerInventory = true;
		npcChatText = "";
		SoundEngine.PlaySound(12);
		InReforgeMenu = true;
		UILinkPointNavigator.GoToDefaultPage();
	}

	public static void NPCChatText_GuideReverseCrafting()
	{
		playerInventory = true;
		npcChatText = "";
		SoundEngine.PlaySound(12);
		InGuideCraftMenu = true;
		NewCraftingUI.Open(quiet: true);
		TryChangePipsPage(PipPage.Recipes);
		UILinkPointNavigator.GoToDefaultPage();
	}

	public static void NPCChatText_PartyGirlSwapMusic()
	{
		SoundEngine.PlaySound(12);
		int num = rand.Next(1, 4);
		npcChatText = Language.GetTextValue("PartyGirlSpecialText.Music" + num);
		swapMusic = !swapMusic;
		DoNPCPortraitHop();
	}

	public static int GetNurseHealCost()
	{
		int num = player[myPlayer].statLifeMax2 - player[myPlayer].statLife;
		for (int i = 0; i < Player.maxBuffs; i++)
		{
			int num2 = player[myPlayer].buffType[i];
			if (debuff[num2] && player[myPlayer].buffTime[i] > 60 && (num2 < 0 || num2 >= BuffID.Count || !BuffID.Sets.NurseCannotRemoveDebuff[num2]))
			{
				num += 100;
			}
		}
		if (NPC.downedGolemBoss)
		{
			num *= 200;
		}
		else if (NPC.downedPlantBoss)
		{
			num *= 150;
		}
		else if (NPC.downedMechBossAny)
		{
			num *= 100;
		}
		else if (hardMode)
		{
			num *= 60;
		}
		else if (NPC.downedBoss3 || NPC.downedQueenBee)
		{
			num *= 25;
		}
		else if (NPC.downedBoss2)
		{
			num *= 10;
		}
		else if (NPC.downedBoss1)
		{
			num *= 3;
		}
		if (expertMode)
		{
			num *= 2;
		}
		if (LocalPlayer.discountAvailable)
		{
			num = (int)((float)num * 0.8f);
		}
		return (int)((float)num * LocalPlayer.currentShoppingSettings.PriceAdjustment);
	}

	public static void NPCChatText_DoNurseHeal(int healCost)
	{
		SoundEngine.PlaySound(12);
		if (healCost > 0)
		{
			if (player[myPlayer].BuyItem(healCost))
			{
				AchievementsHelper.HandleNurseService(healCost);
				SoundEngine.PlaySound(SoundID.Item4);
				player[myPlayer].HealEffect(player[myPlayer].statLifeMax2 - player[myPlayer].statLife);
				if ((double)player[myPlayer].statLife < (double)player[myPlayer].statLifeMax2 * 0.25)
				{
					npcChatText = Lang.dialog(227);
				}
				else if ((double)player[myPlayer].statLife < (double)player[myPlayer].statLifeMax2 * 0.5)
				{
					npcChatText = Lang.dialog(228);
				}
				else if ((double)player[myPlayer].statLife < (double)player[myPlayer].statLifeMax2 * 0.75)
				{
					npcChatText = Lang.dialog(229);
				}
				else
				{
					npcChatText = Lang.dialog(230);
				}
				player[myPlayer].statLife = player[myPlayer].statLifeMax2;
				for (int i = 0; i < Player.maxBuffs; i++)
				{
					int num = player[myPlayer].buffType[i];
					if (debuff[num] && player[myPlayer].buffTime[i] > 0 && (num < 0 || num >= BuffID.Count || !BuffID.Sets.NurseCannotRemoveDebuff[num]))
					{
						player[myPlayer].DelBuff(i);
						i = -1;
					}
				}
			}
			else
			{
				int num2 = rand.Next(3);
				if (num2 == 0)
				{
					npcChatText = Lang.dialog(52);
				}
				if (num2 == 1)
				{
					npcChatText = Lang.dialog(53);
				}
				if (num2 == 2)
				{
					npcChatText = Lang.dialog(54);
				}
			}
		}
		else
		{
			int num3 = rand.Next(3);
			if (!ChildSafety.Disabled)
			{
				num3 = rand.Next(1, 3);
			}
			switch (num3)
			{
			case 0:
				npcChatText = Lang.dialog(55);
				break;
			case 1:
				npcChatText = Lang.dialog(56);
				break;
			case 2:
				npcChatText = Lang.dialog(57);
				break;
			}
		}
		DoNPCPortraitHop();
	}

	public static void NPCChatText_DoTaxCollector()
	{
		if (player[myPlayer].taxMoney > 0)
		{
			int taxMoney = player[myPlayer].taxMoney;
			taxMoney = (int)((float)taxMoney / player[myPlayer].currentShoppingSettings.PriceAdjustment);
			while (taxMoney > 0)
			{
				EntitySource_Gift source = new EntitySource_Gift(npc[player[myPlayer].talkNPC]);
				if (taxMoney > 1000000)
				{
					int num = taxMoney / 1000000;
					taxMoney -= 1000000 * num;
					int number = Item.NewItem(source, (int)player[myPlayer].position.X, (int)player[myPlayer].position.Y, player[myPlayer].width, player[myPlayer].height, 74, num);
					if (netMode == 1)
					{
						NetMessage.SendData(21, -1, -1, null, number, 1f);
					}
					continue;
				}
				if (taxMoney > 10000)
				{
					int num2 = taxMoney / 10000;
					taxMoney -= 10000 * num2;
					int number2 = Item.NewItem(source, (int)player[myPlayer].position.X, (int)player[myPlayer].position.Y, player[myPlayer].width, player[myPlayer].height, 73, num2);
					if (netMode == 1)
					{
						NetMessage.SendData(21, -1, -1, null, number2, 1f);
					}
					continue;
				}
				if (taxMoney > 100)
				{
					int num3 = taxMoney / 100;
					taxMoney -= 100 * num3;
					int number3 = Item.NewItem(source, (int)player[myPlayer].position.X, (int)player[myPlayer].position.Y, player[myPlayer].width, player[myPlayer].height, 72, num3);
					if (netMode == 1)
					{
						NetMessage.SendData(21, -1, -1, null, number3, 1f);
					}
					continue;
				}
				int num4 = taxMoney;
				if (num4 < 1)
				{
					num4 = 1;
				}
				taxMoney -= num4;
				int number4 = Item.NewItem(source, (int)player[myPlayer].position.X, (int)player[myPlayer].position.Y, player[myPlayer].width, player[myPlayer].height, 71, num4);
				if (netMode == 1)
				{
					NetMessage.SendData(21, -1, -1, null, number4, 1f);
				}
			}
			npcChatText = Lang.dialog(rand.Next(380, 384));
			player[myPlayer].taxMoney = 0;
		}
		else
		{
			npcChatText = Lang.dialog(rand.Next(390, 401));
		}
		DoNPCPortraitHop();
	}

	public static void NPCChatText_DoAnglerQuest()
	{
		npcChatCornerItem = 0;
		SoundEngine.PlaySound(12);
		bool flag = false;
		if (!anglerQuestFinished && !anglerWhoFinishedToday.Contains(player[myPlayer].name))
		{
			int num = player[myPlayer].FindItem(anglerQuestItemNetIDs[anglerQuest]);
			if (num != -1)
			{
				player[myPlayer].inventory[num].stack--;
				if (player[myPlayer].inventory[num].stack <= 0)
				{
					player[myPlayer].inventory[num] = new Item();
				}
				flag = true;
				SoundEngine.PlaySound(24);
				player[myPlayer].anglerQuestsFinished++;
				player[myPlayer].GetAnglerReward(npc[player[myPlayer].talkNPC], anglerQuestItemNetIDs[anglerQuest]);
			}
		}
		npcChatText = Lang.AnglerQuestChat(flag);
		if (flag)
		{
			anglerQuestFinished = true;
			if (netMode == 1)
			{
				NetMessage.SendData(75);
			}
			else
			{
				anglerWhoFinishedToday.Add(player[myPlayer].name);
			}
			AchievementsHelper.HandleAnglerService();
		}
		DoNPCPortraitHop();
	}

	public static void DryadText_WorldPurityOrStardewValleyBit()
	{
		DoNPCPortraitHop();
		SoundEngine.PlaySound(12);
		npcChatText = Lang.GetDryadWorldStatusDialog(out var worldIsEntirelyPure);
		if (CanDryadPlayStardewAnimation(LocalPlayer, npc[player[myPlayer].talkNPC]))
		{
			DryadText_Do_StardewValleyBit();
		}
		else if (worldIsEntirelyPure)
		{
			AchievementsHelper.HandleSpecialEvent(player[myPlayer], 27);
		}
	}

	public static void DryadText_Do_StardewValleyBit()
	{
		NPC.PreventJojaColaDialog = true;
		NPC.RerollDryadText = 2;
		LocalPlayer.ConsumeItem(5275, reverseOrder: true);
		if (netMode == 1)
		{
			NetMessage.SendData(144);
		}
		else
		{
			NPC.HaveDryadDoStardewAnimation();
		}
		npcChatText = Language.GetTextValue("StardewTalk.PlayerGivesCola");
		AchievementsHelper.NotifyProgressionEvent(46);
	}

	public static void CycleNPCPortraitMode()
	{
		DialoguePortraitDrawOption dialoguePortraitPreference = DialoguePortraitPreference;
		switch (DialoguePortraitPreference)
		{
		case DialoguePortraitDrawOption.Detailed:
			dialoguePortraitPreference = DialoguePortraitDrawOption.CloseUp;
			break;
		case DialoguePortraitDrawOption.CloseUp:
			dialoguePortraitPreference = DialoguePortraitDrawOption.FullBodyRetro;
			break;
		case DialoguePortraitDrawOption.FullBodyRetro:
			dialoguePortraitPreference = DialoguePortraitDrawOption.Disabled;
			break;
		case DialoguePortraitDrawOption.Disabled:
			dialoguePortraitPreference = DialoguePortraitDrawOption.Detailed;
			break;
		}
		DialoguePortraitPreference = dialoguePortraitPreference;
	}

	public static void DrawNPCPortrait(Microsoft.Xna.Framework.Color chatBack, Vector2 npcChatTopLeft)
	{
		DialoguePortraitDrawOption dialoguePortraitPreference = DialoguePortraitPreference;
		if (dialoguePortraitPreference == DialoguePortraitDrawOption.Disabled)
		{
			return;
		}
		NPCID.Sets.NPCPortraitProvider nPCPortraitProvider = npcChatPortrait;
		if (nPCPortraitProvider == null)
		{
			return;
		}
		nPCPortraitProvider.GetDrawData(out var texture, out var drawFrame);
		if (texture == null)
		{
			return;
		}
		int num = npcChatPortraitFrameCounter++;
		int num2 = 56;
		Vector2 vector = npcChatTopLeft + new Vector2(-num2 - 6, num2 + 6);
		Asset<Texture2D> npcPortraitBackground = TextureAssets.NpcPortraitBackground;
		Microsoft.Xna.Framework.Rectangle rectangle = npcPortraitBackground.Frame();
		Vector2 scale = new Vector2(1f, 1f);
		int num3 = num % 120;
		int num4 = num / 120;
		SpriteEffects spriteEffects = SpriteEffects.None;
		float num5 = 0f;
		bool num6 = num4 == 0;
		bool flag = false;
		if (false)
		{
			double num7 = 15.0;
			double num8 = Utils.Clamp(num3, 0.0, num7);
			Vector2 center = vector + new Vector2(0f, num2);
			num5 = (float)Math.Sin(6.2831854820251465 * (num8 / num7)) * ((float)Math.PI * 2f) * 0.0045f;
			vector = vector.RotatedBy(num5, center);
		}
		if (num6)
		{
			double num9 = 80.0;
			float num10 = 0.25f;
			float num11 = (float)Utils.EaseOutBounce(Utils.Clamp(num3, 0.0, num9) / num9);
			vector += new Vector2(0f, (float)(-num2) * num10 * (1f - num11));
		}
		if (flag)
		{
			double num12 = 120.0;
			int num13 = 30;
			Utils.GetPortraitMovement(Utils.Clamp(num3, 0.0, num12) / num12, out var offsetX, out var scaleX);
			scale.X = (float)scaleX;
			vector.X += (float)num13 * (float)offsetX;
			if (scale.X < 0f)
			{
				scale.X *= -1f;
				spriteEffects ^= SpriteEffects.FlipHorizontally;
			}
		}
		spriteBatch.Draw(npcPortraitBackground.Value, vector, rectangle, chatBack, num5, rectangle.Size() / 2f, scale, spriteEffects, 0f);
		NPC nPC = npc[LocalPlayer.talkNPC];
		if (dialoguePortraitPreference == DialoguePortraitDrawOption.Detailed)
		{
			spriteBatch.Draw(texture, vector, drawFrame, Microsoft.Xna.Framework.Color.White, num5, drawFrame.Size() / 2f, scale, spriteEffects, 0f);
		}
		if (dialoguePortraitPreference == DialoguePortraitDrawOption.CloseUp)
		{
			NPC portraitDummy = _portraitDummy;
			portraitDummy.SetDefaults(nPC.type);
			portraitDummy.whoAmI = nPC.whoAmI;
			portraitDummy.GivenName = nPC.GivenName;
			portraitDummy.townNpcVariationIndex = nPC.townNpcVariationIndex;
			portraitDummy.FindFrame();
			int num14 = 16;
			portraitDummy.scale = 3f;
			int num15 = -portraitDummy.width / 2;
			if (NPCID.Sets.IsTownPet[portraitDummy.type])
			{
				num14 = -20;
				portraitDummy.scale = 3f;
				int num16 = 96;
				num16 -= nPC.frame.Width;
				num16 /= 2;
				num16 /= 6;
				num16 *= 6;
				num15 = -36 + num16;
			}
			Dictionary<int, Vector2> nPCPortraitsCloseUpOffsets = NPCID.Sets.NPCPortraitsCloseUpOffsets;
			portraitDummy.position = vector + new Vector2(num15, 48 + num14);
			Vector2 value = Vector2.Zero;
			if (nPCPortraitsCloseUpOffsets.TryGetValue(nPC.type, out value))
			{
				portraitDummy.position += value;
			}
			portraitDummy.IsABestiaryIconDummy = true;
			portraitDummy.IsAPortraitDummy = true;
			spriteBatch.End();
			Microsoft.Xna.Framework.Rectangle scissorRectangle = spriteBatch.GraphicsDevice.ScissorRectangle;
			spriteBatch.Begin(SpriteSortMode.Deferred, null, SamplerState.PointClamp, null, ScissorState, null, UIScaleMatrix);
			Microsoft.Xna.Framework.Rectangle scissorRectangle2 = Utils.CenteredRectangle(vector * UIScaleMatrix.M11, new Vector2(96f, 96f) * UIScaleMatrix.M11);
			scissorRectangle2.Y -= 50;
			scissorRectangle2.Height += 50;
			spriteBatch.GraphicsDevice.ScissorRectangle = scissorRectangle2;
			instance.DrawNPCDirect(spriteBatch, portraitDummy, behindTiles: false, Vector2.Zero);
			spriteBatch.End();
			spriteBatch.GraphicsDevice.ScissorRectangle = scissorRectangle;
			spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, UIScaleMatrix);
		}
		if (dialoguePortraitPreference == DialoguePortraitDrawOption.FullBodyRetro)
		{
			NPC portraitDummy2 = _portraitDummy;
			portraitDummy2.SetDefaults(nPC.type);
			portraitDummy2.whoAmI = nPC.whoAmI;
			portraitDummy2.GivenName = nPC.GivenName;
			portraitDummy2.townNpcVariationIndex = nPC.townNpcVariationIndex;
			portraitDummy2.FindFrame();
			int num17 = -portraitDummy2.height;
			portraitDummy2.scale = 2f;
			int num18 = -portraitDummy2.width / 2;
			Dictionary<int, Vector2> nPCPortraitsFullBodyRetroOffsets = NPCID.Sets.NPCPortraitsFullBodyRetroOffsets;
			portraitDummy2.position = vector + new Vector2(num18, 48 + num17);
			Vector2 value2 = Vector2.Zero;
			if (nPCPortraitsFullBodyRetroOffsets.TryGetValue(nPC.type, out value2))
			{
				portraitDummy2.position += value2;
			}
			portraitDummy2.IsABestiaryIconDummy = true;
			portraitDummy2.IsAPortraitDummy = true;
			spriteBatch.End();
			_ = spriteBatch.GraphicsDevice.ScissorRectangle;
			spriteBatch.Begin(SpriteSortMode.Deferred, null, SamplerState.PointClamp, null, null, null, UIScaleMatrix);
			instance.DrawNPCDirect(spriteBatch, portraitDummy2, behindTiles: false, Vector2.Zero);
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, UIScaleMatrix);
		}
		string givenName = nPC.GivenName;
		DynamicSpriteFont value3 = FontAssets.ItemStack.Value;
		Vector2 vector2 = value3.MeasureString(givenName);
		float num19 = 1f;
		ChatManager.DrawColorCodedStringWithShadow(spriteBatch, value3, givenName, vector + new Vector2(0f, num2 + 1), Microsoft.Xna.Framework.Color.White, 0f, vector2 / 2f, Vector2.One * num19);
	}

	public static bool CanDryadPlayStardewAnimation(Player player, NPC npc)
	{
		Item heldItem = player.HeldItem;
		if (!heldItem.IsAir && heldItem.type == 5275 && npc.ai[0] != 24f)
		{
			return npc.type == 20;
		}
		return false;
	}

	public void OpenShop(int shopIndex)
	{
		playerInventory = true;
		stackSplit = 9999;
		npcChatText = "";
		SetNPCShopIndex(shopIndex);
		shop[npcShop].SetupShop(npcShop);
		SoundEngine.PlaySound(12);
	}

	public static void SetNPCShopIndex(int index)
	{
		npcShop = index;
	}

	private static void DrawNPCChatButtons(int superColor, Microsoft.Xna.Framework.Color chatColor, int numLines, string focusText, string focusText3)
	{
		float y = 130 + numLines * 30;
		int num = 180 + (screenWidth - 800) / 2;
		Vector2 vec = new Vector2(mouseX, mouseY);
		Player player = Main.player[myPlayer];
		Vector2 vector = new Vector2(num, y);
		string text = focusText;
		DynamicSpriteFont value = FontAssets.MouseText.Value;
		Vector2 vector2 = vector;
		Vector2 vector3 = new Vector2(0.9f);
		Vector2 stringSize = ChatManager.GetStringSize(value, text, vector3);
		Microsoft.Xna.Framework.Color baseColor = chatColor;
		Microsoft.Xna.Framework.Color black = Microsoft.Xna.Framework.Color.Black;
		Vector2 vector4 = new Vector2(1f);
		Microsoft.Xna.Framework.Color brown = Microsoft.Xna.Framework.Color.Brown;
		float num2 = 1.2f;
		if (stringSize.X > 260f)
		{
			vector4.X *= 260f / stringSize.X;
		}
		if (vec.Between(vector2, vector2 + stringSize * vector3 * vector4.X) && !PlayerInput.IgnoreMouseInterface)
		{
			player.mouseInterface = true;
			player.releaseUseItem = false;
			vector3 *= num2;
			if (!npcChatFocus2)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus2 = true;
		}
		else
		{
			if (npcChatFocus2)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus2 = false;
		}
		ChatManager.DrawColorCodedStringShadow(baseColor: (!npcChatFocus2) ? Microsoft.Xna.Framework.Color.Black : brown, spriteBatch: spriteBatch, font: value, text: text, position: vector2 + stringSize * vector4 * 0.5f, rotation: 0f, origin: stringSize * 0.5f, baseScale: vector3 * vector4);
		ChatManager.DrawColorCodedString(spriteBatch, value, text, vector2 + stringSize * vector4 * 0.5f, baseColor, 0f, stringSize * 0.5f, vector3 * vector4);
		if (text.Length > 0)
		{
			UILinkPointNavigator.SetPosition(2500, vector2 + stringSize * 0.5f);
			UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsLeft = true;
		}
		Vector2 vector5 = new Vector2((float)num + stringSize.X * vector4.X + 30f, y);
		text = Lang.inter[52].Value;
		value = FontAssets.MouseText.Value;
		vector2 = vector5;
		vector3 = new Vector2(0.9f);
		stringSize = ChatManager.GetStringSize(value, text, vector3);
		baseColor = new Microsoft.Xna.Framework.Color(superColor, (int)((double)superColor / 1.1), superColor / 2, superColor);
		vector4 = new Vector2(1f);
		if (vec.Between(vector2, vector2 + stringSize * vector3 * vector4.X) && !PlayerInput.IgnoreMouseInterface)
		{
			player.mouseInterface = true;
			player.releaseUseItem = false;
			vector3 *= num2;
			if (!npcChatFocus1)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus1 = true;
		}
		else
		{
			if (npcChatFocus1)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus1 = false;
		}
		ChatManager.DrawColorCodedStringShadow(baseColor: (!npcChatFocus1) ? Microsoft.Xna.Framework.Color.Black : brown, spriteBatch: spriteBatch, font: value, text: text, position: vector2 + stringSize * vector4 * 0.5f, rotation: 0f, origin: stringSize * 0.5f, baseScale: vector3 * vector4);
		ChatManager.DrawColorCodedString(spriteBatch, value, text, vector2 + stringSize * vector4 * 0.5f, baseColor, 0f, stringSize * 0.5f, vector3 * vector4);
		if (text.Length > 0)
		{
			UILinkPointNavigator.SetPosition(2501, vector2 + stringSize * 0.5f);
			UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsMiddle = true;
		}
		if (string.IsNullOrWhiteSpace(focusText3))
		{
			npcChatFocus3 = false;
			UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsRight = false;
		}
		else
		{
			Vector2 vector6 = new Vector2(vector5.X + stringSize.X * vector4.X + 30f, y);
			text = focusText3;
			value = FontAssets.MouseText.Value;
			vector2 = vector6;
			vector3 = new Vector2(0.9f);
			stringSize = ChatManager.GetStringSize(value, text, vector3);
			baseColor = chatColor;
			vector4 = new Vector2(1f);
			vector5.X = vector6.X;
			if (vec.Between(vector2, vector2 + stringSize * vector3 * vector4.X) && !PlayerInput.IgnoreMouseInterface)
			{
				player.mouseInterface = true;
				player.releaseUseItem = false;
				vector3 *= num2;
				if (!npcChatFocus3)
				{
					SoundEngine.PlaySound(12);
				}
				npcChatFocus3 = true;
			}
			else
			{
				if (npcChatFocus3)
				{
					SoundEngine.PlaySound(12);
				}
				npcChatFocus3 = false;
			}
			ChatManager.DrawColorCodedStringShadow(baseColor: (!npcChatFocus3) ? Microsoft.Xna.Framework.Color.Black : brown, spriteBatch: spriteBatch, font: value, text: text, position: vector2 + stringSize * vector4 * 0.5f, rotation: 0f, origin: stringSize * 0.5f, baseScale: vector3 * vector4);
			ChatManager.DrawColorCodedString(spriteBatch, value, text, vector2 + stringSize * vector4 * 0.5f, baseColor, 0f, stringSize * 0.5f, vector3 * vector4);
			UILinkPointNavigator.SetPosition(2502, vector2 + stringSize * 0.5f);
			UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsRight = true;
		}
		if (remixWorld)
		{
			return;
		}
		if (LocalPlayer.talkNPC >= 0 && npc[LocalPlayer.talkNPC].homeless && npc[LocalPlayer.talkNPC].type != 37 && npc[LocalPlayer.talkNPC].type != 368 && npc[LocalPlayer.talkNPC].type != 453)
		{
			string textValue = Language.GetTextValue("UI.NPCHousing");
			Vector2 vector7 = new Vector2(vector5.X + stringSize.X * vector4.X + 30f, y);
			text = textValue;
			value = FontAssets.MouseText.Value;
			vector2 = vector7;
			vector3 = new Vector2(0.9f);
			stringSize = ChatManager.GetStringSize(value, text, vector3);
			baseColor = new Microsoft.Xna.Framework.Color(superColor, (int)((double)superColor / 1.1), superColor / 2, superColor);
			vector4 = new Vector2(1f);
			if (vec.Between(vector2, vector2 + stringSize * vector3 * vector4.X) && !PlayerInput.IgnoreMouseInterface)
			{
				player.mouseInterface = true;
				player.releaseUseItem = false;
				vector3 *= num2;
				if (!npcChatFocus4)
				{
					SoundEngine.PlaySound(12);
				}
				npcChatFocus4 = true;
			}
			else
			{
				if (npcChatFocus4)
				{
					SoundEngine.PlaySound(12);
				}
				npcChatFocus4 = false;
			}
			ChatManager.DrawColorCodedStringShadow(baseColor: (!npcChatFocus4) ? Microsoft.Xna.Framework.Color.Black : brown, spriteBatch: spriteBatch, font: value, text: text, position: vector2 + stringSize * vector4 * 0.5f, rotation: 0f, origin: stringSize * 0.5f, baseScale: vector3 * vector4);
			ChatManager.DrawColorCodedString(spriteBatch, value, text, vector2 + stringSize * vector4 * 0.5f, baseColor, 0f, stringSize * 0.5f, vector3 * vector4);
			UILinkPointNavigator.SetPosition(2503, vector2 + stringSize * 0.5f);
			UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsRight2 = true;
			return;
		}
		if (Main.player[myPlayer].currentShoppingSettings.HappinessReport == "")
		{
			npcChatFocus4 = false;
			UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsRight2 = false;
			return;
		}
		string textValue2 = Language.GetTextValue("UI.NPCCheckHappiness");
		Vector2 vector8 = new Vector2(vector5.X + stringSize.X * vector4.X + 30f, y);
		text = textValue2;
		value = FontAssets.MouseText.Value;
		vector2 = vector8;
		vector3 = new Vector2(0.9f);
		stringSize = ChatManager.GetStringSize(value, text, vector3);
		baseColor = new Microsoft.Xna.Framework.Color(superColor, (int)((double)superColor / 1.1), superColor / 2, superColor);
		vector4 = new Vector2(1f);
		if (vec.Between(vector2, vector2 + stringSize * vector3 * vector4.X) && !PlayerInput.IgnoreMouseInterface)
		{
			player.mouseInterface = true;
			player.releaseUseItem = false;
			vector3 *= num2;
			if (!npcChatFocus4)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus4 = true;
		}
		else
		{
			if (npcChatFocus4)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus4 = false;
		}
		ChatManager.DrawColorCodedStringShadow(baseColor: (!npcChatFocus4) ? Microsoft.Xna.Framework.Color.Black : brown, spriteBatch: spriteBatch, font: value, text: text, position: vector2 + stringSize * vector4 * 0.5f, rotation: 0f, origin: stringSize * 0.5f, baseScale: vector3 * vector4);
		ChatManager.DrawColorCodedString(spriteBatch, value, text, vector2 + stringSize * vector4 * 0.5f, baseColor, 0f, stringSize * 0.5f, vector3 * vector4);
		UILinkPointNavigator.SetPosition(2503, vector2 + stringSize * 0.5f);
		UILinkPointNavigator.Shortcuts.NPCCHAT_ButtonsRight2 = true;
	}

	public static void DoNPCPortraitHop()
	{
		npcChatPortraitFrameCounter = 0;
	}

	public static void CloseNPCChatOrSign(bool quiet = false)
	{
		LocalPlayer.CloseSign(quiet: true);
		player[myPlayer].SetTalkNPC(-1);
		npcChatCornerItem = 0;
		npcChatText = "";
		if (!quiet)
		{
			SoundEngine.PlaySound(11);
		}
		player[myPlayer].releaseMount = false;
		instance._newChatPanel.Close();
	}

	public static void SubmitSignText()
	{
		SoundEngine.PlaySound(12);
		int num = player[myPlayer].sign;
		Sign.TextSign(num, npcChatText);
		editSign = false;
		if (netMode == 1)
		{
			NetMessage.SendData(47, -1, -1, null, num);
		}
	}

	private int NPCBannerSorter(int npcIndex1, int npcIndex2)
	{
		return -npc[npcIndex1].housingCategory.CompareTo(npc[npcIndex2].housingCategory);
	}

	protected void DrawNPCHousesInWorld()
	{
		_npcsWithBannersToDraw.Clear();
		_occupantsListToDrawNPCHouses.Clear();
		for (int i = 0; i < maxNPCs; i++)
		{
			if (npc[i].active && npc[i].townNPC && !npc[i].homeless && npc[i].homeTileX > 0 && npc[i].homeTileY > 0 && npc[i].type != 37)
			{
				_npcsWithBannersToDraw.Add(i);
			}
		}
		_npcsWithBannersToDraw.Sort(NPCBannerSorter);
		UILinkPointNavigator.Shortcuts.NPCS_HoveredBanner = -2;
		for (int j = 0; j < _npcsWithBannersToDraw.Count; j++)
		{
			int num = _npcsWithBannersToDraw[j];
			NPC nPC = npc[num];
			if (!nPC.active || !nPC.townNPC || nPC.homeless || nPC.homeTileX <= 0 || nPC.homeTileY <= 0 || nPC.type == 37)
			{
				continue;
			}
			int num2 = 0;
			int housingCategory = nPC.housingCategory;
			int homeTileX = nPC.homeTileX;
			int num3 = nPC.homeTileY - 1;
			WorldGen.TownManager.AddOccupantsToList(homeTileX, num3 + 1, _occupantsListToDrawNPCHouses);
			if (_occupantsListToDrawNPCHouses.Contains(nPC.type))
			{
				num2 = 1;
			}
			int num4 = 0;
			for (int num5 = _npcsWithBannersToDraw.Count - 1; num5 > j; num5--)
			{
				int num6 = _npcsWithBannersToDraw[num5];
				if (npc[num6].homeTileX == homeTileX && npc[num6].homeTileY == num3 + 1)
				{
					num4++;
				}
			}
			int num7 = num4 * 26;
			if (tile[homeTileX, num3] == null)
			{
				continue;
			}
			bool flag = false;
			while (!tile[homeTileX, num3].active() || !tileSolid[tile[homeTileX, num3].type])
			{
				num3--;
				if (num3 < 10)
				{
					break;
				}
				if (tile[homeTileX, num3] == null)
				{
					flag = true;
					break;
				}
			}
			if (flag)
			{
				continue;
			}
			int num8 = 8;
			int num9 = 18;
			if (tile[homeTileX, num3].type == 19)
			{
				num9 -= 8;
			}
			num3++;
			int num10 = 0;
			float num11 = num3 * 16;
			num11 += (float)num7;
			SpriteEffects effects = SpriteEffects.None;
			Texture2D value = TextureAssets.HouseBanner.Value;
			Microsoft.Xna.Framework.Rectangle value2 = value.Frame(2, 2);
			if (num2 > 0)
			{
				value2.X += value2.Width * num2;
			}
			if (housingCategory > 0)
			{
				value2.Y += value2.Height * housingCategory;
			}
			if (player[myPlayer].gravDir == -1f)
			{
				num11 -= screenPosition.Y;
				num11 = screenPosition.Y + (float)screenHeight - num11;
				num11 -= (float)value2.Height;
				effects = SpriteEffects.FlipVertically;
				num10 = 4;
			}
			spriteBatch.Draw(value, new Vector2(homeTileX * 16 - (int)screenPosition.X + num8, num11 - (float)(int)screenPosition.Y + (float)num9 + (float)num10), value2, Lighting.GetColor(homeTileX, num3), 0f, new Vector2(value2.Width / 2, value2.Height / 2), 1f, effects, 0f);
			int headIndexSafe = TownNPCProfiles.GetHeadIndexSafe(nPC);
			float scale = 1f;
			float num12 = 0f;
			num12 = ((TextureAssets.NpcHead[headIndexSafe].Width() <= TextureAssets.NpcHead[headIndexSafe].Height()) ? ((float)TextureAssets.NpcHead[headIndexSafe].Height()) : ((float)TextureAssets.NpcHead[headIndexSafe].Width()));
			if (num12 > 24f)
			{
				scale = 24f / num12;
			}
			spriteBatch.Draw(TextureAssets.NpcHead[headIndexSafe].Value, new Vector2(homeTileX * 16 - (int)screenPosition.X + num8, num11 - (float)(int)screenPosition.Y + (float)num9 + 2f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.NpcHead[headIndexSafe].Width(), TextureAssets.NpcHead[headIndexSafe].Height()), Lighting.GetColor(homeTileX, num3), 0f, new Vector2(TextureAssets.NpcHead[headIndexSafe].Width() / 2, TextureAssets.NpcHead[headIndexSafe].Height() / 2), scale, effects, 0f);
			homeTileX = homeTileX * 16 - (int)screenPosition.X + num8 - value2.Width / 2;
			num3 = (int)num11 - (int)screenPosition.Y + 4;
			int num13 = -8;
			if (PlayerInput.ControllerHousingCursorActive)
			{
				Vector2 vector = PlayerInput.HousingWorldPosition - screenPosition;
				if (vector.X >= (float)homeTileX && vector.X <= (float)(homeTileX + value2.Width) && vector.Y >= (float)num3 && vector.Y <= (float)(num3 + value2.Height + num13))
				{
					UILinkPointNavigator.Shortcuts.NPCS_HoveredBanner = num;
				}
			}
			else if (mouseX >= homeTileX && mouseX <= homeTileX + value2.Width && mouseY >= num3 && mouseY <= num3 + value2.Height + num13)
			{
				string nPCHouseBannerText = Lang.GetNPCHouseBannerText(nPC, num2);
				MouseText(nPCHouseBannerText, 0, 0);
				if (mouseRightRelease && mouseRight)
				{
					mouseRightRelease = false;
					WorldGen.kickOut(num);
					SoundEngine.PlaySound(12);
				}
			}
		}
	}

	public void SetIMEPanelAnchor(Vector2 position, float xAnchor)
	{
		imePanelAnchor = new IMEPanelAnchor
		{
			Position = position,
			XAnchor = xAnchor
		};
	}

	public void DrawIMEPanel()
	{
		if (!imePanelAnchor.HasValue || !Platform.Get<IImeService>().IsCandidateListVisible)
		{
			return;
		}
		Vector2 position = imePanelAnchor.Value.Position;
		float xAnchor = imePanelAnchor.Value.XAnchor;
		List<string> list = new List<string>();
		for (uint num = 0u; num < Platform.Get<IImeService>().CandidateCount; num++)
		{
			string candidate = Platform.Get<IImeService>().GetCandidate(num);
			list.Add(candidate);
		}
		if (list.Count == 0)
		{
			return;
		}
		PlayerInput.SetZoom_UI();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, UIScaleMatrix);
		uint? selectedCandidate = Platform.Get<IImeService>().SelectedCandidate;
		DynamicSpriteFont value = FontAssets.MouseText.Value;
		float num2 = 0.85f;
		float num3 = 14f;
		float num4 = 0f;
		int num5 = 32;
		num4 += num3;
		string text = "{0,2}: {1}";
		string text2 = "  ";
		for (int i = 0; i < list.Count; i++)
		{
			int num6 = i + 1;
			string text3 = text;
			if (i < list.Count - 1)
			{
				text3 += text2;
			}
			num4 += value.MeasureString(string.Format(text3, num6, list[i])).X * num2;
			num4 += num3;
		}
		position += new Vector2(num4 * (0f - xAnchor), 0f);
		position.X = Math.Min(position.X, (float)screenWidth - num4);
		position.X = Math.Max(position.X, 0f);
		Utils.DrawSettings2Panel(spriteBatch, position + new Vector2(0f, -num5), num4, new Microsoft.Xna.Framework.Color(63, 65, 151, 255) * 0.785f);
		position += new Vector2(10f, -num5 / 2);
		for (uint num7 = 0u; num7 < list.Count; num7++)
		{
			Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Gray;
			if (num7 == selectedCandidate)
			{
				color = Microsoft.Xna.Framework.Color.White;
			}
			uint num8 = num7 + 1;
			string text4 = text;
			if (num7 < list.Count - 1)
			{
				text4 += text2;
			}
			string text5 = string.Format(text4, num8, list[(int)num7]);
			Vector2 vector = value.MeasureString(text5) * num2;
			Utils.DrawBorderString(spriteBatch, text5, position, color, num2, 0f, 0.4f);
			position.X += vector.X + num3;
		}
		spriteBatch.End();
	}

	public void HandleIME()
	{
		if (_imeToggle != PlayerInput.WritingText)
		{
			_imeToggle = PlayerInput.WritingText;
			if (_imeToggle)
			{
				Platform.Get<IImeService>().Enable();
			}
			else
			{
				Platform.Get<IImeService>().Disable();
			}
		}
	}

	public void DrawPlayerChat()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		TextSnippet[] array = null;
		if (drawingPlayerChat)
		{
			PlayerInput.WritingText = true;
		}
		HandleIME();
		if (drawingPlayerChat)
		{
			textBlinkerCount++;
			if (textBlinkerCount >= 20)
			{
				if (textBlinkerState == 0)
				{
					textBlinkerState = 1;
				}
				else
				{
					textBlinkerState = 0;
				}
				textBlinkerCount = 0;
			}
			string text = chatText;
			if (screenWidth > 800)
			{
				int num = screenWidth - 300;
				int num2 = 78;
				spriteBatch.Draw(TextureAssets.TextBack.Value, new Vector2(num2, screenHeight - 36), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.TextBack.Width() - 100, TextureAssets.TextBack.Height()), new Microsoft.Xna.Framework.Color(100, 100, 100, 100), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				num -= 400;
				num2 += 400;
				while (num > 0)
				{
					if (num > 300)
					{
						spriteBatch.Draw(TextureAssets.TextBack.Value, new Vector2(num2, screenHeight - 36), new Microsoft.Xna.Framework.Rectangle(100, 0, TextureAssets.TextBack.Width() - 200, TextureAssets.TextBack.Height()), new Microsoft.Xna.Framework.Color(100, 100, 100, 100), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						num -= 300;
						num2 += 300;
					}
					else
					{
						spriteBatch.Draw(TextureAssets.TextBack.Value, new Vector2(num2, screenHeight - 36), new Microsoft.Xna.Framework.Rectangle(TextureAssets.TextBack.Width() - num, 0, TextureAssets.TextBack.Width() - (TextureAssets.TextBack.Width() - num), TextureAssets.TextBack.Height()), new Microsoft.Xna.Framework.Color(100, 100, 100, 100), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						num = 0;
					}
				}
			}
			else
			{
				spriteBatch.Draw(TextureAssets.TextBack.Value, new Vector2(78f, screenHeight - 36), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.TextBack.Width(), TextureAssets.TextBack.Height()), new Microsoft.Xna.Framework.Color(100, 100, 100, 100), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			int hoveredSnippet = -1;
			List<TextSnippet> list = ChatManager.ParseMessage(text, Microsoft.Xna.Framework.Color.White);
			float x = ChatManager.GetStringSize(FontAssets.MouseText.Value, list.ToArray(), Vector2.One).X;
			SetIMEPanelAnchor(new Vector2(88f + x, screenHeight - 36), 0f);
			string compositionString = Platform.Get<IImeService>().CompositionString;
			if (compositionString != null && compositionString.Length > 0)
			{
				list.Add(new TextSnippet(compositionString, imeCompositionStringColor));
			}
			if (textBlinkerState == 1)
			{
				list.Add(new TextSnippet("|", Microsoft.Xna.Framework.Color.White));
			}
			array = list.ToArray();
			ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, array, new Vector2(88f, screenHeight - 30), 0f, Vector2.Zero, Vector2.One, out hoveredSnippet);
			if (hoveredSnippet > -1)
			{
				array[hoveredSnippet].OnHover();
				if (mouseLeft && mouseLeftRelease)
				{
					array[hoveredSnippet].OnClick();
				}
			}
		}
		chatMonitor.DrawChat(drawingPlayerChat);
		TimeLogger.PlayerChat.AddTime(fromTimestamp);
	}

	protected void DrawInventory()
	{
		if (!NewCraftingUI.Visible)
		{
			Recipe.UpdateRecipeList();
		}
		DrawPVPIcons();
		int num = 0;
		int num2 = 0;
		int num3 = screenWidth;
		int num4 = 0;
		int num5 = screenWidth;
		int num6 = 0;
		Vector2 vector = new Vector2(num, num2);
		new Vector2(num3, num4);
		new Vector2(num5, num6);
		DrawBestiaryIcon(num, num2);
		DrawEmoteBubblesButton(num, num2);
		DrawTrashItemSlot(num, num2);
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, Lang.inter[4].Value, new Vector2(40f, 0f) + vector, new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, default(Vector2), 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		inventoryScale = 0.85f;
		if (mouseX > 20 && mouseX < (int)(20f + 560f * inventoryScale) && mouseY > 20 && mouseY < (int)(20f + 280f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
		{
			player[myPlayer].mouseInterface = true;
		}
		for (int i = 0; i < 10; i++)
		{
			for (int j = 0; j < 5; j++)
			{
				int num7 = (int)(20f + (float)(i * 56) * inventoryScale) + num;
				int num8 = (int)(20f + (float)(j * 56) * inventoryScale) + num2;
				int num9 = i + j * 10;
				new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
				if (mouseX >= num7 && (float)mouseX <= (float)num7 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num8 && (float)mouseY <= (float)num8 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
				{
					player[myPlayer].mouseInterface = true;
					if (player[myPlayer].inventoryChestStack[num9] && player[myPlayer].inventory[num9].IsAir)
					{
						player[myPlayer].inventoryChestStack[num9] = false;
					}
					ItemSlot.Handle(player[myPlayer].inventory, 0, num9, !player[myPlayer].inventoryChestStack[num9]);
				}
				ItemSlot.Draw(spriteBatch, player[myPlayer].inventory, 0, num9, new Vector2(num7, num8));
			}
		}
		GetBuilderAccsCountToShow(LocalPlayer, out var _, out var _, out var totalDrawnIcons);
		bool pushSideToolsUp = totalDrawnIcons >= 10;
		if (!PlayerInput.UsingGamepad)
		{
			DrawHotbarLockIcon(num, num2, pushSideToolsUp);
		}
		ItemSlot.DrawRadialDpad(spriteBatch, new Vector2(20f) + new Vector2(56f * inventoryScale * 10f, 56f * inventoryScale * 5f) + new Vector2(26f, 70f) + vector);
		if (_achievementAdvisor.CanDrawAboveCoins)
		{
			int num10 = (int)(20f + 560f * inventoryScale) + num;
			int num11 = (int)(20f + 0f * inventoryScale) + num2;
			_achievementAdvisor.DrawOneAchievement(spriteBatch, new Vector2(num10, num11) + new Vector2(5f), large: true);
		}
		int state = -1;
		if (mapEnabled)
		{
			bool flag = false;
			int num12 = num3 - 440;
			int num13 = 40 + num4;
			if (screenWidth < 940)
			{
				flag = true;
			}
			if (flag)
			{
				num12 = num5 - 40;
				num13 = num6 - 200;
			}
			int num14 = 0;
			for (int k = 0; k < 4; k++)
			{
				int num15 = 255;
				int num16 = num12 + k * 32 - num14;
				int num17 = num13;
				if (flag)
				{
					num16 = num12;
					num17 = num13 + k * 32 - num14;
				}
				int num18 = k;
				num15 = 120;
				if (k > 0 && mapStyle == k - 1)
				{
					num15 = 200;
				}
				if (mouseX >= num16 && mouseX <= num16 + 32 && mouseY >= num17 && mouseY <= num17 + 30 && !PlayerInput.IgnoreMouseInterface)
				{
					num15 = 255;
					num18 += 4;
					player[myPlayer].mouseInterface = true;
					state = k;
					if (mouseLeft && mouseLeftRelease)
					{
						if (k == 0)
						{
							playerInventory = false;
							player[myPlayer].SetTalkNPC(-1);
							npcChatCornerItem = 0;
							SoundEngine.PlaySound(10);
							mapFullscreenScale = 2.5f;
							MapPylonTile = new Point16(-1, -1);
							mapFullscreen = true;
							resetMapFull = true;
						}
						if (k == 1)
						{
							mapStyle = 0;
							SoundEngine.PlaySound(12);
						}
						if (k == 2)
						{
							mapStyle = 1;
							SoundEngine.PlaySound(12);
						}
						if (k == 3)
						{
							mapStyle = 2;
							SoundEngine.PlaySound(12);
						}
					}
				}
				spriteBatch.Draw(TextureAssets.MapIcon[num18].Value, new Vector2(num16, num17), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.MapIcon[num18].Width(), TextureAssets.MapIcon[num18].Height()), new Microsoft.Xna.Framework.Color(num15, num15, num15, num15), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
		}
		DoStatefulTickSound(ref mapStyleMouseOver, state);
		if (armorHide)
		{
			armorAlpha -= 0.1f;
			if (armorAlpha < 0f)
			{
				armorAlpha = 0f;
			}
		}
		else
		{
			armorAlpha += 0.025f;
			if (armorAlpha > 1f)
			{
				armorAlpha = 1f;
			}
		}
		new Microsoft.Xna.Framework.Color((byte)((float)(int)mouseTextColor * armorAlpha), (byte)((float)(int)mouseTextColor * armorAlpha), (byte)((float)(int)mouseTextColor * armorAlpha), (byte)((float)(int)mouseTextColor * armorAlpha));
		armorHide = false;
		int num19 = 8 + player[myPlayer].GetAmountOfExtraAccessorySlotsToShow();
		int num20 = 174 + mH;
		int num21 = 950;
		_cannotDrawAccessoriesHorizontally = false;
		if (screenHeight < num21 && num19 >= 10)
		{
			num20 -= (int)(56f * inventoryScale * (float)(num19 - 9));
			_cannotDrawAccessoriesHorizontally = true;
		}
		int num22 = DrawPageIcons(num20 - 32);
		DoStatefulTickSound(ref equipPageMouseOver, num22);
		if (num22 > -1)
		{
			ClearHoverItem();
			switch (num22)
			{
			case 1:
				hoverItemName = Lang.inter[80].Value;
				break;
			case 2:
				hoverItemName = Lang.inter[79].Value;
				break;
			case 3:
				hoverItemName = (CaptureModeDisabled ? Lang.inter[115].Value : Lang.inter[81].Value);
				break;
			}
		}
		if (EquipPage == 2)
		{
			Microsoft.Xna.Framework.Point value = new Microsoft.Xna.Framework.Point(mouseX, mouseY);
			Microsoft.Xna.Framework.Rectangle r = new Microsoft.Xna.Framework.Rectangle(0, 0, (int)((float)TextureAssets.InventoryBack.Width() * inventoryScale), (int)((float)TextureAssets.InventoryBack.Height() * inventoryScale));
			Item[] inv = player[myPlayer].miscEquips;
			int num23 = screenWidth - 92;
			int num24 = num20;
			for (int l = 0; l < 2; l++)
			{
				switch (l)
				{
				case 0:
					inv = player[myPlayer].miscEquips;
					break;
				case 1:
					inv = player[myPlayer].miscDyes;
					break;
				}
				r.X = num23 + l * -47;
				for (int m = 0; m < 5; m++)
				{
					int context = 0;
					int num25 = -1;
					bool flag2 = false;
					switch (m)
					{
					case 0:
						context = 19;
						num25 = 0;
						break;
					case 1:
						context = 20;
						num25 = 1;
						break;
					case 2:
						context = 18;
						flag2 = player[myPlayer].unlockedSuperCart;
						break;
					case 3:
						context = 17;
						break;
					case 4:
						context = 16;
						break;
					}
					if (l == 1)
					{
						context = 33;
						num25 = -1;
						flag2 = false;
					}
					r.Y = num24 + m * 47;
					bool flag3 = false;
					Texture2D value2 = TextureAssets.InventoryTickOn.Value;
					Microsoft.Xna.Framework.Rectangle r2 = new Microsoft.Xna.Framework.Rectangle(r.Left + 34, r.Top - 2, value2.Width, value2.Height);
					int num26 = 0;
					if (num25 != -1 && mouseItem.IsAir)
					{
						if (player[myPlayer].hideMisc[num25])
						{
							value2 = TextureAssets.InventoryTickOff.Value;
						}
						if (r2.Contains(value) && !PlayerInput.IgnoreMouseInterface)
						{
							player[myPlayer].mouseInterface = true;
							flag3 = true;
							if (mouseLeft && mouseLeftRelease)
							{
								if (num25 == 0)
								{
									player[myPlayer].TogglePet();
								}
								if (num25 == 1)
								{
									player[myPlayer].ToggleLight();
								}
								mouseLeftRelease = false;
								SoundEngine.PlaySound(12);
								if (netMode == 1)
								{
									NetMessage.SendData(4, -1, -1, null, myPlayer);
								}
							}
							num26 = ((!player[myPlayer].hideMisc[num25]) ? 1 : 2);
						}
					}
					if (flag2 && mouseItem.IsAir)
					{
						value2 = TextureAssets.Extra[255].Value;
						if (!player[myPlayer].enabledSuperCart)
						{
							value2 = TextureAssets.Extra[256].Value;
						}
						r2 = new Microsoft.Xna.Framework.Rectangle(r2.X + r2.Width / 2, r2.Y + r2.Height / 2, r2.Width, r2.Height);
						r2.Offset(-r2.Width / 2, -r2.Height / 2);
						if (r2.Contains(value) && !PlayerInput.IgnoreMouseInterface)
						{
							player[myPlayer].mouseInterface = true;
							flag3 = true;
							if (mouseLeft && mouseLeftRelease)
							{
								player[myPlayer].enabledSuperCart = !player[myPlayer].enabledSuperCart;
								mouseLeftRelease = false;
								SoundEngine.PlaySound(12);
								if (netMode == 1)
								{
									NetMessage.SendData(4, -1, -1, null, myPlayer);
								}
							}
							num26 = ((!player[myPlayer].enabledSuperCart) ? 1 : 2);
						}
					}
					if (r.Contains(value) && !flag3 && !PlayerInput.IgnoreMouseInterface)
					{
						player[myPlayer].mouseInterface = true;
						armorHide = true;
						ItemSlot.Handle(inv, context, m);
					}
					ItemSlot.Draw(spriteBatch, inv, context, m, r.TopLeft());
					if (num25 != -1 && mouseItem.IsAir)
					{
						spriteBatch.Draw(value2, r2.TopLeft(), Microsoft.Xna.Framework.Color.White * 0.7f);
						if (num26 > 0)
						{
							ClearHoverItem();
							hoverItemName = Lang.inter[58 + num26].Value;
						}
					}
					if (flag2 && mouseItem.IsAir)
					{
						spriteBatch.Draw(value2, r2.TopLeft(), Microsoft.Xna.Framework.Color.White);
						if (num26 > 0)
						{
							ClearHoverItem();
							hoverItemName = Language.GetTextValue((num26 == 1) ? "GameUI.SuperCartDisabled" : "GameUI.SuperCartEnabled");
						}
					}
				}
			}
			num24 += 247;
			num23 += 8;
			int num27 = -1;
			int num28 = 0;
			int num29 = 3;
			int num30 = 260;
			if (screenHeight > 630 + num30 * (mapStyle == 1).ToInt())
			{
				num29++;
			}
			if (screenHeight > 680 + num30 * (mapStyle == 1).ToInt())
			{
				num29++;
			}
			if (screenHeight > 730 + num30 * (mapStyle == 1).ToInt())
			{
				num29++;
			}
			int num31 = 46;
			for (int n = 0; n < Player.maxBuffs; n++)
			{
				if (player[myPlayer].buffType[n] != 0)
				{
					int num32 = num28 / num29;
					int num33 = num28 % num29;
					Microsoft.Xna.Framework.Point point = new Microsoft.Xna.Framework.Point(num23 + num32 * -num31, num24 + num33 * num31);
					num27 = DrawBuffIcon(num27, n, point.X, point.Y);
					UILinkPointNavigator.SetPosition(9000 + num28, new Vector2(point.X + 30, point.Y + 30));
					num28++;
					if (buffAlpha[n] < 0.65f)
					{
						buffAlpha[n] = 0.65f;
					}
				}
			}
			UILinkPointNavigator.Shortcuts.BUFFS_DRAWN = num28;
			UILinkPointNavigator.Shortcuts.BUFFS_PER_COLUMN = num29;
			if (num27 >= 0)
			{
				int num34 = player[myPlayer].buffType[num27];
				if (num34 > 0)
				{
					string buffName = Lang.GetBuffName(num34);
					string buffTooltip = GetBuffTooltip(player[myPlayer], num34);
					if (num34 == 147)
					{
						bannerMouseOver = true;
					}
					if (meleeBuff[num34])
					{
						MouseTextHackZoom(buffName, -10, 0, buffTooltip);
					}
					else
					{
						MouseTextHackZoom(buffName, buffTooltip);
					}
				}
			}
		}
		else if (EquipPage == 1)
		{
			DrawNPCHousesInUI(num20);
		}
		else
		{
			int num35 = 4;
			if (mouseX > screenWidth - 64 - 28 && mouseX < (int)((float)(screenWidth - 64 - 28) + 56f * inventoryScale) && mouseY > num20 && mouseY < (int)((float)num20 + 448f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
			}
			float num36 = inventoryScale;
			int num37 = num19 - 1;
			bool flag4 = LocalPlayer.CanDemonHeartAccessoryBeShown();
			bool flag5 = LocalPlayer.CanMasterModeAccessoryBeShown();
			if (_settingsButtonIsPushedToSide)
			{
				num37--;
			}
			int num38 = num37 - 1;
			Microsoft.Xna.Framework.Color color = inventoryBack;
			Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(80, 80, 80, 80);
			DrawLoadoutButtons(num20, flag4, flag5);
			int num39 = -1;
			for (int num40 = 0; num40 < 10; num40++)
			{
				if ((num40 == 8 && !flag4) || (num40 == 9 && !flag5))
				{
					continue;
				}
				num39++;
				bool flag6 = LocalPlayer.IsItemSlotUnlockedAndUsable(num40);
				int num41 = screenWidth - 64 - 28;
				int num42 = (int)((float)num20 + (float)(num39 * 56) * inventoryScale);
				new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
				int num43 = screenWidth - 58;
				int num44 = (int)((float)(num20 - 2) + (float)(num39 * 56) * inventoryScale);
				int context2 = 8;
				if (num40 > 2)
				{
					num42 += num35;
					num44 += num35;
					context2 = 10;
				}
				if (num39 == num38 && !_achievementAdvisor.CanDrawAboveCoins)
				{
					_achievementAdvisor.DrawOneAchievement(spriteBatch, new Vector2(num41 - 10 - 47 - 47 - 14 - 14, num42 + 8), large: false);
					UILinkPointNavigator.SetPosition(1570, new Vector2(num41 - 10 - 47 - 47 - 14 - 14, num42 + 8) + new Vector2(20f) * inventoryScale);
				}
				if (num39 == num37)
				{
					DrawDefenseCounter(num41, num42);
				}
				Texture2D value3 = TextureAssets.InventoryTickOn.Value;
				if (player[myPlayer].hideVisibleAccessory[num40])
				{
					value3 = TextureAssets.InventoryTickOff.Value;
				}
				Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(num43, num44, value3.Width, value3.Height);
				int num45 = 0;
				if (num40 > 2 && rectangle.Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)) && !PlayerInput.IgnoreMouseInterface && mouseItem.IsAir)
				{
					player[myPlayer].mouseInterface = true;
					if (mouseLeft && mouseLeftRelease)
					{
						player[myPlayer].hideVisibleAccessory[num40] = !player[myPlayer].hideVisibleAccessory[num40];
						SoundEngine.PlaySound(12);
						if (netMode == 1)
						{
							NetMessage.SendData(4, -1, -1, null, myPlayer);
						}
					}
					num45 = ((!player[myPlayer].hideVisibleAccessory[num40]) ? 1 : 2);
				}
				else if (mouseX >= num41 && (float)mouseX <= (float)num41 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num42 && (float)mouseY <= (float)num42 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
				{
					armorHide = true;
					player[myPlayer].mouseInterface = true;
					ItemSlot.Handle(player[myPlayer].armor, context2, num40, flag6 || mouseItem.IsAir);
				}
				inventoryBack = (flag6 ? color : color2);
				ItemSlot.Draw(spriteBatch, player[myPlayer].armor, context2, num40, new Vector2(num41, num42));
				if (num40 > 2 && mouseItem.IsAir)
				{
					spriteBatch.Draw(value3, new Vector2(num43, num44), Microsoft.Xna.Framework.Color.White * 0.7f);
					if (num45 > 0)
					{
						ClearHoverItem();
						hoverItemName = Lang.inter[58 + num45].Value;
					}
				}
			}
			if (mouseX > screenWidth - 64 - 28 - 47 && mouseX < (int)((float)(screenWidth - 64 - 20 - 47) + 56f * inventoryScale) && mouseY > num20 && mouseY < (int)((float)num20 + 168f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
			}
			num39 = -1;
			for (int num46 = 10; num46 < 20; num46++)
			{
				if ((num46 != 18 || flag4) && (num46 != 19 || flag5))
				{
					num39++;
					bool flag7 = LocalPlayer.IsItemSlotUnlockedAndUsable(num46);
					int num47 = screenWidth - 64 - 28 - 47;
					int num48 = (int)((float)num20 + (float)(num39 * 56) * inventoryScale);
					new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
					if (num46 > 12)
					{
						num48 += num35;
					}
					int context3 = 9;
					if (num46 > 12)
					{
						context3 = 11;
					}
					if (mouseX >= num47 && (float)mouseX <= (float)num47 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num48 && (float)mouseY <= (float)num48 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
					{
						player[myPlayer].mouseInterface = true;
						armorHide = true;
						ItemSlot.Handle(player[myPlayer].armor, context3, num46, flag7 || mouseItem.IsAir);
					}
					inventoryBack = (flag7 ? color : color2);
					ItemSlot.Draw(spriteBatch, player[myPlayer].armor, context3, num46, new Vector2(num47, num48));
				}
			}
			if (mouseX > screenWidth - 64 - 28 - 47 && mouseX < (int)((float)(screenWidth - 64 - 20 - 47) + 56f * inventoryScale) && mouseY > num20 && mouseY < (int)((float)num20 + 168f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
			}
			num39 = -1;
			for (int num49 = 0; num49 < 10; num49++)
			{
				if ((num49 != 8 || flag4) && (num49 != 9 || flag5))
				{
					num39++;
					bool flag8 = LocalPlayer.IsItemSlotUnlockedAndUsable(num49);
					int num50 = screenWidth - 64 - 28 - 47 - 47;
					int num51 = (int)((float)num20 + (float)(num39 * 56) * inventoryScale);
					new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
					if (num49 > 2)
					{
						num51 += num35;
					}
					if (mouseX >= num50 && (float)mouseX <= (float)num50 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num51 && (float)mouseY <= (float)num51 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
					{
						player[myPlayer].mouseInterface = true;
						armorHide = true;
						ItemSlot.Handle(player[myPlayer].dye, 12, num49, flag8 || mouseItem.IsAir);
					}
					inventoryBack = (flag8 ? color : color2);
					ItemSlot.Draw(spriteBatch, player[myPlayer].dye, 12, num49, new Vector2(num50, num51));
				}
			}
			inventoryBack = color;
			inventoryScale = num36;
		}
		int num52 = (screenHeight - 600) / 2;
		int middleY = (int)((float)screenHeight / 600f * 250f);
		if (screenHeight < 700)
		{
			num52 = (screenHeight - 508) / 2;
			middleY = (int)((float)screenHeight / 600f * 200f);
		}
		else if (screenHeight < 850)
		{
			middleY = (int)((float)screenHeight / 600f * 225f);
		}
		if (craftingHide)
		{
			craftingAlpha -= 0.1f;
			if (craftingAlpha < 0f)
			{
				craftingAlpha = 0f;
			}
		}
		else
		{
			craftingAlpha += 0.025f;
			if (craftingAlpha > 1f)
			{
				craftingAlpha = 1f;
			}
		}
		Microsoft.Xna.Framework.Color craftingTipColor = new Microsoft.Xna.Framework.Color((byte)((float)(int)mouseTextColor * craftingAlpha), (byte)((float)(int)mouseTextColor * craftingAlpha), (byte)((float)(int)mouseTextColor * craftingAlpha), (byte)((float)(int)mouseTextColor * craftingAlpha));
		craftingHide = false;
		if (InReforgeMenu)
		{
			if (mouseReforge)
			{
				if (reforgeScale < 1f)
				{
					reforgeScale += 0.02f;
				}
			}
			else
			{
				reforgeCooldown = 0;
				if (reforgeScale > 1f)
				{
					reforgeScale -= 0.02f;
				}
			}
			if (player[myPlayer].chest != -1 || npcShop != 0 || player[myPlayer].talkNPC == -1 || InGuideCraftMenu)
			{
				InReforgeMenu = false;
				player[myPlayer].dropItemCheck();
			}
			else
			{
				int num53 = 50;
				int num54 = 270;
				string text = Lang.inter[46].Value + ": ";
				if (reforgeItem.type > 0)
				{
					long num55 = (long)reforgeItem.value * (long)reforgeItem.stack;
					if (player[myPlayer].discountAvailable)
					{
						num55 = (long)((double)num55 * 0.8);
					}
					num55 = (long)((float)num55 * player[myPlayer].currentShoppingSettings.PriceAdjustment);
					num55 /= 3;
					string text2 = "";
					long num56 = 0L;
					long num57 = 0L;
					long num58 = 0L;
					long num59 = 0L;
					long num60 = num55;
					if (num60 < 1)
					{
						num60 = 1L;
					}
					if (num60 >= 1000000)
					{
						num56 = num60 / 1000000;
						num60 -= num56 * 1000000;
					}
					if (num60 >= 10000)
					{
						num57 = num60 / 10000;
						num60 -= num57 * 10000;
					}
					if (num60 >= 100)
					{
						num58 = num60 / 100;
						num60 -= num58 * 100;
					}
					if (num60 >= 1)
					{
						num59 = num60;
					}
					if (num56 > 0)
					{
						text2 = text2 + "[c/" + Colors.AlphaDarken(Colors.CoinPlatinum).Hex3() + ":" + num56 + " " + Lang.inter[15].Value + "] ";
					}
					if (num57 > 0)
					{
						text2 = text2 + "[c/" + Colors.AlphaDarken(Colors.CoinGold).Hex3() + ":" + num57 + " " + Lang.inter[16].Value + "] ";
					}
					if (num58 > 0)
					{
						text2 = text2 + "[c/" + Colors.AlphaDarken(Colors.CoinSilver).Hex3() + ":" + num58 + " " + Lang.inter[17].Value + "] ";
					}
					if (num59 > 0)
					{
						text2 = text2 + "[c/" + Colors.AlphaDarken(Colors.CoinCopper).Hex3() + ":" + num59 + " " + Lang.inter[18].Value + "] ";
					}
					ItemSlot.DrawSavings(spriteBatch, num53 + 130, invBottom, horizontal: true);
					ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, text2, new Vector2((float)(num53 + 50) + FontAssets.MouseText.Value.MeasureString(text).X, num54), Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, Vector2.One);
					int num61 = num53 + 70;
					int num62 = num54 + 40;
					bool num63 = mouseX > num61 - 15 && mouseX < num61 + 15 && mouseY > num62 - 15 && mouseY < num62 + 15 && !PlayerInput.IgnoreMouseInterface;
					Texture2D value4 = TextureAssets.Reforge[0].Value;
					if (num63)
					{
						value4 = TextureAssets.Reforge[1].Value;
					}
					spriteBatch.Draw(value4, new Vector2(num61, num62), null, Microsoft.Xna.Framework.Color.White, 0f, value4.Size() / 2f, reforgeScale, SpriteEffects.None, 0f);
					UILinkPointNavigator.SetPosition(304, new Vector2(num61, num62) + value4.Size() / 4f);
					if (num63)
					{
						hoverItemName = Lang.inter[19].Value;
						if (!mouseReforge)
						{
							SoundEngine.PlaySound(12);
						}
						mouseReforge = true;
						player[myPlayer].mouseInterface = true;
						if (mouseLeftRelease && mouseLeft && reforgeCooldown <= 0 && player[myPlayer].BuyItem(num55))
						{
							ReforgeItemInReforgeSlot();
						}
					}
					else
					{
						mouseReforge = false;
					}
				}
				else
				{
					text = Lang.inter[20].Value;
				}
				ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, text, new Vector2(num53 + 50, num54), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, Vector2.Zero, Vector2.One);
				if (mouseX >= num53 && (float)mouseX <= (float)num53 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num54 && (float)mouseY <= (float)num54 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
				{
					craftingHide = true;
					player[myPlayer].mouseInterface = true;
					ItemSlot.Handle(ref reforgeItem, 5);
				}
				ItemSlot.Draw(spriteBatch, ref reforgeItem, 5, new Vector2(num53, num54));
			}
		}
		else if (InGuideCraftMenu)
		{
			if (player[myPlayer].chest != -1 || npcShop != 0 || player[myPlayer].talkNPC == -1 || InReforgeMenu)
			{
				InGuideCraftMenu = false;
				NewCraftingUI.Close(quiet: true, returnToInventory: true);
				player[myPlayer].dropItemCheck();
			}
			else if (!NewCraftingUI.Visible)
			{
				int num64 = 73;
				int num65 = 331 + num52;
				DrawGuideCraftText(num64, num65);
				if (mouseX >= num64 && (float)mouseX <= (float)num64 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num65 && (float)mouseY <= (float)num65 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
				{
					craftingHide = true;
					player[myPlayer].mouseInterface = true;
					ItemSlot.Handle(ref guideItem, 7);
				}
				ItemSlot.Draw(spriteBatch, ref guideItem, 7, new Vector2(num64, num65));
			}
		}
		CreativeMenu.Draw(spriteBatch);
		bool flag9 = CreativeMenu.Enabled && !CreativeMenu.Blocked;
		if (NewCraftingUI.Visible)
		{
			NewCraftingUI.DrawUI(spriteBatch);
		}
		else if (!InReforgeMenu && !LocalPlayer.tileEntityAnchor.InUse && !flag9)
		{
			if (InPipCrafting)
			{
				craftingUI.DrawRecipesList(spriteBatch, num52, middleY, craftingTipColor);
			}
			if (InPipBanner)
			{
				bannerUI.DrawBannersList(spriteBatch, num52, middleY, craftingTipColor);
			}
			if (!InGuideCraftMenu && LocalPlayer.chest < 0 && (PlayerInput.UsingGamepad || PlayerInput.SteamDeckIsUsed))
			{
				num52 -= 132;
			}
			int num66 = 94;
			int num67 = (InGuideCraftMenu ? 300 : 450) + num52;
			CraftingUI.DrawGridToggle(spriteBatch, num66, num67, 11001);
			if (!InGuideCraftMenu && InPipCrafting)
			{
				CraftingUI.DrawCraftFromNearbyChestsToggle(spriteBatch, num66, num67 + 40, 11003);
			}
			if (!InGuideCraftMenu)
			{
				bannerUI.DrawGridToggle(spriteBatch, num52);
			}
		}
		if (PipsUseGrid && !flag9)
		{
			if (InPipCrafting)
			{
				craftingUI.DrawRecipesGrid(spriteBatch);
			}
			if (InPipBanner)
			{
				bannerUI.DrawBannersGrid(spriteBatch);
			}
		}
		Vector2 vector2 = FontAssets.MouseText.Value.MeasureString("Coins");
		Vector2 vector3 = FontAssets.MouseText.Value.MeasureString(Lang.inter[26].Value);
		float num68 = vector2.X / vector3.X;
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, Lang.inter[26].Value, new Vector2(496f, 84f + (vector2.Y - vector2.Y * num68) / 2f), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, default(Vector2), 0.75f * num68, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		inventoryScale = 0.6f;
		for (int num69 = 0; num69 < 4; num69++)
		{
			int num70 = 497;
			int num71 = (int)(85f + (float)(num69 * 56) * inventoryScale + 20f);
			int slot = num69 + 50;
			new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
			if (mouseX >= num70 && (float)mouseX <= (float)num70 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num71 && (float)mouseY <= (float)num71 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
				ItemSlot.Handle(player[myPlayer].inventory, 1, slot);
			}
			ItemSlot.Draw(spriteBatch, player[myPlayer].inventory, 1, slot, new Vector2(num70, num71));
		}
		Vector2 vector4 = FontAssets.MouseText.Value.MeasureString("Ammo");
		Vector2 vector5 = FontAssets.MouseText.Value.MeasureString(Lang.inter[27].Value);
		float num72 = vector4.X / vector5.X;
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, Lang.inter[27].Value, new Vector2(532f, 84f + (vector4.Y - vector4.Y * num72) / 2f), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, default(Vector2), 0.75f * num72, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		inventoryScale = 0.6f;
		for (int num73 = 0; num73 < 4; num73++)
		{
			int num74 = 534;
			int num75 = (int)(85f + (float)(num73 * 56) * inventoryScale + 20f);
			int slot2 = 54 + num73;
			new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
			if (mouseX >= num74 && (float)mouseX <= (float)num74 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num75 && (float)mouseY <= (float)num75 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
				ItemSlot.Handle(player[myPlayer].inventory, 2, slot2);
			}
			ItemSlot.Draw(spriteBatch, player[myPlayer].inventory, 2, slot2, new Vector2(num74, num75));
		}
		if (npcShop > 0 && (!playerInventory || player[myPlayer].talkNPC == -1))
		{
			SetNPCShopIndex(0);
		}
		if (npcShop > 0 && !PipsUseGrid)
		{
			Utils.DrawBorderStringFourWay(spriteBatch, FontAssets.MouseText.Value, Lang.inter[28].Value, 504f, invBottom, Microsoft.Xna.Framework.Color.White * ((float)(int)mouseTextColor / 255f), Microsoft.Xna.Framework.Color.Black, Vector2.Zero);
			ItemSlot.DrawSavings(spriteBatch, 504f, invBottom);
			Texture2D value5 = TextureAssets.NPCHappiness.Value;
			float priceAdjustment = LocalPlayer.currentShoppingSettings.PriceAdjustment;
			int frameX = ((!(priceAdjustment <= 0.82f)) ? ((priceAdjustment <= 1f) ? 1 : ((!(priceAdjustment <= 1.1f)) ? 3 : 2)) : 0);
			Microsoft.Xna.Framework.Rectangle rectangle2 = value5.Frame(4, 1, frameX);
			Vector2 position = new Vector2(504 + shopHappinessIconOffsetX, invBottom + shopHappinessIconOffsetY);
			spriteBatch.Draw(value5, position, rectangle2, Microsoft.Xna.Framework.Color.White, 0f, rectangle2.Size() / 2f, 1f, SpriteEffects.None, 0f);
			string text3 = priceAdjustment.ToString("P0");
			Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
			Utils.DrawBorderStringFourWay(spriteBatch, FontAssets.MouseText.Value, text3, 504 + shopHappinessTextOffsetX, invBottom + shopHappinessTextOffsetY, white * ((float)(int)mouseTextColor / 255f), Microsoft.Xna.Framework.Color.Black, Vector2.Zero);
			inventoryScale = 0.755f;
			if (mouseX > 73 && mouseX < (int)(73f + 560f * inventoryScale) && mouseY > invBottom && mouseY < (int)((float)invBottom + 224f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
			}
			for (int num76 = 0; num76 < 10; num76++)
			{
				for (int num77 = 0; num77 < 4; num77++)
				{
					int num78 = (int)(73f + (float)(num76 * 56) * inventoryScale);
					int num79 = (int)((float)invBottom + (float)(num77 * 56) * inventoryScale);
					int slot3 = num76 + num77 * 10;
					new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
					if (mouseX >= num78 && (float)mouseX <= (float)num78 + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num79 && (float)mouseY <= (float)num79 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
					{
						player[myPlayer].mouseInterface = true;
						ItemSlot.Handle(shop[npcShop].item, 15, slot3);
					}
					ItemSlot.Draw(spriteBatch, shop[npcShop].item, 15, slot3, new Vector2(num78, num79));
				}
			}
		}
		if (player[myPlayer].chest > -1 && !tileContainer[tile[player[myPlayer].chestX, player[myPlayer].chestY].type])
		{
			player[myPlayer].chest = -1;
		}
		int offsetDown = 0;
		UIVirtualKeyboard.ShouldHideText = !PlayerInput.SettingsForUI.ShowGamepadHints;
		if (!PlayerInput.UsingGamepad)
		{
			offsetDown = 9999;
		}
		UIVirtualKeyboard.OffsetDown = offsetDown;
		ChestUI.Draw(spriteBatch);
		LocalPlayer.tileEntityAnchor.GetTileEntity()?.OnInventoryDraw(LocalPlayer, spriteBatch);
		if (player[myPlayer].chest == -1 && npcShop == 0)
		{
			int num80 = 0;
			int num81 = 498;
			int num82 = 244;
			int num83 = TextureAssets.ChestStack[num80].Width();
			int num84 = TextureAssets.ChestStack[num80].Height();
			UILinkPointNavigator.SetPosition(301, new Vector2((float)num81 + (float)num83 * 0.75f, (float)num82 + (float)num84 * 0.75f));
			bool state2 = false;
			if (mouseX >= num81 && mouseX <= num81 + num83 && mouseY >= num82 && mouseY <= num82 + num84 && !PlayerInput.IgnoreMouseInterface && !LocalPlayerHasPendingInventoryActions())
			{
				num80 = 1;
				if (mouseLeft && mouseLeftRelease)
				{
					mouseLeftRelease = false;
					player[myPlayer].QuickStackAllChests();
					SoundEngine.PlaySound(12);
				}
				if (mouseRight && mouseRightRelease)
				{
					mouseRightRelease = false;
					Player.Settings.CycleQuickStackMode();
					SoundEngine.PlaySound(10);
					SaveSettings();
				}
				state2 = true;
				player[myPlayer].mouseInterface = true;
				if (!mouseText)
				{
					string key = ((Player.Settings.StackToChestsPreferredMode == Player.Settings.StackToNearbyChestsMode.QuickStackToNearbyChests) ? "GameUI.QuickStackToNearby" : "GameUI.SmartStackToNearby");
					MouseTextNoOverride(Language.GetTextValue(key), 0, 0);
				}
			}
			DoStatefulTickSound(ref allChestStackHover, state2);
			num80 += (int)Player.Settings.StackToChestsPreferredMode * 2;
			spriteBatch.Draw(TextureAssets.ChestStack[num80].Value, new Vector2(num81, num82), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.ChestStack[num80].Width(), TextureAssets.ChestStack[num80].Height()), Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
		}
		if (player[myPlayer].chest == -1 && npcShop == 0)
		{
			int num85 = 0;
			int num86 = 534;
			int num87 = 244;
			int num88 = 30;
			int num89 = 30;
			UILinkPointNavigator.SetPosition(302, new Vector2((float)num86 + (float)num88 * 0.75f, (float)num87 + (float)num89 * 0.75f));
			bool state3 = false;
			if (mouseX >= num86 && mouseX <= num86 + num88 && mouseY >= num87 && mouseY <= num87 + num89 && !PlayerInput.IgnoreMouseInterface && !LocalPlayerHasPendingInventoryActions())
			{
				num85 = 1;
				state3 = true;
				player[myPlayer].mouseInterface = true;
				if (mouseLeft && mouseLeftRelease)
				{
					mouseLeftRelease = false;
					ItemSorting.SortInventory();
					SoundEngine.PlaySound(12);
				}
			}
			DoStatefulTickSound(ref inventorySortMouseOver, state3);
			Texture2D value6 = TextureAssets.InventorySort[inventorySortMouseOver ? 1 : 0].Value;
			spriteBatch.Draw(value6, new Vector2(num86, num87), null, Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			if (!mouseText && num85 == 1)
			{
				MouseTextNoOverride(Language.GetTextValue("GameUI.SortInventory"), 0, 0);
			}
		}
		ParticleSystem_OverInventory.Settings.AnchorPosition = Vector2.Zero;
		ParticleSystem_OverInventory.Draw(spriteBatch);
	}

	private static void ReforgeItemInReforgeSlot()
	{
		reforgeItem.ResetPrefix();
		reforgeItem.Prefix(-2, out var rolledPrefixIsTopTier);
		PopupText.NewText(rolledPrefixIsTopTier ? PopupTextContext.ItemReforge_Best : PopupTextContext.ItemReforge, reforgeItem, LocalPlayer.Center, reforgeItem.stack, noStack: true);
		if (rolledPrefixIsTopTier)
		{
			SoundEngine.PlaySound(SoundID.BestReforge);
			reforgeCooldown = 60;
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.RainbowRodHit, new ParticleOrchestraSettings
			{
				PositionInWorld = LocalPlayer.MountedCenter + new Vector2(0f, -16f * LocalPlayer.gravDir),
				MovementVector = new Vector2(48f, 0f) + rand.NextVector2Circular(16f, 16f)
			}, myPlayer);
			ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.RainbowRodHit, new ParticleOrchestraSettings
			{
				PositionInWorld = LocalPlayer.MountedCenter + new Vector2(0f, -16f * LocalPlayer.gravDir),
				MovementVector = new Vector2(0f, 16f) + rand.NextVector2Circular(5f, 5f)
			}, myPlayer);
			for (int i = 0; i < 3; i++)
			{
				ParticleOrchestrator.RequestParticleSpawn(clientOnly: true, ParticleOrchestraType.BestReforge, new ParticleOrchestraSettings
				{
					PositionInWorld = LocalPlayer.MountedCenter + rand.NextVector2Circular(16f, 16f)
				}, myPlayer);
			}
		}
		else
		{
			SoundEngine.PlaySound(SoundID.Item37);
		}
	}

	private static void DrawLoadoutButtons(int inventoryTop, bool demonHeartSlotAvailable, bool masterModeSlotAvailable)
	{
		int num = 10;
		Player player = Main.player[myPlayer];
		if (!demonHeartSlotAvailable)
		{
			num--;
		}
		if (!masterModeSlotAvailable)
		{
			num--;
		}
		int x = screenWidth - 58 + 14;
		int num2 = (int)((float)(inventoryTop - 2) + 0f * inventoryScale);
		int num3 = (int)((float)(inventoryTop - 2) + (float)(num * 56) * inventoryScale);
		Texture2D value = TextureAssets.Extra[259].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(x, num2 + 2, 4, num3 - num2);
		ItemSlot.GetLoadoutColor(player.CurrentLoadoutIndex);
		int num4 = player.Loadouts.Length;
		int num5 = 32;
		int num6 = 4;
		int state = -1;
		_ = FontAssets.ItemStack.Value;
		for (int i = 0; i < num4; i++)
		{
			Microsoft.Xna.Framework.Rectangle rectangle2 = new Microsoft.Xna.Framework.Rectangle(rectangle.X + rectangle.Width, rectangle.Y + (num5 + num6) * i, 32, num5);
			Microsoft.Xna.Framework.Color loadoutColor = ItemSlot.GetLoadoutColor(i);
			_ = player.Loadouts[i];
			int frameX = ((i == player.CurrentLoadoutIndex) ? 1 : 0);
			bool flag = false;
			if (rectangle2.Contains(MouseScreen.ToPoint()) && !PlayerInput.IgnoreMouseInterface)
			{
				flag = true;
				loadoutColor = Microsoft.Xna.Framework.Color.Lerp(loadoutColor, Microsoft.Xna.Framework.Color.White, 0.8f);
				player.mouseInterface = true;
				if (!mouseText)
				{
					instance.MouseText(Language.GetTextValue("UI.Loadout" + (i + 1)), 0, 0);
					mouseText = true;
				}
				if (mouseLeft && mouseLeftRelease)
				{
					player.TrySwitchingLoadout(i);
				}
				state = i;
			}
			Microsoft.Xna.Framework.Rectangle rectangle3 = value.Frame(3, 3, frameX, i);
			spriteBatch.Draw(value, rectangle2.Center.ToVector2(), rectangle3, Microsoft.Xna.Framework.Color.White, 0f, rectangle3.Size() / 2f, 1f, SpriteEffects.None, 0f);
			if (flag)
			{
				rectangle3 = value.Frame(3, 3, 2, i);
				spriteBatch.Draw(value, rectangle2.Center.ToVector2(), rectangle3, OurFavoriteColor, 0f, rectangle3.Size() / 2f, 1f, SpriteEffects.None, 0f);
			}
			UILinkPointNavigator.SetPosition(312 + i, rectangle2.Center.ToVector2());
		}
		DoStatefulTickSound(ref loadoutMouseOver, state);
	}

	private void DrawNPCHousesInUI(int inventoryTop)
	{
		if (mouseX > screenWidth - 64 - 28 && mouseX < (int)((float)(screenWidth - 64 - 28) + 56f * inventoryScale) && mouseY > inventoryTop && mouseY < (int)((float)inventoryTop + 448f * inventoryScale) && !PlayerInput.IgnoreMouseInterface)
		{
			player[myPlayer].mouseInterface = true;
		}
		int num = 0;
		string text = "";
		int num2 = 0;
		int num3 = 0;
		_npcTypesThatAlreadyDrewAHead.Clear();
		for (int i = 0; i < _npcIndexWhoHoldsHeadIndex.Length; i++)
		{
			_npcIndexWhoHoldsHeadIndex[i] = -1;
		}
		for (int j = 0; j < maxNPCs; j++)
		{
			if (npc[j].active && !_npcTypesThatAlreadyDrewAHead.Contains(npc[j].type))
			{
				int headIndexSafe = TownNPCProfiles.GetHeadIndexSafe(npc[j]);
				if (headIndexSafe > 0 && headIndexSafe <= NPCHeadID.Count && !NPCHeadID.Sets.CannotBeDrawnInHousingUI[headIndexSafe] && _npcIndexWhoHoldsHeadIndex[headIndexSafe] == -1)
				{
					_npcIndexWhoHoldsHeadIndex[headIndexSafe] = j;
					_npcTypesThatAlreadyDrewAHead.Add(npc[j].type);
				}
			}
		}
		hidePVPAndTeamIcons = false;
		int num4 = 0;
		int num5 = 0;
		UILinkPointNavigator.Shortcuts.NPCS_IconsPerColumn = 1;
		UILinkPointNavigator.Shortcuts.NPCS_SelectedNPC = -2;
		Vector2 vector = TextureAssets.InventoryBack.Size();
		int[] headListOrder = NPCHeadID.Sets.HeadListOrder;
		foreach (int num6 in headListOrder)
		{
			if (num6 != 0 && _npcIndexWhoHoldsHeadIndex[num6] == -1)
			{
				continue;
			}
			int num7 = _npcIndexWhoHoldsHeadIndex[num6];
			int num8 = screenWidth - 64 - 28 + num3;
			int num9 = (int)((float)inventoryTop + (float)(num * 56) * inventoryScale) + num2;
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(100, 100, 100, 100);
			if (num9 > screenHeight - 80)
			{
				num3 -= 48;
				num2 -= num9 - inventoryTop;
				num8 = screenWidth - 64 - 28 + num3;
				num9 = (int)((float)inventoryTop + (float)(num * 56) * inventoryScale) + num2;
				UILinkPointNavigator.Shortcuts.NPCS_IconsPerColumn = num5;
				if (num3 <= -144)
				{
					hidePVPAndTeamIcons = true;
				}
				num5 = 0;
			}
			if (mouseX >= num8 && (float)mouseX <= (float)num8 + (float)(int)vector.X * inventoryScale && mouseY >= num9 && (float)mouseY <= (float)num9 + (float)(int)vector.Y * inventoryScale)
			{
				mouseText = true;
				text = ((num6 != 0) ? npc[num7].FullName : Lang.inter[8].Value);
				UILinkPointNavigator.Shortcuts.NPCS_SelectedNPC = num7;
				if (!PlayerInput.IgnoreMouseInterface)
				{
					player[myPlayer].mouseInterface = true;
					if (mouseLeftRelease && mouseLeft && !PlayerInput.UsingGamepadUI && mouseItem.type == 0)
					{
						SoundEngine.PlaySound(12);
						if (num6 == 0)
						{
							SetMouseNPC_ToHousingQuery();
						}
						else
						{
							SetMouseNPC(num7, npc[num7].type);
						}
						mouseLeftRelease = false;
					}
				}
			}
			UILinkPointNavigator.SetPosition(600 + num, new Vector2(num8, num9) + vector * 0.75f);
			Texture2D value = TextureAssets.InventoryBack11.Value;
			Microsoft.Xna.Framework.Color white = inventoryBack;
			if (UILinkPointNavigator.CurrentPoint - 600 == num)
			{
				value = TextureAssets.InventoryBack14.Value;
				white = Microsoft.Xna.Framework.Color.White;
			}
			spriteBatch.Draw(value, new Vector2(num8, num9), null, white, 0f, default(Vector2), inventoryScale, SpriteEffects.None, 0f);
			color = Microsoft.Xna.Framework.Color.White;
			Texture2D value2 = TextureAssets.NpcHead[num6].Value;
			Vector2 vector2 = value2.Size();
			float scale = 1f;
			float num10 = Math.Max(vector2.X, vector2.Y);
			if (num10 > 36f)
			{
				scale = 36f / num10;
			}
			spriteBatch.Draw(value2, new Vector2((float)num8 + 26f * inventoryScale, (float)num9 + 26f * inventoryScale), null, color, 0f, vector2 / 2f, scale, SpriteEffects.None, 0f);
			num++;
			num4++;
			num5++;
		}
		if (UILinkPointNavigator.Shortcuts.NPCS_IconsPerColumn < num5)
		{
			UILinkPointNavigator.Shortcuts.NPCS_IconsPerColumn = num5;
		}
		UILinkPointNavigator.Shortcuts.NPCS_IconsTotal = num4;
		if (text != "" && mouseItem.type == 0)
		{
			MouseText(text, 0, 0);
		}
		PlayerInput.UpdateHousingCursor();
	}

	private static void DrawDefenseCounter(int inventoryX, int inventoryY)
	{
		Vector2 vector = new Vector2(inventoryX - 10 - 47 - 47 - 14, (float)inventoryY + (float)TextureAssets.InventoryBack.Height() * 0.5f);
		Texture2D value = TextureAssets.Extra[58].Value;
		int num = 0;
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Transparent;
		float num2 = 3f;
		int statDefense = player[myPlayer].statDefense;
		double num3 = 0.5;
		if (masterMode)
		{
			num3 = 1.0;
		}
		else if (expertMode)
		{
			num3 = 0.75;
		}
		int num4 = (int)Math.Ceiling((double)statDefense * num3);
		float difficulty = Difficulty;
		if (difficulty >= GameDifficultyLevel.Expert)
		{
			num = 1;
			color = new Microsoft.Xna.Framework.Color((byte)DiscoR, (byte)DiscoG, (byte)DiscoB);
		}
		if (difficulty >= GameDifficultyLevel.Master)
		{
			num = 2;
			float num5 = 6f;
			color = new Microsoft.Xna.Framework.Color(255, (byte)(((float)Math.Sin(GlobalTimeWrappedHourly % num5 / num5 * ((float)Math.PI * 2f)) * 0.5f + 0.5f) * 120f), 0);
		}
		if (num == 0 || statDefense == 0)
		{
			color = Microsoft.Xna.Framework.Color.Transparent;
		}
		color *= Utils.Remap(MathHelper.Clamp((float)Math.Sin(GlobalTimeWrappedHourly % num2 / num2 * ((float)Math.PI * 2f)), 0f, 1f), 0f, 1f, 0.4f, 1f);
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(3, 2, num);
		Microsoft.Xna.Framework.Rectangle value2 = value.Frame(3, 2, num, 1);
		Vector2 origin = rectangle.Size() / 2f;
		spriteBatch.Draw(value, vector, rectangle, Microsoft.Xna.Framework.Color.White, 0f, origin, inventoryScale, SpriteEffects.None, 0f);
		if (color != Microsoft.Xna.Framework.Color.Transparent)
		{
			spriteBatch.Draw(value, vector, value2, color, 0f, origin, inventoryScale, SpriteEffects.None, 0f);
		}
		string text = statDefense.ToString();
		Vector2 vector2 = FontAssets.MouseText.Value.MeasureString(text);
		Vector2 vector3 = new Vector2(0f, 2f) * inventoryScale;
		ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, text, vector - vector2 * 0.5f * inventoryScale + vector3, Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, new Vector2(inventoryScale));
		if (Utils.CenteredRectangle(vector, rectangle.Size()).Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)) && !PlayerInput.IgnoreMouseInterface)
		{
			player[myPlayer].mouseInterface = true;
			string text2 = text + " " + Lang.inter[10].Value;
			text2 = text2 + "\n" + Language.GetTextValue("UI.DefenseDamageReduction", num4);
			if (difficulty >= GameDifficultyLevel.Legendary)
			{
				text2 = text2 + "\n" + Language.GetTextValue("UI.Legendary");
			}
			else if (difficulty >= GameDifficultyLevel.Master)
			{
				text2 = text2 + "\n" + Language.GetTextValue("UI.Master");
			}
			else if (difficulty >= GameDifficultyLevel.Expert)
			{
				text2 = text2 + "\n" + Language.GetTextValue("UI.Expert");
			}
			if (!string.IsNullOrEmpty(text2))
			{
				hoverItemName = text2;
			}
		}
		UILinkPointNavigator.SetPosition(1557, vector + rectangle.Size() * inventoryScale / 4f);
	}

	public static void DrawGuideCraftText(int inventoryX, int inventoryY)
	{
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
		Vector2 vector = new Vector2(inventoryX + 50, inventoryY + 12);
		DynamicSpriteFont value = FontAssets.MouseText.Value;
		if (guideItem.IsAir)
		{
			string value2 = Lang.inter[24].Value;
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, value, value2, vector, color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
			return;
		}
		string text = Lang.inter[21].Value + " " + guideItem.Name;
		string recipeRequirementsText = GetRecipeRequirementsText(recipe[availableRecipe[focusRecipe]], explicitNone: true);
		vector.Y -= 14f;
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, value, text, vector, color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		Vector2 vector2 = vector + new Vector2(0f, 26f);
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, value, recipeRequirementsText, vector2, color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
	}

	public static string GetRecipeRequirementsText(Recipe recipe, bool explicitNone)
	{
		_requiredObjecsForCraftingText.Clear();
		if (recipe.requiredTile >= 0)
		{
			_requiredObjecsForCraftingText.Add(Recipe.GetRequiredTileName(recipe.requiredTile));
		}
		if (recipe.needWater)
		{
			_requiredObjecsForCraftingText.Add(Lang.inter[53].Value);
		}
		if (recipe.needHoney)
		{
			_requiredObjecsForCraftingText.Add(Lang.inter[58].Value);
		}
		if (recipe.needLava)
		{
			_requiredObjecsForCraftingText.Add(Lang.inter[56].Value);
		}
		if (recipe.needSnowBiome)
		{
			_requiredObjecsForCraftingText.Add(Lang.inter[123].Value);
		}
		if (recipe.needGraveyardBiome)
		{
			_requiredObjecsForCraftingText.Add(Lang.inter[124].Value);
		}
		if (recipe.needTorchGodsFavor)
		{
			_requiredObjecsForCraftingText.Add(Lang.inter[125].Value);
		}
		if (explicitNone && _requiredObjecsForCraftingText.Count == 0)
		{
			string value = Lang.inter[23].Value;
			_requiredObjecsForCraftingText.Add(value);
		}
		string value2 = Lang.inter[22].Value;
		string text = string.Join(", ", _requiredObjecsForCraftingText);
		return value2 + " " + text;
	}

	public static void LockCraftingForThisCraftClickDuration()
	{
		_preventCraftingBecauseClickWasUsedToChangeFocusedRecipe = true;
	}

	public static bool TryingToBulkCraft()
	{
		return ItemSlot.ShiftInUse;
	}

	public static void HoverOverCraftingItemButton(int recipeIndex)
	{
		Recipe recipe = Main.recipe[availableRecipe[recipeIndex]];
		player[myPlayer].mouseInterface = true;
		bool flag = (mouseLeftRelease && mouseLeft) || (mouseRightRelease && mouseRight);
		bool flag2 = mouseLeft || mouseRight;
		craftingHide = true;
		HoverItem = recipe.createItem.Clone();
		HoverItem.tooltipSlot = 0;
		ItemSlot.MouseHover(22);
		if (ItemSlot.HoverOverrideClick(recipe.createItem, 22))
		{
			_preventCraftingBecauseClickWasUsedToChangeFocusedRecipe = true;
		}
		else if (focusRecipe == recipeIndex && guideItem.IsAir)
		{
			bool flag3 = !LocalPlayer.UsingOrReusingItem && !player[myPlayer].IsLockedFromCrafting() && !_preventCraftingBecauseClickWasUsedToChangeFocusedRecipe;
			bool num = _currentRecipeBeingCrafted != -1 && _currentRecipeBeingCrafted != availableRecipe[recipeIndex];
			bool flag4 = _currentRecipeBeingCrafted != -1 && Main.recipe[_currentRecipeBeingCrafted].createItem.maxStack == 1;
			bool flag5 = num || flag4;
			int num2 = superFastStack + 1;
			if (ItemSlot.ShiftInUse)
			{
				num2 *= 10;
			}
			if (flag2 && !flag5 && flag3 && stackSplit <= 1)
			{
				bool usingGamepad = PlayerInput.UsingGamepad;
				bool movedAnItemToAllowCrafting;
				bool num3 = TryAllowingToCraftRecipe(recipe, usingGamepad, out movedAnItemToAllowCrafting);
				if (movedAnItemToAllowCrafting)
				{
					_preventCraftingBecauseClickWasUsedToChangeFocusedRecipe = true;
				}
				if (num3 && !movedAnItemToAllowCrafting)
				{
					if (_currentRecipeBeingCrafted == -1)
					{
						_currentRecipeBeingCrafted = availableRecipe[recipeIndex];
					}
					ItemSlot.RefreshStackSplitCooldown();
					CraftingRequests.CraftItem(recipe, num2);
				}
			}
		}
		else if (flag)
		{
			focusRecipe = recipeIndex;
			stackSplit = 15;
			_preventCraftingBecauseClickWasUsedToChangeFocusedRecipe = true;
			SoundEngine.PlaySound(12);
		}
		if (!flag2)
		{
			_preventCraftingBecauseClickWasUsedToChangeFocusedRecipe = false;
			_currentRecipeBeingCrafted = -1;
		}
	}

	public static bool CursorHasSpaceToCraftRecipe(Recipe currentRecipe)
	{
		bool movedAnItemToAllowCrafting;
		return TryAllowingToCraftRecipe(currentRecipe, tryFittingItemInInventoryToAllowCrafting: false, out movedAnItemToAllowCrafting);
	}

	public static bool TryAllowingToCraftRecipe(Recipe currentRecipe, bool tryFittingItemInInventoryToAllowCrafting, out bool movedAnItemToAllowCrafting)
	{
		movedAnItemToAllowCrafting = false;
		Item item = mouseItem;
		bool flag = false;
		if (!FakeCursorItem.Item.IsAir)
		{
			item = FakeCursorItem.Item;
			flag = true;
		}
		if (item.IsAir)
		{
			return true;
		}
		if (!item.CanHavePrefixes() && Item.CanStack(item, currentRecipe.createItem) && item.stack + currentRecipe.createItem.stack <= item.maxStack)
		{
			return true;
		}
		if (tryFittingItemInInventoryToAllowCrafting && !flag && LocalPlayer.ItemSpace(mouseItem).CanTakeItemToPersonalInventory)
		{
			mouseItem = LocalPlayer.GetItem(mouseItem, GetItemSettings.ReturnItemShowAsNewNoCoinMerge);
			if (mouseItem.IsAir)
			{
				movedAnItemToAllowCrafting = true;
				return true;
			}
			if (!mouseItem.CanHavePrefixes() && Item.CanStack(mouseItem, currentRecipe.createItem) && mouseItem.stack + currentRecipe.createItem.stack <= mouseItem.maxStack)
			{
				movedAnItemToAllowCrafting = true;
				return true;
			}
		}
		return false;
	}

	private static void DrawTrashItemSlot(int pivotTopLeftX, int pivotTopLeftY)
	{
		inventoryScale = 0.85f;
		int num = 448 + pivotTopLeftX;
		int num2 = 258 + pivotTopLeftY;
		if (ChestOrShopUIVisible)
		{
			num2 += 168;
			inventoryScale = 0.755f;
			num += 5;
		}
		new Microsoft.Xna.Framework.Color(150, 150, 150, 150);
		if (mouseX >= num && (float)mouseX <= (float)num + (float)TextureAssets.InventoryBack.Width() * inventoryScale && mouseY >= num2 && (float)mouseY <= (float)num2 + (float)TextureAssets.InventoryBack.Height() * inventoryScale && !PlayerInput.IgnoreMouseInterface)
		{
			player[myPlayer].mouseInterface = true;
			ItemSlot.Handle(ref player[myPlayer].trashItem, 6);
		}
		ItemSlot.Draw(spriteBatch, ref player[myPlayer].trashItem, 6, new Vector2(num, num2));
	}

	private static void DrawEmoteBubblesButton(int pivotTopLeftX, int pivotTopLeftY)
	{
		inventoryScale = 0.85f;
		int num = (int)((float)(450 + pivotTopLeftX) - 56f * inventoryScale);
		int num2 = 258 + pivotTopLeftY;
		int num3 = 244;
		int width = 30;
		int num4 = 30;
		num = 534;
		num2 = num3 + num4 + 4;
		if (ChestOrShopUIVisible)
		{
			num2 += 168;
			inventoryScale = 0.755f;
			num += 5;
			num3 += 24;
		}
		if (editChest)
		{
			num2 += 24;
		}
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(num, num2, (int)((float)TextureAssets.InventoryBack.Width() * inventoryScale), (int)((float)TextureAssets.InventoryBack.Height() * inventoryScale));
		rectangle = new Microsoft.Xna.Framework.Rectangle(num, num2, width, num4);
		bool flag = false;
		if (rectangle.Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)) && !PlayerInput.IgnoreMouseInterface && !LocalPlayerHasPendingInventoryActions())
		{
			player[myPlayer].mouseInterface = true;
			flag = true;
			if (mouseLeft && mouseLeftRelease)
			{
				player[myPlayer].SetTalkNPC(-1);
				npcChatCornerItem = 0;
				npcChatText = "";
				mouseLeftRelease = false;
				SoundEngine.PlaySound(12);
				IngameFancyUI.OpenUIState(new UIEmotesMenu());
			}
		}
		DoStatefulTickSound(ref emoteMouseOver, flag);
		Texture2D value = TextureAssets.EmoteMenuButton.Value;
		Vector2 position = rectangle.Center.ToVector2();
		Microsoft.Xna.Framework.Rectangle rectangle2 = value.Frame(2, 1, flag ? 1 : 0);
		rectangle2.Width -= 2;
		rectangle2.Height -= 2;
		Vector2 origin = rectangle2.Size() / 2f;
		Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
		spriteBatch.Draw(value, position, rectangle2, white, 0f, origin, 1f, SpriteEffects.None, 0f);
		UILinkPointNavigator.SetPosition(309, position);
		if (!mouseText && flag)
		{
			instance.MouseTextNoOverride(Language.GetTextValue("GameUI.Emote"), 0, 0);
		}
	}

	private static void DrawBestiaryIcon(int pivotTopLeftX, int pivotTopLeftY)
	{
		inventoryScale = 0.85f;
		int num = (int)((float)(450 + pivotTopLeftX) - 56f * inventoryScale * 2f);
		int num2 = 258 + pivotTopLeftY;
		int num3 = 244;
		int width = 30;
		int num4 = 30;
		num3 = 244;
		num = 498;
		num2 = num3 + num4 + 4;
		if (ChestOrShopUIVisible)
		{
			num2 += 168;
			inventoryScale = 0.755f;
			num += 5;
			num3 += 24;
		}
		if (editChest)
		{
			num2 += 24;
		}
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(num, num2, (int)((float)TextureAssets.InventoryBack.Width() * inventoryScale), (int)((float)TextureAssets.InventoryBack.Height() * inventoryScale));
		rectangle = new Microsoft.Xna.Framework.Rectangle(num, num2, width, num4);
		bool flag = false;
		if (rectangle.Contains(new Microsoft.Xna.Framework.Point(mouseX, mouseY)) && !PlayerInput.IgnoreMouseInterface && !LocalPlayerHasPendingInventoryActions())
		{
			player[myPlayer].mouseInterface = true;
			flag = true;
			if (mouseLeft && mouseLeftRelease)
			{
				player[myPlayer].SetTalkNPC(-1);
				npcChatCornerItem = 0;
				npcChatText = "";
				mouseLeftRelease = false;
				SoundEngine.PlaySound(12);
				IngameFancyUI.OpenUIState(BestiaryUI);
				BestiaryUI.OnOpenPage();
			}
		}
		DoStatefulTickSound(ref bestiaryMouseOver, flag);
		Texture2D value = TextureAssets.BestiaryMenuButton.Value;
		Vector2 position = rectangle.Center.ToVector2();
		Microsoft.Xna.Framework.Rectangle rectangle2 = value.Frame(2, 1, flag ? 1 : 0);
		rectangle2.Width -= 2;
		rectangle2.Height -= 2;
		Vector2 origin = rectangle2.Size() / 2f;
		Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
		spriteBatch.Draw(value, position, rectangle2, white, 0f, origin, 1f, SpriteEffects.None, 0f);
		UILinkPointNavigator.SetPosition(310, position);
		if (!mouseText && flag)
		{
			instance.MouseTextNoOverride(Language.GetTextValue("GameUI.Bestiary"), 0, 0);
		}
	}

	private void DrawHotbarLockIcon(int pivotTopLeftX, int pivotTopLeftY, bool pushSideToolsUp)
	{
		int num = 21 + pivotTopLeftY;
		_ = player[myPlayer];
		if (pushSideToolsUp)
		{
			num = pivotTopLeftY;
		}
		float num2 = 0.9f;
		Texture2D value = TextureAssets.HbLock[(!player[myPlayer].hbLocked) ? 1u : 0u].Value;
		Microsoft.Xna.Framework.Rectangle value2 = value.Frame(2);
		bool flag = false;
		if (mouseX > pivotTopLeftX && (float)mouseX < (float)pivotTopLeftX + (float)value2.Width * num2 && mouseY > num && (float)mouseY < (float)num + (float)value2.Height * num2 && !PlayerInput.IgnoreMouseInterface)
		{
			flag = true;
			player[myPlayer].mouseInterface = true;
			if (!player[myPlayer].hbLocked)
			{
				MouseText(Lang.inter[5].Value, 0, 0);
			}
			else
			{
				MouseText(Lang.inter[6].Value, 0, 0);
			}
			mouseText = true;
			if (mouseLeft && mouseLeftRelease)
			{
				SoundEngine.PlaySound(22);
				player[myPlayer].hbLocked = !player[myPlayer].hbLocked;
			}
		}
		spriteBatch.Draw(value, new Vector2(pivotTopLeftX, num), value2, Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		if (flag)
		{
			spriteBatch.Draw(value, new Vector2(pivotTopLeftX, num), value.Frame(2, 1, 1), OurFavoriteColor, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		}
		DoStatefulTickSound(ref hotbarLockMouseOver, flag);
	}

	private bool DrawBlockReplacementIcon(int pivotTopLeftX, int pivotTopLeftY, bool pushSideToolsUp, int gamepadPointOffset)
	{
		if (!playerInventory)
		{
			return false;
		}
		int num = 44 + pivotTopLeftY;
		_ = player[myPlayer];
		if (pushSideToolsUp)
		{
			num = 23 + pivotTopLeftY;
		}
		float num2 = 0.9f;
		int num3 = 10;
		bool flag = player[myPlayer].builderAccStatus[num3] == 0;
		Texture2D value = TextureAssets.blockReplaceIcon[0].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(3, 1, (!flag) ? 1 : 0);
		bool flag2 = false;
		if (mouseX > pivotTopLeftX && (float)mouseX < (float)pivotTopLeftX + (float)rectangle.Width * num2 && mouseY > num && (float)mouseY < (float)num + (float)rectangle.Height * num2 && !PlayerInput.IgnoreMouseInterface)
		{
			flag2 = true;
			player[myPlayer].mouseInterface = true;
			MouseText(flag ? Language.GetTextValue("GameUI.BlockReplacerOn") : Language.GetTextValue("GameUI.BlockReplacerOff"), 0, 0);
			mouseText = true;
			if (mouseLeft && mouseLeftRelease)
			{
				SoundEngine.PlaySound(22);
				player[myPlayer].builderAccStatus[num3] = (flag ? 1 : 0);
			}
		}
		Vector2 vector = new Vector2(pivotTopLeftX, num);
		spriteBatch.Draw(value, vector, rectangle, Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		if (flag2)
		{
			spriteBatch.Draw(value, vector, value.Frame(3, 1, 2), OurFavoriteColor, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		}
		UILinkPointNavigator.SetPosition(6000 + gamepadPointOffset, vector + rectangle.Size() * 0.65f);
		return flag2;
	}

	private bool DrawTorchBiomeSwapIcon(int pivotTopLeftX, int pivotTopLeftY, bool pushSideToolsUp, int gamepadPointOffset)
	{
		if (!playerInventory)
		{
			return false;
		}
		int num = 68 + pivotTopLeftY;
		_ = player[myPlayer];
		if (pushSideToolsUp)
		{
			num = 47 + pivotTopLeftY;
		}
		float num2 = 0.9f;
		int num3 = 11;
		bool flag = player[myPlayer].builderAccStatus[num3] == 0;
		Texture2D value = TextureAssets.Extra[211].Value;
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(4, 1, flag ? 1 : 0);
		bool flag2 = false;
		if (mouseX > pivotTopLeftX && (float)mouseX < (float)pivotTopLeftX + (float)rectangle.Width * num2 && mouseY > num && (float)mouseY < (float)num + (float)rectangle.Height * num2 && !PlayerInput.IgnoreMouseInterface)
		{
			flag2 = true;
			player[myPlayer].mouseInterface = true;
			MouseText(flag ? Language.GetTextValue("GameUI.TorchTypeSwapperOn") : Language.GetTextValue("GameUI.TorchTypeSwapperOff"), 0, 0);
			mouseText = true;
			if (mouseLeft && mouseLeftRelease)
			{
				SoundEngine.PlaySound(22);
				player[myPlayer].builderAccStatus[num3] = (flag ? 1 : 0);
			}
		}
		Vector2 vector = new Vector2(pivotTopLeftX, num);
		spriteBatch.Draw(value, vector, rectangle, Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		if (flag2)
		{
			spriteBatch.Draw(value, vector, value.Frame(4, 1, flag ? 3 : 2), OurFavoriteColor, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		}
		UILinkPointNavigator.SetPosition(6000 + gamepadPointOffset, vector + rectangle.Size() * 0.65f);
		return flag2;
	}

	public static bool LocalPlayerHasPendingInventoryActions()
	{
		if (FakeCursorItem.Item.IsAir)
		{
			return CraftingRequests.HasPendingRequests;
		}
		return true;
	}

	public static void CraftItem_GrantItem(Recipe recipe, Item result, bool quickCraft)
	{
		result.stack += mouseItem.stack;
		mouseItem = result;
		if (quickCraft)
		{
			if (CraftingRequests.HasPendingRequests)
			{
				LocalPlayer.GetOrDropItem(mouseItem, GetItemSettings.ReturnItemShowAsNew);
				mouseItem.TurnToAir();
			}
			else
			{
				mouseItem = LocalPlayer.GetItem(mouseItem, GetItemSettings.ReturnItemShowAsNew);
			}
		}
		CraftingEffects.OnCraftItemGranted(recipe, result, quickCraft);
		AchievementsHelper.NotifyItemCraft(recipe);
		AchievementsHelper.NotifyItemPickup(player[myPlayer], recipe.createItem);
	}

	private static void DrawPVPIcons()
	{
		if (EquipPage != 1)
		{
			hidePVPAndTeamIcons = false;
		}
		if (hidePVPAndTeamIcons)
		{
			return;
		}
		inventoryScale = 0.6f;
		int num = (int)(52f * inventoryScale);
		int num2 = 707 - num * 4 + screenWidth - 800;
		int num3 = 114 + mH + num * 2 + num / 2 - 12;
		if (EquipPage == 2)
		{
			num2 += num + num / 2;
		}
		if (ShouldPVPDraw)
		{
			int num4 = (player[myPlayer].hostile ? 2 : 0);
			if (mouseX > num2 - 7 && mouseX < num2 + 25 && mouseY > num3 - 2 && mouseY < num3 + 37 && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
				if (teamCooldown == 0)
				{
					string textValue = Language.GetTextValue(player[myPlayer].hostile ? "UI.PvpIcon_Active" : "UI.PvpIcon_Inactive");
					instance.MouseTextHackZoom(textValue);
					num4++;
				}
				if (mouseLeft && mouseLeftRelease && teamCooldown == 0)
				{
					teamCooldown = teamCooldownLen;
					SoundEngine.PlaySound(12);
					player[myPlayer].hostile = !player[myPlayer].hostile;
					NetMessage.SendData(30, -1, -1, null, myPlayer);
				}
			}
			Microsoft.Xna.Framework.Rectangle rectangle = TextureAssets.Pvp[0].Frame(4, 6);
			rectangle.Location = new Microsoft.Xna.Framework.Point(rectangle.Width * num4, rectangle.Height * player[myPlayer].team);
			rectangle.Width -= 2;
			rectangle.Height--;
			spriteBatch.Draw(TextureAssets.Pvp[0].Value, new Vector2(num2 - 10, num3), rectangle, Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, Vector2.One, SpriteEffects.None, 0f);
			UILinkPointNavigator.SetPosition(1550, new Vector2(num2 - 10, num3) + rectangle.Size() * 0.75f);
		}
		num3 += 60;
		num2 -= 10;
		if (!ShouldTeamSelectDraw)
		{
			return;
		}
		Microsoft.Xna.Framework.Rectangle rectangle2 = TextureAssets.Pvp[1].Frame(6);
		Microsoft.Xna.Framework.Rectangle r = rectangle2;
		for (int i = 0; i < 6; i++)
		{
			r.Location = new Microsoft.Xna.Framework.Point(num2 + i % 2 * 20, num3 + i / 2 * 20);
			rectangle2.X = rectangle2.Width * i;
			bool flag = false;
			if (r.Contains(MouseScreen.ToPoint()) && !PlayerInput.IgnoreMouseInterface)
			{
				player[myPlayer].mouseInterface = true;
				if (teamCooldown == 0)
				{
					flag = true;
				}
				if (flag)
				{
					string text = "None";
					switch (i)
					{
					case 1:
						text = "Red";
						break;
					case 2:
						text = "Green";
						break;
					case 3:
						text = "Blue";
						break;
					case 4:
						text = "Yellow";
						break;
					case 5:
						text = "Pink";
						break;
					}
					string textValue2 = Language.GetTextValue("UI.TeamIcon" + text + ((player[myPlayer].team == i) ? "_Active" : "_Inactive"));
					instance.MouseTextHackZoom(textValue2);
				}
				if (mouseLeft && mouseLeftRelease && player[myPlayer].team != i && teamCooldown == 0)
				{
					if (!player[myPlayer].TeamChangeAllowed())
					{
						NewText(Lang.misc[84].Value, byte.MaxValue, 240, 20);
					}
					else
					{
						teamCooldown = teamCooldownLen;
						SoundEngine.PlaySound(12);
						player[myPlayer].team = i;
						if (netMode != 0)
						{
							NetMessage.SendData(157, -1, -1, null, myPlayer);
						}
						else if (teamBasedSpawnsSeed)
						{
							player[myPlayer].Spawn(PlayerSpawnContext.TeamSwap);
						}
					}
				}
			}
			r.Width = rectangle2.Width - 2;
			if (flag)
			{
				spriteBatch.Draw(TextureAssets.Pvp[2].Value, r.Location.ToVector2() + new Vector2(-2f), Microsoft.Xna.Framework.Color.White);
			}
			Microsoft.Xna.Framework.Rectangle value = rectangle2;
			value.Width -= 2;
			spriteBatch.Draw(TextureAssets.Pvp[1].Value, r.Location.ToVector2(), value, Microsoft.Xna.Framework.Color.White);
			UILinkPointNavigator.SetPosition(1550 + i + 1, r.Location.ToVector2() + r.Size() * 0.75f);
		}
	}

	private static int DrawPageIcons(int yPos)
	{
		int num = -1;
		Vector2 vector = new Vector2(screenWidth - 162, yPos);
		vector.X += 82f;
		Texture2D value = TextureAssets.EquipPage[(EquipPage == 2) ? 3 : 2].Value;
		if (Collision.CheckAABBvAABBCollision(vector, value.Size(), new Vector2(mouseX, mouseY), Vector2.One) && (mouseItem.stack < 1 || mouseItem.dye > 0) && !PlayerInput.IgnoreMouseInterface)
		{
			num = 2;
		}
		if (num == 2)
		{
			spriteBatch.Draw(TextureAssets.EquipPage[6].Value, vector, null, OurFavoriteColor, 0f, new Vector2(2f), 0.9f, SpriteEffects.None, 0f);
		}
		spriteBatch.Draw(value, vector, null, Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, 0.9f, SpriteEffects.None, 0f);
		UILinkPointNavigator.SetPosition(305, vector + value.Size() * 0.75f);
		vector.X -= 48f;
		value = TextureAssets.EquipPage[(EquipPage == 1) ? 5 : 4].Value;
		if (Collision.CheckAABBvAABBCollision(vector, value.Size(), new Vector2(mouseX, mouseY), Vector2.One) && mouseItem.stack < 1 && !PlayerInput.IgnoreMouseInterface)
		{
			num = 1;
		}
		if (num == 1)
		{
			spriteBatch.Draw(TextureAssets.EquipPage[7].Value, vector, null, OurFavoriteColor, 0f, new Vector2(2f), 0.9f, SpriteEffects.None, 0f);
		}
		spriteBatch.Draw(value, vector, null, Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, 0.9f, SpriteEffects.None, 0f);
		UILinkPointNavigator.SetPosition(306, vector + value.Size() * 0.75f);
		vector.X -= 48f;
		value = TextureAssets.EquipPage[(EquipPage == 3) ? 10 : 8].Value;
		if (Collision.CheckAABBvAABBCollision(vector, value.Size(), new Vector2(mouseX, mouseY), Vector2.One) && mouseItem.stack < 1 && !PlayerInput.IgnoreMouseInterface)
		{
			num = 3;
		}
		if (num == 3 && !CaptureModeDisabled)
		{
			spriteBatch.Draw(TextureAssets.EquipPage[9].Value, vector, null, OurFavoriteColor, 0f, Vector2.Zero, 0.9f, SpriteEffects.None, 0f);
		}
		spriteBatch.Draw(value, vector, null, CaptureModeDisabled ? Microsoft.Xna.Framework.Color.Red : Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, 0.9f, SpriteEffects.None, 0f);
		UILinkPointNavigator.SetPosition(307, vector + value.Size() * 0.75f);
		if (num != -1)
		{
			player[myPlayer].mouseInterface = true;
			if (mouseLeft && mouseLeftRelease)
			{
				bool flag = true;
				if (num == 3)
				{
					if (CaptureModeDisabled)
					{
						flag = false;
					}
					else if (PlayerInput.UsingGamepad)
					{
						CaptureInterface.QuickScreenshot();
					}
					else
					{
						CaptureManager.Instance.Active = true;
						blockMouse = true;
					}
				}
				else if (EquipPageSelected != num)
				{
					EquipPageSelected = num;
				}
				else
				{
					EquipPageSelected = 0;
				}
				if (flag)
				{
					SoundEngine.PlaySound(10);
				}
			}
		}
		ItemSlot.SelectEquipPage(mouseItem);
		if (EquipPage == -1)
		{
			EquipPage = EquipPageSelected;
		}
		return num;
	}

	public void DrawMouseOver()
	{
		PlayerInput.SetZoom_World();
		Vector2 vector = ReverseGravitySupport(MouseScreen) + screenPosition;
		Microsoft.Xna.Framework.Rectangle mouseRectangle = new Microsoft.Xna.Framework.Rectangle((int)vector.X, (int)vector.Y, 1, 1);
		PlayerInput.SetZoom_UI();
		if (!LocalPlayer.ghost && LocalPlayer.spectating < 0)
		{
			ResourceSetsManager.TryToHoverOverResources();
		}
		AchievementAdvisor.DrawMouseHover();
		IngameOptions.MouseOver();
		IngameFancyUI.MouseOver();
		if (!mouseText)
		{
			for (int i = 0; i < 400; i++)
			{
				if (!item[i].active)
				{
					continue;
				}
				Microsoft.Xna.Framework.Rectangle drawHitbox = Item.GetDrawHitbox(item[i].type, null);
				Vector2 bottom = item[i].Bottom;
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)(bottom.X - (float)drawHitbox.Width * 0.5f), (int)(bottom.Y - (float)drawHitbox.Height), drawHitbox.Width, drawHitbox.Height);
				if (mouseRectangle.Intersects(value))
				{
					player[myPlayer].cursorItemIconEnabled = false;
					string text = item[i].AffixName();
					if (item[i].stack > 1)
					{
						text = text + " (" + item[i].stack + ")";
					}
					if (item[i].playerIndexTheItemIsReservedFor < 255 && showItemOwner)
					{
						text = text + " <" + player[item[i].playerIndexTheItemIsReservedFor].name + ">";
					}
					rare = item[i].rare;
					if (item[i].expert)
					{
						rare = -12;
					}
					MouseTextHackZoom(text, rare, 0);
					mouseText = true;
					break;
				}
			}
		}
		for (int j = 0; j < 255; j++)
		{
			if (!player[j].active || myPlayer == j || player[j].dead || player[j].ShouldNotDraw || !((double)player[j].stealth > 0.5))
			{
				continue;
			}
			Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle((int)((double)player[j].position.X + (double)player[j].width * 0.5 - 16.0), (int)(player[j].position.Y + (float)player[j].height - 48f), 32, 48);
			if (!mouseText && mouseRectangle.Intersects(value2))
			{
				player[myPlayer].cursorItemIconEnabled = false;
				int num = player[j].statLife;
				if (num < 0)
				{
					num = 0;
				}
				string text2 = player[j].name + ": " + num + "/" + player[j].statLifeMax2;
				if (player[j].hostile)
				{
					text2 = text2 + " " + Language.GetTextValue("Game.PvPFlag");
				}
				MouseTextHackZoom(text2, 0, player[j].difficulty);
				mouseText = true;
			}
		}
		HoveringOverAnNPC = false;
		HoverOverNPCs(mouseRectangle);
		if (!mouseText && signHover != -1 && sign[signHover] != null && !player[myPlayer].mouseInterface && !string.IsNullOrWhiteSpace(sign[signHover].text))
		{
			int lineAmount;
			string[] array = Utils.WordwrapString(sign[signHover].text, FontAssets.MouseText.Value, 460, 10, out lineAmount);
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, _uiScaleMatrix);
			PlayerInput.SetZoom_UI();
			float num2 = 0f;
			for (int k = 0; k < lineAmount; k++)
			{
				float x = FontAssets.MouseText.Value.MeasureString(array[k]).X;
				if (num2 < x)
				{
					num2 = x;
				}
			}
			if (num2 > 460f)
			{
				num2 = 460f;
			}
			bool settingsEnabled_OpaqueBoxBehindTooltips = SettingsEnabled_OpaqueBoxBehindTooltips;
			Vector2 vector2 = new Vector2(mouseX, mouseY) + new Vector2(16f);
			if (settingsEnabled_OpaqueBoxBehindTooltips)
			{
				vector2 += new Vector2(8f, 2f);
			}
			if (vector2.Y > (float)(screenHeight - 30 * lineAmount))
			{
				vector2.Y = screenHeight - 30 * lineAmount;
			}
			if (vector2.X > (float)screenWidth - num2)
			{
				vector2.X = (float)screenWidth - num2;
			}
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
			if (settingsEnabled_OpaqueBoxBehindTooltips)
			{
				color = Microsoft.Xna.Framework.Color.Lerp(color, Microsoft.Xna.Framework.Color.White, 1f);
				int num3 = 10;
				int num4 = 5;
				Utils.DrawInvBG(spriteBatch, new Microsoft.Xna.Framework.Rectangle((int)vector2.X - num3, (int)vector2.Y - num4, (int)num2 + num3 * 2, 30 * lineAmount + num4 + num4 / 2), new Microsoft.Xna.Framework.Color(23, 25, 81, 255) * 0.925f * 0.85f);
			}
			for (int l = 0; l < lineAmount; l++)
			{
				Utils.DrawBorderStringFourWay(spriteBatch, FontAssets.MouseText.Value, array[l], vector2.X, vector2.Y + (float)(l * 30), color, Microsoft.Xna.Framework.Color.Black, Vector2.Zero);
			}
			mouseText = true;
		}
		PlayerInput.SetZoom_UI();
	}

	private void HoverOverNPCs(Microsoft.Xna.Framework.Rectangle mouseRectangle)
	{
		Player player = Main.player[myPlayer];
		Microsoft.Xna.Framework.Rectangle worldRegion = TileReachCheckSettings.Simple.GetWorldRegion(player);
		for (int i = 0; i < maxNPCs; i++)
		{
			NPC nPC = npc[i];
			if (!nPC.active || nPC.CurrentlyShimmerTransparent())
			{
				continue;
			}
			int type = nPC.type;
			LoadNPC(type);
			nPC.position += nPC.netOffset;
			Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)nPC.Bottom.X - nPC.frame.Width / 2, (int)nPC.Bottom.Y - nPC.frame.Height, nPC.frame.Width, nPC.frame.Height);
			if (nPC.type >= 87 && nPC.type <= 92)
			{
				value = new Microsoft.Xna.Framework.Rectangle((int)((double)nPC.position.X + (double)nPC.width * 0.5 - 32.0), (int)((double)nPC.position.Y + (double)nPC.height * 0.5 - 32.0), 64, 64);
			}
			if (nPC.type == 696 || nPC.type == 695)
			{
				value = Utils.CenteredRectangle(nPC.Bottom - new Vector2(nPC.direction * -10, 20f), new Vector2(60f, 40f));
			}
			bool flag = mouseRectangle.Intersects(value);
			bool flag2 = flag || (SmartInteractShowingGenuine && SmartInteractNPC == i);
			if (flag2 && ((nPC.type != 85 && nPC.type != 341 && nPC.type != 629 && nPC.aiStyle != 87) || nPC.ai[0] != 0f) && (nPC.type != 694 || nPC.ai[3] != 3f) && nPC.type != 690 && nPC.type != 488)
			{
				if (nPC.type == 685)
				{
					if (!mouseText)
					{
						player.cursorItemIconEnabled = true;
						player.cursorItemIconID = 327;
						player.cursorItemIconText = "";
					}
					if (!player.dead)
					{
						player.noThrow = 4;
						if (mouseRight && npcChatRelease)
						{
							npcChatRelease = false;
							if (PlayerInput.UsingGamepad)
							{
								player.releaseInventory = false;
							}
							if (player.talkNPC != i && !player.tileInteractionHappened && TryFreeingElderSlime(i))
							{
								NPC.TransformElderSlime(i);
								SoundEngine.PlaySound(22);
							}
						}
					}
				}
				else
				{
					bool flag3 = SmartInteractShowingGenuine && SmartInteractNPC == i;
					if (nPC.townNPC || nPC.type == 105 || nPC.type == 106 || nPC.type == 123 || nPC.type == 354 || nPC.type == 376 || nPC.type == 579 || nPC.type == 453 || nPC.type == 589)
					{
						Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle((int)nPC.position.X, (int)nPC.position.Y, nPC.width, nPC.height);
						if (worldRegion.Intersects(value2))
						{
							flag3 = true;
						}
					}
					if (player.ownedProjectileCounts[651] > 0)
					{
						flag3 = false;
					}
					if (player.stinky)
					{
						flag3 = false;
					}
					if (player.mouseInterface)
					{
						flag3 = false;
					}
					if (flag3 && !player.dead)
					{
						player.noThrow = 4;
						HoveringOverAnNPC = true;
						currentNPCShowingChatBubble = i;
						if (mouseRight && npcChatRelease)
						{
							npcChatRelease = false;
							if (PlayerInput.UsingGamepad)
							{
								player.releaseInventory = false;
							}
							if (player.talkNPC != i && !player.tileInteractionHappened)
							{
								IngameUIWindows.CloseAll(quiet: true);
								player.dropItemCheck();
								player.SetTalkNPC(i);
								npcChatText = nPC.GetChat();
								SoundEngine.PlaySound(24);
							}
						}
					}
					if (flag && !mouseText)
					{
						player.cursorItemIconEnabled = false;
						string text = nPC.GivenOrTypeName;
						int num = i;
						if (nPC.realLife >= 0)
						{
							num = nPC.realLife;
						}
						if (npc[num].lifeMax > 1 && !npc[num].dontTakeDamage)
						{
							text = text + ": " + npc[num].life + "/" + npc[num].lifeMax;
						}
						MouseTextHackZoom(text);
						mouseText = true;
						nPC.position -= nPC.netOffset;
						break;
					}
					if (flag2)
					{
						nPC.position -= nPC.netOffset;
						break;
					}
				}
			}
			nPC.position -= nPC.netOffset;
		}
	}

	private static bool TryFreeingElderSlime(int npcIndex)
	{
		Player player = Main.player[myPlayer];
		short type = 327;
		bool inVoidBag = false;
		int num = player.FindItemInInventoryOrOpenVoidBag(type, out inVoidBag);
		if (num == -1)
		{
			return false;
		}
		Item item = null;
		item = ((!inVoidBag) ? player.inventory[num] : player.bank4.item[num]);
		if (--item.stack <= 0)
		{
			item.TurnToAir();
		}
		return true;
	}

	private static void DrawNPCChatBubble(int i)
	{
		int num = -(npc[i].width / 2 + 8);
		float num2 = npc[i].position.Y - (float)TextureAssets.Chat.Height() - (float)(int)screenPosition.Y;
		if (npc[i].type == 637 && npc[i].ai[0] == 5f)
		{
			num2 -= 18f;
		}
		SpriteEffects spriteEffects = SpriteEffects.None;
		if (npc[i].spriteDirection == -1)
		{
			spriteEffects = SpriteEffects.FlipHorizontally;
			num = npc[i].width / 2 + 8;
		}
		if (player[myPlayer].gravDir != 1f)
		{
			spriteEffects |= SpriteEffects.FlipVertically;
			num2 = (float)screenHeight - num2 - (float)TextureAssets.Chat.Height();
		}
		Vector2 position = new Vector2(npc[i].position.X + (float)(npc[i].width / 2) - screenPosition.X - (float)(TextureAssets.Chat.Width() / 2) - (float)num, num2);
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, SamplerState.PointClamp, null, null, null, GameViewMatrix.ZoomMatrix);
		PlayerInput.SetZoom_UI();
		spriteBatch.Draw(TextureAssets.Chat.Value, position, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chat.Width(), TextureAssets.Chat.Height()), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, default(Vector2), 1f, spriteEffects, 0f);
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, _uiScaleMatrix);
	}

	public void GUIBarsDraw()
	{
		if (ignoreErrors)
		{
			try
			{
				GUIBarsDrawInner();
				return;
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				return;
			}
		}
		GUIBarsDrawInner();
	}

	protected void GUIBarsDrawInner()
	{
		ResourceSetsManager.Draw();
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
		DrawInterface_Resources_Breath();
		DrawInterface_Resources_ClearBuffs();
		if (!ingameOptionsWindow && !playerInventory && !inFancyUI && !CaptureManager.Instance.Active)
		{
			DrawInterface_Resources_Buffs();
		}
	}

	public static void DrawInterface_Resources_ClearBuffs()
	{
		buffString = "";
		bannerMouseOver = false;
		if (!PipsUseGrid)
		{
			recStart = 0;
		}
	}

	public void DrawInterface_Resources_Buffs()
	{
		PipsUseGrid = false;
		int num = -1;
		int num2 = 11;
		int num3 = 0;
		for (int i = 0; i < Player.maxBuffs; i++)
		{
			if (player[myPlayer].buffType[i] > 0)
			{
				_ = player[myPlayer].buffType[i];
				int x = 32 + num3 * 38;
				int num4 = 76;
				int num5 = num3;
				while (num5 >= num2)
				{
					num5 -= num2;
					x = 32 + num5 * 38;
					num4 += 50;
				}
				num = DrawBuffIcon(num, i, x, num4);
				num3++;
			}
			else
			{
				buffAlpha[i] = 0.4f;
			}
		}
		if (num < 0)
		{
			return;
		}
		int num6 = player[myPlayer].buffType[num];
		if (num6 > 0)
		{
			string buffName = Lang.GetBuffName(num6);
			string buffTooltip = GetBuffTooltip(player[myPlayer], num6);
			if (num6 == 147)
			{
				bannerMouseOver = true;
			}
			if (meleeBuff[num6])
			{
				MouseTextHackZoom(buffName, -10, 0, buffTooltip);
			}
			else
			{
				MouseTextHackZoom(buffName, buffTooltip);
			}
		}
	}

	public static string GetBuffTooltip(Player player, int buffType)
	{
		string text = Lang.GetBuffDescription(buffType);
		switch (buffType)
		{
		case 26:
			if (expertMode)
			{
				text = Language.GetTextValue("BuffDescription.WellFed_Expert");
			}
			break;
		case 206:
			if (expertMode)
			{
				text = Language.GetTextValue("BuffDescription.WellFed2_Expert");
			}
			break;
		case 207:
			if (expertMode)
			{
				text = Language.GetTextValue("BuffDescription.WellFed3_Expert");
			}
			break;
		case 94:
		{
			int num = (int)(player.manaSickReduction * 100f) + 1;
			text = text + num + "%";
			break;
		}
		}
		return text;
	}

	public static bool TryGetBuffTime(int buffSlotOnPlayer, out int buffTimeValue)
	{
		int num = player[myPlayer].buffType[buffSlotOnPlayer];
		buffTimeValue = 0;
		if (!vanityPet[num] && !lightPet[num] && !buffNoTimeDisplay[num] && (!player[myPlayer].honeyWet || num != 48) && (!player[myPlayer].wet || !expertMode || num != 46))
		{
			if (vampireSeed && player[myPlayer].buffTime[buffSlotOnPlayer] < 10 && (num == 24 || num == 23 || num == 32))
			{
				return false;
			}
			buffTimeValue = player[myPlayer].buffTime[buffSlotOnPlayer];
			return true;
		}
		return false;
	}

	public static int DrawBuffIcon(int drawBuffText, int buffSlotOnPlayer, int x, int y)
	{
		int num = player[myPlayer].buffType[buffSlotOnPlayer];
		if (num == 0)
		{
			return drawBuffText;
		}
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(buffAlpha[buffSlotOnPlayer], buffAlpha[buffSlotOnPlayer], buffAlpha[buffSlotOnPlayer], buffAlpha[buffSlotOnPlayer]);
		spriteBatch.Draw(TextureAssets.Buff[num].Value, new Vector2(x, y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Buff[num].Width(), TextureAssets.Buff[num].Height()), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
		string text = null;
		if (BuffID.Sets.BuffTextHandlers.TryGetValue(num, out var value))
		{
			text = value.HandleBuffText();
		}
		if (text == null && TryGetBuffTime(buffSlotOnPlayer, out var buffTimeValue) && buffTimeValue > 2)
		{
			text = Lang.LocalizedDuration(new TimeSpan(0, 0, buffTimeValue / 60), abbreviated: true, showAllAvailableUnits: false);
		}
		if (text != null)
		{
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.ItemStack.Value, text, new Vector2(x, y + TextureAssets.Buff[num].Height()), color, 0f, default(Vector2), 0.8f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		if (mouseX < x + TextureAssets.Buff[num].Width() && mouseY < y + TextureAssets.Buff[num].Height() && mouseX > x && mouseY > y && !PlayerInput.IgnoreMouseInterface)
		{
			drawBuffText = buffSlotOnPlayer;
			buffAlpha[buffSlotOnPlayer] += 0.1f;
			bool flag = mouseRight && mouseRightRelease;
			if (PlayerInput.UsingGamepad)
			{
				flag = mouseLeft && mouseLeftRelease && playerInventory;
				if (playerInventory)
				{
					player[myPlayer].mouseInterface = true;
				}
			}
			else
			{
				player[myPlayer].mouseInterface = true;
			}
			if (flag)
			{
				TryRemovingBuff(buffSlotOnPlayer, num);
			}
		}
		else
		{
			buffAlpha[buffSlotOnPlayer] -= 0.05f;
		}
		if (buffAlpha[buffSlotOnPlayer] > 1f)
		{
			buffAlpha[buffSlotOnPlayer] = 1f;
		}
		else if ((double)buffAlpha[buffSlotOnPlayer] < 0.4)
		{
			buffAlpha[buffSlotOnPlayer] = 0.4f;
		}
		if (PlayerInput.UsingGamepad && !playerInventory)
		{
			drawBuffText = -1;
		}
		return drawBuffText;
	}

	public static void TryRemovingBuff(int i, int b)
	{
		bool flag = false;
		if (!debuff[b] && b != 60 && b != 151)
		{
			if (player[myPlayer].mount.Active && player[myPlayer].mount.CheckBuff(b))
			{
				player[myPlayer].mount.TryDismount(player[myPlayer]);
				flag = true;
			}
			TryRemovingBuff_CheckBuffHideMisc(0, b);
			TryRemovingBuff_CheckBuffHideMisc(1, b);
			SoundEngine.PlaySound(12);
			if (!flag)
			{
				player[myPlayer].DelBuff(i);
			}
		}
	}

	public static void TryRemovingBuff_CheckBuffHideMisc(int slot, int buffID)
	{
		if (!player[myPlayer].hideMisc[slot])
		{
			bool flag = player[myPlayer].miscEquips[slot].buffType == buffID;
			if (!flag && (buffID == 102 || buffID == 101))
			{
				flag = player[myPlayer].miscEquips[slot].buffType == 27;
			}
			if (flag)
			{
				player[myPlayer].hideMisc[slot] = true;
			}
		}
	}

	private static void DrawInterface_Resources_Breath()
	{
		bool flag = false;
		if (player[myPlayer].dead)
		{
			return;
		}
		if (player[myPlayer].lavaTime < player[myPlayer].lavaMax && player[myPlayer].lavaWet)
		{
			flag = true;
		}
		else if (player[myPlayer].lavaTime < player[myPlayer].lavaMax && player[myPlayer].breath == player[myPlayer].breathMax)
		{
			flag = true;
		}
		Vector2 vector = player[myPlayer].Top + new Vector2(0f, player[myPlayer].gfxOffY);
		if (playerInventory && screenHeight < 1000)
		{
			vector.Y += player[myPlayer].height - 20;
		}
		vector = Vector2.Transform(vector - screenPosition, GameViewMatrix.ZoomMatrix);
		if (!playerInventory || screenHeight >= 1000)
		{
			vector.Y -= 100f;
		}
		vector /= UIScale;
		if (ingameOptionsWindow || InGameUI.IsVisible)
		{
			vector = new Vector2(screenWidth / 2, screenHeight / 2 + 236);
			if (InGameUI.IsVisible)
			{
				vector.Y = screenHeight - 64;
			}
		}
		if (player[myPlayer].breath < player[myPlayer].breathMax && !player[myPlayer].ghost && !flag)
		{
			_ = player[myPlayer].breathMax / 20;
			int num = 20;
			for (int i = 1; i < player[myPlayer].breathMax / num + 1; i++)
			{
				int num2 = 255;
				float num3 = 1f;
				if (player[myPlayer].breath >= i * num)
				{
					num2 = 255;
				}
				else
				{
					float num4 = (float)(player[myPlayer].breath - (i - 1) * num) / (float)num;
					num2 = (int)(30f + 225f * num4);
					if (num2 < 30)
					{
						num2 = 30;
					}
					num3 = num4 / 4f + 0.75f;
					if ((double)num3 < 0.75)
					{
						num3 = 0.75f;
					}
				}
				int num5 = 0;
				int num6 = 0;
				if (i > 10)
				{
					num5 -= 260;
					num6 += 26;
				}
				spriteBatch.Draw(TextureAssets.Bubble.Value, vector + new Vector2((float)(26 * (i - 1) + num5) - 125f, 32f + ((float)TextureAssets.Bubble.Height() - (float)TextureAssets.Bubble.Height() * num3) / 2f + (float)num6), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Bubble.Width(), TextureAssets.Bubble.Height()), new Microsoft.Xna.Framework.Color(num2, num2, num2, num2), 0f, default(Vector2), num3, SpriteEffects.None, 0f);
			}
		}
		if (!(player[myPlayer].lavaTime < player[myPlayer].lavaMax && !player[myPlayer].ghost && flag))
		{
			return;
		}
		int num7 = player[myPlayer].lavaMax / 10;
		_ = player[myPlayer].breathMax / num7;
		for (int j = 1; j < player[myPlayer].lavaMax / num7 + 1; j++)
		{
			int num8 = 255;
			float num9 = 1f;
			if (player[myPlayer].lavaTime >= j * num7)
			{
				num8 = 255;
			}
			else
			{
				float num10 = (float)(player[myPlayer].lavaTime - (j - 1) * num7) / (float)num7;
				num8 = (int)(30f + 225f * num10);
				if (num8 < 30)
				{
					num8 = 30;
				}
				num9 = num10 / 4f + 0.75f;
				if ((double)num9 < 0.75)
				{
					num9 = 0.75f;
				}
			}
			int num11 = 0;
			int num12 = 0;
			if (j > 10)
			{
				num11 -= 260;
				num12 += 26;
			}
			spriteBatch.Draw(TextureAssets.Flame.Value, vector + new Vector2((float)(26 * (j - 1) + num11) - 125f, 32f + ((float)TextureAssets.Flame.Height() - (float)TextureAssets.Flame.Height() * num9) / 2f + (float)num12), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Bubble.Width(), TextureAssets.Bubble.Height()), new Microsoft.Xna.Framework.Color(num8, num8, num8, num8), 0f, default(Vector2), num9, SpriteEffects.None, 0f);
		}
	}

	private static void DrawInterface_Resources_GolfPower()
	{
		Projectile projectile = null;
		for (int i = 0; i < 1000; i++)
		{
			Projectile projectile2 = Main.projectile[i];
			if (projectile2.active && projectile2.owner == myPlayer && projectile2.type == 722)
			{
				projectile = projectile2;
				break;
			}
		}
		if (projectile == null)
		{
			return;
		}
		Projectile projectile3 = GolfHelper.FindGolfBallForHelper(projectile);
		if (projectile3 != null)
		{
			float relativeStrength = GolfHelper.CalculateShotStrength(projectile, projectile3).RelativeStrength;
			if (!(relativeStrength < 0.001f))
			{
				Vector2 position = LocalPlayer.Bottom - Camera.ScaledPosition;
				position *= GameViewMatrix.RenderZoom;
				position /= UIScale;
				position.X -= 27f;
				position.Y += 14f;
				spriteBatch.Draw(TextureAssets.GolfSwingBarPanel.Value, position, null, Microsoft.Xna.Framework.Color.White);
				spriteBatch.Draw(TextureAssets.GolfSwingBarFill.Value, position, new Microsoft.Xna.Framework.Rectangle(0, 0, (int)(54f * relativeStrength), 14), Microsoft.Xna.Framework.Color.White);
			}
		}
	}

	private static void DrawInterface_GolfBallIndicator()
	{
		if (!Item.IsAGolfingItem(LocalPlayer.HeldItem))
		{
			return;
		}
		Projectile lastHitBall = LocalGolfState.GetLastHitBall();
		if (lastHitBall != null && GolfHelper.IsGolfBallResting(lastHitBall))
		{
			Vector2 vector = lastHitBall.Top - Camera.ScaledPosition;
			vector *= GameViewMatrix.RenderZoom;
			vector /= UIScale;
			float num = MathHelper.Clamp(((LocalPlayer.position - lastHitBall.position).Length() - 150f) / 50f, 0f, 1f);
			Vector2 vector2 = Vector2.Clamp(vector, new Vector2(20f), Camera.UnscaledSize - new Vector2(20f));
			float num2 = 0f;
			if (vector2 != vector)
			{
				num2 = (vector2 - vector).ToRotation() + (float)Math.PI / 2f;
			}
			vector2 -= (num2 + (float)Math.PI / 2f).ToRotationVector2() * (((float)Math.Sin(GlobalTimeWrappedHourly * 4f) * 0.5f + 0.5f) * 5f + 14f);
			Texture2D value = TextureAssets.GolfBallArrow.Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(2);
			Vector2 origin = rectangle.Size() * new Vector2(0.5f, 1f);
			Microsoft.Xna.Framework.Rectangle value2 = value.Frame(2, 1, 1);
			spriteBatch.Draw(TextureAssets.GolfBallArrowShadow.Value, vector2 + new Vector2(-4f, 4f) * 1.5f, rectangle, Microsoft.Xna.Framework.Color.White * num, num2, origin, 1.5f, SpriteEffects.None, 0f);
			float amount = (float)Math.Sin(GlobalTimeWrappedHourly * 4f) * 0.5f + 0.5f;
			for (float num3 = 0f; num3 < 1f; num3 += 0.25f)
			{
				spriteBatch.Draw(value, vector2 + ((float)Math.PI * 2f * num3 + num2).ToRotationVector2() * MathHelper.Lerp(2f, 2f, amount), value2, Microsoft.Xna.Framework.Color.Black * num * MathHelper.Lerp(1f, 1f, amount), num2, origin, 1.5f, SpriteEffects.None, 0f);
			}
			for (float num4 = 0f; num4 < 1f; num4 += 0.25f)
			{
				spriteBatch.Draw(value, vector2 + ((float)Math.PI * 2f * num4 + num2).ToRotationVector2() * MathHelper.Lerp(0f, 0f, amount), value2, Microsoft.Xna.Framework.Color.White * num * MathHelper.Lerp(0.8f, 0.8f, amount), num2, origin, 1.5f, SpriteEffects.None, 0f);
			}
			spriteBatch.Draw(value, vector2, rectangle, mouseColor * num, num2, origin, 1.5f, SpriteEffects.None, 0f);
		}
	}

	protected void GUIHotbarDrawInner()
	{
		if (playerInventory || LocalPlayer.ghost || LocalPlayer.spectating >= 0)
		{
			return;
		}
		string text = Lang.inter[37].Value;
		if (player[myPlayer].inventory[player[myPlayer].selectedItem].Name != null && player[myPlayer].inventory[player[myPlayer].selectedItem].Name != "")
		{
			text = player[myPlayer].inventory[player[myPlayer].selectedItem].AffixName();
		}
		Vector2 vector = FontAssets.MouseText.Value.MeasureString(text) / 2f;
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, text, new Vector2(236f - vector.X, 0f), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, default(Vector2), 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		int num = 20;
		for (int i = 0; i < 10; i++)
		{
			if (i == LocalPlayer.selectedItem && !LocalPlayer.selectedItemState.HasActiveOverride)
			{
				if (hotbarScale[i] < 1f)
				{
					hotbarScale[i] += 0.05f;
				}
			}
			else if ((double)hotbarScale[i] > 0.75)
			{
				hotbarScale[i] -= 0.05f;
			}
			float num2 = hotbarScale[i];
			int num3 = (int)(20f + 22f * (1f - num2));
			int a = (int)(75f + 150f * num2);
			Microsoft.Xna.Framework.Color lightColor = new Microsoft.Xna.Framework.Color(255, 255, 255, a);
			if (!player[myPlayer].hbLocked && !PlayerInput.IgnoreMouseInterface && !LocalPlayer.controlTorch && mouseX >= num && (float)mouseX <= (float)num + (float)TextureAssets.InventoryBack.Width() * hotbarScale[i] && mouseY >= num3 && (float)mouseY <= (float)num3 + (float)TextureAssets.InventoryBack.Height() * hotbarScale[i] && !player[myPlayer].channel)
			{
				player[myPlayer].mouseInterface = true;
				player[myPlayer].cursorItemIconEnabled = false;
				if (mouseLeft && !player[myPlayer].hbLocked && !blockMouse)
				{
					player[myPlayer].changeItem = i;
				}
				hoverItemName = player[myPlayer].inventory[i].AffixName();
				if (player[myPlayer].inventory[i].stack > 1)
				{
					hoverItemName = hoverItemName + " (" + player[myPlayer].inventory[i].stack + ")";
				}
				rare = player[myPlayer].inventory[i].rare;
				if (player[myPlayer].inventory[i].expert)
				{
					rare = -12;
				}
			}
			float num4 = inventoryScale;
			inventoryScale = num2;
			ItemSlot.Draw(spriteBatch, player[myPlayer].inventory, 13, i, new Vector2(num, num3), lightColor);
			inventoryScale = num4;
			num += (int)((float)TextureAssets.InventoryBack.Width() * hotbarScale[i]) + 4;
		}
		if ((LocalPlayer.selectedItemState.HasActiveOverride || LocalPlayer.selectedItem >= 10) && LocalPlayer.selectedItem != 58 && !LocalPlayer.HeldItem.IsAir)
		{
			float num5 = 1f;
			int num6 = (int)(20f + 22f * (1f - num5));
			int a2 = (int)(75f + 150f * num5);
			Microsoft.Xna.Framework.Color lightColor2 = new Microsoft.Xna.Framework.Color(255, 255, 255, a2);
			float num7 = inventoryScale;
			inventoryScale = num5;
			ItemSlot.Draw(spriteBatch, player[myPlayer].inventory, 36, LocalPlayer.selectedItem, new Vector2(num, num6), lightColor2);
			inventoryScale = num7;
		}
	}

	public static void OpenHairWindow()
	{
		hBar = -1f;
		lBar = -1f;
		sBar = -1f;
		playerInventory = false;
		npcChatText = "";
		oldHairStyle = player[myPlayer].hair;
		oldHairColor = player[myPlayer].hairColor;
		hairWindow = true;
		SoundEngine.PlaySound(10);
	}

	public static void CancelHairWindow(bool quiet = false)
	{
		if (hairWindow)
		{
			player[myPlayer].hair = oldHairStyle;
			player[myPlayer].hairColor = oldHairColor;
			hairWindow = false;
			if (player[myPlayer].talkNPC > -1 && npc[player[myPlayer].talkNPC].type == 353)
			{
				player[myPlayer].SetTalkNPC(-1);
			}
			if (!quiet)
			{
				SoundEngine.PlaySound(11);
			}
			ContentSamples.FixItemsUsingPlayerColours();
		}
	}

	public static void BuyHairWindow()
	{
		SoundEngine.PlaySound(18);
		hairWindow = false;
		player[myPlayer].SetTalkNPC(-1);
		npcChatCornerItem = 0;
		NetMessage.SendData(4, -1, -1, null, myPlayer);
		ContentSamples.FixItemsUsingPlayerColours();
	}

	public static int UnlockedMaxHair()
	{
		int num = 217;
		if (NPC.downedMartians)
		{
			num += 10;
		}
		if (NPC.downedMartians && NPC.downedMoonlord)
		{
			num++;
		}
		return num;
	}

	protected void DrawHairWindow()
	{
		if (npcChatText != "" || playerInventory || player[myPlayer].chest != -1 || npcShop != 0 || player[myPlayer].talkNPC == -1 || InGuideCraftMenu)
		{
			CancelHairWindow();
			return;
		}
		Hairstyles.UpdateUnlocks();
		int count = Hairstyles.AvailableHairstyles.Count;
		int num = screenHeight / 2 + 60;
		int num2 = screenWidth / 2 - TextureAssets.HairStyleBack.Width() / 2;
		int num3 = num + 42;
		int num4 = num2 + 22;
		int num5 = num2 + 234;
		int num6 = num + 18;
		selColor = player[myPlayer].hairColor;
		spriteBatch.Draw(TextureAssets.HairStyleBack.Value, new Vector2(num2, num), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.HairStyleBack.Width(), TextureAssets.HairStyleBack.Height()), new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
		if (new Microsoft.Xna.Framework.Rectangle(num2, num, TextureAssets.HairStyleBack.Width(), TextureAssets.HairStyleBack.Height()).Contains(MouseScreen.ToPoint()))
		{
			int num7 = PlayerInput.ScrollWheelDelta / 120;
			num7 = -num7;
			int num8 = Math.Sign(num7);
			while (num7 != 0)
			{
				if (num7 < 0)
				{
					hairStart -= 5;
					SoundEngine.PlaySound(12);
				}
				else
				{
					hairStart += 5;
					SoundEngine.PlaySound(12);
				}
				num7 -= num8;
			}
		}
		if (mouseX > num2 && mouseX < num2 + TextureAssets.HairStyleBack.Width() && mouseY > num && mouseY < num + TextureAssets.HairStyleBack.Height())
		{
			player[myPlayer].mouseInterface = true;
		}
		int num9 = num5 - 18;
		int num10 = num6 + 74;
		if (hairStart >= 1)
		{
			if (mouseX >= num9 && mouseX <= num9 + TextureAssets.CraftUpButton.Width() && mouseY >= num10 && mouseY <= num10 + TextureAssets.CraftUpButton.Height())
			{
				player[myPlayer].mouseInterface = true;
				if (mouseLeftRelease && mouseLeft)
				{
					hairStart -= 15;
					SoundEngine.PlaySound(12);
				}
			}
			spriteBatch.Draw(TextureAssets.ScrollLeftButton.Value, new Vector2(num9, num10), null, new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
		}
		if (hairStart + 15 < count)
		{
			num9 += 296;
			if (mouseX >= num9 && mouseX <= num9 + TextureAssets.CraftUpButton.Width() && mouseY >= num10 && mouseY <= num10 + TextureAssets.CraftUpButton.Height())
			{
				player[myPlayer].mouseInterface = true;
				if (mouseLeftRelease && mouseLeft)
				{
					hairStart += 15;
					SoundEngine.PlaySound(12);
				}
			}
			spriteBatch.Draw(TextureAssets.ScrollRightButton.Value, new Vector2(num9, num10), null, new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
		}
		if (hairStart + 15 >= count)
		{
			hairStart = count - 15;
		}
		if (hairStart < 0)
		{
			hairStart = 0;
		}
		int num11 = 0;
		if (oldHairStyle != player[myPlayer].hair)
		{
			num11 += 100000;
		}
		if (oldHairColor != player[myPlayer].hairColor)
		{
			num11 += 20000;
		}
		if (LocalPlayer.discountAvailable)
		{
			num11 = (int)((float)num11 * 0.8f);
		}
		num11 = (int)((float)num11 * LocalPlayer.currentShoppingSettings.PriceAdjustment);
		num11 = (int)Math.Round((float)num11 / 10000f) * 10000;
		string text = "";
		string text2 = "";
		int num12 = 0;
		int num13 = 0;
		int num14 = 0;
		int num15 = 0;
		int num16 = num11;
		_ = 0;
		if (num16 < 0)
		{
			num16 = 0;
		}
		num11 = num16;
		if (num16 >= 1000000)
		{
			num12 = num16 / 1000000;
			num16 -= num12 * 1000000;
		}
		if (num16 >= 10000)
		{
			num13 = num16 / 10000;
			num16 -= num13 * 10000;
		}
		if (num16 >= 100)
		{
			num14 = num16 / 100;
			num16 -= num14 * 100;
		}
		if (num16 >= 1)
		{
			num15 = num16;
		}
		if (num12 > 0)
		{
			text2 = text2 + num12 + " " + Lang.inter[15].Value + " ";
		}
		if (num13 > 0)
		{
			text2 = text2 + num13 + " " + Lang.inter[16].Value + " ";
		}
		if (num14 > 0)
		{
			text2 = text2 + num14 + " " + Lang.inter[17].Value + " ";
		}
		if (num15 > 0)
		{
			text2 = text2 + num15 + " " + Lang.inter[18].Value + " ";
		}
		text = Language.GetTextValue("GameUI.BuyWithValue", text2);
		if (num11 == 0)
		{
			text = Language.GetTextValue("GameUI.Buy");
		}
		int num17 = (mouseTextColor * 2 + 255) / 3;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(num17, (int)((double)num17 / 1.1), num17 / 2, num17);
		float num18 = 0.9f;
		string text3 = text;
		int num19 = num2 + 18;
		int num20 = num + 156;
		bool flag = false;
		if (num11 > 0)
		{
			ItemSlot.DrawSavings(spriteBatch, num19, num20 - 70, horizontal: true);
		}
		if (num11 > 0 && mouseX > num19 && (float)mouseX < (float)num19 + FontAssets.MouseText.Value.MeasureString(text3).X && mouseY > num20 && (float)mouseY < (float)num20 + FontAssets.MouseText.Value.MeasureString(text3).Y)
		{
			flag = true;
			num18 = 1.1f;
			if (!npcChatFocus1)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus1 = true;
			player[myPlayer].releaseUseItem = false;
		}
		else
		{
			if (npcChatFocus1)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus1 = false;
		}
		Vector2 vector = FontAssets.MouseText.Value.MeasureString(text3);
		vector *= 0.5f;
		UILinkPointNavigator.SetPosition(2603, new Vector2(num19, num20) + vector);
		for (int i = 0; i < 5; i++)
		{
			int num21 = num19;
			int num22 = num20;
			Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Black;
			if (flag)
			{
				color2 = Microsoft.Xna.Framework.Color.Brown;
			}
			if (i == 0)
			{
				num21 -= 2;
			}
			if (i == 1)
			{
				num21 += 2;
			}
			if (i == 2)
			{
				num22 -= 2;
			}
			if (i == 3)
			{
				num22 += 2;
			}
			if (i == 4)
			{
				color2 = ((num11 != 0) ? color : new Microsoft.Xna.Framework.Color(100, 100, 100));
			}
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, text3, new Vector2((float)num21 + vector.X, (float)num22 + vector.Y), color2, 0f, vector, num18, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		num18 = 0.9f;
		string textValue = Language.GetTextValue("GameUI.Cancel");
		num19 += 130;
		flag = false;
		if (mouseX > num19 && (float)mouseX < (float)num19 + FontAssets.MouseText.Value.MeasureString(textValue).X && mouseY > num20 && (float)mouseY < (float)num20 + FontAssets.MouseText.Value.MeasureString(textValue).Y)
		{
			flag = true;
			num18 = 1.1f;
			if (!npcChatFocus2)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus2 = true;
			player[myPlayer].releaseUseItem = false;
		}
		else
		{
			if (npcChatFocus2)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus2 = false;
		}
		vector = FontAssets.MouseText.Value.MeasureString(textValue);
		vector *= 0.5f;
		UILinkPointNavigator.SetPosition(2604, new Vector2(num19, num20) + vector);
		for (int j = 0; j < 5; j++)
		{
			int num23 = num19;
			int num24 = num20;
			Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.Black;
			if (flag)
			{
				color3 = Microsoft.Xna.Framework.Color.Brown;
			}
			if (j == 0)
			{
				num23 -= 2;
			}
			if (j == 1)
			{
				num23 += 2;
			}
			if (j == 2)
			{
				num24 -= 2;
			}
			if (j == 3)
			{
				num24 += 2;
			}
			if (j == 4)
			{
				color3 = color;
			}
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, textValue, new Vector2((float)num23 + vector.X, (float)num24 + vector.Y), color3, 0f, vector, num18, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		if (mouseLeft && mouseLeftRelease)
		{
			if (npcChatFocus1)
			{
				if (player[myPlayer].BuyItem(num11))
				{
					BuyHairWindow();
					return;
				}
			}
			else if (npcChatFocus2)
			{
				CancelHairWindow();
				return;
			}
		}
		if (!mouseLeft)
		{
			grabColorSlider = 0;
			blockMouse = false;
		}
		int num25 = 167;
		Vector3 vector2 = rgbToHsl(selColor);
		float num26 = vector2.X;
		float num27 = vector2.Y;
		float z = vector2.Z;
		float num28 = (float)(int)selColor.A / 255f;
		if (hBar == -1f || sBar == -1f || lBar == -1f || aBar == -1f)
		{
			hBar = num26;
			sBar = num27;
			lBar = z;
			aBar = (float)(int)selColor.A / 255f;
		}
		else
		{
			num26 = hBar;
			num27 = sBar;
			z = lBar;
			aBar = num28;
		}
		UILinkPointNavigator.SetPosition(2600, new Vector2(num4, num3) + TextureAssets.Hue.Value.Size() / 2f);
		spriteBatch.Draw(TextureAssets.Hue.Value, new Vector2(num4, num3), Microsoft.Xna.Framework.Color.White);
		if ((mouseX > num4 - 4 && mouseX < num4 + TextureAssets.Hue.Width() + 4 && mouseY > num3 - 4 && mouseY < num3 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 1)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num4, num3), OurFavoriteColor);
		}
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num4 + (float)(TextureAssets.Hue.Width() - 2) * hBar - (float)(TextureAssets.ColorSlider.Width() / 2), num3 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if (((mouseX > num4 - 4 && mouseX < num4 + TextureAssets.Hue.Width() + 4 && mouseY > num3 - 4 && mouseY < num3 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 1) && mouseLeft && !blockMouse)
		{
			grabColorSlider = 1;
			num26 = mouseX - num4;
			num26 /= (float)TextureAssets.Hue.Width();
			if (num26 < 0f)
			{
				num26 = 0f;
			}
			if (num26 > 1f)
			{
				num26 = 1f;
			}
			hBar = num26;
		}
		num3 += 26;
		UILinkPointNavigator.SetPosition(2601, new Vector2(num4, num3) + TextureAssets.ColorBar.Value.Size() / 2f);
		spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num4, num3), Microsoft.Xna.Framework.Color.White);
		for (int k = 0; k <= num25; k++)
		{
			float saturation = (float)k / (float)num25;
			Microsoft.Xna.Framework.Color color4 = hslToRgb(num26, saturation, z);
			spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num4 + k + 5, num3 + 4), color4);
		}
		if ((mouseX > num4 - 4 && mouseX < num4 + TextureAssets.Hue.Width() + 4 && mouseY > num3 - 4 && mouseY < num3 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 2)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num4, num3), OurFavoriteColor);
		}
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num4 + (float)(TextureAssets.Hue.Width() - 2) * sBar - (float)(TextureAssets.ColorSlider.Width() / 2), num3 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if (((mouseX > num4 - 4 && mouseX < num4 + TextureAssets.Hue.Width() + 4 && mouseY > num3 - 4 && mouseY < num3 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 2) && mouseLeft && !blockMouse)
		{
			grabColorSlider = 2;
			num27 = mouseX - num4;
			num27 /= (float)TextureAssets.Hue.Width();
			if (num27 < 0f)
			{
				num27 = 0f;
			}
			if (num27 > 1f)
			{
				num27 = 1f;
			}
			sBar = num27;
		}
		num3 += 26;
		UILinkPointNavigator.SetPosition(2602, new Vector2(num4, num3) + TextureAssets.ColorBar.Value.Size() / 2f);
		spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num4, num3), Microsoft.Xna.Framework.Color.White);
		float num29 = 0.15f;
		for (int l = 0; l <= num25; l++)
		{
			float luminosity = (float)l / (float)num25;
			Microsoft.Xna.Framework.Color color5 = hslToRgb(num26, num27, luminosity);
			spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num4 + l + 5, num3 + 4), color5);
		}
		if ((mouseX > num4 - 4 && mouseX < num4 + TextureAssets.Hue.Width() + 4 && mouseY > num3 - 4 && mouseY < num3 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 3)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num4, num3), OurFavoriteColor);
		}
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num4 + (float)(TextureAssets.Hue.Width() - 2) * ((lBar - num29) / (1f - num29)) - (float)(TextureAssets.ColorSlider.Width() / 2), num3 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if (((mouseX > num4 - 4 && mouseX < num4 + TextureAssets.Hue.Width() + 4 && mouseY > num3 - 4 && mouseY < num3 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 3) && mouseLeft && !blockMouse)
		{
			grabColorSlider = 3;
			z = mouseX - num4;
			z /= (float)TextureAssets.Hue.Width();
			if (z < 0f)
			{
				z = 0f;
			}
			if (z > 1f)
			{
				z = 1f;
			}
			z = z * (1f - num29) + num29;
			lBar = z;
		}
		selColor = hslToRgb(hBar, sBar, lBar);
		player[myPlayer].hairColor = selColor;
		int num30 = num5;
		int num31 = num6;
		_ = hairStart;
		int num32 = 0;
		int num33 = 0;
		for (int m = 0; m < 15; m++)
		{
			int num34 = Hairstyles.AvailableHairstyles[hairStart + m];
			UILinkPointNavigator.SetPosition(2605 + m, new Vector2(num30, num31) + TextureAssets.InventoryBack.Value.Size() * 0.75f);
			if (player[myPlayer].hair == num34)
			{
				spriteBatch.Draw(TextureAssets.InventoryBack14.Value, new Vector2(num30, num31), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.InventoryBack.Width(), TextureAssets.InventoryBack.Height()), new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			else
			{
				spriteBatch.Draw(TextureAssets.InventoryBack8.Value, new Vector2(num30, num31), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.InventoryBack.Width(), TextureAssets.InventoryBack.Height()), new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			if (mouseX > num30 && mouseX < num30 + TextureAssets.InventoryBack.Width() && mouseY > num31 && mouseY < num31 + TextureAssets.InventoryBack.Height())
			{
				Asset<Texture2D> asset = Assets.Request<Texture2D>("Images/UI/PanelBorder", AssetRequestMode.ImmediateLoad);
				Utils.DrawSplicedPanel(spriteBatch, asset.Value, num30, num31, TextureAssets.InventoryBack.Width(), TextureAssets.InventoryBack.Height(), asset.Width() / 2 - 1, asset.Width() / 2 - 1, asset.Height() / 2 - 1, asset.Height() / 2 - 1, OurFavoriteColor);
				if (mouseLeft && mouseLeftRelease)
				{
					mouseLeftRelease = false;
					player[myPlayer].hair = num34;
					SoundEngine.PlaySound(12);
				}
			}
			LoadHair(num34);
			float x = num30 + TextureAssets.InventoryBack.Width() / 2 - TextureAssets.PlayerHair[num34].Width() / 2;
			float y = num31 + 4;
			spriteBatch.Draw(TextureAssets.Players[num32, 0].Value, new Vector2(x, y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.PlayerHair[num34].Width(), 56), player[myPlayer].skinColor, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.Players[num32, 1].Value, new Vector2(x, y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.PlayerHair[num34].Width(), 56), new Microsoft.Xna.Framework.Color(255, 255, 255, 255), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.Players[num32, 2].Value, new Vector2(x, y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.PlayerHair[num34].Width(), 56), player[myPlayer].eyeColor, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			Vector2 vector3 = player[myPlayer].GetHairDrawOffset(num34, hatHair: false) * player[myPlayer].Directions;
			spriteBatch.Draw(TextureAssets.PlayerHair[num34].Value, new Vector2(x, y) + vector3, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.PlayerHair[num34].Width(), 56), selColor, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			num33++;
			num30 += 56;
			if (num33 >= 5)
			{
				num33 = 0;
				num30 = num5;
				num31 += 56;
			}
		}
	}

	public static void OpenClothesWindow()
	{
		if (clothesWindow)
		{
			CancelClothesWindow();
			return;
		}
		hBar = -1f;
		lBar = -1f;
		sBar = -1f;
		IngameUIWindows.CloseAll(quiet: true);
		clothesWindow = true;
		SoundEngine.PlaySound(10);
		selClothes = 0;
		oldClothesColor[0] = player[myPlayer].shirtColor;
		oldClothesColor[1] = player[myPlayer].underShirtColor;
		oldClothesColor[2] = player[myPlayer].pantsColor;
		oldClothesColor[3] = player[myPlayer].shoeColor;
		oldClothesColor[4] = player[myPlayer].eyeColor;
		oldClothesColor[5] = player[myPlayer].skinColor;
		if (dresserInterfaceDummy == null)
		{
			dresserInterfaceDummy = new Player();
		}
		oldClothesStyle = player[myPlayer].skinVariant;
		oldVoiceStyle = player[myPlayer].voiceVariant;
		oldVoicePitch = player[myPlayer].voicePitchOffset;
	}

	public static void CancelClothesWindow(bool quiet = false)
	{
		if (clothesWindow)
		{
			clothesWindow = false;
			if (!quiet)
			{
				SoundEngine.PlaySound(11);
			}
			player[myPlayer].shirtColor = oldClothesColor[0];
			player[myPlayer].underShirtColor = oldClothesColor[1];
			player[myPlayer].pantsColor = oldClothesColor[2];
			player[myPlayer].shoeColor = oldClothesColor[3];
			player[myPlayer].eyeColor = oldClothesColor[4];
			player[myPlayer].skinColor = oldClothesColor[5];
			dresserInterfaceDummy.skinVariant = oldClothesStyle;
			dresserInterfaceDummy.voiceVariant = oldVoiceStyle;
			dresserInterfaceDummy.Male = player[myPlayer].Male;
			dresserInterfaceDummy.voicePitchOffset = oldVoicePitch;
			player[myPlayer].skinVariant = dresserInterfaceDummy.skinVariant;
			player[myPlayer].voiceVariant = dresserInterfaceDummy.voiceVariant;
			ContentSamples.FixItemsUsingPlayerColours();
		}
	}

	public static void SaveClothesWindow()
	{
		ContentSamples.FixItemsUsingPlayerColours();
		SoundEngine.PlaySound(7);
		clothesWindow = false;
		NetMessage.SendData(4, -1, -1, null, myPlayer);
	}

	protected void DrawClothesWindow()
	{
		if (npcChatText != "" || playerInventory || player[myPlayer].chest != -1 || npcShop != 0 || player[myPlayer].talkNPC != -1 || InGuideCraftMenu)
		{
			CancelClothesWindow();
			return;
		}
		if (!LocalPlayer.IsInInteractionRangeToMultiTileHitbox(interactedDresserTopLeftX, interactedDresserTopLeftY) || !tile[interactedDresserTopLeftX, interactedDresserTopLeftY].active())
		{
			CancelClothesWindow();
			return;
		}
		int num = 477;
		int num2 = 163;
		int num3 = num / 2;
		num3 = 180;
		num = 511;
		num -= num / 2 - num3 - 26;
		int num4 = screenHeight / 2 + 60;
		int num5 = screenWidth / 2 - num / 2;
		int num6 = num4 + 32;
		int num7 = num5 + 22;
		num6 -= 16;
		int num8 = num5 + num - num3;
		int num9 = num4 + 18;
		if (selClothes == 0)
		{
			selColor = player[myPlayer].shirtColor;
		}
		if (selClothes == 1)
		{
			selColor = player[myPlayer].underShirtColor;
		}
		if (selClothes == 2)
		{
			selColor = player[myPlayer].pantsColor;
		}
		if (selClothes == 3)
		{
			selColor = player[myPlayer].shoeColor;
		}
		if (selClothes == 4)
		{
			selColor = player[myPlayer].eyeColor;
		}
		if (selClothes == 5)
		{
			selColor = player[myPlayer].skinColor;
		}
		Utils.DrawInvBG(spriteBatch, new Microsoft.Xna.Framework.Rectangle(num5, num4, num, num2));
		if (!PlayerInput.IgnoreMouseInterface && mouseX > num5 && mouseX < num5 + num && mouseY > num4 && mouseY < num4 + num2)
		{
			player[myPlayer].mouseInterface = true;
		}
		Vector2 vector = new Vector2(num5 + num / 2 - 16 - 28, num4 + 66 + dresserInterfaceDummy.height / 2 - 20);
		vector.Y += 18f;
		vector.X += 58f;
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)vector.X - dresserInterfaceDummy.width / 2 - 15, (int)vector.Y - dresserInterfaceDummy.height - 33, dresserInterfaceDummy.width + 30, dresserInterfaceDummy.height + 66);
		rectangle.Height -= 50;
		vector.Y -= 22f;
		bool flag = rectangle.Contains(MouseScreen.ToPoint());
		int num10 = selClothes;
		int num11 = (mouseTextColor * 2 + 255) / 3;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(num11, (int)((double)num11 / 1.1), num11 / 2, num11);
		float num12 = 0.9f;
		string textValue = Language.GetTextValue("GameUI.Change");
		int num13 = num5 + num - num3 + 22;
		num13 = num5 + 22;
		int num14 = num4 + 94 + 30;
		bool flag2 = false;
		if (oldClothesColor[0] != player[myPlayer].shirtColor || oldClothesColor[1] != player[myPlayer].underShirtColor || oldClothesColor[2] != player[myPlayer].pantsColor || oldClothesColor[3] != player[myPlayer].shoeColor || oldClothesColor[4] != player[myPlayer].eyeColor || oldClothesColor[5] != player[myPlayer].skinColor || oldVoiceStyle != player[myPlayer].voiceVariant || oldClothesStyle != player[myPlayer].skinVariant || oldVoicePitch != player[myPlayer].voicePitchOffset)
		{
			flag2 = true;
		}
		Vector2 vector2 = FontAssets.MouseText.Value.MeasureString(textValue);
		bool flag3 = false;
		UILinkPointNavigator.SetPosition(2803, new Vector2(num13, num14) + vector2 * num12 * 0.5f);
		if (flag2 && mouseX > num13 && (float)mouseX < (float)num13 + vector2.X && mouseY > num14 && (float)mouseY < (float)num14 + vector2.Y)
		{
			flag3 = true;
			num12 = 1.1f;
			if (!npcChatFocus1)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus1 = true;
			player[myPlayer].releaseUseItem = false;
		}
		else
		{
			if (npcChatFocus1)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus1 = false;
		}
		for (int i = 0; i < 5; i++)
		{
			int num15 = num13;
			int num16 = num14;
			Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.Black;
			if (flag3)
			{
				color2 = Microsoft.Xna.Framework.Color.Brown;
			}
			if (i == 0)
			{
				num15 -= 2;
			}
			if (i == 1)
			{
				num15 += 2;
			}
			if (i == 2)
			{
				num16 -= 2;
			}
			if (i == 3)
			{
				num16 += 2;
			}
			if (i == 4)
			{
				color2 = (flag2 ? color : new Microsoft.Xna.Framework.Color(100, 100, 100));
			}
			Vector2 vector3 = FontAssets.MouseText.Value.MeasureString(textValue);
			vector3 *= 0.5f;
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, textValue, new Vector2((float)num15 + vector3.X, (float)num16 + vector3.Y), color2, 0f, vector3, num12, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		num12 = 0.9f;
		string textValue2 = Language.GetTextValue("GameUI.Cancel");
		num13 += 130;
		bool flag4 = false;
		vector2 = FontAssets.MouseText.Value.MeasureString(textValue2);
		UILinkPointNavigator.SetPosition(2804, new Vector2(num13, num14) + vector2 * num12 * 0.5f);
		if (mouseX > num13 && (float)mouseX < (float)num13 + vector2.X && mouseY > num14 && (float)mouseY < (float)num14 + vector2.Y)
		{
			flag4 = true;
			num12 = 1.1f;
			if (!npcChatFocus2)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus2 = true;
			player[myPlayer].releaseUseItem = false;
		}
		else
		{
			if (npcChatFocus2)
			{
				SoundEngine.PlaySound(12);
			}
			npcChatFocus2 = false;
		}
		for (int j = 0; j < 5; j++)
		{
			int num17 = num13;
			int num18 = num14;
			Microsoft.Xna.Framework.Color color3 = Microsoft.Xna.Framework.Color.Black;
			if (flag4)
			{
				color3 = Microsoft.Xna.Framework.Color.Brown;
			}
			if (j == 0)
			{
				num17 -= 2;
			}
			if (j == 1)
			{
				num17 += 2;
			}
			if (j == 2)
			{
				num18 -= 2;
			}
			if (j == 3)
			{
				num18 += 2;
			}
			if (j == 4)
			{
				color3 = color;
			}
			Vector2 vector4 = FontAssets.MouseText.Value.MeasureString(textValue2);
			vector4 *= 0.5f;
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, textValue2, new Vector2((float)num17 + vector4.X, (float)num18 + vector4.Y), color3, 0f, vector4, num12, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		if (mouseLeft && mouseLeftRelease)
		{
			if (npcChatFocus1)
			{
				SaveClothesWindow();
				return;
			}
			if (npcChatFocus2)
			{
				CancelClothesWindow();
				return;
			}
		}
		if (!mouseLeft)
		{
			grabColorSlider = 0;
			blockMouse = false;
		}
		int num19 = 167;
		Vector3 vector5 = rgbToHsl(selColor);
		float num20 = vector5.X;
		float num21 = vector5.Y;
		float z = vector5.Z;
		if (hBar == -1f || sBar == -1f || lBar == -1f)
		{
			hBar = num20;
			sBar = num21;
			lBar = z;
		}
		else
		{
			num20 = hBar;
			num21 = sBar;
			z = lBar;
		}
		spriteBatch.Draw(TextureAssets.Hue.Value, new Vector2(num7, num6), Microsoft.Xna.Framework.Color.White);
		if ((mouseX > num7 - 4 && mouseX < num7 + TextureAssets.Hue.Width() + 4 && mouseY > num6 - 4 && mouseY < num6 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 1)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num7, num6), OurFavoriteColor);
		}
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num7 + (float)(TextureAssets.Hue.Width() - 2) * hBar - (float)(TextureAssets.ColorSlider.Width() / 2), num6 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if (((mouseX > num7 - 4 && mouseX < num7 + TextureAssets.Hue.Width() + 4 && mouseY > num6 - 4 && mouseY < num6 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 1) && mouseLeft && !blockMouse)
		{
			grabColorSlider = 1;
			num20 = mouseX - num7;
			num20 /= (float)TextureAssets.Hue.Width();
			if (num20 < 0f)
			{
				num20 = 0f;
			}
			if (num20 > 1f)
			{
				num20 = 1f;
			}
			hBar = num20;
		}
		UILinkPointNavigator.SetPosition(2800, new Vector2(num7, num6) + TextureAssets.Hue.Value.Size() / 2f);
		num6 += 26;
		spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num7, num6), Microsoft.Xna.Framework.Color.White);
		for (int k = 0; k <= num19; k++)
		{
			float saturation = (float)k / (float)num19;
			Microsoft.Xna.Framework.Color color4 = hslToRgb(num20, saturation, z);
			spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num7 + k + 5, num6 + 4), color4);
		}
		if ((mouseX > num7 - 4 && mouseX < num7 + TextureAssets.Hue.Width() + 4 && mouseY > num6 - 4 && mouseY < num6 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 2)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num7, num6), OurFavoriteColor);
		}
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num7 + (float)(TextureAssets.Hue.Width() - 2) * sBar - (float)(TextureAssets.ColorSlider.Width() / 2), num6 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if (((mouseX > num7 - 4 && mouseX < num7 + TextureAssets.Hue.Width() + 4 && mouseY > num6 - 4 && mouseY < num6 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 2) && mouseLeft && !blockMouse)
		{
			grabColorSlider = 2;
			num21 = mouseX - num7;
			num21 /= (float)TextureAssets.Hue.Width();
			if (num21 < 0f)
			{
				num21 = 0f;
			}
			if (num21 > 1f)
			{
				num21 = 1f;
			}
			sBar = num21;
		}
		UILinkPointNavigator.SetPosition(2801, new Vector2(num7, num6) + TextureAssets.Hue.Value.Size() / 2f);
		num6 += 26;
		spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num7, num6), Microsoft.Xna.Framework.Color.White);
		float num22 = 0.15f;
		for (int l = 0; l <= num19; l++)
		{
			float luminosity = (float)l / (float)num19;
			Microsoft.Xna.Framework.Color color5 = hslToRgb(num20, num21, luminosity);
			spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num7 + l + 5, num6 + 4), color5);
		}
		if ((mouseX > num7 - 4 && mouseX < num7 + TextureAssets.Hue.Width() + 4 && mouseY > num6 - 4 && mouseY < num6 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 3)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num7, num6), OurFavoriteColor);
		}
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num7 + (float)(TextureAssets.Hue.Width() - 2) * ((lBar - num22) / (1f - num22)) - (float)(TextureAssets.ColorSlider.Width() / 2), num6 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if (((mouseX > num7 - 4 && mouseX < num7 + TextureAssets.Hue.Width() + 4 && mouseY > num6 - 4 && mouseY < num6 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 3) && mouseLeft && !blockMouse)
		{
			grabColorSlider = 3;
			z = mouseX - num7;
			z /= (float)TextureAssets.Hue.Width();
			if (z < 0f)
			{
				z = 0f;
			}
			if (z > 1f)
			{
				z = 1f;
			}
			z = z * (1f - num22) + num22;
			lBar = z;
		}
		UILinkPointNavigator.SetPosition(2802, new Vector2(num7, num6) + TextureAssets.Hue.Value.Size() / 2f);
		selColor = hslToRgb(hBar, sBar, lBar);
		if (selClothes == 0)
		{
			player[myPlayer].shirtColor = selColor;
		}
		if (selClothes == 1)
		{
			player[myPlayer].underShirtColor = selColor;
		}
		if (selClothes == 2)
		{
			player[myPlayer].pantsColor = selColor;
		}
		if (selClothes == 3)
		{
			player[myPlayer].shoeColor = selColor;
		}
		if (selClothes == 4)
		{
			player[myPlayer].eyeColor = selColor;
		}
		if (selClothes == 5)
		{
			player[myPlayer].skinColor = selColor;
		}
		int num23 = num8;
		int num24 = num9;
		num24 -= 8;
		for (int m = 0; m < 6; m++)
		{
			if (num10 == m)
			{
				spriteBatch.Draw(TextureAssets.InventoryBack14.Value, new Vector2(num23, num24), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.InventoryBack.Width(), TextureAssets.InventoryBack.Height()), new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			else
			{
				spriteBatch.Draw(TextureAssets.InventoryBack8.Value, new Vector2(num23, num24), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.InventoryBack.Width(), TextureAssets.InventoryBack.Height()), new Microsoft.Xna.Framework.Color(200, 200, 200, 200), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			if (mouseX > num23 && mouseX < num23 + TextureAssets.InventoryBack.Width() && mouseY > num24 && mouseY < num24 + TextureAssets.InventoryBack.Height() && mouseLeft && mouseLeftRelease)
			{
				mouseLeftRelease = false;
				selClothes = m;
				SoundEngine.PlaySound(12);
				hBar = -1f;
				lBar = -1f;
				sBar = -1f;
			}
			float x = num23 + TextureAssets.InventoryBack.Width() / 2 - TextureAssets.Clothes[m].Width() / 2;
			float y = num24 + TextureAssets.InventoryBack.Height() / 2 - TextureAssets.Clothes[m].Height() / 2;
			Microsoft.Xna.Framework.Color color6 = Microsoft.Xna.Framework.Color.White;
			if (m == 0)
			{
				color6 = player[myPlayer].shirtColor;
			}
			if (m == 1)
			{
				color6 = player[myPlayer].underShirtColor;
			}
			if (m == 2)
			{
				color6 = player[myPlayer].pantsColor;
			}
			if (m == 3)
			{
				color6 = player[myPlayer].shoeColor;
			}
			if (m == 4)
			{
				color6 = player[myPlayer].eyeColor;
			}
			if (m == 5)
			{
				color6 = player[myPlayer].skinColor;
			}
			spriteBatch.Draw(TextureAssets.Clothes[m].Value, new Vector2(x, y), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Clothes[m].Width(), TextureAssets.Clothes[m].Height()), color6, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			if (m == 4)
			{
				Texture2D value = Assets.Request<Texture2D>("Images/UI/CharCreation/ColorEyeBack", AssetRequestMode.ImmediateLoad).Value;
				spriteBatch.Draw(value, new Vector2(x, y), value.Frame(), Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			UILinkPointNavigator.SetPosition(2806 + m, new Vector2(x, y) + TextureAssets.Clothes[m].Value.Size() * 0.75f);
			num23 += 56;
			if (m == 1)
			{
				num23 -= 112;
				num24 += 56;
			}
			if (m == 3)
			{
				num24 -= 56;
			}
			if (m == 4)
			{
				num24 += 56;
				num23 -= 56;
			}
		}
		dresserInterfaceDummy.skinVariant = player[myPlayer].skinVariant;
		dresserInterfaceDummy.eyeColor = player[myPlayer].eyeColor;
		dresserInterfaceDummy.hairColor = player[myPlayer].hairColor;
		dresserInterfaceDummy.hair = player[myPlayer].hair;
		dresserInterfaceDummy.skinColor = player[myPlayer].skinColor;
		dresserInterfaceDummy.shirtColor = player[myPlayer].shirtColor;
		dresserInterfaceDummy.underShirtColor = player[myPlayer].underShirtColor;
		dresserInterfaceDummy.shoeColor = player[myPlayer].shoeColor;
		dresserInterfaceDummy.pantsColor = player[myPlayer].pantsColor;
		dresserInterfaceDummy.Bottom = screenPosition + vector;
		dresserInterfaceDummy.direction = -1;
		dresserInterfaceDummy.gravDir = 1f;
		dresserInterfaceDummy.PlayerFrame();
		dresserInterfaceDummy.socialIgnoreLight = true;
		Microsoft.Xna.Framework.Color c = new Microsoft.Xna.Framework.Color(46, 106, 98) * 0.6f;
		if (flag)
		{
			c = new Microsoft.Xna.Framework.Color(46, 106, 98) * 2f * 0.6f;
			if (mouseLeft && mouseLeftRelease)
			{
				mouseLeftRelease = false;
				SoundEngine.PlaySound(12);
				CycleClothingStyle(player[myPlayer]);
			}
		}
		UILinkPointNavigator.SetPosition(2805, rectangle.Center.ToVector2());
		Utils.DrawInvBG(spriteBatch, rectangle, c);
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Immediate, null, null, null, null, null, UIScaleMatrix);
		PlayerRenderer.DrawPlayer(Camera, dresserInterfaceDummy, dresserInterfaceDummy.position, dresserInterfaceDummy.fullRotation, dresserInterfaceDummy.fullRotationOrigin);
		Microsoft.Xna.Framework.Rectangle r = rectangle;
		r.Y += r.Height + 4;
		r.Height = 46;
		UILinkPointNavigator.SetPosition(2813, r.Center.ToVector2());
		bool num25 = r.Contains(MouseScreen.ToPoint());
		Microsoft.Xna.Framework.Color c2 = new Microsoft.Xna.Framework.Color(46, 106, 98) * 0.6f;
		if (num25)
		{
			c2 = new Microsoft.Xna.Framework.Color(46, 106, 98) * 2f * 0.6f;
			if (mouseLeft && mouseLeftRelease)
			{
				mouseLeftRelease = false;
				CycleVoiceStyle(player[myPlayer], 1);
				int voiceVariant = dresserInterfaceDummy.voiceVariant;
				Vector2 position = dresserInterfaceDummy.position;
				_ = dresserInterfaceDummy.voicePitchOffset;
				dresserInterfaceDummy.voiceVariant = player[myPlayer].voiceVariant;
				dresserInterfaceDummy.voicePitchOffset = player[myPlayer].voicePitchOffset;
				dresserInterfaceDummy.position = new Vector2(-1f, -1f);
				dresserInterfaceDummy.PlayHurtSound();
				dresserInterfaceDummy.position = position;
				dresserInterfaceDummy.voiceVariant = voiceVariant;
				dresserInterfaceDummy.voicePitchOffset = voiceVariant;
			}
		}
		Utils.DrawInvBG(spriteBatch, r, c2);
		Asset<Texture2D> asset = Assets.Request<Texture2D>("Images/UI/CharCreation/Voice", AssetRequestMode.ImmediateLoad);
		Microsoft.Xna.Framework.Color color7 = PlayerVoiceID.Sets.Colors[player[myPlayer].voiceVariant];
		spriteBatch.Draw(asset.Value, r.Center.ToVector2(), null, color7, 0f, asset.Size() / 2f, 1f, SpriteEffects.None, 0f);
		int num26 = num7;
		int num27 = num6 + 30;
		spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num26, num27), Microsoft.Xna.Framework.Color.White);
		for (int n = 0; n <= num19; n++)
		{
			float fromValue = ((float)n / (float)num19 * 4f + 0.5f) % 1f;
			float num28 = Utils.Remap(fromValue, 0f, 0.5f, 0f, 1f) * Utils.Remap(fromValue, 0.5f, 1f, 1f, 0f);
			float amount = num28 * num28 * num28 * num28 * num28;
			Microsoft.Xna.Framework.Color color8 = Microsoft.Xna.Framework.Color.Lerp(new Microsoft.Xna.Framework.Color(90, 90, 120), Microsoft.Xna.Framework.Color.White, amount);
			spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num26 + n + 5, num27 + 4), color8);
		}
		if ((mouseX > num26 - 4 && mouseX < num26 + TextureAssets.Hue.Width() + 4 && mouseY > num27 - 4 && mouseY < num27 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 4)
		{
			spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num26, num27), OurFavoriteColor);
		}
		float num29 = Utils.Remap(LocalPlayer.voicePitchOffset, -1f, 1f, 0f, 1f);
		spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num26 + (float)(TextureAssets.Hue.Width() - 2) * num29 - (float)(TextureAssets.ColorSlider.Width() / 2), num27 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
		if ((mouseX > num26 - 4 && mouseX < num26 + TextureAssets.Hue.Width() + 4 && mouseY > num27 - 4 && mouseY < num27 + TextureAssets.Hue.Height() + 4) || grabColorSlider == 4)
		{
			int num30 = grabColorSlider;
			if (mouseLeft && !blockMouse)
			{
				grabColorSlider = 4;
				z = mouseX - num26;
				z /= (float)TextureAssets.Hue.Width();
				if (z < 0f)
				{
					z = 0f;
				}
				if (z > 1f)
				{
					z = 1f;
				}
				int num31 = 20;
				float fromValue2 = (float)Math.Round(z * (float)num31) / (float)num31;
				float voicePitchOffset = LocalPlayer.voicePitchOffset;
				LocalPlayer.voicePitchOffset = Utils.Remap(fromValue2, 0f, 1f, -1f, 1f);
				if (LocalPlayer.voicePitchOffset != voicePitchOffset || num30 != grabColorSlider)
				{
					int voiceVariant2 = dresserInterfaceDummy.voiceVariant;
					Vector2 position2 = dresserInterfaceDummy.position;
					_ = dresserInterfaceDummy.voicePitchOffset;
					dresserInterfaceDummy.voiceVariant = player[myPlayer].voiceVariant;
					dresserInterfaceDummy.voicePitchOffset = player[myPlayer].voicePitchOffset;
					dresserInterfaceDummy.position = new Vector2(-1f, -1f);
					dresserInterfaceDummy.PlayHurtSound();
					dresserInterfaceDummy.position = position2;
					dresserInterfaceDummy.voiceVariant = voiceVariant2;
					dresserInterfaceDummy.voicePitchOffset = voiceVariant2;
				}
			}
		}
		UILinkPointNavigator.SetPosition(2812, new Vector2(num26, num27) + TextureAssets.Hue.Value.Size() / 2f);
	}

	private void DrawInterface_Tests()
	{
	}

	private void SetupDrawInterfaceLayers()
	{
		if (_needToSetupDrawInterfaceLayers)
		{
			_needToSetupDrawInterfaceLayers = false;
			_gameInterfaceLayers = new List<GameInterfaceLayer>();
			_gameInterfaceLayers.AddRange(new GameInterfaceLayer[43]
			{
				new LegacyGameInterfaceLayer("Vanilla: Interface Logic 1", delegate
				{
					DrawInterface_0_InterfaceLogic1();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: MP Player Names", delegate
				{
					DrawInterface_20_MultiplayerPlayerNames();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Emote Bubbles", delegate
				{
					DrawInterface_1_1_DrawEmoteBubblesInWorld();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Entity Markers", delegate
				{
					DrawInterface_1_2_DrawEntityMarkersInWorld();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Smart Cursor Targets", delegate
				{
					DrawInterface_2_SmartCursorTargets();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Laser Ruler", delegate
				{
					DrawInterface_3_LaserRuler();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Ruler", delegate
				{
					DrawInterface_4_Ruler();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Gamepad Lock On", delegate
				{
					DrawInterface_5_GamepadLockOn();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Tile Grid Option", delegate
				{
					DrawInterface_6_TileGridOption();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Town NPC House Banners", delegate
				{
					DrawInterface_7_TownNPCHouseBanners();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Hide UI Toggle", DrawInterface_8_CheckF11UIHideToggle, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Wire Selection", delegate
				{
					DrawInterface_9_WireSelection();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Capture Manager Check", DrawInterface_10_CheckCaptureManager),
				new LegacyGameInterfaceLayer("Vanilla: Ingame Options", DrawInterface_11_IngameOptionsMenu, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Fancy UI", DrawInterface_12_IngameFancyUI, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Achievement Complete Popups", delegate
				{
					DrawInterface_13_AchievementCompletePopups();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Entity Health Bars", delegate
				{
					DrawInterface_14_EntityHealthBars();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Invasion Progress Bars", delegate
				{
					DrawInterface_15_InvasionProgressBars();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Map / Minimap", delegate
				{
					DrawInterface_16_MapOrMinimap();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Diagnose Net", delegate
				{
					DrawInterface_17_DiagnoseNet();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Sign Tile Bubble", delegate
				{
					DrawInterface_19_SignTileBubble();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Hair Window", delegate
				{
					DrawInterface_21_HairWindow();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Dresser Window", delegate
				{
					DrawInterface_22_DresserWindow();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: NPC / Sign Dialog", delegate
				{
					DrawInterface_23_NPCSignsDialog();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Interface Logic 2", delegate
				{
					DrawInterface_24_InterfaceLogic2();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Resource Bars", delegate
				{
					DrawInterface_25_ResourceBars();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Interface Logic 3", delegate
				{
					DrawInterface_26_InterfaceLogic3();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Inventory", delegate
				{
					DrawInterface_27_Inventory();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Info Accessories Bar", delegate
				{
					DrawInterface_28_InfoAccs();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Settings Button", delegate
				{
					DrawInterface_29_SettingsButton();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Control Hints", delegate
				{
					DrawInterface_29B_ControlHints();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Hotbar", delegate
				{
					DrawInterface_30_Hotbar();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Builder Accessories Bar", delegate
				{
					DrawInterface_31_BuilderAccToggles();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Radial Hotbars", delegate
				{
					DrawInterface_32_GamepadRadialHotbars();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Mouse Text", delegate
				{
					DrawInterface_33_MouseText();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Player Chat", delegate
				{
					DrawInterface_34_PlayerChat();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Death Text", delegate
				{
					DrawInterface_35_YouDied();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Cursor", delegate
				{
					DrawInterface_36_Cursor();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Debug Stuff", delegate
				{
					DrawInterface_37_DebugStuff();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Mouse Item / NPC Head", delegate
				{
					DrawInterface_38_MouseCarriedObject();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Mouse Over", delegate
				{
					DrawInterface_39_MouseOver();
					return true;
				}),
				new LegacyGameInterfaceLayer("Vanilla: Interact Item Icon", delegate
				{
					DrawInterface_40_InteractItemIcon();
					return true;
				}, InterfaceScaleType.UI),
				new LegacyGameInterfaceLayer("Vanilla: Interface Logic 4", delegate
				{
					DrawInterface_41_InterfaceLogic4();
					return true;
				}, InterfaceScaleType.UI)
			});
		}
	}

	protected void DrawInterface(GameTime gameTime)
	{
		_drawInterfaceGameTime = gameTime;
		if (_needToSetupDrawInterfaceLayers)
		{
			SetupDrawInterfaceLayers();
		}
		using (List<GameInterfaceLayer>.Enumerator enumerator = _gameInterfaceLayers.GetEnumerator())
		{
			while (enumerator.MoveNext() && enumerator.Current.Draw())
			{
			}
		}
		CoinSlot.UpdateSlotAnims();
		PlayerInput.SetZoom_UI();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, UIScaleMatrix);
		DrawPendingMouseText();
		spriteBatch.End();
		cursorOverride = -1;
		DebugLineDraw.UI.Draw(spriteBatch);
		PlayerInput.SetZoom_World();
	}

	private static void DrawWallOfCopperShortswords()
	{
		UnifiedRandom r = new UnifiedRandom(5000);
		Texture2D value = TextureAssets.Cloud[28].Value;
		Vector2 vector = ScreenSize.ToVector2();
		spriteBatch.Begin();
		for (int i = 0; i < 20000; i++)
		{
			Vector2 vector2 = r.NextVector2Square(-0.1f, 1.1f);
			vector2.X -= 0.1f;
			vector2.X += GlobalTimeWrappedHourly % 10f / 10f * 1.2f;
			vector2.Y -= GlobalTimeWrappedHourly % 10f / 10f;
			if (vector2.Y < -0.2f)
			{
				vector2.Y += 1.4f;
			}
			if (vector2.X > 1.1f)
			{
				vector2.X -= 1.2f;
			}
			Vector2 position = vector2 * vector;
			spriteBatch.Draw(value, position, Microsoft.Xna.Framework.Color.White);
		}
		spriteBatch.End();
	}

	private static void DrawWallOfBoulders()
	{
		UnifiedRandom r = new UnifiedRandom(5000);
		instance.LoadProjectile(99);
		Texture2D value = TextureAssets.Projectile[99].Value;
		Vector2 vector = ScreenSize.ToVector2();
		spriteBatch.Begin();
		for (int i = 0; i < 20000; i++)
		{
			Vector2 vector2 = r.NextVector2Square(-0.1f, 1.1f);
			vector2.X *= 0.1f;
			vector2.X -= 0.1f;
			vector2.X += GlobalTimeWrappedHourly % 10f / 10f * 1.2f;
			vector2.Y -= GlobalTimeWrappedHourly % 10f / 10f;
			if (vector2.Y < -0.2f)
			{
				vector2.Y += 1.4f;
			}
			if (vector2.X > 1.1f)
			{
				vector2.X -= 1.2f;
			}
			Vector2 position = vector2 * vector;
			spriteBatch.Draw(value, position, Microsoft.Xna.Framework.Color.White);
		}
		spriteBatch.End();
	}

	private static void DrawInterface_41_InterfaceLogic4()
	{
		if (mouseRight)
		{
			npcChatRelease = false;
		}
		else
		{
			npcChatRelease = true;
		}
	}

	private static void DrawSpectatingControlHint()
	{
		if (((LocalPlayer.CanDeathSpectate && LocalPlayer.AnyoneToSpectate()) || LocalPlayer.spectating >= 0) && !drawingPlayerChat && !PlayerInput.SettingsForUI.ShowGamepadHints)
		{
			string textValue = Language.GetTextValue((LocalPlayer.spectating >= 0) ? "Game.SpectateHintChangeTarget" : "Game.SpectateHint");
			ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, textValue, new Vector2((float)(screenWidth / 2) - FontAssets.MouseText.Value.MeasureString(textValue).X / 2f, screenHeight - 30), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, Vector2.Zero, Vector2.One);
		}
	}

	private static void DrawPendingMouseText()
	{
		DrawGamepadInstructions();
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
		if (instance._mouseTextCache.isValid)
		{
			instance.MouseTextInner(instance._mouseTextCache);
			if (!mapFullscreen)
			{
				DrawInterface_36_Cursor();
			}
			instance._mouseTextCache.noOverride = false;
		}
	}

	private void DrawInterface_40_InteractItemIcon()
	{
		if (HoveringOverAnNPC || LocalPlayer.mouseInterface)
		{
			return;
		}
		Item heldItem = LocalPlayer.HeldItem;
		int num = heldItem.type;
		if (player[myPlayer].UsingBiomeTorches)
		{
			switch (num)
			{
			case 8:
				num = player[myPlayer].BiomeTorchHoldStyle(num);
				break;
			case 966:
				num = player[myPlayer].BiomeCampfireHoldStyle(num);
				break;
			}
		}
		if (player[myPlayer].cursorItemIconID != 0)
		{
			num = player[myPlayer].cursorItemIconID;
		}
		bool flag = LocalPlayer.cursorItemIconEnabled && num != 0 && MouseDisplayItem.IsAir;
		ItemIconCacheVerification();
		bool flag2 = _itemIconCacheTime > 0 && mouseItem.type < 1;
		if (!(flag || flag2))
		{
			return;
		}
		int t = _itemIconCacheSelectedItemID;
		if (!flag)
		{
			Utils.Swap(ref t, ref player[myPlayer].cursorItemIconID);
		}
		Microsoft.Xna.Framework.Color currentColor = player[myPlayer].inventory[player[myPlayer].selectedItem].GetAlpha(Microsoft.Xna.Framework.Color.White);
		Microsoft.Xna.Framework.Color color = player[myPlayer].inventory[player[myPlayer].selectedItem].GetColor(Microsoft.Xna.Framework.Color.White);
		if (player[myPlayer].cursorItemIconID != 0)
		{
			currentColor = Microsoft.Xna.Framework.Color.White;
			color = default(Microsoft.Xna.Framework.Color);
		}
		float num2 = 1f;
		num2 = cursorScale;
		ItemSlot.GetItemLight(ref currentColor, num);
		SpriteEffects effects = SpriteEffects.None;
		if (player[myPlayer].cursorItemIconReversed)
		{
			effects = SpriteEffects.FlipHorizontally;
		}
		if (num > 0)
		{
			int num3 = 10 + player[myPlayer].cursorItemIconPush;
			instance.LoadItem(num);
			Vector2 vector = Item.GetDrawHitbox(num, null).Size() * num2 * 0.5f;
			ItemSlot.DrawItemIcon(ContentSamples.ItemsByType[num], 21, spriteBatch, new Vector2(mouseX + num3, mouseY + num3) + vector, num2, 9999f, currentColor);
			if (num == heldItem.type && TryGetAmmo(heldItem, out var ammoItem, out var ammoColor, out var ammoScale, out var ammoOffset))
			{
				float scale = num2 * ammoScale;
				int type = ammoItem.type;
				Microsoft.Xna.Framework.Color alpha = ammoItem.GetAlpha(ammoColor);
				instance.LoadItem(type);
				spriteBatch.Draw(TextureAssets.Item[type].Value, new Vector2(mouseX + 10, mouseY + 10) + ammoOffset, Item.GetDrawHitbox(type, null), alpha, 0f, default(Vector2), scale, effects, 0f);
			}
		}
		if (player[myPlayer].cursorItemIconText != "")
		{
			MouseText(player[myPlayer].cursorItemIconText, 0, 0);
		}
		if (player[myPlayer].cursorItemIconID == 0 && player[myPlayer].inventory[player[myPlayer].selectedItem].color != default(Microsoft.Xna.Framework.Color))
		{
			instance.LoadItem(player[myPlayer].inventory[player[myPlayer].selectedItem].type);
			spriteBatch.Draw(TextureAssets.Item[player[myPlayer].inventory[player[myPlayer].selectedItem].type].Value, new Vector2(mouseX + 10, mouseY + 10), Item.GetDrawHitbox(player[myPlayer].inventory[player[myPlayer].selectedItem].type, null), color, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
		}
		if (!flag)
		{
			Utils.Swap(ref t, ref player[myPlayer].cursorItemIconID);
		}
	}

	private bool TryGetAmmo(Item sourceItem, out Item ammoItem, out Microsoft.Xna.Framework.Color ammoColor, out float ammoScale, out Vector2 ammoOffset)
	{
		ammoItem = null;
		ammoColor = Microsoft.Xna.Framework.Color.White;
		ammoScale = 0.8f;
		ammoOffset = Vector2.Zero;
		int type = sourceItem.type;
		if (type == 1071 || type == 1543 || type == 1072 || type == 1544)
		{
			int num = 22;
			int num2 = 22;
			if (type == 1072 || type == 1544)
			{
				num = 28;
				num2 = 28;
			}
			ammoOffset = new Vector2(num, num2);
			ammoItem = player[myPlayer].FindPaintOrCoating();
			return ammoItem != null;
		}
		FlexibleTileWand flexibleTileWand = sourceItem.GetFlexibleTileWand();
		if (flexibleTileWand != null && flexibleTileWand.ShowsHoverAmmoIcon && flexibleTileWand.TryGetPlacementOption(LocalPlayer, Player.FlexibleWandRandomSeed, Player.FlexibleWandCycleOffset, out var _, out ammoItem))
		{
			ammoOffset = new Vector2(28f, 28f);
			return true;
		}
		return false;
	}

	private void DrawInterface_39_MouseOver()
	{
		if (ignoreErrors)
		{
			try
			{
				DrawMouseOver();
				return;
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				return;
			}
		}
		DrawMouseOver();
	}

	public void PerformHousingCheck(int x, int y)
	{
		int n = -1;
		WorldGen.MoveTownNPC(x, y, n, RichRoomCheckFeedback.Instance);
		if (WorldGen.MoveTownNPC(x, y, n, NoRoomCheckFeedback.WithText))
		{
			NewText(Lang.inter[39].Value, byte.MaxValue, 240, 20);
		}
	}

	public void TryMovingNPC(int x, int y, int selectedNPC)
	{
		if (WorldGen.MoveTownNPC(x, y, selectedNPC))
		{
			SetMouseNPC(-1, -1);
			WorldGen.moveRoom(x, y, selectedNPC);
			SoundEngine.PlaySound(12);
		}
	}

	private void DrawInterface_38_MouseCarriedObject()
	{
		Item inv = MouseDisplayItem;
		if (!inv.IsAir)
		{
			SetMouseNPC(-1, -1);
			mouseText = true;
			float num = inventoryScale;
			inventoryScale = cursorScale;
			DoGlowingMouseItemDraw = true;
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Immediate, null, null, null, null, null, UIScaleMatrix);
			ItemSlot.Draw(spriteBatch, ref inv, 21, new Vector2(mouseX, mouseY));
			inventoryScale = num;
			DoGlowingMouseItemDraw = false;
		}
		else
		{
			if (mouseNPCType <= -1)
			{
				return;
			}
			float num2 = 1f;
			num2 *= cursorScale;
			if (mouseNPCIndex >= 0)
			{
				NPC nPC = npc[mouseNPCIndex];
				if (!nPC.active || nPC.type != mouseNPCType)
				{
					SetMouseNPC_ToHousingQuery();
				}
			}
			int type = mouseNPCType;
			int num3 = ((mouseNPCIndex >= 0) ? TownNPCProfiles.GetHeadIndexSafe(npc[mouseNPCIndex]) : NPC.TypeToDefaultHeadIndex(type));
			Texture2D value = TextureAssets.NpcHead[num3].Value;
			spriteBatch.Draw(value, new Vector2((float)mouseX + 26f * num2 - (float)value.Width * 0.5f * num2, (float)mouseY + 26f * num2 - (float)value.Height * 0.5f * num2), null, Microsoft.Xna.Framework.Color.White, 0f, default(Vector2), num2, SpriteEffects.None, 0f);
			if (PlayerInput.IgnoreMouseInterface)
			{
				return;
			}
			player[myPlayer].mouseInterface = true;
			mouseText = false;
			if (mouseRight && mouseRightRelease)
			{
				SoundEngine.PlaySound(12);
				SetMouseNPC(-1, -1);
			}
			if (!mouseLeft || !mouseLeftRelease)
			{
				return;
			}
			PlayerInput.SetZoom_World();
			Vector2 vector = ReverseGravitySupport(MouseScreen) + screenPosition;
			int x = (int)(vector.X / 16f);
			int y = (int)(vector.Y / 16f);
			PlayerInput.SetZoom_Unscaled();
			if (mouseNPCType == 0)
			{
				PerformHousingCheck(x, y);
				return;
			}
			int num4 = mouseNPCIndex;
			if (num4 >= 0)
			{
				TryMovingNPC(x, y, num4);
			}
		}
	}

	public static void DrawInterface_37_DebugStuff()
	{
	}

	private static void DrawInterface_36_Cursor()
	{
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerStateForCursor, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
		if (PlayerInput.ControllerHousingCursorActive)
		{
			Vector2 housingScreenPosition = PlayerInput.HousingScreenPosition;
			int num = mouseX;
			int num2 = mouseY;
			mouseX = (int)housingScreenPosition.X;
			mouseY = (int)housingScreenPosition.Y;
			DrawCursor(DrawThickCursor());
			mouseX = num;
			mouseY = num2;
		}
		else if (cursorOverride != -1)
		{
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color((int)((float)(int)cursorColor.R * 0.2f), (int)((float)(int)cursorColor.G * 0.2f), (int)((float)(int)cursorColor.B * 0.2f), (int)((float)(int)cursorColor.A * 0.5f));
			Microsoft.Xna.Framework.Color white = cursorColor;
			bool flag = true;
			bool flag2 = true;
			float rotation = 0f;
			Vector2 vector = default(Vector2);
			float num3 = 1f;
			if (cursorOverride == 2)
			{
				flag = false;
				white = Microsoft.Xna.Framework.Color.White;
				num3 = 0.7f;
				vector = new Vector2(0.1f);
			}
			switch (cursorOverride)
			{
			case 2:
				flag = false;
				white = Microsoft.Xna.Framework.Color.White;
				num3 = 0.7f;
				vector = new Vector2(0.1f);
				break;
			case 3:
			case 6:
			case 7:
			case 8:
			case 9:
			case 10:
				flag = false;
				white = Microsoft.Xna.Framework.Color.White;
				break;
			}
			if (flag)
			{
				spriteBatch.Draw(TextureAssets.Cursors[cursorOverride].Value, new Vector2(mouseX + 1, mouseY + 1), null, color, rotation, vector * TextureAssets.Cursors[cursorOverride].Value.Size(), cursorScale * 1.1f * num3, SpriteEffects.None, 0f);
			}
			if (flag2)
			{
				spriteBatch.Draw(TextureAssets.Cursors[cursorOverride].Value, new Vector2(mouseX, mouseY), null, white, rotation, vector * TextureAssets.Cursors[cursorOverride].Value.Size(), cursorScale * num3, SpriteEffects.None, 0f);
			}
		}
		else if (SmartCursorIsUsed)
		{
			DrawCursor(DrawThickCursor(smart: true), smart: true);
		}
		else
		{
			DrawCursor(DrawThickCursor());
		}
	}

	private static void DrawInterface_35_YouDied()
	{
		if (!player[myPlayer].dead)
		{
			return;
		}
		float num = -60f;
		string value = Lang.inter[38].Value;
		if (LocalPlayer.spectating < 0)
		{
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, value, new Vector2((float)(screenWidth / 2) - FontAssets.DeathText.Value.MeasureString(value).X / 2f, (float)(screenHeight / 2) + num), player[myPlayer].GetDeathAlpha(Microsoft.Xna.Framework.Color.Transparent), 0f, default(Vector2), 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
			if (LocalPlayer.lostCoins > 0)
			{
				num += 50f;
				string textValue = Language.GetTextValue("Game.DroppedCoins", player[myPlayer].lostCoinString);
				DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, textValue, new Vector2((float)(screenWidth / 2) - FontAssets.MouseText.Value.MeasureString(textValue).X / 2f, (float)(screenHeight / 2) + num), player[myPlayer].GetDeathAlpha(Microsoft.Xna.Framework.Color.Transparent), 0f, default(Vector2), 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
				num -= 26f;
			}
		}
		else
		{
			num += 24f;
		}
		num += 70f;
		float num2 = 0.7f;
		string textValue2 = Language.GetTextValue("Game.RespawnInSuffix", ((float)(int)(1f + (float)player[myPlayer].respawnTimer / 60f)).ToString());
		DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, textValue2, new Vector2((float)(screenWidth / 2) - FontAssets.DeathText.Value.MeasureString(textValue2).X * num2 / 2f, (float)(screenHeight / 2) + num), player[myPlayer].GetDeathAlpha(Microsoft.Xna.Framework.Color.Transparent), 0f, default(Vector2), num2, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		if (PlayerInput.SettingsForUI.ShowGamepadHints)
		{
			DrawGamepadInstructions();
		}
	}

	private void DrawInterface_34_PlayerChat()
	{
		if (ignoreErrors)
		{
			try
			{
				DrawPlayerChat();
				return;
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				return;
			}
		}
		DrawPlayerChat();
	}

	private void DrawInterface_33_MouseText()
	{
		if (mouseItem.stack <= 0)
		{
			mouseItem.type = 0;
		}
		if (hoverItemName != null && hoverItemName != "" && MouseDisplayItem.IsAir)
		{
			player[myPlayer].cursorItemIconEnabled = false;
			if (SettingsEnabled_OpaqueBoxBehindTooltips)
			{
				MouseText(hoverItemName, rare, 0, mouseX + 6, mouseY + 6);
			}
			else
			{
				MouseText(hoverItemName, rare, 0);
			}
			mouseText = true;
		}
		if (LocalPlayer.rulerLine && LocalPlayer.builderAccStatus[0] == 0 && LocalPlayer.spectating < 0 && LocalPlayer.velocity.Length() <= 6f)
		{
			int num = Math.Abs(rulerLineDisplayValues.X) + 1;
			int num2 = Math.Abs(rulerLineDisplayValues.Y) + 1;
			if (num > 1 || num2 > 1)
			{
				Utils.DrawBorderString(spriteBatch, num + "x" + num2, MouseScreen + new Vector2(16f, 0f), new Microsoft.Xna.Framework.Color(0.24f, 0.8f, 0.9f, 1f), 1f, 0f, 0.8f);
			}
		}
		DrawInterface_InstrumentMouseText();
	}

	private void DrawInterface_InstrumentMouseText()
	{
		Player localPlayer = LocalPlayer;
		if (_mouseTextCache.isValid || signHover > -1 || localPlayer.cursorItemIconID > 0 || localPlayer.selectedItem == 58 || (localPlayer.rulerLine && localPlayer.builderAccStatus[0] == 0) || localPlayer.mouseInterface)
		{
			instrumentMouseFixHack = 3;
			return;
		}
		if (instrumentMouseFixHack > 0)
		{
			instrumentMouseFixHack--;
			return;
		}
		int type = localPlayer.inventory[localPlayer.selectedItem].type;
		if (type == 4057 || type == 4372 || type == 4715 || type == 4673)
		{
			float musicDist = localPlayer.musicDist;
			string text = "GameUI.GuitarAm";
			if (type == 4673)
			{
				int num = 10;
				float num2 = 1f / (float)num;
				text = ((musicDist > num2 * 9f) ? "GameUI.DrumCymbol" : ((musicDist > num2 * 8f) ? "GameUI.DrumCymbol1" : ((musicDist > num2 * 7f) ? "GameUI.DrumHiHat" : ((musicDist > num2 * 6f) ? "GameUI.DrumClosedHiHat" : ((musicDist > num2 * 5f) ? "GameUI.DrumFloorTom" : ((musicDist > num2 * 4f) ? "GameUI.DrumTamaSnare" : ((musicDist > num2 * 3f) ? "GameUI.DrumTomHigh" : ((musicDist > num2 * 2f) ? "GameUI.DrumTomMid" : ((!(musicDist > num2 * 1f)) ? "GameUI.DrumKick" : "GameUI.DrumTomLow")))))))));
			}
			else
			{
				int num3 = 6;
				float num4 = 1f / (float)num3;
				text = ((musicDist > num4 * 5f) ? "GameUI.GuitarEm" : ((musicDist > num4 * 4f) ? "GameUI.GuitarD" : ((musicDist > num4 * 3f) ? "GameUI.GuitarC" : ((musicDist > num4 * 2f) ? "GameUI.GuitarBm" : ((!(musicDist > num4 * 1f)) ? "GameUI.GuitarG" : "GameUI.GuitarAm")))));
			}
			MouseText(Language.GetTextValue(Language.GetTextValue(text)), 0, 0);
		}
	}

	private static void DrawInterface_32_GamepadRadialHotbars()
	{
		ItemSlot.DrawRadialCircular(spriteBatch, new Vector2(screenWidth, screenHeight) / 2f, LocalPlayer.CircularRadial, LocalPlayer.inventory);
		ItemSlot.DrawRadialQuicks(spriteBatch, new Vector2(screenWidth, screenHeight) / 2f);
	}

	private void DrawInterface_31_BuilderAccToggles()
	{
		DrawBuilderAccToggles(new Vector2(10f, 77f));
	}

	public static void DrawInterface_29B_ControlHints()
	{
		DrawSpectatingControlHint();
	}

	public static void DrawInterface_29_SettingsButton()
	{
		_settingsButtonIsPushedToSide = false;
		if (playerInventory || ingameOptionsWindow || LocalPlayer.dead)
		{
			string value = Lang.inter[62].Value;
			string textSizeMatcher = "Settings";
			int num = screenWidth - 110;
			int num2 = screenHeight - 20;
			int num3 = 620;
			int num4 = 870;
			int amountOfExtraAccessorySlotsToShow = player[myPlayer].GetAmountOfExtraAccessorySlotsToShow();
			if (amountOfExtraAccessorySlotsToShow >= 1)
			{
				int num5 = (int)(56f * inventoryScale * (float)amountOfExtraAccessorySlotsToShow);
				num3 += num5;
				num4 += num5;
			}
			if (LocalPlayer.dead)
			{
				num += 40;
			}
			else if (amountOfExtraAccessorySlotsToShow >= 1 && (screenHeight < num3 || (screenHeight < num4 && mapStyle == 1)))
			{
				num -= 140;
				num2 -= PlayerInput.SettingsForUI.PushEquipmentAreaUp.ToInt() * 30;
				_settingsButtonIsPushedToSide = true;
			}
			Action clickAction = IngameOptions.Open;
			if (ingameOptionsWindow)
			{
				clickAction = IngameOptions.Close;
			}
			DrawSettingButton(ref mouseExit, ref exitScale, num, num2, value, textSizeMatcher, clickAction);
		}
	}

	public static void DrawSettingButton(ref bool mouseOver, ref float scale, int posX, int posY, string text, string textSizeMatcher, Action clickAction)
	{
		Vector2 vector = FontAssets.MouseText.Value.MeasureString(textSizeMatcher);
		Vector2 vector2 = FontAssets.MouseText.Value.MeasureString(text);
		Vector2 vector3 = FontAssets.DeathText.Value.MeasureString(text);
		float num = vector.X / vector2.X;
		if (mouseOver)
		{
			if ((double)scale < 0.96)
			{
				scale += 0.02f;
			}
		}
		else if ((double)scale > 0.8)
		{
			scale -= 0.02f;
		}
		UILinkPointNavigator.SetPosition(308, new Vector2(posX, posY));
		for (int i = 0; i < 5; i++)
		{
			int num2 = 0;
			int num3 = 0;
			Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Black;
			if (i == 0)
			{
				num2 = -2;
			}
			if (i == 1)
			{
				num2 = 2;
			}
			if (i == 2)
			{
				num3 = -2;
			}
			if (i == 3)
			{
				num3 = 2;
			}
			if (i == 4)
			{
				color = Microsoft.Xna.Framework.Color.White;
			}
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, text, new Vector2(posX + num2, posY + num3), color, 0f, new Vector2(vector3.X / 2f, vector3.Y / 2f), (scale - 0.2f) * num, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
		bool flag = false;
		if (PlayerInput.UsingGamepad)
		{
			float num4 = (scale - 0.2f) * num;
			GlyphTagHandler.GetGlyph(PlayerInput.ProfileGamepadUI.KeyStatus["MapFull"][0]).UniqueDraw(justCheckingSize: false, out var _, spriteBatch, new Vector2((float)posX - vector3.X / 2f * num4 - 32f, (float)posY - vector3.Y / 2f * num4 + 2f), Microsoft.Xna.Framework.Color.White);
			flag = PlayerInput.Triggers.JustPressed.MapFull;
		}
		if ((float)mouseX > (float)posX - vector3.X / 2f && (float)mouseX < (float)posX + vector3.X / 2f && (float)mouseY > (float)posY - vector3.Y / 2f && (float)mouseY < (float)posY + vector3.Y / 2f - 10f && !LocalPlayer.mouseInterface)
		{
			if (!PlayerInput.IgnoreMouseInterface)
			{
				if (!mouseOver)
				{
					SoundEngine.PlaySound(12);
				}
				mouseOver = true;
				player[myPlayer].mouseInterface = true;
				if (mouseLeftRelease && mouseLeft)
				{
					mouseOver = false;
					scale = 0.8f;
					flag = true;
				}
			}
		}
		else
		{
			mouseOver = false;
		}
		if (flag)
		{
			clickAction();
		}
	}

	private void DrawInterface_28_InfoAccs()
	{
		float num = inventoryScale;
		inventoryScale = 0.6f;
		DrawInfoAccs();
		inventoryScale = num;
	}

	private void HackForGamepadInputHell()
	{
		if (PlayerInput.SettingsForUI.ShowGamepadHints)
		{
			PlayerInput.ComposeInstructionsForGamepad();
			PlayerInput.AllowExecutionOfGamepadInstructions = false;
		}
	}

	private void DrawInterface_27_Inventory()
	{
		HackForGamepadInputHell();
		if (playerInventory)
		{
			if (player[myPlayer].chest != -1)
			{
				CreativeMenu.CloseMenu();
			}
			if (ignoreErrors)
			{
				try
				{
					DrawInventory();
					return;
				}
				catch (Exception e)
				{
					TimeLogger.DrawException(e);
					return;
				}
			}
			DrawInventory();
		}
		else
		{
			CreativeMenu.CloseMenu();
			PipsFastScroll = true;
			SetMouseNPC(-1, -1);
			EquipPage = 0;
		}
	}

	private static void DrawInterface_26_InterfaceLogic3()
	{
		if (player[myPlayer].dead)
		{
			playerInventory = false;
		}
		if (!playerInventory)
		{
			player[myPlayer].chest = -1;
			InGuideCraftMenu = false;
			InReforgeMenu = false;
			NewCraftingUI.Close(quiet: true);
			ItemSlot.ResetInventoryStateCounters();
		}
		hoverItemName = "";
	}

	private void DrawInterface_25_ResourceBars()
	{
		if (LocalPlayer.spectating < 0)
		{
			GUIBarsDraw();
		}
	}

	private static void DrawInterface_24_InterfaceLogic2()
	{
		invAlpha += invDir * 0.2f;
		if (invAlpha > 240f)
		{
			invAlpha = 240f;
			invDir = -1f;
		}
		if (invAlpha < 180f)
		{
			invAlpha = 180f;
			invDir = 1f;
		}
		inventoryBack = new Microsoft.Xna.Framework.Color((byte)invAlpha, (byte)invAlpha, (byte)invAlpha, (byte)invAlpha);
		mouseText = false;
		rare = 0;
	}

	private void DrawInterface_23_NPCSignsDialog()
	{
		GUIChatDraw();
	}

	private void DrawInterface_22_DresserWindow()
	{
		if (clothesWindow)
		{
			DrawClothesWindow();
		}
	}

	private void DrawInterface_21_HairWindow()
	{
		if (hairWindow)
		{
			DrawHairWindow();
		}
	}

	private static void DrawInterface_20_MultiplayerPlayerNames()
	{
		ActiveClosePlayersTeamOverlay.Draw();
	}

	private static void DrawInterface_19_SignTileBubble()
	{
		if (signBubble)
		{
			int num = (int)((float)signX - screenPosition.X);
			int num2 = (int)((float)signY - screenPosition.Y);
			if (player[myPlayer].gravDir == -1f)
			{
				num2 = screenHeight - (int)((float)signY - screenPosition.Y) - 32;
			}
			SpriteEffects effects = SpriteEffects.None;
			if ((float)signX > player[myPlayer].position.X + (float)player[myPlayer].width)
			{
				effects = SpriteEffects.FlipHorizontally;
				num += -8 - TextureAssets.Chat2.Width();
			}
			else
			{
				num += 8;
			}
			num2 -= 22;
			spriteBatch.Draw(TextureAssets.Chat2.Value, new Vector2(num, num2), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Chat2.Width(), TextureAssets.Chat2.Height()), new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor), 0f, default(Vector2), 1f, effects, 0f);
		}
	}

	private static void DrawInterface_17_DiagnoseNet()
	{
		if (shouldDrawNetDiagnosticsUI)
		{
			ActiveNetDiagnosticsUI.Draw(spriteBatch);
		}
	}

	private void DrawInterface_16_MapOrMinimap()
	{
		mH = 0;
		if (!mapEnabled)
		{
			return;
		}
		if (!mapFullscreen && mapStyle == 1)
		{
			mH = 256;
			try
			{
				DrawMap(new GameTime());
			}
			catch (Exception e)
			{
				if (!ignoreErrors)
				{
					throw;
				}
				TimeLogger.DrawException(e);
			}
		}
		PlayerInput.SetZoom_UI();
		if (mH + RecommendedEquipmentAreaPushUp > screenHeight)
		{
			mH = screenHeight - RecommendedEquipmentAreaPushUp;
		}
	}

	private static void DrawInterface_15_InvasionProgressBars()
	{
		DrawInvasionProgress();
		if (HealthBarDrawSettings != 0)
		{
			BigBossProgressBar.Draw(spriteBatch);
		}
	}

	private void DrawInterface_14_EntityHealthBars()
	{
		if (HealthBarDrawSettings == 0)
		{
			return;
		}
		int num = -1;
		if (PlayerInput.UsingGamepad)
		{
			Player localPlayer = LocalPlayer;
			for (int i = 0; i < maxNPCs; i++)
			{
				NPC nPC = npc[i];
				if ((nPC.life == nPC.lifeMax || nPC.dontTakeDamage) && !nPC.dontTakeDamage && nPC.nameOver > 0f && (num == -1 || nPC.Distance(localPlayer.Center) < npc[num].Distance(localPlayer.Center)))
				{
					num = i;
				}
			}
		}
		bool flag = false;
		for (int num2 = maxNPCs - 1; num2 >= 0; num2--)
		{
			if (npc[num2].active && npc[num2].type > 0 && npc[num2].shimmerTransparency == 0f)
			{
				npc[num2].position += npc[num2].netOffset;
				if (npc[num2].life != npc[num2].lifeMax && !npc[num2].dontTakeDamage)
				{
					float scale = 1f;
					int type = npc[num2].type;
					if (type == 4)
					{
						scale = 1.5f;
					}
					if (type == 35)
					{
						scale = 1.5f;
					}
					if (type == 36)
					{
						scale = 1.5f;
					}
					if (type == 50)
					{
						scale = 1.5f;
					}
					if (type == 113)
					{
						scale = 1.5f;
					}
					if (type == 114)
					{
						scale = 1.5f;
					}
					if (type == 125)
					{
						scale = 1.5f;
					}
					if (type == 126)
					{
						scale = 1.5f;
					}
					if (type == 127)
					{
						scale = 1.5f;
					}
					if (type == 128)
					{
						scale = 1.5f;
					}
					if (type == 129)
					{
						scale = 1.5f;
					}
					if (type == 130)
					{
						scale = 1.5f;
					}
					if (type == 131)
					{
						scale = 1.5f;
					}
					if (type == 222)
					{
						scale = 1.5f;
					}
					if (type >= 245 && type <= 249)
					{
						scale = 1.5f;
					}
					if (type == 262)
					{
						scale = 1.5f;
					}
					if (type == 266)
					{
						scale = 1.5f;
					}
					if (type == 564 || type == 565 || type == 551 || type == 576 || type == 577)
					{
						scale = 1.5f;
					}
					if (type == 87)
					{
						scale = 1.5f;
					}
					if (type == 510 || type == 454 || type == 621)
					{
						scale = 1.5f;
					}
					if (type == 439 || type == 370)
					{
						scale = 1.5f;
					}
					float num3 = 10f;
					if (HealthBarDrawSettings == 2)
					{
						num3 -= 34f;
					}
					if ((!expertMode || type != 266) && type != 690 && ((type != 439 && type != 440) || npc[num2].ai[0] != 5f))
					{
						if (type >= 134 && type <= 136)
						{
							scale = 1.5f;
							if (!flag)
							{
								flag = true;
								Vector2 vector = default(Vector2);
								float num4 = 999999f;
								for (int j = 0; j < maxNPCs; j++)
								{
									if (npc[j].active && npc[j].type >= 134 && npc[j].type <= 136)
									{
										Vector2 vector2 = player[myPlayer].Center - npc[j].Center;
										if (vector2.Length() < num4 && Collision.CanHit(player[myPlayer].Center, 1, 1, npc[j].Center, 1, 1))
										{
											num4 = vector2.Length();
											vector = npc[j].position;
										}
									}
								}
								if (num4 < (float)screenWidth)
								{
									if (destroyerHB.X < 100f && destroyerHB.Y < 100f)
									{
										destroyerHB = vector;
									}
									else
									{
										destroyerHB = (destroyerHB * 49f + vector) / 50f;
									}
									vector = destroyerHB;
									int num5 = num2;
									if (type != 134 && npc[num2].realLife != -1)
									{
										num5 = npc[num2].realLife;
									}
									float num6 = Lighting.Brightness((int)((npc[num2].position.X + (float)(npc[num2].width / 2)) / 16f), (int)((npc[num2].position.Y + (float)(npc[num2].height / 2) + npc[num2].gfxOffY) / 16f));
									num6 = (num6 + 1f) / 2f;
									DrawHealthBar(vector.X + (float)(npc[num2].width / 2), vector.Y + (float)(npc[num2].height / 2), npc[num5].life, npc[num5].lifeMax, num6, scale);
								}
								else
								{
									destroyerHB = new Vector2(0f, 0f);
								}
							}
						}
						else
						{
							switch (type)
							{
							case 7:
								DrawInterface_Healthbar_Worm(npc[num2], 9, scale);
								break;
							case 95:
								DrawInterface_Healthbar_Worm(npc[num2], 97, scale);
								break;
							case 10:
								DrawInterface_Healthbar_Worm(npc[num2], 12, scale);
								break;
							case 87:
								DrawInterface_Healthbar_Worm(npc[num2], 92, scale);
								break;
							default:
								switch (type)
								{
								case 412:
									DrawInterface_Healthbar_Worm(npc[num2], 414, scale);
									break;
								case 39:
									DrawInterface_Healthbar_Worm(npc[num2], 41, scale);
									break;
								case 98:
									DrawInterface_Healthbar_Worm(npc[num2], 100, scale);
									break;
								case 454:
									DrawInterface_Healthbar_Worm(npc[num2], 459, scale);
									break;
								default:
									switch (type)
									{
									case 510:
										DrawInterface_Healthbar_Worm(npc[num2], 512, scale);
										break;
									case 621:
										DrawInterface_Healthbar_Worm(npc[num2], 623, scale);
										break;
									case 513:
										DrawInterface_Healthbar_Worm(npc[num2], 515, scale);
										break;
									case 117:
										DrawInterface_Healthbar_Worm(npc[num2], 119, scale);
										break;
									default:
										if (HealthBarDrawSettings == 1)
										{
											num3 += NPCAddHeight(npc[num2]);
											DrawHealthBar(npc[num2].position.X + (float)(npc[num2].width / 2), npc[num2].position.Y + (float)npc[num2].height + num3 + npc[num2].gfxOffY, npc[num2].life, npc[num2].lifeMax, Lighting.Brightness((int)((npc[num2].position.X + (float)(npc[num2].width / 2)) / 16f), (int)((npc[num2].position.Y + (float)(npc[num2].height / 2) + npc[num2].gfxOffY) / 16f)), scale);
										}
										else if (HealthBarDrawSettings == 2)
										{
											num3 -= NPCAddHeight(npc[num2]) / 2f;
											DrawHealthBar(npc[num2].position.X + (float)(npc[num2].width / 2), npc[num2].position.Y + num3 + npc[num2].gfxOffY, npc[num2].life, npc[num2].lifeMax, Lighting.Brightness((int)((npc[num2].position.X + (float)(npc[num2].width / 2)) / 16f), (int)((npc[num2].position.Y + (float)(npc[num2].height / 2) + npc[num2].gfxOffY) / 16f)), scale);
										}
										break;
									case 118:
									case 119:
									case 511:
									case 512:
									case 514:
									case 515:
									case 622:
									case 623:
										break;
									}
									break;
								case 40:
								case 41:
								case 99:
								case 100:
								case 413:
								case 414:
								case 455:
								case 456:
								case 457:
								case 458:
								case 459:
									break;
								}
								break;
							case 8:
							case 9:
							case 11:
							case 12:
							case 88:
							case 89:
							case 90:
							case 91:
							case 92:
							case 96:
							case 97:
								break;
							}
						}
					}
				}
				else if (!npc[num2].dontTakeDamage && npc[num2].nameOver > 0f && PlayerInput.UsingGamepad && num2 == num)
				{
					Vector2 stringSize = ChatManager.GetStringSize(FontAssets.MouseText.Value, npc[num2].GivenOrTypeName, Vector2.One);
					Vector2 vector3 = npc[num2].Bottom - screenPosition + new Vector2(0f, 10f);
					if (NPC.GetNPCLocation(num2, seekHead: true, averageDirection: true, out var _, out var pos))
					{
						vector3 = pos - screenPosition + new Vector2(0f, 10 + npc[num2].height / 2);
						if (player[myPlayer].gravDir == -1f)
						{
							vector3 = ReverseGravitySupport(vector3, -npc[num2].height - 20);
						}
						Vector2 origin = stringSize * new Vector2(0.5f, 0f);
						ChatManager.DrawColorCodedStringShadow(spriteBatch, FontAssets.MouseText.Value, npc[num2].GivenOrTypeName, vector3, Microsoft.Xna.Framework.Color.Black * npc[num2].nameOver * 0.5f, 0f, origin, Vector2.One);
						ChatManager.DrawColorCodedString(spriteBatch, FontAssets.MouseText.Value, npc[num2].GivenOrTypeName, vector3, Microsoft.Xna.Framework.Color.White * npc[num2].nameOver, 0f, origin, Vector2.One);
					}
				}
				bool flag2 = npc[num2].nextDialogue != null && npc[num2].nextDialogue.ShowIndicator;
				bool flag3 = false;
				if (!flag2 && NPC.CanShowHomelessText(num2))
				{
					flag2 = true;
					flag3 = true;
				}
				if (flag2 && (!flag3 || LocalPlayer.Distance(npc[num2].Center) < 105f))
				{
					Utils.DrawNotificationIcon(spriteBatch, npc[num2].Top + new Vector2(0f, npc[num2].gfxOffY - 10f), 1f, worldSpace: true);
				}
				if (npc[num2].type == 548 && !npc[num2].dontTakeDamageFromHostiles && DD2Event.TimeLeftBetweenWaves > 0 && !hideUI)
				{
					Vector2 position = npc[num2].Bottom - screenPosition + new Vector2(0f, -100f);
					int num7 = DD2Event.TimeLeftBetweenWaves / 60;
					string text = $"{num7}";
					DynamicSpriteFont value = FontAssets.MouseText.Value;
					float num8 = 1f;
					Vector2 origin2 = value.MeasureString(text) * num8 * new Vector2(0.5f, 0.5f);
					ChatManager.DrawColorCodedStringWithShadow(spriteBatch, value, text, position, Microsoft.Xna.Framework.Color.White, 0f, origin2, Vector2.One * num8);
				}
				npc[num2].position -= npc[num2].netOffset;
			}
		}
		for (int k = 0; k < 255; k++)
		{
			if (k != myPlayer && player[k].active && !player[k].ghost && !player[k].dead && !player[k].invis && player[k].statLife != player[k].statLifeMax2)
			{
				Vector2 vector4 = player[k].Bottom + player[k].netOffset + new Vector2(0f, player[k].gfxOffY);
				if (HealthBarDrawSettings == 1)
				{
					int num9 = 10;
					DrawHealthBar(vector4.X, vector4.Y + (float)num9, player[k].statLife, player[k].statLifeMax2, player[k].stealth * Lighting.Brightness((int)((player[k].position.X + (float)(player[k].width / 2)) / 16f), (int)((player[k].position.Y + (float)(player[k].height / 2) + player[k].gfxOffY) / 16f)));
				}
				else if (HealthBarDrawSettings == 2)
				{
					int num10 = -20;
					DrawHealthBar(vector4.X, vector4.Y + (float)num10, player[k].statLife, player[k].statLifeMax2, player[k].stealth * Lighting.Brightness((int)((player[k].position.X + (float)(player[k].width / 2)) / 16f), (int)((player[k].position.Y + (float)(player[k].height / 2) + player[k].gfxOffY) / 16f)));
				}
			}
		}
	}

	private void DrawInterface_Healthbar_Worm(NPC head, int tailID, float scale)
	{
		NPC nPC = head;
		for (int i = head.whoAmI + 1; i < maxNPCs; i++)
		{
			if (npc[i].active && npc[i].type == tailID)
			{
				nPC = npc[i];
				break;
			}
		}
		Vector2 vector = (head.position + nPC.position) / 2f;
		DrawHealthBar(vector.X + (float)(head.width / 2), vector.Y + (float)(head.height / 2), head.life, head.lifeMax, Lighting.Brightness((int)((head.position.X + (float)(head.width / 2)) / 16f), (int)((head.position.Y + (float)(head.height / 2) + head.gfxOffY) / 16f)), scale);
	}

	private static void DrawInterface_13_AchievementCompletePopups()
	{
		InGameNotificationsTracker.DrawInGame(spriteBatch);
	}

	private static bool DrawInterface_12_IngameFancyUI()
	{
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerStateForCursor, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
		InGameUI.Draw(spriteBatch, _drawInterfaceGameTime);
		if (inFancyUI && !IngameFancyUI.Draw(spriteBatch, _drawInterfaceGameTime))
		{
			return false;
		}
		return true;
	}

	private bool DrawInterface_11_IngameOptionsMenu()
	{
		if (ingameOptionsWindow)
		{
			DrawInterface_16_MapOrMinimap();
			PlayerInput.SetZoom_UI();
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, null, null, null, null, null, UIScaleMatrix);
			IngameOptions.Draw(this, spriteBatch);
			DrawInterface_40_InteractItemIcon();
			return false;
		}
		return true;
	}

	private static bool DrawInterface_8_CheckF11UIHideToggle()
	{
		if (hideUI)
		{
			maxQ = true;
			return false;
		}
		return true;
	}

	private static bool DrawInterface_10_CheckCaptureManager()
	{
		CaptureManager.Instance.Update(CaptureInterface.SelectionContext.World);
		if (CaptureManager.Instance.Active)
		{
			CaptureManager.Instance.Draw(spriteBatch);
			return false;
		}
		return true;
	}

	private static void DrawInterface_9_WireSelection()
	{
		if (!hideUI)
		{
			DrawInterface_Resources_GolfPower();
			DrawInterface_GolfBallIndicator();
		}
		WiresUI.HandleWiresUI(spriteBatch);
	}

	private static void DrawInterface_0_InterfaceLogic1()
	{
		if (player[myPlayer].selectedItem == 58 && player[myPlayer].UsingOrReusingItem)
		{
			mouseLeftRelease = false;
		}
	}

	private void DrawInterface_7_TownNPCHouseBanners()
	{
		if (EquipPage != 1 && (!UILinkPointNavigator.Shortcuts.NPCS_IconsDisplay || !PlayerInput.UsingGamepad))
		{
			return;
		}
		if (ignoreErrors)
		{
			try
			{
				DrawNPCHousesInWorld();
				return;
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				return;
			}
		}
		DrawNPCHousesInWorld();
	}

	private static void DrawInterface_6_TileGridOption()
	{
		bool flag = MouseShowBuildingGrid && !SmartCursorIsUsed;
		if (PlayerInput.UsingGamepad && !SmartCursorIsUsed)
		{
			_ = !PlayerInput.UsingGamepadUI;
		}
		else
			_ = 0;
		if (flag && !player[myPlayer].dead && !PlayerInput.CursorIsBusy)
		{
			float num = player[myPlayer].velocity.Length();
			float num2 = 6f;
			float value = MathHelper.Lerp(0f, 0.7f, MathHelper.Clamp(1f - num / num2, 0f, 1f));
			MouseBuildingGridAlpha = MathHelper.Lerp(MouseBuildingGridAlpha, value, 0.2f);
			value = MouseBuildingGridAlpha;
			if (value > 0f)
			{
				Vector2 position = MouseWorld.ToTileCoordinates().ToVector2() * 16f;
				new Vector2(offScreenRange, offScreenRange);
				_ = drawToScreen;
				position -= screenPosition;
				position += new Vector2(8f);
				if (player[myPlayer].gravDir == -1f)
				{
					position.Y = (float)screenHeight - position.Y;
				}
				Texture2D value2 = TextureAssets.CursorRadial.Value;
				spriteBatch.Draw(value2, position, null, Microsoft.Xna.Framework.Color.White * 0.5f * value, 0f, value2.Size() / 2f, 1f, SpriteEffects.None, 0f);
			}
		}
		else
		{
			MouseBuildingGridAlpha = MathHelper.Clamp(MouseBuildingGridAlpha - 0.05f, 0f, 1f);
		}
	}

	private static void DrawInterface_5_GamepadLockOn()
	{
		LockOnHelper.Draw(spriteBatch);
	}

	private static void DrawInterface_4_Ruler()
	{
		if (LocalPlayer.spectating >= 0 || !player[myPlayer].rulerLine || player[myPlayer].builderAccStatus[0] != 0)
		{
			return;
		}
		float num = player[myPlayer].velocity.Length();
		float num2 = 6f;
		float num3 = 2f;
		if (!(num <= num2))
		{
			return;
		}
		float num4 = 1f;
		if (num >= num3)
		{
			num4 = 1f - (num - num3) / num2;
		}
		int num5 = 1;
		if ((float)mouseX + screenPosition.X < player[myPlayer].Center.X)
		{
			num5 = -1;
		}
		int num6 = (int)(player[myPlayer].position.X + (float)(player[myPlayer].width / 2)) / 16;
		int num7 = (int)(player[myPlayer].position.Y + (float)player[myPlayer].height - 2f) / 16;
		if (player[myPlayer].gravDir == -1f)
		{
			num7--;
		}
		Vector2 mouseWorld = MouseWorld;
		if (Math.Abs(num6 - (int)(MouseWorld.X / 16f)) > 0)
		{
			num6 += num5;
		}
		if (player[myPlayer].gravDir == -1f)
		{
			mouseWorld.Y += 16f;
		}
		mouseWorld /= 16f;
		new Vector2(num6, num7);
		int num8 = (int)mouseWorld.X - num6;
		int num9 = (int)mouseWorld.Y - num7;
		Math.Abs(num8);
		Math.Abs(num9);
		rulerLineDisplayValues.X = num8;
		rulerLineDisplayValues.Y = num9;
		if (num8 == 0 && num9 == 0)
		{
			return;
		}
		Texture2D value = TextureAssets.Extra[2].Value;
		Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16);
		int num10 = num6;
		int num11 = num7;
		if (player[myPlayer].gravDir == -1f)
		{
			num11--;
		}
		float r = 0.24f;
		float g = 0.8f;
		float b = 0.9f;
		float a = 1f;
		float num12 = 0.8f;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(r, g, b, a) * num12 * num4;
		spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(num10, num11) * 16f - screenPosition, 16f), value2, color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
		if (num8 != 0)
		{
			int num13 = Math.Sign(num8);
			value2.Y = ((num13 == 1) ? 16 : 32);
			while (num8 != 0)
			{
				num8 -= num13;
				num10 += num13;
				if (num8 == 0)
				{
					value2.Y = 0;
				}
				color = new Microsoft.Xna.Framework.Color(r, g, b, a) * num12 * num4;
				spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(num10, num11) * 16f - screenPosition, 16f), value2, color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
			}
		}
		if (num9 == 0)
		{
			return;
		}
		int num14 = Math.Sign(num9);
		value2.Y = ((num14 == 1) ? 48 : 64);
		while (num9 != 0)
		{
			num9 -= num14;
			num11 += num14;
			if (num9 == 0)
			{
				value2.Y = 0;
			}
			color = new Microsoft.Xna.Framework.Color(r, g, b, a) * num12 * num4;
			spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(num10, num11) * 16f - screenPosition, 16f), value2, color, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
		}
	}

	private static void DrawInterface_3_LaserRuler()
	{
		if (!player[myPlayer].rulerGrid || player[myPlayer].builderAccStatus[1] != 0)
		{
			return;
		}
		float num = player[myPlayer].velocity.Length();
		num = Vector2.Distance(player[myPlayer].position, player[myPlayer].shadowPos[2]);
		float num2 = 6f;
		Texture2D value = TextureAssets.Extra[68].Value;
		float num3 = MathHelper.Lerp(0.2f, 0.7f, MathHelper.Clamp(1f - num / num2, 0f, 1f));
		Vector2 vec = screenPosition;
		vec += new Vector2(-50f);
		vec = vec.ToTileCoordinates().ToVector2() * 16f;
		int num4 = (screenWidth + 100) / 16;
		int num5 = (screenHeight + 100) / 16;
		Microsoft.Xna.Framework.Point point = MouseWorld.ToTileCoordinates();
		point.X -= (int)vec.X / 16;
		point.Y -= (int)vec.Y / 16;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(0.24f, 0.8f, 0.9f, 0.5f) * 0.4f * num3;
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(1f, 0.8f, 0.9f, 0.5f) * 0.5f * num3;
		Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle(0, 18, 18, 18);
		vec -= Vector2.One;
		for (int i = 0; i < num4; i++)
		{
			for (int j = 0; j < num5; j++)
			{
				Microsoft.Xna.Framework.Color color3 = color;
				Vector2 zero = Vector2.Zero;
				if (i != point.X && j != point.Y)
				{
					if (i != point.X + 1)
					{
						value2.X = 0;
						value2.Width = 16;
					}
					else
					{
						value2.X = 2;
						value2.Width = 14;
						zero.X = 2f;
					}
					if (j != point.Y + 1)
					{
						value2.Y = 18;
						value2.Height = 16;
					}
					else
					{
						value2.Y = 2;
						value2.Height = 14;
						zero.Y = 2f;
					}
					spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(i, j) * 16f - screenPosition + vec + zero, 16f), value2, color3, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
				}
			}
		}
		value2 = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 18);
		for (int k = 0; k < num4; k++)
		{
			if (k == point.X)
			{
				spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(k, point.Y) * 16f - screenPosition + vec, 16f), new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16), color2, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
			}
			else
			{
				spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(k, point.Y) * 16f - screenPosition + vec, 16f), value2, color2, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
			}
		}
		value2 = new Microsoft.Xna.Framework.Rectangle(0, 0, 18, 16);
		for (int l = 0; l < num5; l++)
		{
			if (l != point.Y)
			{
				spriteBatch.Draw(value, ReverseGravitySupport(new Vector2(point.X, l) * 16f - screenPosition + vec, 16f), value2, color2, 0f, Vector2.Zero, 1f, SpriteEffects.None, 0f);
			}
		}
	}

	private static void DrawInterface_2_SmartCursorTargets()
	{
		DrawSmartCursor();
	}

	private static void DrawInterface_1_1_DrawEmoteBubblesInWorld()
	{
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, SamplerState.PointClamp, null, null, null, GameViewMatrix.ZoomMatrix);
		EmoteBubble.DrawAll(spriteBatch);
		if (instance.currentNPCShowingChatBubble != -1)
		{
			DrawNPCChatBubble(instance.currentNPCShowingChatBubble);
		}
		instance.currentNPCShowingChatBubble = -1;
	}

	private static void DrawInterface_1_2_DrawEntityMarkersInWorld()
	{
		Player localPlayer = LocalPlayer;
		if (localPlayer.dead || !localPlayer.HeldItem.summon)
		{
			return;
		}
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, SamplerState.PointClamp, null, null, null, GameViewMatrix.ZoomMatrix);
		Texture2D value = TextureAssets.Extra[199].Value;
		Vector2 zero = Vector2.Zero;
		int minionAttackTargetNPC = localPlayer.MinionAttackTargetNPC;
		Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X, (int)screenPosition.Y, screenWidth, screenHeight);
		for (int i = 0; i < maxNPCs; i++)
		{
			NPC nPC = npc[i];
			if (nPC.active && nPC.Hitbox.Intersects(value2))
			{
				Vector2 vector = nPC.Center - screenPosition;
				if (player[myPlayer].gravDir == -1f)
				{
					vector.Y = (float)screenHeight - vector.Y;
				}
				Vector2 position = vector + zero;
				if (i == minionAttackTargetNPC)
				{
					int frameY = (int)(GlobalTimeWrappedHourly * 10f) % 4;
					Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, 4, 0, frameY, 0, -2);
					Vector2 origin = rectangle.Size() / 2f;
					Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White * 0.7f;
					color.A /= 2;
					spriteBatch.Draw(value, position, rectangle, color, 0f, origin, 1f, SpriteEffects.None, 0f);
				}
			}
		}
	}

	private static void MouseOversClear()
	{
		instance._mouseTextCache.isValid = false;
		instance._mouseTextCache.noOverride = false;
		player[myPlayer].cursorItemIconEnabled = false;
		player[myPlayer].cursorItemIconID = 0;
		player[myPlayer].cursorItemIconText = string.Empty;
		player[myPlayer].cursorItemIconPush = 0;
		signHover = -1;
		signBubble = false;
	}

	public static void ItemIconCacheUpdate(int selectedItemID)
	{
		_itemIconCacheScreenPosition = MouseScreen;
		_itemIconCacheSelectedItemID = selectedItemID;
		_itemIconCacheTime = 10;
	}

	public static void ItemIconCacheVerification()
	{
		if (_itemIconCacheTime > 0)
		{
			float num = Vector2.Distance(_itemIconCacheScreenPosition, MouseScreen);
			if (num != 0f)
			{
				_itemIconCacheTime--;
			}
			if (num > 4f)
			{
				_itemIconCacheTime = 0;
			}
			if (_itemIconCacheSelectedItemID != player[myPlayer].inventory[player[myPlayer].selectedItem].type)
			{
				_itemIconCacheTime = 0;
			}
		}
	}

	public static void DrawWallOfFish()
	{
		List<int> list = new List<int>();
		for (int i = 2297; i <= 2321; i++)
		{
			list.Add(i);
		}
		for (int j = 2450; j <= 2488; j++)
		{
			list.Add(j);
		}
		for (int k = 0; k < 5; k++)
		{
			float num = 10f;
			Vector2 vector = new Vector2((float)screenWidth / num * (GlobalTimeWrappedHourly % num), -100f);
			vector.X += 14 * k;
			vector.Y += k % 2 * 14;
			int num2 = 30 * k;
			while (vector.Y < (float)(screenHeight + 100))
			{
				if (++num2 >= list.Count)
				{
					num2 = 0;
				}
				vector.Y += 26f;
				instance.LoadItem(list[num2]);
				Texture2D value = TextureAssets.Item[list[num2]].Value;
				Microsoft.Xna.Framework.Point point = (vector + screenPosition).ToTileCoordinates();
				spriteBatch.Draw(value, vector, null, Lighting.GetColor(point.X, point.Y), (float)Math.PI / 4f, value.Size() / 2f, 1f, SpriteEffects.None, 0f);
			}
		}
	}

	public static void DrawWallOfStars()
	{
		bool flag = true;
		if (flag)
		{
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		}
		int num = Projectile.NewProjectile(Projectile.GetNoneSource(), Vector2.Zero, Vector2.UnitX, 12, 0, 0f, myPlayer);
		Projectile projectile = Main.projectile[num];
		for (int i = 0; i < 5; i++)
		{
			float num2 = 10f;
			Vector2 vector = new Vector2((float)screenWidth / num2 * (GlobalTimeWrappedHourly % num2), -100f);
			vector.X += 14 * i;
			vector.Y += i % 2 * 14;
			while (vector.Y < (float)(screenHeight + 100))
			{
				vector.Y += 26f;
				projectile.position = Vector2.One * 10f;
				projectile.velocity = Vector2.UnitX * 10f;
				projectile.rotation = GlobalTimeWrappedHourly * ((float)Math.PI * 2f);
				projectile.Update(num);
				projectile.position = vector + screenPosition;
				instance.DrawProj(num);
			}
		}
		projectile.position = Vector2.One * 10f;
		projectile.Kill();
		if (flag)
		{
			spriteBatch.End();
		}
	}

	private static void DrawSmartCursor()
	{
		if (!SmartCursorShowing || player[myPlayer].dead)
		{
			return;
		}
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, null, DefaultSamplerState, null, null, null, GameViewMatrix.ZoomMatrix);
		Vector2 vector = new Vector2(SmartCursorX, SmartCursorY) * 16f;
		new Vector2(offScreenRange, offScreenRange);
		_ = drawToScreen;
		vector -= screenPosition;
		if (player[myPlayer].gravDir == -1f)
		{
			vector.Y = (float)screenHeight - vector.Y - 16f;
		}
		Microsoft.Xna.Framework.Color newColor = Lighting.GetColor(SmartCursorX, SmartCursorY) * 1f;
		Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1);
		float r = 1f;
		float g = 0.9f;
		float b = 0.1f;
		float a = 1f;
		float num = 0.6f;
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitX * 8f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitY * 8f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.One * 8f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
		b = 0.3f;
		g = 0.95f;
		a = (num = 1f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitX * -2f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(2f, 16f), SpriteEffects.None, 0f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitX * 16f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(2f, 16f), SpriteEffects.None, 0f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitY * -2f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(16f, 2f), SpriteEffects.None, 0f);
		spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitY * 16f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(16f, 2f), SpriteEffects.None, 0f);
		Microsoft.Xna.Framework.Point? lockedDesiredDirection = SmartCursorHelper.LockedDesiredDirection;
		if (lockedDesiredDirection.HasValue)
		{
			int num2 = Array.IndexOf(SmartCursorDirectionLocks, lockedDesiredDirection.Value);
			Tile tile = Main.tile[SmartCursorX + lockedDesiredDirection.Value.X, SmartCursorY + lockedDesiredDirection.Value.Y];
			if ((num2 >= 0 && !tile.active()) || LocalPlayer.PlaceThing_IsReplacableBlock(tile))
			{
				Asset<Texture2D> smartCursorArrow = TextureAssets.SmartCursorArrow;
				Vector2 vector2 = lockedDesiredDirection.Value.ToVector2();
				bool flag = num2 % 2 == 1;
				float num3 = (float)((double)GlobalTimeWrappedHourly / 0.9 % 1.0);
				float num4 = 2f - 2f * (float)Math.Sin(num3 * (float)Math.PI);
				Vector2 position = vector + vector2 * (flag ? 16 : 20) + vector2 * num4;
				spriteBatch.Draw(smartCursorArrow.Value, position, smartCursorArrow.Frame(8, 1, num2), Microsoft.Xna.Framework.Color.White);
			}
		}
	}

	private static void DrawSmartInteract()
	{
		if (SmartInteractShowingGenuine && SmartInteractNPC == -1 && SmartInteractProj == -1 && !player[myPlayer].dead)
		{
			Vector2 vector = new Vector2(SmartInteractX, SmartInteractY) * 16f;
			new Vector2(offScreenRange, offScreenRange);
			_ = drawToScreen;
			vector -= screenPosition;
			if (player[myPlayer].gravDir == -1f)
			{
				vector.Y = (float)screenHeight - vector.Y - 16f;
			}
			Microsoft.Xna.Framework.Color newColor = Lighting.GetColor(SmartInteractX, SmartInteractY) * 1f;
			Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1);
			float r = 0.1f;
			float g = 0.9f;
			float b = 1f;
			float a = 1f;
			float num = 0.6f;
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitX * 8f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitY * 8f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.One * 8f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, 8f, SpriteEffects.None, 0f);
			r = 0.3f;
			g = 0.95f;
			a = (num = 1f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitX * -2f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(2f, 16f), SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitX * 16f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(2f, 16f), SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitY * -2f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(16f, 2f), SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector + Vector2.UnitY * 16f, value, buffColor(newColor, r, g, b, a) * num, 0f, Vector2.Zero, new Vector2(16f, 2f), SpriteEffects.None, 0f);
		}
	}

	private void DrawInterface_30_Hotbar()
	{
		try
		{
			GUIHotbarDrawInner();
		}
		catch (Exception e)
		{
			if (ignoreErrors)
			{
				TimeLogger.DrawException(e);
				return;
			}
			throw;
		}
	}

	public void GUIChatDraw()
	{
		if (ignoreErrors)
		{
			try
			{
				if ((npcChatText != "" || player[myPlayer].sign != -1) && !editChest)
				{
					GUIChatDrawInner();
				}
				return;
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				return;
			}
		}
		if ((npcChatText != "" || player[myPlayer].sign != -1) && !editChest)
		{
			GUIChatDrawInner();
		}
	}

	private void DrawInfoAccs()
	{
		int state = -1;
		if (!CanShowInfoAccs)
		{
			return;
		}
		bool flag = false;
		bool flag2 = false;
		bool flag3 = false;
		bool flag4 = false;
		bool flag5 = false;
		bool flag6 = false;
		bool flag7 = false;
		bool flag8 = false;
		bool flag9 = false;
		bool flag10 = false;
		bool flag11 = false;
		bool flag12 = false;
		int num = -1;
		int num2 = -10;
		int num3 = 0;
		string text = "";
		float num4 = 215f;
		int startX = 0;
		if (!playerInventory && GameCulture.FromCultureName(GameCulture.CultureName.Russian).IsActive)
		{
			startX = -50;
			num4 += 50f;
		}
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(100, 100, 100, mouseTextColor);
		for (int i = 0; i < 12; i++)
		{
			string text2 = "";
			string text3 = "";
			Microsoft.Xna.Framework.Color infoTextColor = new Microsoft.Xna.Framework.Color(mouseTextColor, mouseTextColor, mouseTextColor, mouseTextColor);
			Microsoft.Xna.Framework.Color infoTextShadowColor = Microsoft.Xna.Framework.Color.Black;
			if (player[myPlayer].accWatch > 0 && !flag && (!player[myPlayer].hideInfo[0] || playerInventory))
			{
				num = 0;
				text3 = Lang.inter[95].Value;
				string textValue = Language.GetTextValue("GameUI.TimeAtMorning");
				double num5 = time;
				if (player[myPlayer].accWatchTime != 0.0)
				{
					num5 = player[myPlayer].accWatchTime;
				}
				if (!dayTime)
				{
					num5 += 54000.0;
				}
				num5 = num5 / 86400.0 * 24.0;
				double num6 = 7.5;
				num5 = num5 - num6 - 12.0;
				if (num5 < 0.0)
				{
					num5 += 24.0;
				}
				if (num5 >= 12.0)
				{
					textValue = Language.GetTextValue("GameUI.TimePastMorning");
				}
				int num7 = (int)num5;
				double num8 = num5 - (double)num7;
				num8 = (int)(num8 * 60.0);
				string text4 = string.Concat(num8);
				if (num8 < 10.0)
				{
					text4 = "0" + text4;
				}
				if (num7 > 12)
				{
					num7 -= 12;
				}
				if (num7 == 0)
				{
					num7 = 12;
				}
				if (player[myPlayer].accWatch == 1)
				{
					text4 = "00";
				}
				else if (player[myPlayer].accWatch == 2)
				{
					text4 = ((!(num8 < 30.0)) ? "30" : "00");
				}
				text2 = num7 + ":" + text4 + " " + textValue;
				flag = true;
			}
			else if (player[myPlayer].accWeatherRadio && !flag5 && (!player[myPlayer].hideInfo[1] || playerInventory))
			{
				num = 1;
				text3 = Lang.inter[96].Value;
				string text5 = "";
				text5 = (IsItStorming ? Language.GetTextValue("GameUI.Storm") : (((double)maxRaining > 0.6) ? Language.GetTextValue("GameUI.HeavyRain") : (((double)maxRaining >= 0.2) ? Language.GetTextValue("GameUI.Rain") : ((maxRaining > 0f) ? Language.GetTextValue("GameUI.LightRain") : ((cloudBGActive > 0f) ? Language.GetTextValue("GameUI.Overcast") : ((numClouds > 90) ? Language.GetTextValue("GameUI.MostlyCloudy") : ((numClouds > 55) ? Language.GetTextValue("GameUI.Cloudy") : ((numClouds <= 15) ? Language.GetTextValue("GameUI.Clear") : Language.GetTextValue("GameUI.PartlyCloudy")))))))));
				text2 = text5;
				int num9 = (int)(windSpeedCurrent * 50f);
				if (num9 < 0)
				{
					text2 += Language.GetTextValue("GameUI.EastWind", Math.Abs(num9));
				}
				else if (num9 > 0)
				{
					text2 += Language.GetTextValue("GameUI.WestWind", num9);
				}
				if (Sandstorm.Happening)
				{
					if (GlobalTimeWrappedHourly % 10f >= 5f)
					{
						text2 = Language.GetTextValue("GameUI.Sandstorm");
					}
					text2 += " +";
				}
				flag5 = true;
			}
			else if (player[myPlayer].accCalendar && !flag8 && (!player[myPlayer].hideInfo[7] || playerInventory))
			{
				num = ((bloodMoon && !dayTime) ? 8 : ((!eclipse || !dayTime) ? 7 : 8));
				text3 = Lang.inter[102].Value;
				if (moonPhase == 0)
				{
					text2 = Language.GetTextValue("GameUI.FullMoon");
				}
				else if (moonPhase == 1)
				{
					text2 = Language.GetTextValue("GameUI.WaningGibbous");
				}
				else if (moonPhase == 2)
				{
					text2 = Language.GetTextValue("GameUI.ThirdQuarter");
				}
				else if (moonPhase == 3)
				{
					text2 = Language.GetTextValue("GameUI.WaningCrescent");
				}
				else if (moonPhase == 4)
				{
					text2 = Language.GetTextValue("GameUI.NewMoon");
				}
				else if (moonPhase == 5)
				{
					text2 = Language.GetTextValue("GameUI.WaxingCrescent");
				}
				else if (moonPhase == 6)
				{
					text2 = Language.GetTextValue("GameUI.FirstQuarter");
				}
				else if (moonPhase == 7)
				{
					text2 = Language.GetTextValue("GameUI.WaxingGibbous");
				}
				flag8 = true;
			}
			else if (player[myPlayer].accFishFinder && !flag4 && (!player[myPlayer].hideInfo[2] || playerInventory))
			{
				bool flag13 = false;
				num = 2;
				text3 = Lang.inter[97].Value;
				for (int j = 0; j < 1000; j++)
				{
					if (projectile[j].active && projectile[j].owner == myPlayer && projectile[j].bobber)
					{
						flag13 = true;
						break;
					}
				}
				if (flag13)
				{
					text2 = player[myPlayer].displayedFishingInfo;
				}
				else
				{
					PlayerFishingConditions fishingConditions = player[myPlayer].GetFishingConditions();
					text2 = ((fishingConditions.BaitItemType != 2673) ? (player[myPlayer].displayedFishingInfo = Language.GetTextValue("GameUI.FishingPower", fishingConditions.FinalFishingLevel)) : Language.GetTextValue("GameUI.FishingWarning"));
				}
				flag4 = true;
			}
			else if (player[myPlayer].accOreFinder && !flag10 && (!player[myPlayer].hideInfo[10] || playerInventory))
			{
				num = 10;
				text3 = Lang.inter[104].Value;
				if (PlayerSceneMetrics.BestOreType <= 0)
				{
					text2 = Language.GetTextValue("GameUI.NoTreasureNearby");
					infoTextColor = color;
				}
				else
				{
					int baseOption = 0;
					int num10 = PlayerSceneMetrics.BestOreType;
					Microsoft.Xna.Framework.Point bestOrePosition = PlayerSceneMetrics.BestOrePosition;
					Tile tileSafely = Framing.GetTileSafely(bestOrePosition);
					if (tileSafely.active())
					{
						MapHelper.GetTileBaseOption(bestOrePosition.X, bestOrePosition.Y, tileSafely.type, tileSafely, ref baseOption);
						num10 = tileSafely.type;
						if (baseOption >= 13 || TileID.Sets.BasicChest[num10] || TileID.Sets.BasicChestFake[num10])
						{
							baseOption = 0;
						}
					}
					text2 = Language.GetTextValue("GameUI.OreDetected", Lang.GetMapObjectName(MapHelper.TileToLookup(num10, baseOption)));
				}
				flag10 = true;
			}
			else if (player[myPlayer].accCritterGuide && !flag11 && (!player[myPlayer].hideInfo[11] || playerInventory))
			{
				flag11 = true;
				num = 11;
				text3 = Lang.inter[105].Value;
				int num11 = 1300;
				int num12 = 0;
				int num13 = -1;
				if (player[myPlayer].accCritterGuideCounter <= 0)
				{
					player[myPlayer].accCritterGuideCounter = 15;
					for (int k = 0; k < maxNPCs; k++)
					{
						if (npc[k].active && npc[k].rarity > num12 && (npc[k].Center - player[myPlayer].Center).Length() < (float)num11)
						{
							num13 = k;
							num12 = npc[k].rarity;
						}
					}
					player[myPlayer].accCritterGuideNumber = (byte)num13;
				}
				else
				{
					player[myPlayer].accCritterGuideCounter--;
					num13 = player[myPlayer].accCritterGuideNumber;
				}
				if (num13 >= 0 && num13 < maxNPCs && npc[num13].active && npc[num13].rarity > 0)
				{
					text2 = npc[num13].GivenOrTypeName;
					DrawInfoAccs_AdjustInfoTextColorsForNPC(npc[num13], ref infoTextColor, ref infoTextShadowColor);
				}
				else
				{
					text2 = Language.GetTextValue("GameUI.NoRareCreatures");
					infoTextColor = color;
				}
			}
			else if (player[myPlayer].accThirdEye && !flag6 && (!player[myPlayer].hideInfo[5] || playerInventory))
			{
				flag6 = true;
				num = 5;
				text3 = Lang.inter[100].Value;
				int num14 = 2000;
				if (player[myPlayer].accThirdEyeCounter == 0)
				{
					player[myPlayer].accThirdEyeNumber = 0;
					player[myPlayer].accThirdEyeCounter = 15;
					for (int l = 0; l < maxNPCs; l++)
					{
						if (npc[l].active && !npc[l].friendly && npc[l].damage > 0 && npc[l].lifeMax > 5 && !npc[l].dontCountMe && (npc[l].Center - player[myPlayer].Center).Length() < (float)num14)
						{
							player[myPlayer].accThirdEyeNumber++;
						}
					}
				}
				else
				{
					player[myPlayer].accThirdEyeCounter--;
				}
				if (player[myPlayer].accThirdEyeNumber != 0)
				{
					text2 = ((player[myPlayer].accThirdEyeNumber != 1) ? Language.GetTextValue("GameUI.EnemiesNearby", player[myPlayer].accThirdEyeNumber) : Language.GetTextValue("GameUI.OneEnemyNearby"));
				}
				else
				{
					text2 = Language.GetTextValue("GameUI.NoEnemiesNearby");
					infoTextColor = color;
				}
			}
			else if (player[myPlayer].accJarOfSouls && !flag7 && (!player[myPlayer].hideInfo[6] || playerInventory))
			{
				flag7 = true;
				num = 6;
				text3 = Lang.inter[101].Value;
				int lastCreatureHit = player[myPlayer].lastCreatureHit;
				if (lastCreatureHit <= 0)
				{
					text2 = Language.GetTextValue("GameUI.NoKillCount");
					infoTextColor = color;
				}
				else
				{
					text2 = Lang.GetNPCNameValue(BannerSystem.BannerToNPC(lastCreatureHit)) + ": " + BannerSystem.GetKillCount(lastCreatureHit);
				}
			}
			else if (player[myPlayer].accDreamCatcher && !flag12 && (!player[myPlayer].hideInfo[12] || playerInventory))
			{
				num = 12;
				text3 = Lang.inter[106].Value;
				player[myPlayer].checkDPSTime();
				int dPS = player[myPlayer].getDPS();
				flag12 = true;
				if (dPS == 0)
				{
					text2 = Language.GetTextValue("GameUI.NoDPS");
					infoTextColor = color;
				}
				else
				{
					text2 = Language.GetTextValue("GameUI.DPS", player[myPlayer].getDPS());
				}
			}
			else if (player[myPlayer].accStopwatch && !flag9 && (!player[myPlayer].hideInfo[9] || playerInventory))
			{
				num = 9;
				text3 = Lang.inter[103].Value;
				Vector2 vector = player[myPlayer].velocity + player[myPlayer].instantMovementAccumulatedThisFrame;
				if (player[myPlayer].mount.Active && player[myPlayer].mount.IsConsideredASlimeMount && player[myPlayer].velocity.Y != 0f && !player[myPlayer].SlimeDontHyperJump)
				{
					vector.Y += player[myPlayer].velocity.Y;
				}
				int num15 = (int)(1f + vector.Length() * 6f);
				if (num15 > player[myPlayer].speedSlice.Length)
				{
					num15 = player[myPlayer].speedSlice.Length;
				}
				float num16 = 0f;
				for (int num17 = num15 - 1; num17 > 0; num17--)
				{
					player[myPlayer].speedSlice[num17] = player[myPlayer].speedSlice[num17 - 1];
				}
				player[myPlayer].speedSlice[0] = vector.Length();
				for (int m = 0; m < player[myPlayer].speedSlice.Length; m++)
				{
					if (m < num15)
					{
						num16 += player[myPlayer].speedSlice[m];
					}
					else
					{
						player[myPlayer].speedSlice[m] = num16 / (float)num15;
					}
				}
				num16 /= (float)num15;
				int num18 = 42240;
				int num19 = 216000;
				float num20 = num16 * (float)num19 / (float)num18;
				if (!player[myPlayer].merman && !player[myPlayer].ignoreWater)
				{
					if (player[myPlayer].honeyWet)
					{
						num20 /= 4f;
					}
					else if (player[myPlayer].shimmerWet)
					{
						num20 *= 0.375f;
					}
					else if (player[myPlayer].wet && !player[myPlayer].trident)
					{
						num20 /= 2f;
					}
				}
				text2 = Language.GetTextValue("GameUI.Speed", Math.Round(num20));
				flag9 = true;
			}
			else if (player[myPlayer].accCompass > 0 && !flag3 && (!player[myPlayer].hideInfo[3] || playerInventory))
			{
				num = 3;
				text3 = Lang.inter[98].Value;
				int num21 = (int)((player[myPlayer].position.X + (float)(player[myPlayer].width / 2)) * 2f / 16f - (float)maxTilesX);
				text2 = ((num21 > 0) ? Language.GetTextValue("GameUI.CompassEast", num21) : ((num21 >= 0) ? Language.GetTextValue("GameUI.CompassCenter") : Language.GetTextValue("GameUI.CompassWest", -num21)));
				flag3 = true;
			}
			else if (player[myPlayer].accDepthMeter > 0 && !flag2 && (!player[myPlayer].hideInfo[4] || playerInventory))
			{
				num = 4;
				text3 = Lang.inter[99].Value;
				int num22 = (int)((double)((player[myPlayer].position.Y + (float)player[myPlayer].height) * 2f / 16f) - worldSurface * 2.0);
				string text6 = "";
				float num23 = (float)maxTilesX / 4200f;
				num23 *= num23;
				float num24 = (float)((double)(player[myPlayer].Center.Y / 16f - (65f + 10f * num23)) / (worldSurface / 5.0));
				text6 = ((player[myPlayer].Bottom.Y > (float)((maxTilesY - 204) * 16)) ? Language.GetTextValue("GameUI.LayerUnderworld") : (((double)player[myPlayer].Bottom.Y > rockLayer * 16.0) ? Language.GetTextValue("GameUI.LayerCaverns") : ((num22 > 0) ? Language.GetTextValue("GameUI.LayerUnderground") : ((!(num24 >= 1f)) ? Language.GetTextValue("GameUI.LayerSpace") : Language.GetTextValue("GameUI.LayerSurface")))));
				string text7 = "";
				num22 = Math.Abs(num22);
				text7 = ((num22 != 0) ? Language.GetTextValue("GameUI.Depth", num22) : Language.GetTextValue("GameUI.DepthLevel"));
				text2 = text7 + " " + text6;
				flag2 = true;
			}
			if (!(text2 != ""))
			{
				continue;
			}
			GetInfoAccIconPosition(num3, startX, out var X, out var Y);
			if (num >= 0)
			{
				num3++;
				int num25 = 22;
				if (screenHeight < 650)
				{
					num25 = 20;
				}
				Vector2 vector2 = new Vector2(X, Y + 74 + num25 * i + 52);
				int num26 = num;
				if (num26 == 8)
				{
					num26 = 7;
				}
				Microsoft.Xna.Framework.Color color2 = Microsoft.Xna.Framework.Color.White;
				bool flag14 = false;
				if (playerInventory)
				{
					vector2 = new Vector2(X, Y);
					if ((float)mouseX >= vector2.X && (float)mouseY >= vector2.Y && (float)mouseX <= vector2.X + (float)TextureAssets.InfoIcon[num].Width() && (float)mouseY <= vector2.Y + (float)TextureAssets.InfoIcon[num].Height())
					{
						state = num3;
						if (!PlayerInput.IgnoreMouseInterface)
						{
							flag14 = true;
							player[myPlayer].mouseInterface = true;
							if (mouseLeft && mouseLeftRelease)
							{
								SoundEngine.PlaySound(12);
								mouseLeftRelease = false;
								player[myPlayer].hideInfo[num26] = !player[myPlayer].hideInfo[num26];
							}
							if (!mouseText)
							{
								text = text3;
								mouseText = true;
							}
						}
					}
					if (player[myPlayer].hideInfo[num26])
					{
						color2 = new Microsoft.Xna.Framework.Color(80, 80, 80, 70);
					}
				}
				else if ((float)mouseX >= vector2.X && (float)mouseY >= vector2.Y && (float)mouseX <= vector2.X + (float)TextureAssets.InfoIcon[num].Width() && (float)mouseY <= vector2.Y + (float)TextureAssets.InfoIcon[num].Height() && !mouseText)
				{
					num2 = i;
					text = text3;
					mouseText = true;
				}
				UILinkPointNavigator.SetPosition(1558 + num3 - 1, vector2 + TextureAssets.InfoIcon[num].Value.Size() * 0.75f);
				spriteBatch.Draw(TextureAssets.InfoIcon[num].Value, vector2, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.InfoIcon[num].Width(), TextureAssets.InfoIcon[num].Height()), color2, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				if (flag14)
				{
					spriteBatch.Draw(TextureAssets.InfoIcon[13].Value, vector2 - Vector2.One * 2f, null, OurFavoriteColor, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				}
				X += 20;
			}
			UILinkPointNavigator.Shortcuts.INFOACCCOUNT = num3;
			if (playerInventory)
			{
				continue;
			}
			Vector2 scale = new Vector2(1f);
			Vector2 vector3 = FontAssets.MouseText.Value.MeasureString(text2);
			if (vector3.X > num4)
			{
				scale.X = num4 / vector3.X;
			}
			if (scale.X < 0.58f)
			{
				scale.Y = 1f - scale.X / 3f;
			}
			for (int n = 0; n < 5; n++)
			{
				int num27 = 0;
				int num28 = 0;
				Microsoft.Xna.Framework.Color color3 = infoTextShadowColor;
				if (n == 0)
				{
					num27 = -2;
				}
				if (n == 1)
				{
					num27 = 2;
				}
				if (n == 2)
				{
					num28 = -2;
				}
				if (n == 3)
				{
					num28 = 2;
				}
				if (n == 4)
				{
					color3 = infoTextColor;
				}
				if (i > num2 && i < num2 + 2)
				{
					color3 = new Microsoft.Xna.Framework.Color(color3.R / 3, color3.G / 3, color3.B / 3, color3.A / 3);
				}
				int num29 = 22;
				if (screenHeight < 650)
				{
					num29 = 20;
				}
				spriteBatch.DrawString(FontAssets.MouseText.Value, text2, new Vector2(X + num27, Y + 74 + num29 * i + num28 + 48), color3, 0f, default(Vector2), scale, SpriteEffects.None, 0f);
			}
		}
		if (!string.IsNullOrEmpty(text))
		{
			if (playerInventory)
			{
				player[myPlayer].mouseInterface = true;
			}
			MouseTextNoOverride(text, 0, 0);
		}
		DoStatefulTickSound(ref infoAccMouseOver, state);
	}

	private void DrawInfoAccs_AdjustInfoTextColorsForNPC(NPC npc, ref Microsoft.Xna.Framework.Color infoTextColor, ref Microsoft.Xna.Framework.Color infoTextShadowColor)
	{
		for (int i = 0; i < NPCID.Sets.GoldCrittersCollection.Count; i++)
		{
			int num = NPCID.Sets.GoldCrittersCollection[i];
			if (npc.type == num)
			{
				infoTextColor = OurFavoriteColor;
				infoTextShadowColor = infoTextColor * 0.1f;
				byte a = (infoTextShadowColor.A = mouseTextColor);
				infoTextColor.A = a;
				break;
			}
		}
	}

	private static void GetInfoAccIconPosition(int drawnCount, int StartX, out int X, out int Y)
	{
		if (!playerInventory)
		{
			X = screenWidth - 280;
			Y = -32;
			if (mapStyle == 1 && mapEnabled)
			{
				Y += 261;
			}
		}
		else if (ShouldDrawInfoIconsHorizontally)
		{
			X = screenWidth - 280 + 20 * drawnCount - 10;
			Y = 94;
			if (mapStyle == 1 && mapEnabled)
			{
				Y += 261;
			}
		}
		else
		{
			int num = (int)(52f * inventoryScale);
			float num2 = 0.85f;
			int num3 = (int)(52f * num2);
			int nPCS_IconsPerColumn = UILinkPointNavigator.Shortcuts.NPCS_IconsPerColumn;
			int nPCS_IconsTotal = UILinkPointNavigator.Shortcuts.NPCS_IconsTotal;
			int num4 = (int)Math.Ceiling((float)nPCS_IconsTotal / (float)nPCS_IconsPerColumn);
			int num5 = nPCS_IconsTotal - Math.Max(0, (num4 - 1) * nPCS_IconsPerColumn);
			int num6 = nPCS_IconsPerColumn - num5;
			int num7 = Math.Max(0, num4 - 4);
			if (num4 >= 4 && num6 < 5)
			{
				num7++;
			}
			int num8 = num7 * (num3 + 4);
			if (EquipPage != 1)
			{
				num8 = 0;
			}
			X = 697 - num * 4 + screenWidth - 800 + 20 * (drawnCount % 2) - num8;
			Y = 114 + mH + num * 7 + num / 2 + 20 * (drawnCount / 2) + 8 * (drawnCount / 4) - 20;
			if (EquipPage == 2)
			{
				X += num + num / 2;
				Y -= num;
			}
		}
		X += StartX;
	}

	private void DrawBuilderAccToggles(Vector2 start)
	{
		if (!playerInventory)
		{
			return;
		}
		int state = -1;
		string.IsNullOrEmpty(npcChatText);
		if (false || Main.player[myPlayer].sign >= 0)
		{
			return;
		}
		int num = 0;
		Player player = Main.player[myPlayer];
		int[] builderAccStatus = Main.player[myPlayer].builderAccStatus;
		GetBuilderAccsCountToShow(player, out var blockReplaceIcons, out var torchGodIcons, out var totalDrawnIcons);
		start.Y += 24 * torchGodIcons;
		bool flag = totalDrawnIcons >= 10;
		int num2 = 10;
		for (int i = 0; i < num2; i++)
		{
			int num3 = i - 2;
			switch (i)
			{
			case 0:
				num3 = 8;
				break;
			case 1:
				num3 = 9;
				break;
			}
			Texture2D value = TextureAssets.BuilderAcc.Value;
			Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(0, 16, 14, 14);
			Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White;
			Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(127, 127, 127);
			Vector2 vector = start + new Vector2(0f, num * 24);
			if (flag)
			{
				vector.Y -= 24f;
			}
			bool flag2 = Utils.CenteredRectangle(vector, new Vector2(14f)).Contains(MouseScreen.ToPoint()) && !PlayerInput.IgnoreMouseInterface;
			bool flag3 = flag2 && mouseLeft && mouseLeftRelease;
			switch (num3)
			{
			case 8:
				if (!player.InfoAccMechShowWires)
				{
					continue;
				}
				rectangle.X = num3 * 16;
				color = ((builderAccStatus[num3] == 0) ? color : color2);
				if (flag2)
				{
					player.mouseInterface = true;
					MouseTextNoOverride((builderAccStatus[num3] == 0) ? Language.GetTextValue("GameUI.WireModeForced") : Language.GetTextValue("GameUI.WireModeNormal"), 0, 0);
					mouseText = true;
				}
				if (flag3)
				{
					builderAccStatus[num3] = ((builderAccStatus[num3] == 0) ? 1 : 0);
					SoundEngine.PlaySound(12);
					mouseLeftRelease = false;
				}
				break;
			case 0:
				if (!player.rulerLine)
				{
					continue;
				}
				rectangle.X = num3 * 16;
				color = ((builderAccStatus[num3] == 0) ? color : color2);
				if (flag2)
				{
					player.mouseInterface = true;
					MouseTextNoOverride((builderAccStatus[num3] == 0) ? Language.GetTextValue("GameUI.RulerOn") : Language.GetTextValue("GameUI.RulerOff"), 0, 0);
					mouseText = true;
				}
				if (flag3)
				{
					builderAccStatus[num3] = ((builderAccStatus[num3] == 0) ? 1 : 0);
					SoundEngine.PlaySound(12);
					mouseLeftRelease = false;
				}
				break;
			case 1:
				if (!player.rulerGrid)
				{
					continue;
				}
				rectangle.X = num3 * 16;
				color = ((builderAccStatus[num3] == 0) ? color : color2);
				if (flag2)
				{
					player.mouseInterface = true;
					MouseTextNoOverride((builderAccStatus[num3] == 0) ? Language.GetTextValue("GameUI.MechanicalRulerOn") : Language.GetTextValue("GameUI.MechanicalRulerOff"), 0, 0);
					mouseText = true;
				}
				if (flag3)
				{
					builderAccStatus[num3] = ((builderAccStatus[num3] == 0) ? 1 : 0);
					SoundEngine.PlaySound(12);
					mouseLeftRelease = false;
				}
				break;
			case 3:
				if (!player.autoPaint)
				{
					continue;
				}
				rectangle.X = num3 * 16;
				color = ((builderAccStatus[num3] == 0) ? color : color2);
				if (flag2)
				{
					player.mouseInterface = true;
					MouseTextNoOverride((builderAccStatus[num3] == 0) ? Language.GetTextValue("GameUI.PaintSprayerOn") : Language.GetTextValue("GameUI.PaintSprayerOff"), 0, 0);
					mouseText = true;
				}
				if (flag3)
				{
					builderAccStatus[num3] = ((builderAccStatus[num3] == 0) ? 1 : 0);
					SoundEngine.PlaySound(12);
					mouseLeftRelease = false;
				}
				break;
			case 2:
				if (!player.autoActuator)
				{
					continue;
				}
				rectangle.X = num3 * 16;
				color = ((builderAccStatus[num3] == 0) ? color : color2);
				if (flag2)
				{
					player.mouseInterface = true;
					MouseTextNoOverride((builderAccStatus[num3] == 0) ? Language.GetTextValue("GameUI.ActuationDeviceOn") : Language.GetTextValue("GameUI.ActuationDeviceOff"), 0, 0);
					mouseText = true;
				}
				if (flag3)
				{
					builderAccStatus[num3] = ((builderAccStatus[num3] == 0) ? 1 : 0);
					SoundEngine.PlaySound(12);
					mouseLeftRelease = false;
				}
				break;
			case 4:
			case 5:
			case 6:
			case 7:
			case 9:
				if (!player.InfoAccMechShowWires)
				{
					continue;
				}
				rectangle.X = num3 * 16;
				color = ((builderAccStatus[num3] == 0) ? color : ((builderAccStatus[num3] == 1) ? color2 : ((builderAccStatus[num3] == 2) ? color2.MultiplyRGBA(new Microsoft.Xna.Framework.Color(0.66f, 0.66f, 0.66f, 0.66f)) : color2.MultiplyRGBA(new Microsoft.Xna.Framework.Color(0.33f, 0.33f, 0.33f, 0.33f)))));
				if (flag2)
				{
					player.mouseInterface = true;
					string arg = "";
					switch (num3)
					{
					case 4:
						arg = Language.GetTextValue("Game.RedWires");
						break;
					case 5:
						arg = Language.GetTextValue("Game.BlueWires");
						break;
					case 6:
						arg = Language.GetTextValue("Game.GreenWires");
						break;
					case 7:
						arg = Language.GetTextValue("Game.YellowWires");
						break;
					case 9:
						arg = Language.GetTextValue("Game.Actuators");
						break;
					}
					string arg2 = "";
					switch (builderAccStatus[num3])
					{
					case 0:
						arg2 = Language.GetTextValue("GameUI.Bright");
						break;
					case 1:
						arg2 = Language.GetTextValue("GameUI.Normal");
						break;
					case 2:
						arg2 = Language.GetTextValue("GameUI.Faded");
						break;
					case 3:
						arg2 = Language.GetTextValue("GameUI.Hidden");
						break;
					}
					MouseTextNoOverride($"{arg}: {arg2}", 0, 0);
					mouseText = true;
				}
				if (flag3)
				{
					builderAccStatus[num3]++;
					if (builderAccStatus[num3] >= 3)
					{
						builderAccStatus[num3] = 0;
					}
					SoundEngine.PlaySound(12);
					mouseLeftRelease = false;
				}
				break;
			case 11:
				continue;
			}
			spriteBatch.Draw(value, vector, rectangle, color, 0f, rectangle.Size() / 2f, 1f, SpriteEffects.None, 0f);
			if (flag2)
			{
				spriteBatch.Draw(TextureAssets.InfoIcon[13].Value, vector, null, OurFavoriteColor, 0f, TextureAssets.InfoIcon[13].Value.Size() / 2f, 1f, SpriteEffects.None, 0f);
			}
			UILinkPointNavigator.SetPosition(6000 + num + blockReplaceIcons + torchGodIcons, vector + rectangle.Size() * 0.15f);
			if (flag2)
			{
				state = num;
			}
			num++;
		}
		if (DrawBlockReplacementIcon(0, 0, flag, 0))
		{
			state = num;
		}
		num++;
		if (player.unlockedBiomeTorches)
		{
			if (DrawTorchBiomeSwapIcon(0, 0, flag, 1))
			{
				state = num;
			}
			num++;
		}
		DoStatefulTickSound(ref toggleAccMouseOver, state);
		UILinkPointNavigator.Shortcuts.BUILDERACCCOUNT = num;
	}

	private static void GetBuilderAccsCountToShow(Player plr, out int blockReplaceIcons, out int torchGodIcons, out int totalDrawnIcons)
	{
		blockReplaceIcons = 1;
		torchGodIcons = (plr.unlockedBiomeTorches ? 1 : 0);
		totalDrawnIcons = plr.InfoAccMechShowWires.ToInt() * 6 + plr.rulerLine.ToInt() + plr.rulerGrid.ToInt() + plr.autoActuator.ToInt() + plr.autoPaint.ToInt() + blockReplaceIcons + torchGodIcons;
	}

	public static void CheckInvasionProgressDisplay()
	{
		if (invasionProgressMode != 2)
		{
			invasionProgressNearInvasion = false;
			return;
		}
		bool flag = false;
		Player player = Main.player[myPlayer];
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X, (int)screenPosition.Y, screenWidth, screenHeight);
		int num = 5000;
		int num2 = 0;
		for (int i = 0; i < maxNPCs; i++)
		{
			if (!npc[i].active)
			{
				continue;
			}
			num2 = NPC.GetNPCInvasionGroup(npc[i].type);
			if (num2 != 0 && (num2 != -1 || (!((double)player.position.Y > worldSurface * 16.0) && !dayTime && snowMoon)) && (num2 != -2 || (!((double)player.position.Y > worldSurface * 16.0) && !dayTime && pumpkinMoon)) && (num2 != -3 || DD2Event.Ongoing) && (num2 <= 0 || (!((double)player.position.Y > worldSurface * 16.0) && invasionType == num2)))
			{
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle((int)(npc[i].position.X + (float)(npc[i].width / 2)) - num, (int)(npc[i].position.Y + (float)(npc[i].height / 2)) - num, num * 2, num * 2);
				if (rectangle.Intersects(value))
				{
					flag = true;
					break;
				}
			}
		}
		invasionProgressNearInvasion = flag;
		if (!flag || invasionProgressIcon != 0)
		{
			return;
		}
		int waveNumber = NPC.waveNumber;
		if (snowMoon)
		{
			int progressMax = NPC.MoonEventRequiredPointsPerWaveLookup[waveNumber];
			ReportInvasionProgress((int)NPC.waveKills, progressMax, 1, waveNumber);
			return;
		}
		if (pumpkinMoon)
		{
			int progressMax2 = NPC.MoonEventRequiredPointsPerWaveLookup[waveNumber];
			ReportInvasionProgress((int)NPC.waveKills, progressMax2, 2, waveNumber);
			return;
		}
		if (DD2Event.Ongoing)
		{
			DD2Event.ReportEventProgress();
			return;
		}
		int progressMax3 = 1;
		if (invasionType != 0 && invasionSizeStart != 0)
		{
			progressMax3 = invasionSizeStart;
		}
		ReportInvasionProgress(invasionSizeStart - invasionSize, progressMax3, (num2 < 0) ? (-num2) : (num2 + 3), 0);
	}

	public static void SyncAnInvasion(int toWho)
	{
		int waveNumber = NPC.waveNumber;
		if (snowMoon)
		{
			int num = (new int[21]
			{
				0, 25, 15, 10, 30, 100, 160, 180, 200, 250,
				300, 375, 450, 525, 675, 850, 1025, 1325, 1550, 2000,
				0
			})[waveNumber];
			NetMessage.SendData(78, toWho, -1, null, (int)NPC.waveKills, num, 1f, waveNumber);
		}
		else if (pumpkinMoon)
		{
			int num2 = (new int[16]
			{
				0, 25, 40, 50, 80, 100, 160, 180, 200, 250,
				300, 375, 450, 525, 675, 0
			})[waveNumber];
			NetMessage.SendData(78, toWho, -1, null, (int)NPC.waveKills, num2, 2f, waveNumber);
		}
		else if (DD2Event.Ongoing)
		{
			DD2Event.SyncInvasionProgress(toWho);
		}
		else if (invasionType > 0)
		{
			int num3 = 1;
			if (invasionType != 0 && invasionSizeStart != 0)
			{
				num3 = invasionSizeStart;
			}
			NetMessage.SendData(78, toWho, -1, null, invasionSizeStart - invasionSize, num3, invasionType + 3);
		}
	}

	public static void ReportInvasionProgress(int progress, int progressMax, int icon, int progressWave)
	{
		invasionProgress = progress;
		invasionProgressMax = progressMax;
		invasionProgressIcon = icon;
		invasionProgressWave = progressWave;
		invasionProgressDisplayLeft = 160;
	}

	public static void DrawInvasionProgress()
	{
		if (invasionProgress == -1)
		{
			return;
		}
		if (invasionProgressMode == 2 && invasionProgressNearInvasion && invasionProgressDisplayLeft < 160)
		{
			invasionProgressDisplayLeft = 160;
		}
		if (!gamePaused && invasionProgressDisplayLeft > 0)
		{
			invasionProgressDisplayLeft--;
		}
		if (invasionProgressDisplayLeft > 0)
		{
			invasionProgressAlpha += 0.05f;
		}
		else
		{
			invasionProgressAlpha -= 0.05f;
		}
		if (invasionProgressMode == 0)
		{
			invasionProgressDisplayLeft = 0;
			invasionProgressAlpha = 0f;
		}
		if (invasionProgressAlpha < 0f)
		{
			invasionProgressAlpha = 0f;
		}
		if (invasionProgressAlpha > 1f)
		{
			invasionProgressAlpha = 1f;
		}
		if (invasionProgressAlpha <= 0f)
		{
			return;
		}
		float num = 0.5f + invasionProgressAlpha * 0.5f;
		Texture2D value = TextureAssets.Extra[9].Value;
		string text = "";
		Microsoft.Xna.Framework.Color c = Microsoft.Xna.Framework.Color.White;
		if (invasionProgressIcon == 1)
		{
			value = TextureAssets.Extra[8].Value;
			text = Lang.inter[83].Value;
			c = new Microsoft.Xna.Framework.Color(64, 109, 164) * 0.5f;
		}
		else if (invasionProgressIcon == 2)
		{
			value = TextureAssets.Extra[12].Value;
			text = Lang.inter[84].Value;
			c = new Microsoft.Xna.Framework.Color(112, 86, 114) * 0.5f;
		}
		else if (invasionProgressIcon == 3)
		{
			value = TextureAssets.Extra[79].Value;
			text = Language.GetTextValue("DungeonDefenders2.InvasionProgressTitle");
			c = new Microsoft.Xna.Framework.Color(88, 0, 160) * 0.5f;
		}
		else if (invasionProgressIcon == 7)
		{
			value = TextureAssets.Extra[10].Value;
			text = Lang.inter[85].Value;
			c = new Microsoft.Xna.Framework.Color(165, 160, 155) * 0.5f;
		}
		else if (invasionProgressIcon == 6)
		{
			value = TextureAssets.Extra[11].Value;
			text = Lang.inter[86].Value;
			c = new Microsoft.Xna.Framework.Color(148, 122, 72) * 0.5f;
		}
		else if (invasionProgressIcon == 5)
		{
			value = TextureAssets.Extra[7].Value;
			text = Lang.inter[87].Value;
			c = new Microsoft.Xna.Framework.Color(173, 135, 140) * 0.5f;
		}
		else if (invasionProgressIcon == 4)
		{
			value = TextureAssets.Extra[9].Value;
			text = Lang.inter[88].Value;
			c = new Microsoft.Xna.Framework.Color(94, 72, 131) * 0.5f;
		}
		if (invasionProgressWave > 0)
		{
			int num2 = (int)(200f * num);
			int num3 = (int)(45f * num);
			Vector2 vector = new Vector2(screenWidth - 120, screenHeight - 40);
			Utils.DrawInvBG(R: new Microsoft.Xna.Framework.Rectangle((int)vector.X - num2 / 2, (int)vector.Y - num3 / 2, num2, num3), sb: spriteBatch, c: new Microsoft.Xna.Framework.Color(63, 65, 151, 255) * 0.785f);
			string text2 = "";
			text2 = Language.GetTextValue(arg1: (invasionProgressMax != 0) ? ((int)((float)invasionProgress * 100f / (float)invasionProgressMax) + "%") : Language.GetTextValue("Game.InvasionPoints", invasionProgress), key: "Game.WaveMessage", arg0: invasionProgressWave);
			Texture2D value2 = TextureAssets.ColorBar.Value;
			_ = TextureAssets.ColorBlip.Value;
			float num4 = MathHelper.Clamp((float)invasionProgress / (float)invasionProgressMax, 0f, 1f);
			if (invasionProgressMax == 0)
			{
				num4 = 1f;
			}
			float num5 = 169f * num;
			float num6 = 8f * num;
			Vector2 vector2 = vector + Vector2.UnitY * num6 + Vector2.UnitX * 1f;
			Utils.DrawBorderString(spriteBatch, text2, vector2, Microsoft.Xna.Framework.Color.White * invasionProgressAlpha, num, 0.5f, 1f);
			spriteBatch.Draw(value2, vector, null, Microsoft.Xna.Framework.Color.White * invasionProgressAlpha, 0f, new Vector2(value2.Width / 2, 0f), num, SpriteEffects.None, 0f);
			vector2 += Vector2.UnitX * (num4 - 0.5f) * num5;
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector2, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), new Microsoft.Xna.Framework.Color(255, 241, 51) * invasionProgressAlpha, 0f, new Vector2(1f, 0.5f), new Vector2(num5 * num4, num6), SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector2, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), new Microsoft.Xna.Framework.Color(255, 165, 0, 127) * invasionProgressAlpha, 0f, new Vector2(1f, 0.5f), new Vector2(2f, num6), SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector2, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), Microsoft.Xna.Framework.Color.Black * invasionProgressAlpha, 0f, new Vector2(0f, 0.5f), new Vector2(num5 * (1f - num4), num6), SpriteEffects.None, 0f);
		}
		else
		{
			int num7 = (int)(200f * num);
			int num8 = (int)(45f * num);
			Vector2 vector3 = new Vector2(screenWidth - 120, screenHeight - 40);
			Utils.DrawInvBG(R: new Microsoft.Xna.Framework.Rectangle((int)vector3.X - num7 / 2, (int)vector3.Y - num8 / 2, num7, num8), sb: spriteBatch, c: new Microsoft.Xna.Framework.Color(63, 65, 151, 255) * 0.785f);
			string text3 = "";
			text3 = ((invasionProgressMax != 0) ? ((int)((float)invasionProgress * 100f / (float)invasionProgressMax) + "%") : invasionProgress.ToString());
			text3 = Language.GetTextValue("Game.WaveCleared", text3);
			Texture2D value3 = TextureAssets.ColorBar.Value;
			_ = TextureAssets.ColorBlip.Value;
			if (invasionProgressMax != 0)
			{
				spriteBatch.Draw(value3, vector3, null, Microsoft.Xna.Framework.Color.White * invasionProgressAlpha, 0f, new Vector2(value3.Width / 2, 0f), num, SpriteEffects.None, 0f);
				float num9 = MathHelper.Clamp((float)invasionProgress / (float)invasionProgressMax, 0f, 1f);
				Vector2 vector4 = FontAssets.MouseText.Value.MeasureString(text3);
				float num10 = num;
				if (vector4.Y > 22f)
				{
					num10 *= 22f / vector4.Y;
				}
				float num11 = 169f * num;
				float num12 = 8f * num;
				Vector2 vector5 = vector3 + Vector2.UnitY * num12 + Vector2.UnitX * 1f;
				Utils.DrawBorderString(spriteBatch, text3, vector5 + new Vector2(0f, -4f), Microsoft.Xna.Framework.Color.White * invasionProgressAlpha, num10, 0.5f, 1f);
				vector5 += Vector2.UnitX * (num9 - 0.5f) * num11;
				spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector5, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), new Microsoft.Xna.Framework.Color(255, 241, 51) * invasionProgressAlpha, 0f, new Vector2(1f, 0.5f), new Vector2(num11 * num9, num12), SpriteEffects.None, 0f);
				spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector5, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), new Microsoft.Xna.Framework.Color(255, 165, 0, 127) * invasionProgressAlpha, 0f, new Vector2(1f, 0.5f), new Vector2(2f, num12), SpriteEffects.None, 0f);
				spriteBatch.Draw(TextureAssets.MagicPixel.Value, vector5, new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), Microsoft.Xna.Framework.Color.Black * invasionProgressAlpha, 0f, new Vector2(0f, 0.5f), new Vector2(num11 * (1f - num9), num12), SpriteEffects.None, 0f);
			}
		}
		Vector2 vector6 = FontAssets.MouseText.Value.MeasureString(text);
		float num13 = 120f;
		if (vector6.X > 200f)
		{
			num13 += vector6.X - 200f;
		}
		Microsoft.Xna.Framework.Rectangle r = Utils.CenteredRectangle(new Vector2((float)screenWidth - num13, screenHeight - 80), (vector6 + new Vector2(value.Width + 12, 6f)) * num);
		Utils.DrawInvBG(spriteBatch, r, c);
		spriteBatch.Draw(value, r.Left() + Vector2.UnitX * num * 8f, null, Microsoft.Xna.Framework.Color.White * invasionProgressAlpha, 0f, new Vector2(0f, value.Height / 2), num * 0.8f, SpriteEffects.None, 0f);
		Utils.DrawBorderString(spriteBatch, text, r.Right() + Vector2.UnitX * num * -22f, Microsoft.Xna.Framework.Color.White * invasionProgressAlpha, num * 0.9f, 1f, 0.4f);
	}

	protected void QuitGame()
	{
		SaveSettings();
		if (!dedServ)
		{
			SocialAPI.Shutdown();
		}
		Assets.TransferCompletedAssets();
		Exit();
	}

	private void Main_Exiting(object sender, EventArgs e)
	{
		TryDisposingEverything();
	}

	private static void TryDisposingEverything()
	{
		ChromaInitializer.DisableAllDeviceGroups();
		CaptureManager.Instance.Dispose();
		audioSystem.Dispose();
	}

	protected Microsoft.Xna.Framework.Color randColor()
	{
		int num = 0;
		int num2 = 0;
		int num3 = 0;
		while (num + num3 + num2 <= 150)
		{
			num = rand.Next(256);
			num2 = rand.Next(256);
			num3 = rand.Next(256);
		}
		return new Microsoft.Xna.Framework.Color(num, num2, num3, 255);
	}

	public static Microsoft.Xna.Framework.Color hslToRgb(Vector3 hslVector)
	{
		return hslToRgb(hslVector.X, hslVector.Y, hslVector.Z);
	}

	public static Microsoft.Xna.Framework.Color hslToRgb(float Hue, float Saturation, float Luminosity, byte a = byte.MaxValue)
	{
		byte r;
		byte g;
		byte b;
		if (Saturation == 0f)
		{
			r = (byte)Math.Round((double)Luminosity * 255.0);
			g = (byte)Math.Round((double)Luminosity * 255.0);
			b = (byte)Math.Round((double)Luminosity * 255.0);
		}
		else
		{
			double num = Hue;
			double num2 = ((!((double)Luminosity < 0.5)) ? ((double)(Luminosity + Saturation - Luminosity * Saturation)) : ((double)Luminosity * (1.0 + (double)Saturation)));
			double t = 2.0 * (double)Luminosity - num2;
			double c = num + 1.0 / 3.0;
			double c2 = num;
			double c3 = num - 1.0 / 3.0;
			c = hue2rgb(c, t, num2);
			c2 = hue2rgb(c2, t, num2);
			double num3 = hue2rgb(c3, t, num2);
			r = (byte)Math.Round(c * 255.0);
			g = (byte)Math.Round(c2 * 255.0);
			b = (byte)Math.Round(num3 * 255.0);
		}
		return new Microsoft.Xna.Framework.Color(r, g, b, a);
	}

	public static double hue2rgb(double c, double t1, double t2)
	{
		if (c < 0.0)
		{
			c += 1.0;
		}
		if (c > 1.0)
		{
			c -= 1.0;
		}
		if (6.0 * c < 1.0)
		{
			return t1 + (t2 - t1) * 6.0 * c;
		}
		if (2.0 * c < 1.0)
		{
			return t2;
		}
		if (3.0 * c < 2.0)
		{
			return t1 + (t2 - t1) * (2.0 / 3.0 - c) * 6.0;
		}
		return t1;
	}

	public static Vector3 rgbToHsl(Microsoft.Xna.Framework.Color newColor)
	{
		float num = (int)newColor.R;
		float num2 = (int)newColor.G;
		float num3 = (int)newColor.B;
		num /= 255f;
		num2 /= 255f;
		num3 /= 255f;
		float val = Math.Max(num, num2);
		val = Math.Max(val, num3);
		float val2 = Math.Min(num, num2);
		val2 = Math.Min(val2, num3);
		float num4 = 0f;
		float num5 = (val + val2) / 2f;
		float y;
		if (val == val2)
		{
			num4 = (y = 0f);
		}
		else
		{
			float num6 = val - val2;
			y = (((double)num5 > 0.5) ? (num6 / (2f - val - val2)) : (num6 / (val + val2)));
			if (val == num)
			{
				num4 = (num2 - num3) / num6 + (float)((num2 < num3) ? 6 : 0);
			}
			if (val == num2)
			{
				num4 = (num3 - num) / num6 + 2f;
			}
			if (val == num3)
			{
				num4 = (num - num2) / num6 + 4f;
			}
			num4 /= 6f;
		}
		return new Vector3(num4, y, num5);
	}

	public static void DrawCursor(Vector2 bonus, bool smart = false)
	{
		if (gameMenu && alreadyGrabbingSunOrMoon)
		{
			return;
		}
		if (player[myPlayer].dead || player[myPlayer].mouseInterface || IsCameraTrackingObject)
		{
			ClearSmartInteract();
			TileInteractionLX = (TileInteractionHX = (TileInteractionLY = (TileInteractionHY = -1)));
		}
		Microsoft.Xna.Framework.Color color = cursorColor;
		if (!gameMenu && LocalPlayer.hasRainbowCursor)
		{
			color = hslToRgb(GlobalTimeWrappedHourly * 0.25f % 1f, 1f, 0.5f);
		}
		bool flag = UILinkPointNavigator.Available && !PlayerInput.InBuildingMode;
		if (PlayerInput.SettingsForUI.ShowGamepadCursor)
		{
			if ((player[myPlayer].dead && !player[myPlayer].ghost && !gameMenu) || player[myPlayer].spectating >= 0 || PlayerInput.InvisibleGamepadInMenus)
			{
				return;
			}
			Vector2 t = new Vector2(mouseX, mouseY);
			Vector2 t2 = Vector2.Zero;
			bool flag2 = smart;
			if (flag2)
			{
				PlayerInput.smartSelectPointer.UpdateCenter(ScreenSize.ToVector2() / 2f);
				t2 = PlayerInput.smartSelectPointer.GetPointerPosition();
				if (Vector2.Distance(t2, t) < 1f)
				{
					flag2 = false;
				}
				else
				{
					Utils.Swap(ref t, ref t2);
				}
			}
			float num = 1f;
			if (flag2)
			{
				num = 0.3f;
				color = Microsoft.Xna.Framework.Color.White * GamepadCursorAlpha;
				int num2 = 17;
				int frameX = 0;
				spriteBatch.Draw(TextureAssets.Cursors[num2].Value, t2 + bonus, TextureAssets.Cursors[num2].Frame(1, 1, frameX), color, (float)Math.PI / 2f * GlobalTimeWrappedHourly, TextureAssets.Cursors[num2].Frame(1, 1, frameX).Size() / 2f, cursorScale, SpriteEffects.None, 0f);
			}
			if (smart && !flag)
			{
				color = Microsoft.Xna.Framework.Color.White * GamepadCursorAlpha * num;
				int num3 = 13;
				int frameX2 = 0;
				spriteBatch.Draw(TextureAssets.Cursors[num3].Value, t + bonus, TextureAssets.Cursors[num3].Frame(2, 1, frameX2), color, 0f, TextureAssets.Cursors[num3].Frame(2, 1, frameX2).Size() / 2f, cursorScale, SpriteEffects.None, 0f);
			}
			else
			{
				color = Microsoft.Xna.Framework.Color.White;
				int num4 = 15;
				spriteBatch.Draw(TextureAssets.Cursors[num4].Value, new Vector2(mouseX, mouseY) + bonus, null, color, 0f, TextureAssets.Cursors[num4].Value.Size() / 2f, cursorScale, SpriteEffects.None, 0f);
			}
		}
		else
		{
			int num5 = smart.ToInt();
			spriteBatch.Draw(TextureAssets.Cursors[num5].Value, new Vector2(mouseX, mouseY) + bonus + Vector2.One, null, new Microsoft.Xna.Framework.Color((int)((float)(int)color.R * 0.2f), (int)((float)(int)color.G * 0.2f), (int)((float)(int)color.B * 0.2f), (int)((float)(int)color.A * 0.5f)), 0f, default(Vector2), cursorScale * 1.1f, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.Cursors[num5].Value, new Vector2(mouseX, mouseY) + bonus, null, color, 0f, default(Vector2), cursorScale, SpriteEffects.None, 0f);
		}
		ParticleSystem_OverCursor.Settings.AnchorPosition = new Vector2(mouseX, mouseY);
		ParticleSystem_OverCursor.Draw(spriteBatch);
	}

	public static void ClearSmartInteract()
	{
		SmartInteractShowingGenuine = false;
		SmartInteractShowingFake = false;
		SmartInteractNPC = -1;
		SmartInteractProj = -1;
		SmartInteractTileCoords.Clear();
		SmartInteractTileCoordsSelected.Clear();
	}

	public static Vector2 DrawThickCursor(bool smart = false)
	{
		if (ThickMouse)
		{
			bool showGamepadCursor = PlayerInput.SettingsForUI.ShowGamepadCursor;
			if (gameMenu && alreadyGrabbingSunOrMoon)
			{
				return Vector2.Zero;
			}
			if (showGamepadCursor && PlayerInput.InvisibleGamepadInMenus)
			{
				return Vector2.Zero;
			}
			if (showGamepadCursor && player[myPlayer].dead && !player[myPlayer].ghost && !gameMenu)
			{
				return Vector2.Zero;
			}
			if (showGamepadCursor && player[myPlayer].spectating >= 0)
			{
				return Vector2.Zero;
			}
			bool flag = UILinkPointNavigator.Available && !PlayerInput.InBuildingMode;
			Microsoft.Xna.Framework.Color mouseBorderColor = MouseBorderColor;
			int num = 11;
			num += smart.ToInt();
			for (int i = 0; i < 4; i++)
			{
				Vector2 vector = Vector2.Zero;
				switch (i)
				{
				case 0:
					vector = new Vector2(0f, 1f);
					break;
				case 1:
					vector = new Vector2(1f, 0f);
					break;
				case 2:
					vector = new Vector2(0f, -1f);
					break;
				case 3:
					vector = new Vector2(-1f, 0f);
					break;
				}
				vector *= 1f;
				vector += Vector2.One * 2f;
				Vector2 origin = new Vector2(2f);
				Microsoft.Xna.Framework.Rectangle? sourceRectangle = null;
				float scale = cursorScale * 1.1f;
				if (showGamepadCursor)
				{
					if (smart && !flag)
					{
						num = 13;
						int frameX = 0;
						vector = Vector2.One;
						sourceRectangle = TextureAssets.Cursors[num].Frame(2, 1, frameX);
						origin = TextureAssets.Cursors[num].Frame(2, 1, frameX).Size() / 2f;
						mouseBorderColor *= GamepadCursorAlpha;
					}
					else
					{
						num = 15;
						vector = Vector2.One;
						origin = TextureAssets.Cursors[num].Value.Size() / 2f;
					}
				}
				spriteBatch.Draw(TextureAssets.Cursors[num].Value, new Vector2(mouseX, mouseY) + vector, sourceRectangle, mouseBorderColor, 0f, origin, scale, SpriteEffects.None, 0f);
			}
			return new Vector2(2f);
		}
		return Vector2.Zero;
	}

	private void OnCharacterNamed(string text)
	{
		PendingPlayer.name = text.Trim();
		PlayerFileData.CreateAndSave(PendingPlayer);
		LoadPlayers();
		menuMode = 1;
	}

	private void OnSeedSelected(string text)
	{
		text = text.Trim();
		if (text.Length == 0)
		{
			ActiveWorldFileData.SetSeedToRandom();
		}
		else
		{
			ActiveWorldFileData.SetSeed(text);
		}
		menuMode = 10;
		WorldGen.CreateNewWorld();
	}

	private void OnWorldNamed(string text)
	{
		menuMode = 10;
		worldName = text.Trim();
		ActiveWorldFileData = WorldFile.CreateMetadata(worldName, SocialAPI.Cloud != null && SocialAPI.Cloud.EnabledByDefault, GameMode);
		menuMode = 5000;
	}

	private static Action CreateGoToMenuEvent(int menu)
	{
		return delegate
		{
			menuMode = menu;
			UILinkPointNavigator.Shortcuts.FANCYUI_SPECIAL_INSTRUCTIONS = 0;
		};
	}

	public static void GoToWorldSelect()
	{
		menuMode = 888;
		MenuUI.SetState(_worldSelectMenu);
	}

	public static void StartClientGameplay()
	{
		menuMode = 10;
		Netplay.StartTcpClient();
	}

	public static void ReleaseHostAndPlayProcess()
	{
		if (tServer != null)
		{
			tServer = null;
		}
	}

	private static string SanitizePathArgument(string argumentName, string argumentPath)
	{
		string input = Regex.Replace(argumentPath, "(\\\\*)\"", "$1$1\\\"");
		string text = "\"" + Regex.Replace(input, "(\\\\+)$", "$1$1") + "\"";
		return " -" + argumentName + " " + text;
	}

	protected void DrawMenu(GameTime gameTime)
	{
		Action action = null;
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, Rasterizer, null, UIScaleMatrix);
		if (!IsEngineLoaded)
		{
			IsEngineLoaded = true;
			if (Main.OnEngineLoad != null)
			{
				Main.OnEngineLoad();
			}
		}
		GamepadMainMenuHandler.Update();
		GamepadMainMenuHandler.MenuItemPositions.Clear();
		int num = menuMode;
		if (menuMode <= 1 && slimeRain)
		{
			StopSlimeRain();
		}
		render = false;
		_playerSceneMetrics.Reset();
		_cameraSceneMetrics.Reset();
		_usingSeparateCameraSceneMetrics = false;
		SceneState.Reset();
		if (!menuChat)
		{
			drawingPlayerChat = false;
			chatMonitor.Clear();
		}
		screenPosition.Y = (float)(worldSurface * 16.0 - (double)screenHeight);
		MenuXMovement = 4f;
		if (alreadyGrabbingSunOrMoon)
		{
			playOldTile = true;
			if (starGame)
			{
				playOldTile = false;
			}
		}
		screenPosition.X += MenuXMovement;
		if (screenPosition.X > 2.1474835E+09f)
		{
			screenPosition.X = 0f;
		}
		if (screenPosition.X < -2.1474835E+09f)
		{
			screenPosition.X = 0f;
		}
		Star.UpdateStars();
		Cloud.UpdateClouds();
		DrawFPS();
		background = 0;
		byte b = (byte)((255 + tileColor.R * 2) / 3);
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(b, b, b, 255);
		if (WorldGen.remixWorldGen)
		{
			logoRotation += logoRotationSpeed * 4E-05f;
			if ((double)logoRotation < 3.04)
			{
				logoRotation += logoRotationSpeed * 0.0016f;
				if (logoRotationSpeed < 0f)
				{
					logoRotationSpeed = 0f;
				}
			}
			if ((double)logoRotation > 3.22)
			{
				logoRotationDirection = -1f;
			}
			else if ((double)logoRotation < 3.06)
			{
				logoRotationDirection = 1f;
			}
			if (logoRotationSpeed < 20f && logoRotationDirection == 1f)
			{
				logoRotationSpeed += 1f;
			}
			else if (logoRotationSpeed > -20f && logoRotationDirection == -1f)
			{
				logoRotationSpeed -= 1f;
			}
			logoScale += logoScaleSpeed * 9E-05f;
			if (logoScale > 1f)
			{
				logoScaleDirection = -1f;
			}
			else if (logoScale < 0.9f)
			{
				logoScaleDirection = 1f;
			}
			if (logoScaleSpeed < 50f && logoScaleDirection == 1f)
			{
				logoScaleSpeed += 1f;
			}
			else if (logoScaleSpeed > -50f && logoScaleDirection == -1f)
			{
				logoScaleSpeed -= 1f;
			}
		}
		else if (WorldGen.drunkWorldGen && !WorldGen.notTheBees)
		{
			logoRotation += logoRotationSpeed * 4E-06f;
			if (logoRotationSpeed > 0f)
			{
				logoRotationSpeed += 1500f;
			}
			else
			{
				logoRotationSpeed -= 1500f;
			}
			logoScale -= 0.05f;
			if (logoScale < 0f)
			{
				logoScale = 0f;
			}
		}
		else
		{
			if ((double)logoScale < 0.1)
			{
				logoRotation = 0f;
				logoRotationSpeed = 0f;
			}
			if ((double)logoScale < 0.98)
			{
				logoScale *= 1.05f;
			}
			if ((double)logoRotation > 0.09)
			{
				logoRotation += logoRotationSpeed * 0.0016f;
				if (logoRotationSpeed > 0f)
				{
					logoRotationSpeed = 0f;
				}
			}
			logoRotation += logoRotationSpeed * 4E-06f;
			if ((double)logoRotation > 0.08)
			{
				logoRotationDirection = -1f;
			}
			else if ((double)logoRotation < -0.08)
			{
				logoRotationDirection = 1f;
			}
			if (logoRotationSpeed < 20f && logoRotationDirection == 1f)
			{
				logoRotationSpeed += 1f;
			}
			else if (logoRotationSpeed > -20f && logoRotationDirection == -1f)
			{
				logoRotationSpeed -= 1f;
			}
			logoScale += logoScaleSpeed * 9E-06f;
			if ((double)logoScale > 1.35)
			{
				logoScaleDirection = -1f;
			}
			else if (logoScale < 1f)
			{
				logoScaleDirection = 1f;
			}
			if (logoScaleSpeed < 50f && logoScaleDirection == 1f)
			{
				logoScaleSpeed += 1f;
			}
			else if (logoScaleSpeed > -50f && logoScaleDirection == -1f)
			{
				logoScaleSpeed -= 1f;
			}
		}
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color((byte)((float)(int)color.R * ((float)LogoA / 255f)), (byte)((float)(int)color.G * ((float)LogoA / 255f)), (byte)((float)(int)color.B * ((float)LogoA / 255f)), (byte)((float)(int)color.A * ((float)LogoA / 255f)));
		Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color((byte)((float)(int)color.R * ((float)LogoB / 255f)), (byte)((float)(int)color.G * ((float)LogoB / 255f)), (byte)((float)(int)color.B * ((float)LogoB / 255f)), (byte)((float)(int)color.A * ((float)LogoB / 255f)));
		if (noTrapsWorld)
		{
			boulderLogo = true;
		}
		if (playOldTile)
		{
			spriteBatch.Draw(TextureAssets.Logo3.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color2, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.Logo4.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color3, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
		}
		else if (boulderLogo)
		{
			spriteBatch.Draw(TextureAssets.Logo5.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color2, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.Logo6.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color3, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
		}
		else
		{
			spriteBatch.Draw(TextureAssets.Logo.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color2, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.Logo2.Value, new Vector2(screenWidth / 2, 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Logo.Width(), TextureAssets.Logo.Height()), color3, logoRotation, new Vector2(TextureAssets.Logo.Width() / 2, TextureAssets.Logo.Height() / 2), logoScale, SpriteEffects.None, 0f);
		}
		if (dayTime && !WorldGen.remixWorldGen)
		{
			LogoA += 2;
			if (LogoA > 255)
			{
				LogoA = 255;
			}
			LogoB--;
			if (LogoB < 0)
			{
				LogoB = 0;
			}
		}
		else
		{
			LogoB += 2;
			if (LogoB > 255)
			{
				LogoB = 255;
			}
			LogoA--;
			if (LogoA < 0)
			{
				LogoA = 0;
				LogoT = true;
			}
		}
		int num2 = 250;
		int num3 = screenWidth / 2;
		int num4 = 80;
		int num5 = 0;
		int num6 = menuMode;
		int num7 = 0;
		int num8 = 0;
		bool flag = false;
		bool flag2 = false;
		bool flag3 = false;
		int num9 = 0;
		bool[] array = new bool[maxMenuItems];
		bool[] array2 = new bool[maxMenuItems];
		bool[] array3 = new bool[maxMenuItems];
		int[] array4 = new int[maxMenuItems];
		int[] array5 = new int[maxMenuItems];
		byte[] array6 = new byte[maxMenuItems];
		float[] array7 = new float[maxMenuItems];
		bool[] array8 = new bool[maxMenuItems];
		bool flag4 = false;
		bool flag5 = UILinkPointNavigator.Shortcuts.BackButtonInUse && !UILinkPointNavigator.Shortcuts.BackButtonLock;
		for (int i = 0; i < maxMenuItems; i++)
		{
			array[i] = false;
			array2[i] = false;
			array4[i] = 0;
			array5[i] = 0;
			array7[i] = 1f;
		}
		string[] array9 = new string[maxMenuItems];
		if (menuMode == -1)
		{
			menuMode = 0;
		}
		if (Program.LoadedEverything)
		{
			GamepadMainMenuHandler.CanRun = true;
		}
		DrawInterface_13_AchievementCompletePopups();
		if (menuMode == 1212)
		{
			array9[0] = Lang.menu[102].Value;
			num2 = 200;
			num4 = 30;
			num2 = 200;
			array4[0] = -20;
			array[0] = true;
			array9[1] = Language.GetTextValue("Language.English");
			array9[2] = Language.GetTextValue("Language.German");
			array9[3] = Language.GetTextValue("Language.Italian");
			array9[4] = Language.GetTextValue("Language.French");
			array9[5] = Language.GetTextValue("Language.Spanish");
			array9[6] = Language.GetTextValue("Language.Russian");
			array9[7] = Language.GetTextValue("Language.Chinese");
			array9[8] = Language.GetTextValue("Language.Portuguese");
			array9[9] = Language.GetTextValue("Language.Polish");
			array9[10] = Language.GetTextValue("Language.Japanese");
			array9[11] = Language.GetTextValue("Language.Korean");
			array9[12] = Language.GetTextValue("Language.ChineseTraditional");
			num5 = 13;
			for (int j = 0; j < num5; j++)
			{
				array7[j] = 0.65f;
			}
			array7[0] = 1f;
			if (selectedMenu >= 1)
			{
				changeTheTitle = true;
				LanguageManager.Instance.SetLanguage(selectedMenu);
				menuMode = 0;
				SoundEngine.PlaySound(10);
				SaveSettings();
			}
		}
		else if (menuMode == 1213)
		{
			array9[0] = Lang.menu[102].Value;
			array[0] = true;
			array9[1] = Language.GetTextValue("Language.English");
			array9[2] = Language.GetTextValue("Language.German");
			array9[3] = Language.GetTextValue("Language.Italian");
			array9[4] = Language.GetTextValue("Language.French");
			array9[5] = Language.GetTextValue("Language.Spanish");
			array9[6] = Language.GetTextValue("Language.Russian");
			array9[7] = Language.GetTextValue("Language.Chinese");
			array9[8] = Language.GetTextValue("Language.Portuguese");
			array9[9] = Language.GetTextValue("Language.Polish");
			array9[10] = Language.GetTextValue("Language.Japanese");
			array9[11] = Language.GetTextValue("Language.Korean");
			array9[12] = Language.GetTextValue("Language.ChineseTraditional");
			int num10 = 13;
			array9[num10] = Lang.menu[5].Value;
			num5 = 14;
			if (selectedMenu == num10 || flag5)
			{
				flag5 = false;
				menuMode = 11;
				SoundEngine.PlaySound(11);
			}
			else if (selectedMenu >= 1)
			{
				changeTheTitle = true;
				LanguageManager.Instance.SetLanguage(selectedMenu);
				SoundEngine.PlaySound(12);
				SaveSettings();
			}
			num4 = 26;
			num2 = 200;
			array4[0] = -20;
			array4[num10] = 9;
			for (int k = 0; k < num5; k++)
			{
				array7[k] = 0.65f;
			}
			array7[0] = 0.85f;
			array7[num10] = 0.8f;
		}
		else if (netMode == 2)
		{
			bool flag6 = true;
			for (int l = 0; l < 8; l++)
			{
				if (l >= 255)
				{
					continue;
				}
				try
				{
					array9[l] = Netplay.Clients[l].StatusText;
					if (Netplay.Clients[l].IsActive && showSpam)
					{
						ref string reference = ref array9[l];
						reference = reference + " (" + NetMessage.buffer[l].spamCount + ")";
					}
				}
				catch
				{
					array9[l] = "";
				}
				array[l] = true;
				if (array9[l] != "" && array9[l] != null)
				{
					flag6 = false;
				}
			}
			if (flag6)
			{
				array9[0] = Lang.menu[0].Value;
				array9[1] = Lang.menu[1].Value + Netplay.ListenPort + ".";
			}
			num5 = 11;
			array9[9] = statusText;
			array[9] = true;
			num2 = 170;
			num4 = 30;
			array4[10] = 20;
			array4[10] = 40;
			array9[10] = Lang.menu[2].Value;
			if (selectedMenu == 10 || flag5)
			{
				flag5 = false;
				Netplay.Disconnect = true;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 31)
		{
			if (PlayerInput.SettingsForUI.ShowGamepadHints)
			{
				UIVirtualKeyboard uIVirtualKeyboard = new UIVirtualKeyboard(Lang.menu[3].Value, Netplay.ServerPassword, OnSubmitServerPasswordFromRequest, CanceledGivingServerPassword, 0, allowEmpty: true);
				uIVirtualKeyboard.HideContents = HidePassword;
				UserInterface.ActiveInstance.SetState(uIVirtualKeyboard);
				menuMode = 888;
			}
			string serverPassword = Netplay.ServerPassword;
			PlayerInput.WritingText = true;
			instance.HandleIME();
			Netplay.ServerPassword = GetInputText(Netplay.ServerPassword);
			if (serverPassword != Netplay.ServerPassword)
			{
				SoundEngine.PlaySound(12);
			}
			array9[0] = Lang.menu[3].Value;
			textBlinkerCount++;
			if (textBlinkerCount >= 20)
			{
				if (textBlinkerState == 0)
				{
					textBlinkerState = 1;
				}
				else
				{
					textBlinkerState = 0;
				}
				textBlinkerCount = 0;
			}
			array9[1] = Netplay.ServerPassword;
			if (HidePassword)
			{
				array9[1] = "";
				for (int m = 0; m < Netplay.ServerPassword.Length; m++)
				{
					array9[1] += "*";
				}
			}
			if (textBlinkerState == 1)
			{
				array9[1] += "|";
				array5[1] = 1;
			}
			else
			{
				array9[1] += " ";
			}
			array[0] = true;
			array[1] = true;
			array4[1] = -20;
			array4[2] = 20;
			array9[2] = Lang.menu[4].Value;
			array9[3] = Lang.menu[5].Value;
			num5 = 4;
			if (selectedMenu == 3 || flag5)
			{
				flag5 = false;
				CanceledGivingServerPassword();
			}
			else if (selectedMenu == 2 || inputTextEnter)
			{
				OnSubmitServerPasswordFromRequest();
			}
		}
		else if ((netMode == 1 && menuMode != 888) || menuMode == 14)
		{
			num5 = 2;
			array9[0] = statusText;
			array[0] = true;
			num2 = 300;
			int num11 = statusText.Split('\n').Length - 1;
			array7[0] = 1f - (float)num11 * 0.04f;
			array4[0] = num11 * -18;
			array4[1] = num11 * 28;
			array9[1] = Lang.menu[6].Value;
			gameTips.Update();
			gameTips.Draw();
			if (selectedMenu == 1 || flag5)
			{
				flag5 = false;
				Netplay.InvalidateAllOngoingIPSetAttempts();
				Netplay.Disconnect = true;
				Netplay.Connection.Socket.Close();
				SoundEngine.PlaySound(11);
				menuMode = 0;
				netMode = 0;
				if (tServer != null)
				{
					try
					{
						tServer.Kill();
						tServer = null;
					}
					catch
					{
					}
				}
			}
			else if (Netplay.IsHostAndPlay && tServer != null && tServer.HasExited)
			{
				statusText = Language.GetTextValue("Error.ServerStartFailed");
			}
		}
		else if (menuMode == 882)
		{
			num5 = 2;
			array[0] = true;
			num2 = 300;
			array9[0] = statusText;
			array9[1] = Lang.menu[6].Value;
			if (selectedMenu == 1 || flag5)
			{
				flag5 = false;
				SoundEngine.PlaySound(11);
				menuMode = 0;
				netMode = 0;
				if (SocialAPI.Network != null)
				{
					SocialAPI.Network.CancelJoin();
				}
			}
		}
		else if (menuMode == 30)
		{
			if (PlayerInput.SettingsForUI.ShowGamepadHints)
			{
				UIVirtualKeyboard uIVirtualKeyboard2 = new UIVirtualKeyboard(Lang.menu[7].Value, Netplay.ServerPassword, OnSubmitServerPassword, ExitServerPasswordMenu, 0, allowEmpty: true);
				uIVirtualKeyboard2.HideContents = HidePassword;
				UserInterface.ActiveInstance.SetState(uIVirtualKeyboard2);
				menuMode = 888;
			}
			string serverPassword2 = Netplay.ServerPassword;
			PlayerInput.WritingText = true;
			instance.HandleIME();
			Netplay.ServerPassword = GetInputText(Netplay.ServerPassword);
			if (serverPassword2 != Netplay.ServerPassword)
			{
				SoundEngine.PlaySound(12);
			}
			array9[0] = Lang.menu[7].Value;
			textBlinkerCount++;
			if (textBlinkerCount >= 20)
			{
				if (textBlinkerState == 0)
				{
					textBlinkerState = 1;
				}
				else
				{
					textBlinkerState = 0;
				}
				textBlinkerCount = 0;
			}
			array9[1] = Netplay.ServerPassword;
			if (HidePassword)
			{
				array9[1] = "";
				for (int n = 0; n < Netplay.ServerPassword.Length; n++)
				{
					array9[1] += "*";
				}
			}
			if (textBlinkerState == 1)
			{
				array9[1] += "|";
				array5[1] = 1;
			}
			else
			{
				array9[1] += " ";
			}
			array[0] = true;
			array[1] = true;
			array4[1] = -20;
			array4[2] = 20;
			array9[2] = Lang.menu[4].Value;
			array9[3] = Lang.menu[5].Value;
			num5 = 4;
			if (selectedMenu == 3 || flag5)
			{
				flag5 = false;
				ExitServerPasswordMenu();
			}
			else if (selectedMenu == 2 || inputTextEnter || autoPass)
			{
				HostAndPlay();
			}
		}
		else if (menuMode == 889)
		{
			num2 = 200;
			num4 = 60;
			array4[1] = 30;
			array4[2] = 30;
			array4[3] = 30;
			array4[4] = 70;
			array4[5] = 70;
			num5 = 6;
			array9[0] = Lang.menu[135].Value;
			array9[4] = Lang.menu[144].Value;
			array9[5] = Lang.menu[5].Value;
			array[0] = true;
			if ((MenuServerMode & ServerMode.Lobby) == 0)
			{
				MenuServerMode = ServerMode.None;
				array[2] = true;
				array[3] = true;
				array9[1] = Lang.menu[136].Value;
				array9[2] = "";
				array9[3] = "";
			}
			else
			{
				array9[1] = Lang.menu[137].Value;
				if ((MenuServerMode & ServerMode.FriendsCanJoin) != ServerMode.None)
				{
					array9[2] = Lang.menu[139].Value;
					if ((MenuServerMode & ServerMode.FriendsOfFriends) != ServerMode.None)
					{
						array9[3] = Lang.menu[143].Value;
					}
					else
					{
						array9[3] = Lang.menu[142].Value;
					}
				}
				else
				{
					array9[2] = Lang.menu[138].Value;
					if ((MenuServerMode & ServerMode.FriendsOfFriends) != ServerMode.None)
					{
						array9[3] = Lang.menu[141].Value;
					}
					else
					{
						array9[3] = Lang.menu[140].Value;
					}
				}
			}
			if (flag5)
			{
				flag5 = false;
				selectedMenu = 5;
			}
			switch (selectedMenu)
			{
			case 1:
				MenuServerMode ^= ServerMode.Lobby;
				SoundEngine.PlaySound(12);
				break;
			case 2:
				MenuServerMode ^= ServerMode.FriendsCanJoin;
				SoundEngine.PlaySound(12);
				break;
			case 3:
				MenuServerMode ^= ServerMode.FriendsOfFriends;
				SoundEngine.PlaySound(12);
				break;
			case 4:
				clrInput();
				Netplay.ServerPassword = "";
				GetInputText("");
				autoPass = false;
				menuMode = 30;
				SoundEngine.PlaySound(10);
				break;
			case 5:
				menuMode = 6;
				SoundEngine.PlaySound(11);
				break;
			}
		}
		else if (menuMode == 15)
		{
			num5 = 2;
			array9[0] = statusText;
			array[0] = true;
			num2 = 80;
			num4 = 400;
			array9[1] = Lang.menu[5].Value;
			if (selectedMenu == 1 || flag5)
			{
				flag5 = false;
				Netplay.Disconnect = true;
				SoundEngine.PlaySound(11);
				menuMode = 0;
				netMode = 0;
			}
		}
		else if (menuMode == 200)
		{
			num5 = 3;
			array9[0] = Lang.menu[9].Value;
			array[0] = true;
			num2 -= 30;
			array4[1] = 70;
			array4[2] = 50;
			array9[1] = Lang.menu[10].Value;
			array9[2] = Lang.menu[6].Value;
			if (selectedMenu == 1)
			{
				if (FileUtilities.Exists(worldPathName + ".bak", ActiveWorldFileData.IsCloudSave))
				{
					FileUtilities.Move(worldPathName, worldPathName + ".bad", ActiveWorldFileData.IsCloudSave);
					FileUtilities.Move(worldPathName + ".bak", worldPathName, ActiveWorldFileData.IsCloudSave);
					SoundEngine.PlaySound(10);
					WorldGen.playWorld();
					menuMode = 10;
				}
				else
				{
					SoundEngine.PlaySound(11);
					menuMode = 0;
					netMode = 0;
				}
			}
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				SoundEngine.PlaySound(11);
				menuMode = 0;
				netMode = 0;
			}
		}
		else if (menuMode == 201)
		{
			num5 = 3;
			array9[0] = Lang.menu[9].Value;
			array[0] = true;
			array[1] = true;
			num2 -= 30;
			array4[1] = -30;
			array4[2] = 50;
			array9[1] = Lang.menu[11].Value;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				SoundEngine.PlaySound(11);
				menuMode = 0;
				netMode = 0;
			}
		}
		else if (menuMode == 10)
		{
			num5 = 1;
			array9[0] = statusText;
			array[0] = true;
			num2 = 300;
			gameTips.Update();
			gameTips.Draw();
		}
		else if (menuMode == 100)
		{
			num5 = 1;
			array9[0] = statusText;
			array[0] = true;
			num2 = 300;
		}
		else if (menuMode == 0)
		{
			_blockFancyUIWhileLoading = false;
			_pendingCharacterSelect = null;
			DD2Event.Ongoing = false;
			eclipse = false;
			pumpkinMoon = false;
			snowMoon = false;
			ServerSideCharacter = false;
			menuMultiplayer = false;
			menuServer = false;
			netMode = 0;
			ClearVisualPostProcessEffects();
			int num12 = 0;
			num2 = 220;
			num5 = 7;
			num4 = 52;
			array9[num12] = Lang.menu[12].Value;
			if (selectedMenu == num12)
			{
				SoundEngine.PlaySound(10);
				ClearPendingPlayerSelectCallbacks();
				menuMode = 1;
			}
			num12++;
			array9[num12] = Lang.menu[13].Value;
			if (selectedMenu == num12)
			{
				SoundEngine.PlaySound(10);
				menuMode = 12;
			}
			num12++;
			array9[num12] = Lang.menu[131].Value;
			if (selectedMenu == num12)
			{
				SoundEngine.PlaySound(10);
				menuMode = 888;
				MenuUI.SetState(AchievementsMenu);
			}
			num12++;
			if (SocialAPI.Workshop != null)
			{
				array9[num12] = Language.GetText("UI.Workshop").Value;
				if (selectedMenu == num12)
				{
					SoundEngine.PlaySound(10);
					menuMode = 888;
					UIWorkshopHub uIWorkshopHub = new UIWorkshopHub(null);
					uIWorkshopHub.EnterHub();
					MenuUI.SetState(uIWorkshopHub);
				}
			}
			else
			{
				array9[num12] = Language.GetText("UI.ResourcePacks").Value;
				if (selectedMenu == num12)
				{
					SoundEngine.PlaySound(10);
					OpenResourcePacksMenu(null);
				}
			}
			num12++;
			array9[num12] = Lang.menu[14].Value;
			if (selectedMenu == num12)
			{
				SoundEngine.PlaySound(10);
				menuMode = 11;
			}
			num12++;
			array9[num12] = Language.GetText("UI.Credits").Value;
			if (selectedMenu == num12)
			{
				SoundEngine.PlaySound(10);
				menuMode = 3000;
				SkyManager.Instance.Activate("CreditsRoll", default(Vector2));
			}
			num12++;
			array9[num12] = Lang.menu[15].Value;
			if (selectedMenu == num12)
			{
				GameAskedToQuit = true;
			}
			num12++;
		}
		else if (menuMode == 1)
		{
			OpenCharacterSelectUI();
		}
		else if (menuMode == 2)
		{
			flag4 = true;
			if (selectedMenu == 0)
			{
				menuMode = 17;
				SoundEngine.PlaySound(10);
				selColor = PendingPlayer.hairColor;
			}
			if (selectedMenu == 1)
			{
				menuMode = 18;
				SoundEngine.PlaySound(10);
				selColor = PendingPlayer.eyeColor;
			}
			if (selectedMenu == 2)
			{
				menuMode = 19;
				SoundEngine.PlaySound(10);
				selColor = PendingPlayer.skinColor;
			}
			if (selectedMenu == 3)
			{
				menuMode = 20;
				SoundEngine.PlaySound(10);
			}
			array9[0] = Lang.menu[18].Value;
			array9[1] = Lang.menu[19].Value;
			array9[2] = Lang.menu[20].Value;
			array9[3] = Lang.menu[21].Value;
			num2 = 220;
			for (int num13 = 0; num13 < 9; num13++)
			{
				if (num13 < 6)
				{
					array7[num13] = 0.75f;
				}
				else
				{
					array7[num13] = 0.9f;
				}
			}
			num4 = 38;
			array4[6] = 6;
			array4[7] = 12;
			array4[8] = 18;
			num7 = screenWidth / 2 - 16;
			num8 = 176;
			if (PendingPlayer.Male)
			{
				array9[4] = Lang.menu[22].Value;
			}
			else
			{
				array9[4] = Lang.menu[23].Value;
			}
			if (selectedMenu == 4)
			{
				if (PendingPlayer.Male)
				{
					SoundEngine.PlaySound(20);
					PendingPlayer.Male = false;
				}
				else
				{
					SoundEngine.PlaySound(1);
					PendingPlayer.Male = true;
				}
			}
			if (PendingPlayer.difficulty == 2)
			{
				array9[5] = Lang.menu[24].Value;
				array6[5] = PendingPlayer.difficulty;
			}
			else if (PendingPlayer.difficulty == 1)
			{
				array9[5] = Lang.menu[25].Value;
				array6[5] = PendingPlayer.difficulty;
			}
			else
			{
				array9[5] = Lang.menu[26].Value;
			}
			if (selectedMenu == 5)
			{
				SoundEngine.PlaySound(10);
				menuMode = 222;
			}
			if (selectedMenu == 7)
			{
				SoundEngine.PlaySound(12);
				PendingPlayer.hair = rand.Next(51);
				PendingPlayer.eyeColor = randColor();
				while (PendingPlayer.eyeColor.R + PendingPlayer.eyeColor.G + PendingPlayer.eyeColor.B > 300)
				{
					PendingPlayer.eyeColor = randColor();
				}
				PendingPlayer.hairColor = randColor();
				PendingPlayer.pantsColor = randColor();
				PendingPlayer.shirtColor = randColor();
				PendingPlayer.shoeColor = randColor();
				PendingPlayer.skinColor = randColor();
				float num14 = (float)rand.Next(60, 120) * 0.01f;
				if (num14 > 1f)
				{
					num14 = 1f;
				}
				PendingPlayer.skinColor.R = (byte)((float)rand.Next(240, 255) * num14);
				PendingPlayer.skinColor.G = (byte)((float)rand.Next(110, 140) * num14);
				PendingPlayer.skinColor.B = (byte)((float)rand.Next(75, 110) * num14);
				PendingPlayer.underShirtColor = randColor();
				int num15 = PendingPlayer.hair + 1;
				if (num15 == 5 || num15 == 6 || num15 == 7 || num15 == 10 || num15 == 12 || num15 == 19 || num15 == 22 || num15 == 23 || num15 == 26 || num15 == 27 || num15 == 30 || num15 == 33)
				{
					PendingPlayer.Male = false;
				}
				else
				{
					PendingPlayer.Male = true;
				}
				PendingPlayer.skinVariant = rand.Next(PlayerVariantID.Count);
			}
			array9[7] = Lang.menu[27].Value;
			array9[6] = Lang.menu[28].Value;
			array9[8] = Lang.menu[5].Value;
			num5 = 9;
			if (selectedMenu == 8 || flag5)
			{
				flag5 = false;
				SoundEngine.PlaySound(11);
				menuMode = 1;
			}
			else if (selectedMenu == 6)
			{
				SoundEngine.PlaySound(10);
				PendingPlayer.name = "";
				menuMode = 3;
				clrInput();
			}
		}
		else if (menuMode == 222)
		{
			if (focusMenu == 3)
			{
				array9[0] = Lang.menu[29].Value;
			}
			else if (focusMenu == 2)
			{
				array9[0] = Lang.menu[30].Value;
			}
			else if (focusMenu == 1)
			{
				array9[0] = Lang.menu[31].Value;
			}
			else
			{
				array9[0] = Lang.menu[32].Value;
			}
			num4 = 50;
			array4[1] = 25;
			array4[2] = 25;
			array4[3] = 25;
			array[0] = true;
			array9[1] = Lang.menu[26].Value;
			array9[2] = Lang.menu[25].Value;
			array6[2] = 1;
			array9[3] = Lang.menu[24].Value;
			array6[3] = 2;
			num5 = 4;
			if (selectedMenu == 1)
			{
				PendingPlayer.difficulty = 0;
				menuMode = 2;
			}
			else if (selectedMenu == 2)
			{
				menuMode = 2;
				PendingPlayer.difficulty = 1;
			}
			else if (selectedMenu == 3)
			{
				PendingPlayer.difficulty = 2;
				menuMode = 2;
			}
		}
		else if (menuMode == 20)
		{
			flag4 = true;
			if (selectedMenu == 0)
			{
				menuMode = 21;
				SoundEngine.PlaySound(10);
				selColor = PendingPlayer.shirtColor;
			}
			if (selectedMenu == 1)
			{
				menuMode = 22;
				SoundEngine.PlaySound(10);
				selColor = PendingPlayer.underShirtColor;
			}
			if (selectedMenu == 2)
			{
				menuMode = 23;
				SoundEngine.PlaySound(10);
				selColor = PendingPlayer.pantsColor;
			}
			if (selectedMenu == 3)
			{
				selColor = PendingPlayer.shoeColor;
				menuMode = 24;
				SoundEngine.PlaySound(10);
			}
			if (selectedMenu == 5 || flag5)
			{
				flag5 = false;
				SoundEngine.PlaySound(11);
				menuMode = 2;
			}
			if (selectedMenu == 4)
			{
				SoundEngine.PlaySound(12);
				CycleClothingStyle(PendingPlayer);
			}
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			num2 = 260;
			num4 = 50;
			num5 = 6;
			array9[0] = Lang.menu[33].Value;
			array9[1] = Lang.menu[34].Value;
			array9[2] = Lang.menu[35].Value;
			array9[3] = Lang.menu[36].Value;
			array9[4] = Lang.menu[127].Value;
			array9[5] = Lang.menu[5].Value;
			array4[5] = 20;
		}
		else if (menuMode == 17)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 390;
			num2 = 260;
			num4 = 60;
			PendingPlayer.hairColor = selColor;
			num5 = 3;
			array9[0] = Lang.menu[37].Value + " " + (PendingPlayer.hair + 1);
			array9[1] = Lang.menu[38].Value;
			array[1] = true;
			array4[2] = 150;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			int num16 = 51;
			if (focusMenu == 0)
			{
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 9;
			}
			if (selectedMenu == 0)
			{
				SoundEngine.PlaySound(12);
				PendingPlayer.hair++;
				if (PendingPlayer.hair >= num16)
				{
					PendingPlayer.hair = 0;
				}
			}
			else if (selectedMenu2 == 0)
			{
				SoundEngine.PlaySound(12);
				PendingPlayer.hair--;
				if (PendingPlayer.hair < 0)
				{
					PendingPlayer.hair = num16 - 1;
				}
			}
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 2;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 18)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 370;
			num2 = 240;
			num4 = 60;
			PendingPlayer.eyeColor = selColor;
			num5 = 3;
			array9[0] = "";
			array9[1] = Lang.menu[39].Value;
			array[1] = true;
			array4[2] = 170;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 2;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 19)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 370;
			num2 = 240;
			num4 = 60;
			PendingPlayer.skinColor = selColor;
			num5 = 3;
			array9[0] = "";
			array9[1] = Lang.menu[40].Value;
			array[1] = true;
			array4[2] = 170;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 2;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 21)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 370;
			num2 = 240;
			num4 = 60;
			PendingPlayer.shirtColor = selColor;
			num5 = 3;
			array9[0] = "";
			array9[1] = Lang.menu[41].Value;
			array[1] = true;
			array4[2] = 170;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 20;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 22)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 370;
			num2 = 240;
			num4 = 60;
			PendingPlayer.underShirtColor = selColor;
			num5 = 3;
			array9[0] = "";
			array9[1] = Lang.menu[42].Value;
			array[1] = true;
			array4[2] = 170;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 20;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 23)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 370;
			num2 = 240;
			num4 = 60;
			PendingPlayer.pantsColor = selColor;
			num5 = 3;
			array9[0] = "";
			array9[1] = Lang.menu[43].Value;
			array[1] = true;
			array4[2] = 170;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 20;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 24)
		{
			flag4 = true;
			num7 = screenWidth / 2 - 16;
			num8 = 210;
			flag = true;
			num9 = 370;
			num2 = 240;
			num4 = 60;
			PendingPlayer.shoeColor = selColor;
			num5 = 3;
			array9[0] = "";
			array9[1] = Lang.menu[44].Value;
			array[1] = true;
			array4[2] = 170;
			array4[1] = 10;
			array9[2] = Lang.menu[5].Value;
			if (selectedMenu == 2 || flag5)
			{
				flag5 = false;
				menuMode = 20;
				SoundEngine.PlaySound(11);
			}
		}
		else if (menuMode == 3)
		{
			UIVirtualKeyboard state = new UIVirtualKeyboard(Lang.menu[45].Value, "", OnCharacterNamed, CreateGoToMenuEvent(2));
			menuMode = 888;
			MenuUI.SetState(state);
		}
		else if (menuMode != 4)
		{
			if (menuMode == 5)
			{
				array9[0] = Lang.menu[46].Value + " " + PlayerList[selectedPlayer].Player.name + "?";
				array[0] = true;
				array9[1] = Lang.menu[104].Value;
				array9[2] = Lang.menu[105].Value;
				num5 = 3;
				if (selectedMenu == 1)
				{
					ErasePlayer(selectedPlayer);
					SoundEngine.PlaySound(10);
					menuMode = 1;
				}
				else if (selectedMenu == 2 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 1;
				}
			}
			else if (menuMode == 40)
			{
				if (string.IsNullOrEmpty(PendingPlayer.name))
				{
					array9[0] = Language.GetTextValue("UI.PlayerCreateDiscardWarningNoName");
				}
				else
				{
					array9[0] = Language.GetTextValue("UI.PlayerCreateDiscardWarningWithName", PendingPlayer.name);
				}
				array[0] = true;
				array9[1] = Language.GetTextValue("UI.PlayerCreateDiscardWarningYes");
				array9[2] = Language.GetTextValue("UI.PlayerCreateDiscardWarningNo");
				num5 = 3;
				if (selectedMenu == 1)
				{
					UICharacterCreation.BackupConfirmationState = null;
					SoundEngine.PlaySound(10);
					OpenCharacterSelectUI();
				}
				else if (selectedMenu == 2 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 888;
					MenuUI.SetState(UICharacterCreation.BackupConfirmationState);
				}
			}
			else if (menuMode == 6)
			{
				menuMode = 888;
				MenuUI.SetState(_worldSelectMenu);
			}
			else if (menuMode == -7)
			{
				num2 = 200;
				num4 = 60;
				array4[2] = 30;
				array4[3] = 30;
				array4[4] = 30;
				array6[3] = 1;
				array6[4] = 2;
				array4[5] = 70;
				if (focusMenu == 2)
				{
					array9[1] = Language.GetTextValue("UI.WorldDescriptionNormal");
				}
				else if (focusMenu == 3)
				{
					array9[1] = Language.GetTextValue("UI.WorldDescriptionExpert");
				}
				else if (focusMenu == 4)
				{
					array9[1] = Language.GetTextValue("UI.WorldDescriptionMaster");
				}
				array9[0] = Lang.menu[32].Value;
				array[0] = true;
				array[1] = true;
				array9[2] = Language.GetTextValue("UI.Normal");
				array9[3] = Language.GetTextValue("UI.Expert");
				array9[4] = Language.GetTextValue("UI.Master");
				array9[5] = Language.GetTextValue("UI.Back");
				num5 = 6;
				if (selectedMenu == 2)
				{
					GameMode = 0;
					SoundEngine.PlaySound(10);
					menuMode = 7;
					if (SettingsUnlock_WorldEvil)
					{
						menuMode = -71;
					}
				}
				else if (selectedMenu == 3)
				{
					GameMode = 1;
					SoundEngine.PlaySound(10);
					menuMode = 7;
					if (SettingsUnlock_WorldEvil)
					{
						menuMode = -71;
					}
				}
				else if (selectedMenu == 4)
				{
					GameMode = 2;
					SoundEngine.PlaySound(10);
					menuMode = 7;
					if (SettingsUnlock_WorldEvil)
					{
						menuMode = -71;
					}
				}
				else if (selectedMenu == 5 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 16;
				}
				clrInput();
			}
			else if (menuMode == -71)
			{
				num2 = 200;
				num4 = 60;
				array4[1] = 30;
				array4[2] = 30;
				array4[3] = 30;
				array4[4] = 70;
				num5 = 5;
				int num17 = 0;
				array9[num17] = Lang.misc[100].Value;
				array[num17] = true;
				num17++;
				array9[num17] = Lang.misc[101].Value;
				if (selectedMenu == num17)
				{
					WorldGen.WorldGenParam_Evil = 0;
					SoundEngine.PlaySound(10);
					menuMode = 7;
				}
				num17++;
				array9[num17] = Lang.misc[102].Value;
				if (selectedMenu == num17)
				{
					WorldGen.WorldGenParam_Evil = 1;
					SoundEngine.PlaySound(10);
					menuMode = 7;
				}
				num17++;
				array9[num17] = Lang.misc[103].Value;
				if (selectedMenu == num17)
				{
					WorldGen.WorldGenParam_Evil = -1;
					SoundEngine.PlaySound(10);
					menuMode = 7;
				}
				num17++;
				array9[num17] = Language.GetTextValue("UI.Back");
				if (selectedMenu == num17 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = -7;
				}
				num17++;
				clrInput();
			}
			else if (menuMode == 7)
			{
				menuMode = 888;
				MenuUI.SetState(new UIVirtualKeyboard(Lang.menu[48].Value, "", OnWorldNamed, CreateGoToMenuEvent(-7)));
			}
			else if (menuMode == 5000)
			{
				menuMode = 888;
				MenuUI.SetState(new UIVirtualKeyboard(Language.GetTextValue("UI.EnterSeed"), "", OnSeedSelected, CreateGoToMenuEvent(7), 0, allowEmpty: true));
			}
			else if (menuMode == 8)
			{
				num2 = 180;
				num4 = 40;
				num5 = 8;
				array4[7] += 30;
				for (int num18 = 0; num18 < num5; num18++)
				{
					array7[num18] = 0.8f;
				}
				array9[7] = Lang.menu[5].Value;
				for (int num19 = 0; num19 < 7; num19++)
				{
					if (num19 < WorldList.Count)
					{
						array9[num19] = WorldList[num19 + menuSkip].Name;
						if (WorldList[num19 + menuSkip].GameMode == 1)
						{
							array6[num19] = 1;
						}
						else if (WorldList[num19 + menuSkip].GameMode == 2)
						{
							array6[num19] = 2;
						}
					}
					else
					{
						array9[num19] = null;
					}
				}
				if (WorldList.Count > 7 + menuSkip)
				{
					array9[6] = Language.GetTextValue("UI.More");
					array9[6] = "â¼";
					array7[6] = 0.6f;
					array4[6] += 8;
					menuWide[6] = true;
				}
				if (menuSkip > 0)
				{
					array9[0] = "â²";
					array7[0] = 0.6f;
					array4[0] += 8;
					menuWide[0] = true;
				}
				if (selectedMenu == 0 && menuSkip > 0)
				{
					SoundEngine.PlaySound(12);
					menuSkip -= 5;
					if (menuSkip < 0)
					{
						menuSkip = 0;
					}
				}
				else if (selectedMenu == 6 && menuSkip < WorldList.Count - 7)
				{
					SoundEngine.PlaySound(12);
					menuSkip += 5;
					if (menuSkip >= PlayerList.Count - 7)
					{
						menuSkip = WorldList.Count - 7;
					}
				}
				else if (selectedMenu == 7 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 6;
				}
				else if (selectedMenu >= 0)
				{
					selectedWorld = selectedMenu + menuSkip;
					SoundEngine.PlaySound(10);
					menuMode = 9;
				}
			}
			else if (menuMode == 9)
			{
				array9[0] = Lang.menu[46].Value + " " + WorldList[selectedWorld].Name + "?";
				array[0] = true;
				array9[1] = Lang.menu[104].Value;
				array9[2] = Lang.menu[105].Value;
				num5 = 3;
				if (selectedMenu == 1)
				{
					EraseWorld(selectedWorld);
					SoundEngine.PlaySound(10);
					menuMode = 6;
				}
				else if (selectedMenu == 2 || flag5)
				{
					SoundEngine.PlaySound(11);
					menuMode = 6;
				}
			}
			else if (menuMode == 3000)
			{
				num5 = 1;
				num2 = 500;
				array7[0] = 0.9f;
				array9[0] = Lang.menu[5].Value;
				if (selectedMenu == 0 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 0;
				}
			}
			else if (menuMode == 11)
			{
				num2 = 210;
				num4 = 37;
				num5 = 8;
				array4[num5 - 1] = 8;
				for (int num20 = 0; num20 < num5; num20++)
				{
					array7[num20] = 0.75f;
				}
				int num21 = 0;
				array9[num21] = Lang.menu[114].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(10);
					menuMode = 112;
				}
				num21++;
				array9[num21] = Lang.menu[210].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(10);
					menuMode = 1112;
				}
				num21++;
				array9[num21] = Lang.menu[63].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(10);
					menuMode = 1111;
				}
				num21++;
				array9[num21] = Lang.menu[65].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(11);
					menuMode = 26;
				}
				num21++;
				array9[num21] = Lang.menu[218].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(10);
					menuMode = 1125;
				}
				num21++;
				array9[num21] = Lang.menu[219].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(10);
					menuMode = 1127;
				}
				num21++;
				array9[num21] = Lang.menu[103].Value;
				if (selectedMenu == num21)
				{
					SoundEngine.PlaySound(10);
					menuMode = 1213;
				}
				num21++;
				array9[num21] = Lang.menu[5].Value;
				if (selectedMenu == num21 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 0;
					SaveSettings();
				}
			}
			else if (menuMode == 112)
			{
				num2 = 250;
				num4 = 52;
				num5 = 5;
				array4[num5 - 1] = 18;
				for (int num22 = 0; num22 < num5; num22++)
				{
					array7[num22] = 0.78f;
				}
				int num23 = 0;
				if (autoSave)
				{
					array9[num23] = Lang.menu[67].Value;
				}
				else
				{
					array9[num23] = Lang.menu[68].Value;
				}
				if (selectedMenu == num23)
				{
					SoundEngine.PlaySound(12);
					if (autoSave)
					{
						autoSave = false;
					}
					else
					{
						autoSave = true;
					}
				}
				num23++;
				if (autoPause)
				{
					array9[num23] = Lang.menu[69].Value;
				}
				else
				{
					array9[num23] = Lang.menu[70].Value;
				}
				if (selectedMenu == num23)
				{
					SoundEngine.PlaySound(12);
					if (autoPause)
					{
						autoPause = false;
					}
					else
					{
						autoPause = true;
					}
				}
				num23++;
				if (mapEnabled)
				{
					array9[num23] = Lang.menu[112].Value;
				}
				else
				{
					array9[num23] = Lang.menu[113].Value;
				}
				if (selectedMenu == num23)
				{
					SoundEngine.PlaySound(12);
					if (mapEnabled)
					{
						mapEnabled = false;
					}
					else
					{
						mapEnabled = true;
					}
				}
				num23++;
				array9[num23] = (HidePassword ? Lang.menu[212].Value : Lang.menu[211].Value);
				if (selectedMenu == num23)
				{
					SoundEngine.PlaySound(12);
					HidePassword = !HidePassword;
				}
				num23++;
				array9[num23] = Lang.menu[5].Value;
				if (selectedMenu == num23 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 1112)
			{
				num2 = 210;
				num4 = 28;
				num5 = 12;
				array4[num5 - 1] = 16;
				for (int num24 = 0; num24 < num5; num24++)
				{
					array7[num24] = 0.6f;
				}
				int num25 = 0;
				if (showItemText)
				{
					array9[num25] = Lang.menu[71].Value;
				}
				else
				{
					array9[num25] = Lang.menu[72].Value;
				}
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					if (showItemText)
					{
						showItemText = false;
					}
					else
					{
						showItemText = true;
					}
				}
				num25++;
				array9[num25] = Lang.menu[123].Value + " " + Lang.menu[124 + invasionProgressMode].Value;
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					invasionProgressMode++;
					if (invasionProgressMode >= 3)
					{
						invasionProgressMode = 0;
					}
				}
				num25++;
				array9[num25] = (placementPreview ? Lang.menu[128].Value : Lang.menu[129].Value);
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					placementPreview = !placementPreview;
				}
				num25++;
				array9[num25] = (ItemSlot.Options.HighlightNewItems ? Lang.inter[117].Value : Lang.inter[116].Value);
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					ItemSlot.Options.HighlightNewItems = !ItemSlot.Options.HighlightNewItems;
				}
				num25++;
				array9[num25] = (MouseShowBuildingGrid ? Lang.menu[229].Value : Lang.menu[230].Value);
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					MouseShowBuildingGrid = !MouseShowBuildingGrid;
				}
				num25++;
				array9[num25] = (GamepadDisableInstructionsDisplay ? Lang.menu[241].Value : Lang.menu[242].Value);
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					GamepadDisableInstructionsDisplay = !GamepadDisableInstructionsDisplay;
				}
				num25++;
				string textValue = Language.GetTextValue("UI.MinimapFrame_" + MinimapFrameManagerInstance.ActiveSelectionKeyName);
				array9[num25] = Language.GetTextValue("UI.SelectMapBorder", textValue);
				if (selectedMenu == num25)
				{
					MinimapFrameManagerInstance.CycleSelection();
				}
				num25++;
				string activeSetKeyName = ResourceSetsManager.ActiveSetKeyName;
				string textValue2 = Language.GetTextValue("UI.HealthManaStyle_" + activeSetKeyName);
				array9[num25] = Language.GetTextValue("UI.SelectHealthStyle", textValue2);
				if (selectedMenu == num25)
				{
					ResourceSetsManager.CycleResourceSet();
				}
				num25++;
				array9[num25] = Language.GetTextValue(DialoguePortraitPreference switch
				{
					DialoguePortraitDrawOption.CloseUp => Language.GetTextValue("UI.PortraitsCloseUp"), 
					DialoguePortraitDrawOption.FullBodyRetro => Language.GetTextValue("UI.PortraitsFullBody"), 
					DialoguePortraitDrawOption.Disabled => Language.GetTextValue("UI.PortraitsDisabled"), 
					_ => Language.GetTextValue("UI.PortraitsDetailed"), 
				});
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					CycleNPCPortraitMode();
				}
				num25++;
				array9[num25] = Language.GetTextValue(BigProgressBarSystem.ShowText ? "UI.ShowBossLifeTextOn" : "UI.ShowBossLifeTextOff");
				if (selectedMenu == num25)
				{
					BigProgressBarSystem.ToggleShowText();
				}
				num25++;
				array9[num25] = (FlashyEffectsInterface ? Language.GetTextValue("UI.FlashyEffectsInterfaceOn") : Language.GetTextValue("UI.FlashyEffectsInterfaceOff"));
				if (selectedMenu == num25)
				{
					SoundEngine.PlaySound(12);
					FlashyEffectsInterface = !FlashyEffectsInterface;
				}
				num25++;
				array9[num25] = Lang.menu[5].Value;
				if (selectedMenu == num25 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 1111)
			{
				bgScroll = (int)Math.Round((1f - caveParallax) * 500f);
				int num26 = 0;
				array9[num26] = Lang.menu[51].Value;
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(10);
					menuMode = 111;
				}
				num26++;
				array9[num26] = Lang.menu[52].Value;
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(11);
					menuMode = 28;
				}
				num26++;
				array9[num26] = Lang.menu[(int)(247 + FrameSkipMode)].Value;
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					CycleFrameSkipMode();
				}
				num26++;
				array9[num26] = Language.GetTextValue("UI.LightMode_" + Lighting.Mode);
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					Lighting.NextLightMode();
				}
				num26++;
				switch (qaStyle)
				{
				case 0:
					array9[num26] = Lang.menu[59].Value;
					break;
				case 1:
					array9[num26] = Lang.menu[60].Value;
					break;
				case 2:
					array9[num26] = Lang.menu[61].Value;
					break;
				default:
					array9[num26] = Lang.menu[62].Value;
					break;
				}
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					if (++qaStyle > 3)
					{
						qaStyle = 0;
					}
				}
				num26++;
				array9[num26] = (BackgroundEnabled ? Lang.menu[100].Value : Lang.menu[101].Value);
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					BackgroundEnabled = !BackgroundEnabled;
				}
				num26++;
				array9[num26] = (ChildSafety.Disabled ? Lang.menu[132].Value : Lang.menu[133].Value);
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					ChildSafety.Disabled = !ChildSafety.Disabled;
				}
				num26++;
				array9[num26] = (SettingsEnabled_MinersWobble ? Lang.menu[250].Value : Lang.menu[251].Value);
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					SettingsEnabled_MinersWobble = !SettingsEnabled_MinersWobble;
				}
				num26++;
				array9[num26] = (SettingsEnabled_TilesSwayInWind ? Language.GetTextValue("UI.TilesSwayInWindOn") : Language.GetTextValue("UI.TilesSwayInWindOff"));
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(12);
					SettingsEnabled_TilesSwayInWind = !SettingsEnabled_TilesSwayInWind;
				}
				num26++;
				array9[num26] = Language.GetTextValue("UI.Effects");
				if (selectedMenu == num26)
				{
					SoundEngine.PlaySound(11);
					menuMode = 2008;
				}
				num26++;
				int num27 = num26;
				int num28 = num27;
				array9[num28] = Lang.menu[5].Value;
				array4[num28] = 8;
				if (selectedMenu == num28 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					SaveSettings();
					menuMode = 11;
				}
				num2 = 186;
				num4 = 30;
				num5 = num28 + 1;
				for (int num29 = 0; num29 < num27; num29++)
				{
					array7[num29] = 0.6f;
				}
			}
			else if (menuMode == 2008)
			{
				num2 = 210;
				num4 = 28;
				num5 = 9;
				array4[num5 - 1] = 24;
				for (int num30 = 0; num30 < num5; num30++)
				{
					array7[num30] = 0.6f;
				}
				int num31 = 0;
				array9[num31] = Language.GetTextValue("UI.Effects");
				array[num31] = true;
				array7[num31] = 0.7f;
				array4[num31] -= 8;
				num31++;
				array9[num31] = Language.GetTextValue("GameUI.StormEffects", UseStormEffects ? Language.GetTextValue("GameUI.Enabled") : Language.GetTextValue("GameUI.Disabled"));
				if (selectedMenu == num31)
				{
					SoundEngine.PlaySound(12);
					UseStormEffects = !UseStormEffects;
				}
				num31++;
				array9[num31] = Language.GetTextValue("GameUI.ForegroundSunlightEffects", ForegroundSunlightEffects ? Language.GetTextValue("GameUI.Enabled") : Language.GetTextValue("GameUI.Disabled"));
				if (selectedMenu == num31)
				{
					SoundEngine.PlaySound(12);
					ForegroundSunlightEffects = !ForegroundSunlightEffects;
				}
				num31++;
				array9[num31] = Language.GetTextValue("GameUI.HeatDistortion", UseHeatDistortion ? Language.GetTextValue("GameUI.Enabled") : Language.GetTextValue("GameUI.Disabled"));
				if (selectedMenu == num31)
				{
					SoundEngine.PlaySound(12);
					UseHeatDistortion = !UseHeatDistortion;
				}
				num31++;
				array9[num31] = Language.GetTextValue("GameUI.WaveQuality", WaveQuality switch
				{
					1 => Language.GetTextValue("GameUI.QualityLow"), 
					2 => Language.GetTextValue("GameUI.QualityMedium"), 
					3 => Language.GetTextValue("GameUI.QualityHigh"), 
					_ => Language.GetTextValue("GameUI.QualityOff"), 
				});
				if (selectedMenu == num31)
				{
					SoundEngine.PlaySound(12);
					WaveQuality = (WaveQuality + 1) % 4;
				}
				num31++;
				array9[num31] = Language.GetTextValue("GameUI.ScreenShake", UseScreenShake ? Language.GetTextValue("GameUI.Enabled") : Language.GetTextValue("GameUI.Disabled"));
				if (selectedMenu == num31)
				{
					SoundEngine.PlaySound(12);
					UseScreenShake = !UseScreenShake;
				}
				num31++;
				array9[num31] = (FlashyEffectsWorld ? Language.GetTextValue("UI.FlashyEffectsWorldOn") : Language.GetTextValue("UI.FlashyEffectsWorldOff"));
				if (selectedMenu == num31)
				{
					SoundEngine.PlaySound(12);
					FlashyEffectsWorld = !FlashyEffectsWorld;
				}
				num31++;
				array9[num31] = Lang.menu[5].Value;
				if (selectedMenu == num31 || flag5)
				{
					SoundEngine.PlaySound(11);
					flag5 = false;
					menuMode = 1111;
				}
			}
			else if (menuMode == 111)
			{
				for (int num32 = 0; num32 < 9; num32++)
				{
					array7[num32] = 0.85f;
				}
				num2 = 210;
				num4 = 55;
				int num33 = 0;
				array9[num33] = Lang.menu[73].Value + ": " + PendingResolutionWidth + "x" + PendingResolutionHeight;
				if (selectedMenu == num33)
				{
					SoundEngine.PlaySound(12);
					int num34 = 0;
					for (int num35 = 0; num35 < numDisplayModes; num35++)
					{
						if (displayWidth[num35] == PendingResolutionWidth && displayHeight[num35] == PendingResolutionHeight)
						{
							num34 = num35;
							break;
						}
					}
					num34 = (num34 + 1) % numDisplayModes;
					PendingResolutionWidth = displayWidth[num34];
					PendingResolutionHeight = displayHeight[num34];
				}
				num33++;
				if (IsBorderlessDisplayAvailable())
				{
					array9[num33] = Lang.menu[PendingBorderlessState ? 245 : 246].Value;
					if (selectedMenu == num33)
					{
						SoundEngine.PlaySound(12);
						PendingBorderlessState = !PendingBorderlessState;
					}
					num33++;
				}
				array9[num33] = (graphics.IsFullScreen ? Lang.menu[49].Value : Lang.menu[50].Value);
				if (selectedMenu == num33)
				{
					action = (Action)Delegate.Combine(action, new Action(ToggleFullScreen));
				}
				num33++;
				array4[num33] = 100;
				array9[num33] = Lang.menu[134].Value;
				if (selectedMenu == num33)
				{
					if (graphics.IsFullScreen || PendingBorderlessState != screenBorderless || PendingResolutionWidth != screenWidth || PendingResolutionHeight != screenHeight)
					{
						action = (Action)Delegate.Combine(action, (Action)delegate
						{
							screenBorderless = PendingBorderlessState;
							screenBorderlessPendingResizes = (screenBorderless ? 6 : 0);
							SetResolution(PendingResolutionWidth, PendingResolutionHeight);
						});
					}
					SoundEngine.PlaySound(11);
					menuMode = 1111;
				}
				num33++;
				array9[num33] = Lang.menu[5].Value;
				array4[num33] = 100;
				if (selectedMenu == num33 || flag5)
				{
					flag5 = false;
					PendingResolutionWidth = graphics.PreferredBackBufferWidth;
					PendingResolutionHeight = graphics.PreferredBackBufferHeight;
					PendingBorderlessState = screenBorderless;
					menuMode = 1111;
					SoundEngine.PlaySound(11);
				}
				num33++;
				num5 = num33;
			}
			else if (menuMode == 1125)
			{
				num2 = 232;
				num4 = 38;
				num5 = 7;
				array4[num5 - 1] = 18;
				for (int num36 = 0; num36 < num5; num36++)
				{
					array7[num36] = 0.73f;
				}
				int num37 = 0;
				array9[num37] = Lang.menu[64].Value;
				if (selectedMenu == num37)
				{
					SoundEngine.PlaySound(10);
					selColor = mouseColor;
					mouseColorSlider.SetHSL(mouseColor);
					menuMode = 25;
				}
				num37++;
				array9[num37] = Lang.menu[217].Value;
				if (selectedMenu == num37)
				{
					SoundEngine.PlaySound(10);
					selColor = MouseBorderColor;
					mouseBorderColorSlider.SetHSL(mouseColor);
					menuMode = 252;
				}
				num37++;
				array9[num37] = (cSmartCursorModeIsToggleAndNotHold ? Lang.menu[121].Value : Lang.menu[122].Value);
				if (selectedMenu == num37)
				{
					SoundEngine.PlaySound(12);
					cSmartCursorModeIsToggleAndNotHold = !cSmartCursorModeIsToggleAndNotHold;
				}
				num37++;
				array9[num37] = (Player.SmartCursorSettings.SmartAxeAfterPickaxe ? Lang.menu[214].Value : Lang.menu[213].Value);
				if (selectedMenu == num37)
				{
					SoundEngine.PlaySound(12);
					Player.SmartCursorSettings.SmartAxeAfterPickaxe = !Player.SmartCursorSettings.SmartAxeAfterPickaxe;
				}
				num37++;
				array9[num37] = (Player.SmartCursorSettings.SmartBlocksEnabled ? Lang.menu[215].Value : Lang.menu[216].Value);
				if (selectedMenu == num37)
				{
					SoundEngine.PlaySound(12);
					Player.SmartCursorSettings.SmartBlocksEnabled = !Player.SmartCursorSettings.SmartBlocksEnabled;
				}
				num37++;
				switch (LockOnHelper.UseMode)
				{
				case LockOnHelper.LockOnMode.FocusTarget:
					array9[num37] = Lang.menu[232].Value;
					break;
				case LockOnHelper.LockOnMode.TargetClosest:
					array9[num37] = Lang.menu[233].Value;
					break;
				case LockOnHelper.LockOnMode.ThreeDS:
					array9[num37] = Lang.menu[234].Value;
					break;
				}
				if (selectedMenu == num37)
				{
					SoundEngine.PlaySound(12);
					LockOnHelper.CycleUseModes();
				}
				num37++;
				array9[num37] = Lang.menu[5].Value;
				if (selectedMenu == num37 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 25)
			{
				flag = true;
				num9 = 320;
				num2 = 200;
				num4 = 10;
				mouseColor = selColor;
				mouseColorSlider.SetHSL(mouseColor);
				num5 = 3;
				array9[0] = "";
				array9[1] = Lang.menu[64].Value;
				array[1] = true;
				array4[2] = 250;
				array4[1] = 10;
				array9[2] = Lang.menu[5].Value;
				if (selectedMenu == 2 || flag5)
				{
					flag5 = false;
					menuMode = 1125;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 252)
			{
				flag = true;
				num9 = 320;
				num2 = 200;
				num4 = 10;
				MouseBorderColor = selColor;
				mouseBorderColorSlider.SetHSL(mouseColor);
				num5 = 3;
				array9[0] = "";
				array9[1] = Lang.menu[217].Value;
				array[1] = true;
				array4[2] = 250;
				array4[1] = 10;
				array9[2] = Lang.menu[5].Value;
				if (selectedMenu == 2 || flag5)
				{
					flag5 = false;
					menuMode = 1125;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 26)
			{
				flag2 = true;
				num2 = 200;
				num4 = 10;
				num5 = 3;
				array9[0] = "";
				array9[1] = Lang.menu[65].Value;
				array[1] = true;
				array4[2] = 250;
				array4[1] = 10;
				array9[2] = Lang.menu[5].Value;
				if (selectedMenu == 2 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 28)
			{
				caveParallax = 1f - (float)bgScroll / 500f;
				flag3 = true;
				num2 = 240;
				num4 = 60;
				num5 = 3;
				array9[0] = "";
				array9[1] = Lang.menu[52].Value;
				array[1] = true;
				array4[2] = 170;
				array4[1] = 10;
				array9[2] = Lang.menu[5].Value;
				if (selectedMenu == 2 || flag5)
				{
					flag5 = false;
					menuMode = 1111;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 272727)
			{
				num2 = 200;
				num4 = 30;
				num5 = 14;
				string[] array10 = new string[12]
				{
					cMapStyle, cMapFull, cMapZoomIn, cMapZoomOut, cMapAlphaUp, cMapAlphaDown, null, null, null, null,
					null, null
				};
				if (setKey >= 0)
				{
					array10[setKey] = "_";
				}
				array9[0] = Lang.menu[106].Value + array10[0];
				array9[1] = Lang.menu[107].Value + array10[1];
				array9[2] = Lang.menu[108].Value + array10[2];
				array9[3] = Lang.menu[109].Value + array10[3];
				array9[4] = Lang.menu[110].Value + array10[4];
				array9[5] = Lang.menu[111].Value + array10[5];
				for (int num38 = 0; num38 < 6; num38++)
				{
					array8[num38] = true;
					array7[num38] = 0.55f;
					array5[num38] = -140;
				}
				array7[6] = 0.8f;
				array7[6] = 0.8f;
				array4[6] = 6;
				array9[6] = Lang.menu[86].Value;
				array4[7] = 16;
				array9[7] = Lang.menu[5].Value;
				if (selectedMenu == 7 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
				else if (selectedMenu == 6)
				{
					cMapStyle = "Tab";
					cMapFull = "M";
					cMapZoomIn = "Add";
					cMapZoomOut = "Subtract";
					cMapAlphaUp = "PageUp";
					cMapAlphaDown = "PageDown";
					setKey = -1;
					SoundEngine.PlaySound(11);
				}
				else if (selectedMenu >= 0)
				{
					setKey = selectedMenu;
				}
				if (setKey >= 0)
				{
					List<Microsoft.Xna.Framework.Input.Keys> pressedKeys = PlayerInput.GetPressedKeys();
					if (pressedKeys.Count > 0)
					{
						string text = string.Concat(pressedKeys[0]);
						if (text != "None")
						{
							if (setKey == 0)
							{
								cMapStyle = text;
							}
							if (setKey == 1)
							{
								cMapFull = text;
							}
							if (setKey == 2)
							{
								cMapZoomIn = text;
							}
							if (setKey == 3)
							{
								cMapZoomOut = text;
							}
							if (setKey == 4)
							{
								cMapAlphaUp = text;
							}
							if (setKey == 5)
							{
								cMapAlphaDown = text;
							}
							setKey = -1;
						}
					}
				}
			}
			else if (menuMode == 27)
			{
				num2 = 176;
				num4 = 22;
				num5 = 16;
				string[] array11 = new string[14]
				{
					cUp, cDown, cLeft, cRight, cJump, cThrowItem, cInv, cHeal, cMana, cBuff,
					cHook, cTorch, cSmart, cMount
				};
				if (setKey >= 0)
				{
					array11[setKey] = "_";
				}
				array9[0] = Lang.menu[74].Value + array11[0];
				array9[1] = Lang.menu[75].Value + array11[1];
				array9[2] = Lang.menu[76].Value + array11[2];
				array9[3] = Lang.menu[77].Value + array11[3];
				array9[4] = Lang.menu[78].Value + array11[4];
				array9[5] = Lang.menu[79].Value + array11[5];
				array9[6] = Lang.menu[80].Value + array11[6];
				array9[7] = Lang.menu[81].Value + array11[7];
				array9[8] = Lang.menu[82].Value + array11[8];
				array9[9] = Lang.menu[83].Value + array11[9];
				array9[10] = Lang.menu[84].Value + array11[10];
				array9[11] = Lang.menu[85].Value + array11[11];
				array9[12] = Lang.menu[120].Value + array11[12];
				array9[13] = Lang.menu[130].Value + array11[13];
				for (int num39 = 0; num39 < 14; num39++)
				{
					array8[num39] = true;
					array7[num39] = 0.45f;
					array5[num39] = -80;
				}
				array7[14] = 0.8f;
				array4[14] = 6;
				array9[14] = Lang.menu[86].Value;
				array7[15] = 0.8f;
				array4[15] = 16;
				array9[15] = Lang.menu[5].Value;
				if (selectedMenu == 15 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
				else if (selectedMenu == 14)
				{
					ResetKeyBindings();
					setKey = -1;
					SoundEngine.PlaySound(11);
				}
				else if (selectedMenu >= 0)
				{
					setKey = selectedMenu;
				}
				if (setKey >= 0)
				{
					List<Microsoft.Xna.Framework.Input.Keys> pressedKeys2 = PlayerInput.GetPressedKeys();
					if (pressedKeys2.Count > 0)
					{
						string text2 = string.Concat(pressedKeys2[0]);
						if (text2 != "None")
						{
							if (setKey == 0)
							{
								cUp = text2;
							}
							if (setKey == 1)
							{
								cDown = text2;
							}
							if (setKey == 2)
							{
								cLeft = text2;
							}
							if (setKey == 3)
							{
								cRight = text2;
							}
							if (setKey == 4)
							{
								cJump = text2;
							}
							if (setKey == 5)
							{
								cThrowItem = text2;
							}
							if (setKey == 6)
							{
								cInv = text2;
							}
							if (setKey == 7)
							{
								cHeal = text2;
							}
							if (setKey == 8)
							{
								cMana = text2;
							}
							if (setKey == 9)
							{
								cBuff = text2;
							}
							if (setKey == 10)
							{
								cHook = text2;
							}
							if (setKey == 11)
							{
								cTorch = text2;
							}
							if (setKey == 12)
							{
								cSmart = text2;
							}
							if (setKey == 13)
							{
								cMount = text2;
							}
							setKey = -1;
						}
					}
				}
			}
			else if (menuMode == 1127)
			{
				num2 = 250;
				num4 = 52;
				num5 = 4;
				array4[num5 - 1] = 18;
				for (int num40 = 0; num40 < num5; num40++)
				{
					array7[num40] = 0.78f;
				}
				int num41 = 0;
				array9[num41] = (ReversedUpDownArmorSetBonuses ? Lang.menu[220].Value : Lang.menu[221].Value);
				if (selectedMenu == num41)
				{
					SoundEngine.PlaySound(12);
					ReversedUpDownArmorSetBonuses = !ReversedUpDownArmorSetBonuses;
				}
				num41++;
				if (ItemSlot.Options.DisableQuickTrash)
				{
					array9[num41] = Lang.menu[253].Value;
				}
				else
				{
					array9[num41] = (ItemSlot.Options.DisableLeftShiftTrashCan ? Lang.menu[224].Value : Lang.menu[223].Value);
				}
				if (selectedMenu == num41)
				{
					SoundEngine.PlaySound(12);
					if (ItemSlot.Options.DisableQuickTrash)
					{
						ItemSlot.Options.DisableQuickTrash = false;
						ItemSlot.Options.DisableLeftShiftTrashCan = true;
					}
					else if (ItemSlot.Options.DisableLeftShiftTrashCan)
					{
						ItemSlot.Options.DisableLeftShiftTrashCan = false;
					}
					else
					{
						ItemSlot.Options.DisableQuickTrash = true;
						ItemSlot.Options.DisableLeftShiftTrashCan = false;
					}
				}
				num41++;
				array9[num41] = Lang.menu[222].Value;
				if (selectedMenu == num41)
				{
					SoundEngine.PlaySound(10);
					menuMode = 888;
					MenuUI.SetState(ManageControlsMenu);
				}
				num41++;
				array9[num41] = Lang.menu[5].Value;
				if (selectedMenu == num41 || flag5)
				{
					flag5 = false;
					menuMode = 11;
					SoundEngine.PlaySound(11);
				}
			}
			else if (menuMode == 12)
			{
				int num42 = ((SocialAPI.Network != null) ? 1 : 0);
				menuServer = false;
				array9[0] = Lang.menu[(SocialAPI.Network != null) ? 146 : 87].Value;
				array9[1] = Lang.menu[145].Value;
				array9[1 + num42] = Lang.menu[88].Value;
				array9[2 + num42] = Lang.menu[5].Value;
				if (selectedMenu == 0)
				{
					LoadPlayers();
					menuMultiplayer = true;
					SoundEngine.PlaySound(10);
					ClearPendingPlayerSelectCallbacks();
					menuMode = 1;
				}
				else if (selectedMenu == 1 + num42)
				{
					LoadPlayers();
					SoundEngine.PlaySound(10);
					ClearPendingPlayerSelectCallbacks();
					menuMode = 1;
					menuMultiplayer = true;
					menuServer = true;
				}
				else if (selectedMenu == 1)
				{
					SoundEngine.PlaySound(10);
					SocialAPI.Friends.OpenJoinInterface();
				}
				else if (selectedMenu == 2 + num42 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 0;
				}
				num5 = 3 + num42;
			}
			else if (menuMode == 13)
			{
				if (PlayerInput.SettingsForUI.ShowGamepadHints)
				{
					num2 = 180;
					num4 = 30;
					int num43 = 0;
					array9[num43] = Lang.menu[89].Value.Replace(":", "");
					if (selectedMenu == num43)
					{
						UIVirtualKeyboard state2 = new UIVirtualKeyboard(Lang.menu[89].Value, getIP, OnSubmitServerIP, CreateGoToMenuEvent(13), 0, allowEmpty: true);
						UserInterface.ActiveInstance.SetState(state2);
						menuMode = 888;
					}
					array7[num43] = 0.6f;
					array4[num43] = 40;
					num43++;
					for (int num44 = 0; num44 <= 6; num44++)
					{
						if (recentWorld[num44] != null && recentWorld[num44] != "")
						{
							array9[num43] = recentWorld[num44] + " (" + recentIP[num44] + ":" + recentPort[num44] + ")";
						}
						else
						{
							array9[num43] = "";
							array[num43] = true;
						}
						array7[num43] = 0.6f;
						array4[num43] = 40;
						if (selectedMenu == num43)
						{
							autoPass = false;
							Netplay.ListenPort = recentPort[num44];
							getIP = recentIP[num44];
							Netplay.SetRemoteIPAsync(getIP, StartClientGameplay);
							menuMode = 14;
							statusText = Language.GetTextValue("Net.ConnectingTo", getIP);
						}
						num43++;
					}
					array4[num43] = 64;
					array9[num43] = Lang.menu[5].Value;
					if (selectedMenu == num43 || flag5)
					{
						flag5 = false;
						SoundEngine.PlaySound(11);
						menuMode = 1;
					}
					num43++;
					num5 = num43;
				}
				else
				{
					string text3 = getIP;
					PlayerInput.WritingText = true;
					instance.HandleIME();
					getIP = GetInputText(getIP);
					if (text3 != getIP)
					{
						SoundEngine.PlaySound(12);
					}
					num5 = 11;
					num2 = 180;
					num4 = 30;
					array9[0] = Lang.menu[89].Value;
					array[0] = true;
					array9[1] = getIP;
					array4[1] = 19;
					if (textBlinkerState == 1)
					{
						array9[1] += "|";
						array5[1] = 1;
					}
					else
					{
						array9[1] += " ";
					}
					array[1] = true;
					array4[9] = 44;
					array9[9] = Lang.menu[4].Value;
					array2[9] = true;
					if (getIP != "")
					{
						if (getIP.Substring(0, 1) == " ")
						{
							getIP = "";
						}
						for (int num45 = 0; num45 < getIP.Length; num45++)
						{
							if (getIP != " ")
							{
								array2[9] = false;
							}
						}
					}
					array4[10] = 64;
					array9[10] = Lang.menu[5].Value;
					for (int num46 = 2; num46 <= 8; num46++)
					{
						int num47 = num46 - 2;
						if (recentWorld[num47] != null && recentWorld[num47] != "")
						{
							array9[num46] = recentWorld[num47] + " (" + recentIP[num47] + ":" + recentPort[num47] + ")";
						}
						else
						{
							array9[num46] = "";
							array[num46] = true;
						}
						array7[num46] = 0.6f;
						array4[num46] = 40;
					}
					if (selectedMenu >= 2 && selectedMenu < 9)
					{
						autoPass = false;
						int num48 = selectedMenu - 2;
						Netplay.ListenPort = recentPort[num48];
						getIP = recentIP[num48];
						Netplay.SetRemoteIPAsync(getIP, StartClientGameplay);
						menuMode = 14;
						statusText = Language.GetTextValue("Net.ConnectingTo", getIP);
					}
					if (selectedMenu == 10 || flag5)
					{
						flag5 = false;
						SoundEngine.PlaySound(11);
						menuMode = 1;
					}
					if (selectedMenu == 9 || (!array2[2] && inputTextEnter))
					{
						OnSubmitServerIP(getIP);
					}
					textBlinkerCount++;
					if (textBlinkerCount >= 20)
					{
						if (textBlinkerState == 0)
						{
							textBlinkerState = 1;
						}
						else
						{
							textBlinkerState = 0;
						}
						textBlinkerCount = 0;
					}
				}
			}
			else if (menuMode == 131)
			{
				if (PlayerInput.SettingsForUI.ShowGamepadHints)
				{
					UIVirtualKeyboard uIVirtualKeyboard3 = new UIVirtualKeyboard(Lang.menu[90].Value, getPort, OnSubmitServerPort, CreateGoToMenuEvent(13), 0, allowEmpty: true);
					uIVirtualKeyboard3.CustomTextValidationForUpdate = IsGoodPortAddress;
					uIVirtualKeyboard3.CustomTextValidationForSubmit = IsGoodPortAddress;
					UserInterface.ActiveInstance.SetState(uIVirtualKeyboard3);
					menuMode = 888;
				}
				int num49 = 7777;
				PlayerInput.WritingText = true;
				instance.HandleIME();
				string text4 = getPort;
				getPort = GetInputText(getPort);
				if (text4 != getPort)
				{
					SoundEngine.PlaySound(12);
				}
				array9[0] = Lang.menu[90].Value;
				array2[2] = true;
				if (getPort != "")
				{
					bool flag7 = false;
					try
					{
						num49 = Convert.ToInt32(getPort);
						if (num49 > 0 && num49 <= 65535)
						{
							flag7 = true;
						}
					}
					catch
					{
					}
					if (flag7)
					{
						array2[2] = false;
					}
				}
				textBlinkerCount++;
				if (textBlinkerCount >= 20)
				{
					if (textBlinkerState == 0)
					{
						textBlinkerState = 1;
					}
					else
					{
						textBlinkerState = 0;
					}
					textBlinkerCount = 0;
				}
				array9[1] = getPort;
				if (textBlinkerState == 1)
				{
					array9[1] += "|";
					array5[1] = 1;
				}
				else
				{
					array9[1] += " ";
				}
				array[0] = true;
				array[1] = true;
				array4[1] = -20;
				array4[2] = 20;
				array9[2] = Lang.menu[4].Value;
				array9[3] = Lang.menu[5].Value;
				num5 = 4;
				if (selectedMenu == 3 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 1;
				}
				if (selectedMenu == 2 || (!array2[2] && inputTextEnter))
				{
					OnSubmitServerPort(getPort);
				}
			}
			else if (menuMode == 16)
			{
				num2 = 200;
				num4 = 60;
				array4[1] = 30;
				array4[2] = 30;
				array4[3] = 30;
				array4[4] = 70;
				array9[0] = Lang.menu[91].Value;
				array[0] = true;
				array9[1] = Lang.menu[92].Value;
				array9[2] = Lang.menu[93].Value;
				array9[3] = Lang.menu[94].Value;
				array9[4] = Lang.menu[5].Value;
				num5 = 5;
				if (selectedMenu == 4 || flag5)
				{
					flag5 = false;
					menuMode = 6;
					SoundEngine.PlaySound(11);
				}
				else if (selectedMenu > 0)
				{
					if (selectedMenu == 1)
					{
						maxTilesX = 4200;
						maxTilesY = 1200;
					}
					else if (selectedMenu == 2)
					{
						maxTilesX = 6400;
						maxTilesY = 1800;
					}
					else
					{
						maxTilesX = 8400;
						maxTilesY = 2400;
					}
					clrInput();
					menuMode = -7;
					SoundEngine.PlaySound(10);
					WorldGen.setWorldSize();
				}
			}
			else if (menuMode == 1000000)
			{
				num5 = 2;
				array9[0] = statusText;
				array[0] = true;
				num2 = 220;
				num4 = 250;
				array9[1] = Lang.menu[5].Value;
				if (selectedMenu == 1 || flag5)
				{
					flag5 = false;
					SoundEngine.PlaySound(11);
					menuMode = 6;
					netMode = 0;
				}
			}
			else if (menuMode == 1000001)
			{
				num5 = 2;
				array9[0] = statusText;
				array[0] = true;
				num2 = 220;
				num4 = 250;
				RejectionMenuInfo rejectionMenuInfo = RejectionMenuInfo;
				if (rejectionMenuInfo != null)
				{
					array9[0] = rejectionMenuInfo.TextToShow;
				}
				array9[1] = Lang.menu[5].Value;
				if (selectedMenu == 1 || flag5)
				{
					flag5 = false;
					ReturnFromRejectionMenuAction returnFromRejectionMenuAction = null;
					if (RejectionMenuInfo != null)
					{
						returnFromRejectionMenuAction = RejectionMenuInfo.ExitAction;
					}
					if (returnFromRejectionMenuAction != null)
					{
						returnFromRejectionMenuAction();
					}
					else
					{
						SoundEngine.PlaySound(11);
						menuMode = 0;
						netMode = 0;
					}
				}
			}
		}
		if (menuMode == 888)
		{
			if (!_blockFancyUIWhileLoading)
			{
				MenuUI.Draw(spriteBatch, gameTime);
			}
		}
		else
		{
			MenuUI.SetState(null);
		}
		if (UILinkPointNavigator.Shortcuts.BackButtonInUse && !flag5)
		{
			UILinkPointNavigator.Shortcuts.BackButtonLock = true;
		}
		int num50 = focusMenu;
		if (menuMode != num6)
		{
			if (menuMode == 10 || netMode == 1 || menuMode == 14)
			{
				gameTips.ClearTips();
			}
			blockMouse = true;
			menuSkip = 0;
			num5 = 0;
			if (PlayerInput.UsingGamepad && InvisibleCursorForGamepad)
			{
				num50 = (focusMenu = -1);
				mouseX = (mouseY = (PlayerInput.MouseX = (PlayerInput.MouseY = 0)));
			}
			for (int num51 = 0; num51 < maxMenuItems; num51++)
			{
				menuItemScale[num51] = 0.8f;
			}
		}
		if (!mouseLeft)
		{
			blockMouse = true;
		}
		selectedMenu = -1;
		selectedMenu2 = -1;
		focusMenu = -1;
		bool flag8 = mouseLeft && !PlayerInput.UsingGamepad;
		if (!flag)
		{
			grabColorSlider = 0;
			hBar = -1f;
			sBar = -1f;
			lBar = -1f;
			aBar = -1f;
		}
		if (flag)
		{
			if (!mouseLeft)
			{
				grabColorSlider = 0;
				blockMouse = false;
			}
			int num52 = focusColor;
			focusColor = 0;
			int num53 = num9;
			int num54 = screenWidth / 2 - TextureAssets.Hue.Width() / 2;
			int num55 = 167;
			Vector3 vector = rgbToHsl(selColor);
			float num56 = vector.X;
			float num57 = vector.Y;
			float luminosity = vector.Z;
			float num58 = (float)(int)selColor.A / 255f;
			if (hBar == -1f || sBar == -1f || lBar == -1f || aBar == -1f)
			{
				hBar = num56;
				sBar = num57;
				lBar = luminosity;
				aBar = num58;
			}
			else
			{
				num56 = hBar;
				num57 = sBar;
				luminosity = lBar;
				num58 = aBar;
			}
			spriteBatch.Draw(TextureAssets.Hue.Value, new Vector2(num54, num53), Microsoft.Xna.Framework.Color.White);
			if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 1)
			{
				spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num54, num53), OurFavoriteColor);
			}
			spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num54 + (float)(TextureAssets.Hue.Width() - 2) * hBar - (float)(TextureAssets.ColorSlider.Width() / 2), num53 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
			if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 1)
			{
				focusColor = 1;
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 5;
				if (flag8 && !blockMouse)
				{
					grabColorSlider = 1;
					num56 = mouseX - num54;
					num56 /= (float)TextureAssets.Hue.Width();
					if (num56 < 0f)
					{
						num56 = 0f;
					}
					if (num56 > 1f)
					{
						num56 = 1f;
					}
					hBar = num56;
				}
			}
			GamepadMainMenuHandler.MenuItemPositions.Add(new Vector2(num54, num53) + TextureAssets.ColorBar.Value.Size() / 2f);
			num53 += 26;
			spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num54, num53), Microsoft.Xna.Framework.Color.White);
			for (int num59 = 0; num59 <= num55; num59++)
			{
				float saturation = (float)num59 / (float)num55;
				Microsoft.Xna.Framework.Color color4 = hslToRgb(num56, saturation, luminosity);
				spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num54 + num59 + 5, num53 + 4), color4);
			}
			if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 2)
			{
				spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num54, num53), OurFavoriteColor);
			}
			spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num54 + (float)(TextureAssets.Hue.Width() - 2) * sBar - (float)(TextureAssets.ColorSlider.Width() / 2), num53 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
			if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 2)
			{
				focusColor = 2;
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 6;
				if (flag8 && !blockMouse)
				{
					grabColorSlider = 2;
					num57 = mouseX - num54;
					num57 /= (float)TextureAssets.Hue.Width();
					if (num57 < 0f)
					{
						num57 = 0f;
					}
					if (num57 > 1f)
					{
						num57 = 1f;
					}
					sBar = num57;
				}
			}
			GamepadMainMenuHandler.MenuItemPositions.Add(new Vector2(num54, num53) + TextureAssets.ColorBar.Value.Size() / 2f);
			num53 += 26;
			spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num54, num53), Microsoft.Xna.Framework.Color.White);
			float num60 = 0.15f;
			if (menuMode == 252)
			{
				num60 = 0f;
			}
			for (int num61 = 0; num61 <= num55; num61++)
			{
				float luminosity2 = (float)num61 / (float)num55;
				Microsoft.Xna.Framework.Color color5 = hslToRgb(num56, num57, luminosity2);
				spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num54 + num61 + 5, num53 + 4), color5);
			}
			if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 3)
			{
				spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num54, num53), OurFavoriteColor);
			}
			spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num54 + (float)(TextureAssets.Hue.Width() - 2) * ((lBar - num60) / (1f - num60)) - (float)(TextureAssets.ColorSlider.Width() / 2), num53 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
			if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 3)
			{
				focusColor = 3;
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 7;
				if (flag8 && !blockMouse)
				{
					grabColorSlider = 3;
					luminosity = mouseX - num54;
					luminosity /= (float)TextureAssets.Hue.Width();
					if (luminosity < 0f)
					{
						luminosity = 0f;
					}
					if (luminosity > 1f)
					{
						luminosity = 1f;
					}
					luminosity = (lBar = luminosity * (1f - num60) + num60);
				}
			}
			GamepadMainMenuHandler.MenuItemPositions.Add(new Vector2(num54, num53) + TextureAssets.ColorBar.Value.Size() / 2f);
			bool flag9 = false;
			if (menuMode == 252)
			{
				num53 += 26;
				flag9 = true;
				spriteBatch.Draw(TextureAssets.ColorBar.Value, new Vector2(num54, num53), Microsoft.Xna.Framework.Color.White);
				Microsoft.Xna.Framework.Color color6 = hslToRgb(num56, num57, luminosity);
				for (int num62 = 0; num62 <= num55; num62++)
				{
					float num63 = (float)num62 / (float)num55;
					Microsoft.Xna.Framework.Color color7 = color6 * num63;
					spriteBatch.Draw(TextureAssets.ColorBlip.Value, new Vector2(num54 + num62 + 5, num53 + 4), color7);
				}
				if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 4)
				{
					spriteBatch.Draw(TextureAssets.ColorHighlight.Value, new Vector2(num54, num53), OurFavoriteColor);
				}
				spriteBatch.Draw(TextureAssets.ColorSlider.Value, new Vector2((float)num54 + (float)(TextureAssets.Hue.Width() - 2) * aBar - (float)(TextureAssets.ColorSlider.Width() / 2), num53 - TextureAssets.ColorSlider.Height() / 2 + TextureAssets.Hue.Height() / 2), Microsoft.Xna.Framework.Color.White);
				if ((mouseX > num54 - 4 && mouseX < num54 + TextureAssets.Hue.Width() + 4 && mouseY > num53 - 4 && mouseY < num53 + TextureAssets.Hue.Height() + 4 && grabColorSlider == 0) || grabColorSlider == 4)
				{
					focusColor = 4;
					UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 8;
					if (mouseLeft && !blockMouse)
					{
						grabColorSlider = 4;
						num58 = mouseX - num54;
						num58 /= (float)TextureAssets.Hue.Width();
						if (num58 < 0f)
						{
							num58 = 0f;
						}
						if (num58 > 1f)
						{
							num58 = 1f;
						}
						aBar = num58;
					}
				}
				GamepadMainMenuHandler.MenuItemPositions.Add(new Vector2(num54, num53) + TextureAssets.ColorBar.Value.Size() / 2f);
			}
			if (num52 != focusColor)
			{
				SoundEngine.PlaySound(12);
			}
			selColor = hslToRgb(hBar, sBar, lBar);
			if (flag9)
			{
				selColor.A = (byte)(aBar * 255f);
			}
		}
		else if (flag)
		{
			string text5 = "";
			for (int num64 = 0; num64 < 6; num64++)
			{
				int num65 = num9;
				int num66 = 370 + screenWidth / 2 - 400;
				if (num64 == 0)
				{
					text5 = Lang.menu[95].Value;
				}
				if (num64 == 1)
				{
					text5 = Lang.menu[96].Value;
					num65 += 30;
				}
				if (num64 == 2)
				{
					text5 = Lang.menu[97].Value;
					num65 += 60;
				}
				if (num64 == 3)
				{
					text5 = string.Concat(selColor.R);
					num66 += 90;
				}
				if (num64 == 4)
				{
					text5 = string.Concat(selColor.G);
					num66 += 90;
					num65 += 30;
				}
				if (num64 == 5)
				{
					text5 = string.Concat(selColor.B);
					num66 += 90;
					num65 += 60;
				}
				for (int num67 = 0; num67 < 5; num67++)
				{
					Microsoft.Xna.Framework.Color color8 = Microsoft.Xna.Framework.Color.Black;
					if (num67 == 4)
					{
						color8 = color;
						color8.R = (byte)((255 + color8.R) / 2);
						color8.G = (byte)((255 + color8.R) / 2);
						color8.B = (byte)((255 + color8.R) / 2);
					}
					int num68 = 255;
					int num69 = color8.R - (255 - num68);
					if (num69 < 0)
					{
						num69 = 0;
					}
					color8 = new Microsoft.Xna.Framework.Color((byte)num69, (byte)num69, (byte)num69, (byte)num68);
					int num70 = 0;
					int num71 = 0;
					if (num67 == 0)
					{
						num70 = -2;
					}
					if (num67 == 1)
					{
						num70 = 2;
					}
					if (num67 == 2)
					{
						num71 = -2;
					}
					if (num67 == 3)
					{
						num71 = 2;
					}
					DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, text5, new Vector2(num66 + num70, num65 + num71), color8, 0f, default(Vector2), 0.5f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
				}
			}
			bool flag10 = false;
			for (int num72 = 0; num72 < 2; num72++)
			{
				for (int num73 = 0; num73 < 3; num73++)
				{
					int num74 = num9 + num73 * 30 - 12;
					int num75 = 360 + screenWidth / 2 - 400;
					float num76 = 0.9f;
					if (num72 == 0)
					{
						num75 -= 70;
						num74 += 2;
					}
					else
					{
						num75 -= 40;
					}
					text5 = "-";
					if (num72 == 1)
					{
						text5 = "+";
					}
					Vector2 vector2 = new Vector2(24f, 24f);
					int num77 = 142;
					if (mouseX > num75 && (float)mouseX < (float)num75 + vector2.X && mouseY > num74 + 13 && (float)mouseY < (float)(num74 + 13) + vector2.Y)
					{
						if (focusColor != (num72 + 1) * (num73 + 10))
						{
							SoundEngine.PlaySound(12);
						}
						focusColor = (num72 + 1) * (num73 + 10);
						flag10 = true;
						num77 = 255;
						if (mouseLeft)
						{
							if (colorDelay <= 1)
							{
								if (colorDelay == 0)
								{
									colorDelay = 40;
								}
								else
								{
									colorDelay = 3;
								}
								int num78 = num72;
								if (num72 == 0)
								{
									num78 = -1;
									if (selColor.R + selColor.G + selColor.B <= 150)
									{
										num78 = 0;
									}
								}
								if (num73 == 0 && selColor.R + num78 >= 0 && selColor.R + num78 <= 255)
								{
									selColor.R = (byte)(selColor.R + num78);
								}
								if (num73 == 1 && selColor.G + num78 >= 0 && selColor.G + num78 <= 255)
								{
									selColor.G = (byte)(selColor.G + num78);
								}
								if (num73 == 2 && selColor.B + num78 >= 0 && selColor.B + num78 <= 255)
								{
									selColor.B = (byte)(selColor.B + num78);
								}
							}
							colorDelay--;
						}
						else
						{
							colorDelay = 0;
						}
					}
					for (int num79 = 0; num79 < 5; num79++)
					{
						Microsoft.Xna.Framework.Color color9 = Microsoft.Xna.Framework.Color.Black;
						if (num79 == 4)
						{
							color9 = color;
							color9.R = (byte)((255 + color9.R) / 2);
							color9.G = (byte)((255 + color9.R) / 2);
							color9.B = (byte)((255 + color9.R) / 2);
						}
						int num80 = color9.R - (255 - num77);
						if (num80 < 0)
						{
							num80 = 0;
						}
						color9 = new Microsoft.Xna.Framework.Color((byte)num80, (byte)num80, (byte)num80, (byte)num77);
						int num81 = 0;
						int num82 = 0;
						if (num79 == 0)
						{
							num81 = -2;
						}
						if (num79 == 1)
						{
							num81 = 2;
						}
						if (num79 == 2)
						{
							num82 = -2;
						}
						if (num79 == 3)
						{
							num82 = 2;
						}
						DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, text5, new Vector2(num75 + num81, num74 + num82), color9, 0f, default(Vector2), num76, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
					}
				}
			}
			if (!flag10)
			{
				focusColor = 0;
				colorDelay = 0;
			}
		}
		if (flag2)
		{
			float x = screenWidth / 2 - 40 + 37;
			int num83 = 320;
			string text6 = "";
			for (int num84 = 0; num84 < 6; num84++)
			{
				int num85 = num83;
				int num86 = 370 + screenWidth / 2 - 400 + 37;
				switch (num84)
				{
				case 0:
					text6 = Lang.menu[98].Value;
					num85 += 30;
					break;
				case 1:
					text6 = Lang.menu[99].Value;
					break;
				case 2:
					text6 = Lang.menu[119].Value;
					num85 += 60;
					break;
				case 3:
					text6 = Math.Round(musicVolume * 100f) + "%";
					num86 += 90;
					break;
				case 4:
					text6 = Math.Round(soundVolume * 100f) + "%";
					num86 += 90;
					num85 += 30;
					break;
				case 5:
					text6 = Math.Round(ambientVolume * 100f) + "%";
					num86 += 90;
					num85 += 60;
					break;
				}
				Microsoft.Xna.Framework.Color color10 = color;
				color10.R = (byte)((255 + color10.R) / 2);
				color10.G = (byte)((255 + color10.R) / 2);
				color10.B = (byte)((255 + color10.R) / 2);
				int num87 = 255;
				int num88 = color10.R - (255 - num87);
				if (num88 < 0)
				{
					num88 = 0;
				}
				Utils.DrawBorderStringFourWay(textColor: new Microsoft.Xna.Framework.Color((byte)num88, (byte)num88, (byte)num88, (byte)num87), sb: spriteBatch, font: FontAssets.DeathText.Value, text: text6, x: num86, y: num85, borderColor: Microsoft.Xna.Framework.Color.Black, origin: Vector2.Zero, scale: 0.5f);
			}
			int rightHover = IngameOptions.rightHover;
			IngameOptions.rightHover = -1;
			if (!mouseLeft)
			{
				IngameOptions.rightLock = -1;
			}
			IngameOptions.valuePosition = new Vector2(x, num83 - 18 + 30);
			GamepadMainMenuHandler.MenuItemPositions.Add(IngameOptions.valuePosition - TextureAssets.ColorBar.Value.Size() * new Vector2(0.5f, 0f));
			float num89 = IngameOptions.DrawValueBar(spriteBatch, 1f, musicVolume);
			if (IngameOptions.inBar || IngameOptions.rightLock == 3)
			{
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 2;
				IngameOptions.rightHover = 3;
				if (flag8 && IngameOptions.rightLock == 3)
				{
					musicVolume = num89;
				}
			}
			IngameOptions.valuePosition = new Vector2(x, num83 - 18 + 60);
			GamepadMainMenuHandler.MenuItemPositions.Add(IngameOptions.valuePosition - TextureAssets.ColorBar.Value.Size() * new Vector2(0.5f, 0f));
			float num90 = IngameOptions.DrawValueBar(spriteBatch, 1f, soundVolume);
			if (IngameOptions.inBar || IngameOptions.rightLock == 2)
			{
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 3;
				IngameOptions.rightHover = 2;
				if (flag8 && IngameOptions.rightLock == 2)
				{
					soundVolume = num90;
				}
			}
			IngameOptions.valuePosition = new Vector2(x, num83 - 18 + 90);
			GamepadMainMenuHandler.MenuItemPositions.Add(IngameOptions.valuePosition - TextureAssets.ColorBar.Value.Size() * new Vector2(0.5f, 0f));
			float num91 = IngameOptions.DrawValueBar(spriteBatch, 1f, ambientVolume);
			if (IngameOptions.inBar || IngameOptions.rightLock == 4)
			{
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 4;
				IngameOptions.rightHover = 4;
				if (flag8 && IngameOptions.rightLock == 4)
				{
					ambientVolume = num91;
				}
			}
			if (IngameOptions.rightHover != -1)
			{
				IngameOptions.rightLock = IngameOptions.rightHover;
			}
			if (IngameOptions.rightHover != rightHover)
			{
				SoundEngine.PlaySound(12);
			}
		}
		if (flag3)
		{
			int num92 = 400;
			string text7 = "";
			for (int num93 = 0; num93 < 4; num93++)
			{
				int num94 = num92;
				int num95 = 370 + screenWidth / 2 - 400;
				if (num93 == 0)
				{
					text7 = Lang.menu[52].Value + ": " + bgScroll;
				}
				for (int num96 = 0; num96 < 5; num96++)
				{
					Microsoft.Xna.Framework.Color color11 = Microsoft.Xna.Framework.Color.Black;
					if (num96 == 4)
					{
						color11 = color;
						color11.R = (byte)((255 + color11.R) / 2);
						color11.G = (byte)((255 + color11.R) / 2);
						color11.B = (byte)((255 + color11.R) / 2);
					}
					int num97 = 255;
					int num98 = color11.R - (255 - num97);
					if (num98 < 0)
					{
						num98 = 0;
					}
					color11 = new Microsoft.Xna.Framework.Color((byte)num98, (byte)num98, (byte)num98, (byte)num97);
					int num99 = 0;
					int num100 = 0;
					if (num96 == 0)
					{
						num99 = -2;
					}
					if (num96 == 1)
					{
						num99 = 2;
					}
					if (num96 == 2)
					{
						num100 = -2;
					}
					if (num96 == 3)
					{
						num100 = 2;
					}
					DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, text7, new Vector2(num95 + num99, num94 + num100), color11, 0f, default(Vector2), 0.5f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
				}
			}
			IngameOptions.rightHover = -1;
			if (!mouseLeft)
			{
				IngameOptions.rightLock = -1;
			}
			IngameOptions.valuePosition = new Vector2(screenWidth / 2 - 40, num92 + 12);
			GamepadMainMenuHandler.MenuItemPositions.Add(IngameOptions.valuePosition - TextureAssets.ColorBar.Value.Size() * new Vector2(0.5f, 0f));
			float num101 = IngameOptions.DrawValueBar(spriteBatch, 1f, (float)bgScroll / 100f);
			if (IngameOptions.inBar || IngameOptions.rightLock == 2)
			{
				UILinkPointNavigator.Shortcuts.OPTIONS_BUTTON_SPECIALFEATURE = 1;
				IngameOptions.rightHover = 2;
				if (flag8 && IngameOptions.rightLock == 2)
				{
					bgScroll = (int)(num101 * 100f);
					caveParallax = 1f - (float)bgScroll / 500f;
				}
			}
			if (IngameOptions.rightHover != -1)
			{
				IngameOptions.rightLock = IngameOptions.rightHover;
			}
		}
		bool flag11 = false;
		for (int num102 = 0; num102 < num5; num102++)
		{
			if (array9[num102] == null)
			{
				continue;
			}
			Vector2 vector3 = FontAssets.DeathText.Value.MeasureString(array9[num102]);
			vector3.X *= 0.5f;
			vector3.Y *= 0.5f;
			for (int num103 = 0; num103 < 5; num103++)
			{
				Microsoft.Xna.Framework.Color color12 = Microsoft.Xna.Framework.Color.Black;
				if (num103 == 4)
				{
					switch (array6[num102])
					{
					case 0:
						color12 = color;
						break;
					case 1:
						color12 = mcColor;
						break;
					case 2:
						color12 = hcColor;
						break;
					case 3:
						color12 = highVersionColor;
						break;
					case 4:
					case 5:
					case 6:
						color12 = errorColor;
						break;
					default:
						color12 = color;
						break;
					}
					color12.R = (byte)((255 + color12.R) / 2);
					color12.G = (byte)((255 + color12.G) / 2);
					color12.B = (byte)((255 + color12.B) / 2);
				}
				int num104 = (int)(255f * (menuItemScale[num102] * 2f - 1f));
				if (array[num102])
				{
					num104 = 255;
				}
				int num105 = color12.R - (255 - num104);
				if (num105 < 0)
				{
					num105 = 0;
				}
				int num106 = color12.G - (255 - num104);
				if (num106 < 0)
				{
					num106 = 0;
				}
				int num107 = color12.B - (255 - num104);
				if (num107 < 0)
				{
					num107 = 0;
				}
				if (num50 == num102 && num103 == 4)
				{
					float num108 = (float)num104 / 255f;
					num105 = (int)((float)num105 * (1f - num108) + 255f * num108);
					num106 = (int)((float)num106 * (1f - num108) + 215f * num108);
					num107 = (int)((float)num107 * (1f - num108) + 0f * num108);
				}
				color12 = new Microsoft.Xna.Framework.Color((byte)num105, (byte)num106, (byte)num107, (byte)num104);
				if (array3[num102])
				{
					if (num103 == 4)
					{
						color12.R = (byte)(color12.R * mouseTextColor / 300);
						color12.G = (byte)(color12.G * mouseTextColor / 300);
						color12.B = (byte)(color12.B * mouseTextColor / 300);
						color12.A = (byte)(color12.A * mouseTextColor / 300);
					}
					else
					{
						color12.A -= (byte)(mouseTextColor / 5);
					}
				}
				int num109 = 0;
				int num110 = 0;
				if (num103 == 0)
				{
					num109 = -2;
				}
				if (num103 == 1)
				{
					num109 = 2;
				}
				if (num103 == 2)
				{
					num110 = -2;
				}
				if (num103 == 3)
				{
					num110 = 2;
				}
				float num111 = menuItemScale[num102];
				if (menuMode == 15 && num102 == 0)
				{
					num111 *= 0.35f;
				}
				else if (menuMode == 1000000 && num102 == 0)
				{
					num111 *= 0.75f;
				}
				else if (netMode == 2)
				{
					num111 *= 0.5f;
				}
				num111 *= array7[num102];
				if (!array8[num102])
				{
					DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, array9[num102], new Vector2(num3 + num109 + array5[num102], (float)(num2 + num4 * num102 + num110) + vector3.Y * array7[num102] + (float)array4[num102]), color12, 0f, vector3, num111, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
				}
				else
				{
					DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.DeathText.Value, array9[num102], new Vector2(num3 + num109 + array5[num102], (float)(num2 + num4 * num102 + num110) + vector3.Y * array7[num102] + (float)array4[num102]), color12, 0f, new Vector2(0f, vector3.Y), num111, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
				}
			}
			if (!array[num102] && !array2[num102])
			{
				GamepadMainMenuHandler.MenuItemPositions.Add(new Vector2(num3 + array5[num102], (float)(num2 + num4 * num102) + vector3.Y * array7[num102] + (float)array4[num102]));
			}
			if (!array8[num102])
			{
				int num112 = 0;
				menuWide[num102] = false;
				Vector2 vector4 = FontAssets.DeathText.Value.MeasureString(array9[num102]) * array7[num102];
				if (!((float)mouseX > (float)num3 - vector4.X * 0.5f + (float)array5[num102] - (float)num112) || !((float)mouseX < (float)num3 + vector4.X * 0.5f * array7[num102] + (float)array5[num102] + (float)num112) || mouseY <= num2 + num4 * num102 + array4[num102] || !((float)mouseY < (float)(num2 + num4 * num102 + array4[num102]) + 50f * array7[num102]) || !hasFocus)
				{
					continue;
				}
				focusMenu = num102;
				if (array[num102] || array2[num102])
				{
					focusMenu = -1;
					continue;
				}
				if (num50 != focusMenu)
				{
					flag11 = true;
				}
				if (mouseLeftRelease && mouseLeft)
				{
					selectedMenu = num102;
				}
				if (mouseRightRelease && mouseRight)
				{
					selectedMenu2 = num102;
				}
				continue;
			}
			Vector2 vector5 = FontAssets.DeathText.Value.MeasureString(array9[num102]) * array7[num102];
			if (mouseX <= num3 + array5[num102] || !((float)mouseX < (float)num3 + vector5.X + (float)array5[num102]) || mouseY <= num2 + num4 * num102 + array4[num102] || !((float)mouseY < (float)(num2 + num4 * num102 + array4[num102]) + 50f * array7[num102]) || !hasFocus)
			{
				continue;
			}
			focusMenu = num102;
			if (array[num102] || array2[num102])
			{
				focusMenu = -1;
				continue;
			}
			if (num50 != focusMenu)
			{
				flag11 = true;
			}
			if (mouseLeftRelease && mouseLeft)
			{
				selectedMenu = num102;
			}
			if (mouseRightRelease && mouseRight)
			{
				selectedMenu2 = num102;
			}
		}
		if (flag11 && num50 != focusMenu)
		{
			SoundEngine.PlaySound(12);
		}
		if (GamepadMainMenuHandler.MenuItemPositions.Count == 0)
		{
			Vector2 vector6 = new Vector2((float)Math.Cos(GlobalTimeWrappedHourly * ((float)Math.PI * 2f)), (float)Math.Sin(GlobalTimeWrappedHourly * ((float)Math.PI * 2f) * 2f)) * new Vector2(30f, 15f) + Vector2.UnitY * 20f;
			UILinkPointNavigator.SetPosition(2000, new Vector2(screenWidth, screenHeight) / 2f + vector6);
		}
		for (int num113 = 0; num113 < maxMenuItems; num113++)
		{
			if (num113 == focusMenu)
			{
				if (menuItemScale[num113] < 1f)
				{
					menuItemScale[num113] += 0.02f;
				}
				if (menuItemScale[num113] > 1f)
				{
					menuItemScale[num113] = 1f;
				}
			}
			else if ((double)menuItemScale[num113] > 0.8)
			{
				menuItemScale[num113] -= 0.02f;
			}
		}
		if (flag4)
		{
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
			Player pendingPlayer = PendingPlayer;
			pendingPlayer.PlayerFrame();
			pendingPlayer.position.X = (float)num7 + screenPosition.X;
			pendingPlayer.position.Y = (float)num8 + screenPosition.Y;
			PlayerRenderer.DrawPlayer(Camera, pendingPlayer, pendingPlayer.position, 0f, Vector2.Zero);
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
		}
		float num114 = 0f;
		if (!WorldGen.drunkWorldGen && menuMode == 0)
		{
			DrawSocialMediaButtons(color, num114);
			num114 += 32f;
		}
		if (!WorldGen.drunkWorldGen)
		{
			DrawVersionNumber(color, num114);
			num114 += 20f;
		}
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerStateForCursor, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
		WorkshopPublishingIndicator.Draw(spriteBatch);
		IssueReporterIndicator.Draw(spriteBatch);
		DrawCursor(DrawThickCursor());
		DrawPendingMouseText();
		if (fadeCounter > 0)
		{
			Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
			byte b2 = 0;
			fadeCounter--;
			float num115 = (float)fadeCounter / 120f * 255f;
			if (quickSplash)
			{
				num115 = (float)fadeCounter / 75f * 255f;
			}
			b2 = (byte)num115;
			white = new Microsoft.Xna.Framework.Color(b2, b2, b2, b2);
			spriteBatch.Draw(TextureAssets.Fade.Value, new Microsoft.Xna.Framework.Rectangle(-5, -5, screenWidth + 10, screenHeight + 10), white);
		}
		spriteBatch.End();
		DrawIMEPanel();
		if (mouseLeft)
		{
			mouseLeftRelease = false;
		}
		else
		{
			mouseLeftRelease = true;
		}
		if (mouseRight)
		{
			mouseRightRelease = false;
		}
		else
		{
			mouseRightRelease = true;
		}
		if (menuMode == num)
		{
			GamepadMainMenuHandler.LastDrew = num;
		}
		action?.Invoke();
	}

	public static void CycleFrameSkipMode()
	{
		int frameSkipMode = (int)FrameSkipMode;
		frameSkipMode++;
		if (frameSkipMode < 0 || frameSkipMode > 2)
		{
			frameSkipMode = 0;
		}
		FrameSkipMode = (FrameSkipMode)frameSkipMode;
	}

	private static void OnSubmitServerPasswordFromRequest(string passwordCandidate)
	{
		Netplay.ServerPassword = passwordCandidate;
		OnSubmitServerPasswordFromRequest();
	}

	private static void OnSubmitServerPasswordFromRequest()
	{
		NetMessage.SendData(38);
		menuMode = 14;
	}

	private static void CanceledGivingServerPassword()
	{
		SoundEngine.PlaySound(11);
		menuMode = 0;
		Netplay.Disconnect = true;
		Netplay.ServerPassword = "";
	}

	private void OnSubmitServerPassword(string passwordCandidate)
	{
		Netplay.ServerPassword = passwordCandidate;
		HostAndPlay();
	}

	private static string NewToken()
	{
		using RandomNumberGenerator randomNumberGenerator = RandomNumberGenerator.Create();
		byte[] array = new byte[16];
		randomNumberGenerator.GetBytes(array);
		return Convert.ToBase64String(array);
	}

	internal static void HostAndPlay()
	{
		string text = "-autoshutdown -password \"" + ConvertToSafeArgument(Netplay.ServerPassword) + "\" -lang " + Language.ActiveCulture.LegacyId;
		if (Platform.IsLinux)
		{
			text = ((IntPtr.Size != 8) ? (text + " -x86") : (text + " -x64"));
		}
		text = ((!ActiveWorldFileData.IsCloudSave) ? (text + SanitizePathArgument("world", worldPathName)) : (text + SanitizePathArgument("cloudworld", worldPathName)));
		text = text + " -worldrollbackstokeep " + WorldRollingBackupsCountToKeep;
		Netplay.HostToken = NewToken();
		text = text + " -hosttoken " + Netplay.HostToken;
		tServer = new Process();
		if (Platform.IsLinux)
		{
			tServer.StartInfo.FileName = "TerrariaServer";
		}
		else if (Platform.IsOSX)
		{
			tServer.StartInfo.FileName = "../MacOS/TerrariaServer";
		}
		else
		{
			tServer.StartInfo.FileName = "TerrariaServer.exe";
		}
		tServer.StartInfo.Arguments = text;
		if (libPath != "")
		{
			ProcessStartInfo startInfo = tServer.StartInfo;
			startInfo.Arguments = startInfo.Arguments + " -loadlib " + libPath;
		}
		tServer.StartInfo.UseShellExecute = false;
		tServer.StartInfo.CreateNoWindow = true;
		if (SocialAPI.Network != null)
		{
			SocialAPI.Network.LaunchLocalServer(tServer, MenuServerMode);
		}
		else
		{
			tServer.Start();
		}
		Netplay.SetRemoteIP("127.0.0.1");
		Netplay.ListenPort = 7777;
		Netplay.IsHostAndPlay = true;
		autoPass = true;
		statusText = Lang.menu[8].Value;
		Netplay.StartTcpClient();
		menuMode = 10;
	}

	private static void ExitServerPasswordMenu()
	{
		if (SocialAPI.Network != null)
		{
			menuMode = 889;
		}
		else
		{
			menuMode = 6;
		}
		Netplay.ServerPassword = "";
	}

	private static bool IsGoodPortAddress(string text)
	{
		if (string.IsNullOrWhiteSpace(text))
		{
			return false;
		}
		ushort result = 0;
		if (!ushort.TryParse(text, out result))
		{
			return false;
		}
		return true;
	}

	private static void OnSubmitServerPort(string candidatePort)
	{
		Netplay.ListenPort = ushort.Parse(candidatePort);
		autoPass = false;
		Netplay.SetRemoteIPAsync(getIP, StartClientGameplay);
		menuMode = 14;
		statusText = Language.GetTextValue("Net.ConnectingTo", getIP);
	}

	public static void OnSubmitServerIP(string inputText)
	{
		getIP = inputText;
		SoundEngine.PlaySound(12);
		menuMode = 131;
		clrInput();
	}

	private static void DrawSocialMediaButtons(Microsoft.Xna.Framework.Color menuColor, float upBump)
	{
		List<TitleLinkButton> titleLinks = TitleLinks;
		Vector2 anchorPosition = new Vector2(18f, (float)(screenHeight - 26) - upBump);
		for (int i = 0; i < titleLinks.Count; i++)
		{
			titleLinks[i].Draw(spriteBatch, anchorPosition);
			anchorPosition.X += 30f;
		}
	}

	private static void DrawVersionNumber(Microsoft.Xna.Framework.Color menuColor, float upBump)
	{
		string text = versionNumber;
		Vector2 vector = FontAssets.MouseText.Value.MeasureString(text);
		vector.X *= 0.5f;
		vector.Y *= 0.5f;
		for (int i = 0; i < 5; i++)
		{
			Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Black;
			if (i == 4)
			{
				color = menuColor;
				color.R = (byte)((255 + color.R) / 2);
				color.G = (byte)((255 + color.R) / 2);
				color.B = (byte)((255 + color.R) / 2);
			}
			color.A = (byte)((float)(int)color.A * 0.3f);
			int num = 0;
			int num2 = 0;
			if (i == 0)
			{
				num = -2;
			}
			if (i == 1)
			{
				num = 2;
			}
			if (i == 2)
			{
				num2 = -2;
			}
			if (i == 3)
			{
				num2 = 2;
			}
			DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.MouseText.Value, text, new Vector2(vector.X + (float)num + 10f, (float)screenHeight - vector.Y + (float)num2 - 2f - upBump), color, 0f, vector, 1f, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
		}
	}

	private static void ClearVisualPostProcessEffects()
	{
		for (int i = 0; i < 13; i++)
		{
			string key = "";
			switch (i)
			{
			case 0:
				key = "Solar";
				break;
			case 1:
				key = "Vortex";
				break;
			case 2:
				key = "Nebula";
				break;
			case 3:
				key = "Stardust";
				break;
			case 4:
				key = "MoonLord";
				break;
			case 5:
				key = "MonolithSolar";
				break;
			case 6:
				key = "MonolithVortex";
				break;
			case 7:
				key = "MonolithNebula";
				break;
			case 8:
				key = "MonolithStardust";
				break;
			case 9:
				key = "Blizzard";
				break;
			case 10:
				key = "HeatDistortion";
				break;
			case 11:
				key = "Sandstorm";
				break;
			case 12:
				key = "MonolithMoonLord";
				break;
			}
			if (SkyManager.Instance[key] != null && SkyManager.Instance[key].IsActive())
			{
				SkyManager.Instance[key].Deactivate();
			}
			if (Overlays.Scene[key] != null && Overlays.Scene[key].IsVisible())
			{
				Overlays.Scene[key].Deactivate();
			}
			if (Terraria.Graphics.Effects.Filters.Scene[key] != null && Terraria.Graphics.Effects.Filters.Scene[key].IsActive())
			{
				Terraria.Graphics.Effects.Filters.Scene[key].Deactivate();
			}
		}
		if (Terraria.Graphics.Effects.Filters.Scene["BloodMoon"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["BloodMoon"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["Graveyard"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["Graveyard"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["Sepia"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["Sepia"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["Noir"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["Noir"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["BloodMoon"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["BloodMoon"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["MoonLordShake"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["MoonLordShake"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["WaterDistortion"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["WaterDistortion"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["CRT"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["CRT"].Deactivate();
		}
		if (Terraria.Graphics.Effects.Filters.Scene["Test2"].IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene["Test2"].Deactivate();
		}
		if (SkyManager.Instance["Martian"].IsActive())
		{
			SkyManager.Instance["Martian"].Deactivate();
		}
		if (SkyManager.Instance["Party"].IsActive())
		{
			SkyManager.Instance["Party"].Deactivate();
		}
		if (SkyManager.Instance["Slime"].IsActive())
		{
			SkyManager.Instance["Slime"].Deactivate();
		}
		if (SkyManager.Instance["Ambience"].IsActive())
		{
			SkyManager.Instance["Ambience"].Deactivate();
		}
		if (SkyManager.Instance["Aurora"].IsActive())
		{
			SkyManager.Instance["Aurora"].Deactivate();
		}
		slimeRain = false;
		slimeRainTime = 0.0;
		slimeWarningTime = 0;
		BirthdayParty.WorldClear();
		LanternNight.WorldClear();
		Sandstorm.WorldClear();
		CreditsRollEvent.Reset();
		maxRaining = 0f;
		raining = false;
		ClearWorldSeedFlags();
	}

	public static void ClearWorldSeedFlags()
	{
		getGoodWorld = false;
		drunkWorld = false;
		tenthAnniversaryWorld = false;
		dontStarveWorld = false;
		notTheBeesWorld = false;
		remixWorld = false;
		noTrapsWorld = false;
		zenithWorld = false;
		skyblockWorld = false;
		vampireSeed = false;
		infectedSeed = false;
		teamBasedSpawnsSeed = false;
		dualDungeonsSeed = false;
	}

	private static void PostDrawMenu(Microsoft.Xna.Framework.Point screenSizeCache, Microsoft.Xna.Framework.Point screenSizeCacheAfterScaling)
	{
		if (ScreenSize == screenSizeCacheAfterScaling)
		{
			screenPosition.Y -= screenSizeCache.Y - screenHeight;
		}
	}

	private void PreDrawMenu(out Microsoft.Xna.Framework.Point screenSizeCache, out Microsoft.Xna.Framework.Point screenSizeCacheAfterScaling)
	{
		float uiScaleWanted = _uiScaleWanted;
		float num = (float)screenHeight / 900f;
		if (num < 1f)
		{
			num = 1f;
		}
		if (SettingDontScaleMainMenuUp)
		{
			num = 1f;
		}
		screenSizeCache = ScreenSize;
		UIScale = num;
		PlayerInput.SetZoom_UI();
		screenSizeCacheAfterScaling = ScreenSize;
		_uiScaleWanted = uiScaleWanted;
		if (_needsMenuUIRecalculation)
		{
			_needsMenuUIRecalculation = false;
			MenuUI.Recalculate();
		}
	}

	private static bool IsBorderlessDisplayAvailable()
	{
		bool result = false;
		if (Platform.IsWindows)
		{
			result = true;
		}
		return result;
	}

	private static void SetDisplayModeAsBorderless(ref int width, ref int height, Form form)
	{
		if (screenBorderless && !graphics.IsFullScreen && screenBorderlessPendingResizes > 0)
		{
			screenBorderlessPendingResizes--;
			System.Drawing.Rectangle bounds = Screen.FromPoint(form.Location).Bounds;
			width = bounds.Width;
			height = bounds.Height;
			TryPickingDefaultUIScale(height);
		}
	}

	private static void ApplyBorderlessResolution(Form form)
	{
		if (screenBorderlessPendingResizes > 0)
		{
			screenBorderlessPendingResizes--;
			System.Drawing.Rectangle bounds = Screen.FromPoint(form.Location).Bounds;
			form.Location = new System.Drawing.Point(bounds.X, bounds.Y);
			form.FormBorderStyle = FormBorderStyle.None;
			form.Width = bounds.Width;
			form.Height = bounds.Height;
		}
	}

	private static void SetBorderlessFormStyle(Form form)
	{
		form.Location = new System.Drawing.Point(0, 0);
		form.FormBorderStyle = FormBorderStyle.None;
	}

	public static void OpenCharacterSelectUI()
	{
		menuMode = 888;
		MenuUI.SetState(_characterSelectMenu);
	}

	public static void OpenReportsMenu()
	{
		List<IProvideReports> list = new List<IProvideReports>();
		list.Add(IssueReporter);
		if (SocialAPI.Workshop != null)
		{
			list.Add(SocialAPI.Workshop.IssueReporter);
		}
		UIReportsPage state = new UIReportsPage(MenuUI.CurrentState, menuMode, list);
		menuMode = 888;
		MenuUI.SetState(state);
	}

	public static void OpenWorldSelectUI()
	{
		menuMode = 888;
		MenuUI.SetState(_worldSelectMenu);
	}

	public static void OpenResourcePacksMenu(UIState uiStateToGoBackTo)
	{
		menuMode = 888;
		MenuUI.SetState(new UIResourcePackSelectionMenu(uiStateToGoBackTo, AssetSourceController, AssetInitializer.CreateResourcePackList(instance.Services)));
	}

	public static void CycleVoiceStyle(Player plr, int offset)
	{
		int num = 0;
		int[] variantOrder = PlayerVoiceID.VariantOrder;
		for (int i = 0; i < variantOrder.Length; i++)
		{
			if (variantOrder[i] == plr.voiceVariant)
			{
				num = i;
				break;
			}
		}
		num = (num + offset) % variantOrder.Length;
		if (num < 0)
		{
			num += variantOrder.Length;
		}
		plr.voiceVariant = variantOrder[num];
	}

	private static void CycleClothingStyle(Player plr)
	{
		CycleClothingStyle_Inner(plr);
		while (!IsValidPlayerStyle(plr))
		{
			CycleClothingStyle_Inner(plr);
		}
	}

	private static bool IsValidPlayerStyle(Player plr)
	{
		int skinVariant = plr.skinVariant;
		if ((uint)(skinVariant - 10) <= 1u)
		{
			return false;
		}
		return true;
	}

	private static void CycleClothingStyle_Inner(Player plr)
	{
		if (plr.Male)
		{
			int num = 0;
			int[] variantOrderMale = PlayerVariantID.Sets.VariantOrderMale;
			for (int i = 0; i < variantOrderMale.Length; i++)
			{
				if (variantOrderMale[i] == plr.skinVariant)
				{
					num = i;
					break;
				}
			}
			if (num == variantOrderMale.Length - 1)
			{
				plr.skinVariant = variantOrderMale[0];
			}
			else
			{
				plr.skinVariant = variantOrderMale[num + 1];
			}
			return;
		}
		int num2 = 0;
		int[] variantOrderFemale = PlayerVariantID.Sets.VariantOrderFemale;
		for (int j = 0; j < variantOrderFemale.Length; j++)
		{
			if (variantOrderFemale[j] == plr.skinVariant)
			{
				num2 = j;
				break;
			}
		}
		if (num2 == variantOrderFemale.Length - 1)
		{
			plr.skinVariant = variantOrderFemale[0];
		}
		else
		{
			plr.skinVariant = variantOrderFemale[num2 + 1];
		}
	}

	public static void ResetKeyBindings()
	{
		cUp = "W";
		cDown = "S";
		cLeft = "A";
		cRight = "D";
		cJump = "Space";
		cThrowItem = "T";
		cInv = "Escape";
		cHeal = "H";
		cMana = "J";
		cBuff = "B";
		cHook = "E";
		cTorch = "LeftShift";
		cSmart = "LeftControl";
		cMount = "R";
	}

	public static void CursorColor()
	{
		cursorAlpha += (float)cursorColorDirection * 0.015f;
		if (cursorAlpha >= 1f)
		{
			cursorAlpha = 1f;
			cursorColorDirection = -1;
		}
		if ((double)cursorAlpha <= 0.6)
		{
			cursorAlpha = 0.6f;
			cursorColorDirection = 1;
		}
		float num = cursorAlpha * 0.3f + 0.7f;
		byte r = (byte)((float)(int)mouseColor.R * cursorAlpha);
		byte g = (byte)((float)(int)mouseColor.G * cursorAlpha);
		byte b = (byte)((float)(int)mouseColor.B * cursorAlpha);
		byte a = (byte)(255f * num);
		cursorColor = new Microsoft.Xna.Framework.Color(r, g, b, a);
		cursorScale = cursorAlpha * 0.3f + 0.7f + 0.1f;
	}

	protected void DrawSplash(GameTime gameTime)
	{
		int num = 10000;
		base.GraphicsDevice.Clear(Microsoft.Xna.Framework.Color.Black);
		base.Draw(gameTime);
		bool flag = false;
		if (!_gameContentLoadProcess.MoveNext())
		{
			flag = true;
		}
		long num2 = splashTimer.ElapsedMilliseconds;
		if (musicVolume == 0f)
		{
			quickSplash = true;
			num2 = 999999L;
		}
		bool flag2 = true;
		bool flag3 = false;
		if (Debugger.IsAttached)
		{
			quickSplash = true;
			flag2 = false;
		}
		if (QuickLoad.QuickLoading || SkipAssemblyLoad)
		{
			quickSplash = true;
			flag3 = true;
			flag2 = false;
		}
		if (Assets.PendingAssets == 0 && flag && (Program.LoadedEverything || !flag2))
		{
			_isAsyncLoadComplete = true;
		}
		spriteBatch.Begin();
		splashCounter++;
		Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
		byte b = 0;
		int num3 = 90;
		int num4 = 410;
		int num5 = 620;
		int num6 = 60;
		int num7 = 120;
		if (quickSplash)
		{
			num3 = 0;
			num4 = 75;
			num5 = 200;
			num6 = 75;
			num7 = 75;
		}
		if (flag3)
		{
			num3 = -1;
			num4 = -1;
			num5 = -1;
		}
		if (splashCounter >= num3)
		{
			if (splashCounter <= num4)
			{
				float num8 = (float)(splashCounter - num3) / (float)(num4 - num3);
				num8 *= num8 * num8 * num8;
				num8 *= 255f;
				b = (byte)num8;
			}
			else if (splashCounter <= num5)
			{
				b = byte.MaxValue;
				if (splashCounter >= num5 - num6)
				{
					b = (byte)((float)(num6 - (splashCounter - (num5 - num6))) / (float)num6 * 255f);
				}
			}
			else if (!_isAsyncLoadComplete)
			{
				b = 0;
				num = 1;
			}
			else
			{
				Initialize_AlmostEverything();
				PostContentLoadInitialize();
				showSplash = false;
				fadeCounter = num7;
				splashTimer.Stop();
			}
		}
		white = new Microsoft.Xna.Framework.Color(b, b, b, b);
		Asset<Texture2D> splashTextureLegoBack = TextureAssets.SplashTextureLegoBack;
		if (splashTextureLegoBack.Width() > 0 && splashTextureLegoBack.Height() > 0)
		{
			Vector2 vector = new Vector2((float)screenWidth / (float)splashTextureLegoBack.Width(), (float)screenHeight / (float)splashTextureLegoBack.Height());
			_ = splashTextureLegoBack.Size() / 2f;
			Vector2 position = new Vector2(screenWidth, screenHeight) / 2f;
			Vector2 scale = vector;
			if (scale.X > scale.Y)
			{
				scale.X = scale.Y;
			}
			else
			{
				scale.Y = scale.X;
			}
			Vector2 scale2 = vector;
			if (scale2.X < scale2.Y)
			{
				scale2.X = scale2.Y;
			}
			else
			{
				scale2.Y = scale2.X;
			}
			spriteBatch.Draw(splashTextureLegoBack.Value, position, null, white, 0f, splashTextureLegoBack.Size() / 2f, scale2, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.SplashTextureLegoTree.Value, ScreenSize.ToVector2(), null, white, 0f, TextureAssets.SplashTextureLegoTree.Size(), scale, SpriteEffects.None, 0f);
			spriteBatch.Draw(TextureAssets.SplashTextureLegoFront.Value, position, null, white, 0f, TextureAssets.SplashTextureLegoFront.Size() / 2f, scale, SpriteEffects.None, 0f);
		}
		int num9 = 70;
		if (num == 1)
		{
			DrawSplash_LoadingFlower(Microsoft.Xna.Framework.Color.White);
		}
		else if (num2 > num)
		{
			DrawSplash_LoadingFlower(white);
		}
		_splashFrameCount += 1f;
		if (_splashFrameCount >= (float)num9)
		{
			_splashFrameCount = 0f;
		}
		spriteBatch.End();
	}

	private void DrawSplash_LoadingFlower(Microsoft.Xna.Framework.Color splashColor)
	{
		float val = (float)screenWidth / (float)MaxWorldViewSize.X;
		float val2 = (float)screenHeight / (float)MaxWorldViewSize.Y;
		float num = Math.Max(Math.Max(1f, val), val2);
		Texture2D value = TextureAssets.LoadingSunflower.Value;
		int num2 = 3;
		int num3 = 19;
		Vector2 position = new Vector2(screenWidth / 2, screenHeight) - new Vector2(0f, 50f) * num;
		int num4 = (int)_splashFrameCount / num2;
		if (num4 >= num3)
		{
			num4 = 0;
		}
		Microsoft.Xna.Framework.Rectangle rectangle = value.Frame(1, num3, 0, (num4 + 10) % num3);
		float rotation = 0f;
		Vector2 origin = rectangle.Size() / 2f;
		spriteBatch.Draw(value, position, rectangle, splashColor, rotation, origin, num, SpriteEffects.None, 0f);
	}

	private void DrawSplash_LoadingStar(Microsoft.Xna.Framework.Color splashColor)
	{
		int num = 4;
		Vector2 position = new Vector2(screenWidth, screenHeight) - new Vector2(30f);
		int num2 = (int)_splashFrameCount / num;
		if (num2 >= 15)
		{
			num2 = 0;
		}
		if (num2 >= 8)
		{
			num2 = 14 - num2;
		}
		Microsoft.Xna.Framework.Rectangle rectangle = TextureAssets.Item[75].Frame(1, 8, 0, num2);
		rectangle.Height -= 2;
		float rotation = 0f;
		Vector2 origin = rectangle.Size() / 2f;
		origin.Y += 2f;
		spriteBatch.Draw(TextureAssets.Item[75].Value, position, rectangle, splashColor, rotation, origin, 1f, SpriteEffects.None, 0f);
	}

	protected void DrawUnderworldBackground(float zoomForPushUp = 1f)
	{
		if (!(screenPosition.Y + (float)screenHeight < (float)(maxTilesY - 220) * 16f))
		{
			Vector2 screenOffset = screenPosition + new Vector2(screenWidth >> 1, screenHeight >> 1);
			float pushUp = (zoomForPushUp - 1f) * 0.5f * 200f;
			SkyManager.Instance.ResetDepthTracker();
			for (int num = 4; num >= 0; num--)
			{
				DrawUnderworldBackgroudLayer(screenOffset, pushUp, num);
			}
			if (!mapFullscreen)
			{
				SkyManager.Instance.DrawRemainingDepth(spriteBatch);
			}
			DrawSurfaceBG_DrawChangeOverlay(12);
		}
	}

	private static void DrawUnderworldBackgroudLayer(Vector2 screenOffset, float pushUp, int layerTextureIndex)
	{
		int num = underworldBG[layerTextureIndex];
		Asset<Texture2D> asset = TextureAssets.Underworld[num];
		if (!asset.IsLoaded)
		{
			Assets.Request<Texture2D>(asset.Name, AssetRequestMode.ImmediateLoad);
		}
		Texture2D value = asset.Value;
		Vector2 vec = new Vector2(value.Width, value.Height) * 0.5f;
		float num2 = (float)(layerTextureIndex * 2) + 3f;
		Vector2 vector = new Vector2(1f / num2);
		Microsoft.Xna.Framework.Rectangle value2 = new Microsoft.Xna.Framework.Rectangle(0, 0, value.Width, value.Height);
		float num3 = 1.3f;
		Vector2 zero = Vector2.Zero;
		int num4 = 0;
		switch (num)
		{
		case 1:
		{
			int num9 = (int)(GlobalTimeWrappedHourly * 8f) % 4;
			value2 = new Microsoft.Xna.Framework.Rectangle((num9 >> 1) * (value.Width >> 1), num9 % 2 * (value.Height >> 1), value.Width >> 1, value.Height >> 1);
			vec *= 0.5f;
			zero.Y += 175f;
			break;
		}
		case 2:
			zero.Y += 100f;
			break;
		case 3:
			zero.Y += 75f;
			break;
		case 4:
			num3 = 0.5f;
			zero.Y -= 0f;
			break;
		case 5:
			zero.Y += num4;
			break;
		case 6:
		{
			int num8 = (int)(GlobalTimeWrappedHourly * 8f) % 4;
			value2 = new Microsoft.Xna.Framework.Rectangle(num8 % 2 * (value.Width >> 1), (num8 >> 1) * (value.Height >> 1), value.Width >> 1, value.Height >> 1);
			vec *= 0.5f;
			zero.Y += num4;
			zero.Y += -60f;
			break;
		}
		case 7:
		{
			int num7 = (int)(GlobalTimeWrappedHourly * 8f) % 4;
			value2 = new Microsoft.Xna.Framework.Rectangle(num7 % 2 * (value.Width >> 1), (num7 >> 1) * (value.Height >> 1), value.Width >> 1, value.Height >> 1);
			vec *= 0.5f;
			zero.Y += num4;
			zero.X -= 400f;
			zero.Y += 90f;
			break;
		}
		case 8:
		{
			int num6 = (int)(GlobalTimeWrappedHourly * 8f) % 4;
			value2 = new Microsoft.Xna.Framework.Rectangle(num6 % 2 * (value.Width >> 1), (num6 >> 1) * (value.Height >> 1), value.Width >> 1, value.Height >> 1);
			vec *= 0.5f;
			zero.Y += num4;
			zero.Y += 90f;
			break;
		}
		case 9:
			zero.Y += num4;
			zero.Y -= 30f;
			break;
		case 10:
			zero.Y += 250f * num2;
			break;
		case 11:
			zero.Y += 100f * num2;
			break;
		case 12:
			zero.Y += 20f * num2;
			break;
		case 13:
		{
			zero.Y += 20f * num2;
			int num5 = (int)(GlobalTimeWrappedHourly * 8f) % 4;
			value2 = new Microsoft.Xna.Framework.Rectangle(num5 % 2 * (value.Width >> 1), (num5 >> 1) * (value.Height >> 1), value.Width >> 1, value.Height >> 1);
			vec *= 0.5f;
			break;
		}
		}
		vec *= num3;
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / vector.X);
		zero.Y -= pushUp;
		float num10 = num3 * (float)value2.Width;
		int num11 = (int)((float)(int)(screenOffset.X * vector.X - vec.X + zero.X - (float)(screenWidth >> 1)) / num10);
		vec = vec.Floor();
		int num12 = (int)Math.Ceiling((float)screenWidth / num10);
		int num13 = (int)(num3 * ((float)(value2.Width - 1) / vector.X));
		Vector2 vec2 = (new Vector2((num11 - 2) * num13, (float)UnderworldLayer * 16f) + vec - screenOffset) * vector + screenOffset - screenPosition - vec + zero;
		vec2 = vec2.Floor();
		while (vec2.X + num10 < 0f)
		{
			num11++;
			vec2.X += num10;
		}
		for (int i = num11 - 2; i <= num11 + 4 + num12; i++)
		{
			spriteBatch.Draw(value, vec2, value2, Microsoft.Xna.Framework.Color.White, 0f, Vector2.Zero, num3, SpriteEffects.None, 0f);
			if (layerTextureIndex == 0)
			{
				int num14 = (int)(vec2.Y + (float)value2.Height * num3);
				spriteBatch.Draw(TextureAssets.BlackTile.Value, new Microsoft.Xna.Framework.Rectangle((int)vec2.X, num14, (int)((float)value2.Width * num3), Math.Max(0, screenHeight - num14)), new Microsoft.Xna.Framework.Color(11, 3, 7));
			}
			vec2.X += num10;
		}
	}

	protected void DrawBackground()
	{
		float num = shimmerAlpha;
		if (num == 1f)
		{
			ugBackTransition = 0f;
			return;
		}
		if (!BackgroundEnabled)
		{
			OldDrawBackground();
			return;
		}
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		tileBatch.Begin();
		Array.Clear(_drawbackground_colorSlices, 0, _drawbackground_colorSlices.Length);
		double num2 = maxTilesY - 330;
		double num3 = (int)((num2 - worldSurface) / 6.0) * 6;
		num2 = worldSurface + num3 - 5.0;
		int q = (int)(255f * (1f - gfxQuality) + 140f * gfxQuality);
		int q2 = (int)(200f * (1f - gfxQuality) + 40f * gfxQuality);
		Vector2 drawOffset = (drawToScreen ? Vector2.Zero : new Vector2(offScreenRange, offScreenRange));
		Vector3 backgroundColor = new Vector3(0.9f);
		float num4 = MathHelper.Clamp((screenPosition.Y - (float)worldSurface * 16f) / 300f, 0f, 1f);
		Lighting.GlobalBrightness = Lighting.GlobalBrightness * (1f - num4) + 1f * num4;
		float value = (float)((double)(screenPosition.Y - (float)(screenHeight / 2) + 200f) - rockLayer * 16.0) / 300f;
		value = MathHelper.Clamp(value, 0f, 1f);
		int num5 = DrawBackground_PickUndergroundBackgroundStyle(num2);
		if (num5 != undergroundBackground)
		{
			oldUndergroundBackground = undergroundBackground;
			undergroundBackground = num5;
			ugBackTransition = 1f;
		}
		if (num > 0f)
		{
			ugBackTransition = 0f;
		}
		if (ugBackTransition > 0f)
		{
			ugBackTransition -= 0.25f;
		}
		if (ugBackTransition < 0f)
		{
			ugBackTransition = 0f;
		}
		DrawBackground_UpdateBackgroundStyles();
		float globalBrightness = 1.2f - 0.2f * value;
		DrawBackground_SurfaceTransitionBackground(num, ref drawOffset, ref backgroundColor);
		DrawBackground_DirtBackground(num, q, q2, ref drawOffset, ref backgroundColor);
		DrawBackground_DrawUnderworldBlackBox(num2, drawOffset);
		hellBlackBoxBottom = screenPosition.Y + (float)screenHeight + 100f;
		DrawBackground_DrawRockLayer(num, num2, q, q2, ref drawOffset, ref backgroundColor);
		DrawBackground_DrawMagmaLayer(num2, q, q2, ref drawOffset, ref backgroundColor);
		Lighting.GlobalBrightness = globalBrightness;
		tileBatch.End();
		TimeLogger.DrawUndergroundBackground.AddTime(fromTimestamp);
	}

	private void DrawBackground_DrawMagmaLayer(double magmaLayer, int q1, int q2, ref Vector2 drawOffset, ref Vector3 backgroundColor)
	{
		float x = backgroundColor.X;
		float y = backgroundColor.Y;
		float z = backgroundColor.Z;
		bgTopY = (float)magmaLayer * 16f - screenPosition.Y + 16f + 600f - 8f;
		bool flag = false;
		int num = 128;
		if (!(magmaLayer * 16.0 <= (double)(screenPosition.Y + (float)screenHeight)))
		{
			return;
		}
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
		if (magmaLayer * 16.0 + (double)screenHeight < (double)(screenPosition.Y - 16f))
		{
			bgStartY = (int)(Math.IEEERemainder(bgTopY, backgroundHeight[2]) - (double)backgroundHeight[2]);
			bgLoopsY = (screenHeight - bgStartY + (int)drawOffset.Y * 2) / backgroundHeight[2] + 1;
		}
		else
		{
			bgStartY = (int)bgTopY;
			bgLoopsY = (int)((float)screenHeight - bgTopY + drawOffset.Y * 2f) / backgroundHeight[2] + 1;
		}
		if ((float)UnderworldLayer * 16f < screenPosition.Y + (float)screenHeight)
		{
			bgLoopsY = (int)Math.Ceiling(((float)UnderworldLayer * 16f - screenPosition.Y - (float)bgStartY) / (float)backgroundHeight[2]);
			flag = true;
		}
		q1 = (int)((double)q1 * 1.5);
		q2 = (int)((double)q2 * 1.5);
		int num2 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
		if (num2 == -8)
		{
			num2 = 8;
		}
		for (int i = 0; i < bgLoops; i++)
		{
			for (int j = 0; j < bgLoopsY; j++)
			{
				for (int k = 0; k < num / 16; k++)
				{
					for (int l = 0; l < 6; l++)
					{
						float num3 = bgStartY + j * 96 + l * 16 + 8;
						int num4 = (int)(((float)(bgStartX + num * i + k * 16 + 8) + screenPosition.X) / 16f);
						int num5 = (int)((num3 + screenPosition.Y) / 16f);
						if (!WorldGen.InWorld(num4, num5, 1))
						{
							continue;
						}
						Microsoft.Xna.Framework.Color color = Lighting.GetColor(num4, num5);
						if ((!ShouldDrawBackgroundTileAt(num4, num5) && color.R != 0 && color.G != 0 && color.B != 0) || (color.R <= 0 && color.G <= 0 && color.B <= 0 && num5 <= maxTilesY - 300) || (!WallLightAt(num4, num5) && caveParallax == 0f))
						{
							continue;
						}
						if (Lighting.NotRetro && color.R < 230 && color.G < 230 && color.B < 230)
						{
							if ((color.R > q1 || (double)(int)color.G > (double)q1 * 1.1 || (double)(int)color.B > (double)q1 * 1.2) && !tile[num4, num5].active())
							{
								Lighting.GetColor9Slice(num4, num5, ref _drawbackground_colorSlices);
								for (int m = 0; m < 9; m++)
								{
									int num6 = 0;
									int num7 = 0;
									int width = 4;
									int height = 4;
									Microsoft.Xna.Framework.Color color2 = color;
									Microsoft.Xna.Framework.Color color3 = color;
									switch (m)
									{
									case 0:
										if (!tile[num4 - 1, num5 - 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 1:
										width = 8;
										num6 = 4;
										if (!tile[num4, num5 - 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 2:
										num6 = 12;
										if (!tile[num4 + 1, num5 - 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 3:
										height = 8;
										num7 = 4;
										if (!tile[num4 - 1, num5].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 4:
										width = 8;
										height = 8;
										num6 = 4;
										num7 = 4;
										break;
									case 5:
										num6 = 12;
										num7 = 4;
										height = 8;
										if (!tile[num4 + 1, num5].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 6:
										num7 = 12;
										if (!tile[num4 - 1, num5 + 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 7:
										width = 8;
										height = 4;
										num6 = 4;
										num7 = 12;
										if (!tile[num4, num5 + 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 8:
										num6 = 12;
										num7 = 12;
										if (!tile[num4 + 1, num5 + 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									}
									color2.R = (byte)((color.R + color3.R) / 2);
									color2.G = (byte)((color.G + color3.G) / 2);
									color2.B = (byte)((color.B + color3.B) / 2);
									color2.R = (byte)((float)(int)color2.R * x);
									color2.G = (byte)((float)(int)color2.G * y);
									color2.B = (byte)((float)(int)color2.B * z);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[5]].Value, new Vector2(bgStartX + num * i + 16 * k + num6 + num2, bgStartY + backgroundHeight[2] * j + 16 * l + num7) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num6 + num2 + 16, 16 * l + backgroundHeight[2] * magmaBGFrame + num7, width, height), color2, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
								}
							}
							else if (color.R > q2 || (double)(int)color.G > (double)q2 * 1.1 || (double)(int)color.B > (double)q2 * 1.2)
							{
								Lighting.GetColor4Slice(num4, num5, ref _drawbackground_colorSlices);
								for (int n = 0; n < 4; n++)
								{
									int num8 = 0;
									int num9 = 0;
									Microsoft.Xna.Framework.Color color4 = color;
									Microsoft.Xna.Framework.Color color5 = _drawbackground_colorSlices[n];
									switch (n)
									{
									case 1:
										num8 = 8;
										break;
									case 2:
										num9 = 8;
										break;
									case 3:
										num8 = 8;
										num9 = 8;
										break;
									}
									color4.R = (byte)((color.R + color5.R) / 2);
									color4.G = (byte)((color.G + color5.G) / 2);
									color4.B = (byte)((color.B + color5.B) / 2);
									color4.R = (byte)((float)(int)color4.R * x);
									color4.G = (byte)((float)(int)color4.G * y);
									color4.B = (byte)((float)(int)color4.B * z);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[5]].Value, new Vector2(bgStartX + num * i + 16 * k + num8 + num2, bgStartY + backgroundHeight[2] * j + 16 * l + num9) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num8 + num2 + 16, 16 * l + backgroundHeight[2] * magmaBGFrame + num9, 8, 8), color4, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
								}
							}
							else
							{
								color.R = (byte)((float)(int)color.R * x);
								color.G = (byte)((float)(int)color.G * y);
								color.B = (byte)((float)(int)color.B * z);
								spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[5]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[2] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l + backgroundHeight[2] * magmaBGFrame, 16, 16), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
							}
						}
						else
						{
							color.R = (byte)((float)(int)color.R * x);
							color.G = (byte)((float)(int)color.G * y);
							color.B = (byte)((float)(int)color.B * z);
							spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[5]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[2] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l + backgroundHeight[2] * magmaBGFrame, 16, 16), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						}
					}
				}
			}
		}
		if (!flag)
		{
			return;
		}
		bgParallax = caveParallax;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
		bgTopY = bgStartY + bgLoopsY * backgroundHeight[2];
		hellBlackBoxBottom = bgTopY + screenPosition.Y;
		for (int num10 = 0; num10 < bgLoops; num10++)
		{
			for (int num11 = 0; num11 < num / 16; num11++)
			{
				float num12 = bgStartX + num * num10 + num11 * 16 + 8;
				float num13 = bgTopY;
				Microsoft.Xna.Framework.Color color6 = Lighting.GetColor((int)((num12 + screenPosition.X) / 16f), (int)((screenPosition.Y + num13) / 16f));
				color6.R = (byte)((float)(int)color6.R * x);
				color6.G = (byte)((float)(int)color6.G * y);
				color6.B = (byte)((float)(int)color6.B * z);
				spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[6]].Value, new Vector2(bgStartX + num * num10 + 16 * num11 + num2, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * num11 + num2 + 16, magmaBGFrame * 16, 16, 16), color6);
				if (ugBackTransition > 0f)
				{
					Microsoft.Xna.Framework.Color color7 = color6;
					color7.R = (byte)((float)(int)color7.R * ugBackTransition);
					color7.G = (byte)((float)(int)color7.G * ugBackTransition);
					color7.B = (byte)((float)(int)color7.B * ugBackTransition);
					color7.A = (byte)((float)(int)color7.A * ugBackTransition);
					spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[6]].Value, new Vector2(bgStartX + num * num10 + 16 * num11 + num2, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * num11 + num2 + 16, magmaBGFrame * 16, 16, 16), color7);
				}
			}
		}
	}

	private int GetRockTransitionPoint()
	{
		int num = ((int)rockLayer - (int)worldSurface) * 16;
		int num2 = num / backgroundHeight[2];
		if (num % backgroundHeight[2] != 0)
		{
			num2++;
		}
		int num3 = num2 * backgroundHeight[2];
		return (int)worldSurface * 16 + num3 + 32;
	}

	private void DrawBackground_DrawRockLayer(float localShimmerAlpha, double magmaLayer, int q1, int q2, ref Vector2 drawOffset, ref Vector3 backgroundColor)
	{
		int rockTransitionPoint = GetRockTransitionPoint();
		bool magmaTransition = (float)rockTransitionPoint <= screenPosition.Y + (float)screenHeight && magmaLayer * 16.0 < (double)(screenPosition.Y + (float)screenHeight);
		int num = rockTransitionPoint;
		double num2 = magmaLayer * 16.0 + 600.0;
		bgTopY = (float)num - screenPosition.Y;
		float x = backgroundColor.X;
		float y = backgroundColor.Y;
		float z = backgroundColor.Z;
		int num3 = 128;
		if (!((float)rockTransitionPoint <= screenPosition.Y + (float)screenHeight))
		{
			return;
		}
		bgParallax = caveParallax;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num3 + 2;
		if ((float)(rockTransitionPoint + screenHeight) < screenPosition.Y - 16f)
		{
			bgStartY = (int)(Math.IEEERemainder(bgTopY, backgroundHeight[3]) - (double)backgroundHeight[3]);
			bgLoopsY = (screenHeight - bgStartY + (int)drawOffset.Y * 2) / backgroundHeight[2] + 1;
		}
		else
		{
			bgStartY = (int)bgTopY;
			bgLoopsY = (int)((float)screenHeight - bgTopY + drawOffset.Y * 2f) / backgroundHeight[2] + 1;
		}
		if (magmaLayer * 16.0 < (double)(screenPosition.Y + (float)screenHeight))
		{
			bgLoopsY = (int)(num2 - (double)bgStartY - (double)screenPosition.Y) / backgroundHeight[2];
		}
		int num4 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
		if (num4 == -8)
		{
			num4 = 8;
		}
		for (int i = 0; i < bgLoops; i++)
		{
			for (int j = 0; j < bgLoopsY; j++)
			{
				for (int k = 0; k < num3 / 16; k++)
				{
					for (int l = 0; l < 6; l++)
					{
						float num5 = bgStartY + j * 96 + l * 16 + 8;
						int num6 = (int)(((float)(bgStartX + num3 * i + k * 16 + 8) + screenPosition.X) / 16f);
						int num7 = (int)((num5 + screenPosition.Y) / 16f);
						if (!WorldGen.InWorld(num6, num7, 1))
						{
							continue;
						}
						Microsoft.Xna.Framework.Color color = Lighting.GetColor(num6, num7);
						if ((!ShouldDrawBackgroundTileAt(num6, num7) && color.R != 0 && color.G != 0 && color.B != 0) || (color.R <= 0 && color.G <= 0 && color.B <= 0) || (!WallLightAt(num6, num7) && caveParallax == 0f))
						{
							continue;
						}
						if (localShimmerAlpha == 0f && Lighting.NotRetro && color.R < 230 && color.G < 230 && color.B < 230 && ugBackTransition == 0f)
						{
							if ((color.R > q1 || (double)(int)color.G > (double)q1 * 1.1 || (double)(int)color.B > (double)q1 * 1.2) && !tile[num6, num7].active())
							{
								Lighting.GetColor9Slice(num6, num7, ref _drawbackground_colorSlices);
								for (int m = 0; m < 9; m++)
								{
									int num8 = 0;
									int num9 = 0;
									int width = 4;
									int height = 4;
									Microsoft.Xna.Framework.Color color2 = color;
									Microsoft.Xna.Framework.Color color3 = color;
									switch (m)
									{
									case 0:
										if (!tile[num6 - 1, num7 - 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 1:
										width = 8;
										num8 = 4;
										if (!tile[num6, num7 - 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 2:
										num8 = 12;
										if (!tile[num6 + 1, num7 - 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 3:
										height = 8;
										num9 = 4;
										if (!tile[num6 - 1, num7].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 4:
										width = 8;
										height = 8;
										num8 = 4;
										num9 = 4;
										break;
									case 5:
										num8 = 12;
										num9 = 4;
										height = 8;
										if (!tile[num6 + 1, num7].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 6:
										num9 = 12;
										if (!tile[num6 - 1, num7 + 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 7:
										width = 8;
										height = 4;
										num8 = 4;
										num9 = 12;
										if (!tile[num6, num7 + 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									case 8:
										num8 = 12;
										num9 = 12;
										if (!tile[num6 + 1, num7 + 1].active())
										{
											color3 = _drawbackground_colorSlices[m];
										}
										break;
									}
									color2.R = (byte)((color.R + color3.R) / 2);
									color2.G = (byte)((color.G + color3.G) / 2);
									color2.B = (byte)((color.B + color3.B) / 2);
									color2.R = (byte)((float)(int)color2.R * x);
									color2.G = (byte)((float)(int)color2.G * y);
									color2.B = (byte)((float)(int)color2.B * z);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num8 + num4, bgStartY + backgroundHeight[_drawBackground_backTexture[3]] * j + 16 * l + num9) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num8 + num4 + 16, 16 * l + num9, width, height), color2);
									if (ugBackTransition > 0f)
									{
										Microsoft.Xna.Framework.Color color4 = color2;
										color4.R = (byte)((float)(int)color4.R * ugBackTransition);
										color4.G = (byte)((float)(int)color4.G * ugBackTransition);
										color4.B = (byte)((float)(int)color4.B * ugBackTransition);
										color4.A = (byte)((float)(int)color4.A * ugBackTransition);
										spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num8 + num4, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[3]] * j + 16 * l + num9) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num8 + num4 + 16, 16 * l + num9, width, height), color4);
									}
								}
							}
							else if (color.R > q2 || (double)(int)color.G > (double)q2 * 1.1 || (double)(int)color.B > (double)q2 * 1.2)
							{
								Lighting.GetColor4Slice(num6, num7, ref _drawbackground_colorSlices);
								for (int n = 0; n < 4; n++)
								{
									int num10 = 0;
									int num11 = 0;
									Microsoft.Xna.Framework.Color color5 = color;
									Microsoft.Xna.Framework.Color color6 = _drawbackground_colorSlices[n];
									switch (n)
									{
									case 1:
										num10 = 8;
										break;
									case 2:
										num11 = 8;
										break;
									case 3:
										num10 = 8;
										num11 = 8;
										break;
									}
									color5.R = (byte)((color.R + color6.R) / 2);
									color5.G = (byte)((color.G + color6.G) / 2);
									color5.B = (byte)((color.B + color6.B) / 2);
									color5.R = (byte)((float)(int)color5.R * x);
									color5.G = (byte)((float)(int)color5.G * y);
									color5.B = (byte)((float)(int)color5.B * z);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num10 + num4, bgStartY + backgroundHeight[_drawBackground_backTexture[3]] * j + 16 * l + num11) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num10 + num4 + 16, 16 * l + num11, 8, 8), color5);
									if (ugBackTransition > 0f)
									{
										Microsoft.Xna.Framework.Color color7 = color5;
										color7.R = (byte)((float)(int)color7.R * ugBackTransition);
										color7.G = (byte)((float)(int)color7.G * ugBackTransition);
										color7.B = (byte)((float)(int)color7.B * ugBackTransition);
										color7.A = (byte)((float)(int)color7.A * ugBackTransition);
										spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num10 + num4, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[3]] * j + 16 * l + num11) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num10 + num4 + 16, 16 * l + num11, 8, 8), color7);
									}
								}
							}
							else
							{
								color.R = (byte)((float)(int)color.R * x);
								color.G = (byte)((float)(int)color.G * y);
								color.B = (byte)((float)(int)color.B * z);
								spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num4, bgStartY + backgroundHeight[_drawBackground_backTexture[3]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num4 + 16, 16 * l, 16, 16), color);
								if (ugBackTransition > 0f)
								{
									Microsoft.Xna.Framework.Color color8 = color;
									color8.R = (byte)((float)(int)color8.R * ugBackTransition);
									color8.G = (byte)((float)(int)color8.G * ugBackTransition);
									color8.B = (byte)((float)(int)color8.B * ugBackTransition);
									color8.A = (byte)((float)(int)color8.A * ugBackTransition);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num4, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[3]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num4 + 16, 16 * l, 16, 16), color8);
								}
							}
						}
						else
						{
							color.R = (byte)((float)(int)color.R * x);
							color.G = (byte)((float)(int)color.G * y);
							color.B = (byte)((float)(int)color.B * z);
							if (localShimmerAlpha > 0f)
							{
								color *= 1f - localShimmerAlpha;
							}
							spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num4, bgStartY + backgroundHeight[_drawBackground_backTexture[3]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num4 + 16, 16 * l, 16, 16), color);
							if (ugBackTransition > 0f)
							{
								Microsoft.Xna.Framework.Color color9 = color;
								color9.R = (byte)((float)(int)color9.R * ugBackTransition);
								color9.G = (byte)((float)(int)color9.G * ugBackTransition);
								color9.B = (byte)((float)(int)color9.B * ugBackTransition);
								color9.A = (byte)((float)(int)color9.A * ugBackTransition);
								spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[3]].Value, new Vector2(bgStartX + num3 * i + 16 * k + num4, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[3]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num4 + 16, 16 * l, 16, 16), color9);
							}
						}
					}
				}
			}
		}
		DrawBackground_DrawMagmaTransition(ref drawOffset, magmaTransition, ref backgroundColor, ref num3, num4);
	}

	private void DrawBackground_DrawMagmaTransition(ref Vector2 drawOffset, bool magmaTransition, ref Vector3 backgroundColor, ref int backgroundWidth, int diff)
	{
		float x = backgroundColor.X;
		float y = backgroundColor.Y;
		float z = backgroundColor.Z;
		backgroundWidth = 128;
		if (!magmaTransition)
		{
			return;
		}
		bgParallax = caveParallax;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)backgroundWidth + (double)screenPosition.X * bgParallax, backgroundWidth) - (double)(backgroundWidth / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / backgroundWidth + 2;
		bgTopY = bgStartY + bgLoopsY * backgroundHeight[2];
		for (int i = 0; i < bgLoops; i++)
		{
			for (int j = 0; j < backgroundWidth / 16; j++)
			{
				float num = bgStartX + backgroundWidth * i + j * 16 + 8;
				float num2 = bgTopY;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)((num + screenPosition.X) / 16f), (int)((screenPosition.Y + num2) / 16f));
				color.R = (byte)((float)(int)color.R * x);
				color.G = (byte)((float)(int)color.G * y);
				color.B = (byte)((float)(int)color.B * z);
				spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[4]].Value, new Vector2(bgStartX + backgroundWidth * i + 16 * j + diff, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * j + diff + 16, magmaBGFrame * 16, 16, 16), color);
				if (ugBackTransition > 0f)
				{
					Microsoft.Xna.Framework.Color color2 = color;
					color2.R = (byte)((float)(int)color2.R * ugBackTransition);
					color2.G = (byte)((float)(int)color2.G * ugBackTransition);
					color2.B = (byte)((float)(int)color2.B * ugBackTransition);
					color2.A = (byte)((float)(int)color2.A * ugBackTransition);
					spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[4]].Value, new Vector2(bgStartX + backgroundWidth * i + 16 * j + diff, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * j + diff + 16, magmaBGFrame * 16, 16, 16), color2);
				}
			}
		}
	}

	private void DrawBackground_DrawUnderworldBlackBox(double magmaLayer, Vector2 drawOffset)
	{
		if (!(magmaLayer * 16.0 <= (double)(screenPosition.Y + (float)screenHeight)) || (remixWorld && maxTilesX < 5000))
		{
			return;
		}
		int y = 0;
		int x = 0;
		int num = screenHeight + 200;
		int width = screenWidth + 100;
		if ((float)UnderworldLayer * 16f < screenPosition.Y + (float)screenHeight)
		{
			int num2 = (int)(hellBlackBoxBottom - screenPosition.Y + drawOffset.Y);
			if (num > num2)
			{
				num = num2;
			}
		}
		spriteBatch.Draw(TextureAssets.BlackTile.Value, new Microsoft.Xna.Framework.Rectangle(x, y, width, num), new Microsoft.Xna.Framework.Color(0, 0, 0));
	}

	private void DrawBackground_DirtBackground(float localShimmerAlpha, int q1, int q2, ref Vector2 drawOffset, ref Vector3 backgroundColor)
	{
		int rockTransitionPoint = GetRockTransitionPoint();
		float x = backgroundColor.X;
		float y = backgroundColor.Y;
		float z = backgroundColor.Z;
		bgTopY = (float)worldSurface * 16f - screenPosition.Y + 16f;
		bool flag = false;
		if (!(worldSurface * 16.0 <= (double)(screenPosition.Y + (float)screenHeight + (float)offScreenRange)))
		{
			return;
		}
		bgParallax = caveParallax;
		int num = TextureAssets.Background[_drawBackground_backTexture[1]].Width() - 32;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
		if (worldSurface * 16.0 < (double)(screenPosition.Y - 16f))
		{
			bgStartY = (int)(Math.IEEERemainder(bgTopY, backgroundHeight[2]) - (double)backgroundHeight[2]);
			bgLoopsY = (screenHeight - bgStartY + (int)drawOffset.Y * 2) / backgroundHeight[2] + 1;
		}
		else
		{
			bgStartY = (int)bgTopY;
			bgLoopsY = (int)((float)screenHeight - bgTopY + drawOffset.Y * 2f) / backgroundHeight[2] + 1;
		}
		if ((float)rockTransitionPoint < Camera.ScaledPosition.Y + (float)screenHeight - 16f)
		{
			bgLoopsY = (int)((float)rockTransitionPoint - screenPosition.Y - (float)bgStartY) / backgroundHeight[2];
			flag = true;
		}
		int num2 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
		if (num2 == -8)
		{
			num2 = 8;
		}
		for (int i = 0; i < bgLoops; i++)
		{
			for (int j = 0; j < bgLoopsY; j++)
			{
				for (int k = 0; k < num / 16; k++)
				{
					for (int l = 0; l < 6; l++)
					{
						float num3 = bgStartY + j * 96 + l * 16 + 8;
						int num4 = (int)(((float)(bgStartX + num * i + k * 16 + 8) + screenPosition.X) / 16f);
						int num5 = (int)((num3 + screenPosition.Y) / 16f);
						Microsoft.Xna.Framework.Color color = Lighting.GetColor(num4, num5);
						if (!WorldGen.InWorld(num4, num5))
						{
							continue;
						}
						if (tile[num4, num5] == null)
						{
							tile[num4, num5] = new Tile();
						}
						if (localShimmerAlpha == 0f && (color.R > 0 || color.G > 0 || color.B > 0))
						{
							if (!drawToScreen)
							{
								Lighting.GetCornerColors(num4, num5, out var vertices);
								vertices.BottomLeftColor = new Microsoft.Xna.Framework.Color(vertices.BottomLeftColor.ToVector3() * backgroundColor);
								vertices.BottomRightColor = new Microsoft.Xna.Framework.Color(vertices.BottomRightColor.ToVector3() * backgroundColor);
								tileBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[_drawBackground_backTexture[1]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l, 16, 16), vertices, Vector2.Zero, 1f, SpriteEffects.None);
							}
							else if ((color.R > q1 || (double)(int)color.G > (double)q1 * 1.1 || (double)(int)color.B > (double)q1 * 1.2) && !tile[num4, num5].active() && WallLightAt(num4, num5) && ugBackTransition == 0f)
							{
								Lighting.GetColor9Slice(num4, num5, ref _drawbackground_colorSlices);
								try
								{
									for (int m = 0; m < 9; m++)
									{
										int num6 = 0;
										int num7 = 0;
										int width = 4;
										int height = 4;
										Microsoft.Xna.Framework.Color color2 = color;
										Microsoft.Xna.Framework.Color color3 = color;
										switch (m)
										{
										case 0:
											if (!tile[num4 - 1, num5 - 1].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 1:
											width = 8;
											num6 = 4;
											if (!tile[num4, num5 - 1].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 2:
											num6 = 12;
											if (!tile[num4 + 1, num5 - 1].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 3:
											height = 8;
											num7 = 4;
											if (!tile[num4 - 1, num5].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 4:
											width = 8;
											height = 8;
											num6 = 4;
											num7 = 4;
											break;
										case 5:
											num6 = 12;
											num7 = 4;
											height = 8;
											if (!tile[num4 + 1, num5].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 6:
											num7 = 12;
											if (!tile[num4 - 1, num5 + 1].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 7:
											width = 8;
											height = 4;
											num6 = 4;
											num7 = 12;
											if (!tile[num4, num5 + 1].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										case 8:
											num6 = 12;
											num7 = 12;
											if (!tile[num4 + 1, num5 + 1].active())
											{
												color3 = _drawbackground_colorSlices[m];
											}
											break;
										}
										color2.R = (byte)((color.R + color3.R) / 2);
										color2.G = (byte)((color.G + color3.G) / 2);
										color2.B = (byte)((color.B + color3.B) / 2);
										color2.R = (byte)((float)(int)color2.R * x);
										color2.G = (byte)((float)(int)color2.G * y);
										color2.B = (byte)((float)(int)color2.B * z);
										spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num6 + num2, bgStartY + backgroundHeight[_drawBackground_backTexture[1]] * j + 16 * l + num7) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num6 + num2 + 16, 16 * l + num7, width, height), color2);
										if (ugBackTransition > 0f)
										{
											Microsoft.Xna.Framework.Color color4 = color2;
											color4.R = (byte)((float)(int)color4.R * ugBackTransition);
											color4.G = (byte)((float)(int)color4.G * ugBackTransition);
											color4.B = (byte)((float)(int)color4.B * ugBackTransition);
											color4.A = (byte)((float)(int)color4.A * ugBackTransition);
											spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num6 + num2, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[1]] * j + 16 * l + num7) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num6 + num2 + 16, 16 * l + num7, width, height), color4);
										}
									}
								}
								catch
								{
									color.R = (byte)((float)(int)color.R * x);
									color.G = (byte)((float)(int)color.G * y);
									color.B = (byte)((float)(int)color.B * z);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[_drawBackground_backTexture[1]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l, 16, 16), color);
								}
							}
							else if ((color.R > q2 || (double)(int)color.G > (double)q2 * 1.1 || (double)(int)color.B > (double)q2 * 1.2) && ugBackTransition == 0f)
							{
								Lighting.GetColor4Slice(num4, num5, ref _drawbackground_colorSlices);
								for (int n = 0; n < 4; n++)
								{
									int num8 = 0;
									int num9 = 0;
									Microsoft.Xna.Framework.Color color5 = color;
									Microsoft.Xna.Framework.Color color6 = _drawbackground_colorSlices[n];
									switch (n)
									{
									case 1:
										num8 = 8;
										break;
									case 2:
										num9 = 8;
										break;
									case 3:
										num8 = 8;
										num9 = 8;
										break;
									}
									color5.R = (byte)((color.R + color6.R) / 2);
									color5.G = (byte)((color.G + color6.G) / 2);
									color5.B = (byte)((color.B + color6.B) / 2);
									color5.R = (byte)((float)(int)color5.R * x);
									color5.G = (byte)((float)(int)color5.G * y);
									color5.B = (byte)((float)(int)color5.B * z);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num8 + num2, bgStartY + backgroundHeight[_drawBackground_backTexture[1]] * j + 16 * l + num9) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num8 + num2 + 16, 16 * l + num9, 8, 8), color5);
									if (ugBackTransition > 0f)
									{
										Microsoft.Xna.Framework.Color color7 = color5;
										color7.R = (byte)((float)(int)color7.R * ugBackTransition);
										color7.G = (byte)((float)(int)color7.G * ugBackTransition);
										color7.B = (byte)((float)(int)color7.B * ugBackTransition);
										color7.A = (byte)((float)(int)color7.A * ugBackTransition);
										spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num8 + num2, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[1]] * j + 16 * l + num9) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num8 + num2 + 16, 16 * l + num9, 8, 8), color7);
									}
								}
							}
							else
							{
								color.R = (byte)((float)(int)color.R * x);
								color.G = (byte)((float)(int)color.G * y);
								color.B = (byte)((float)(int)color.B * z);
								spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[_drawBackground_backTexture[1]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l, 16, 16), color);
								if (ugBackTransition > 0f)
								{
									Microsoft.Xna.Framework.Color color8 = color;
									color8.R = (byte)((float)(int)color8.R * ugBackTransition);
									color8.G = (byte)((float)(int)color8.G * ugBackTransition);
									color8.B = (byte)((float)(int)color8.B * ugBackTransition);
									color8.A = (byte)((float)(int)color8.A * ugBackTransition);
									spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[1]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l, 16, 16), color8);
								}
							}
						}
						else
						{
							color.R = (byte)((float)(int)color.R * x);
							color.G = (byte)((float)(int)color.G * y);
							color.B = (byte)((float)(int)color.B * z);
							if (localShimmerAlpha > 0f)
							{
								color *= 1f - localShimmerAlpha;
							}
							spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[1]].Value, new Vector2(bgStartX + num * i + 16 * k + num2, bgStartY + backgroundHeight[_drawBackground_backTexture[1]] * j + 16 * l) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * k + num2 + 16, 16 * l, 16, 16), color);
						}
					}
				}
			}
		}
		if (ugBackTransition > 0f)
		{
			num = TextureAssets.Background[_drawBackground_oldBackTexture[1]].Width() - 32;
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
			bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
			num2 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
			if (num2 == -8)
			{
				num2 = 8;
			}
			for (int num10 = 0; num10 < bgLoops; num10++)
			{
				for (int num11 = 0; num11 < bgLoopsY; num11++)
				{
					for (int num12 = 0; num12 < num / 16; num12++)
					{
						for (int num13 = 0; num13 < 6; num13++)
						{
							float num14 = bgStartY + num11 * 96 + num13 * 16 + 8;
							int num15 = (int)(((float)(bgStartX + num * num10 + num12 * 16 + 8) + screenPosition.X) / 16f);
							int num16 = (int)((num14 + screenPosition.Y) / 16f);
							if (WorldGen.InWorld(num15, num16))
							{
								Microsoft.Xna.Framework.Color color9 = Lighting.GetColor(num15, num16);
								if (tile[num15, num16] == null)
								{
									tile[num15, num16] = new Tile();
								}
								if (color9.R > 0 || color9.G > 0 || color9.B > 0)
								{
									Lighting.GetCornerColors(num15, num16, out var vertices2, ugBackTransition);
									byte a = (byte)(255f * ugBackTransition);
									vertices2.BottomLeftColor.A = a;
									vertices2.BottomRightColor.A = a;
									vertices2.TopLeftColor.A = a;
									vertices2.TopRightColor.A = a;
									tileBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[1]].Value, new Vector2(bgStartX + num * num10 + 16 * num12 + num2, bgStartY + backgroundHeight[_drawBackground_oldBackTexture[1]] * num11 + 16 * num13) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * num12 + num2 + 16, 16 * num13, 16, 16), vertices2, Vector2.Zero, 1f, SpriteEffects.None);
								}
							}
						}
					}
				}
			}
		}
		num = 128;
		if (!flag)
		{
			return;
		}
		bgParallax = caveParallax;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
		bgTopY = (float)rockTransitionPoint - screenPosition.Y - 16f;
		if (!(bgTopY > -32f))
		{
			return;
		}
		for (int num17 = 0; num17 < bgLoops; num17++)
		{
			for (int num18 = 0; num18 < num / 16; num18++)
			{
				float num19 = bgStartX + num * num17 + num18 * 16 + 8;
				float num20 = bgTopY;
				Microsoft.Xna.Framework.Color color10 = Lighting.GetColor((int)((num19 + screenPosition.X) / 16f), (int)((screenPosition.Y + num20) / 16f));
				color10.R = (byte)((float)(int)color10.R * x);
				color10.G = (byte)((float)(int)color10.G * y);
				color10.B = (byte)((float)(int)color10.B * z);
				if (localShimmerAlpha > 0f)
				{
					color10 *= 1f - localShimmerAlpha;
				}
				spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[2]].Value, new Vector2(bgStartX + num * num17 + 16 * num18 + num2, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * num18 + num2 + 16, 0, 16, 16), color10);
				if (ugBackTransition > 0f)
				{
					Microsoft.Xna.Framework.Color color11 = color10;
					color11.R = (byte)((float)(int)color11.R * ugBackTransition);
					color11.G = (byte)((float)(int)color11.G * ugBackTransition);
					color11.B = (byte)((float)(int)color11.B * ugBackTransition);
					color11.A = (byte)((float)(int)color11.A * ugBackTransition);
					spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[2]].Value, new Vector2(bgStartX + num * num17 + 16 * num18 + num2, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * num18 + num2 + 16, 0, 16, 16), color11);
				}
			}
		}
	}

	private void DrawBackground_SurfaceTransitionBackground(float localShimmerAlpha, ref Vector2 drawOffset, ref Vector3 backgroundColor)
	{
		int num = TextureAssets.Background[_drawBackground_backTexture[0]].Width() - 32;
		bgParallax = caveParallax;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
		bgTopY = (float)worldSurface * 16f - 16f - screenPosition.Y + 16f;
		float x = backgroundColor.X;
		float y = backgroundColor.Y;
		float z = backgroundColor.Z;
		for (int i = 0; i < bgLoops; i++)
		{
			for (int j = 0; j < num / 16; j++)
			{
				int num2 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
				if (num2 == -8)
				{
					num2 = 8;
				}
				float num3 = bgStartX + num * i + j * 16 + 8;
				float num4 = bgTopY;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)((num3 + screenPosition.X) / 16f), (int)((screenPosition.Y + num4) / 16f));
				color.R = (byte)((float)(int)color.R * x);
				color.G = (byte)((float)(int)color.G * y);
				color.B = (byte)((float)(int)color.B * z);
				if (localShimmerAlpha > 0f)
				{
					color *= 1f - localShimmerAlpha;
				}
				spriteBatch.Draw(TextureAssets.Background[_drawBackground_backTexture[0]].Value, new Vector2(bgStartX + num * i + 16 * j + num2, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * j + num2 + 16, 0, 16, 16), color);
			}
		}
		if (!(ugBackTransition > 0f))
		{
			return;
		}
		num = TextureAssets.Background[_drawBackground_oldBackTexture[0]].Width() - 32;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num + (double)screenPosition.X * bgParallax, num) - (double)(num / 2)) - (int)drawOffset.X;
		bgLoops = (screenWidth + (int)drawOffset.X * 2) / num + 2;
		for (int k = 0; k < bgLoops; k++)
		{
			for (int l = 0; l < num / 16; l++)
			{
				int num5 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
				if (num5 == -8)
				{
					num5 = 8;
				}
				float num6 = bgStartX + num * k + l * 16 + 8;
				float num7 = bgTopY;
				Microsoft.Xna.Framework.Color color2 = Lighting.GetColor((int)((num6 + screenPosition.X) / 16f), (int)((screenPosition.Y + num7) / 16f));
				color2.R = (byte)((float)(int)color2.R * x);
				color2.G = (byte)((float)(int)color2.G * y);
				color2.B = (byte)((float)(int)color2.B * z);
				Microsoft.Xna.Framework.Color color3 = color2;
				color3.R = (byte)((float)(int)color3.R * ugBackTransition);
				color3.G = (byte)((float)(int)color3.G * ugBackTransition);
				color3.B = (byte)((float)(int)color3.B * ugBackTransition);
				color3.A = (byte)((float)(int)color3.A * ugBackTransition);
				spriteBatch.Draw(TextureAssets.Background[_drawBackground_oldBackTexture[0]].Value, new Vector2(bgStartX + num * k + 16 * l + num5, bgTopY) + drawOffset, new Microsoft.Xna.Framework.Rectangle(16 * l + num5 + 16, 0, 16, 16), color3);
			}
		}
	}

	private void DrawBackground_UpdateBackgroundStyles()
	{
		Array.Clear(_drawBackground_backTexture, 0, _drawBackground_backTexture.Length);
		Array.Clear(_drawBackground_oldBackTexture, 0, _drawBackground_oldBackTexture.Length);
		for (int i = 0; i < 2; i++)
		{
			int num = undergroundBackground;
			if (i == 1)
			{
				num = oldUndergroundBackground;
			}
			Array.Clear(_drawBackground_tempBack, 0, _drawBackground_tempBack.Length);
			switch (num)
			{
			case 0:
				_drawBackground_tempBack[0] = 1;
				_drawBackground_tempBack[1] = 2;
				_drawBackground_tempBack[2] = 4;
				_drawBackground_tempBack[3] = 3;
				_drawBackground_tempBack[4] = 6;
				_drawBackground_tempBack[5] = 5;
				break;
			case 1:
				if (iceBackStyle == 0)
				{
					_drawBackground_tempBack[1] = 33;
					_drawBackground_tempBack[3] = 32;
					_drawBackground_tempBack[0] = 40;
					_drawBackground_tempBack[2] = 34;
				}
				else if (iceBackStyle == 1)
				{
					_drawBackground_tempBack[1] = 118;
					_drawBackground_tempBack[3] = 117;
					_drawBackground_tempBack[0] = 160;
					_drawBackground_tempBack[2] = 161;
				}
				else if (iceBackStyle == 2)
				{
					_drawBackground_tempBack[1] = 165;
					_drawBackground_tempBack[3] = 167;
					_drawBackground_tempBack[0] = 164;
					_drawBackground_tempBack[2] = 166;
				}
				else
				{
					_drawBackground_tempBack[1] = 120;
					_drawBackground_tempBack[3] = 119;
					_drawBackground_tempBack[0] = 162;
					_drawBackground_tempBack[2] = 163;
				}
				_drawBackground_tempBack[4] = 128 + hellBackStyle;
				break;
			case 2:
				_drawBackground_tempBack[0] = 62;
				_drawBackground_tempBack[1] = 63;
				_drawBackground_tempBack[2] = 64;
				_drawBackground_tempBack[3] = 65;
				_drawBackground_tempBack[4] = 143 + hellBackStyle;
				break;
			case 3:
				_drawBackground_tempBack[0] = 66;
				_drawBackground_tempBack[1] = 67;
				_drawBackground_tempBack[2] = 68;
				_drawBackground_tempBack[3] = 69;
				_drawBackground_tempBack[4] = 128 + hellBackStyle;
				break;
			case 4:
				_drawBackground_tempBack[0] = 70;
				_drawBackground_tempBack[1] = 71;
				_drawBackground_tempBack[2] = 68;
				_drawBackground_tempBack[3] = 72;
				_drawBackground_tempBack[4] = 128 + hellBackStyle;
				break;
			case 5:
				_drawBackground_tempBack[0] = 73;
				_drawBackground_tempBack[1] = 74;
				_drawBackground_tempBack[2] = 75;
				_drawBackground_tempBack[3] = 76;
				_drawBackground_tempBack[4] = 131 + hellBackStyle;
				break;
			case 6:
				_drawBackground_tempBack[0] = 77;
				_drawBackground_tempBack[1] = 78;
				_drawBackground_tempBack[2] = 79;
				_drawBackground_tempBack[3] = 80;
				_drawBackground_tempBack[4] = 134 + hellBackStyle;
				break;
			case 7:
				_drawBackground_tempBack[0] = 77;
				_drawBackground_tempBack[1] = 81;
				_drawBackground_tempBack[2] = 79;
				_drawBackground_tempBack[3] = 82;
				_drawBackground_tempBack[4] = 134 + hellBackStyle;
				break;
			case 8:
				_drawBackground_tempBack[0] = 83;
				_drawBackground_tempBack[1] = 84;
				_drawBackground_tempBack[2] = 85;
				_drawBackground_tempBack[3] = 86;
				_drawBackground_tempBack[4] = 137 + hellBackStyle;
				break;
			case 9:
				_drawBackground_tempBack[0] = 83;
				_drawBackground_tempBack[1] = 87;
				_drawBackground_tempBack[2] = 88;
				_drawBackground_tempBack[3] = 89;
				_drawBackground_tempBack[4] = 137 + hellBackStyle;
				break;
			case 10:
				_drawBackground_tempBack[0] = 121;
				_drawBackground_tempBack[1] = 122;
				_drawBackground_tempBack[2] = 123;
				_drawBackground_tempBack[3] = 124;
				_drawBackground_tempBack[4] = 140 + hellBackStyle;
				break;
			case 11:
				if (jungleBackStyle == 0)
				{
					_drawBackground_tempBack[0] = 153;
					_drawBackground_tempBack[1] = 147;
					_drawBackground_tempBack[2] = 148;
					_drawBackground_tempBack[3] = 149;
					_drawBackground_tempBack[4] = 150 + hellBackStyle;
				}
				else
				{
					_drawBackground_tempBack[0] = 146;
					_drawBackground_tempBack[1] = 154;
					_drawBackground_tempBack[2] = 155;
					_drawBackground_tempBack[3] = 156;
					_drawBackground_tempBack[4] = 157 + hellBackStyle;
				}
				break;
			case 12:
			case 13:
			case 14:
				_drawBackground_tempBack[0] = 66;
				_drawBackground_tempBack[1] = 67;
				_drawBackground_tempBack[2] = 68;
				_drawBackground_tempBack[4] = 128 + hellBackStyle;
				switch (num)
				{
				case 12:
					_drawBackground_tempBack[3] = 193 + worldID % 4;
					break;
				case 13:
					_drawBackground_tempBack[3] = 188 + worldID % 5;
					break;
				case 14:
					_drawBackground_tempBack[3] = 197 + worldID % 3;
					break;
				}
				break;
			default:
				if (num >= 15 && num <= 17)
				{
					_drawBackground_tempBack[0] = 40;
					_drawBackground_tempBack[1] = 33;
					_drawBackground_tempBack[2] = 34;
					_drawBackground_tempBack[4] = 128 + hellBackStyle;
					switch (num)
					{
					case 15:
						_drawBackground_tempBack[3] = 200;
						break;
					case 16:
						_drawBackground_tempBack[3] = 201 + worldID % 2;
						break;
					case 17:
						_drawBackground_tempBack[3] = 203 + worldID % 4;
						break;
					}
					break;
				}
				switch (num)
				{
				case 18:
					_drawBackground_tempBack[0] = 290;
					_drawBackground_tempBack[1] = 291;
					break;
				case 19:
					_drawBackground_tempBack[0] = 292;
					_drawBackground_tempBack[1] = 293;
					break;
				case 20:
					_drawBackground_tempBack[0] = 294;
					_drawBackground_tempBack[1] = 295;
					break;
				case 21:
					_drawBackground_tempBack[0] = 296;
					_drawBackground_tempBack[1] = 297;
					break;
				}
				break;
			}
			if (hellBackStyle == 0)
			{
				_drawBackground_tempBack[5] = 125;
			}
			if (hellBackStyle == 1)
			{
				_drawBackground_tempBack[5] = 126;
			}
			if (hellBackStyle == 2)
			{
				_drawBackground_tempBack[5] = 127;
			}
			_drawBackground_tempBack[6] = 185 + hellBackStyle;
			LoadBackground(_drawBackground_tempBack[0]);
			LoadBackground(_drawBackground_tempBack[1]);
			LoadBackground(_drawBackground_tempBack[2]);
			LoadBackground(_drawBackground_tempBack[3]);
			LoadBackground(_drawBackground_tempBack[4]);
			LoadBackground(_drawBackground_tempBack[5]);
			LoadBackground(_drawBackground_tempBack[6]);
			if (i == 0)
			{
				for (int j = 0; j < 7; j++)
				{
					_drawBackground_backTexture[j] = _drawBackground_tempBack[j];
				}
			}
			else
			{
				for (int k = 0; k < 7; k++)
				{
					_drawBackground_oldBackTexture[k] = _drawBackground_tempBack[k];
				}
			}
		}
	}

	private static int DrawBackground_PickUndergroundBackgroundStyle(double magmaLayer)
	{
		int num = (int)((screenPosition.X + (float)(screenWidth / 2)) / 16f);
		int num2 = 3;
		num2 = ((num <= caveBackX[0]) ? caveBackStyle[0] : ((num <= caveBackX[1]) ? caveBackStyle[1] : ((num > caveBackX[2]) ? caveBackStyle[3] : caveBackStyle[2])));
		num2 += 3;
		if (SceneMetrics.SnowTileCount > SceneMetrics.SnowTileThreshold && (screenPosition.Y + (float)screenHeight + 1200f) / 16f < (float)(maxTilesY - 250))
		{
			num2 = 1;
		}
		if (SceneMetrics.JungleTileCount > SceneMetrics.JungleTileThreshold)
		{
			if (num2 == 1)
			{
				if (SceneMetrics.JungleTileCount > SceneMetrics.SnowTileCount)
				{
					num2 = 11;
				}
			}
			else
			{
				num2 = 11;
			}
		}
		if (SceneMetrics.ZoneBeach)
		{
			num2 = (SceneMetrics.ZoneCorrupt ? 19 : (SceneMetrics.ZoneCrimson ? 21 : ((!SceneMetrics.ZoneHallow) ? 18 : 20)));
		}
		else if ((double)(screenPosition.Y / 16f) > rockLayer + 60.0 && (double)(screenPosition.Y / 16f) < magmaLayer - 60.0)
		{
			if (SceneMetrics.ZoneSnow)
			{
				if (SceneMetrics.ZoneCorrupt)
				{
					num2 = 15;
				}
				else if (SceneMetrics.ZoneCrimson)
				{
					num2 = 16;
				}
				else if (SceneMetrics.ZoneHallow)
				{
					num2 = 17;
				}
			}
			else if (SceneMetrics.ZoneCorrupt)
			{
				num2 = 12;
			}
			else if (SceneMetrics.ZoneCrimson)
			{
				num2 = 13;
			}
			else if (SceneMetrics.ZoneHallow)
			{
				num2 = 14;
			}
		}
		if (SceneMetrics.ZoneGlowshroom)
		{
			num2 = 2;
		}
		return num2;
	}

	protected void OldDrawBackground()
	{
		Microsoft.Xna.Framework.Color[] slices = new Microsoft.Xna.Framework.Color[9];
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		tileBatch.Begin();
		int num = (int)(255f * (1f - gfxQuality) + 140f * gfxQuality);
		int num2 = (int)(200f * (1f - gfxQuality) + 40f * gfxQuality);
		int num3 = 128;
		Vector2 vector = new Vector2(offScreenRange, offScreenRange);
		if (drawToScreen)
		{
			vector = Vector2.Zero;
		}
		float num6;
		float num5;
		float num4 = (num5 = (num6 = 0.9f));
		float num7 = 0f;
		if (SceneMetrics.BloodTileCount > SceneMetrics.EvilTileCount && SceneMetrics.BloodTileCount > SceneMetrics.HolyTileCount)
		{
			num7 = SceneMetrics.BloodTileCount;
		}
		else if (SceneMetrics.HolyTileCount > SceneMetrics.EvilTileCount)
		{
			num7 = SceneMetrics.HolyTileCount;
		}
		else if (SceneMetrics.EvilTileCount > SceneMetrics.HolyTileCount)
		{
			num7 = SceneMetrics.EvilTileCount;
		}
		num7 = MathHelper.Clamp(num7 / 800f, 0f, 1f);
		float num8 = (float)((double)screenPosition.Y - worldSurface * 16.0) / 300f;
		if (num8 < 0f)
		{
			num8 = 0f;
		}
		else if (num8 > 1f)
		{
			num8 = 1f;
		}
		float num9 = 1f * (1f - num8) + num6 * num8;
		float globalBrightness = Lighting.GlobalBrightness;
		Lighting.GlobalBrightness = globalBrightness * (1f - num8) + 1f * num8;
		float value = (float)((double)(screenPosition.Y - (float)(screenHeight / 2) + 200f) - rockLayer * 16.0) / 300f;
		value = MathHelper.Clamp(value, 0f, 1f);
		if (SceneMetrics.BloodTileCount > SceneMetrics.EvilTileCount && SceneMetrics.BloodTileCount > SceneMetrics.HolyTileCount)
		{
			num6 = 1f * num7 + num6 * (1f - num7);
			num5 = 0.55f * num7 + num5 * (1f - num7);
			num4 = 0.5f * num7 + num4 * (1f - num7);
		}
		else if (SceneMetrics.EvilTileCount > 0)
		{
			num6 = 0.8f * num7 + num6 * (1f - num7);
			num5 = 0.75f * num7 + num5 * (1f - num7);
			num4 = 1.1f * num7 + num4 * (1f - num7);
		}
		else if (SceneMetrics.HolyTileCount > 0)
		{
			num6 = 1f * num7 + num6 * (1f - num7);
			num5 = 0.7f * num7 + num5 * (1f - num7);
			num4 = 0.9f * num7 + num4 * (1f - num7);
		}
		num6 = 1f * (num9 - value) + num6 * value;
		num5 = 1f * (num9 - value) + num5 * value;
		num4 = 1f * (num9 - value) + num4 * value;
		int num10 = (int)((screenPosition.X + (float)(screenWidth / 2)) / 16f);
		int num11 = 3;
		num11 = ((num10 <= caveBackX[0]) ? caveBackStyle[0] : ((num10 <= caveBackX[1]) ? caveBackStyle[1] : ((num10 > caveBackX[2]) ? caveBackStyle[3] : caveBackStyle[2])));
		num11 += 3;
		if (SceneMetrics.SnowTileCount > SceneMetrics.SnowTileThreshold && (screenPosition.Y + (float)screenHeight) / 16f < (float)(maxTilesY - 250))
		{
			num11 = 1;
		}
		if (SceneMetrics.JungleTileCount > SceneMetrics.JungleTileThreshold)
		{
			if (num11 == 1)
			{
				if (SceneMetrics.JungleTileCount > SceneMetrics.SnowTileCount)
				{
					num11 = 11;
				}
			}
			else
			{
				num11 = 11;
			}
		}
		if (SceneMetrics.ZoneGlowshroom)
		{
			num11 = 2;
		}
		if (num11 != undergroundBackground)
		{
			oldUndergroundBackground = undergroundBackground;
			undergroundBackground = num11;
			ugBackTransition = 1f;
		}
		if (ugBackTransition > 0f)
		{
			ugBackTransition -= 0.25f;
		}
		if (ugBackTransition < 0f)
		{
			ugBackTransition = 0f;
		}
		int[] array = new int[6];
		int[] array2 = new int[6];
		for (int i = 0; i < 2; i++)
		{
			int num12 = undergroundBackground;
			if (i == 1)
			{
				num12 = oldUndergroundBackground;
			}
			int[] array3 = new int[6];
			switch (num12)
			{
			case 0:
				array3[0] = 1;
				array3[1] = 2;
				array3[2] = 4;
				array3[3] = 3;
				array3[4] = 6;
				array3[5] = 5;
				break;
			case 1:
				if (iceBackStyle == 0)
				{
					array3[1] = 33;
					array3[3] = 32;
					array3[0] = 40;
					array3[2] = 34;
				}
				else if (iceBackStyle == 1)
				{
					array3[1] = 118;
					array3[3] = 117;
					array3[0] = 160;
					array3[2] = 161;
				}
				else if (iceBackStyle == 2)
				{
					array3[1] = 165;
					array3[3] = 167;
					array3[0] = 164;
					array3[2] = 166;
				}
				else
				{
					array3[1] = 120;
					array3[3] = 119;
					array3[0] = 162;
					array3[2] = 163;
				}
				array3[4] = array3[3];
				break;
			case 2:
				array3[0] = 62;
				array3[1] = 63;
				array3[2] = 64;
				array3[3] = 65;
				array3[4] = 143 + hellBackStyle;
				break;
			case 3:
				array3[0] = 66;
				array3[1] = 67;
				array3[2] = 68;
				array3[3] = 69;
				array3[4] = 128 + hellBackStyle;
				break;
			case 4:
				array3[0] = 70;
				array3[1] = 71;
				array3[2] = 68;
				array3[3] = 72;
				array3[4] = 128 + hellBackStyle;
				break;
			case 5:
				array3[0] = 73;
				array3[1] = 74;
				array3[2] = 75;
				array3[3] = 76;
				array3[4] = 131 + hellBackStyle;
				break;
			case 6:
				array3[0] = 77;
				array3[1] = 78;
				array3[2] = 79;
				array3[3] = 80;
				array3[4] = 134 + hellBackStyle;
				break;
			case 7:
				array3[0] = 77;
				array3[1] = 81;
				array3[2] = 79;
				array3[3] = 82;
				array3[4] = 134 + hellBackStyle;
				break;
			case 8:
				array3[0] = 83;
				array3[1] = 84;
				array3[2] = 85;
				array3[3] = 86;
				array3[4] = 137 + hellBackStyle;
				break;
			case 9:
				array3[0] = 83;
				array3[1] = 87;
				array3[2] = 88;
				array3[3] = 89;
				array3[4] = 137 + hellBackStyle;
				break;
			case 10:
				array3[0] = 121;
				array3[1] = 122;
				array3[2] = 123;
				array3[3] = 124;
				array3[4] = 140 + hellBackStyle;
				break;
			case 11:
				if (jungleBackStyle == 0)
				{
					array3[0] = 153;
					array3[1] = 147;
					array3[2] = 148;
					array3[3] = 149;
					array3[4] = 150 + hellBackStyle;
				}
				else
				{
					array3[0] = 146;
					array3[1] = 154;
					array3[2] = 155;
					array3[3] = 156;
					array3[4] = 157 + hellBackStyle;
				}
				break;
			}
			if (hellBackStyle == 0)
			{
				array3[5] = 125;
			}
			if (hellBackStyle == 1)
			{
				array3[5] = 126;
			}
			if (hellBackStyle == 2)
			{
				array3[5] = 127;
			}
			LoadBackground(array3[0]);
			LoadBackground(array3[1]);
			LoadBackground(array3[2]);
			LoadBackground(array3[3]);
			LoadBackground(array3[4]);
			LoadBackground(array3[5]);
			if (i == 0)
			{
				for (int j = 0; j < 6; j++)
				{
					array[j] = array3[j];
				}
			}
			else
			{
				for (int k = 0; k < 6; k++)
				{
					array2[k] = array3[k];
				}
			}
		}
		globalBrightness = 1.2f * (1f - value) + 1f * value;
		bgParallax = caveParallax;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)vector.X;
		bgLoops = (screenWidth + (int)vector.X * 2) / num3 + 2;
		bgTopY = (float)worldSurface * 16f - 16f - screenPosition.Y + 16f;
		for (int l = 0; l < bgLoops; l++)
		{
			for (int m = 0; m < num3 / 16; m++)
			{
				int num13 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
				if (num13 == -8)
				{
					num13 = 8;
				}
				float num14 = bgStartX + num3 * l + m * 16 + 8;
				float num15 = bgTopY;
				Microsoft.Xna.Framework.Color color = Lighting.GetColor((int)((num14 + screenPosition.X) / 16f), (int)((screenPosition.Y + num15) / 16f));
				color.R = (byte)((float)(int)color.R * num6);
				color.G = (byte)((float)(int)color.G * num5);
				color.B = (byte)((float)(int)color.B * num4);
				spriteBatch.Draw(TextureAssets.Background[array[0]].Value, new Vector2(bgStartX + num3 * l + 16 * m + num13, bgTopY) + vector, new Microsoft.Xna.Framework.Rectangle(16 * m + num13 + 16, 0, 16, 16), color);
				if (ugBackTransition > 0f)
				{
					Microsoft.Xna.Framework.Color color2 = color;
					color2.R = (byte)((float)(int)color2.R * ugBackTransition);
					color2.G = (byte)((float)(int)color2.G * ugBackTransition);
					color2.B = (byte)((float)(int)color2.B * ugBackTransition);
					color2.A = (byte)((float)(int)color2.A * ugBackTransition);
					spriteBatch.Draw(TextureAssets.Background[array2[0]].Value, new Vector2(bgStartX + num3 * l + 16 * m + num13, bgTopY) + vector, new Microsoft.Xna.Framework.Rectangle(16 * m + num13 + 16, 0, 16, 16), color2);
				}
			}
		}
		double num16 = maxTilesY - 230;
		double num17 = (int)((num16 - worldSurface) / 6.0) * 6;
		num16 = worldSurface + num17 - 5.0;
		bool flag = false;
		bool flag2 = false;
		bgTopY = (float)worldSurface * 16f - screenPosition.Y + 16f;
		if (worldSurface * 16.0 <= (double)(screenPosition.Y + (float)screenHeight + (float)offScreenRange))
		{
			bgParallax = caveParallax;
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)vector.X;
			bgLoops = (screenWidth + (int)vector.X * 2) / num3 + 2;
			if (worldSurface * 16.0 < (double)(screenPosition.Y - 16f))
			{
				bgStartY = (int)(Math.IEEERemainder(bgTopY, backgroundHeight[2]) - (double)backgroundHeight[2]);
				bgLoopsY = (screenHeight - bgStartY + (int)vector.Y * 2) / backgroundHeight[2] + 1;
			}
			else
			{
				bgStartY = (int)bgTopY;
				bgLoopsY = (int)((float)screenHeight - bgTopY + vector.Y * 2f) / backgroundHeight[2] + 1;
			}
			if (rockLayer * 16.0 < (double)(Camera.ScaledPosition.Y + 600f))
			{
				bgLoopsY = (int)(rockLayer * 16.0 - (double)screenPosition.Y + 600.0 - (double)bgStartY) / backgroundHeight[2];
				flag2 = true;
			}
			int num18 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
			if (num18 == -8)
			{
				num18 = 8;
			}
			for (int n = 0; n < bgLoops; n++)
			{
				for (int num19 = 0; num19 < bgLoopsY; num19++)
				{
					for (int num20 = 0; num20 < num3 / 16; num20++)
					{
						for (int num21 = 0; num21 < 6; num21++)
						{
							float num22 = bgStartY + num19 * 96 + num21 * 16 + 8;
							int num23 = (int)(((float)(bgStartX + num3 * n + num20 * 16 + 8) + screenPosition.X) / 16f);
							int num24 = (int)((num22 + screenPosition.Y) / 16f);
							Microsoft.Xna.Framework.Color color3 = Lighting.GetColor(num23, num24);
							if (tile[num23, num24] == null)
							{
								tile[num23, num24] = new Tile();
							}
							if (color3.R > 0 || color3.G > 0 || color3.B > 0)
							{
								if (!drawToScreen)
								{
									Lighting.GetCornerColors(num23, num24, out var vertices);
									tileBatch.Draw(TextureAssets.Background[array[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num18, bgStartY + backgroundHeight[array[1]] * num19 + 16 * num21) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num18 + 16, 16 * num21, 16, 16), vertices, Vector2.Zero, 1f, SpriteEffects.None);
								}
								else if ((color3.R > num || (double)(int)color3.G > (double)num * 1.1 || (double)(int)color3.B > (double)num * 1.2) && !tile[num23, num24].active() && WallLightAt(num23, num24) && ugBackTransition == 0f)
								{
									Lighting.GetColor9Slice(num23, num24, ref slices);
									try
									{
										for (int num25 = 0; num25 < 9; num25++)
										{
											int num26 = 0;
											int num27 = 0;
											int width = 4;
											int height = 4;
											Microsoft.Xna.Framework.Color color4 = color3;
											Microsoft.Xna.Framework.Color color5 = color3;
											switch (num25)
											{
											case 0:
												if (!tile[num23 - 1, num24 - 1].active())
												{
													color5 = slices[num25];
												}
												break;
											case 1:
												width = 8;
												num26 = 4;
												if (!tile[num23, num24 - 1].active())
												{
													color5 = slices[num25];
												}
												break;
											case 2:
												num26 = 12;
												if (!tile[num23 + 1, num24 - 1].active())
												{
													color5 = slices[num25];
												}
												break;
											case 3:
												height = 8;
												num27 = 4;
												if (!tile[num23 - 1, num24].active())
												{
													color5 = slices[num25];
												}
												break;
											case 4:
												width = 8;
												height = 8;
												num26 = 4;
												num27 = 4;
												break;
											case 5:
												num26 = 12;
												num27 = 4;
												height = 8;
												if (!tile[num23 + 1, num24].active())
												{
													color5 = slices[num25];
												}
												break;
											case 6:
												num27 = 12;
												if (!tile[num23 - 1, num24 + 1].active())
												{
													color5 = slices[num25];
												}
												break;
											case 7:
												width = 8;
												height = 4;
												num26 = 4;
												num27 = 12;
												if (!tile[num23, num24 + 1].active())
												{
													color5 = slices[num25];
												}
												break;
											case 8:
												num26 = 12;
												num27 = 12;
												if (!tile[num23 + 1, num24 + 1].active())
												{
													color5 = slices[num25];
												}
												break;
											}
											color4.R = (byte)((color3.R + color5.R) / 2);
											color4.G = (byte)((color3.G + color5.G) / 2);
											color4.B = (byte)((color3.B + color5.B) / 2);
											color4.R = (byte)((float)(int)color4.R * num6);
											color4.G = (byte)((float)(int)color4.G * num5);
											color4.B = (byte)((float)(int)color4.B * num4);
											spriteBatch.Draw(TextureAssets.Background[array[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num26 + num18, bgStartY + backgroundHeight[array[1]] * num19 + 16 * num21 + num27) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num26 + num18 + 16, 16 * num21 + num27, width, height), color4);
											if (ugBackTransition > 0f)
											{
												Microsoft.Xna.Framework.Color color6 = color4;
												color6.R = (byte)((float)(int)color6.R * ugBackTransition);
												color6.G = (byte)((float)(int)color6.G * ugBackTransition);
												color6.B = (byte)((float)(int)color6.B * ugBackTransition);
												color6.A = (byte)((float)(int)color6.A * ugBackTransition);
												spriteBatch.Draw(TextureAssets.Background[array2[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num26 + num18, bgStartY + backgroundHeight[array2[1]] * num19 + 16 * num21 + num27) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num26 + num18 + 16, 16 * num21 + num27, width, height), color6);
											}
										}
									}
									catch
									{
										color3.R = (byte)((float)(int)color3.R * num6);
										color3.G = (byte)((float)(int)color3.G * num5);
										color3.B = (byte)((float)(int)color3.B * num4);
										spriteBatch.Draw(TextureAssets.Background[array[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num18, bgStartY + backgroundHeight[array[1]] * num19 + 16 * num21) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num18 + 16, 16 * num21, 16, 16), color3);
									}
								}
								else if ((color3.R > num2 || (double)(int)color3.G > (double)num2 * 1.1 || (double)(int)color3.B > (double)num2 * 1.2) && ugBackTransition == 0f)
								{
									Lighting.GetColor4Slice(num23, num24, ref slices);
									for (int num28 = 0; num28 < 4; num28++)
									{
										int num29 = 0;
										int num30 = 0;
										Microsoft.Xna.Framework.Color color7 = color3;
										Microsoft.Xna.Framework.Color color8 = slices[num28];
										switch (num28)
										{
										case 1:
											num29 = 8;
											break;
										case 2:
											num30 = 8;
											break;
										case 3:
											num29 = 8;
											num30 = 8;
											break;
										}
										color7.R = (byte)((color3.R + color8.R) / 2);
										color7.G = (byte)((color3.G + color8.G) / 2);
										color7.B = (byte)((color3.B + color8.B) / 2);
										color7.R = (byte)((float)(int)color7.R * num6);
										color7.G = (byte)((float)(int)color7.G * num5);
										color7.B = (byte)((float)(int)color7.B * num4);
										spriteBatch.Draw(TextureAssets.Background[array[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num29 + num18, bgStartY + backgroundHeight[array[1]] * num19 + 16 * num21 + num30) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num29 + num18 + 16, 16 * num21 + num30, 8, 8), color7);
										if (ugBackTransition > 0f)
										{
											Microsoft.Xna.Framework.Color color9 = color7;
											color9.R = (byte)((float)(int)color9.R * ugBackTransition);
											color9.G = (byte)((float)(int)color9.G * ugBackTransition);
											color9.B = (byte)((float)(int)color9.B * ugBackTransition);
											color9.A = (byte)((float)(int)color9.A * ugBackTransition);
											spriteBatch.Draw(TextureAssets.Background[array2[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num29 + num18, bgStartY + backgroundHeight[array2[1]] * num19 + 16 * num21 + num30) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num29 + num18 + 16, 16 * num21 + num30, 8, 8), color9);
										}
									}
								}
								else
								{
									color3.R = (byte)((float)(int)color3.R * num6);
									color3.G = (byte)((float)(int)color3.G * num5);
									color3.B = (byte)((float)(int)color3.B * num4);
									spriteBatch.Draw(TextureAssets.Background[array[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num18, bgStartY + backgroundHeight[array[1]] * num19 + 16 * num21) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num18 + 16, 16 * num21, 16, 16), color3);
									if (ugBackTransition > 0f)
									{
										Microsoft.Xna.Framework.Color color10 = color3;
										color10.R = (byte)((float)(int)color10.R * ugBackTransition);
										color10.G = (byte)((float)(int)color10.G * ugBackTransition);
										color10.B = (byte)((float)(int)color10.B * ugBackTransition);
										color10.A = (byte)((float)(int)color10.A * ugBackTransition);
										spriteBatch.Draw(TextureAssets.Background[array2[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num18, bgStartY + backgroundHeight[array2[1]] * num19 + 16 * num21) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num18 + 16, 16 * num21, 16, 16), color10);
									}
								}
							}
							else
							{
								color3.R = (byte)((float)(int)color3.R * num6);
								color3.G = (byte)((float)(int)color3.G * num5);
								color3.B = (byte)((float)(int)color3.B * num4);
								spriteBatch.Draw(TextureAssets.Background[array[1]].Value, new Vector2(bgStartX + num3 * n + 16 * num20 + num18, bgStartY + backgroundHeight[array[1]] * num19 + 16 * num21) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num20 + num18 + 16, 16 * num21, 16, 16), color3);
							}
						}
					}
				}
			}
			if (ugBackTransition > 0f)
			{
				for (int num31 = 0; num31 < bgLoops; num31++)
				{
					for (int num32 = 0; num32 < bgLoopsY; num32++)
					{
						for (int num33 = 0; num33 < num3 / 16; num33++)
						{
							for (int num34 = 0; num34 < 6; num34++)
							{
								float num35 = bgStartY + num32 * 96 + num34 * 16 + 8;
								int num36 = (int)(((float)(bgStartX + num3 * num31 + num33 * 16 + 8) + screenPosition.X) / 16f);
								int num37 = (int)((num35 + screenPosition.Y) / 16f);
								Microsoft.Xna.Framework.Color color11 = Lighting.GetColor(num36, num37);
								if (tile[num36, num37] == null)
								{
									tile[num36, num37] = new Tile();
								}
								if (color11.R > 0 || color11.G > 0 || color11.B > 0)
								{
									Lighting.GetCornerColors(num36, num37, out var vertices2, ugBackTransition);
									byte a = (byte)(255f * ugBackTransition);
									vertices2.BottomLeftColor.A = a;
									vertices2.BottomRightColor.A = a;
									vertices2.TopLeftColor.A = a;
									vertices2.TopRightColor.A = a;
									tileBatch.Draw(TextureAssets.Background[array2[1]].Value, new Vector2(bgStartX + num3 * num31 + 16 * num33 + num18, bgStartY + backgroundHeight[array2[1]] * num32 + 16 * num34) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num33 + num18 + 16, 16 * num34, 16, 16), vertices2, Vector2.Zero, 1f, SpriteEffects.None);
								}
							}
						}
					}
				}
			}
			if (flag2)
			{
				bgParallax = caveParallax;
				bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)vector.X;
				bgLoops = (screenWidth + (int)vector.X * 2) / num3 + 2;
				bgTopY = bgStartY + bgLoopsY * backgroundHeight[2];
				if (bgTopY > -32f)
				{
					for (int num38 = 0; num38 < bgLoops; num38++)
					{
						for (int num39 = 0; num39 < num3 / 16; num39++)
						{
							float num40 = bgStartX + num3 * num38 + num39 * 16 + 8;
							float num41 = bgTopY;
							Microsoft.Xna.Framework.Color color12 = Lighting.GetColor((int)((num40 + screenPosition.X) / 16f), (int)((screenPosition.Y + num41) / 16f));
							color12.R = (byte)((float)(int)color12.R * num6);
							color12.G = (byte)((float)(int)color12.G * num5);
							color12.B = (byte)((float)(int)color12.B * num4);
							spriteBatch.Draw(TextureAssets.Background[array[2]].Value, new Vector2(bgStartX + num3 * num38 + 16 * num39 + num18, bgTopY) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num39 + num18 + 16, 0, 16, 16), color12);
							if (ugBackTransition > 0f)
							{
								Microsoft.Xna.Framework.Color color13 = color12;
								color13.R = (byte)((float)(int)color13.R * ugBackTransition);
								color13.G = (byte)((float)(int)color13.G * ugBackTransition);
								color13.B = (byte)((float)(int)color13.B * ugBackTransition);
								color13.A = (byte)((float)(int)color13.A * ugBackTransition);
								spriteBatch.Draw(TextureAssets.Background[array2[2]].Value, new Vector2(bgStartX + num3 * num38 + 16 * num39 + num18, bgTopY) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num39 + num18 + 16, 0, 16, 16), color13);
							}
						}
					}
				}
			}
		}
		bgTopY = (float)rockLayer * 16f - screenPosition.Y + 16f + 600f - 8f;
		if (rockLayer * 16.0 <= (double)(screenPosition.Y + 600f))
		{
			bgParallax = caveParallax;
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)vector.X;
			bgLoops = (screenWidth + (int)vector.X * 2) / num3 + 2;
			if (rockLayer * 16.0 + (double)screenHeight < (double)(screenPosition.Y - 16f))
			{
				bgStartY = (int)(Math.IEEERemainder(bgTopY, backgroundHeight[3]) - (double)backgroundHeight[3]);
				bgLoopsY = (screenHeight - bgStartY + (int)vector.Y * 2) / backgroundHeight[2] + 1;
			}
			else
			{
				bgStartY = (int)bgTopY;
				bgLoopsY = (int)((float)screenHeight - bgTopY + vector.Y * 2f) / backgroundHeight[2] + 1;
			}
			if (num16 * 16.0 < (double)(screenPosition.Y + 600f))
			{
				bgLoopsY = (int)(num16 * 16.0 - (double)screenPosition.Y + 600.0 - (double)bgStartY) / backgroundHeight[2];
				flag = true;
			}
			int num42 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
			if (num42 == -8)
			{
				num42 = 8;
			}
			for (int num43 = 0; num43 < bgLoops; num43++)
			{
				for (int num44 = 0; num44 < bgLoopsY; num44++)
				{
					for (int num45 = 0; num45 < num3 / 16; num45++)
					{
						for (int num46 = 0; num46 < 6; num46++)
						{
							float num47 = bgStartY + num44 * 96 + num46 * 16 + 8;
							int num48 = (int)(((float)(bgStartX + num3 * num43 + num45 * 16 + 8) + screenPosition.X) / 16f);
							int num49 = (int)((num47 + screenPosition.Y) / 16f);
							Microsoft.Xna.Framework.Color color14 = Lighting.GetColor(num48, num49);
							if ((!ShouldDrawBackgroundTileAt(num48, num49) && color14.R != 0 && color14.G != 0 && color14.B != 0) || (color14.R <= 0 && color14.G <= 0 && color14.B <= 0) || (!WallLightAt(num48, num49) && caveParallax == 0f))
							{
								continue;
							}
							if (Lighting.NotRetro && color14.R < 230 && color14.G < 230 && color14.B < 230 && ugBackTransition == 0f)
							{
								if ((color14.R > num || (double)(int)color14.G > (double)num * 1.1 || (double)(int)color14.B > (double)num * 1.2) && !tile[num48, num49].active())
								{
									Lighting.GetColor9Slice(num48, num49, ref slices);
									for (int num50 = 0; num50 < 9; num50++)
									{
										int num51 = 0;
										int num52 = 0;
										int width2 = 4;
										int height2 = 4;
										Microsoft.Xna.Framework.Color color15 = color14;
										Microsoft.Xna.Framework.Color color16 = color14;
										switch (num50)
										{
										case 0:
											if (!tile[num48 - 1, num49 - 1].active())
											{
												color16 = slices[num50];
											}
											break;
										case 1:
											width2 = 8;
											num51 = 4;
											if (!tile[num48, num49 - 1].active())
											{
												color16 = slices[num50];
											}
											break;
										case 2:
											num51 = 12;
											if (!tile[num48 + 1, num49 - 1].active())
											{
												color16 = slices[num50];
											}
											break;
										case 3:
											height2 = 8;
											num52 = 4;
											if (!tile[num48 - 1, num49].active())
											{
												color16 = slices[num50];
											}
											break;
										case 4:
											width2 = 8;
											height2 = 8;
											num51 = 4;
											num52 = 4;
											break;
										case 5:
											num51 = 12;
											num52 = 4;
											height2 = 8;
											if (!tile[num48 + 1, num49].active())
											{
												color16 = slices[num50];
											}
											break;
										case 6:
											num52 = 12;
											if (!tile[num48 - 1, num49 + 1].active())
											{
												color16 = slices[num50];
											}
											break;
										case 7:
											width2 = 8;
											height2 = 4;
											num51 = 4;
											num52 = 12;
											if (!tile[num48, num49 + 1].active())
											{
												color16 = slices[num50];
											}
											break;
										case 8:
											num51 = 12;
											num52 = 12;
											if (!tile[num48 + 1, num49 + 1].active())
											{
												color16 = slices[num50];
											}
											break;
										}
										color15.R = (byte)((color14.R + color16.R) / 2);
										color15.G = (byte)((color14.G + color16.G) / 2);
										color15.B = (byte)((color14.B + color16.B) / 2);
										color15.R = (byte)((float)(int)color15.R * num6);
										color15.G = (byte)((float)(int)color15.G * num5);
										color15.B = (byte)((float)(int)color15.B * num4);
										spriteBatch.Draw(TextureAssets.Background[array[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num51 + num42, bgStartY + backgroundHeight[array[3]] * num44 + 16 * num46 + num52) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num51 + num42 + 16, 16 * num46 + num52, width2, height2), color15);
										if (ugBackTransition > 0f)
										{
											Microsoft.Xna.Framework.Color color17 = color15;
											color17.R = (byte)((float)(int)color17.R * ugBackTransition);
											color17.G = (byte)((float)(int)color17.G * ugBackTransition);
											color17.B = (byte)((float)(int)color17.B * ugBackTransition);
											color17.A = (byte)((float)(int)color17.A * ugBackTransition);
											spriteBatch.Draw(TextureAssets.Background[array2[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num51 + num42, bgStartY + backgroundHeight[array2[3]] * num44 + 16 * num46 + num52) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num51 + num42 + 16, 16 * num46 + num52, width2, height2), color17);
										}
									}
								}
								else if (color14.R > num2 || (double)(int)color14.G > (double)num2 * 1.1 || (double)(int)color14.B > (double)num2 * 1.2)
								{
									Lighting.GetColor4Slice(num48, num49, ref slices);
									for (int num53 = 0; num53 < 4; num53++)
									{
										int num54 = 0;
										int num55 = 0;
										Microsoft.Xna.Framework.Color color18 = color14;
										Microsoft.Xna.Framework.Color color19 = slices[num53];
										switch (num53)
										{
										case 1:
											num54 = 8;
											break;
										case 2:
											num55 = 8;
											break;
										case 3:
											num54 = 8;
											num55 = 8;
											break;
										}
										color18.R = (byte)((color14.R + color19.R) / 2);
										color18.G = (byte)((color14.G + color19.G) / 2);
										color18.B = (byte)((color14.B + color19.B) / 2);
										color18.R = (byte)((float)(int)color18.R * num6);
										color18.G = (byte)((float)(int)color18.G * num5);
										color18.B = (byte)((float)(int)color18.B * num4);
										spriteBatch.Draw(TextureAssets.Background[array[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num54 + num42, bgStartY + backgroundHeight[array[3]] * num44 + 16 * num46 + num55) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num54 + num42 + 16, 16 * num46 + num55, 8, 8), color18);
										if (ugBackTransition > 0f)
										{
											Microsoft.Xna.Framework.Color color20 = color18;
											color20.R = (byte)((float)(int)color20.R * ugBackTransition);
											color20.G = (byte)((float)(int)color20.G * ugBackTransition);
											color20.B = (byte)((float)(int)color20.B * ugBackTransition);
											color20.A = (byte)((float)(int)color20.A * ugBackTransition);
											spriteBatch.Draw(TextureAssets.Background[array2[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num54 + num42, bgStartY + backgroundHeight[array2[3]] * num44 + 16 * num46 + num55) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num54 + num42 + 16, 16 * num46 + num55, 8, 8), color20);
										}
									}
								}
								else
								{
									color14.R = (byte)((float)(int)color14.R * num6);
									color14.G = (byte)((float)(int)color14.G * num5);
									color14.B = (byte)((float)(int)color14.B * num4);
									spriteBatch.Draw(TextureAssets.Background[array[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num42, bgStartY + backgroundHeight[array[3]] * num44 + 16 * num46) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num42 + 16, 16 * num46, 16, 16), color14);
									if (ugBackTransition > 0f)
									{
										Microsoft.Xna.Framework.Color color21 = color14;
										color21.R = (byte)((float)(int)color21.R * ugBackTransition);
										color21.G = (byte)((float)(int)color21.G * ugBackTransition);
										color21.B = (byte)((float)(int)color21.B * ugBackTransition);
										color21.A = (byte)((float)(int)color21.A * ugBackTransition);
										spriteBatch.Draw(TextureAssets.Background[array2[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num42, bgStartY + backgroundHeight[array2[3]] * num44 + 16 * num46) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num42 + 16, 16 * num46, 16, 16), color21);
									}
								}
							}
							else
							{
								color14.R = (byte)((float)(int)color14.R * num6);
								color14.G = (byte)((float)(int)color14.G * num5);
								color14.B = (byte)((float)(int)color14.B * num4);
								spriteBatch.Draw(TextureAssets.Background[array[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num42, bgStartY + backgroundHeight[array[3]] * num44 + 16 * num46) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num42 + 16, 16 * num46, 16, 16), color14);
								if (ugBackTransition > 0f)
								{
									Microsoft.Xna.Framework.Color color22 = color14;
									color22.R = (byte)((float)(int)color22.R * ugBackTransition);
									color22.G = (byte)((float)(int)color22.G * ugBackTransition);
									color22.B = (byte)((float)(int)color22.B * ugBackTransition);
									color22.A = (byte)((float)(int)color22.A * ugBackTransition);
									spriteBatch.Draw(TextureAssets.Background[array2[3]].Value, new Vector2(bgStartX + num3 * num43 + 16 * num45 + num42, bgStartY + backgroundHeight[array2[3]] * num44 + 16 * num46) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num45 + num42 + 16, 16 * num46, 16, 16), color22);
								}
							}
						}
					}
				}
			}
			num3 = 128;
			if (flag)
			{
				bgParallax = caveParallax;
				bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)vector.X;
				bgLoops = (screenWidth + (int)vector.X * 2) / num3 + 2;
				bgTopY = bgStartY + bgLoopsY * backgroundHeight[2];
				for (int num56 = 0; num56 < bgLoops; num56++)
				{
					for (int num57 = 0; num57 < num3 / 16; num57++)
					{
						float num58 = bgStartX + num3 * num56 + num57 * 16 + 8;
						float num59 = bgTopY;
						Microsoft.Xna.Framework.Color color23 = Lighting.GetColor((int)((num58 + screenPosition.X) / 16f), (int)((screenPosition.Y + num59) / 16f));
						color23.R = (byte)((float)(int)color23.R * num6);
						color23.G = (byte)((float)(int)color23.G * num5);
						color23.B = (byte)((float)(int)color23.B * num4);
						spriteBatch.Draw(TextureAssets.Background[array[4]].Value, new Vector2(bgStartX + num3 * num56 + 16 * num57 + num42, bgTopY) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num57 + num42 + 16, magmaBGFrame * 16, 16, 16), color23);
						if (ugBackTransition > 0f)
						{
							Microsoft.Xna.Framework.Color color24 = color23;
							color24.R = (byte)((float)(int)color24.R * ugBackTransition);
							color24.G = (byte)((float)(int)color24.G * ugBackTransition);
							color24.B = (byte)((float)(int)color24.B * ugBackTransition);
							color24.A = (byte)((float)(int)color24.A * ugBackTransition);
							spriteBatch.Draw(TextureAssets.Background[array2[4]].Value, new Vector2(bgStartX + num3 * num56 + 16 * num57 + num42, bgTopY) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num57 + num42 + 16, magmaBGFrame * 16, 16, 16), color24);
						}
					}
				}
			}
		}
		bgTopY = (float)num16 * 16f - screenPosition.Y + 16f + 600f - 8f;
		if (num16 * 16.0 <= (double)(screenPosition.Y + 600f))
		{
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)num3 + (double)screenPosition.X * bgParallax, num3) - (double)(num3 / 2)) - (int)vector.X;
			bgLoops = (screenWidth + (int)vector.X * 2) / num3 + 2;
			if (num16 * 16.0 + (double)screenHeight < (double)(screenPosition.Y - 16f))
			{
				bgStartY = (int)(Math.IEEERemainder(bgTopY, backgroundHeight[2]) - (double)backgroundHeight[2]);
				bgLoopsY = (screenHeight - bgStartY + (int)vector.Y * 2) / backgroundHeight[2] + 1;
			}
			else
			{
				bgStartY = (int)bgTopY;
				bgLoopsY = (int)((float)screenHeight - bgTopY + vector.Y * 2f) / backgroundHeight[2] + 1;
			}
			num = (int)((double)num * 1.5);
			num2 = (int)((double)num2 * 1.5);
			int num60 = (int)(float)Math.Round(0f - (float)Math.IEEERemainder((float)bgStartX + screenPosition.X, 16.0));
			if (num60 == -8)
			{
				num60 = 8;
			}
			for (int num61 = 0; num61 < bgLoops; num61++)
			{
				for (int num62 = 0; num62 < bgLoopsY; num62++)
				{
					for (int num63 = 0; num63 < num3 / 16; num63++)
					{
						for (int num64 = 0; num64 < 6; num64++)
						{
							float num65 = bgStartY + num62 * 96 + num64 * 16 + 8;
							int num66 = (int)(((float)(bgStartX + num3 * num61 + num63 * 16 + 8) + screenPosition.X) / 16f);
							int num67 = (int)((num65 + screenPosition.Y) / 16f);
							Microsoft.Xna.Framework.Color color25 = Lighting.GetColor(num66, num67);
							if ((!ShouldDrawBackgroundTileAt(num66, num67) && color25.R != 0 && color25.G != 0 && color25.B != 0) || (color25.R <= 0 && color25.G <= 0 && color25.B <= 0) || (!WallLightAt(num66, num67) && caveParallax == 0f))
							{
								continue;
							}
							if (Lighting.NotRetro && color25.R < 230 && color25.G < 230 && color25.B < 230)
							{
								if ((color25.R > num || (double)(int)color25.G > (double)num * 1.1 || (double)(int)color25.B > (double)num * 1.2) && !tile[num66, num67].active())
								{
									Lighting.GetColor9Slice(num66, num67, ref slices);
									for (int num68 = 0; num68 < 9; num68++)
									{
										int num69 = 0;
										int num70 = 0;
										int width3 = 4;
										int height3 = 4;
										Microsoft.Xna.Framework.Color color26 = color25;
										Microsoft.Xna.Framework.Color color27 = color25;
										switch (num68)
										{
										case 0:
											if (!tile[num66 - 1, num67 - 1].active())
											{
												color27 = slices[num68];
											}
											break;
										case 1:
											width3 = 8;
											num69 = 4;
											if (!tile[num66, num67 - 1].active())
											{
												color27 = slices[num68];
											}
											break;
										case 2:
											num69 = 12;
											if (!tile[num66 + 1, num67 - 1].active())
											{
												color27 = slices[num68];
											}
											break;
										case 3:
											height3 = 8;
											num70 = 4;
											if (!tile[num66 - 1, num67].active())
											{
												color27 = slices[num68];
											}
											break;
										case 4:
											width3 = 8;
											height3 = 8;
											num69 = 4;
											num70 = 4;
											break;
										case 5:
											num69 = 12;
											num70 = 4;
											height3 = 8;
											if (!tile[num66 + 1, num67].active())
											{
												color27 = slices[num68];
											}
											break;
										case 6:
											num70 = 12;
											if (!tile[num66 - 1, num67 + 1].active())
											{
												color27 = slices[num68];
											}
											break;
										case 7:
											width3 = 8;
											height3 = 4;
											num69 = 4;
											num70 = 12;
											if (!tile[num66, num67 + 1].active())
											{
												color27 = slices[num68];
											}
											break;
										case 8:
											num69 = 12;
											num70 = 12;
											if (!tile[num66 + 1, num67 + 1].active())
											{
												color27 = slices[num68];
											}
											break;
										}
										color26.R = (byte)((color25.R + color27.R) / 2);
										color26.G = (byte)((color25.G + color27.G) / 2);
										color26.B = (byte)((color25.B + color27.B) / 2);
										color26.R = (byte)((float)(int)color26.R * num6);
										color26.G = (byte)((float)(int)color26.G * num5);
										color26.B = (byte)((float)(int)color26.B * num4);
										spriteBatch.Draw(TextureAssets.Background[array[5]].Value, new Vector2(bgStartX + num3 * num61 + 16 * num63 + num69 + num60, bgStartY + backgroundHeight[2] * num62 + 16 * num64 + num70) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num63 + num69 + num60 + 16, 16 * num64 + backgroundHeight[2] * magmaBGFrame + num70, width3, height3), color26, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
									}
								}
								else if (color25.R > num2 || (double)(int)color25.G > (double)num2 * 1.1 || (double)(int)color25.B > (double)num2 * 1.2)
								{
									Lighting.GetColor4Slice(num66, num67, ref slices);
									for (int num71 = 0; num71 < 4; num71++)
									{
										int num72 = 0;
										int num73 = 0;
										Microsoft.Xna.Framework.Color color28 = color25;
										Microsoft.Xna.Framework.Color color29 = slices[num71];
										switch (num71)
										{
										case 1:
											num72 = 8;
											break;
										case 2:
											num73 = 8;
											break;
										case 3:
											num72 = 8;
											num73 = 8;
											break;
										}
										color28.R = (byte)((color25.R + color29.R) / 2);
										color28.G = (byte)((color25.G + color29.G) / 2);
										color28.B = (byte)((color25.B + color29.B) / 2);
										color28.R = (byte)((float)(int)color28.R * num6);
										color28.G = (byte)((float)(int)color28.G * num5);
										color28.B = (byte)((float)(int)color28.B * num4);
										spriteBatch.Draw(TextureAssets.Background[array[5]].Value, new Vector2(bgStartX + num3 * num61 + 16 * num63 + num72 + num60, bgStartY + backgroundHeight[2] * num62 + 16 * num64 + num73) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num63 + num72 + num60 + 16, 16 * num64 + backgroundHeight[2] * magmaBGFrame + num73, 8, 8), color28, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
									}
								}
								else
								{
									color25.R = (byte)((float)(int)color25.R * num6);
									color25.G = (byte)((float)(int)color25.G * num5);
									color25.B = (byte)((float)(int)color25.B * num4);
									spriteBatch.Draw(TextureAssets.Background[array[5]].Value, new Vector2(bgStartX + num3 * num61 + 16 * num63 + num60, bgStartY + backgroundHeight[2] * num62 + 16 * num64) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num63 + num60 + 16, 16 * num64 + backgroundHeight[2] * magmaBGFrame, 16, 16), color25, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
								}
							}
							else
							{
								color25.R = (byte)((float)(int)color25.R * num6);
								color25.G = (byte)((float)(int)color25.G * num5);
								color25.B = (byte)((float)(int)color25.B * num4);
								spriteBatch.Draw(TextureAssets.Background[array[5]].Value, new Vector2(bgStartX + num3 * num61 + 16 * num63 + num60, bgStartY + backgroundHeight[2] * num62 + 16 * num64) + vector, new Microsoft.Xna.Framework.Rectangle(16 * num63 + num60 + 16, 16 * num64 + backgroundHeight[2] * magmaBGFrame, 16, 16), color25, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
							}
						}
					}
				}
			}
		}
		tileBatch.End();
		Lighting.GlobalBrightness = globalBrightness;
		TimeLogger.DrawOldUndergroundBackground.AddTime(fromTimestamp);
	}

	private static bool ShouldDrawBackgroundTileAt(int i, int j)
	{
		if (tile[i, j] == null)
		{
			tile[i, j] = new Tile();
		}
		if (caveParallax != 0f)
		{
			if (tile[i - 1, j] == null)
			{
				tile[i - 1, j] = new Tile();
			}
			if (tile[i + 1, j] == null)
			{
				tile[i + 1, j] = new Tile();
			}
			if (WallLightAt(i, j) || WallLightAt(i - 1, j) || WallLightAt(i + 1, j))
			{
				return true;
			}
		}
		else if (WallLightAt(i, j))
		{
			return true;
		}
		return false;
	}

	public static bool WallLightAt(int i, int j)
	{
		return WallLightAt(i, j, ShouldShowInvisibleBlocksAndWalls());
	}

	public static bool WallLightAt(int i, int j, bool showInvisibleWalls)
	{
		Tile tile = Main.tile[i, j];
		if (!wallLight[tile.wall])
		{
			if (!showInvisibleWalls)
			{
				return tile.invisibleWall();
			}
			return false;
		}
		return true;
	}

	protected void RenderBackgroundWater()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		spriteBatch.Begin();
		tileBatch.Begin();
		try
		{
			DrawWaters(isBackground: true);
		}
		catch
		{
		}
		tileBatch.End();
		spriteBatch.End();
		TimeLogger.RenderBackgroundLiquid.AddTime(fromTimestamp);
	}

	protected void RenderBackground()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		spriteBatch.Begin();
		if (ignoreErrors)
		{
			try
			{
				DrawBackground();
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
			}
		}
		else
		{
			DrawBackground();
		}
		spriteBatch.End();
		TimeLogger.RenderUndergroundBackground.AddTime(fromTimestamp);
	}

	public static string ValueToCoins(long value)
	{
		long num = value;
		long num2 = 0L;
		long num3 = 0L;
		long num4 = 0L;
		long num5 = 0L;
		while (num >= 1000000)
		{
			num -= 1000000;
			num2++;
		}
		while (num >= 10000)
		{
			num -= 10000;
			num3++;
		}
		while (num >= 100)
		{
			num -= 100;
			num4++;
		}
		num5 = num;
		string text = "";
		if (num2 > 0)
		{
			text += string.Format("{0} {1} ", num2, Language.GetTextValue("Currency.Platinum").ToLower());
		}
		if (num3 > 0)
		{
			text += string.Format("{0} {1} ", num3, Language.GetTextValue("Currency.Gold").ToLower());
		}
		if (num4 > 0)
		{
			text += string.Format("{0} {1} ", num4, Language.GetTextValue("Currency.Silver").ToLower());
		}
		if (num5 > 0)
		{
			text += string.Format("{0} {1} ", num5, Language.GetTextValue("Currency.Copper").ToLower());
		}
		if (text.Length > 0)
		{
			text = text.Substring(0, text.Length - 1);
		}
		return text;
	}

	private static void UpdateMinimapAnchors()
	{
		int num = 240;
		int num2 = 240;
		_minimapTopRightAnchorOffsetTowardsLeft = 292;
		_minimapTopRightAnchorOffsetTowardsBottom = 90;
		_minimapTopRightAnchorOffsetTowardsLeft = (int)((float)(52 + num / 2) + MapScale * (float)num / 2f);
		_minimapTopRightAnchorOffsetTowardsBottom = (int)((float)(90 + num2 / 2) - MapScale * (float)num2 / 2f);
		_minimapTopRightAnchorOffsetTowardsLeft = 52 + (int)(240f * MapScale);
		_minimapTopRightAnchorOffsetTowardsBottom = 90;
	}

	public void DrawMap(GameTime gameTime)
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		string text = "";
		if (!mapEnabled || !mapReady)
		{
			return;
		}
		float num = 0f;
		float num2 = 0f;
		float num3 = num;
		float num4 = num2;
		float num5 = 2f;
		byte b = byte.MaxValue;
		float num6 = 10f;
		float num7 = 10f;
		float num8 = maxTilesX - 10;
		float num9 = maxTilesY - 19;
		float num10 = 0f;
		float num11 = 0f;
		MapRenderer.CheckMapTargets();
		num = 200f;
		num2 = 300f;
		float num12 = 0f;
		float num13 = 0f;
		float num14 = num8 - 1f;
		float num15 = num9 - 1f;
		num5 = (mapFullscreen ? mapFullscreenScale : ((mapStyle != 1) ? mapOverlayScale : mapMinimapScale));
		bool flag = false;
		float mapScale = MapScale;
		float num16 = 1f / mapScale;
		int num17 = mouseX;
		int num18 = mouseY;
		Matrix uIScaleMatrix = UIScaleMatrix;
		Matrix transformMatrix = uIScaleMatrix;
		Matrix transformMatrix2 = uIScaleMatrix;
		Matrix matrix = Matrix.CreateScale(mapScale);
		CoinLossRevengeSystem.RevengeMarker revengeMarker = null;
		int num19 = -1;
		if (mapStyle != 1)
		{
			transformMatrix = Matrix.Identity;
		}
		if (mapFullscreen)
		{
			transformMatrix = Matrix.Identity;
		}
		if (!mapFullscreen && mapStyle == 1)
		{
			transformMatrix *= matrix;
			transformMatrix2 *= matrix;
		}
		if (!mapFullscreen)
		{
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix);
			if (num5 > 1f)
			{
				flag = true;
			}
		}
		if (mapFullscreen)
		{
			if (mouseLeft && base.IsActive && !CaptureManager.Instance.UsingMap)
			{
				if (mouseLeftRelease)
				{
					grabMapX = mouseX;
					grabMapY = mouseY;
				}
				else
				{
					float num20 = (float)mouseX - grabMapX;
					float num21 = (float)mouseY - grabMapY;
					grabMapX = mouseX;
					grabMapY = mouseY;
					num20 *= 0.06255f;
					num21 *= 0.06255f;
					mapFullscreenPos.X -= num20 * (16f / mapFullscreenScale);
					mapFullscreenPos.Y -= num21 * (16f / mapFullscreenScale);
				}
			}
			if (PanTargetMapFullscreen)
			{
				if (base.IsActive && mouseLeft && mouseLeftRelease)
				{
					PanTargetMapFullscreen = false;
				}
				else
				{
					float num22 = (PanTargetMapFullscreenEnd - mapFullscreenPos).Length();
					if (num22 < 1f)
					{
						mapFullscreenPos = PanTargetMapFullscreenEnd;
						PanTargetMapFullscreen = false;
					}
					else
					{
						float amount = 0.15f;
						if (num22 * 0.15f < 1f)
						{
							amount = 1f / num22;
						}
						mapFullscreenPos = Vector2.Lerp(mapFullscreenPos, PanTargetMapFullscreenEnd, amount);
					}
				}
			}
			player[myPlayer].mouseInterface = true;
			float num23 = (float)screenWidth / (float)maxTilesX * 0.599f;
			if (mapFullscreenScale < num23)
			{
				mapFullscreenScale = num23;
			}
			if (mapFullscreenScale > 31.2f)
			{
				mapFullscreenScale = 31.18f;
			}
			num5 = mapFullscreenScale;
			b = byte.MaxValue;
			if (mapFullscreenPos.X < num6)
			{
				mapFullscreenPos.X = num6;
			}
			if (mapFullscreenPos.X > num8)
			{
				mapFullscreenPos.X = num8;
			}
			if (mapFullscreenPos.Y < num7)
			{
				mapFullscreenPos.Y = num7;
			}
			if (mapFullscreenPos.Y > num9)
			{
				mapFullscreenPos.Y = num9;
			}
			float num24 = mapFullscreenPos.X;
			float num25 = mapFullscreenPos.Y;
			if (resetMapFull)
			{
				PanTargetMapFullscreen = false;
				resetMapFull = false;
				num24 = (screenPosition.X + (float)(screenWidth / 2)) / 16f;
				num25 = (screenPosition.Y + (float)(screenHeight / 2)) / 16f;
				mapFullscreenPos.X = num24;
				mapFullscreenPos.Y = num25;
			}
			num24 *= num5;
			num25 *= num5;
			num = 0f - num24 + (float)(screenWidth / 2);
			num2 = 0f - num25 + (float)(screenHeight / 2);
			num += num6 * num5;
			num2 += num7 * num5;
			float num26 = maxTilesX / 840;
			num26 *= mapFullscreenScale;
			float num27 = num;
			float num28 = num2;
			float num29 = TextureAssets.Map.Width();
			float num30 = TextureAssets.Map.Height();
			if (maxTilesX == 8400)
			{
				num26 *= 0.999f;
				num27 -= 40.6f * num26;
				num28 = num2 - 5f * num26;
				num29 -= 8.045f;
				num29 *= num26;
				num30 += 0.12f;
				num30 *= num26;
				if ((double)num26 < 1.2)
				{
					num30 += 1f;
				}
			}
			else if (maxTilesX == 6400)
			{
				num26 *= 1.09f;
				num27 -= 38.8f * num26;
				num28 = num2 - 3.85f * num26;
				num29 -= 13.6f;
				num29 *= num26;
				num30 -= 6.92f;
				num30 *= num26;
				if ((double)num26 < 1.2)
				{
					num30 += 2f;
				}
			}
			else if (maxTilesX == 6300)
			{
				num26 *= 1.09f;
				num27 -= 39.8f * num26;
				num28 = num2 - 4.08f * num26;
				num29 -= 26.69f;
				num29 *= num26;
				num30 -= 6.92f;
				num30 *= num26;
				if ((double)num26 < 1.2)
				{
					num30 += 2f;
				}
			}
			else if (maxTilesX == 4200)
			{
				num26 *= 0.998f;
				num27 -= 37.3f * num26;
				num28 -= 1.7f * num26;
				num29 -= 16f;
				num29 *= num26;
				num30 -= 8.31f;
				num30 *= num26;
			}
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise);
			flag = true;
			DrawMapFullscreenBackground(screenPosition, screenWidth, screenHeight);
			Microsoft.Xna.Framework.Rectangle destinationRectangle = new Microsoft.Xna.Framework.Rectangle((int)num27, (int)num28, (int)num29, (int)num30);
			spriteBatch.Draw(TextureAssets.Map.Value, destinationRectangle, Microsoft.Xna.Framework.Color.White);
			if (mouseLeft && mouseLeftRelease)
			{
				double totalSeconds = gameTime.TotalGameTime.TotalSeconds;
				if (totalSeconds - _lastPingMouseDownTime < 0.5 && Vector2.Distance(MouseScreen, _lastPingMousePosition) < 2f)
				{
					TriggerPing((MouseScreen - new Vector2(num - 10f * num5, num2 - 10f * num5)) / num5);
				}
				_lastPingMouseDownTime = totalSeconds;
				_lastPingMousePosition = MouseScreen;
			}
			if (num5 < 1f)
			{
				spriteBatch.End();
				spriteBatch.Begin();
				flag = false;
			}
		}
		else if (mapStyle == 1)
		{
			UpdateMinimapAnchors();
			miniMapWidth = 240;
			miniMapHeight = 240;
			miniMapX = screenWidth - _minimapTopRightAnchorOffsetTowardsLeft;
			miniMapY = _minimapTopRightAnchorOffsetTowardsBottom;
			miniMapX = (int)((float)miniMapX * num16);
			miniMapY = (int)((float)miniMapY * num16);
			mouseX = (int)((float)mouseX * num16);
			mouseY = (int)((float)mouseY * num16);
			_ = (float)miniMapHeight / (float)maxTilesY;
			if ((double)mapMinimapScale < 0.2)
			{
				mapMinimapScale = 0.2f;
			}
			if (mapMinimapScale > 3f)
			{
				mapMinimapScale = 3f;
			}
			if ((double)mapMinimapAlpha < 0.01)
			{
				mapMinimapAlpha = 0.01f;
			}
			if (mapMinimapAlpha > 1f)
			{
				mapMinimapAlpha = 1f;
			}
			num5 = mapMinimapScale;
			b = (byte)(255f * mapMinimapAlpha);
			num = miniMapX;
			num2 = miniMapY;
			num3 = num;
			num4 = num2;
			float num31 = (screenPosition.X + (float)(PlayerInput.RealScreenWidth / 2)) / 16f;
			float num32 = (screenPosition.Y + (float)(PlayerInput.RealScreenHeight / 2)) / 16f;
			num10 = (0f - (num31 - (float)(int)((screenPosition.X + (float)(PlayerInput.RealScreenWidth / 2)) / 16f))) * num5;
			num11 = (0f - (num32 - (float)(int)((screenPosition.Y + (float)(PlayerInput.RealScreenHeight / 2)) / 16f))) * num5;
			num14 = (float)miniMapWidth / num5;
			num15 = (float)miniMapHeight / num5;
			num12 = (float)(int)num31 - num14 / 2f;
			num13 = (float)(int)num32 - num15 / 2f;
			_ = (float)maxTilesY + num13;
			float num33 = num3 - 6f;
			float num34 = num4 - 6f;
			MinimapFrameManagerInstance.DrawTo(spriteBatch, new Vector2(num33 + 10f, num34 + 10f));
		}
		else if (mapStyle == 2)
		{
			float num35 = (float)screenWidth / (float)maxTilesX;
			if (mapOverlayScale < num35)
			{
				mapOverlayScale = num35;
			}
			if (mapOverlayScale > 16f * GameViewMatrix.RenderZoom.X)
			{
				mapOverlayScale = 16f * GameViewMatrix.RenderZoom.X;
			}
			if ((double)mapOverlayAlpha < 0.01)
			{
				mapOverlayAlpha = 0.01f;
			}
			if (mapOverlayAlpha > 1f)
			{
				mapOverlayAlpha = 1f;
			}
			num5 = mapOverlayScale;
			b = (byte)(255f * mapOverlayAlpha);
			_ = maxTilesX;
			_ = maxTilesY;
			float num36 = (screenPosition.X + (float)(screenWidth / 2)) / 16f;
			float num37 = (screenPosition.Y + (float)(screenHeight / 2)) / 16f;
			num36 *= num5;
			float num38 = num37 * num5;
			num = 0f - num36 + (float)(screenWidth / 2);
			num2 = 0f - num38 + (float)(screenHeight / 2);
			num += num6 * num5;
			num2 += num7 * num5;
		}
		if (mapStyle == 1 && !mapFullscreen)
		{
			if (num12 < num6)
			{
				num -= (num12 - num6) * num5;
			}
			if (num13 < num7)
			{
				num2 -= (num13 - num7) * num5;
			}
		}
		num14 += num12;
		num15 += num13;
		if (num12 > num6)
		{
			num6 = num12;
		}
		if (num13 > num7)
		{
			num7 = num13;
		}
		if (num14 < num8)
		{
			num8 = num14;
		}
		if (num15 < num9)
		{
			num9 = num15;
		}
		MapRenderer.DrawMap(num, num2, num6, num8, num7, num9, num10, num11, num5, b);
		if (flag)
		{
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix);
		}
		if (!mapFullscreen)
		{
			if (mapStyle == 2)
			{
				float num39 = (num5 * 0.2f * 2f + 1f) / 3f;
				if (num39 > 1f)
				{
					num39 = 1f;
				}
				num39 *= UIScale;
				MapIcons.Draw(Vector2.Zero, new Vector2(num - 10f * num5, num2 - 10f * num5), null, num5, num39, b, ref text);
				revengeMarker = NPC.RevengeManager.DrawMapIcons(spriteBatch, Vector2.Zero, new Vector2(num - 10f * num5, num2 - 10f * num5), null, num5, num39, ref text);
				DrawMiscMapIcons(spriteBatch, Vector2.Zero, new Vector2(num - 10f * num5, num2 - 10f * num5), null, num5, num39, ref text);
				spriteBatch.End();
				if (revengeMarker != null)
				{
					spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, uIScaleMatrix);
					try
					{
						revengeMarker.UseMouseOver(spriteBatch, ref text, num39);
					}
					catch (Exception e)
					{
						TimeLogger.DrawException(e);
					}
					spriteBatch.End();
				}
				spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix);
				try
				{
					DrawNPCMapIcons3(num, num2, num5, b, num39);
				}
				catch (Exception e2)
				{
					TimeLogger.DrawException(e2);
				}
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix);
				for (int i = 0; i < 255; i++)
				{
					if (!player[i].active || !DrawPlayerMapIcon_CanBeSeen(i))
					{
						continue;
					}
					if (!player[i].dead && i != myPlayer)
					{
						float num40 = (player[i].position.X + (float)(player[i].width / 2)) / 16f * num5;
						float num41 = player[i].position.Y / 16f * num5;
						num40 += num;
						num41 += num2;
						num40 -= 6f;
						num41 -= 2f;
						num41 -= 2f - num5 / 5f * 2f;
						num40 -= 10f * num5;
						num41 -= 10f * num5;
						Microsoft.Xna.Framework.Color playerHeadBordersColor = GetPlayerHeadBordersColor(player[i]);
						MapPlayerRenderer.DrawPlayerHead(Camera, player[i], new Vector2(num40, num41), (float)(int)b / 255f, num39, playerHeadBordersColor);
					}
					if (player[i].showLastDeath)
					{
						float num42 = (player[i].lastDeathPostion.X / 16f - num12) * num5;
						float num43 = (player[i].lastDeathPostion.Y / 16f - num13) * num5;
						num42 += num;
						num43 += num2;
						num43 -= 2f - num5 / 5f * 2f;
						num42 -= 10f * num5;
						num43 -= 10f * num5;
						spriteBatch.Draw(TextureAssets.MapDeath.Value, new Vector2(num42, num43), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.MapDeath.Width(), TextureAssets.MapDeath.Height()), Microsoft.Xna.Framework.Color.White * ((float)(int)b / 255f), 0f, new Vector2((float)TextureAssets.MapDeath.Width() * 0.5f, (float)TextureAssets.MapDeath.Height() * 0.5f), num39, SpriteEffects.None, 0f);
						float num44 = num42 + 4f - 14f * num39;
						float num45 = num43 + 2f - 14f * num39;
						num44 -= 4f;
						num45 -= 4f;
						float num46 = num44 + 28f * num39;
						float num47 = num45 + 28f * num39;
						if ((float)mouseX >= num44 && (float)mouseX <= num46 && (float)mouseY >= num45 && (float)mouseY <= num47)
						{
							num19 = i;
						}
					}
				}
				spriteBatch.End();
				spriteBatch.Begin();
			}
			if (mapStyle == 1)
			{
				float num48 = (num5 * 0.25f * 2f + 1f) / 3f;
				if (num48 > 1f)
				{
					num48 = 1f;
				}
				MapIcons.Draw(new Vector2(num12, num13), new Vector2(num3 + num10, num4 + num11), new Microsoft.Xna.Framework.Rectangle(miniMapX, miniMapY, miniMapWidth, miniMapHeight), num5, num48, b, ref text);
				DrawDebugMapOverlays(num3 + num10, num4 + num11, num12, num13, num5);
				revengeMarker = NPC.RevengeManager.DrawMapIcons(spriteBatch, new Vector2(num12, num13), new Vector2(num3 + num10, num4 + num11), new Microsoft.Xna.Framework.Rectangle(miniMapX, miniMapY, miniMapWidth, miniMapHeight), num5, num48, ref text);
				DrawMiscMapIcons(spriteBatch, new Vector2(num12, num13), new Vector2(num3 + num10, num4 + num11), new Microsoft.Xna.Framework.Rectangle(miniMapX, miniMapY, miniMapWidth, miniMapHeight), num5, num48, ref text);
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix2);
				text = DrawNPCMapIcons2(text, num3, num4, num5, b, num10, num11, num12, num13, num48);
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix2);
				for (int j = 0; j < 255; j++)
				{
					if (!DrawPlayerMapIcon_CanBeSeen(j))
					{
						continue;
					}
					float num49 = ((player[j].position.X + (float)(player[j].width / 2)) / 16f - num12) * num5;
					float num50 = ((player[j].position.Y + player[j].gfxOffY + (float)(player[j].height / 2)) / 16f - num13) * num5;
					num49 += num3;
					num50 += num4;
					num49 -= 6f;
					num50 -= 6f;
					num50 -= 2f - num5 / 5f * 2f;
					num49 += num10;
					num50 += num11;
					if (!player[j].dead && num49 > (float)(miniMapX + 6) && num49 < (float)(miniMapX + miniMapWidth - 16) && num50 > (float)(miniMapY + 6) && num50 < (float)(miniMapY + miniMapHeight - 14))
					{
						Microsoft.Xna.Framework.Color playerHeadBordersColor2 = GetPlayerHeadBordersColor(player[j]);
						MapPlayerRenderer.DrawPlayerHead(Camera, player[j], new Vector2(num49, num50), (float)(int)b / 255f, num48, playerHeadBordersColor2);
						if (j != myPlayer)
						{
							float num51 = num49 + 4f - 14f * num48;
							float num52 = num50 + 2f - 14f * num48;
							float num53 = num51 + 28f * num48;
							float num54 = num52 + 28f * num48;
							if ((float)mouseX >= num51 && (float)mouseX <= num53 && (float)mouseY >= num52 && (float)mouseY <= num54)
							{
								text = player[j].name;
							}
						}
					}
					if (!player[j].showLastDeath)
					{
						continue;
					}
					num49 = (player[j].lastDeathPostion.X / 16f - num12) * num5;
					num50 = (player[j].lastDeathPostion.Y / 16f - num13) * num5;
					num49 += num3;
					num50 += num4;
					num50 -= 2f - num5 / 5f * 2f;
					num49 += num10;
					num50 += num11;
					if (num49 > (float)(miniMapX + 8) && num49 < (float)(miniMapX + miniMapWidth - 18) && num50 > (float)(miniMapY + 8) && num50 < (float)(miniMapY + miniMapHeight - 16))
					{
						spriteBatch.Draw(TextureAssets.MapDeath.Value, new Vector2(num49, num50), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.MapDeath.Width(), TextureAssets.MapDeath.Height()), Microsoft.Xna.Framework.Color.White * ((float)(int)b / 255f), 0f, new Vector2((float)TextureAssets.MapDeath.Width() * 0.5f, (float)TextureAssets.MapDeath.Height() * 0.5f), num48, SpriteEffects.None, 0f);
						float num55 = num49 + 4f - 14f * num48;
						float num56 = num50 + 2f - 14f * num48;
						num55 -= 4f;
						num56 -= 4f;
						float num57 = num55 + 28f * num48;
						float num58 = num56 + 28f * num48;
						if ((float)mouseX >= num55 && (float)mouseX <= num57 && (float)mouseY >= num56 && (float)mouseY <= num58)
						{
							num19 = j;
						}
					}
				}
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, transformMatrix2);
				MinimapFrameManagerInstance.DrawForeground(spriteBatch);
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, uIScaleMatrix);
				if (num19 != -1)
				{
					TimeSpan timeSpan = DateTime.Now - player[num19].lastDeathTime;
					text = Language.GetTextValue("Game.PlayerDeathTime", player[num19].name, Lang.LocalizedDuration(timeSpan, abbreviated: false, showAllAvailableUnits: false));
				}
				else
				{
					revengeMarker?.UseMouseOver(spriteBatch, ref text);
				}
			}
		}
		if (mapFullscreen)
		{
			int num59 = (int)((0f - num + (float)mouseX) / num5 + num6);
			int num60 = (int)((0f - num2 + (float)mouseY) / num5 + num7);
			bool flag2 = false;
			if ((float)num59 < num6)
			{
				flag2 = true;
			}
			if ((float)num59 >= num8)
			{
				flag2 = true;
			}
			if ((float)num60 < num7)
			{
				flag2 = true;
			}
			if ((float)num60 >= num9)
			{
				flag2 = true;
			}
			if (!flag2)
			{
				if (UIWorldGenDebug.ActiveInstance != null && keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.RightShift))
				{
					text = DebugUtils.GetTileDescription(num59, num60);
				}
				else if (Map[num59, num60].Light > 40)
				{
					int type = Map[num59, num60].Type;
					int num61 = MapHelper.tileLookup[21];
					int num62 = MapHelper.tileLookup[441];
					int num63 = MapHelper.tileOptionCounts[21];
					int num64 = MapHelper.tileLookup[467];
					int num65 = MapHelper.tileLookup[468];
					int num66 = MapHelper.tileOptionCounts[467];
					int num67 = MapHelper.tileLookup[88];
					int num68 = MapHelper.tileOptionCounts[88];
					LocalizedText[] chestType = Lang.chestType;
					LocalizedText[] chestType2 = Lang.chestType2;
					if (type >= num61 && type < num61 + num63)
					{
						Tile tile = Main.tile[num59, num60];
						if (tile != null)
						{
							int num69 = num59;
							int num70 = num60;
							if (tile.frameX % 36 != 0)
							{
								num69--;
							}
							if (tile.frameY % 36 != 0)
							{
								num70--;
							}
							text = DrawMap_FindChestName(chestType, tile, num69, num70);
						}
					}
					else if (type >= num64 && type < num64 + num66)
					{
						Tile tile2 = Main.tile[num59, num60];
						if (tile2 != null)
						{
							int num71 = num59;
							int num72 = num60;
							if (tile2.frameX % 36 != 0)
							{
								num71--;
							}
							if (tile2.frameY % 36 != 0)
							{
								num72--;
							}
							text = DrawMap_FindChestName(chestType2, tile2, num71, num72);
						}
					}
					else if (type >= num62 && type < num62 + num63)
					{
						Tile tile3 = Main.tile[num59, num60];
						if (tile3 != null)
						{
							int num73 = num59;
							int num74 = num60;
							if (tile3.frameX % 36 != 0)
							{
								num73--;
							}
							if (tile3.frameY % 36 != 0)
							{
								num74--;
							}
							text = chestType[tile3.frameX / 36].Value;
						}
					}
					else if (type >= num65 && type < num65 + num66)
					{
						Tile tile4 = Main.tile[num59, num60];
						if (tile4 != null)
						{
							int num75 = num59;
							int num76 = num60;
							if (tile4.frameX % 36 != 0)
							{
								num75--;
							}
							if (tile4.frameY % 36 != 0)
							{
								num76--;
							}
							text = chestType2[tile4.frameX / 36].Value;
						}
					}
					else if (type >= num67 && type < num67 + num68)
					{
						Tile tile5 = Main.tile[num59, num60];
						if (tile5 != null)
						{
							int num77 = num60;
							int x = num59 - tile5.frameX % 54 / 18;
							if (tile5.frameY % 36 != 0)
							{
								num77--;
							}
							int num78 = Chest.FindChest(x, num77);
							text = ((num78 < 0) ? Lang.dresserType[0].Value : ((!(chest[num78].name != "")) ? Lang.dresserType[tile5.frameX / 54].Value : (Lang.dresserType[tile5.frameX / 54].Value + ": " + chest[num78].name)));
						}
					}
					else
					{
						text = Lang.GetMapObjectName(type);
					}
				}
			}
			float num79 = (num5 * 0.25f * 2f + 1f) / 3f;
			if (num79 > 1f)
			{
				num79 = 1f;
			}
			num79 = 1f;
			num79 = UIScale;
			revengeMarker = NPC.RevengeManager.DrawMapIcons(spriteBatch, Vector2.Zero, new Vector2(num - 10f * num5, num2 - 10f * num5), null, num5, num79, ref text);
			DrawMiscMapIcons(spriteBatch, Vector2.Zero, new Vector2(num - 10f * num5, num2 - 10f * num5), null, num5, num79, ref text);
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend);
			text = DrawNPCMapIcons(text, num, num2, num5, b, num79);
			bool flag3 = false;
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend);
			int num80 = -1;
			for (int k = 0; k < 255; k++)
			{
				if (!DrawPlayerMapIcon_CanBeSeen(k) || player[k].dead)
				{
					continue;
				}
				float num81 = ((player[k].position.X + (float)(player[k].width / 2)) / 16f - num12) * num5;
				float num82 = ((player[k].position.Y + player[k].gfxOffY + (float)(player[k].height / 2)) / 16f - num13) * num5;
				num81 += num;
				num82 += num2;
				num81 -= 6f;
				num82 -= 2f;
				num82 -= 2f - num5 / 5f * 2f;
				num81 -= 10f * num5;
				num82 -= 10f * num5;
				float num83 = num81 + 4f - 14f * num79;
				float num84 = num82 + 2f - 14f * num79;
				float num85 = num83 + 28f * num79;
				float num86 = num84 + 28f * num79;
				if (player[k].dead)
				{
					continue;
				}
				Microsoft.Xna.Framework.Color playerHeadBordersColor3 = GetPlayerHeadBordersColor(player[k]);
				MapPlayerRenderer.DrawPlayerHead(Camera, player[k], new Vector2(num81, num82), (float)(int)b / 255f, num79, playerHeadBordersColor3);
				if (!((float)mouseX >= num83) || !((float)mouseX <= num85) || !((float)mouseY >= num84) || !((float)mouseY <= num86))
				{
					continue;
				}
				text = player[k].name;
				if (k != myPlayer && player[myPlayer].team > 0 && player[myPlayer].team == player[k].team && netMode == 1 && player[myPlayer].HasUnityPotion() && !flag3 && !cancelWormHole)
				{
					flag3 = true;
					if (!unityMouseOver)
					{
						SoundEngine.PlaySound(12);
					}
					unityMouseOver = true;
					playerHeadBordersColor3 = OurFavoriteColor;
					MapPlayerRenderer.DrawPlayerHead(Camera, player[k], new Vector2(num81, num82), 1f, num79 + 0.5f, playerHeadBordersColor3);
					text = Language.GetTextValue("Game.TeleportTo", player[k].name);
					if (mouseLeft && mouseLeftRelease)
					{
						num80 = k;
					}
				}
			}
			for (int l = 0; l < 255; l++)
			{
				if (DrawPlayerMapIcon_CanBeSeen(l) && player[l].showLastDeath && DrawPlayerDeathMarker(num, num2, num5, num12, num13, num79, l, b))
				{
					num19 = l;
				}
			}
			if (num19 != -1)
			{
				TimeSpan timeSpan2 = DateTime.Now - player[num19].lastDeathTime;
				text = Language.GetTextValue("Game.PlayerDeathTime", player[num19].name, Lang.LocalizedDuration(timeSpan2, abbreviated: false, showAllAvailableUnits: false));
			}
			else if (revengeMarker != null)
			{
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, uIScaleMatrix);
				revengeMarker.UseMouseOver(spriteBatch, ref text, num79);
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend);
			}
			MapIcons.Draw(Vector2.Zero, new Vector2(num - 10f * num5, num2 - 10f * num5), null, num5, num79, b, ref text);
			DrawDebugMapOverlays(num - 10f * num5, num2 - 10f * num5, num12, num13, num5);
			if (!cancelWormHole && num80 > -1)
			{
				mouseLeftRelease = false;
				mapFullscreen = false;
				Vector2 vector = player[num80].Bottom - player[myPlayer].Bottom;
				player[myPlayer].UnityTeleport(player[myPlayer].position + vector);
				player[myPlayer].TakeUnityPotion();
			}
			cancelWormHole = false;
			if (!flag3 && unityMouseOver)
			{
				unityMouseOver = false;
			}
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerStateForCursor, DepthStencilState.None, RasterizerState.CullCounterClockwise, null, UIScaleMatrix);
			PlayerInput.SetZoom_UI();
			if (!UIWorldGenDebug.IsActive)
			{
				int num87 = 10;
				int num88 = screenHeight - 40;
				if (showFrameRate)
				{
					num88 -= 15;
				}
				int num89 = 0;
				int num90 = 130;
				if (mouseX >= num87 && mouseX <= num87 + 32 && mouseY >= num88 && mouseY <= num88 + 30)
				{
					num90 = 255;
					num89 += 4;
					player[myPlayer].mouseInterface = true;
					if (mouseLeft && mouseLeftRelease)
					{
						SoundEngine.PlaySound(10);
						mapFullscreen = false;
					}
				}
				spriteBatch.Draw(TextureAssets.MapIcon[num89].Value, new Vector2(num87, num88), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.MapIcon[num89].Width(), TextureAssets.MapIcon[num89].Height()), new Microsoft.Xna.Framework.Color(num90, num90, num90, num90), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
			if (!gameMenu && !InGameUI.IsVisible)
			{
				DrawCursor(DrawThickCursor());
			}
		}
		mouseX = num17;
		mouseY = num18;
		float t = 3f;
		Utils.Swap(ref t, ref inventoryScale);
		if (text != "")
		{
			MouseText(text, 0, 0);
		}
		Utils.Swap(ref t, ref inventoryScale);
		spriteBatch.End();
		try
		{
			if (num12 < num6)
			{
				num += (num12 - num6) * num5;
			}
			if (num13 < num7)
			{
				num2 += (num13 - num7) * num5;
			}
			if (mapFullscreen && Main.OnPostFullscreenMapDraw != null)
			{
				Main.OnPostFullscreenMapDraw(new Vector2(num, num2), num5);
			}
		}
		catch (Exception e3)
		{
			TimeLogger.DrawException(e3);
		}
		spriteBatch.Begin();
		PlayerInput.SetZoom_Unscaled();
		TimeLogger.Map.AddTime(fromTimestamp);
	}

	private static bool DrawPlayerMapIcon_CanBeSeen(int playerIndex)
	{
		if (playerIndex == myPlayer)
		{
			return true;
		}
		Player player = Main.player[myPlayer];
		Player player2 = Main.player[playerIndex];
		if (!player2.active || player2.ShouldNotDraw)
		{
			return false;
		}
		if (!player.hostile && !player2.hostile)
		{
			return true;
		}
		if (player.team == player2.team && player2.team != 0)
		{
			return true;
		}
		return false;
	}

	private static void DrawNPCMapIcons3(float X, float Y, float scale, byte alpha, float headScale)
	{
		for (int i = 0; i < maxNPCs; i++)
		{
			if (npc[i].active && npc[i].townNPC && DrawNPCMapIcon_CanBeSeen_Townie(npc[i]))
			{
				int headIndexSafe = TownNPCProfiles.GetHeadIndexSafe(npc[i]);
				if (headIndexSafe > 0)
				{
					SpriteEffects dir = SpriteEffects.None;
					if (npc[i].direction > 0)
					{
						dir = SpriteEffects.FlipHorizontally;
					}
					Vector2 vector = npc[i].Center + new Vector2(0f, npc[i].gfxOffY) + npc[i].netOffset;
					float num = vector.X / 16f * scale;
					float num2 = vector.Y / 16f * scale;
					num += X;
					num2 += Y;
					num -= 10f * scale;
					num2 -= 10f * scale;
					DrawNPCHeadFriendly(npc[i], alpha, headScale, dir, headIndexSafe, num, num2);
				}
			}
			if (!npc[i].active || npc[i].GetBossHeadTextureIndex() == -1)
			{
				continue;
			}
			float bossHeadRotation = npc[i].GetBossHeadRotation();
			SpriteEffects bossHeadSpriteEffects = npc[i].GetBossHeadSpriteEffects();
			Vector2 vector2 = npc[i].Center + new Vector2(0f, npc[i].gfxOffY) + npc[i].netOffset;
			if (npc[i].type == 134)
			{
				Vector2 center = npc[i].Center;
				int num3 = 1;
				int num4 = (int)npc[i].ai[0];
				while (num3 < 15 && npc[num4].active && npc[num4].type >= 134 && npc[num4].type <= 136)
				{
					num3++;
					center += npc[num4].Center;
					num4 = (int)npc[num4].ai[0];
				}
				center /= (float)num3;
				vector2 = center;
			}
			int bossHeadTextureIndex = npc[i].GetBossHeadTextureIndex();
			float num5 = vector2.X / 16f * scale;
			float num6 = vector2.Y / 16f * scale;
			num5 += X;
			num6 += Y;
			num5 -= 10f * scale;
			num6 -= 10f * scale;
			DrawNPCHeadBoss(npc[i], alpha, headScale, bossHeadRotation, bossHeadSpriteEffects, bossHeadTextureIndex, num5, num6);
		}
	}

	private static string DrawNPCMapIcons2(string mouseTextString, float X2, float Y2, float scale, byte alpha, float xOff, float yOff, float left, float top, float headScale)
	{
		for (int i = 0; i < maxNPCs; i++)
		{
			if (npc[i].active && npc[i].townNPC && DrawNPCMapIcon_CanBeSeen_Townie(npc[i]))
			{
				int headIndexSafe = TownNPCProfiles.GetHeadIndexSafe(npc[i]);
				if (headIndexSafe > 0)
				{
					SpriteEffects dir = SpriteEffects.None;
					if (npc[i].direction > 0)
					{
						dir = SpriteEffects.FlipHorizontally;
					}
					Vector2 vector = npc[i].Center + new Vector2(0f, npc[i].gfxOffY) + npc[i].netOffset;
					float num = (vector.X / 16f - left) * scale;
					float num2 = (vector.Y / 16f - top) * scale;
					num += X2;
					num2 += Y2;
					num2 -= 2f * scale / 5f;
					num += xOff;
					num2 += yOff;
					if (num > (float)(miniMapX + 12) && num < (float)(miniMapX + miniMapWidth - 16) && num2 > (float)(miniMapY + 10) && num2 < (float)(miniMapY + miniMapHeight - 14))
					{
						float num3 = num - (float)(TextureAssets.NpcHead[headIndexSafe].Width() / 2) * headScale;
						float num4 = num2 - (float)(TextureAssets.NpcHead[headIndexSafe].Height() / 2) * headScale;
						float num5 = num3 + (float)TextureAssets.NpcHead[headIndexSafe].Width() * headScale;
						float num6 = num4 + (float)TextureAssets.NpcHead[headIndexSafe].Height() * headScale;
						if ((float)mouseX >= num3 && (float)mouseX <= num5 && (float)mouseY >= num4 && (float)mouseY <= num6)
						{
							mouseTextString = npc[i].FullName;
						}
						DrawNPCHeadFriendly(npc[i], alpha, headScale, dir, headIndexSafe, num, num2);
					}
				}
			}
			if (!npc[i].active || npc[i].GetBossHeadTextureIndex() == -1)
			{
				continue;
			}
			float bossHeadRotation = npc[i].GetBossHeadRotation();
			SpriteEffects bossHeadSpriteEffects = npc[i].GetBossHeadSpriteEffects();
			Vector2 vector2 = npc[i].Center + new Vector2(0f, npc[i].gfxOffY) + npc[i].netOffset;
			if (npc[i].type == 134)
			{
				Vector2 center = npc[i].Center;
				int num7 = 1;
				int num8 = (int)npc[i].ai[0];
				while (num7 < 15 && npc[num8].active && npc[num8].type >= 134 && npc[num8].type <= 136)
				{
					num7++;
					center += npc[num8].Center;
					num8 = (int)npc[num8].ai[0];
				}
				center /= (float)num7;
				vector2 = center;
			}
			int bossHeadTextureIndex = npc[i].GetBossHeadTextureIndex();
			float num9 = (vector2.X / 16f - left) * scale;
			float num10 = (vector2.Y / 16f - top) * scale;
			num9 += X2;
			num10 += Y2;
			num10 -= 2f * scale / 5f;
			num9 += xOff;
			num10 += yOff;
			if (num9 > (float)(miniMapX + 12) && num9 < (float)(miniMapX + miniMapWidth - 16) && num10 > (float)(miniMapY + 10) && num10 < (float)(miniMapY + miniMapHeight - 14))
			{
				float num11 = num9 - (float)(TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Width() / 2) * headScale;
				float num12 = num10 - (float)(TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Height() / 2) * headScale;
				float num13 = num11 + (float)TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Width() * headScale;
				float num14 = num12 + (float)TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Height() * headScale;
				if ((float)mouseX >= num11 && (float)mouseX <= num13 && (float)mouseY >= num12 && (float)mouseY <= num14)
				{
					mouseTextString = npc[i].GivenOrTypeName;
				}
				DrawNPCHeadBoss(npc[i], alpha, headScale, bossHeadRotation, bossHeadSpriteEffects, bossHeadTextureIndex, num9, num10);
			}
		}
		return mouseTextString;
	}

	private static string DrawNPCMapIcons(string mouseTextString, float X, float Y, float scale, byte alpha, float headScale)
	{
		for (int i = 0; i < maxNPCs; i++)
		{
			if (npc[i].active && npc[i].townNPC && DrawNPCMapIcon_CanBeSeen_Townie(npc[i]))
			{
				int headIndexSafe = TownNPCProfiles.GetHeadIndexSafe(npc[i]);
				if (headIndexSafe > 0)
				{
					SpriteEffects dir = SpriteEffects.None;
					if (npc[i].direction > 0)
					{
						dir = SpriteEffects.FlipHorizontally;
					}
					Vector2 vector = npc[i].Center + new Vector2(0f, npc[i].gfxOffY) + npc[i].netOffset;
					float num = vector.X / 16f * scale;
					float num2 = vector.Y / 16f * scale;
					num += X;
					num2 += Y;
					num -= 10f * scale;
					num2 -= 10f * scale;
					float num3 = num - (float)(TextureAssets.NpcHead[headIndexSafe].Width() / 2) * headScale;
					float num4 = num2 - (float)(TextureAssets.NpcHead[headIndexSafe].Height() / 2) * headScale;
					float num5 = num3 + (float)TextureAssets.NpcHead[headIndexSafe].Width() * headScale;
					float num6 = num4 + (float)TextureAssets.NpcHead[headIndexSafe].Height() * headScale;
					if ((float)mouseX >= num3 && (float)mouseX <= num5 && (float)mouseY >= num4 && (float)mouseY <= num6)
					{
						mouseTextString = npc[i].FullName;
					}
					DrawNPCHeadFriendly(npc[i], alpha, headScale, dir, headIndexSafe, num, num2);
				}
			}
			if (!npc[i].active || npc[i].GetBossHeadTextureIndex() == -1)
			{
				continue;
			}
			float bossHeadRotation = npc[i].GetBossHeadRotation();
			SpriteEffects bossHeadSpriteEffects = npc[i].GetBossHeadSpriteEffects();
			Vector2 vector2 = npc[i].Center + new Vector2(0f, npc[i].gfxOffY) + npc[i].netOffset;
			if (npc[i].type == 134)
			{
				Vector2 center = npc[i].Center;
				int num7 = 1;
				int num8 = (int)npc[i].ai[0];
				while (num7 < 15 && npc[num8].active && npc[num8].type >= 134 && npc[num8].type <= 136)
				{
					num7++;
					center += npc[num8].Center;
					num8 = (int)npc[num8].ai[0];
				}
				center /= (float)num7;
				vector2 = center;
			}
			int bossHeadTextureIndex = npc[i].GetBossHeadTextureIndex();
			float num9 = vector2.X / 16f * scale;
			float num10 = vector2.Y / 16f * scale;
			num9 += X;
			num10 += Y;
			num9 -= 10f * scale;
			num10 -= 10f * scale;
			DrawNPCHeadBoss(npc[i], alpha, headScale, bossHeadRotation, bossHeadSpriteEffects, bossHeadTextureIndex, num9, num10);
			float num11 = num9 - (float)(TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Width() / 2) * headScale;
			float num12 = num10 - (float)(TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Height() / 2) * headScale;
			float num13 = num11 + (float)TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Width() * headScale;
			float num14 = num12 + (float)TextureAssets.NpcHeadBoss[bossHeadTextureIndex].Height() * headScale;
			if ((float)mouseX >= num11 && (float)mouseX <= num13 && (float)mouseY >= num12 && (float)mouseY <= num14)
			{
				mouseTextString = npc[i].GivenOrTypeName;
			}
		}
		return mouseTextString;
	}

	private static bool DrawNPCMapIcon_CanBeSeen_Townie(NPC npc)
	{
		return true;
	}

	private void DrawDebugMapOverlays(float X, float Y, float left, float top, float scale)
	{
		if (DebugOptions.ShowSections)
		{
			DrawDebugSectionsOnMap(X, Y, left, top, scale);
		}
		if (DebugOptions.ShowUnbreakableWall)
		{
			DrawUnbreakableWallScansOnMap(X, Y, left, top, scale);
		}
	}

	private void DrawDebugSectionsOnMap(float X, float Y, float left, float top, float scale)
	{
		for (int i = 0; i < maxSectionsX; i++)
		{
			for (int j = 0; j < maxSectionsY; j++)
			{
				if (ActiveSections.IsSectionActive(new Microsoft.Xna.Framework.Point(i, j)))
				{
					float x = ((float)(i * 200) - left) * scale + X;
					float y = ((float)(j * 150) - top) * scale + Y;
					Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.DarkGreen * Utils.Remap(ActiveSections.TimeTillInactive(new Microsoft.Xna.Framework.Point(i, j)), 0f, ActiveSections.SectionInactiveTime, 0.25f, 0.6f);
					spriteBatch.Draw(TextureAssets.MagicPixel.Value, new Vector2(x, y), new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1), color, 0f, Vector2.Zero, new Vector2(200f * scale, 150f * scale), SpriteEffects.None, 0f);
				}
			}
		}
	}

	private void DrawUnbreakableWallScansOnMap(float X, float Y, float left, float top, float scale)
	{
		Microsoft.Xna.Framework.Point point = LocalPlayer.Center.ToTileCoordinates();
		Vector2 vector = point.ToVector2();
		Microsoft.Xna.Framework.Point[] directions = UnbreakableWallScan.Directions;
		foreach (Microsoft.Xna.Framework.Point point2 in directions)
		{
			bool num = UnbreakableWallScan.LineScan(point, point2);
			Vector2 vector2 = vector + point2.ToVector2() * UnbreakableWallScan.ScanDistance;
			Microsoft.Xna.Framework.Color color = (num ? Microsoft.Xna.Framework.Color.Red : Microsoft.Xna.Framework.Color.Yellow);
			Utils.DrawLine(spriteBatch, (vector - new Vector2(left, top)) * scale + new Vector2(X, Y) + screenPosition, (vector2 - new Vector2(left, top)) * scale + new Vector2(X, Y) + screenPosition, color, color, 1f);
		}
	}

	private static void DrawMapFullscreenBackground(Vector2 screenPosition, int screenWidth, int screenHeight)
	{
		Asset<Texture2D> asset = TextureAssets.MapBGs[0];
		int num = -1;
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.White;
		if (!WorldGen.InWorld((int)(player[myPlayer].Center.X / 16f), (int)(player[myPlayer].Center.Y / 16f), 10) || tile[(int)(player[myPlayer].Center.X / 16f), (int)(player[myPlayer].Center.Y / 16f)] == null)
		{
			return;
		}
		int wall = tile[(int)(player[myPlayer].Center.X / 16f), (int)(player[myPlayer].Center.Y / 16f)].wall;
		if (screenPosition.Y > (float)((maxTilesY - 232) * 16))
		{
			num = 2;
		}
		else if (player[myPlayer].ZoneDungeon)
		{
			num = 4;
		}
		else if (wall == 87)
		{
			num = 13;
		}
		else if ((double)screenPosition.Y > worldSurface * 16.0)
		{
			switch (wall)
			{
			case 86:
			case 108:
				num = 15;
				break;
			case 180:
			case 184:
				num = 16;
				break;
			case 178:
			case 183:
				num = 17;
				break;
			case 62:
			case 263:
				num = 18;
				break;
			default:
				num = ((!player[myPlayer].ZoneGlowshroom) ? ((!player[myPlayer].ZoneCorrupt) ? ((!player[myPlayer].ZoneCrimson) ? ((!player[myPlayer].ZoneHallow) ? ((!player[myPlayer].ZoneSnow) ? ((!player[myPlayer].ZoneJungle) ? ((!player[myPlayer].ZoneDesert) ? ((!player[myPlayer].ZoneRockLayerHeight) ? 1 : 31) : 14) : 12) : 3) : ((!player[myPlayer].ZoneDesert) ? ((!player[myPlayer].ZoneSnow) ? 21 : 35) : 41)) : ((!player[myPlayer].ZoneDesert) ? ((!player[myPlayer].ZoneSnow) ? 23 : 34) : 40)) : ((!player[myPlayer].ZoneDesert) ? ((!player[myPlayer].ZoneSnow) ? 22 : 33) : 39)) : 20);
				break;
			}
		}
		else if (player[myPlayer].ZoneGlowshroom)
		{
			num = 19;
		}
		else
		{
			color = ColorOfTheSkies;
			int num2 = (int)((screenPosition.X + (float)(screenWidth / 2)) / 16f);
			if (player[myPlayer].ZoneSkyHeight)
			{
				num = 32;
			}
			else if (player[myPlayer].ZoneCorrupt)
			{
				num = ((!player[myPlayer].ZoneDesert) ? 5 : 36);
			}
			else if (player[myPlayer].ZoneCrimson)
			{
				num = ((!player[myPlayer].ZoneDesert) ? 6 : 37);
			}
			else if (player[myPlayer].ZoneHallow)
			{
				num = ((!player[myPlayer].ZoneDesert) ? 7 : 38);
			}
			else if ((double)(screenPosition.Y / 16f) < worldSurface + 10.0 && (num2 < 380 || num2 > maxTilesX - 380))
			{
				num = 10;
			}
			else if (player[myPlayer].ZoneSnow)
			{
				num = 11;
			}
			else if (player[myPlayer].ZoneJungle)
			{
				num = 8;
			}
			else if (player[myPlayer].ZoneDesert)
			{
				num = 9;
			}
			else if (bloodMoon)
			{
				color *= 2f;
				num = 25;
			}
			else if (player[myPlayer].ZoneGraveyard)
			{
				num = 26;
			}
		}
		if (num > -1)
		{
			asset = TextureAssets.MapBGs[num];
		}
		spriteBatch.Draw(asset.Value, new Microsoft.Xna.Framework.Rectangle(0, 0, screenWidth, screenHeight), color);
	}

	private static bool DrawPlayerDeathMarker(float X, float Y, float scale, float left, float top, float headScale, int i, int alpha)
	{
		float num = (player[i].lastDeathPostion.X / 16f - left) * scale;
		float num2 = (player[i].lastDeathPostion.Y / 16f - top) * scale;
		num += X;
		num2 += Y;
		num2 -= 2f - scale / 5f * 2f;
		num -= 10f * scale;
		num2 -= 10f * scale;
		spriteBatch.Draw(TextureAssets.MapDeath.Value, new Vector2(num, num2), new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.MapDeath.Width(), TextureAssets.MapDeath.Height()), Microsoft.Xna.Framework.Color.White * ((float)alpha / 255f), 0f, new Vector2((float)TextureAssets.MapDeath.Width() * 0.5f, (float)TextureAssets.MapDeath.Height() * 0.5f), headScale, SpriteEffects.None, 0f);
		float num3 = num + 4f - 14f * headScale;
		float num4 = num2 + 2f - 14f * headScale;
		float num5 = num3 + 28f * headScale;
		float num6 = num4 + 28f * headScale;
		if ((float)mouseX >= num3 && (float)mouseX <= num5 && (float)mouseY >= num4)
		{
			return (float)mouseY <= num6;
		}
		return false;
	}

	private void DrawMiscMapIcons(SpriteBatch spriteBatch, Vector2 mapTopLeft, Vector2 mapX2Y2AndOff, Microsoft.Xna.Framework.Rectangle? mapRect, float mapScale, float drawScale, ref string mouseTextString)
	{
		DrawMapIcons_PotionOfReturnHomePosition(spriteBatch, mapTopLeft, mapX2Y2AndOff, mapRect, mapScale, drawScale, ref mouseTextString);
		DrawMapIcons_PotionOfReturnAppearAfterUsePosition(spriteBatch, mapTopLeft, mapX2Y2AndOff, mapRect, mapScale, drawScale, ref mouseTextString);
		DrawMapIcons_LastGolfballHit(spriteBatch, mapTopLeft, mapX2Y2AndOff, mapRect, mapScale, drawScale, ref mouseTextString);
	}

	private void DrawMapIcons_PotionOfReturnAppearAfterUsePosition(SpriteBatch spriteBatch, Vector2 mapTopLeft, Vector2 mapX2Y2AndOff, Microsoft.Xna.Framework.Rectangle? mapRect, float mapScale, float drawScale, ref string mouseTextString)
	{
		Vector2? potionOfReturnOriginalUsePosition = LocalPlayer.PotionOfReturnOriginalUsePosition;
		if (!potionOfReturnOriginalUsePosition.HasValue)
		{
			return;
		}
		Vector2 vec = (potionOfReturnOriginalUsePosition + new Vector2(0f, -LocalPlayer.height / 2)).Value / 16f - mapTopLeft;
		vec *= mapScale;
		vec += mapX2Y2AndOff;
		vec = vec.Floor();
		if (!mapRect.HasValue || mapRect.Value.Contains(vec.ToPoint()))
		{
			Texture2D value = TextureAssets.Extra[173].Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value.Frame();
			spriteBatch.Draw(value, vec, rectangle, Microsoft.Xna.Framework.Color.White, 0f, rectangle.Size() / 2f, drawScale, SpriteEffects.None, 0f);
			if (Utils.CenteredRectangle(vec, rectangle.Size() * drawScale).Contains(MouseScreen.ToPoint()))
			{
				mouseTextString = Language.GetTextValue("GameUI.PotionOfReturnExitPortal");
				_ = MouseScreen + new Vector2(-28f) + new Vector2(4f, 0f);
			}
		}
	}

	private void DrawMapIcons_PotionOfReturnHomePosition(SpriteBatch spriteBatch, Vector2 mapTopLeft, Vector2 mapX2Y2AndOff, Microsoft.Xna.Framework.Rectangle? mapRect, float mapScale, float drawScale, ref string mouseTextString)
	{
		Vector2? potionOfReturnHomePosition = LocalPlayer.PotionOfReturnHomePosition;
		if (!potionOfReturnHomePosition.HasValue)
		{
			return;
		}
		Vector2 vec = (potionOfReturnHomePosition + new Vector2(0f, -LocalPlayer.height / 2)).Value / 16f - mapTopLeft;
		vec *= mapScale;
		vec += mapX2Y2AndOff;
		vec = vec.Floor();
		if (!mapRect.HasValue || mapRect.Value.Contains(vec.ToPoint()))
		{
			Texture2D value = TextureAssets.Extra[175].Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value.Frame();
			spriteBatch.Draw(value, vec, rectangle, Microsoft.Xna.Framework.Color.White, 0f, rectangle.Size() / 2f, drawScale, SpriteEffects.None, 0f);
			if (Utils.CenteredRectangle(vec, rectangle.Size() * drawScale).Contains(MouseScreen.ToPoint()))
			{
				mouseTextString = Language.GetTextValue("GameUI.PotionOfReturnHomePortal");
				_ = MouseScreen + new Vector2(-28f) + new Vector2(4f, 0f);
			}
		}
	}

	private void DrawMapIcons_LastGolfballHit(SpriteBatch spriteBatch, Vector2 mapTopLeft, Vector2 mapX2Y2AndOff, Microsoft.Xna.Framework.Rectangle? mapRect, float mapScale, float drawScale, ref string mouseTextString)
	{
		Projectile lastHitBall = LocalGolfState.GetLastHitBall();
		if (lastHitBall == null)
		{
			return;
		}
		Vector2 vec = lastHitBall.Center / 16f - mapTopLeft;
		vec *= mapScale;
		vec += mapX2Y2AndOff;
		vec = vec.Floor();
		if (!mapRect.HasValue || mapRect.Value.Contains(vec.ToPoint()))
		{
			Texture2D value = TextureAssets.Extra[176].Value;
			Microsoft.Xna.Framework.Rectangle rectangle = value.Frame();
			spriteBatch.Draw(value, vec, rectangle, Microsoft.Xna.Framework.Color.White, 0f, rectangle.Size() / 2f, drawScale, SpriteEffects.None, 0f);
			Microsoft.Xna.Framework.Rectangle rectangle2 = Utils.CenteredRectangle(vec, rectangle.Size() * drawScale);
			LoadProjectile(lastHitBall.type);
			value = TextureAssets.Projectile[lastHitBall.type].Value;
			rectangle = value.Frame();
			spriteBatch.Draw(value, vec, rectangle, Microsoft.Xna.Framework.Color.White, 0f, rectangle.Size() / 2f, drawScale, SpriteEffects.None, 0f);
			if (rectangle2.Contains(MouseScreen.ToPoint()))
			{
				mouseTextString = lastHitBall.Name;
				_ = MouseScreen + new Vector2(-28f) + new Vector2(4f, 0f);
			}
		}
	}

	public static void TriggerPing(Vector2 position)
	{
		if (!dedServ)
		{
			Pings.Add(position);
			if (netMode == 1)
			{
				NetManager.Instance.SendToServer(NetPingModule.Serialize(position));
			}
		}
	}

	private static void DrawNPCHeadFriendly(Entity theNPC, byte alpha, float headScale, SpriteEffects dir, int townHeadId, float x, float y)
	{
		TownNPCHeadRenderer.DrawWithOutlines(townHeadId, new Vector2(x, y), new Microsoft.Xna.Framework.Color(alpha, alpha, alpha, alpha), 0f, headScale, dir);
		if (theNPC is NPC { nextDialogue: not null } nPC && nPC.nextDialogue.ShowIndicator)
		{
			Utils.DrawNotificationIcon(spriteBatch, new Vector2(x, y - 20f));
		}
	}

	private static void DrawNPCHeadBoss(Entity theNPC, byte alpha, float headScale, float rotation, SpriteEffects effects, int bossHeadId, float x, float y)
	{
		BossNPCHeadRenderer.DrawWithOutlines(bossHeadId, new Vector2(x, y), new Microsoft.Xna.Framework.Color(alpha, alpha, alpha, alpha), rotation, headScale, effects);
	}

	private static void DrawWithOutlines(Entity entity, Texture2D tex, Vector2 position, Microsoft.Xna.Framework.Rectangle? rect, Microsoft.Xna.Framework.Color color, float rotation, Vector2 origin, float scale, SpriteEffects effects)
	{
		float num = 2f * scale;
		Microsoft.Xna.Framework.Color white = Microsoft.Xna.Framework.Color.White;
		int colorOnlyShaderIndex = ContentSamples.DyeShaderIDs.ColorOnlyShaderIndex;
		DrawData value = new DrawData(tex, position, rect, color, rotation, origin, scale, effects);
		GameShaders.Armor.Apply(colorOnlyShaderIndex, entity, value);
		Microsoft.Xna.Framework.Color black = Microsoft.Xna.Framework.Color.Black;
		black *= (float)(int)color.A / 255f;
		black *= (float)(int)color.A / 255f;
		Microsoft.Xna.Framework.Color color2 = white;
		color2 *= (float)(int)color.A / 255f;
		color2 *= (float)(int)color.A / 255f;
		int num2 = 2;
		Vector2 vector;
		for (int i = -num2; i <= num2; i++)
		{
			for (int j = -num2; j <= num2; j++)
			{
				if (Math.Abs(i) + Math.Abs(j) == num2)
				{
					vector = new Vector2((float)i * num, (float)j * num).RotatedBy(rotation);
					spriteBatch.Draw(tex, position + vector, rect, black, rotation, origin, scale, effects, 0f);
				}
			}
		}
		num2 = 1;
		vector = Vector2.Zero;
		for (int k = -num2; k <= num2; k++)
		{
			for (int l = -num2; l <= num2; l++)
			{
				if (Math.Abs(k) + Math.Abs(l) == num2)
				{
					vector = new Vector2((float)k * num, (float)l * num).RotatedBy(rotation);
					spriteBatch.Draw(tex, position + vector, rect, color2, rotation, origin, scale, effects, 0f);
				}
			}
		}
		pixelShader.CurrentTechnique.Passes[0].Apply();
		spriteBatch.Draw(tex, position, rect, color, rotation, origin, scale, effects, 0f);
	}

	public static Microsoft.Xna.Framework.Color GetPlayerHeadBordersColor(Player plr)
	{
		if (plr.ghost || plr.dead)
		{
			return Microsoft.Xna.Framework.Color.Transparent;
		}
		if (netMode == 0)
		{
			return teamColor[0];
		}
		if (plr.whoAmI == myPlayer)
		{
			return teamColor[plr.team];
		}
		if (plr.hostile && (plr.team != LocalPlayer.team || plr.team == 0))
		{
			return Microsoft.Xna.Framework.Color.Transparent;
		}
		return teamColor[plr.team];
	}

	private static string DrawMap_FindChestName(LocalizedText[] chestNames, Tile chestTile, int x, int y, int fullTileWidth = 36)
	{
		int num = Chest.FindChest(x, y);
		if (num < 0)
		{
			return chestNames[0].Value;
		}
		if (chest[num].name != "")
		{
			return string.Concat(chestNames[chestTile.frameX / fullTileWidth], ": ", chest[num].name);
		}
		return chestNames[chestTile.frameX / fullTileWidth].Value;
	}

	public void DrawSimpleSurfaceBackground(Vector2 areaPosition, int areaWidth, int areaHeight)
	{
		float num = (float)(worldSurface + 1.0) * 16f;
		float num2 = Math.Min(areaPosition.Y + (float)areaHeight, num) - areaPosition.Y;
		float y = areaPosition.Y;
		float num3 = areaPosition.Y + num2;
		Vector4 vector = ColorOfTheSkies.ToVector4();
		Vector4 value = new Microsoft.Xna.Framework.Color(53, 43, 243).ToVector4() * vector;
		Vector4 value2 = new Microsoft.Xna.Framework.Color(132, 170, 248).ToVector4() * vector;
		Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(Vector4.Lerp(value, value2, y / num));
		Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color(Vector4.Lerp(value, value2, num3 / num));
		VertexColors colors = default(VertexColors);
		colors.TopLeftColor = color;
		colors.TopRightColor = color;
		colors.BottomLeftColor = color2;
		colors.BottomRightColor = color2;
		tileBatch.Draw(TextureAssets.BlackTile.Value, new Vector4(0f, 0f, areaWidth, num2), colors);
		float num4 = (float)areaHeight - num2;
		if (num4 > 0f)
		{
			colors.TopLeftColor = Microsoft.Xna.Framework.Color.Black;
			colors.TopRightColor = Microsoft.Xna.Framework.Color.Black;
			colors.BottomLeftColor = Microsoft.Xna.Framework.Color.Black;
			colors.BottomRightColor = Microsoft.Xna.Framework.Color.Black;
			tileBatch.Draw(TextureAssets.BlackTile.Value, new Vector4(0f, num2, areaWidth, num4), colors);
		}
	}

	internal void DrawCapture(Microsoft.Xna.Framework.Rectangle area, CaptureSettings settings, CaptureCamera camera)
	{
		float[] array = bgAlphaFrontLayer;
		bgAlphaFrontLayer = new float[array.Length];
		float[] array2 = bgAlphaFarBackLayer;
		bgAlphaFarBackLayer = new float[array2.Length];
		UpdateBGVisibility_BackLayer(settings.Biome.BackgroundIndex, 1f);
		UpdateBGVisibility_FrontLayer(settings.Biome.BackgroundIndex, 1f);
		float[] array3 = liquidAlpha.ToArray();
		int holyTileCount = SceneMetrics.HolyTileCount;
		SceneMetrics.HolyTileCount = ((settings.Biome.BackgroundIndex == 6) ? SceneMetrics.HallowTileMax : 0);
		bool foregroundSunlightEffects = ForegroundSunlightEffects;
		ForegroundSunlightEffects = settings.CameraSpaceEffects;
		int num = offScreenRange;
		offScreenRange = 0;
		SpriteViewMatrix gameViewMatrix = GameViewMatrix;
		GameViewMatrix = new SpriteViewMatrix(base.GraphicsDevice);
		Rasterizer = RasterizerState.CullCounterClockwise;
		bool captureEntities = settings.CaptureEntities;
		bool captureBackground = settings.CaptureBackground;
		CaptureBiome biome = settings.Biome;
		Vector2 vector = screenPosition;
		int num2 = screenWidth;
		int num3 = screenHeight;
		bool captureMech = settings.CaptureMech;
		screenWidth = area.Width << 4;
		screenHeight = area.Height << 4;
		screenPosition = new Vector2(area.X * 16, area.Y * 16);
		for (int i = 0; i <= 10; i++)
		{
			if (i != 1)
			{
				liquidAlpha[i] = ((i == biome.WaterStyle) ? 1f : 0f);
			}
		}
		float num4 = (biome.TileColor == CaptureBiome.TileColorStyle.Mushroom).ToInt();
		SetBackColor(new InfoToSetBackColor
		{
			isInGameMenuOrIsServer = (gameMenu || netMode == 2),
			CorruptionBiomeInfluence = (biome.TileColor == CaptureBiome.TileColorStyle.Corrupt).ToInt(),
			CrimsonBiomeInfluence = (biome.TileColor == CaptureBiome.TileColorStyle.Crimson).ToInt(),
			JungleBiomeInfluence = (biome.TileColor == CaptureBiome.TileColorStyle.Jungle).ToInt(),
			MushroomBiomeInfluence = num4,
			GraveyardInfluence = GraveyardVisualIntensity,
			BloodMoonActive = (biome.WaterStyle == 9),
			LanternNightActive = LanternNight.LanternsUp
		}, out var sunColor, out var moonColor);
		ApplyColorOfTheSkiesToTiles();
		UpdateAtmosphereTransparencyToSkyColor(settings.CameraSpaceEffects ? (vector.Y + (float)(screenHeight / 2)) : ((float)(settings.Area.Center.Y * 16)));
		ColorOfSurfaceBackgroundsBase = (ColorOfSurfaceBackgroundsModified = ColorOfTheSkies);
		WorldSceneLayerTarget worldSceneLayerTarget = waterTarget;
		camera.BeginDrawCapture();
		bool flag = mapEnabled;
		mapEnabled = false;
		Lighting.Initialize();
		renderCount = 99;
		for (int j = 0; j < 4; j++)
		{
			Lighting.LightTiles(area);
		}
		mapEnabled = flag;
		waterTarget.UpdateContent(RenderWater);
		if (!((float)(settings.Area.X * 16) > vector.X - 16f) || !((float)(settings.Area.Y * 16) > vector.Y - 16f) || !((float)((settings.Area.X + settings.Area.Width) * 16) < vector.X + (float)num2 + 16f) || !((float)((settings.Area.Y + settings.Area.Height) * 16) < vector.Y + (float)num3 + 16f))
		{
			for (int k = 0; k < dust.Length; k++)
			{
				if (dust[k].active && dust[k].type == 76)
				{
					dust[k].active = false;
				}
			}
		}
		Vector2 vector2 = (drawToScreen ? Vector2.Zero : new Vector2(offScreenRange, offScreenRange));
		int val = (int)((screenPosition.X - vector2.X) / 16f - 1f);
		int val2 = (int)((screenPosition.X + (float)screenWidth + vector2.X) / 16f) + 2;
		int val3 = (int)((screenPosition.Y - vector2.Y) / 16f - 1f);
		int val4 = (int)((screenPosition.Y + (float)screenHeight + vector2.Y) / 16f) + 5;
		vector2 -= screenPosition;
		val = Math.Max(val, 5) - 2;
		val3 = Math.Max(val3, 5);
		val2 = Math.Min(val2, maxTilesX - 5) + 2;
		val4 = Math.Min(val4, maxTilesY - 5) + 4;
		Microsoft.Xna.Framework.Rectangle drawArea = new Microsoft.Xna.Framework.Rectangle(val, val3, val2 - val, val4 - val3);
		LiquidRenderer.Instance.PrepareDraw(drawArea);
		WorldGen.SectionTileFrameWithCheck(area.Left, area.Top, area.Right, area.Bottom);
		base.GraphicsDevice.Clear(Microsoft.Xna.Framework.Color.Transparent);
		float num5 = 1f / BackgroundViewMatrix.RenderZoom.X;
		int num6 = (int)((float)num2 * num5);
		int num7 = (int)((float)num3 * num5);
		Vector2 vector3 = vector + Utils.Round(new Vector2(num2, num3) / 2f * (Vector2.One - Vector2.One / BackgroundViewMatrix.RenderZoom));
		SceneArea sceneArea = default(SceneArea);
		SpriteBatchBeginner spriteBatchBeginner = default(SpriteBatchBeginner);
		Vector2 lastCelestialBodyPosition = default(Vector2);
		if (captureBackground)
		{
			tileBatch.Begin();
			DrawSimpleSurfaceBackground(new Vector2(area.X * 16, area.Y * 16), area.Width * 16, area.Height * 16);
			tileBatch.End();
			Matrix transform = Transform;
			int num8 = screenHeight;
			int num9 = screenWidth;
			Vector2 vector4 = screenPosition;
			bool flag2 = mapFullscreen;
			mapFullscreen = false;
			float num10 = scAdj;
			float? verticalParallaxOverride = null;
			if (settings.CameraSpaceEffects)
			{
				screenWidth = num6;
				screenHeight = num7;
				screenPosition = vector3;
				Vector2 vector5 = BackgroundViewMatrix.RenderZoom / gameViewMatrix.RenderZoom;
				Vector2 vector6 = screenPosition + new Vector2(screenWidth, screenHeight) / 2f * (Vector2.One - vector5) - vector4;
				transform = Matrix.CreateScale(vector5.X, vector5.Y, 1f) * Matrix.CreateTranslation(vector6.X, vector6.Y, 0f) * transform;
			}
			else
			{
				Microsoft.Xna.Framework.Rectangle rectangle = Microsoft.Xna.Framework.Rectangle.Intersect(new Microsoft.Xna.Framework.Rectangle(0, 0, maxTilesX, (int)worldSurface), settings.Area);
				int num11 = 2048;
				float num12 = MathHelper.Clamp((float)rectangle.Height * 16f / (float)num11, 1f, 3f);
				screenWidth = (int)Math.Ceiling((float)(rectangle.Width * 16) / num12);
				screenHeight = (int)Math.Ceiling((float)(rectangle.Height * 16) / num12);
				screenPosition.X = settings.Area.X * 16;
				screenPosition.Y = settings.Area.Y * 16;
				float num13 = (float)maxTilesY * 0.15f;
				verticalParallaxOverride = (float)Utils.Remap(screenPosition.Y, worldSurface * 16.0, num13 * 16f, -1.0, -0.5);
				int num14 = -120;
				int y = MaxWorldViewSize.Y;
				float val5 = Math.Max(0f, (float)screenHeight - ((float)y * (2f + verticalParallaxOverride.Value) + (float)num14));
				float num15 = Math.Min(num13 * 16f * 0.75f - screenPosition.Y, rectangle.Height * 16);
				float val6 = (float)Math.Pow(Utils.Remap(screenPosition.Y, num13 * 16f, 0f, 0f, 1f), 2.0) * num15 / num12;
				float toMax = Math.Max(val5, val6);
				float toMin = ComputeScAdj(screenPosition.Y, num8);
				scAdj = Utils.Remap(settings.Area.Height * 16, MaxWorldViewSize.Y, num11, toMin, toMax);
				transform = Matrix.CreateScale(num12) * Matrix.CreateTranslation((screenPosition - vector4).ToVector3()) * transform;
				screenPosition.Y += (rectangle.Height * 16 - screenHeight) / 2;
			}
			Microsoft.Xna.Framework.Rectangle worldRect = new Microsoft.Xna.Framework.Rectangle((int)screenPosition.X, (int)screenPosition.Y, screenWidth, screenHeight);
			worldRect.Inflate(Math.Max(0, minScreenW - screenWidth) / 2, Math.Max(0, minScreenH - screenHeight) / 2);
			worldRect = WorldUtils.ClampToWorldBorders(worldRect);
			transform = Matrix.CreateTranslation((worldRect.TopLeft() - screenPosition).ToVector3()) * transform;
			screenPosition = worldRect.TopLeft();
			screenWidth = worldRect.Width;
			screenHeight = worldRect.Height;
			_ = screenPosition;
			spriteBatchBeginner = new SpriteBatchBeginner(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, transform);
			spriteBatchBeginner.Begin(spriteBatch);
			HorizonRenderer.DrawHorizon();
			sceneArea = new SceneArea
			{
				bgTopY = (int)((0f - screenPosition.Y) / ((float)worldSurface * 16f - 600f) * 200f),
				totalWidth = screenWidth,
				totalHeight = screenHeight
			};
			Vector2 vector7 = new Vector2(screenWidth, screenHeight) / new Vector2(num6, num7);
			Vector2[] array4 = new Vector2[numClouds];
			for (int l = 0; l < numClouds; l++)
			{
				array4[l] = cloud[l].position;
				cloud[l].position *= vector7;
			}
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0 && shimmerAlpha != 1f)
			{
				DrawStarsInBackground(sceneArea, artificial: false);
			}
			if ((double)(screenPosition.Y / 16f) < worldSurface + 2.0)
			{
				DrawSunAndMoon(sceneArea, moonColor, sunColor, num4);
			}
			DrawSurfaceBG(spriteBatchBeginner, verticalParallaxOverride);
			if (settings.CameraSpaceEffects)
			{
				DrawUnderworldBackground(GameZoomTarget);
			}
			else
			{
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(0, UnderworldLayer, maxTilesX, maxTilesY - UnderworldLayer);
				Microsoft.Xna.Framework.Rectangle rectangle2 = Microsoft.Xna.Framework.Rectangle.Intersect(settings.Area, value);
				int y2 = MaxWorldViewSize.Y;
				int num16 = Utils.Clamp(rectangle2.Center.Y * 16, value.Top * 16 + y2 / 2, value.Bottom * 16 - y2 / 2);
				screenPosition.Y = num16 - y2 / 2;
				screenPosition.X = rectangle2.Left * 16;
				float num17 = Math.Max(1f, (float)rectangle2.Height * 16f / (float)y2);
				screenHeight = y2;
				screenWidth = settings.Area.Width * 16;
				transform = Transform;
				transform *= Matrix.CreateScale(num17);
				transform.Translation -= new Vector3(vector4.X - (float)(rectangle2.X * 16), vector4.Y - (float)(rectangle2.Y * 16), 0f);
				if (num17 <= 1f)
				{
					transform.Translation -= new Vector3(0f, (float)(rectangle2.Top * 16) - screenPosition.Y, 0f);
				}
				spriteBatch.End();
				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, transform);
				DrawUnderworldBackground();
			}
			spriteBatch.End();
			for (int m = 0; m < numClouds; m++)
			{
				cloud[m].position = array4[m];
			}
			lastCelestialBodyPosition = LastCelestialBodyPosition;
			LastCelestialBodyPosition = Vector2.Transform(LastCelestialBodyPosition * ScreenSize.ToVector2(), transform) / new Vector2(num9, num8);
			scAdj = num10;
			mapFullscreen = flag2;
			screenWidth = num9;
			screenHeight = num8;
			screenPosition = vector4;
		}
		if (captureEntities)
		{
			spriteBatch.Begin();
			CacheNPCDraws();
			CacheProjDraws();
			DrawCachedNPCs(DrawCacheNPCsMoonMoon, behindTiles: true);
			spriteBatch.End();
		}
		if (shimmerAlpha > 0f && captureBackground)
		{
			spriteBatch.Begin();
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, Vector2.Zero, null, Microsoft.Xna.Framework.Color.Black * shimmerAlpha, 0f, Vector2.Zero, new Vector2(Camera.UnscaledSize.X + (float)(offScreenRange * 2), Camera.UnscaledSize.Y + (float)(offScreenRange * 2)), SpriteEffects.None, 0f);
			spriteBatch.End();
		}
		DrawBlack(intoRenderTargets: false, force: true);
		tileBatch.Begin();
		spriteBatch.Begin();
		if (biome == null)
		{
			DrawLiquid(bg: true, waterStyle);
		}
		else
		{
			DrawLiquid(bg: true, bloodMoon ? 9 : biome.WaterStyle);
		}
		tileBatch.End();
		spriteBatch.End();
		if (shimmerAlpha > 0f && captureBackground)
		{
			SpriteBatchBeginner spriteBatchBeginner2 = spriteBatchBeginner;
			SceneArea sceneArea2 = sceneArea;
			if (!settings.CameraSpaceEffects)
			{
				int num18 = 2048;
				float num19 = MathHelper.Clamp((float)Math.Max(settings.Area.Height, settings.Area.Width) * 16f / (float)num18, 1f, 3f);
				sceneArea2 = new SceneArea
				{
					totalWidth = (int)Math.Ceiling((float)(settings.Area.Width * 16) / num19),
					totalHeight = (int)Math.Ceiling((float)(settings.Area.Height * 16) / num19)
				};
				Matrix transformMatrix = Matrix.CreateScale(num19) * Matrix.CreateTranslation((settings.Area.TopLeft() * 16f - screenPosition).ToVector3()) * Transform;
				spriteBatchBeginner2 = new SpriteBatchBeginner(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.PointClamp, DepthStencilState.Default, RasterizerState.CullNone, null, transformMatrix);
			}
			spriteBatchBeginner2.Begin(spriteBatch);
			DrawStarsInBackground(sceneArea2, artificial: true);
			spriteBatch.End();
		}
		if (captureBackground)
		{
			spriteBatch.Begin();
			DrawBackground();
			spriteBatch.End();
		}
		DrawWalls();
		if (captureEntities)
		{
			spriteBatch.Begin();
			DrawWoF();
			spriteBatch.End();
		}
		if (drawBackGore && captureEntities)
		{
			spriteBatch.Begin();
			DrawGoreBehind();
			spriteBatch.End();
			drawBackGore = true;
		}
		if (captureEntities)
		{
			spriteBatch.Begin();
			MoonlordDeathDrama.DrawPieces(spriteBatch);
			MoonlordDeathDrama.DrawExplosions(spriteBatch);
			spriteBatch.End();
		}
		TilesRenderer.SpecificHacksForCapture();
		TilesRenderer.PreDrawTiles(solidLayer: false);
		tileBatch.Begin();
		spriteBatch.Begin();
		DrawCachedNPCs(DrawCacheNPCsBehindNonSolidTiles, behindTiles: true);
		tileBatch.End();
		spriteBatch.End();
		int waterStyleOverride = (bloodMoon ? 9 : biome.WaterStyle);
		if (biome == null)
		{
			DrawTiles(solidLayer: false);
		}
		else
		{
			DrawTiles(solidLayer: false, intoRenderTargets: false, waterStyleOverride);
		}
		DrawTileEntities(solidLayer: false);
		if (captureEntities)
		{
			spriteBatch.Begin();
			tileBatch.Begin();
			waterfallManager.FindWaterfalls(forced: true);
			waterfallManager.Draw();
			tileBatch.End();
			spriteBatch.End();
		}
		if (captureEntities)
		{
			DrawCachedProjs(DrawCacheProjsBehindNPCsAndTiles);
			spriteBatch.Begin();
			DrawNPCs(behindTiles: true);
			spriteBatch.End();
		}
		TilesRenderer.PreDrawTiles(solidLayer: true);
		if (biome == null)
		{
			DrawTiles(solidLayer: true);
		}
		else
		{
			DrawTiles(solidLayer: true, intoRenderTargets: false, waterStyleOverride);
		}
		DrawTileEntities(solidLayer: true);
		if (captureEntities)
		{
			DrawPlayers_BehindNPCs();
			DrawCachedProjs(DrawCacheProjsBehindNPCs);
			spriteBatch.Begin();
			DrawNPCs();
			spriteBatch.End();
			spriteBatch.Begin();
			DrawCachedNPCs(DrawCacheNPCProjectiles, behindTiles: false);
			spriteBatch.End();
			DrawSuperSpecialProjectiles(DrawCacheFirstFractals);
			DrawCachedProjs(DrawCacheProjsBehindProjectiles);
			DrawProjectiles();
			DrawPlayers_AfterProjectiles();
			DrawCachedProjs(DrawCacheProjsOverPlayers);
			spriteBatch.Begin();
			DrawCachedNPCs(DrawCacheNPCsOverPlayers, behindTiles: false);
			spriteBatch.End();
			spriteBatch.Begin();
			DrawItems();
			spriteBatch.End();
			spriteBatch.Begin();
			DrawRain();
			spriteBatch.End();
			spriteBatch.Begin();
			DrawGore();
			spriteBatch.End();
			DrawDust();
		}
		tileBatch.Begin();
		spriteBatch.Begin();
		if (biome == null)
		{
			DrawLiquid(bg: false, waterStyle);
		}
		else
		{
			DrawLiquid(bg: false, biome.WaterStyle);
		}
		if (captureMech)
		{
			DrawWires();
		}
		tileBatch.End();
		spriteBatch.End();
		DrawCachedProjs(DrawCacheProjsOverWiresUI);
		if (mapEnabled)
		{
			spriteBatch.Begin();
			for (int n = area.X; n < area.X + area.Width; n++)
			{
				for (int num20 = area.Y; num20 < area.Y + area.Height; num20++)
				{
					if (!Map.IsRevealed(n, num20))
					{
						spriteBatch.Draw(TextureAssets.BlackTile.Value, new Vector2((float)n * 16f, (float)num20 * 16f) - screenPosition, Microsoft.Xna.Framework.Color.Black);
					}
				}
			}
			spriteBatch.End();
		}
		if (captureBackground && settings.CameraSpaceEffects)
		{
			screenWidth = num6;
			screenHeight = num7;
			LastCelestialBodyPosition = lastCelestialBodyPosition;
			Vector2 vector8 = screenPosition;
			screenPosition = vector;
			HorizonRenderer.DrawLensFlare();
			screenPosition = vector8;
		}
		screenWidth = 2048;
		screenHeight = 2048;
		offScreenRange = num;
		WaterShaderData obj = (WaterShaderData)Terraria.Graphics.Effects.Filters.Scene["WaterDistortion"].GetShader();
		obj.DrawRipples = settings.CameraSpaceEffects;
		ScreenShaderData.MultiChunkCapture = area != settings.Area;
		camera.EndDrawCapture(area.Size() * 16f, settings.Area.Size() * 16f, (area.TopLeft() - settings.Area.TopLeft()) * 16f);
		waterTarget = worldSceneLayerTarget;
		obj.DrawRipples = true;
		ScreenShaderData.MultiChunkCapture = false;
		renderCount = 99;
		screenWidth = num2;
		screenHeight = num3;
		screenPosition = vector;
		liquidAlpha = array3;
		bgAlphaFrontLayer = array;
		bgAlphaFarBackLayer = array2;
		SceneMetrics.HolyTileCount = holyTileCount;
		ForegroundSunlightEffects = foregroundSunlightEffects;
		Lighting.Initialize();
		GameViewMatrix = gameViewMatrix;
	}

	private void DrawPaladinsShield()
	{
		Player localPlayer = LocalPlayer;
		if (localPlayer.dead)
		{
			return;
		}
		if (localPlayer.hasPaladinShield)
		{
			for (int i = 0; i < 255; i++)
			{
				if (i != myPlayer)
				{
					Player player = Main.player[i];
					if (player.active && !player.dead && localPlayer.CanDefendWithPaladinsShield(player.team))
					{
						DrawPaladinsShieldBoundary(localPlayer.MountedCenter, player.MountedCenter);
					}
				}
			}
		}
		if (!localPlayer.defendedByPaladin)
		{
			return;
		}
		for (int j = 0; j < 255; j++)
		{
			if (j != myPlayer)
			{
				Player player2 = Main.player[j];
				if (player2.CanDefendWithPaladinsShield(localPlayer.team))
				{
					DrawPaladinsShieldBoundary(player2.MountedCenter, localPlayer.MountedCenter);
				}
			}
		}
	}

	private void DrawPaladinsShieldBoundary(Vector2 from, Vector2 to)
	{
		float num = Vector2.Distance(from, to);
		float paladinsShieldRange = Player.PaladinsShieldRange;
		float fromValue = Math.Abs(num - paladinsShieldRange);
		bool flag = num < paladinsShieldRange;
		float num2 = 1f;
		float num3 = Utils.Remap(fromValue, paladinsShieldRange * 0.15f, 0f, 0f, 1f);
		if (!(num3 <= 0f))
		{
			float num4 = num3;
			float num5 = (to - from).ToRotation();
			Texture2D value = TextureAssets.Extra[98].Value;
			float num6 = 0.33f;
			Microsoft.Xna.Framework.Color ourFavoriteColor = OurFavoriteColor;
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color(255, 255, 255, 255);
			float num7 = (flag ? 0.5f : 0.25f);
			for (float num8 = -0.01f; num8 <= 0.01f; num8 += 0.005f)
			{
				float num9 = num5 + (float)Math.PI * 2f * num8 * 0.5f;
				Vector2 vector = from + num9.ToRotationVector2() * paladinsShieldRange;
				Microsoft.Xna.Framework.Color color2 = ourFavoriteColor;
				color2 *= num6;
				EntitySpriteDraw(value, vector - screenPosition, null, color2 * num3, num9, value.Size() / 2f, new Vector2(0.5f, 1.5f), SpriteEffects.None);
			}
			for (float num10 = -0.01f; num10 <= 0.01f; num10 += 0.005f)
			{
				float num11 = num5 + (float)Math.PI * 2f * num10;
				Vector2 vector2 = from + num11.ToRotationVector2() * paladinsShieldRange;
				EntitySpriteDraw(value, vector2 - screenPosition, null, color * num3 * num6 * num7, num11, value.Size() / 2f, new Vector2(0.5f, 1.5f) * 0.5f, SpriteEffects.None);
			}
			Vector2 scale = new Vector2(1f, 1.5f);
			float rotation = 0f;
			DrawPrettyStarSparkle(num2, SpriteEffects.None, to - screenPosition, color * num2 * num7, ourFavoriteColor, num4, 0f, 1f, 1f, 2f, rotation, scale, Vector2.One);
			LoadItem(938);
			Asset<Texture2D> asset = TextureAssets.Item[938];
			if (asset.IsLoaded)
			{
				Microsoft.Xna.Framework.Color color3 = ourFavoriteColor;
				color3.A = 200;
				Vector2 vector3 = num5.ToRotationVector2() * Math.Min(paladinsShieldRange - num, 0f);
				spriteBatch.Draw(asset.Value, to - screenPosition + vector3, null, color3 * num4, 0f, asset.Size() / 2f, flag ? new Vector2(1.5f, 1.5f) : new Vector2(1f, 1f), SpriteEffects.None, 0f);
			}
		}
	}

	private void RenderToTargets()
	{
		if (!render)
		{
			return;
		}
		if (renderNow || renderCount == 1)
		{
			waterTarget.UpdateContent(RenderWater);
		}
		else if (renderNow || renderCount == 2)
		{
			backWaterTarget.UpdateContent(RenderBackgroundWater);
			backgroundTargetSwap.UpdateContent(RenderBackground);
			backgroundTargetSwapPending = true;
		}
		else if (renderNow || renderCount == 3)
		{
			wallTarget.UpdateContent(RenderWallsAndBlacks);
			tileTarget.UpdateContent(RenderTiles);
			tile2Target.UpdateContent(RenderTiles2);
		}
		if (tileTarget.IsPartiallyOffscreen)
		{
			tileTarget.UpdateContent(RenderTiles);
		}
		if (tile2Target.IsPartiallyOffscreen)
		{
			tile2Target.UpdateContent(RenderTiles2);
		}
		if (backWaterTarget.IsPartiallyOffscreen)
		{
			backWaterTarget.UpdateContent(RenderBackgroundWater);
		}
		if (backgroundTarget.IsPartiallyOffscreen)
		{
			ApplyPendingBackgroundTargetSwap();
			if (backgroundTarget.IsPartiallyOffscreen)
			{
				backgroundTarget.UpdateContent(RenderBackground);
			}
		}
		if (wallTarget.IsPartiallyOffscreen)
		{
			wallTarget.UpdateContent(RenderWallsAndBlacks);
		}
		if (waterTarget.IsPartiallyOffscreen)
		{
			waterTarget.UpdateContent(RenderWater);
		}
	}

	protected void RenderTiles()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		try
		{
			if (!DebugOptions.hideTiles)
			{
				TilesRenderer.PreDrawTiles(solidLayer: true, intoRenderTargets: true);
				DrawTiles(solidLayer: true, intoRenderTargets: true);
			}
		}
		catch (Exception e)
		{
			if (!ignoreErrors)
			{
				throw;
			}
			TimeLogger.DrawException(e);
		}
		TimeLogger.RenderSolidTiles.AddTime(fromTimestamp);
	}

	protected void RenderTiles2()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		try
		{
			if (!DebugOptions.hideTiles2)
			{
				TilesRenderer.PreDrawTiles(solidLayer: false, intoRenderTargets: true);
				DrawTiles(solidLayer: false, intoRenderTargets: true);
			}
		}
		catch (Exception e)
		{
			if (!ignoreErrors)
			{
				throw;
			}
			TimeLogger.DrawException(e);
		}
		TimeLogger.RenderNonSolidTiles.AddTime(fromTimestamp);
	}

	protected void RenderWater()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		spriteBatch.Begin();
		tileBatch.Begin();
		try
		{
			DrawWaters();
		}
		catch
		{
		}
		tileBatch.End();
		spriteBatch.End();
		TimeLogger.RenderLiquid.AddTime(fromTimestamp);
	}

	public static int CalculateWaterStyle(bool ignoreFountains = false)
	{
		if (SceneMetrics.ActiveFountainColor >= 0 && !ignoreFountains)
		{
			return SceneMetrics.ActiveFountainColor;
		}
		if (bloodMoon && !dayTime)
		{
			return 9;
		}
		switch (bgStyle)
		{
		case 1:
		case 5:
			return 2;
		case 3:
			return 3;
		case 8:
		case 14:
			return 10;
		case 6:
		case 13:
			return 4;
		case 7:
			return 5;
		case 2:
			if (remixWorld)
			{
				return 6;
			}
			if (SceneMetrics.BelowSurface)
			{
				return 12;
			}
			return 6;
		case 4:
			return 13;
		default:
			if (remixWorld)
			{
				if ((double)SceneMetrics.TileCenter.Y > rockLayer)
				{
					return 7;
				}
				if (SceneMetrics.BelowSurface)
				{
					return 8;
				}
			}
			else
			{
				if ((double)SceneMetrics.TileCenter.Y > rockLayer + 40.0)
				{
					if (SceneMetrics.ZoneGlowshroom)
					{
						return 7;
					}
					return 8;
				}
				if (SceneMetrics.BelowSurface)
				{
					return 7;
				}
			}
			return 0;
		}
	}

	public static bool IsLiquidStyleWater(int liquidStyle)
	{
		if (liquidStyle != 1 && liquidStyle != 11)
		{
			return liquidStyle != 14;
		}
		return false;
	}

	private void DrawWaters(bool isBackground = false)
	{
		if (DebugOptions.hideWater)
		{
			return;
		}
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		drewLava = false;
		if (!isBackground)
		{
			waterStyle = CalculateWaterStyle();
			for (int i = 0; i < 15; i++)
			{
				if (IsLiquidStyleWater(waterStyle))
				{
					if (waterStyle != i)
					{
						liquidAlpha[i] = Math.Max(liquidAlpha[i] - 0.2f, 0f);
					}
					else
					{
						liquidAlpha[i] = Math.Min(liquidAlpha[i] + 0.2f, 1f);
					}
				}
			}
		}
		if (!drawToScreen && !isBackground)
		{
			TileDrawing.GetScreenDrawArea(!drawToScreen, out var _, out var firstTileX, out var lastTileX, out var firstTileY, out var lastTileY);
			Microsoft.Xna.Framework.Rectangle drawArea = new Microsoft.Xna.Framework.Rectangle(firstTileX, firstTileY, lastTileX - firstTileX, lastTileY - firstTileY);
			LiquidRenderer.Instance.PrepareDraw(drawArea);
		}
		bool flag = false;
		for (int j = 0; j < 15; j++)
		{
			if (IsLiquidStyleWater(j) && liquidAlpha[j] > 0f && j != waterStyle)
			{
				DrawLiquid(isBackground, j, isBackground ? 1f : liquidAlpha[j], waterOnly: true);
				flag = true;
			}
		}
		DrawLiquid(isBackground, waterStyle, flag ? liquidAlpha[waterStyle] : 1f);
		if (isBackground)
		{
			TimeLogger.DrawBackgroundWaterTiles.AddTime(fromTimestamp);
		}
		else
		{
			TimeLogger.DrawWaterTiles.AddTime(fromTimestamp);
		}
	}

	protected void DrawLiquid(bool bg, int waterStyle, float Alpha = 1f, bool waterOnly = false)
	{
		if (!Lighting.NotRetro)
		{
			oldDrawWater(bg, waterStyle, Alpha);
			return;
		}
		Vector2 drawOffset = (drawToScreen ? Vector2.Zero : new Vector2(offScreenRange, offScreenRange)) - screenPosition;
		if (bg)
		{
			TilesRenderer.DrawLiquidBehindTiles(waterStyle);
		}
		LiquidRenderer.Instance.DrawNormalLiquids(spriteBatch, drawOffset, waterStyle, Alpha, bg, waterOnly);
		if (!waterOnly)
		{
			LiquidRenderer.Instance.DrawShimmer(spriteBatch, drawOffset, bg);
		}
	}

	public static void DrawTileInWater(Vector2 drawOffset, int x, int y)
	{
		if (Main.tile[x, y] != null && Main.tile[x, y].active() && Main.tile[x, y].type == 518)
		{
			instance.LoadTiles(Main.tile[x, y].type);
			Tile tile = Main.tile[x, y];
			int num = tile.liquid / 16;
			num -= 3;
			if (WorldGen.SolidTile(x, y - 1) && num > 8)
			{
				num = 8;
			}
			Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(tile.frameX, tile.frameY, 16, 16);
			Texture2D tileDrawTexture = instance.TilesRenderer.GetTileDrawTexture(Main.tile[x, y], x, y);
			spriteBatch.Draw(tileDrawTexture, new Vector2(x * 16, y * 16 - num) + drawOffset, value, Lighting.GetColor(x, y), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
		}
	}

	public void oldDrawWater(bool bg = false, int Style = 0, float Alpha = 1f)
	{
		float num = 0f;
		float num2 = 99999f;
		float num3 = 99999f;
		int num4 = -1;
		int num5 = -1;
		Vector2 vector = new Vector2(offScreenRange, offScreenRange);
		if (drawToScreen)
		{
			vector = Vector2.Zero;
		}
		_ = new Microsoft.Xna.Framework.Color[4];
		int num6 = (int)(255f * (1f - gfxQuality) + 40f * gfxQuality);
		_ = gfxQuality;
		_ = gfxQuality;
		int num7 = (int)((screenPosition.X - vector.X) / 16f - 1f);
		int num8 = (int)((screenPosition.X + (float)screenWidth + vector.X) / 16f) + 2;
		int num9 = (int)((screenPosition.Y - vector.Y) / 16f - 1f);
		int num10 = (int)((screenPosition.Y + (float)screenHeight + vector.Y) / 16f) + 5;
		if (num7 < 5)
		{
			num7 = 5;
		}
		if (num8 > maxTilesX - 5)
		{
			num8 = maxTilesX - 5;
		}
		if (num9 < 5)
		{
			num9 = 5;
		}
		if (num10 > maxTilesY - 5)
		{
			num10 = maxTilesY - 5;
		}
		for (int i = num9; i < num10 + 4; i++)
		{
			for (int j = num7 - 2; j < num8 + 2; j++)
			{
				if (tile[j, i] == null)
				{
					tile[j, i] = new Tile();
				}
				if (tile[j, i].liquid <= 0 || (tile[j, i].nactive() && tileSolid[tile[j, i].type] && !tileSolidTop[tile[j, i].type]) || !(Lighting.Brightness(j, i) > 0f || bg))
				{
					continue;
				}
				Microsoft.Xna.Framework.Color color = Lighting.GetColor(j, i);
				float num11 = 256 - tile[j, i].liquid;
				num11 /= 32f;
				bool flag = false;
				int num12 = 0;
				if (tile[j, i].lava())
				{
					if (drewLava)
					{
						continue;
					}
					float num13 = Math.Abs((float)(j * 16 + 8) - (screenPosition.X + (float)(screenWidth / 2)));
					float num14 = Math.Abs((float)(i * 16 + 8) - (screenPosition.Y + (float)(screenHeight / 2)));
					if (num13 < (float)(screenWidth * 2) && num14 < (float)(screenHeight * 2))
					{
						float num15 = (float)Math.Sqrt(num13 * num13 + num14 * num14);
						float num16 = 1f - num15 / ((float)screenWidth * 0.75f);
						if (num16 > 0f)
						{
							num += num16;
						}
					}
					if (num13 < num2)
					{
						num2 = num13;
						num4 = j * 16 + 8;
					}
					if (num14 < num3)
					{
						num3 = num13;
						num5 = i * 16 + 8;
					}
					num12 = 1;
				}
				else if (tile[j, i].honey())
				{
					num12 = 11;
				}
				else if (tile[j, i].shimmer())
				{
					num12 = 14;
					flag = true;
				}
				if (num12 == 0)
				{
					num12 = Style;
				}
				if ((num12 == 1 || num12 == 11) && drewLava)
				{
					continue;
				}
				float num17 = 0.5f;
				if (bg)
				{
					num17 = 1f;
				}
				if (num12 != 1 && num12 != 11)
				{
					num17 *= Alpha;
				}
				DrawTileInWater(-screenPosition + vector, j, i);
				Vector2 vector2 = new Vector2(j * 16, i * 16 + (int)num11 * 2);
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16 - (int)num11 * 2);
				bool flag2 = true;
				if (tile[j, i + 1].liquid < 245 && (!tile[j, i + 1].nactive() || !tileSolid[tile[j, i + 1].type] || tileSolidTop[tile[j, i + 1].type]))
				{
					float num18 = 256 - tile[j, i + 1].liquid;
					num18 /= 32f;
					num17 = 0.5f * (8f - num11) / 4f;
					if ((double)num17 > 0.55)
					{
						num17 = 0.55f;
					}
					if ((double)num17 < 0.35)
					{
						num17 = 0.35f;
					}
					float num19 = num11 / 2f;
					if (tile[j, i + 1].liquid < 200)
					{
						if (bg)
						{
							continue;
						}
						if (tile[j, i - 1].liquid > 0 && tile[j, i - 1].liquid > 0)
						{
							value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 16);
							num17 = 0.5f;
						}
						else if (tile[j, i - 1].liquid > 0)
						{
							vector2 = new Vector2(j * 16, i * 16 + 4);
							value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 12);
							num17 = 0.5f;
						}
						else if (tile[j, i + 1].liquid > 0)
						{
							vector2 = new Vector2(j * 16, i * 16 + (int)num11 * 2 + (int)num18 * 2);
							value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 16 - (int)num11 * 2);
						}
						else
						{
							vector2 = new Vector2(j * 16 + (int)num19, i * 16 + (int)num19 * 2 + (int)num18 * 2);
							value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16 - (int)num19 * 2, 16 - (int)num19 * 2);
						}
					}
					else
					{
						num17 = 0.5f;
						value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 16 - (int)num11 * 2 + (int)num18 * 2);
					}
				}
				else if (tile[j, i - 1].liquid > 32)
				{
					value = new Microsoft.Xna.Framework.Rectangle(0, 4, value.Width, value.Height);
				}
				else if (num11 < 1f && tile[j, i - 1].nactive() && tileSolid[tile[j, i - 1].type] && !tileSolidTop[tile[j, i - 1].type])
				{
					vector2 = new Vector2(j * 16, i * 16);
					value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 16);
				}
				else
				{
					for (int k = i + 1; k < i + 6 && (!tile[j, k].nactive() || !tileSolid[tile[j, k].type] || tileSolidTop[tile[j, k].type]); k++)
					{
						if (tile[j, k].liquid < 200)
						{
							flag2 = false;
							break;
						}
					}
					if (!flag2)
					{
						num17 = 0.5f;
						value = new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 16);
					}
					else if (tile[j, i - 1].liquid > 0)
					{
						value = new Microsoft.Xna.Framework.Rectangle(0, 2, value.Width, value.Height);
					}
				}
				if ((color.R > 20 || color.B > 20 || color.G > 20) && value.Y < 4)
				{
					int num20 = color.R;
					if (color.G > num20)
					{
						num20 = color.G;
					}
					if (color.B > num20)
					{
						num20 = color.B;
					}
					num20 /= 30;
					if (rand.Next(20000) < num20)
					{
						Microsoft.Xna.Framework.Color newColor = new Microsoft.Xna.Framework.Color(255, 255, 255);
						if (tile[j, i].honey())
						{
							newColor = new Microsoft.Xna.Framework.Color(255, 255, 50);
						}
						int num21 = Dust.NewDust(new Vector2(j * 16, vector2.Y - 2f), 16, 8, 43, 0f, 0f, 254, newColor, 0.75f);
						dust[num21].velocity *= 0f;
					}
				}
				if (tile[j, i].honey())
				{
					num17 *= 1.6f;
					if (num17 > 1f)
					{
						num17 = 1f;
					}
				}
				if (tile[j, i].lava())
				{
					num17 *= 1.8f;
					if (num17 > 1f)
					{
						num17 = 1f;
					}
					if (base.IsActive && !gamePaused && Dust.lavaBubbles < 200)
					{
						if (tile[j, i].liquid > 200 && rand.Next(700) == 0)
						{
							Dust.NewDust(new Vector2(j * 16, i * 16), 16, 16, 35);
						}
						if (value.Y == 0 && rand.Next(350) == 0)
						{
							int num22 = Dust.NewDust(new Vector2(j * 16, (float)(i * 16) + num11 * 2f - 8f), 16, 8, 35, 0f, 0f, 50, default(Microsoft.Xna.Framework.Color), 1.5f);
							dust[num22].velocity *= 0.8f;
							dust[num22].velocity.X *= 2f;
							dust[num22].velocity.Y -= (float)rand.Next(1, 7) * 0.1f;
							if (rand.Next(10) == 0)
							{
								dust[num22].velocity.Y *= rand.Next(2, 5);
							}
							dust[num22].noGravity = true;
						}
					}
				}
				float num23 = (float)(int)color.R * num17;
				float num24 = (float)(int)color.G * num17;
				float num25 = (float)(int)color.B * num17;
				float num26 = (float)(int)color.A * num17;
				color = new Microsoft.Xna.Framework.Color((byte)num23, (byte)num24, (byte)num25, (byte)num26);
				if (flag)
				{
					color = new Microsoft.Xna.Framework.Color(color.ToVector4() * LiquidRenderer.GetShimmerBaseColor(j, i));
				}
				if (Lighting.NotRetro && !bg)
				{
					Microsoft.Xna.Framework.Color color2 = color;
					if (num12 != 1 && ((double)(int)color2.R > (double)num6 * 0.6 || (double)(int)color2.G > (double)num6 * 0.65 || (double)(int)color2.B > (double)num6 * 0.7))
					{
						for (int l = 0; l < 4; l++)
						{
							int num27 = 0;
							int num28 = 0;
							int width = 8;
							int height = 8;
							Microsoft.Xna.Framework.Color color3 = color2;
							Microsoft.Xna.Framework.Color color4 = Lighting.GetColor(j, i);
							if (l == 0)
							{
								color4 = Lighting.GetColor(j - 1, i - 1);
								if (value.Height < 8)
								{
									height = value.Height;
								}
							}
							if (l == 1)
							{
								color4 = Lighting.GetColor(j + 1, i - 1);
								num27 = 8;
								if (value.Height < 8)
								{
									height = value.Height;
								}
							}
							if (l == 2)
							{
								color4 = Lighting.GetColor(j - 1, i + 1);
								num28 = 8;
								height = 8 - (16 - value.Height);
							}
							if (l == 3)
							{
								color4 = Lighting.GetColor(j + 1, i + 1);
								num27 = 8;
								num28 = 8;
								height = 8 - (16 - value.Height);
							}
							num23 = (float)(int)color4.R * num17;
							num24 = (float)(int)color4.G * num17;
							num25 = (float)(int)color4.B * num17;
							num26 = (float)(int)color4.A * num17;
							color4 = new Microsoft.Xna.Framework.Color((byte)num23, (byte)num24, (byte)num25, (byte)num26);
							color3.R = (byte)((color2.R * 3 + color4.R * 2) / 5);
							color3.G = (byte)((color2.G * 3 + color4.G * 2) / 5);
							color3.B = (byte)((color2.B * 3 + color4.B * 2) / 5);
							color3.A = (byte)((color2.A * 3 + color4.A * 2) / 5);
							if (flag)
							{
								color3 = new Microsoft.Xna.Framework.Color(color3.ToVector4() * LiquidRenderer.GetShimmerBaseColor(j, i));
							}
							spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + new Vector2(num27, num28) + vector, new Microsoft.Xna.Framework.Rectangle(value.X + num27, value.Y + num28, width, height), color3, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
							if (flag)
							{
								spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + new Vector2(num27, num28) + vector, new Microsoft.Xna.Framework.Rectangle(value.X + num27, value.Y + num28 + 36, width, height), LiquidRenderer.GetShimmerGlitterColor(flag2, j, i), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
							}
						}
					}
					else
					{
						spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, value, color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						if (flag)
						{
							value.Y += 36;
							spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, value, LiquidRenderer.GetShimmerGlitterColor(flag2, j, i), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
						}
					}
				}
				else
				{
					if (value.Y < 4)
					{
						value.X += (int)(wFrame * 18f);
					}
					spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, value, color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
					if (flag)
					{
						value.Y += 36;
						spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, value, LiquidRenderer.GetShimmerGlitterColor(flag2, j, i), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
					}
				}
				if (!tile[j, i + 1].halfBrick())
				{
					continue;
				}
				color = Lighting.GetColor(j, i + 1);
				num23 = (float)(int)color.R * num17;
				num24 = (float)(int)color.G * num17;
				num25 = (float)(int)color.B * num17;
				num26 = (float)(int)color.A * num17;
				color = new Microsoft.Xna.Framework.Color((byte)num23, (byte)num24, (byte)num25, (byte)num26);
				if (flag)
				{
					color = new Microsoft.Xna.Framework.Color(color.ToVector4() * LiquidRenderer.GetShimmerBaseColor(j, i));
				}
				vector2 = new Vector2(j * 16, i * 16 + 16);
				spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, new Microsoft.Xna.Framework.Rectangle(0, 4, 16, 8), color, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				if (flag)
				{
					spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, new Microsoft.Xna.Framework.Rectangle(0, 40, 16, 8), LiquidRenderer.GetShimmerGlitterColor(flag2, j, i), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				}
				float num29 = 6f;
				float num30 = 0.75f;
				if (num12 == 1 || num12 == 11)
				{
					num29 = 4f;
					num30 = 0.5f;
				}
				for (int m = 0; (float)m < num29; m++)
				{
					int num31 = i + 2 + m;
					if (WorldGen.SolidTile(j, num31))
					{
						break;
					}
					float num32 = 1f - (float)m / num29;
					num32 *= num30;
					vector2 = new Vector2(j * 16, num31 * 16 - 2);
					spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, new Microsoft.Xna.Framework.Rectangle(0, 18, 16, 16), color * num32, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
					if (flag)
					{
						spriteBatch.Draw(TextureAssets.Liquid[num12].Value, vector2 - screenPosition + vector, new Microsoft.Xna.Framework.Rectangle(0, 54, 16, 16), LiquidRenderer.GetShimmerGlitterColor(flag2, j, i) * num32, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
					}
				}
			}
		}
		if (!drewLava)
		{
			ambientLavaX = num4;
			ambientLavaY = num5;
			ambientLavaStrength = num;
		}
		drewLava = true;
	}

	protected void DrawBlack(bool intoRenderTargets = false, bool force = false)
	{
		if (shimmerAlpha == 1f)
		{
			return;
		}
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, intoRenderTargets ? RasterizerState.CullCounterClockwise : Rasterizer, null, intoRenderTargets ? Matrix.Identity : Transform);
		int num = (tileColor.R + tileColor.G + tileColor.B) / 3;
		float num2 = (float)((double)num * 0.4) / 255f;
		if (Lighting.Mode == LightMode.Retro)
		{
			num2 = (float)(tileColor.R - 55) / 255f;
			if (num2 < 0f)
			{
				num2 = 0f;
			}
		}
		else if (Lighting.Mode == LightMode.Trippy)
		{
			num2 = (float)(num - 55) / 255f;
			if (num2 < 0f)
			{
				num2 = 0f;
			}
		}
		TileDrawing.GetScreenDrawArea(!drawToScreen, out var drawOffSet, out var firstTileX, out var lastTileX, out var firstTileY, out var lastTileY);
		if (!force)
		{
			if (firstTileY < maxTilesY / 2)
			{
				lastTileY = Math.Min(lastTileY, (int)worldSurface + 1);
				firstTileY = Math.Min(firstTileY, (int)worldSurface + 1);
			}
			else
			{
				lastTileY = Math.Max(lastTileY, UnderworldLayer);
				firstTileY = Math.Max(firstTileY, UnderworldLayer);
			}
		}
		bool flag = ShouldShowInvisibleBlocksAndWalls();
		for (int i = firstTileY; i < lastTileY; i++)
		{
			bool flag2 = i >= UnderworldLayer;
			if (flag2)
			{
				num2 = 0.2f;
			}
			for (int j = firstTileX; j < lastTileX; j++)
			{
				int num3 = j;
				for (; j < lastTileX; j++)
				{
					if (!WorldGen.InWorld(j, i))
					{
						return;
					}
					if (Main.tile[j, i] == null)
					{
						Main.tile[j, i] = new Tile();
					}
					Tile tile = Main.tile[j, i];
					float num4 = Lighting.Brightness(j, i);
					num4 = (float)Math.Floor(num4 * 255f) / 255f;
					byte b = tile.liquid;
					bool num5 = num4 <= num2 && ((!flag2 && b < 250) || WorldGen.SolidTile(tile) || (b >= 200 && num4 == 0f));
					bool flag3 = tile.active() && tileBlockLight[tile.type] && (!tile.invisibleBlock() || flag);
					bool flag4 = !WallID.Sets.Transparent[tile.wall] && (!tile.invisibleWall() || flag);
					if (!num5 || (!flag4 && !flag3) || (!drawToScreen && LiquidRenderer.Instance.HasFullWater(j, i) && tile.wall == 0 && !tile.halfBrick() && !((double)i <= worldSurface)))
					{
						break;
					}
				}
				if (j - num3 > 0)
				{
					spriteBatch.Draw(TextureAssets.BlackTile.Value, new Vector2(num3 << 4, i << 4) - screenPosition + drawOffSet, new Microsoft.Xna.Framework.Rectangle(0, 0, j - num3 << 4, 16), Microsoft.Xna.Framework.Color.Black);
				}
			}
		}
		spriteBatch.End();
		TimeLogger.DrawBlackTiles.AddTime(fromTimestamp);
	}

	public static bool ShouldShowInvisibleBlocksAndWalls()
	{
		if (!SceneMetrics.EchoMonolith)
		{
			return SceneMetrics.PerspectivePlayer.CanSeeInvisibleBlocks;
		}
		return true;
	}

	protected void DrawWalls(bool intoRenderTargets = false)
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		try
		{
			WallsRenderer.Begin(intoRenderTargets ? RasterizerState.CullCounterClockwise : Rasterizer, intoRenderTargets ? Matrix.Identity : Transform);
			WallsRenderer.DrawWalls();
		}
		finally
		{
			WallsRenderer.End();
		}
		TimeLogger.DrawWallTiles.AddTime(fromTimestamp);
	}

	private void ApplyPendingBackgroundTargetSwap()
	{
		if (backgroundTargetSwapPending)
		{
			Utils.Swap(ref backgroundTarget, ref backgroundTargetSwap);
			backgroundTargetSwapPending = false;
		}
	}

	protected void RenderWallsAndBlacks()
	{
		ApplyPendingBackgroundTargetSwap();
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		base.GraphicsDevice.DepthStencilState = new DepthStencilState
		{
			DepthBufferEnable = true
		};
		RenderBlacks();
		RenderWalls();
		TimeLogger.RenderBlacksAndWalls.AddTime(fromTimestamp);
	}

	private void RenderBlacks()
	{
		if (!DebugOptions.hideTiles)
		{
			DrawBlack(intoRenderTargets: true);
		}
	}

	private void RenderWalls()
	{
		try
		{
			DrawWalls(intoRenderTargets: true);
		}
		catch (Exception e)
		{
			if (!ignoreErrors)
			{
				throw;
			}
			TimeLogger.DrawException(e);
		}
	}

	protected void ReleaseTargets()
	{
		try
		{
			if (!dedServ)
			{
				offScreenRange = 0;
				targetSet = false;
				if (waterTarget != null)
				{
					waterTarget.Dispose();
				}
				if (backWaterTarget != null)
				{
					backWaterTarget.Dispose();
				}
				if (tileTarget != null)
				{
					tileTarget.Dispose();
				}
				if (tile2Target != null)
				{
					tile2Target.Dispose();
				}
				if (wallTarget != null)
				{
					wallTarget.Dispose();
				}
				if (skyTarget != null)
				{
					skyTarget.Dispose();
				}
				if (screenTarget != null)
				{
					screenTarget.Dispose();
				}
				if (screenTargetSwap != null)
				{
					screenTargetSwap.Dispose();
				}
				if (backgroundTarget != null)
				{
					backgroundTarget.Dispose();
				}
				if (backgroundTargetSwap != null)
				{
					backgroundTargetSwap.Dispose();
				}
				if (Main.OnRenderTargetsReleased != null)
				{
					Main.OnRenderTargetsReleased();
				}
			}
		}
		catch
		{
		}
	}

	protected void EnsureRenderTargetContent()
	{
		if (waterTarget == null || waterTarget.IsContentLost || backWaterTarget == null || backWaterTarget.IsContentLost || tileTarget == null || tileTarget.IsContentLost || tile2Target == null || tile2Target.IsContentLost || wallTarget == null || wallTarget.IsContentLost || skyTarget == null || skyTarget.IsContentLost || backgroundTarget == null || backgroundTarget.IsContentLost || backgroundTargetSwap == null || backgroundTargetSwap.IsContentLost || screenTarget == null || screenTarget.IsContentLost || screenTargetSwap == null || screenTargetSwap.IsContentLost)
		{
			InitTargets();
		}
	}

	protected void InitTargets()
	{
		if (!PreventUpdatingTargets)
		{
			UpdateDisplaySettings();
		}
		ReleaseTargets();
		int num = Math.Min(base.GraphicsDevice.PresentationParameters.BackBufferWidth, MaxWorldViewSize.X);
		int num2 = Math.Min(base.GraphicsDevice.PresentationParameters.BackBufferHeight, MaxWorldViewSize.Y);
		offScreenRange = 192;
		if (num + offScreenRange * 2 > _renderTargetMaxSize)
		{
			offScreenRange = (_renderTargetMaxSize - num) / 2;
		}
		num += offScreenRange * 2;
		num2 += offScreenRange * 2;
		try
		{
			if (!dedServ)
			{
				targetSet = true;
				waterTarget = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				backWaterTarget = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				tileTarget = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				tile2Target = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				wallTarget = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				backgroundTarget = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				backgroundTargetSwap = new WorldSceneLayerTarget(base.GraphicsDevice, num, num2);
				skyTarget = new RenderTarget2D(base.GraphicsDevice, base.GraphicsDevice.PresentationParameters.BackBufferWidth, base.GraphicsDevice.PresentationParameters.BackBufferHeight, mipMap: false, base.GraphicsDevice.PresentationParameters.BackBufferFormat, DepthFormat.None);
				screenTarget = new RenderTarget2D(base.GraphicsDevice, base.GraphicsDevice.PresentationParameters.BackBufferWidth, base.GraphicsDevice.PresentationParameters.BackBufferHeight, mipMap: false, base.GraphicsDevice.PresentationParameters.BackBufferFormat, DepthFormat.None);
				screenTargetSwap = new RenderTarget2D(base.GraphicsDevice, base.GraphicsDevice.PresentationParameters.BackBufferWidth, base.GraphicsDevice.PresentationParameters.BackBufferHeight, mipMap: false, base.GraphicsDevice.PresentationParameters.BackBufferFormat, DepthFormat.None);
				if (Main.OnRenderTargetsInitialized != null)
				{
					Main.OnRenderTargetsInitialized(base.GraphicsDevice.PresentationParameters.BackBufferWidth, base.GraphicsDevice.PresentationParameters.BackBufferHeight);
				}
			}
		}
		catch
		{
			Lighting.Mode = LightMode.Retro;
			mapEnabled = false;
			SaveSettings();
			try
			{
				ReleaseTargets();
			}
			catch
			{
			}
		}
	}

	protected void DrawWires()
	{
		TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
		Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(0, 0, 16, 16);
		Vector2 zero = Vector2.Zero;
		DrawWiresSpecialTiles.Clear();
		bool flag = !WiresUI.Settings.HideWires;
		float num = 1f;
		if (WiresUI.Settings.HideWires)
		{
			num = 0.5f;
		}
		int num2 = 1;
		int num3 = 1;
		int num4 = 1;
		int num5 = 1;
		int num6 = 1;
		if (player[myPlayer].InfoAccMechShowWires)
		{
			int[] builderAccStatus = player[myPlayer].builderAccStatus;
			num2 = builderAccStatus[4];
			num3 = builderAccStatus[5];
			num4 = builderAccStatus[6];
			num5 = builderAccStatus[7];
			num6 = builderAccStatus[9];
		}
		_ = gfxQuality;
		_ = gfxQuality;
		TileDrawing.GetScreenDrawArea(useOffscreenRange: false, out var drawOffSet, out var firstTileX, out var lastTileX, out var firstTileY, out var lastTileY);
		for (int i = firstTileY; i < lastTileY; i++)
		{
			for (int j = firstTileX; j < lastTileX; j++)
			{
				bool flag2 = false;
				bool flag3 = false;
				bool flag4 = false;
				bool flag5 = false;
				bool flag6 = false;
				bool flag7 = false;
				bool flag8 = false;
				bool flag9 = false;
				bool flag10 = false;
				float num7 = 0f;
				Tile tile = Main.tile[j, i];
				if (tile == null)
				{
					continue;
				}
				if (flag && player[myPlayer].CanShowWireStuffHere(j, i))
				{
					int num8 = 0;
					if (tile.active())
					{
						if (tile.type == 424)
						{
							switch (tile.frameX / 18)
							{
							case 0:
								num8 += 72;
								break;
							case 1:
								num8 += 144;
								break;
							case 2:
								num8 += 216;
								break;
							}
						}
						else if (tile.type == 445)
						{
							num8 += 72;
						}
					}
					if (tile.wire())
					{
						num7 += 1f;
						int num9 = 0;
						if (Main.tile[j, i - 1].wire())
						{
							num9 += 18;
							flag4 = true;
						}
						if (Main.tile[j + 1, i].wire())
						{
							num9 += 36;
							flag3 = true;
						}
						if (Main.tile[j, i + 1].wire())
						{
							num9 += 72;
							flag5 = true;
						}
						if (Main.tile[j - 1, i].wire())
						{
							num9 += 144;
							flag2 = true;
						}
						value.Y = num8;
						value.X = num9;
						Microsoft.Xna.Framework.Color color = Lighting.GetColor(j, i);
						switch (num2)
						{
						case 0:
							color = Microsoft.Xna.Framework.Color.White;
							break;
						case 2:
							color *= 0.5f;
							break;
						case 3:
							color = Microsoft.Xna.Framework.Color.Transparent;
							break;
						}
						if (color == Microsoft.Xna.Framework.Color.Transparent)
						{
							num7 -= 1f;
						}
						else
						{
							spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, value, color, 0f, zero, 1f, SpriteEffects.None, 0f);
						}
					}
					if (tile.wire2())
					{
						flag6 = (flag7 = (flag8 = (flag9 = (flag10 = false))));
						num7 += 1f;
						int num10 = 0;
						if (Main.tile[j, i - 1].wire2())
						{
							num10 += 18;
							flag8 = true;
							if (flag4)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j + 1, i].wire2())
						{
							num10 += 36;
							flag7 = true;
							if (flag3)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j, i + 1].wire2())
						{
							num10 += 72;
							flag9 = true;
							if (flag5)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j - 1, i].wire2())
						{
							num10 += 144;
							flag6 = true;
							if (flag2)
							{
								flag10 = true;
							}
						}
						if (num7 > 1f)
						{
							flag10 = true;
						}
						value.Y = num8 + 18;
						value.X = num10;
						Microsoft.Xna.Framework.Color color2 = Lighting.GetColor(j, i);
						switch (num3)
						{
						case 0:
							color2 = Microsoft.Xna.Framework.Color.White;
							break;
						case 2:
							color2 *= 0.5f;
							break;
						case 3:
							color2 = Microsoft.Xna.Framework.Color.Transparent;
							break;
						}
						if (color2 == Microsoft.Xna.Framework.Color.Transparent)
						{
							num7 -= 1f;
						}
						else
						{
							spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, value, color2 * (1f / num7), 0f, zero, 1f, SpriteEffects.None, 0f);
							if (flag8)
							{
								if (flag10 && !flag4)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(18, value.Y, 16, 6), color2, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag4 = true;
							}
							if (flag9)
							{
								if (flag10 && !flag5)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet + new Vector2(0f, 10f), new Microsoft.Xna.Framework.Rectangle(72, value.Y + 10, 16, 6), color2, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag5 = true;
							}
							if (flag7)
							{
								if (flag10 && !flag3)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet + new Vector2(10f, 0f), new Microsoft.Xna.Framework.Rectangle(46, value.Y, 6, 16), color2, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag3 = true;
							}
							if (flag6)
							{
								if (flag10 && !flag2)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(144, value.Y, 6, 16), color2, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag2 = true;
							}
						}
					}
					if (tile.wire3())
					{
						flag6 = (flag7 = (flag8 = (flag9 = (flag10 = false))));
						num7 += 1f;
						int num11 = 0;
						if (Main.tile[j, i - 1].wire3())
						{
							num11 += 18;
							flag8 = true;
							if (flag4)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j + 1, i].wire3())
						{
							num11 += 36;
							flag7 = true;
							if (flag3)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j, i + 1].wire3())
						{
							num11 += 72;
							flag9 = true;
							if (flag5)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j - 1, i].wire3())
						{
							num11 += 144;
							flag6 = true;
							if (flag2)
							{
								flag10 = true;
							}
						}
						if (num7 > 1f)
						{
							flag10 = true;
						}
						value.Y = num8 + 36;
						value.X = num11;
						Microsoft.Xna.Framework.Color color3 = Lighting.GetColor(j, i);
						switch (num4)
						{
						case 0:
							color3 = Microsoft.Xna.Framework.Color.White;
							break;
						case 2:
							color3 *= 0.5f;
							break;
						case 3:
							color3 = Microsoft.Xna.Framework.Color.Transparent;
							break;
						}
						if (color3 == Microsoft.Xna.Framework.Color.Transparent)
						{
							num7 -= 1f;
						}
						else
						{
							spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, value, color3 * (1f / num7), 0f, zero, 1f, SpriteEffects.None, 0f);
							if (flag8)
							{
								if (flag10 && !flag4)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(18, value.Y, 16, 6), color3, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag4 = true;
							}
							if (flag9)
							{
								if (flag10 && !flag5)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet + new Vector2(0f, 10f), new Microsoft.Xna.Framework.Rectangle(72, value.Y + 10, 16, 6), color3, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag5 = true;
							}
							if (flag7)
							{
								if (flag10 && !flag3)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet + new Vector2(10f, 0f), new Microsoft.Xna.Framework.Rectangle(46, value.Y, 6, 16), color3, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag3 = true;
							}
							if (flag6)
							{
								if (flag10 && !flag2)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(144, value.Y, 6, 16), color3, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag2 = true;
							}
						}
					}
					if (tile.wire4())
					{
						flag6 = (flag7 = (flag8 = (flag9 = (flag10 = false))));
						num7 += 1f;
						int num12 = 0;
						if (Main.tile[j, i - 1].wire4())
						{
							num12 += 18;
							flag8 = true;
							if (flag4)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j + 1, i].wire4())
						{
							num12 += 36;
							flag7 = true;
							if (flag3)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j, i + 1].wire4())
						{
							num12 += 72;
							flag9 = true;
							if (flag5)
							{
								flag10 = true;
							}
						}
						if (Main.tile[j - 1, i].wire4())
						{
							num12 += 144;
							flag6 = true;
							if (flag2)
							{
								flag10 = true;
							}
						}
						if (num7 > 1f)
						{
							flag10 = true;
						}
						value.Y = num8 + 54;
						value.X = num12;
						Microsoft.Xna.Framework.Color color4 = Lighting.GetColor(j, i);
						switch (num5)
						{
						case 0:
							color4 = Microsoft.Xna.Framework.Color.White;
							break;
						case 2:
							color4 *= 0.5f;
							break;
						case 3:
							color4 = Microsoft.Xna.Framework.Color.Transparent;
							break;
						}
						if (color4 == Microsoft.Xna.Framework.Color.Transparent)
						{
							num7 -= 1f;
						}
						else
						{
							spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, value, color4 * (1f / num7), 0f, zero, 1f, SpriteEffects.None, 0f);
							if (flag8)
							{
								if (flag10 && !flag4)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(18, value.Y, 16, 6), color4, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag4 = true;
							}
							if (flag9)
							{
								if (flag10 && !flag5)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet + new Vector2(0f, 10f), new Microsoft.Xna.Framework.Rectangle(72, value.Y + 10, 16, 6), color4, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag5 = true;
							}
							if (flag7)
							{
								if (flag10 && !flag3)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet + new Vector2(10f, 0f), new Microsoft.Xna.Framework.Rectangle(46, value.Y, 6, 16), color4, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag3 = true;
							}
							if (flag6)
							{
								if (flag10 && !flag2)
								{
									spriteBatch.Draw(TextureAssets.WireNew.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(144, value.Y, 6, 16), color4, 0f, zero, 1f, SpriteEffects.None, 0f);
								}
								flag2 = true;
							}
						}
					}
				}
				if (Main.tile[j, i].actuator() && (Lighting.Brightness(j, i) > 0f || num6 == 0))
				{
					Microsoft.Xna.Framework.Color color5 = Lighting.GetColor(j, i);
					switch (num6)
					{
					case 0:
						color5 = Microsoft.Xna.Framework.Color.White;
						break;
					case 2:
						color5 *= 0.5f;
						break;
					case 3:
						color5 = Microsoft.Xna.Framework.Color.Transparent;
						break;
					}
					spriteBatch.Draw(TextureAssets.Actuator.Value, new Vector2(j * 16 - (int)screenPosition.X, i * 16 - (int)screenPosition.Y) + drawOffSet, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.Actuator.Width(), TextureAssets.Actuator.Height()), color5 * num, 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
				}
				if (tile.active())
				{
					ushort type = tile.type;
					if (type == 423 && tile.frameY == 36)
					{
						DrawWiresSpecialTiles.Add(Tuple.Create(j, i, tile.type));
					}
				}
			}
		}
		for (int k = 0; k < DrawWiresSpecialTiles.Count; k++)
		{
			Tuple<int, int, ushort> tuple = DrawWiresSpecialTiles[k];
			ushort type = tuple.Item3;
			if (type == 423)
			{
				Vector2 start = new Vector2(tuple.Item1 * 16 - 32 - 1, tuple.Item2 * 16 - 160 - 1) + drawOffSet;
				Vector2 end = new Vector2(tuple.Item1 * 16 + 48 + 1, tuple.Item2 * 16 + 1) + drawOffSet;
				Utils.DrawRectangle(spriteBatch, start, end, Microsoft.Xna.Framework.Color.LightSeaGreen, Microsoft.Xna.Framework.Color.LightSeaGreen, 2f);
			}
		}
		TimeLogger.DrawWireTiles.AddTime(fromTimestamp);
	}

	public static int ConvertPaintIdToTileShaderIndex(int paintIndexOnTile, bool isUsedForPaintingGrass, bool useWallShaderHacks)
	{
		if (paintIndexOnTile == 31)
		{
			return 0;
		}
		if (paintIndexOnTile == 30 && useWallShaderHacks)
		{
			return 43;
		}
		if (paintIndexOnTile >= 28)
		{
			return paintIndexOnTile + 12;
		}
		if (isUsedForPaintingGrass && paintIndexOnTile >= 1 && paintIndexOnTile <= 12)
		{
			return paintIndexOnTile + 27;
		}
		return paintIndexOnTile;
	}

	public static void ResetWindCounter(bool resetExtreme = false)
	{
		FastRandom fastRandom = FastRandom.CreateWithRandomSeed();
		windCounter = fastRandom.Next(900, 2701);
		if (resetExtreme)
		{
			extremeWindCounter = fastRandom.Next(10, 31);
		}
	}

	public static void NewLightning(bool instant = false, bool skipSound = false)
	{
		if (FlashyEffectsWorld && !(shimmerAlpha > 0f))
		{
			if (rand.Next(3) == 0)
			{
				thunderDelay = rand.Next(1, 31);
			}
			else if (rand.Next(2) == 0)
			{
				thunderDelay = rand.Next(31, 121);
			}
			else
			{
				thunderDelay = rand.Next(11, 61);
			}
			thunderDistance = thunderDelay;
			lightningDecay = rand.NextFloat() * 0.05f + 0.008f;
			lightningSpeed = rand.NextFloat() * 0.05f + 0.05f;
			thunderSkipSound = skipSound;
			if (instant)
			{
				lightningSpeed = 0.2f;
				thunderDelay = 1;
				thunderDistance = 0;
			}
		}
	}

	public void UpdateWeather(GameTime gameTime, int currentDayRateIteration)
	{
		if (netMode != 2 && currentDayRateIteration == 0)
		{
			bool flag = base.IsActive || DebugOptions.noPause;
			if (thunderDelay > 0)
			{
				thunderDelay--;
				if (thunderDelay == 0)
				{
					Vector2 center = SceneMetrics.Center;
					float num = thunderDistance * 15;
					if (rand.Next(2) == 0)
					{
						num *= -1f;
					}
					center.X += num;
					int num2 = (int)(worldSurface * 16.0) - 500;
					if (center.Y > (float)num2)
					{
						center.Y = num2;
					}
					if (flag && !thunderSkipSound)
					{
						SoundEngine.PlaySound(43, center);
					}
				}
			}
			if (lightningSpeed > 0f)
			{
				lightning += lightningSpeed;
				if (lightning >= 1f)
				{
					lightning = 1f;
					lightningSpeed = 0f;
				}
				Lighting.LightTiles(GetAreaToLight());
				Lighting.LightTiles(GetAreaToLight());
			}
			else if (lightning > 0f)
			{
				lightning -= lightningDecay;
				Lighting.LightTiles(GetAreaToLight());
				Lighting.LightTiles(GetAreaToLight());
			}
			else if (thunderDelay <= 0 && (double)SceneMetrics.TileCenter.Y < rockLayer && atmo == 1f && !remixWorld)
			{
				if (IsItStorming)
				{
					float num3 = 600f;
					float num4 = 1600f;
					if ((double)maxRaining > 0.8)
					{
						num3 *= 0.6f;
						num4 *= 0.8f;
					}
					if ((double)maxRaining > 0.7)
					{
						num3 *= 0.7f;
						num4 *= 0.9f;
					}
					if ((double)maxRaining > 0.6)
					{
						num3 *= 0.8f;
						num4 *= 0.95f;
					}
					if ((double)Math.Abs(windSpeedTarget) > 0.7)
					{
						num3 *= 0.6f;
						num4 *= 0.8f;
					}
					if ((double)Math.Abs(windSpeedTarget) > 0.6)
					{
						num3 *= 0.7f;
						num4 *= 0.9f;
					}
					if ((double)Math.Abs(windSpeedTarget) > 0.5)
					{
						num3 *= 0.8f;
						num4 *= 0.95f;
					}
					float num5 = rand.Next((int)num3, (int)num4);
					num5 *= (1f - maxRaining + 1f) / 2f;
					num5 *= (1f - windSpeedTarget + 1f) / 2f;
					if (rand.Next((int)num5) == 0)
					{
						NewLightning();
					}
				}
				else if ((double)GraveyardVisualIntensity >= 0.9)
				{
					int maxValue = 120;
					if (rand.Next(maxValue) == 0)
					{
						NewLightning();
					}
				}
			}
		}
		float num6 = 0.8f;
		float num7 = 0.0003f;
		float num8 = windSpeedTarget * (1f + 5f / 9f * maxRaining);
		num7 += Math.Abs(num8 - windSpeedCurrent) * 0.0015f;
		if (windSpeedCurrent < num8)
		{
			windSpeedCurrent += num7;
			if (windSpeedCurrent > num8)
			{
				windSpeedCurrent = num8;
			}
		}
		else if (windSpeedCurrent > num8)
		{
			windSpeedCurrent -= num7;
			if (windSpeedCurrent < num8)
			{
				windSpeedCurrent = num8;
			}
		}
		if (netMode == 1 || (netMode != 2 && gameMenu))
		{
			return;
		}
		if (!CreativePowerManager.Instance.GetPower<CreativePowers.FreezeWindDirectionAndStrength>().Enabled)
		{
			if (LanternNight.LanternsUp)
			{
				return;
			}
			windCounter--;
			if (windCounter <= 0)
			{
				bool flag2 = false;
				for (int i = 0; i < 255; i++)
				{
					if (player[i].active && player[i].statLifeMax >= 120)
					{
						flag2 = true;
						break;
					}
				}
				float num9 = 1f;
				if (windSpeedTarget < 0f)
				{
					num9 = -1f;
				}
				if (rand.Next(4) == 0)
				{
					windSpeedTarget += (float)rand.Next(-25, 26) * 0.001f;
				}
				else if (rand.Next(2) == 0)
				{
					windSpeedTarget += (float)rand.Next(-50, 51) * 0.001f;
				}
				else
				{
					windSpeedTarget += (float)rand.Next(-100, 101) * 0.001f;
				}
				if (!flag2 && Math.Abs(windSpeedTarget) > 0.35f)
				{
					windSpeedTarget = 0.35f * (float)Math.Sign(windSpeedTarget);
				}
				extremeWindCounter--;
				if (extremeWindCounter <= 0)
				{
					ResetWindCounter(resetExtreme: true);
					if (rand.Next(30) < 13)
					{
						if (rand.Next(2) == 0)
						{
							windSpeedTarget = 0f;
							windCounter = rand.Next(7200, 28801);
						}
						else
						{
							windSpeedTarget = (float)rand.Next(-200, 201) * 0.001f;
						}
					}
					else if (rand.Next(20) < 13)
					{
						windSpeedTarget = (float)rand.Next(-400, 401) * 0.001f;
					}
					else
					{
						windSpeedTarget = (float)rand.Next(-850, 851) * 0.001f;
					}
					if (!flag2 && Math.Abs(windSpeedTarget) > 0.35f)
					{
						windSpeedTarget = 0.35f * (float)Math.Sign(windSpeedTarget);
					}
					if ((double)Math.Abs(windSpeedTarget) > 0.3)
					{
						extremeWindCounter += rand.Next(5, 11);
					}
					if ((double)Math.Abs(windSpeedTarget) > 0.5)
					{
						extremeWindCounter += rand.Next(10, 21);
					}
					if ((double)Math.Abs(windSpeedTarget) > 0.7)
					{
						extremeWindCounter += rand.Next(15, 31);
					}
				}
				else
				{
					ResetWindCounter();
				}
				if (rand.Next(3) != 0 && ((num9 < 0f && windSpeedTarget > 0f) || (num9 > 0f && windSpeedTarget < 0f)))
				{
					windSpeedTarget *= -1f;
				}
			}
			if (windSpeedTarget > num6)
			{
				windSpeedTarget = num6;
			}
			if (windSpeedTarget < 0f - num6)
			{
				windSpeedTarget = 0f - num6;
			}
		}
		if (rand.Next(60) == 0)
		{
			numCloudsTemp += rand.Next(-1, 2);
		}
		if ((float)rand.Next(1000) < 50f * cloudBGAlpha)
		{
			numCloudsTemp++;
		}
		if ((float)rand.Next(1300) < 25f * (1f - cloudBGAlpha))
		{
			numCloudsTemp--;
		}
		if ((float)rand.Next(1000) < 200f * cloudAlpha && numCloudsTemp < 100)
		{
			numCloudsTemp++;
		}
		if ((float)rand.Next(1000) < 50f * cloudAlpha)
		{
			numCloudsTemp++;
		}
		if (numCloudsTemp > 66 && rand.Next(100) == 0)
		{
			numCloudsTemp -= rand.Next(1, 3);
		}
		if (numCloudsTemp < 50 && rand.Next(100) == 0)
		{
			numCloudsTemp += rand.Next(1, 3);
		}
		if (cloudBGActive <= 0f && numCloudsTemp > 100 && cloudAlpha == 0f)
		{
			numCloudsTemp = 100;
		}
		if (numCloudsTemp < -20)
		{
			numCloudsTemp = -20;
		}
		if (cloudAlpha > 0f && (float)numClouds < 200f * cloudAlpha)
		{
			while ((float)numClouds < 200f * cloudAlpha)
			{
				numClouds += rand.Next(30);
				if (numClouds > 200)
				{
					numClouds = 200;
				}
				if (numCloudsTemp < numClouds)
				{
					numCloudsTemp = numClouds;
				}
			}
			if (netMode == 2)
			{
				NetMessage.SendData(7);
			}
		}
		weatherCounter--;
		if (weatherCounter > 0)
		{
			return;
		}
		if (rand.Next(2) == 0)
		{
			if (rand.Next(2) == 0)
			{
				numCloudsTemp += rand.Next(250);
			}
			else
			{
				numCloudsTemp += rand.Next(100);
			}
		}
		if (numCloudsTemp < 0)
		{
			numCloudsTemp = 0;
		}
		if (numCloudsTemp > 200)
		{
			numCloudsTemp = 200;
		}
		numClouds = numCloudsTemp;
		weatherCounter = rand.Next(3600, 10800);
		if (netMode == 2)
		{
			NetMessage.SendData(7);
		}
	}

	public void LoadBackground(int i)
	{
		if (i >= 0 && TextureAssets.Background[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Background[i].Name, AssetRequestMode.ImmediateLoad);
			backgroundWidth[i] = TextureAssets.Background[i].Width();
			backgroundHeight[i] = TextureAssets.Background[i].Height();
			switch (i)
			{
			case 219:
			case 220:
			case 221:
			case 235:
			case 271:
			case 272:
			case 273:
			case 281:
			case 302:
			case 303:
			case 305:
			case 307:
			case 309:
			case 311:
			case 313:
			case 315:
			case 317:
			case 326:
			case 337:
			case 338:
			case 341:
				backgroundWidth[i] /= 2;
				backgroundHeight[i] /= 2;
				break;
			}
		}
	}

	public void LoadItem(int i)
	{
		if (TextureAssets.Item[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Item[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadNPC(int i)
	{
		if (TextureAssets.Npc[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Npc[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadProjectile(int i)
	{
		if (TextureAssets.Projectile[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Projectile[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadGore(int i)
	{
		if (TextureAssets.Gore[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Gore[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadWall(int i)
	{
		if (TextureAssets.Wall[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Wall[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadTiles(int i)
	{
		if (TextureAssets.Tile[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Tile[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadItemFlames(int i)
	{
		if (TextureAssets.ItemFlame[i].State == AssetState.NotLoaded)
		{
			try
			{
				Assets.Request<Texture2D>(TextureAssets.ItemFlame[i].Name, AssetRequestMode.ImmediateLoad);
			}
			catch
			{
			}
		}
	}

	public void LoadWings(int i)
	{
		if (TextureAssets.Wings[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.Wings[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadHair(int i)
	{
		if (TextureAssets.PlayerHair[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.PlayerHair[i].Name, AssetRequestMode.ImmediateLoad);
			Assets.Request<Texture2D>(TextureAssets.PlayerHairAlt[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadArmorHead(int i)
	{
		if (TextureAssets.ArmorHead[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.ArmorHead[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadArmorBody(int i)
	{
		if (ArmorIDs.Body.Sets.UsesNewFramingCode[i])
		{
			if (TextureAssets.ArmorBodyComposite[i].State == AssetState.NotLoaded)
			{
				Assets.Request<Texture2D>(TextureAssets.ArmorBodyComposite[i].Name, AssetRequestMode.ImmediateLoad);
			}
		}
		else if (TextureAssets.ArmorBody[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.FemaleBody[i].Name, AssetRequestMode.ImmediateLoad);
			Assets.Request<Texture2D>(TextureAssets.ArmorBody[i].Name, AssetRequestMode.ImmediateLoad);
			Assets.Request<Texture2D>(TextureAssets.ArmorArm[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadArmorLegs(int i)
	{
		if (TextureAssets.ArmorLeg[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.ArmorLeg[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccHandsOn(int i)
	{
		bool flag = !ArmorIDs.HandOn.Sets.UsesNewFramingCode[i];
		if (ArmorIDs.HandOn.Sets.UsesOldFramingTexturesForWalking[i])
		{
			flag = true;
		}
		if (flag && TextureAssets.AccHandsOn[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccHandsOn[i].Name, AssetRequestMode.ImmediateLoad);
		}
		if (ArmorIDs.HandOn.Sets.UsesNewFramingCode[i] && TextureAssets.AccHandsOnComposite[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccHandsOnComposite[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccHandsOff(int i)
	{
		if (!ArmorIDs.HandOff.Sets.UsesNewFramingCode[i] && TextureAssets.AccHandsOff[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccHandsOff[i].Name, AssetRequestMode.ImmediateLoad);
		}
		if (ArmorIDs.HandOff.Sets.UsesNewFramingCode[i] && TextureAssets.AccHandsOffComposite[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccHandsOffComposite[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccBack(int i)
	{
		if (TextureAssets.AccBack[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccBack[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccFront(int i)
	{
		if (TextureAssets.AccFront[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccFront[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccShoes(int i)
	{
		if (TextureAssets.AccShoes[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccShoes[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccWaist(int i)
	{
		if (TextureAssets.AccWaist[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccWaist[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccShield(int i)
	{
		if (TextureAssets.AccShield[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccShield[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccNeck(int i)
	{
		if (TextureAssets.AccNeck[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccNeck[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccFace(int i)
	{
		if (TextureAssets.AccFace[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccFace[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccBalloon(int i)
	{
		if (TextureAssets.AccBalloon[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccBalloon[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadAccBeard(int i)
	{
		if (TextureAssets.AccBeard[i].State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.AccBeard[i].Name, AssetRequestMode.ImmediateLoad);
		}
	}

	public void LoadFlameRing()
	{
		if (TextureAssets.FlameRing.State == AssetState.NotLoaded)
		{
			Assets.Request<Texture2D>(TextureAssets.FlameRing.Name, AssetRequestMode.ImmediateLoad);
		}
	}

	protected void DrawSurfaceBG(SpriteBatchBeginner parentSpriteBatchBeginner, float? verticalParallaxOverride = null)
	{
		LatestSurfaceBackgroundBeginner = parentSpriteBatchBeginner;
		bool flag = ShouldDrawSurfaceBackground();
		Microsoft.Xna.Framework.Color colorOfSurfaceBackgroundsBase = ColorOfSurfaceBackgroundsBase;
		int num = 30;
		if (gameMenu)
		{
			num = 0;
		}
		if (WorldGen.drunkWorldGen)
		{
			if (onlyShimmerOceanWorldsGeneration)
			{
				num = -240;
			}
			else if (vampireSeed)
			{
				num = -100;
			}
			else if (!notTheBeesWorld)
			{
				num = -180;
			}
		}
		float num2 = (float)worldSurface;
		if (num2 == 0f)
		{
			num2 = 1f;
		}
		float num3 = verticalParallaxOverride ?? ((0f - (screenPosition.Y - 300f)) / (num2 * 16f));
		bgTopY = num3 * 1200f + 1190f + scAdj;
		float num4 = 2f;
		int pushBGTopHack = 0;
		float num5 = SkyManager.Instance.ProcessCloudAlpha() * atmo;
		int num6 = 0;
		HorizonRenderer.DrawSurfaceLayer(num6++);
		DrawClouds_Distant(flag, num3, pushBGTopHack, num5);
		HorizonRenderer.DrawSurfaceLayer(num6++);
		if (invasionType == 4 && !SkyManager.Instance["Martian"].IsActive())
		{
			SkyManager.Instance.Activate("Martian", default(Vector2));
		}
		else if (invasionType != 4 && SkyManager.Instance["Martian"].IsActive())
		{
			SkyManager.Instance.Deactivate("Martian");
		}
		SkyManager.Instance.ResetDepthTracker();
		bgParallax = 0.15;
		int num7 = -180;
		bool flag2 = true;
		int num8 = 0;
		if (gameMenu)
		{
			num8 -= num7;
		}
		pushBGTopHack = num8;
		pushBGTopHack += num;
		if (!WorldGen.drunkWorldGen && flag && (double)(screenPosition.Y / 16f) <= worldSurface + 10.0)
		{
			if (BackgroundEnabled)
			{
				if (cloudBGActive > 0f)
				{
					cloudBGAlpha += 0.0005f * (float)dayRate;
					if (cloudBGAlpha > 1f)
					{
						cloudBGAlpha = 1f;
					}
				}
				else
				{
					cloudBGAlpha -= 0.0005f * (float)dayRate;
					if (cloudBGAlpha < 0f)
					{
						cloudBGAlpha = 0f;
					}
				}
				if (cloudBGAlpha > 0f)
				{
					LoadBackground(cloudBG[0]);
					LoadBackground(cloudBG[1]);
					float num9 = cloudBGAlpha;
					if (num9 > 1f)
					{
						num9 = 1f;
					}
					bgScale = 1.65f;
					bgParallax = 0.09000000357627869;
					if (base.IsActive && !gamePaused)
					{
						cloudBGX[0] += windSpeedCurrent * (float)bgParallax * 9f * (float)dayRate;
					}
					if (cloudBGX[0] > (float)backgroundWidth[cloudBG[0]] * bgScale)
					{
						cloudBGX[0] -= (float)backgroundWidth[cloudBG[0]] * bgScale;
					}
					if (cloudBGX[0] < (float)(-backgroundWidth[cloudBG[0]]) * bgScale)
					{
						cloudBGX[0] += (float)backgroundWidth[cloudBG[0]] * bgScale;
					}
					float num10 = (float)backgroundWidth[cloudBG[0]] * bgScale;
					bgTopY = num3 * 900f + 600f + scAdj + (float)pushBGTopHack;
					if (gameMenu)
					{
						bgTopY = -150 + pushBGTopHack;
					}
					bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, num10) - (double)(num10 / 2f) - (double)num10);
					bgStartX += (int)cloudBGX[0];
					bgLoops = screenWidth / (int)num10 + 2 + 2;
					ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * num9;
					SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
					for (int i = 0; i < bgLoops; i++)
					{
						spriteBatch.Draw(TextureAssets.Background[cloudBG[0]].Value, new Vector2((float)bgStartX + num10 * (float)i, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[cloudBG[0]], backgroundHeight[cloudBG[0]]), ColorOfSurfaceBackgroundsModified * num5, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
					}
					num9 = cloudBGAlpha * 1.5f;
					if (num9 > 1f)
					{
						num9 = 1f;
					}
					ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * num9;
					bgScale = 1.85f;
					bgParallax = 0.12;
					if (base.IsActive && !gamePaused)
					{
						cloudBGX[1] += windSpeedCurrent * (float)bgParallax * 9f * (float)dayRate;
					}
					if (cloudBGX[1] > (float)backgroundWidth[cloudBG[1]] * bgScale)
					{
						cloudBGX[1] -= (float)backgroundWidth[cloudBG[1]] * bgScale;
					}
					if (cloudBGX[1] < (float)(-backgroundWidth[cloudBG[1]]) * bgScale)
					{
						cloudBGX[1] += (float)backgroundWidth[cloudBG[1]] * bgScale;
					}
					num10 = (float)backgroundWidth[cloudBG[1]] * bgScale;
					bgTopY = num3 * 1100f + 750f + scAdj + (float)pushBGTopHack;
					if (gameMenu)
					{
						bgTopY = -50 + pushBGTopHack;
					}
					bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, num10) - (double)(num10 / 2f) - (double)num10);
					bgStartX += (int)cloudBGX[1];
					bgLoops = screenWidth / (int)num10 + 2 + 2;
					SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
					for (int j = 0; j < bgLoops; j++)
					{
						spriteBatch.Draw(TextureAssets.Background[cloudBG[1]].Value, new Vector2((float)bgStartX + num10 * (float)j, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[cloudBG[1]], backgroundHeight[cloudBG[1]]), ColorOfSurfaceBackgroundsModified * num5, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
					}
				}
				DrawSurfaceBG_BackMountainsStep1(num3, num4, pushBGTopHack);
			}
			DrawClouds_Closer(num5);
			if (SceneMetrics.HolyTileCount > 0 && BackgroundEnabled)
			{
				double num11 = 0.17;
				float num12 = 1.1f;
				int num13 = 1400;
				int num14 = 900;
				if (WorldGen.hallowBG == 3)
				{
					num14 = 1100;
				}
				float num15 = num3 * (float)num13 + (float)num14 + scAdj + (float)pushBGTopHack;
				num12 *= num4;
				int num16 = (int)((double)(2100f * num12) * 1.05);
				int num17 = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * num11, num16) - (double)(num16 / 2));
				_ = screenWidth / num16;
				if (gameMenu)
				{
					num15 = 230 + pushBGTopHack;
					num17 -= 500;
				}
				SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)num11);
				Microsoft.Xna.Framework.Color color = colorOfSurfaceBackgroundsBase;
				float num18 = (float)(SceneMetrics.HolyTileCount - SceneMetrics.HallowTileThreshold) / (float)(SceneMetrics.HallowTileMax - SceneMetrics.HallowTileThreshold);
				if (num18 > 0.5f)
				{
					num18 = 0.5f;
				}
				else if (num18 < 0f)
				{
					num18 = 0f;
				}
				color.R = (byte)((float)(int)color.R * num18);
				color.G = (byte)((float)(int)color.G * num18);
				color.B = (byte)((float)(int)color.B * num18);
				color.A = (byte)((float)(int)color.A * num18 * 0.8f);
				if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
				{
					LoadBackground(18);
					LoadBackground(19);
					for (int k = 0; k < bgLoops; k++)
					{
						spriteBatch.Draw(TextureAssets.Background[18].Value, new Vector2(num17 + num16 * k, num15), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[18], backgroundHeight[18]), color, 0f, default(Vector2), num12, SpriteEffects.None, 0f);
						spriteBatch.Draw(TextureAssets.Background[19].Value, new Vector2(num17 + num16 * k + 1900, num15 + 100f), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[19], backgroundHeight[19]), color, 0f, default(Vector2), num12 * 0.9f, SpriteEffects.None, 0f);
					}
				}
			}
			if (treeMntBGSet1[1] > -1)
			{
				LoadBackground(treeMntBGSet1[1]);
				bgParallax = 0.2;
				bgScale = 1.15f;
				bgScale *= num4;
				int num19 = backgroundWidth[treeMntBGSet1[1]];
				if (num19 == 0)
				{
					num19 = 1;
				}
				bgWidthScaled = (int)((float)num19 * bgScale);
				bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
				bgLoops = screenWidth / bgWidthScaled + 2;
				if (treeMntBGSet1[1] == 172)
				{
					bgLoops++;
				}
				bgTopY = num3 * 1400f + 1260f + scAdj + (float)pushBGTopHack;
			}
			if (BackgroundEnabled)
			{
				DrawSurfaceBG_BackMountainsStep2(pushBGTopHack);
			}
			DrawClouds_Closest(num5);
		}
		HorizonRenderer.DrawSurfaceLayer(num6++);
		if (flag2)
		{
			pushBGTopHack += num7;
		}
		if (flag)
		{
			for (int l = 0; l < bgAlphaFrontLayer.Length; l++)
			{
				if (BackgroundEnabled)
				{
					ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFrontLayer[l];
					if (bgAlphaFrontLayer[l] > 0f && l == 0)
					{
						DrawSurfaceBG_Forest(num3, num4, pushBGTopHack, treeBGSet1);
						DrawSurfaceBG_DrawChangeOverlay(0);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 10)
					{
						DrawSurfaceBG_Forest(num3, num4, pushBGTopHack, treeBGSet2);
						DrawSurfaceBG_DrawChangeOverlay(1);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 11)
					{
						DrawSurfaceBG_Forest(num3, num4, pushBGTopHack, treeBGSet3);
						DrawSurfaceBG_DrawChangeOverlay(2);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 12)
					{
						DrawSurfaceBG_Forest(num3, num4, pushBGTopHack, treeBGSet4);
						DrawSurfaceBG_DrawChangeOverlay(3);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 1)
					{
						int[] bgTexIndexes = corruptBG;
						DrawSurfaceBG_Corrupt(num3, num4, pushBGTopHack, bgTexIndexes);
						DrawSurfaceBG_DrawChangeOverlay(4);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 2)
					{
						int[] backgrounds = desertBackgroundSet.Pure.Backgrounds;
						DrawSurfaceBG_Desert(num3, num4, pushBGTopHack, backgrounds);
						DrawSurfaceBG_DrawChangeOverlay(9);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 3)
					{
						int[] bgTexIndexes2 = jungleBG;
						DrawSurfaceBG_Jungle(num3, num4, pushBGTopHack, bgTexIndexes2);
						DrawSurfaceBG_DrawChangeOverlay(5);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 4)
					{
						DrawSurfaceBG_DrawChangeOverlay(10);
					}
					if (bgAlphaFrontLayer[l] > 0f && (l == 5 || l == 13 || l == 14))
					{
						DrawSurfaceBG_GoodEvilDesert(num3, num4, pushBGTopHack, l);
						DrawSurfaceBG_DrawChangeOverlay(9);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 6)
					{
						int[] bgTexIndexes3 = hallowBG;
						DrawSurfaceBG_Hallow(num3, num4, pushBGTopHack, bgTexIndexes3);
						DrawSurfaceBG_DrawChangeOverlay(7);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 7)
					{
						int[] bgTexIndexes4 = snowBG;
						DrawSurfaceBG_Snow(num3, num4, pushBGTopHack, bgTexIndexes4);
						DrawSurfaceBG_DrawChangeOverlay(6);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 8)
					{
						int[] bgTexIndexes5 = crimsonBG;
						DrawSurfaceBG_Crimson(num3, num4, pushBGTopHack, bgTexIndexes5);
						DrawSurfaceBG_DrawChangeOverlay(8);
					}
					if (bgAlphaFrontLayer[l] > 0f && l == 9)
					{
						int[] bgTexIndexes6 = mushroomBG;
						DrawSurfaceBG_Mushroom(num3, num4, pushBGTopHack, bgTexIndexes6);
						DrawSurfaceBG_DrawChangeOverlay(11);
					}
				}
			}
		}
		HorizonRenderer.DrawSurfaceLayer(num6++);
		if (flag2)
		{
			pushBGTopHack -= num7;
		}
		float num20 = DrawSurfaceBG_GetFogPower();
		if (flag && num20 > 0f && !gameMenu && (double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			bgParallax = 0.1;
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, backgroundWidth[background]) - (double)(backgroundWidth[background] / 2));
			bgLoops = screenWidth / backgroundWidth[background] + 2;
			bgStartY = 0;
			bgLoopsY = 0;
			bgTopY = (0f - screenPosition.Y) / ((float)worldSurface * 16f - 600f) * 200f;
			Texture2D value = TextureAssets.Background[49].Value;
			for (int m = 0; m < bgLoops; m++)
			{
				bgStartX = 0;
				Microsoft.Xna.Framework.Color color2 = ColorOfTheSkies * num20 * atmo;
				int height = Math.Max(screenHeight + 210, value.Height);
				spriteBatch.Draw(value, new Microsoft.Xna.Framework.Rectangle(bgStartX + value.Width * m, (int)bgTopY, value.Width, height), color2);
			}
		}
		if (!mapFullscreen)
		{
			SkyManager.Instance.DrawRemainingDepth(spriteBatch);
		}
	}

	public static bool ShouldDrawSurfaceBackground()
	{
		bool result = false;
		if ((!remixWorld || (gameMenu && !WorldGen.remixWorldGen)) && (!WorldGen.remixWorldGen || !WorldGen.drunkWorldGen))
		{
			result = true;
		}
		if (mapFullscreen)
		{
			result = false;
		}
		return result;
	}

	private void DrawClouds_Closest(float globalCloudAlpha)
	{
		float num = bgTopY * 1.01f - 150f;
		if (!((double)screenPosition.Y < worldSurface * 16.0 + 16.0))
		{
			return;
		}
		StartDrawingClouds();
		for (int i = 0; i < 200; i++)
		{
			Cloud cloud = Main.cloud[i];
			if (cloud.active && cloud.scale >= 1.15f)
			{
				float num2 = cloud.position.Y * ((float)screenHeight / 600f) - 100f;
				DrawCloud(globalCloudAlpha, cloud, 3, num2 + num);
			}
		}
		EndDrawingClouds();
	}

	private void DrawClouds_Closer(float globalCloudAlpha)
	{
		float num = bgTopY - 50f;
		if (!((double)screenPosition.Y < worldSurface * 16.0 + 16.0))
		{
			return;
		}
		StartDrawingClouds();
		for (int i = 0; i < 200; i++)
		{
			Cloud cloud = Main.cloud[i];
			if (cloud.active && (double)cloud.scale < 1.15 && cloud.scale >= 1f)
			{
				float num2 = cloud.position.Y * ((float)screenHeight / 600f);
				DrawCloud(globalCloudAlpha, cloud, 2, num2 + num + 200f);
			}
		}
		EndDrawingClouds();
	}

	private void DrawClouds_Distant(bool drawBackground, float backgroundTopMagicNumber, int pushBGTopHack, float globalCloudAlpha)
	{
		if (!drawBackground)
		{
			return;
		}
		float num = backgroundTopMagicNumber * 750f + 830f + scAdj + (float)pushBGTopHack;
		if (!((double)screenPosition.Y < worldSurface * 16.0 + 16.0))
		{
			return;
		}
		StartDrawingClouds();
		for (int i = 0; i < 200; i++)
		{
			Cloud cloud = Main.cloud[i];
			if (cloud.active && cloud.scale < 1f)
			{
				float y = cloud.position.Y;
				DrawCloud(globalCloudAlpha, cloud, 1, y + num);
			}
		}
		EndDrawingClouds();
	}

	private void StartDrawingClouds()
	{
		HorizonRenderer.CloudsStart();
	}

	private void EndDrawingClouds()
	{
		HorizonRenderer.CloudsEnd();
	}

	private void DrawCloud(float globalCloudAlpha, Cloud theCloud, int cloudPass, float cY)
	{
		HorizonRenderer.DrawCloud(globalCloudAlpha, theCloud, cloudPass, cY);
	}

	private static float DrawSurfaceBG_GetFogPower()
	{
		return Math.Max(cloudAlpha, GraveyardVisualIntensity * 0.92f);
	}

	private void DrawSurfaceBG_DrawBackMountainsLayer(int bgTextureIndex)
	{
		if (bgTextureIndex >= 0)
		{
			LoadBackground(bgTextureIndex);
			int num = DrawSurfaceBG_GetLayerYOffset(bgTextureIndex);
			bgTopY += num;
			for (int i = 0; i < bgLoops; i++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTextureIndex].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), GetBackgroundRect(bgTextureIndex), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
			bgTopY -= num;
		}
	}

	private int DrawSurfaceBG_GetLayerYOffset(int bgTextureIndex)
	{
		switch (bgTextureIndex)
		{
		case 59:
			return -550;
		case 93:
		case 168:
		case 169:
		case 170:
			return -50;
		case 171:
			return -100;
		case 172:
			return 130;
		case 176:
			return -760;
		case 177:
			return -200;
		case 179:
			return -100;
		case 180:
		case 181:
		case 182:
		case 183:
			return -350;
		case 246:
			return -150;
		case 247:
			return -150;
		case 263:
			return -700;
		case 269:
			return -600;
		case 270:
			return -50;
		case 271:
			return -300;
		case 272:
			return -380;
		case 277:
			return -260;
		case 278:
			return -120;
		case 280:
			return -170;
		case 281:
			return -300;
		case 283:
			return -800;
		case 332:
			return -25;
		case 340:
			return -25;
		default:
			return 0;
		}
	}

	private float GetForestToForestBackgroundLerperValue()
	{
		return (GlobalTimeWrappedHourly * ((float)Math.PI / 2f)).ToRotationVector2().X * 0.5f + 0.5f;
	}

	private void DrawSurfaceBG_BackMountainsStep1(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack)
	{
		Microsoft.Xna.Framework.Color colorOfSurfaceBackgroundsBase = ColorOfSurfaceBackgroundsBase;
		bgScale = 1f;
		bgTopY = backgroundTopMagicNumber * 1300f + 1090f + scAdj + (float)pushBGTopHack;
		bgScale *= bgGlobalScaleMultiplier;
		bgParallax = 0.15;
		bgWidthScaled = (int)(1024f * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (bgWidthScaled == 0)
		{
			bgWidthScaled = 1024;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if (gameMenu)
		{
			bgTopY = 100 + pushBGTopHack;
		}
		if (!((double)screenPosition.Y < worldSurface * 16.0 + 16.0))
		{
			return;
		}
		if (bgAlphaFarBackLayer[0] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[0];
			DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet1[0]);
		}
		if (bgAlphaFarBackLayer[10] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[10];
			DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet2[0]);
		}
		if (bgAlphaFarBackLayer[11] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[11];
			DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet3[0]);
		}
		if (bgAlphaFarBackLayer[12] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[12];
			DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet4[0]);
		}
		if (bgAlphaFarBackLayer[1] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[1];
			if (WorldGen.desertBG != 4)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(23);
			}
		}
		if (bgAlphaFarBackLayer[2] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[2];
			DrawSurfaceBG_DrawBackMountainsLayer(24);
		}
		if (bgAlphaFarBackLayer[4] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[4];
			DrawSurfaceBG_DrawBackMountainsLayer(snowMntBG[0]);
		}
		if (bgAlphaFarBackLayer[5] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[5];
			if (WorldGen.crimsonBG != 5)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(24);
			}
		}
		if (bgAlphaFarBackLayer[6] > 0f && WorldGen.hallowBG == 3)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[6];
			DrawSurfaceBG_DrawBackMountainsLayer(246);
		}
		SkyManager.Instance.DrawToDepth(spriteBatch, 5f);
	}

	private void DrawSurfaceBG_BackMountainsStep2(int pushBGTopHack)
	{
		if (gameMenu)
		{
			bgTopY = 230 + pushBGTopHack;
			bgStartX -= 500;
		}
		Microsoft.Xna.Framework.Color colorOfSurfaceBackgroundsBase = ColorOfSurfaceBackgroundsBase;
		UpdateOceanWaterLineForAmbience();
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		if (!((double)screenPosition.Y < worldSurface * 16.0 + 16.0))
		{
			return;
		}
		if (bgAlphaFarBackLayer[0] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[0];
			if (treeMntBGSet1[1] > -1)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet1[1]);
			}
		}
		if (bgAlphaFarBackLayer[1] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[1];
			if (WorldGen.desertBG != 4)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(22);
			}
		}
		if (bgAlphaFarBackLayer[2] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[2];
			DrawSurfaceBG_DrawBackMountainsLayer(25);
		}
		if (bgAlphaFarBackLayer[3] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[3];
			DrawSurfaceBG_DrawBackMountainsLayer(oceanBG);
		}
		if (bgAlphaFarBackLayer[4] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[4];
			DrawSurfaceBG_DrawBackMountainsLayer(snowMntBG[1]);
		}
		if (bgAlphaFarBackLayer[5] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[5];
			if (WorldGen.crimsonBG != 5)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(42);
			}
		}
		if (bgAlphaFarBackLayer[6] > 0f && WorldGen.hallowBG == 3)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[6];
			DrawSurfaceBG_DrawBackMountainsLayer(247);
		}
		if (bgAlphaFarBackLayer[10] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[10];
			if (treeMntBGSet2[1] > -1)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet2[1]);
			}
		}
		if (bgAlphaFarBackLayer[11] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[11];
			if (treeMntBGSet3[1] > -1)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet3[1]);
			}
		}
		if (bgAlphaFarBackLayer[12] > 0f)
		{
			ColorOfSurfaceBackgroundsModified = colorOfSurfaceBackgroundsBase * bgAlphaFarBackLayer[12];
			if (treeMntBGSet4[1] > -1)
			{
				DrawSurfaceBG_DrawBackMountainsLayer(treeMntBGSet4[1]);
			}
		}
	}

	private void UpdateOceanWaterLineForAmbience()
	{
		int num = DrawSurfaceBG_GetLayerYOffset(oceanBG);
		int num2 = 0;
		switch (oceanBG)
		{
		case 28:
		case 110:
		case 111:
		case 209:
		case 210:
			num2 = 102;
			break;
		case 283:
			num2 = 124;
			break;
		}
		float yScreenPosition = bgTopY + (float)num + (float)num2 * bgScale;
		AmbientSkyDrawCache.Instance.SetOceanLineInfo(yScreenPosition, bgAlphaFarBackLayer[3]);
	}

	private void DrawSurfaceBG_Mushroom(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		float num = 0.33f;
		Vector3 vector = new Vector3(0.1f, 0.15f, 0.3f);
		float num2 = 0.5f;
		Vector3 vector2 = new Vector3(0.1f, 0.175f, 0.3f);
		float num3 = 0.75f;
		Vector3 vector3 = new Vector3(0.125f, 0.2f, 0.3f);
		num = 0.5f;
		num2 = 0.625f;
		num3 = 0.75f;
		vector *= 3f;
		vector2 *= 3f;
		vector3 *= 3f;
		float num4 = (float)(int)ColorOfSurfaceBackgroundsModified.A / 255f;
		Microsoft.Xna.Framework.Color colorOfSurfaceBackgroundsModified = ColorOfSurfaceBackgroundsModified;
		float num5 = (float)rand.Next(28, 42) * 0.001f;
		num5 += (float)(270 - mouseTextColor) / 5000f;
		float x = vector.X;
		float num6 = vector.Y + num5 / 2f;
		float num7 = vector.Z + num5;
		x *= 255f;
		num6 *= 255f;
		num7 *= 255f;
		x *= num * num4;
		num6 *= num * num4;
		num7 *= num * num4;
		if (x > 255f)
		{
			x = 255f;
		}
		if (num6 > 255f)
		{
			num6 = 255f;
		}
		if (num7 > 255f)
		{
			num7 = 255f;
		}
		if (x > (float)(int)colorOfSurfaceBackgroundsModified.R)
		{
			colorOfSurfaceBackgroundsModified.R = (byte)x;
		}
		if (num6 > (float)(int)colorOfSurfaceBackgroundsModified.G)
		{
			colorOfSurfaceBackgroundsModified.G = (byte)num6;
		}
		if (num7 > (float)(int)colorOfSurfaceBackgroundsModified.B)
		{
			colorOfSurfaceBackgroundsModified.B = (byte)num7;
		}
		bgScale = 1.25f;
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[0]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
		bgParallax = 0.4;
		SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 1800f + 1400f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
		if (gameMenu)
		{
			bgTopY = 320 + pushBGTopHack;
		}
		if (bgWidthScaled != 0)
		{
			bgLoops = screenWidth / bgWidthScaled + 2;
		}
		if (TextureAssets.Background[bgTexIndexes[0]].Value == null)
		{
			return;
		}
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int i = 0; i < bgLoops; i++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), GetBackgroundRect(bgTexIndexes[0]), colorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
		colorOfSurfaceBackgroundsModified = ColorOfSurfaceBackgroundsModified;
		num5 = (float)rand.Next(28, 42) * 0.001f;
		num5 += (float)(270 - mouseTextColor) / 5000f;
		x = vector2.X;
		num6 = vector2.Y + num5 / 2f;
		num7 = vector2.Z + num5;
		x *= 255f;
		num6 *= 255f;
		num7 *= 255f;
		x *= num2 * num4;
		num6 *= num2 * num4;
		num7 *= num2 * num4;
		if (x > 255f)
		{
			x = 255f;
		}
		if (num6 > 255f)
		{
			num6 = 255f;
		}
		if (num7 > 255f)
		{
			num7 = 255f;
		}
		if (x > (float)(int)colorOfSurfaceBackgroundsModified.R)
		{
			colorOfSurfaceBackgroundsModified.R = (byte)x;
		}
		if (num6 > (float)(int)colorOfSurfaceBackgroundsModified.G)
		{
			colorOfSurfaceBackgroundsModified.G = (byte)num6;
		}
		if (num7 > (float)(int)colorOfSurfaceBackgroundsModified.B)
		{
			colorOfSurfaceBackgroundsModified.B = (byte)num7;
		}
		bgScale = 1.32f;
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[1]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
		bgParallax = 0.43;
		SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 1950f + 1675f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
		if (gameMenu)
		{
			bgTopY = 400 + pushBGTopHack;
			bgStartX -= 80;
		}
		if (bgWidthScaled == 0)
		{
			return;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int j = 0; j < bgLoops; j++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), GetBackgroundRect(bgTexIndexes[1]), colorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
		colorOfSurfaceBackgroundsModified = ColorOfSurfaceBackgroundsModified;
		num5 = (float)rand.Next(28, 42) * 0.001f;
		num5 += (float)(270 - mouseTextColor) / 3000f;
		x = vector3.X;
		num6 = vector3.Y + num5 / 2f;
		num7 = vector3.Z + num5;
		x *= 255f * num4 * num3;
		num6 *= 255f * num4 * num3;
		num7 *= 255f * num4 * num3;
		if (x > 255f)
		{
			x = 255f;
		}
		if (num6 > 255f)
		{
			num6 = 255f;
		}
		if (num7 > 255f)
		{
			num7 = 255f;
		}
		if (x > (float)(int)colorOfSurfaceBackgroundsModified.R)
		{
			colorOfSurfaceBackgroundsModified.R = (byte)x;
		}
		if (num6 > (float)(int)colorOfSurfaceBackgroundsModified.G)
		{
			colorOfSurfaceBackgroundsModified.G = (byte)num6;
		}
		if (num7 > (float)(int)colorOfSurfaceBackgroundsModified.B)
		{
			colorOfSurfaceBackgroundsModified.B = (byte)num7;
		}
		bgScale = 1.36f;
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		bgParallax = 0.49;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 2100f + 1950f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		if (bgWidthScaled == 0)
		{
			return;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), GetBackgroundRect(bgTexIndexes[2]), colorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f);
	}

	private void DrawSurfaceBG_Crimson(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		if (bgTexIndexes[0] > -1)
		{
			bgScale = 1.25f;
			bgParallax = 0.4;
			bgTopY = backgroundTopMagicNumber * 1800f + 1500f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[0]);
			if (bgTexIndexes[0] == -1)
			{
				return;
			}
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (bgTexIndexes[0] == 105)
			{
				bgTopY += 50f;
			}
			if (bgTexIndexes[0] == 174)
			{
				bgTopY -= 350f;
			}
			if (gameMenu)
			{
				bgTopY = 320 + pushBGTopHack;
			}
			if (bgWidthScaled <= 0)
			{
				return;
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int i = 0; i < bgLoops; i++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), GetBackgroundRect(bgTexIndexes[0]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[1] > -1)
		{
			bgScale = 1.31f;
			bgParallax = 0.43;
			bgTopY = backgroundTopMagicNumber * 1950f + 1750f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[1]);
			if (bgTexIndexes[1] == -1)
			{
				return;
			}
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (gameMenu)
			{
				bgTopY = 400 + pushBGTopHack;
				bgStartX -= 80;
			}
			if (bgWidthScaled <= 0)
			{
				return;
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int j = 0; j < bgLoops; j++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), GetBackgroundRect(bgTexIndexes[1]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		bgScale = 1.34f;
		bgParallax = 0.49;
		bgTopY = backgroundTopMagicNumber * 2100f + 2000f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		if (bgTexIndexes[2] == -1)
		{
			return;
		}
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		if (bgWidthScaled <= 0)
		{
			return;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if (bgTexIndexes[2] == 175)
		{
			bgStartX -= 1000;
			bgTopY -= 400f;
			bgLoops++;
		}
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), GetBackgroundRect(bgTexIndexes[2]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void DrawSurfaceBG_Snow(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		if (bgTexIndexes[0] >= 0)
		{
			bgScale = 1.25f;
			bgParallax = 0.4;
			bgTopY = backgroundTopMagicNumber * 1800f + 1500f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[0]);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (gameMenu)
			{
				bgTopY = 320 + pushBGTopHack;
			}
			bgTopY += DrawSurfaceBG_GetLayerYOffset(bgTexIndexes[0]);
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int i = 0; i < bgLoops; i++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[bgTexIndexes[0]], backgroundHeight[bgTexIndexes[0]]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[1] >= 0)
		{
			bgScale = 1.31f;
			bgParallax = 0.43;
			bgTopY = backgroundTopMagicNumber * 1950f + 1750f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[1]);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (gameMenu)
			{
				bgTopY = 400 + pushBGTopHack;
				bgStartX -= 80;
			}
			bgTopY += DrawSurfaceBG_GetLayerYOffset(bgTexIndexes[1]);
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int j = 0; j < bgLoops; j++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[bgTexIndexes[1]], backgroundHeight[bgTexIndexes[1]]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[2] < 0)
		{
			return;
		}
		bgScale = 1.34f;
		bgParallax = 0.49;
		bgTopY = backgroundTopMagicNumber * 2100f + 2000f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		bgTopY += DrawSurfaceBG_GetLayerYOffset(bgTexIndexes[2]);
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[bgTexIndexes[2]], backgroundHeight[bgTexIndexes[2]]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void SetBackgroundOffsets(int backgroundID, float backgroundTopMagicNumber, int pushBGTopHack)
	{
		int num = 0;
		int num2 = 0;
		switch (backgroundID)
		{
		case 258:
			bgScale = 1.25f;
			bgParallax = 0.23;
			num = 1800;
			num2 = 850;
			break;
		case 259:
			bgScale = 1.31f;
			bgParallax = 0.33;
			num = 1950;
			num2 = 1500;
			break;
		case 260:
			bgScale = 1.34f;
			bgParallax = 0.4;
			num = 2100;
			num2 = 1650;
			break;
		case 263:
			bgScale = 1.25f;
			bgParallax = 0.23;
			num = 1800;
			num2 = 1450;
			break;
		case 264:
			bgScale = 1.31f;
			bgParallax = 0.33;
			num = 1950;
			num2 = 1700;
			break;
		case 265:
			bgScale = 1.34f;
			bgParallax = 0.4;
			num = 2100;
			num2 = 2000;
			break;
		case 267:
			bgScale = 1.25f;
			bgParallax = 0.23;
			num = 1700;
			num2 = 1300;
			break;
		case 266:
			bgScale = 1.31f;
			bgParallax = 0.33;
			num = 1950;
			num2 = 1600;
			break;
		case 268:
			bgScale = 1.34f;
			bgParallax = 0.41;
			num = 2100;
			num2 = 1850;
			break;
		case 248:
			bgScale = 1.3f;
			bgParallax = 0.37;
			num = 1800;
			num2 = 1100;
			break;
		case 249:
			bgScale = 1.4f;
			bgParallax = 0.43;
			num = 1950;
			num2 = 1200;
			break;
		case 250:
			bgScale = 1.7f;
			bgParallax = 0.49;
			num = 2000;
			num2 = 1000;
			break;
		case 255:
			bgScale = 1.15f;
			bgParallax = 0.25;
			num = 1800;
			num2 = 1450;
			break;
		case 256:
			bgScale = 1.21f;
			bgParallax = 0.32;
			num = 1950;
			num2 = 1550;
			break;
		case 257:
			bgScale = 1.34f;
			bgParallax = 0.4;
			num = 2100;
			num2 = 1550;
			break;
		case 240:
			bgScale = 1.15f;
			bgParallax = 0.3;
			num = 1800;
			num2 = 1500;
			break;
		case 241:
			bgScale = 1.21f;
			bgParallax = 0.43;
			num = 1950;
			num2 = 1300;
			break;
		case 242:
			bgScale = 1.34f;
			bgParallax = 0.49;
			num = 2100;
			num2 = 1400;
			break;
		case 243:
			bgScale = 1.15f;
			bgParallax = 0.25;
			num = 1800;
			num2 = 1400;
			break;
		case 244:
			bgScale = 1.21f;
			bgParallax = 0.35;
			num = 1950;
			num2 = 1550;
			break;
		case 245:
			bgScale = 1.24f;
			bgParallax = 0.45;
			num = 2100;
			num2 = 1650;
			break;
		case 273:
			bgParallax = 0.49000000953674316;
			num = 2100;
			num2 = 1560;
			break;
		case 234:
			bgParallax = 0.23;
			num = 1700;
			num2 = 1150;
			break;
		case 235:
			bgParallax = 0.33;
			num = 1950;
			num2 = 1550;
			break;
		case 236:
			bgParallax = 0.41;
			num = 2100;
			num2 = 2000;
			break;
		case 279:
			bgScale = 2.5f;
			bgParallax = 0.3499999940395355;
			num = 1850;
			num2 = 1750;
			break;
		case 282:
			bgScale = 2.6f;
			bgParallax = 0.25;
			num = 1800;
			num2 = 1340;
			break;
		case 261:
			bgParallax = 0.27;
			break;
		case 262:
			bgParallax = 0.4;
			break;
		case 219:
			bgParallax = 0.25;
			break;
		case 220:
			bgParallax = 0.34;
			break;
		case 221:
			bgParallax = 0.43;
			break;
		case 222:
			num = 1800;
			num2 = 1400;
			break;
		case 223:
			num = 2150;
			num2 = 1850;
			break;
		case 224:
			num = 2500;
			num2 = 2400;
			break;
		case 237:
			num = 1800;
			num2 = 1500;
			break;
		case 238:
			num = 1950;
			num2 = 1500;
			break;
		case 239:
			num = 2100;
			num2 = 1900;
			break;
		case 284:
			bgParallax = 0.23;
			num = 1600;
			num2 = 900;
			break;
		case 285:
			bgParallax = 0.36;
			num = 1900;
			num2 = 960;
			break;
		case 286:
			bgParallax = 0.42;
			num = 2100;
			num2 = 1200;
			break;
		case 287:
			bgParallax = 0.21;
			num = 1700;
			num2 = 1560;
			break;
		case 288:
			bgParallax = 0.33;
			num = 1950;
			num2 = 1730;
			break;
		case 289:
			bgParallax = 0.41;
			num = 2100;
			num2 = 1400;
			break;
		case 207:
			bgParallax = 0.32;
			break;
		case 298:
			bgScale = 1.25f;
			num = 2000;
			num2 = 1700;
			bgParallax = 0.3499999940395355;
			break;
		case 299:
			num = 1600;
			num2 = 1400;
			bgParallax = 0.2800000011920929;
			break;
		case 300:
			bgScale = 2.41f;
			num = 3000;
			num2 = 2050;
			bgParallax = 0.5299999713897705;
			break;
		case 301:
			bgScale = 2.36f;
			num = 2200;
			num2 = 1700;
			bgParallax = 0.41499999165534973;
			break;
		case 302:
			bgScale = 2.25f;
			num = 1400;
			num2 = 950;
			bgParallax = 0.23999999463558197;
			break;
		case 303:
		case 304:
		case 305:
		case 307:
		case 308:
		case 309:
		case 311:
		case 312:
		case 313:
		case 315:
		case 316:
		case 317:
			num = 2400;
			num2 = 1900;
			bgParallax = 0.3499999940395355;
			break;
		case 306:
		case 310:
		case 314:
		case 318:
			num = 1800;
			num2 = 1700;
			bgParallax = 0.25999999046325684;
			break;
		case 319:
			num = 4600;
			num2 = 3250;
			bgParallax = 0.6000000238418579;
			break;
		case 320:
			num = 2250;
			num2 = 1950;
			bgParallax = 0.30000001192092896;
			break;
		case 321:
			bgParallax = 0.25;
			break;
		case 322:
			num = 2400;
			num2 = 1950;
			bgParallax = 0.44999998807907104;
			break;
		case 323:
			num = 1900;
			num2 = 1500;
			bgParallax = 0.35;
			break;
		case 324:
			num = 1600;
			num2 = 1300;
			bgParallax = 0.25;
			break;
		case 325:
			num = 2800;
			num2 = 2400;
			bgParallax = 0.49000000953674316;
			break;
		case 326:
			num = 2000;
			num2 = 1740;
			bgParallax = 0.33000001311302185;
			break;
		case 327:
			num = 1450;
			num2 = 1165;
			bgParallax = 0.2199999988079071;
			break;
		case 328:
			bgScale = 2.01f;
			bgParallax = 0.3400000035762787;
			break;
		case 329:
			bgScale = 2.29f;
			bgParallax = 0.25999999046325684;
			break;
		case 330:
			num = 1750;
			num2 = 1450;
			bgParallax = 0.25;
			break;
		case 333:
			bgScale = 2.01f;
			bgParallax = 0.3700000047683716;
			break;
		case 334:
			bgParallax = 0.25999999046325684;
			break;
		case 335:
			num = 1650;
			num2 = 1470;
			bgParallax = 0.2199999988079071;
			break;
		case 337:
			bgScale = 1.01f;
			num = 2500;
			num2 = 2200;
			bgParallax = 0.3499999940395355;
			break;
		case 338:
			bgScale = 0.98f;
			num = 1900;
			num2 = 1650;
			bgParallax = 0.23999999463558197;
			break;
		case 339:
			bgScale = 0.94f;
			num = 1600;
			num2 = 1350;
			bgParallax = 0.20000000298023224;
			break;
		case 341:
			bgParallax = 0.30000001192092896;
			break;
		case 342:
			bgParallax = 0.25;
			break;
		case 343:
			num = 1650;
			num2 = 1550;
			bgParallax = 0.20000000298023224;
			break;
		}
		if (num != 0 || num2 != 0)
		{
			bgTopY = backgroundTopMagicNumber * (float)num + (float)num2 + scAdj + (float)pushBGTopHack;
		}
	}

	private void DrawSurfaceBG_Hallow(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		if (bgTexIndexes[0] > 0)
		{
			bgScale = 1.25f;
			bgParallax = 0.4;
			bgTopY = backgroundTopMagicNumber * 1800f + 1500f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[0]);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1.2f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (gameMenu)
			{
				bgTopY = 320 + pushBGTopHack;
				if (bgWidthScaled <= 0)
				{
					return;
				}
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int i = 0; i < bgLoops; i++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), GetBackgroundRect(bgTexIndexes[0]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[1] > 0)
		{
			bgScale = 1.31f;
			bgParallax = 0.43;
			bgTopY = backgroundTopMagicNumber * 1950f + 1750f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[1]);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (gameMenu)
			{
				bgTopY = 400 + pushBGTopHack;
				bgStartX -= 80;
				if (bgWidthScaled <= 0)
				{
					return;
				}
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int j = 0; j < bgLoops; j++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), GetBackgroundRect(bgTexIndexes[1]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[2] <= 0)
		{
			return;
		}
		bgScale = 1.34f;
		bgParallax = 0.49;
		bgTopY = backgroundTopMagicNumber * 2100f + 2000f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
			if (bgWidthScaled <= 0)
			{
				return;
			}
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), GetBackgroundRect(bgTexIndexes[2]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void DrawSurfaceBG_GoodEvilDesert(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int layerIndex)
	{
		if (layerIndex == 5 && desertBackgroundSet.Corrupt.HasAny)
		{
			DrawSurfaceBG_Desert(backgroundTopMagicNumber, bgGlobalScaleMultiplier, pushBGTopHack, desertBackgroundSet.Corrupt.Backgrounds);
			return;
		}
		if (layerIndex == 14 && desertBackgroundSet.Crimson.HasAny)
		{
			DrawSurfaceBG_Desert(backgroundTopMagicNumber, bgGlobalScaleMultiplier, pushBGTopHack, desertBackgroundSet.Crimson.Backgrounds);
			return;
		}
		if (layerIndex == 13 && desertBackgroundSet.Hallow.HasAny)
		{
			DrawSurfaceBG_Desert(backgroundTopMagicNumber, bgGlobalScaleMultiplier, pushBGTopHack, desertBackgroundSet.Hallow.Backgrounds);
			return;
		}
		LoadBackground(26);
		bgScale = 1.25f;
		bgScale *= bgGlobalScaleMultiplier;
		bgWidthScaled = (int)((float)backgroundWidth[26] * bgScale);
		bgParallax = 0.37;
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 1800f + 1750f + scAdj + (float)pushBGTopHack;
		if (gameMenu)
		{
			bgTopY = 320 + pushBGTopHack;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int i = 0; i < bgLoops; i++)
			{
				spriteBatch.Draw(TextureAssets.Background[26].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[26], backgroundHeight[26]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
		bgScale = 1.34f;
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(27);
		bgWidthScaled = (int)((float)backgroundWidth[27] * bgScale);
		bgParallax = 0.49;
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 2100f + 2150f + scAdj + (float)pushBGTopHack;
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int j = 0; j < bgLoops; j++)
			{
				spriteBatch.Draw(TextureAssets.Background[27].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[27], backgroundHeight[27]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void DrawSurfaceBG_Jungle(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		LoadBackground(bgTexIndexes[0]);
		bgScale = 1.25f;
		bgScale *= bgGlobalScaleMultiplier;
		bgParallax = 0.4;
		SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 1800f + 1660f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
		if (gameMenu)
		{
			bgTopY = 320 + pushBGTopHack;
		}
		if (bgTexIndexes[0] == 59)
		{
			bgTopY -= 200f;
		}
		bgTopY += DrawSurfaceBG_GetLayerYOffset(bgTexIndexes[0]);
		if (bgWidthScaled <= 0)
		{
			return;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int i = 0; i < bgLoops; i++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), GetBackgroundRect(bgTexIndexes[0]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
		LoadBackground(bgTexIndexes[1]);
		bgScale = 1.31f;
		bgScale *= bgGlobalScaleMultiplier;
		bgParallax = 0.43;
		SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 1950f + 1840f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
		if (gameMenu)
		{
			bgTopY = 400 + pushBGTopHack;
			bgStartX -= 80;
		}
		if (bgTexIndexes[1] == 60)
		{
			bgTopY -= 175f;
		}
		bgTopY += DrawSurfaceBG_GetLayerYOffset(bgTexIndexes[1]);
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int j = 0; j < bgLoops; j++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), GetBackgroundRect(bgTexIndexes[1]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.FlipHorizontally, 0f);
			}
		}
		bgScale = 1.34f;
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		bgParallax = 0.49;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 2100f + 2060f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		if (bgTexIndexes[2] == 61)
		{
			bgTopY -= 150f;
		}
		bgTopY += DrawSurfaceBG_GetLayerYOffset(bgTexIndexes[2]);
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), GetBackgroundRect(bgTexIndexes[2]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void DrawSurfaceBG_Desert(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		if (bgTexIndexes[0] > 0)
		{
			bgScale = 1.25f;
			bgParallax = 0.37;
			bgTopY = backgroundTopMagicNumber * 1800f + 1750f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
			LoadBackground(bgTexIndexes[0]);
			bgScale *= bgGlobalScaleMultiplier;
			float num = (float)backgroundWidth[bgTexIndexes[0]] * bgScale;
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, num) - (double)(num / 2f));
			if (gameMenu)
			{
				bgTopY = 320 + pushBGTopHack;
			}
			bgLoops = screenWidth / (int)num + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int i = 0; i < bgLoops; i++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2((float)bgStartX + num * (float)i, bgTopY), GetBackgroundRect(bgTexIndexes[0]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[1] > 0)
		{
			bgScale = 1.34f;
			bgParallax = 0.49;
			bgTopY = backgroundTopMagicNumber * 2100f + 2150f + scAdj + (float)pushBGTopHack;
			SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
			bgScale *= bgGlobalScaleMultiplier;
			LoadBackground(bgTexIndexes[1]);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (gameMenu)
			{
				bgTopY = 480 + pushBGTopHack;
				bgStartX -= 120;
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int j = 0; j < bgLoops; j++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), GetBackgroundRect(bgTexIndexes[1]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		if (bgTexIndexes[2] <= 0)
		{
			return;
		}
		bgScale = 1.34f;
		bgParallax = 0.49;
		bgTopY = backgroundTopMagicNumber * 2100f + 2150f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), GetBackgroundRect(bgTexIndexes[2]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void DrawSurfaceBG_DrawChangeOverlay(int backgroundAreaId)
	{
		Texture2D value = TextureAssets.MagicPixel.Value;
		float flashPower = WorldGen.BackgroundsCache.GetFlashPower(backgroundAreaId);
		Microsoft.Xna.Framework.Color color = Microsoft.Xna.Framework.Color.Black * flashPower;
		if (!(color == Microsoft.Xna.Framework.Color.Transparent))
		{
			spriteBatch.Draw(value, new Microsoft.Xna.Framework.Rectangle(0, 0, screenWidth, screenHeight), color);
		}
	}

	private void DrawSurfaceBG_Corrupt(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		bgScale = 1.25f;
		bgParallax = 0.4;
		bgTopY = backgroundTopMagicNumber * 1800f + 1500f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[0]);
		if (backgroundWidth[bgTexIndexes[0]] == 0 || backgroundHeight[bgTexIndexes[0]] == 0)
		{
			return;
		}
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 320 + pushBGTopHack;
		}
		if (bgTexIndexes[0] == 56)
		{
			bgTopY -= 100f;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int i = 0; i < bgLoops; i++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[0]].Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[bgTexIndexes[0]], backgroundHeight[bgTexIndexes[0]]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
		bgScale = 1.31f;
		bgParallax = 0.43;
		bgTopY = backgroundTopMagicNumber * 1950f + 1750f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[1]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 400 + pushBGTopHack;
			bgStartX -= 80;
		}
		if (bgTexIndexes[0] == 56)
		{
			bgTopY -= 100f;
		}
		if (bgWidthScaled == 0)
		{
			bgWidthScaled = 1;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			try
			{
				Texture2D value = TextureAssets.Background[bgTexIndexes[1]].Value;
				if (value != null)
				{
					for (int j = 0; j < bgLoops; j++)
					{
						spriteBatch.Draw(value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[bgTexIndexes[1]], backgroundHeight[bgTexIndexes[1]]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.FlipHorizontally, 0f);
					}
				}
			}
			catch
			{
				LoadBackground(bgTexIndexes[1]);
			}
		}
		bgScale = 1.34f;
		bgParallax = 0.49;
		bgTopY = backgroundTopMagicNumber * 2100f + 2000f + scAdj + (float)pushBGTopHack;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		LoadBackground(bgTexIndexes[2]);
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		if (bgWidthScaled == 0)
		{
			bgWidthScaled = 150;
		}
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		if (bgTexIndexes[0] == 56)
		{
			bgTopY -= 100f;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		try
		{
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int k = 0; k < bgLoops; k++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), new Microsoft.Xna.Framework.Rectangle(0, 0, backgroundWidth[bgTexIndexes[2]], backgroundHeight[bgTexIndexes[2]]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
				}
			}
		}
		catch
		{
			LoadBackground(bgTexIndexes[2]);
		}
	}

	private Microsoft.Xna.Framework.Rectangle? GetBackgroundRect(int backgroundTextureIndex)
	{
		int num = 0;
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(0, 0, 1, 1);
		switch (backgroundTextureIndex)
		{
		case 235:
			num = (int)(GetBackgroundCounter() / 20) % 4;
			rectangle = TextureAssets.Background[backgroundTextureIndex].Frame(2, 2, num % 2, num / 2);
			rectangle.Inflate(0, -2);
			return rectangle;
		case 219:
		case 220:
		case 221:
		case 271:
		case 272:
		case 273:
		case 302:
		case 303:
		case 305:
		case 307:
		case 309:
		case 311:
		case 313:
		case 315:
		case 317:
		case 326:
		case 337:
		case 338:
		case 341:
			num = (int)(GetBackgroundCounter() / 15) % 4;
			rectangle = TextureAssets.Background[backgroundTextureIndex].Frame(2, 2, num % 2, num / 2);
			rectangle.Inflate(0, -2);
			return rectangle;
		case 281:
			num = (int)(GetBackgroundCounter() / 5) % 4;
			rectangle = TextureAssets.Background[backgroundTextureIndex].Frame(2, 2, num % 2, num / 2);
			rectangle.Inflate(0, -2);
			return rectangle;
		default:
			return null;
		}
	}

	private uint GetBackgroundCounter()
	{
		if (!gameMenu)
		{
			return GameUpdateCount;
		}
		return (uint)(GlobalTimeWrappedHourly * 40f);
	}

	private void DrawSurfaceBG_Forest(float backgroundTopMagicNumber, float bgGlobalScaleMultiplier, int pushBGTopHack, int[] bgTexIndexes)
	{
		bgScale = 1.25f;
		bgParallax = 0.4;
		bgTopY = backgroundTopMagicNumber * 1800f + 1500f + scAdj + (float)pushBGTopHack;
		if (bgTexIndexes[0] == 91)
		{
			bgParallax = 0.27000001072883606;
			bgScale = 1.2f;
		}
		if (bgTexIndexes[0] == 173)
		{
			bgParallax = 0.25;
			bgScale = 1.3f;
		}
		if (bgTexIndexes[0] == 178)
		{
			bgParallax = 0.30000001192092896;
			bgScale = 1.2f;
		}
		if (bgTexIndexes[0] == 184)
		{
			bgParallax = 0.25;
			bgScale = 1.2f;
		}
		if (bgTexIndexes[0] == 282)
		{
			bgScale = 1.4f;
		}
		SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
		bgScale *= bgGlobalScaleMultiplier;
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		if (bgTexIndexes[0] >= 0)
		{
			SetBackgroundOffsets(bgTexIndexes[0], backgroundTopMagicNumber, pushBGTopHack);
			LoadBackground(bgTexIndexes[0]);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[0]] * bgScale);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			if (bgTexIndexes[0] == 91)
			{
				bgTopY = backgroundTopMagicNumber * 1600f + 1400f + scAdj + (float)pushBGTopHack;
			}
			if (bgTexIndexes[0] == 173)
			{
				bgTopY = backgroundTopMagicNumber * 1600f + 1400f + scAdj + (float)pushBGTopHack;
			}
			if (bgTexIndexes[0] == 184)
			{
				bgTopY = backgroundTopMagicNumber * 1600f + 1400f + scAdj + (float)pushBGTopHack;
			}
			if (gameMenu)
			{
				bgTopY = 320 + pushBGTopHack;
			}
			if (bgTexIndexes[0] == 50)
			{
				bgTopY -= 50f;
			}
			if (bgTexIndexes[0] == 53)
			{
				bgTopY -= 100f;
			}
			if (bgTexIndexes[0] == 91)
			{
				bgTopY += 200f;
			}
			if (bgTexIndexes[0] == 173)
			{
				bgTopY += 200f;
			}
			if (bgTexIndexes[0] == 178)
			{
				bgTopY += 75f;
			}
			if (bgTexIndexes[0] == 330)
			{
				bgTopY -= 150f;
			}
			if (bgTexIndexes[0] == 335)
			{
				bgTopY -= 150f;
			}
			if (bgTexIndexes[0] == 343)
			{
				bgTopY -= 300f;
			}
			if (bgWidthScaled == 0)
			{
				return;
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				for (int i = 0; i < bgLoops; i++)
				{
					if (bgTexIndexes[0] != -1)
					{
						Asset<Texture2D> asset = TextureAssets.Background[bgTexIndexes[0]];
						int num = bgTexIndexes[0];
						if (num == 173)
						{
							int num2 = (int)(GetBackgroundCounter() / 10);
							num2 %= 4;
							int num3 = 251 + num2;
							LoadBackground(num3);
							asset = TextureAssets.Background[num3];
						}
						if (asset.Value != null)
						{
							spriteBatch.Draw(asset.Value, new Vector2(bgStartX + bgWidthScaled * i, bgTopY), GetBackgroundRect(bgTexIndexes[0]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
						}
					}
				}
			}
		}
		if (bgTexIndexes[1] >= 0)
		{
			LoadBackground(bgTexIndexes[1]);
			bgScale = 1.31f;
			bgScale *= bgGlobalScaleMultiplier;
			bgParallax = 0.43;
			SetBackgroundOffsets(bgTexIndexes[1], backgroundTopMagicNumber, pushBGTopHack);
			bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[1]] * bgScale);
			if (bgWidthScaled == 0)
			{
				bgWidthScaled = 1;
			}
			SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
			bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
			bgTopY = backgroundTopMagicNumber * 1950f + 1750f + scAdj + (float)pushBGTopHack;
			if (bgTexIndexes[1] == 329)
			{
				bgTopY = backgroundTopMagicNumber * 1900f + 1600f + scAdj + (float)pushBGTopHack;
			}
			if (bgTexIndexes[1] == 334)
			{
				bgTopY = backgroundTopMagicNumber * 1900f + 1650f + scAdj + (float)pushBGTopHack;
			}
			if (bgTexIndexes[1] == 334)
			{
				bgTopY = backgroundTopMagicNumber * 1900f + 1650f + scAdj + (float)pushBGTopHack;
			}
			if (gameMenu)
			{
				bgTopY = 400 + pushBGTopHack;
				bgStartX -= 80;
			}
			if (bgTexIndexes[1] == 51)
			{
				bgTopY -= 50f;
			}
			if (bgTexIndexes[1] == 54)
			{
				bgTopY -= 100f;
			}
			if (bgTexIndexes[1] == 329)
			{
				bgTopY -= 150f;
			}
			if (bgTexIndexes[1] == 334)
			{
				bgTopY -= 150f;
			}
			if (bgTexIndexes[1] == 342)
			{
				bgTopY -= 300f;
			}
			bgLoops = screenWidth / bgWidthScaled + 2;
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				SpriteEffects effects = ((bgTexIndexes[1] == 51 || bgTexIndexes[1] == 54) ? SpriteEffects.FlipHorizontally : SpriteEffects.None);
				for (int j = 0; j < bgLoops; j++)
				{
					spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[1]].Value, new Vector2(bgStartX + bgWidthScaled * j, bgTopY), GetBackgroundRect(bgTexIndexes[1]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, effects, 0f);
				}
			}
		}
		if (bgTexIndexes[2] < 0)
		{
			return;
		}
		LoadBackground(bgTexIndexes[2]);
		bgScale = 1.34f;
		bgScale *= bgGlobalScaleMultiplier;
		bgParallax = 0.49;
		SetBackgroundOffsets(bgTexIndexes[2], backgroundTopMagicNumber, pushBGTopHack);
		SkyManager.Instance.DrawToDepth(spriteBatch, 1f / (float)bgParallax);
		if (bgTexIndexes[0] == 91)
		{
			bgScale = 1.3f;
			bgScale *= bgGlobalScaleMultiplier;
			bgParallax = 0.42;
		}
		if (bgTexIndexes[2] < 0)
		{
			return;
		}
		bgWidthScaled = (int)((float)backgroundWidth[bgTexIndexes[2]] * bgScale);
		if (bgWidthScaled == 0)
		{
			bgWidthScaled = 1;
		}
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, bgWidthScaled) - (double)(bgWidthScaled / 2));
		bgTopY = backgroundTopMagicNumber * 2100f + 2000f + scAdj + (float)pushBGTopHack;
		if (bgTexIndexes[2] == 328)
		{
			bgTopY = backgroundTopMagicNumber * 2600f + 2300f + scAdj + (float)pushBGTopHack;
		}
		if (bgTexIndexes[2] == 333)
		{
			bgTopY = backgroundTopMagicNumber * 2800f + 2550f + scAdj + (float)pushBGTopHack;
		}
		if (gameMenu)
		{
			bgTopY = 480 + pushBGTopHack;
			bgStartX -= 120;
		}
		if (bgTexIndexes[2] == 52)
		{
			bgTopY -= 50f;
		}
		if (bgTexIndexes[2] == 55)
		{
			bgTopY -= 100f;
		}
		if (bgTexIndexes[2] == 92)
		{
			bgTopY += 150f;
		}
		if (bgTexIndexes[2] == 328)
		{
			bgTopY -= 150f;
		}
		if (bgTexIndexes[2] == 333)
		{
			bgTopY -= 150f;
		}
		if (bgTexIndexes[2] == 341)
		{
			bgTopY -= 50f;
		}
		bgLoops = screenWidth / bgWidthScaled + 2;
		if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
		{
			for (int k = 0; k < bgLoops; k++)
			{
				spriteBatch.Draw(TextureAssets.Background[bgTexIndexes[2]].Value, new Vector2(bgStartX + bgWidthScaled * k, bgTopY), GetBackgroundRect(bgTexIndexes[2]), ColorOfSurfaceBackgroundsModified, 0f, default(Vector2), bgScale, SpriteEffects.None, 0f);
			}
		}
	}

	private void DrawBackgroundBlackFill()
	{
		float value = (float)(worldSurface + 2.0) * 16f - screenPosition.Y;
		float value2 = (float)maxTilesY * 16f - 2880f - (screenPosition.Y + (float)screenHeight);
		value = MathHelper.Clamp(value, 0f, screenHeight);
		value2 = MathHelper.Clamp(value2, 0f, screenHeight);
		if (value2 - value > 0f)
		{
			spriteBatch.Draw(TextureAssets.BlackTile.Value, new Microsoft.Xna.Framework.Rectangle(0, (int)value, screenWidth, (int)(value2 - value)), Microsoft.Xna.Framework.Color.Black);
		}
	}

	public void DrawTileCracks(int crackType, HitTile hitter)
	{
		Vector2 vector = new Vector2(offScreenRange, offScreenRange);
		if (drawToScreen)
		{
			vector = Vector2.Zero;
		}
		bool flag = ShouldShowInvisibleBlocksAndWalls();
		for (int i = 0; i < hitter.data.Length; i++)
		{
			if (hitter.data[i].type != crackType)
			{
				continue;
			}
			int damage = hitter.data[i].damage;
			if (damage < 20)
			{
				continue;
			}
			int x = hitter.data[i].X;
			int y = hitter.data[i].Y;
			if (!WorldGen.InWorld(x, y))
			{
				continue;
			}
			bool flag2 = tile[x, y] != null;
			if (flag2 && crackType == 1)
			{
				flag2 = flag2 && tile[x, y].active() && (flag || !tile[x, y].invisibleBlock());
			}
			if (flag2 && crackType == 2)
			{
				flag2 = flag2 && tile[x, y].wall != 0 && (flag || !tile[x, y].invisibleWall());
			}
			if (!flag2)
			{
				continue;
			}
			bool flag3 = false;
			bool flag4 = false;
			if (tile[x, y].type == 10)
			{
				flag3 = false;
			}
			else if (tileSolid[tile[x, y].type] && !tileSolidTop[tile[x, y].type])
			{
				flag3 = true;
			}
			else if (WorldGen.IsTreeType(tile[x, y].type))
			{
				flag4 = true;
				int num = tile[x, y].frameX / 22;
				int num2 = tile[x, y].frameY / 22;
				if (num2 < 9)
				{
					flag3 = ((num != 1 && num != 2) || num2 < 6 || num2 > 8) && (num != 3 || num2 > 2) && (num != 4 || num2 < 3 || num2 > 5) && ((num != 5 || num2 < 6 || num2 > 8) ? true : false);
				}
			}
			else if (tile[x, y].type == 72)
			{
				flag4 = true;
				if (tile[x, y].frameX <= 34)
				{
					flag3 = true;
				}
			}
			if (flag3 && tile[x, y].slope() == 0 && !tile[x, y].halfBrick())
			{
				int num3 = 0;
				if (damage >= 80)
				{
					num3 = 3;
				}
				else if (damage >= 60)
				{
					num3 = 2;
				}
				else if (damage >= 40)
				{
					num3 = 1;
				}
				else if (damage >= 20)
				{
					num3 = 0;
				}
				Microsoft.Xna.Framework.Rectangle value = new Microsoft.Xna.Framework.Rectangle(hitter.data[i].crackStyle * 18, num3 * 18, 16, 16);
				if (flag4)
				{
					value.X = (4 + hitter.data[i].crackStyle / 2) * 18;
				}
				spriteBatch.Draw(TextureAssets.TileCrack.Value, new Vector2(x * 16 - (int)screenPosition.X, y * 16 - (int)screenPosition.Y) + vector, value, Lighting.GetColor(x, y), 0f, default(Vector2), 1f, SpriteEffects.None, 0f);
			}
		}
	}

	public void RainbowBoulderMusicPlayCallback(int trackIndex, int sequentialTimesPlayed)
	{
		musicFade[trackIndex] = 1f;
		_finishedRainbowBoulderStart = sequentialTimesPlayed >= 1;
		if (_finishedRainbowBoulderStart)
		{
			musicFade[trackIndex] = 0f;
			curMusic = 103;
			musicFade[curMusic] = 1f;
		}
	}

	private void GraphicsDeviceLost(object sender, EventArgs evt)
	{
	}

	protected override void Draw(GameTime gameTime)
	{
		if (!_isDrawingOrUpdating && IsGraphicsDeviceAvailable)
		{
			_isDrawingOrUpdating = true;
			DetailedFPS.Begin(DetailedFPS.OperationCategory.Draw);
			EnsureRenderTargetContent();
			DoDraw(gameTime);
			if (Main.OnPostDraw != null)
			{
				Main.OnPostDraw(gameTime);
			}
			Assets.TransferCompletedAssets();
			DetailedFPS.End();
			_isDrawingOrUpdating = false;
		}
	}

	protected override void EndDraw()
	{
		if (_isDrawingOrUpdating)
		{
			return;
		}
		if (CollectGen0EveryFrame)
		{
			NewRuntimeMethods.GC_Collect(0, GCCollectionMode.Forced, blocking: false);
		}
		bool flag = false;
		if (Program.IsMono)
		{
			flag = true;
		}
		if (FrameSkipMode == FrameSkipMode.Subtle && improvedSubtleFrameSkip)
		{
			while (true)
			{
				long num = presentTimestamp;
				presentTimestamp = Stopwatch.GetTimestamp();
				UpdateTimeAccumulator += Utils.SWTicksToTimeSpan(presentTimestamp - num).TotalSeconds;
				if (UpdateTimeAccumulator >= TARGET_FRAME_TIME * 599.0 / 600.0)
				{
					break;
				}
				DetailedFPS.Begin(DetailedFPS.OperationCategory.Idle);
				if (!flag && UpdateTimeAccumulator < TARGET_FRAME_TIME * 0.9)
				{
					flag = true;
					NewRuntimeMethods.GC_Collect(2, GCCollectionMode.Optimized, blocking: false);
				}
			}
		}
		DetailedFPS.Begin(DetailedFPS.OperationCategory.Present);
		if (FrameSkipMode == FrameSkipMode.Subtle && improvedSubtleFrameSkip && !flag && DetailedFPS.CurrentFrameTime.TotalSeconds < TARGET_FRAME_TIME * 0.9 && DetailedFPS.VsyncAppearsActive())
		{
			flag = true;
			NewRuntimeMethods.GC_Collect(2, GCCollectionMode.Optimized, blocking: false);
		}
		base.EndDraw();
		DetailedFPS.End();
		DetailedFPS.StartNextFrame();
	}

	private void DoDraw(GameTime gameTime)
	{
		if (showSplash)
		{
			TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
			DrawSplash(gameTime);
			TimeLogger.SplashDrawTime.AddTime(fromTimestamp);
			return;
		}
		TimeLogger.StartTimestamp fromTimestamp2 = TimeLogger.Start();
		int num = renderCount;
		DebugLineDraw.PreDraw();
		if (_drawCycleCounter == 0L)
		{
			TileFrameSeed = Utils.RandomNextSeed(TileFrameSeed);
		}
		_drawCycleCounter = (_drawCycleCounter + 1) % 5;
		MenuUI.IsVisible = gameMenu && menuMode == 888;
		InGameUI.IsVisible = !gameMenu && InGameUI.CurrentState != null;
		PlayerInput.UpdateMainMouse();
		imePanelAnchor = null;
		RefreshPlayerDrawOrder();
		CaptureManager.Instance.DrawTick();
		if (_resetContentThatNeedsRenderTargetsNextFrame)
		{
			ResetAllContentBasedRenderTargets();
			_resetContentThatNeedsRenderTargetsNextFrame = false;
		}
		if (!gameMenu)
		{
			TilesRenderer.PreparePaintForTilesOnScreen();
		}
		TimeLogger.StartTimestamp fromTimestamp3 = TimeLogger.Start();
		for (int i = 0; i < ContentThatNeedsRenderTargets.Count; i++)
		{
			ContentThatNeedsRenderTargets[i].PrepareRenderTarget(base.GraphicsDevice, spriteBatch);
		}
		TilePaintSystem.PrepareAllRequests();
		TimeLogger.PrepareRequests.AddTime(fromTimestamp3);
		if (loadMap)
		{
			refreshMap = false;
			MapRenderer.DrawToMap(default(Microsoft.Xna.Framework.Rectangle));
		}
		if (Lighting.UpdateEveryFrame)
		{
			drawToScreen = true;
		}
		else
		{
			drawToScreen = false;
		}
		if (drawToScreen && targetSet)
		{
			ReleaseTargets();
		}
		if (!drawToScreen && !targetSet)
		{
			InitTargets();
		}
		fpsCount++;
		if (!base.IsActive)
		{
			maxQ = true;
		}
		if (!dedServ)
		{
			UpdateDisplaySettings();
			if (Main.OnPreDraw != null)
			{
				Main.OnPreDraw(gameTime);
			}
		}
		drawsCountedForFPS++;
		if (stackSplit == 0)
		{
			timesTriedToFastStack = 0;
			stackCounter = 0;
			stackDelay = 7;
			superFastStack = 0;
		}
		else
		{
			stackCounter++;
			int num2 = 30;
			num2 = ((stackDelay == 7) ? 30 : ((stackDelay == 6) ? 25 : ((stackDelay == 5) ? 20 : ((stackDelay == 4) ? 15 : ((stackDelay != 3) ? 5 : 10)))));
			if (stackCounter >= num2)
			{
				stackDelay--;
				if (stackDelay < 2)
				{
					stackDelay = 2;
					superFastStack++;
				}
				if (timesTriedToFastStack < 10)
				{
					superFastStack = 0;
				}
				timesTriedToFastStack++;
				stackCounter = 0;
			}
		}
		if (myPlayer >= 0)
		{
			player[myPlayer].lastMouseInterface = player[myPlayer].mouseInterface;
			player[myPlayer].mouseInterface = false;
			if (LocalPlayer.spectating >= 0)
			{
				LocalPlayer.mouseInterface = true;
			}
		}
		if (mapTime > 0)
		{
			mapTime--;
		}
		if (gameMenu)
		{
			mapTime = mapTimeMax;
		}
		if (_rainbowBoulderMusicFramesCounter > 0)
		{
			AchievementsHelper.NotifyProgressionEvent(39);
			_rainbowBoulderMusicFramesCounter--;
		}
		ClearHoverItem();
		DoDraw_UpdateCameraPosition();
		Cloud.UpdateCloudParallax();
		sunCircle += 0.01f;
		if ((double)sunCircle > 6.285)
		{
			sunCircle -= 6.285f;
		}
		if (!gameMenu && !onlyDrawFancyUI)
		{
			waterfallManager.FindWaterfalls(instantBGTransitionCounter == 10);
			if (renderNow)
			{
				renderCount = 99;
				Lighting.LightTiles(GetAreaToLight());
				Lighting.LightTiles(GetAreaToLight());
				renderCount = 99;
				num = renderCount;
			}
			if (!drawToScreen)
			{
				RenderToTargets();
			}
			renderNow = false;
		}
		else if (!drawToScreen)
		{
			waterTarget.UpdateContent(delegate
			{
			});
		}
		MapUpdateQueue.Update();
		if (!loadMap)
		{
			if (!gameMenu && !WorldGen.generatingWorld)
			{
				TimeLogger.StartTimestamp fromTimestamp4 = TimeLogger.Start();
				int num3 = 0;
				int x;
				int y;
				while (fromTimestamp4.Elapsed.TotalMilliseconds < 5.0 && sectionManager.GetNextMapDraw(player[myPlayer].position, out x, out y))
				{
					if (DebugOptions.unlockMap != 0 && sectionManager.SectionLoaded(x, y))
					{
						Map.UnlockMapSection(x, y);
					}
					MapRenderer.DrawToMap_Section(x, y);
					num3++;
				}
				if (num3 == 0 && !refreshMap)
				{
					DebugOptions.unlockMap = 0;
				}
				TimeLogger.MapSectionUpdate.AddTime(fromTimestamp4);
			}
			if (updateMap.HasValue && !gamePaused)
			{
				if (refreshMap)
				{
					refreshMap = false;
					sectionManager.ClearMapDraw();
				}
				MapRenderer.DrawToMap(updateMap.Value);
				updateMap = null;
			}
			else if (MapRenderer.ChangesQueued)
			{
				MapRenderer.DrawToMap(Microsoft.Xna.Framework.Rectangle.Empty);
			}
		}
		int num4 = dayRate;
		if (num4 < 1)
		{
			num4 = 1;
		}
		float num5 = 0.0005f * (float)num4;
		if (gameMenu)
		{
			num5 *= 20f;
		}
		if (raining)
		{
			if (cloudAlpha > maxRaining)
			{
				cloudAlpha -= num5;
				if (cloudAlpha < maxRaining)
				{
					cloudAlpha = maxRaining;
				}
			}
			else if (cloudAlpha < maxRaining)
			{
				cloudAlpha += num5;
				if (cloudAlpha > maxRaining)
				{
					cloudAlpha = maxRaining;
				}
			}
		}
		else
		{
			cloudAlpha -= num5;
			if (cloudAlpha < 0f)
			{
				cloudAlpha = 0f;
			}
		}
		if (gameMenu || netMode == 2)
		{
			bgDelay = 1000;
			SceneMetrics.EvilTileCount = (int)(bgAlphaFrontLayer[1] * (float)SceneMetrics.CorruptionTileMax);
		}
		Microsoft.Xna.Framework.Color moonColor = Microsoft.Xna.Framework.Color.White;
		Microsoft.Xna.Framework.Color sunColor = Microsoft.Xna.Framework.Color.White;
		float num6 = (float)SceneMetrics.MushroomTileCount / (float)SceneMetrics.MushroomTileMax;
		float num7 = SmoothedMushroomLightInfluence;
		if (num6 > 0f)
		{
			if (num6 > num7)
			{
				num7 += 0.01f;
			}
			if (num6 < num7)
			{
				num7 -= 0.01f;
			}
		}
		else
		{
			num7 -= 0.02f;
		}
		if (num7 < 0f)
		{
			num7 = 0f;
		}
		if (num7 > 1f)
		{
			num7 = 1f;
		}
		SmoothedMushroomLightInfluence = num7;
		SetBackColor(new InfoToSetBackColor
		{
			isInGameMenuOrIsServer = (gameMenu || netMode == 2),
			CorruptionBiomeInfluence = (float)SceneMetrics.EvilTileCount / (float)SceneMetrics.CorruptionTileMax,
			CrimsonBiomeInfluence = (float)SceneMetrics.BloodTileCount / (float)SceneMetrics.CrimsonTileMax,
			JungleBiomeInfluence = (float)SceneMetrics.JungleTileCount / (float)SceneMetrics.JungleTileMax,
			MushroomBiomeInfluence = SmoothedMushroomLightInfluence,
			GraveyardInfluence = GraveyardVisualIntensity,
			BloodMoonActive = (bloodMoon || SceneMetrics.BloodMoonMonolith),
			LanternNightActive = LanternNight.LanternsUp
		}, out sunColor, out moonColor);
		ApplyColorOfTheSkiesToTiles();
		UpdateAtmosphereTransparencyToSkyColor(screenPosition.Y + (float)(screenHeight / 2));
		base.GraphicsDevice.Clear(Microsoft.Xna.Framework.Color.Black);
		base.Draw(gameTime);
		if (DebugOptions.DrawWaitInMs > 0.0)
		{
			ThreadUtilities.HighPrecisionSleep(DebugOptions.DrawWaitInMs);
		}
		float val = (float)screenWidth / (float)MaxWorldViewSize.X;
		float val2 = (float)screenHeight / (float)MaxWorldViewSize.Y;
		ForcedMinimumZoom = Math.Max(Math.Max(1f, val), val2);
		GameViewMatrix.Effects = ((!gameMenu && player[myPlayer].gravDir != 1f) ? SpriteEffects.FlipVertically : SpriteEffects.None);
		BackgroundViewMatrix.Effects = GameViewMatrix.Effects;
		BackgroundViewMatrix.Zoom = new Vector2(ForcedMinimumZoom);
		GameViewMatrix.Zoom = new Vector2(ForcedMinimumZoom * MathHelper.Clamp(GameZoomTarget, 1f, 2f));
		if (gameMenu || player[myPlayer].gravDir == 1f)
		{
			Rasterizer = RasterizerState.CullCounterClockwise;
		}
		else
		{
			Rasterizer = RasterizerState.CullClockwise;
		}
		bool flag = false;
		Filter filter = Terraria.Graphics.Effects.Filters.Scene["Sepia"];
		if (dontStarveWorld && WorldGen.generatingWorld)
		{
			if (!filter.IsActive())
			{
				Terraria.Graphics.Effects.Filters.Scene.Activate("Sepia", default(Vector2));
			}
			flag = false;
		}
		else if (flag && filter.IsActive())
		{
			Terraria.Graphics.Effects.Filters.Scene.Deactivate("Sepia");
		}
		if (filter.IsInUse())
		{
			flag = false;
		}
		bool flag2 = !(drawToScreen || netMode == 2 || flag) && !mapFullscreen && !onlyDrawFancyUI && Lighting.NotRetro && Terraria.Graphics.Effects.Filters.Scene.CanCapture();
		if (flag2)
		{
			instance.GraphicsDevice.SetRenderTarget(skyTarget);
			instance.GraphicsDevice.Clear(Microsoft.Xna.Framework.Color.Transparent);
		}
		Vector2 vector = screenPosition;
		int num8 = screenWidth;
		int num9 = screenHeight;
		PlayerInput.SetZoom_Background();
		screenPosition += BackgroundViewMatrix.Translation;
		Matrix matrix = Matrix.CreateTranslation(BackgroundViewMatrix.Translation.ToVector3()) * BackgroundViewMatrix.TransformationMatrix;
		SpriteBatchBeginner parentSpriteBatchBeginner = new SpriteBatchBeginner(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, matrix);
		bgParallax = 0.1;
		bgStartX = (int)(0.0 - Math.IEEERemainder((double)screenPosition.X * bgParallax, backgroundWidth[background]) - (double)(backgroundWidth[background] / 2));
		bgLoops = screenWidth / backgroundWidth[background] + 2;
		bgStartY = 0;
		bgLoopsY = 0;
		bgTopY = (0f - screenPosition.Y) / ((float)worldSurface * 16f - 600f) * 200f;
		if (gameMenu || netMode == 2)
		{
			bgTopY = 0f;
		}
		SceneArea sceneArea = new SceneArea
		{
			bgTopY = (int)bgTopY,
			totalHeight = screenHeight,
			totalWidth = screenWidth
		};
		if (!mapFullscreen)
		{
			if ((double)screenPosition.Y < worldSurface * 16.0 + 16.0)
			{
				TimeLogger.StartTimestamp fromTimestamp5 = TimeLogger.Start();
				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, matrix);
				Asset<Texture2D> asset = TextureAssets.Background[background];
				Microsoft.Xna.Framework.Rectangle destinationRectangle = new Microsoft.Xna.Framework.Rectangle(bgStartX, (int)bgTopY, asset.Width(), Math.Max(screenHeight, asset.Height()));
				if (destinationRectangle.Bottom < asset.Height())
				{
					int num10 = asset.Height() - destinationRectangle.Bottom;
					destinationRectangle.Height += num10;
				}
				if (false)
				{
					for (int num11 = 0; num11 < bgLoops; num11++)
					{
						destinationRectangle.X = bgStartX + asset.Width() * num11;
						spriteBatch.Draw(asset.Value, destinationRectangle, null, ColorOfTheSkies, 0f, Vector2.Zero, SpriteEffects.FlipVertically, 0f);
					}
				}
				else
				{
					for (int num12 = 0; num12 < bgLoops; num12++)
					{
						destinationRectangle.X = bgStartX + asset.Width() * num12;
						spriteBatch.Draw(asset.Value, destinationRectangle, ColorOfTheSkies);
					}
				}
				HorizonRenderer.DrawHorizon();
				spriteBatch.End();
				TimeLogger.SkyBackground.AddTime(fromTimestamp5);
			}
			TimeLogger.StartTimestamp fromTimestamp6 = TimeLogger.Start();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, matrix);
			if (shimmerAlpha != 1f)
			{
				DrawStarsInBackground(sceneArea, artificial: false);
			}
			if ((double)(screenPosition.Y / 16f) < worldSurface + 2.0)
			{
				DrawSunAndMoon(sceneArea, moonColor, sunColor, num7);
			}
			spriteBatch.End();
			TimeLogger.SunMoonStars.AddTime(fromTimestamp6);
		}
		TimeLogger.StartTimestamp fromTimestamp7 = TimeLogger.Start();
		if (flag2)
		{
			Terraria.Graphics.Effects.Filters.Scene.BeginCapture(screenTarget);
		}
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, matrix);
		Overlays.Scene.Draw(spriteBatch, RenderLayers.Sky);
		spriteBatch.End();
		parentSpriteBatchBeginner.Begin(spriteBatch);
		CurrentFrameFlags.Hacks.CurrentBackgroundMatrixForCreditsRoll = matrix;
		DrawBG(parentSpriteBatchBeginner);
		spriteBatch.End();
		screenWidth = num8;
		screenHeight = num9;
		screenPosition = vector;
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, Rasterizer, null, GameViewMatrix.TransformationMatrix);
		DrawBackgroundBlackFill();
		spriteBatch.End();
		Overlays.Scene.Draw(spriteBatch, RenderLayers.Landscape);
		TimeLogger.SurfaceBackground.AddTime(fromTimestamp7);
		if (gameMenu || netMode == 2)
		{
			TimeLogger.StartTimestamp fromTimestamp8 = TimeLogger.Start();
			DrawLensFlare();
			PreDrawMenu(out var screenSizeCache, out var screenSizeCacheAfterScaling);
			DrawMenu(gameTime);
			PostDrawMenu(screenSizeCache, screenSizeCacheAfterScaling);
			if (flag2)
			{
				base.GraphicsDevice.SetRenderTarget(null);
				HorizonHelper.UpdateSunVisibility(screenTarget);
				Terraria.Graphics.Effects.Filters.Scene.EndCapture(null, screenTarget, screenTargetSwap);
			}
			TimeLogger.MenuDrawTime.AddTime(fromTimestamp8);
			return;
		}
		if (InGameUI.CurrentState != null && onlyDrawFancyUI)
		{
			TimeLogger.StartTimestamp fromTimestamp9 = TimeLogger.Start();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, DepthStencilState.None, Rasterizer, null, UIScaleMatrix);
			InGameUI.Draw(spriteBatch, gameTime);
			DrawPendingMouseText();
			DrawCursor(DrawThickCursor());
			spriteBatch.End();
			mouseLeftRelease = !mouseLeft;
			TimeLogger.Interface.AddTime(fromTimestamp9);
			return;
		}
		onlyDrawFancyUI = false;
		Lighting.LightTiles(GetAreaToLight());
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		if (mapFullscreen)
		{
			TimeLogger.StartTimestamp fromTimestamp10 = TimeLogger.Start();
			if (player[myPlayer].talkNPC >= 0 || player[myPlayer].sign >= 0 || (playerInventory && !CaptureManager.Instance.Active))
			{
				player[myPlayer].ToggleInv();
			}
			PlayerInput.SetZoom_Unscaled();
			DrawMap(gameTime);
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerStateForCursor, null, null, null, UIScaleMatrix);
			PlayerInput.SetZoom_UI();
			DrawFPS();
			DrawPlayerChat();
			DrawPendingMouseText();
			DrawCursor(DrawThickCursor());
			PlayerInput.SetZoom_Unscaled();
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, null, null, null);
			CaptureManager.Instance.Update(CaptureInterface.SelectionContext.Map);
			if (CaptureManager.Instance.Active)
			{
				CaptureManager.Instance.Draw(spriteBatch);
			}
			spriteBatch.End();
			if (mouseLeft)
			{
				mouseLeftRelease = false;
			}
			else
			{
				mouseLeftRelease = true;
			}
			TimeLogger.DrawFullscreenMap.AddTime(fromTimestamp10);
			return;
		}
		unityMouseOver = false;
		if (shimmerAlpha > 0f)
		{
			spriteBatch.Draw(TextureAssets.MagicPixel.Value, Vector2.Zero, null, Microsoft.Xna.Framework.Color.Black * shimmerAlpha, 0f, Vector2.Zero, new Vector2(Camera.UnscaledSize.X + (float)(offScreenRange * 2), Camera.UnscaledSize.Y + (float)(offScreenRange * 2)), SpriteEffects.None, 0f);
		}
		Overlays.Scene.Draw(spriteBatch, RenderLayers.InWorldUI);
		_ = Microsoft.Xna.Framework.Color.White;
		if (drawToScreen)
		{
			DrawWaters(isBackground: true);
		}
		else
		{
			spriteBatch.Draw(backWaterTarget.Texture, backWaterTarget.Position - screenPosition, Microsoft.Xna.Framework.Color.White);
		}
		Overlays.Scene.Draw(spriteBatch, RenderLayers.BackgroundWater);
		if (shimmerAlpha > 0f)
		{
			spriteBatch.End();
			parentSpriteBatchBeginner.Begin(spriteBatch);
			DrawStarsInBackground(sceneArea, artificial: true);
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		}
		if (drawToScreen)
		{
			DrawBackground();
		}
		else
		{
			Vector2 vector2 = (backgroundTarget.Position + backgroundTarget.Texture.Size() / 2f - Camera.Center) * new Vector2(caveParallax - 1f, 0f);
			spriteBatch.Draw(backgroundTarget.Texture, backgroundTarget.Position - screenPosition + vector2, Microsoft.Xna.Framework.Color.White);
		}
		Overlays.Scene.Draw(spriteBatch, RenderLayers.Background);
		ScreenDarkness.DrawBack(spriteBatch);
		magmaBGFrameCounter++;
		if (magmaBGFrameCounter >= 8)
		{
			magmaBGFrameCounter = 0;
			magmaBGFrame++;
			if (magmaBGFrame >= 3)
			{
				magmaBGFrame = 0;
			}
		}
		PlayerInput.SetZoom_World();
		DoDraw_WallsTilesNPCs();
		Overlays.Scene.Draw(spriteBatch, RenderLayers.TilesAndNPCs);
		if (!mapFullscreen && mapStyle == 2)
		{
			try
			{
				DrawMap(gameTime);
			}
			catch (Exception e)
			{
				if (!ignoreErrors)
				{
					throw;
				}
				TimeLogger.DrawException(e);
			}
		}
		spriteBatch.End();
		HasInteractibleObjectThatIsNotATile = false;
		SortDrawCacheWorms();
		DrawSuperSpecialProjectiles(DrawCacheFirstFractals);
		DrawCachedProjs(DrawCacheProjsBehindProjectiles);
		DrawProjectiles();
		spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		ParticleSystem_World_BehindPlayers.Settings.AnchorPosition = -screenPosition;
		ParticleSystem_World_BehindPlayers.Draw(spriteBatch);
		spriteBatch.End();
		DrawPlayers_AfterProjectiles();
		DrawCachedProjs(DrawCacheProjsOverPlayers);
		spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		ParticleSystem_World_OverPlayers.Settings.AnchorPosition = -screenPosition;
		ParticleSystem_World_OverPlayers.Draw(spriteBatch);
		spriteBatch.End();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		DrawCachedNPCs(DrawCacheNPCsOverPlayers, behindTiles: false);
		if (!gamePaused)
		{
			essScale += (float)essDir * 0.01f;
			if (essScale > 1f)
			{
				essDir = -1;
				essScale = 1f;
			}
			if ((double)essScale < 0.7)
			{
				essDir = 1;
				essScale = 0.7f;
			}
		}
		DrawItems();
		DrawRain();
		if (ignoreErrors)
		{
			try
			{
				DrawGore();
			}
			catch (Exception e2)
			{
				TimeLogger.DrawException(e2);
			}
		}
		else
		{
			DrawGore();
		}
		spriteBatch.End();
		DrawDust();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		Overlays.Scene.Draw(spriteBatch, RenderLayers.Entities);
		if (drawToScreen)
		{
			DrawWaters();
			if (WiresUI.Settings.DrawWires)
			{
				DrawWires();
			}
		}
		else
		{
			spriteBatch.Draw(waterTarget.Texture, waterTarget.Position - screenPosition, Microsoft.Xna.Framework.Color.White);
			if (WiresUI.Settings.DrawWires)
			{
				DrawWires();
			}
		}
		Overlays.Scene.Draw(spriteBatch, RenderLayers.ForegroundWater);
		DrawCachedProjs(DrawCacheProjsOverWiresUI, startSpriteBatch: false);
		DrawInfernoRings();
		DrawPaladinsShield();
		spriteBatch.End();
		TimeLogger.StartTimestamp fromTimestamp11 = TimeLogger.Start();
		DrawLensFlare();
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		ScreenDarkness.DrawFront(spriteBatch);
		MoonlordDeathDrama.DrawWhite(spriteBatch);
		ScreenObstruction.Draw(spriteBatch);
		spriteBatch.End();
		Overlays.Scene.Draw(spriteBatch, RenderLayers.All);
		TimeLogger.Overlays.AddTime(fromTimestamp11);
		DebugLineDraw.World.Draw(spriteBatch);
		if (flag2)
		{
			HorizonHelper.UpdateSunVisibility(screenTarget);
			TimeLogger.StartTimestamp fromTimestamp12 = TimeLogger.Start();
			Terraria.Graphics.Effects.Filters.Scene.EndCapture(null, screenTarget, screenTargetSwap);
			TimeLogger.FiltersAndPostDraw.AddTime(fromTimestamp12);
		}
		if (!hideUI)
		{
			TimeLogger.StartTimestamp fromTimestamp13 = TimeLogger.Start();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, null, null, null, UIScaleMatrix);
			DrawPlayerChatBubbles();
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerState.LinearClamp, null, null, null, GameViewMatrix.ZoomMatrix);
			float targetScale = CombatText.TargetScale;
			for (int num13 = 0; num13 < 100; num13++)
			{
				if (!combatText[num13].active)
				{
					continue;
				}
				int num14 = 0;
				if (combatText[num13].crit)
				{
					num14 = 1;
				}
				Vector2 vector3 = FontAssets.CombatText[num14].Value.MeasureString(combatText[num13].text);
				Vector2 vector4 = new Vector2(vector3.X * 0.5f, vector3.Y * 0.5f);
				float num15 = combatText[num13].scale / targetScale;
				float num16 = (int)combatText[num13].color.R;
				float num17 = (int)combatText[num13].color.G;
				float num18 = (int)combatText[num13].color.B;
				float num19 = (int)combatText[num13].color.A;
				num16 *= num15 * combatText[num13].alpha * 0.3f;
				num18 *= num15 * combatText[num13].alpha * 0.3f;
				num17 *= num15 * combatText[num13].alpha * 0.3f;
				num19 *= num15 * combatText[num13].alpha;
				Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color((int)num16, (int)num17, (int)num18, (int)num19);
				for (int num20 = 0; num20 < 5; num20++)
				{
					float num21 = 0f;
					float num22 = 0f;
					switch (num20)
					{
					case 0:
						num21 -= targetScale;
						break;
					case 1:
						num21 += targetScale;
						break;
					case 2:
						num22 -= targetScale;
						break;
					case 3:
						num22 += targetScale;
						break;
					default:
						num16 = (float)(int)combatText[num13].color.R * num15 * combatText[num13].alpha;
						num18 = (float)(int)combatText[num13].color.B * num15 * combatText[num13].alpha;
						num17 = (float)(int)combatText[num13].color.G * num15 * combatText[num13].alpha;
						num19 = (float)(int)combatText[num13].color.A * num15 * combatText[num13].alpha;
						color = new Microsoft.Xna.Framework.Color((int)num16, (int)num17, (int)num18, (int)num19);
						break;
					}
					if (player[myPlayer].gravDir == -1f)
					{
						float num23 = combatText[num13].position.Y - screenPosition.Y;
						num23 = (float)screenHeight - num23;
						DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.CombatText[num14].Value, combatText[num13].text, new Vector2(combatText[num13].position.X - screenPosition.X + num21 + vector4.X, num23 + num22 + vector4.Y), color, combatText[num13].rotation, vector4, combatText[num13].scale, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
					}
					else
					{
						DynamicSpriteFontExtensionMethods.DrawString(spriteBatch, FontAssets.CombatText[num14].Value, combatText[num13].text, new Vector2(combatText[num13].position.X - screenPosition.X + num21 + vector4.X, combatText[num13].position.Y - screenPosition.Y + num22 + vector4.Y), color, combatText[num13].rotation, vector4, combatText[num13].scale, SpriteEffects.None, 0f, (Vector2[])null, (Microsoft.Xna.Framework.Color[])null);
					}
				}
			}
			targetScale = PopupText.TargetScale;
			if (targetScale == 0f)
			{
				targetScale = 1f;
			}
			PopupText.DrawItemTextPopups(targetScale);
			PlayerInput.SetZoom_UI();
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, SamplerStateForCursor, null, null, null, UIScaleMatrix);
			DrawNetplayStatusText();
			DrawFPS();
			spriteBatch.End();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, null, null, null, GameViewMatrix.ZoomMatrix);
			PlayerInput.SetZoom_World();
			if (BlackFadeIn > 0)
			{
				if (BlackFadeIn < 0)
				{
					BlackFadeIn = 0;
				}
				int num24 = BlackFadeIn;
				if (num24 > 255)
				{
					num24 = 255;
				}
				BlackFadeIn -= 25;
				spriteBatch.Draw(TextureAssets.SplashTexture16x9.Value, new Microsoft.Xna.Framework.Rectangle(0, 0, screenWidth, screenHeight), new Microsoft.Xna.Framework.Color(0, 0, 0, num24));
			}
			spriteBatch.End();
			if (!mapFullscreen)
			{
				if (ignoreErrors)
				{
					try
					{
						DrawInterface(gameTime);
					}
					catch (Exception e3)
					{
						TimeLogger.DrawException(e3);
					}
				}
				else
				{
					DrawInterface(gameTime);
				}
			}
			TimeLogger.Interface.AddTime(fromTimestamp13);
		}
		else
		{
			maxQ = true;
		}
		DrawIMEPanel();
		if (mouseLeft)
		{
			mouseLeftRelease = false;
		}
		else
		{
			mouseLeftRelease = true;
		}
		if (mouseRight)
		{
			mouseRightRelease = false;
		}
		else
		{
			mouseRightRelease = true;
		}
		if (!PlayerInput.Triggers.Current.MouseRight && !PlayerInput.Triggers.Current.MouseLeft && (!quickCraftStackSplit || !PlayerInput.Triggers.Current.Grapple))
		{
			stackSplit = 0;
		}
		if (stackSplit > 0)
		{
			stackSplit--;
		}
		if (stackSplit == 0)
		{
			quickCraftStackSplit = false;
		}
		if (drawDiag > 0)
		{
			showFrameRate = true;
			TimeLogger.StartTimestamp fromTimestamp14 = TimeLogger.Start();
			PlayerInput.SetZoom_Unscaled();
			spriteBatch.Begin(SpriteSortMode.Deferred, null);
			DetailedFPS.Draw();
			spriteBatch.End();
			TimeLogger.DrawFPSGraph.AddTime(fromTimestamp14);
		}
		if (drawDiag == 2)
		{
			TimeLogger.StartTimestamp fromTimestamp15 = TimeLogger.Start();
			PlayerInput.SetZoom_UI();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, null, null, null, UIScaleMatrix);
			TimeLogger.Draw();
			spriteBatch.End();
			TimeLogger.DrawTimeLogger.AddTime(fromTimestamp15);
		}
		TimeLogger.TotalDraw.AddTime(fromTimestamp2);
		if (num == 99)
		{
			TimeLogger.TotalDrawRenderNow.AddTime(fromTimestamp2);
		}
		else
		{
			TimeLogger.TotalDrawByRenderCount[num].AddTime(fromTimestamp2);
		}
	}

	private static void DrawLensFlare()
	{
		PlayerInput.SetZoom_Background();
		instance.HorizonRenderer.DrawLensFlare();
		PlayerInput.SetZoom_World();
	}

	public static void UpdateSceneMetrics()
	{
		if (CaptureManager.Instance.IsCapturing)
		{
			return;
		}
		Player perspectivePlayer = LocalPlayer;
		_usingSeparateCameraSceneMetrics = GetObjectTrackingCameraPan(out var trackedPosition, out var _, out var _);
		if (_usingSeparateCameraSceneMetrics)
		{
			LocalPlayer.UpdateSceneMetrics();
			if (LocalPlayer.spectating >= 0)
			{
				perspectivePlayer = player[LocalPlayer.spectating];
			}
		}
		else
		{
			trackedPosition = LocalPlayer.Center;
		}
		Microsoft.Xna.Framework.Rectangle areaToLight = GetAreaToLight();
		areaToLight.Inflate(28, 28);
		SceneMetrics.Scan(new SceneMetricsScanSettings
		{
			VisualScanArea = areaToLight,
			BiomeScanCenterPositionInWorld = trackedPosition,
			ScanNPCPositions = true,
			PerspectivePlayer = perspectivePlayer
		});
	}

	public static void BlackFadeCameraTeleport()
	{
		renderNow = true;
		NPC.ResetNetOffsets();
		Player.ResetNetOffsets();
		BlackFadeIn = 255;
		if (mapTime < 5)
		{
			mapTime = 5;
		}
		maxQ = true;
		Lighting.Clear();
		instantBGTransitionCounter = 10;
		UpdateSceneMetrics();
		SceneState.skipTransitions = true;
		bgDelay = 0;
		bgStyle = GetPreferredBGStyleForPlayer();
		Cloud.lastCameraCenter = null;
	}

	public static Vector2 PlayerFocusedScreenPosition()
	{
		return LocalPlayer.Bottom + new Vector2(0f, LocalPlayer.gfxOffY - 21f) + new Vector2(cameraX, cameraY) + CurrentPan - Camera.UnscaledSize * 0.5f;
	}

	public static void StartCameraTransitionForPlayerTeleport(Vector2 oldPosition, float lerp, int lerpSpeedupDelay)
	{
		if (IsCameraTrackingObject)
		{
			CurrentPan += oldPosition - LocalPlayer.position;
			return;
		}
		oldPosition += CurrentPan;
		CurrentPan = Vector2.Zero;
		if (Vector2.Distance(oldPosition, LocalPlayer.position) < BlackFadeDist)
		{
			SetCameraLerp(lerp, lerpSpeedupDelay);
			return;
		}
		BlackFadeCameraTeleport();
		screenPosition = PlayerFocusedScreenPosition();
	}

	private static void DoDraw_UpdateCameraPosition()
	{
		if (gameMenu || netMode == 2)
		{
			return;
		}
		if (cameraX != 0f && !LocalPlayer.pulley)
		{
			cameraX = 0f;
		}
		if (cameraX > 0f)
		{
			cameraX -= 1f;
			if (cameraX < 0f)
			{
				cameraX = 0f;
			}
		}
		if (cameraX < 0f)
		{
			cameraX += 1f;
			if (cameraX > 0f)
			{
				cameraX = 0f;
			}
		}
		if (cameraY > 0f)
		{
			cameraY -= 2f;
			if (cameraY < 0f)
			{
				cameraY = 0f;
			}
		}
		if (cameraY < 0f)
		{
			cameraY += 2f;
			if (cameraY > 0f)
			{
				cameraY = 0f;
			}
		}
		Vector2 value = screenPosition;
		screenPosition = PlayerFocusedScreenPosition();
		if (cameraLerp > 0f)
		{
			if (Vector2.Distance(value, screenPosition) - LocalPlayer.velocity.Length() < 0.25f)
			{
				cameraLerp = 0f;
			}
			else
			{
				screenPosition = Vector2.Lerp(value, screenPosition, cameraLerp);
			}
		}
		instance.CameraModifiers.ApplyTo(ref screenPosition);
		screenPosition.X = (int)screenPosition.X;
		screenPosition.Y = (int)screenPosition.Y;
		ClampScreenPositionToWorld();
	}

	public static void DebugCameraPan(bool left, bool right, bool up, bool down)
	{
		int num = 32;
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftShift))
		{
			num *= 2;
		}
		if (keyState.IsKeyDown(Microsoft.Xna.Framework.Input.Keys.LeftControl))
		{
			num /= 6;
		}
		if (left)
		{
			screenPosition.X -= num;
		}
		if (right)
		{
			screenPosition.X += num;
		}
		if (up)
		{
			screenPosition.Y -= num;
		}
		if (down)
		{
			screenPosition.Y += num;
		}
	}

	private static void UpdateCameraPan()
	{
		LocalPlayer.netCameraTarget = null;
		disableDontStarveDarknessDamage = false;
		if (float.IsNaN(CurrentPan.X))
		{
			CurrentPan.X = 0f;
		}
		if (float.IsNaN(CurrentPan.Y))
		{
			CurrentPan.Y = 0f;
		}
		Vector2 targetPan = Vector2.Zero;
		float maxPanSpeed = 36f;
		if (GetObjectTrackingCameraPan(out var trackedPosition, out var panRate, out var doubleRateDist))
		{
			LocalPlayer.netCameraTarget = trackedPosition;
			targetPan = trackedPosition - LocalPlayer.Center;
			float num = Vector2.Distance(CurrentPan, targetPan);
			panRate *= 1f + Utils.Clamp(num / doubleRateDist, 0f, 1f);
			maxPanSpeed = num * panRate;
			disableDontStarveDarknessDamage = true;
			CurrentPan -= LocalPlayer.velocity;
		}
		else if (GetPlayerControlledCameraPan(ref targetPan, ref maxPanSpeed))
		{
			disableDontStarveDarknessDamage = true;
		}
		if (Vector2.Distance(CurrentPan, targetPan) >= BlackFadeDist)
		{
			CurrentPan = targetPan;
			BlackFadeCameraTeleport();
		}
		else
		{
			CurrentPan = CurrentPan.MoveTowards(targetPan, maxPanSpeed);
		}
		if (LocalPlayer.netCameraTarget.HasValue != LocalPlayer.lastSyncedNetCameraTarget.HasValue || (LocalPlayer.netCameraTarget.HasValue && Vector2.Distance(LocalPlayer.lastSyncedNetCameraTarget.Value, LocalPlayer.netCameraTarget.Value) > 160f))
		{
			NetMessage.SendData(13, -1, -1, null, myPlayer);
		}
	}

	private static bool GetObjectTrackingCameraPan(out Vector2 trackedPosition, out float panRate, out float doubleRateDist)
	{
		trackedPosition = default(Vector2);
		doubleRateDist = float.MaxValue;
		panRate = 0.13f;
		if (LocalPlayer.spectating >= 0)
		{
			trackedPosition = LocalPlayer.SpectatingCameraPosition;
			doubleRateDist = 500f;
			return true;
		}
		if (LocalPlayer.dead)
		{
			return false;
		}
		if (DroneCameraTracker.TryTracking(out trackedPosition))
		{
			return true;
		}
		if (LocalGolfState.TryGetCameraTrackingPosition(out trackedPosition))
		{
			return true;
		}
		return false;
	}

	private static bool GetPlayerControlledCameraPan(ref Vector2 targetPan, ref float maxPanSpeed)
	{
		if (LocalPlayer.dead)
		{
			return false;
		}
		if ((LocalPlayer.noThrow > 0 || LocalPlayer.lastMouseInterface) && CurrentPan == Vector2.Zero)
		{
			return false;
		}
		Item item = LocalPlayer.inventory[LocalPlayer.selectedItem];
		float num = -1f;
		bool flag = true;
		bool flag2 = true;
		if (LocalPlayer.mount.Active && MountID.Sets.DontHoldItems[LocalPlayer.mount.Type])
		{
			flag2 = false;
		}
		if (flag2)
		{
			if (LocalPlayer.scope)
			{
				num = 0.5f;
			}
			if (item.type == 1254)
			{
				num = 2f / 3f;
			}
			if (item.type == 1254 && LocalPlayer.scope)
			{
				num = 0.8f;
			}
			if (item.type == 1299)
			{
				num = 2f / 3f;
				flag = false;
			}
		}
		if (num <= 0f)
		{
			return false;
		}
		int num2 = Utils.Clamp(mouseX, 0, screenWidth);
		int num3 = Utils.Clamp(mouseY, 0, screenHeight);
		Vector2 vector = new Vector2(num2, num3) / Camera.UnscaledSize * 2f - Vector2.One;
		if (PlayerInput.UsingGamepad)
		{
			if (PlayerInput.GamepadThumbstickRight.Length() == 0f && SmartCursorIsUsed)
			{
				return false;
			}
			maxPanSpeed = 48f;
		}
		else if ((flag && !mouseRight) || LocalPlayer.selectedItem == 58)
		{
			return false;
		}
		targetPan = vector * Camera.ScaledSize / 2f * num;
		return true;
	}

	public static bool IsItDay()
	{
		if (remixWorld)
		{
			return false;
		}
		return dayTime;
	}

	public static double starGameMath(double value = 1.0)
	{
		if (!starGame)
		{
			return 1.0;
		}
		double num = (double)starsHit / 200.0;
		if (num > 1.0)
		{
			num = 1.0;
		}
		return 1.0 + num * value;
	}

	private void DrawSunAndMoon(SceneArea sceneArea, Microsoft.Xna.Framework.Color moonColor, Microsoft.Xna.Framework.Color sunColor, float tempMushroomInfluence)
	{
		Texture2D value = TextureAssets.Sun.Value;
		int num = moonType;
		if (!TextureAssets.Moon.IndexInRange(num))
		{
			num = Utils.Clamp(num, 0, 8);
		}
		Texture2D value2 = TextureAssets.Moon[num].Value;
		int num2 = sceneArea.bgTopY;
		int num3 = (int)(time / 54000.0 * (double)(sceneArea.totalWidth + (float)(value.Width * 2))) - value.Width;
		int num4 = 0;
		float num5 = 1f;
		float rotation = (float)(time / 54000.0) * 2f - 7.3f;
		int num6 = (int)(time / 32400.0 * (double)(sceneArea.totalWidth + (float)(value2.Width * 2))) - value2.Width;
		int num7 = 0;
		float num8 = 1f;
		float num9 = (float)(time / 32400.0) * 2f - 7.3f;
		if (dayTime)
		{
			double num10 = Math.Pow(Math.Abs(time / 54000.0 * 2.0 - 1.0), 2.0);
			num4 = (int)((double)num2 + num10 * 250.0 + 180.0);
			num5 = (float)(1.2 - num10 * 0.4);
		}
		else
		{
			double num11 = Math.Pow(Math.Abs(time / 32400.0 * 2.0 - 1.0), 2.0);
			num7 = (int)((double)num2 + num11 * 250.0 + 180.0);
			num8 = (float)(1.2 - num11 * 0.4);
		}
		if (starGame)
		{
			if (WorldGen.generatingWorld)
			{
				alreadyGrabbingSunOrMoon = true;
				if (rand.Next(60) == 0)
				{
					for (int i = 0; i < numStars; i++)
					{
						if (star[i].hidden)
						{
							Star.SpawnStars(i);
						}
					}
				}
				if (dayTime)
				{
					dayTime = false;
					time = 0.0;
				}
			}
			else
			{
				starGame = false;
			}
		}
		else
		{
			starsHit = 0;
		}
		if (dayTime)
		{
			if ((remixWorld && !gameMenu) || WorldGen.remixWorldGen)
			{
				return;
			}
			num5 *= 1.1f;
			float num12 = 1f - tempMushroomInfluence;
			num12 -= cloudAlpha * 1.5f * atmo;
			if (num12 < 0f)
			{
				num12 = 0f;
			}
			Microsoft.Xna.Framework.Color color = new Microsoft.Xna.Framework.Color((byte)(255f * num12), (byte)((float)(int)sunColor.G * num12), (byte)((float)(int)sunColor.B * num12), (byte)(255f * num12));
			Microsoft.Xna.Framework.Color color2 = new Microsoft.Xna.Framework.Color((byte)((float)(int)sunColor.R * num12), (byte)((float)(int)sunColor.G * num12), (byte)((float)(int)sunColor.B * num12), (byte)((float)(int)sunColor.B * num12));
			if (!eclipse)
			{
				color = Microsoft.Xna.Framework.Color.White;
			}
			bool flag = false;
			bool flag2 = false;
			if (eclipse)
			{
				value = TextureAssets.Sun3.Value;
				flag = true;
			}
			else if (!gameMenu && player[myPlayer].head == 12)
			{
				value = TextureAssets.Sun2.Value;
				flag2 = true;
				flag = true;
			}
			if (flag)
			{
				color2 = new Microsoft.Xna.Framework.Color((byte)((float)(int)sunColor.R * num12), (byte)((float)(int)sunColor.G * num12), (byte)((float)(int)sunColor.B * num12), (byte)((float)(sunColor.B - 60) * num12));
			}
			Vector2 origin = value.Size() / 2f;
			Vector2 vector = new Vector2(num3, num4 + sunModY);
			spriteBatch.Draw(value, vector, null, color, rotation, origin, num5, SpriteEffects.None, 0f);
			spriteBatch.Draw(value, vector, null, color2, rotation, origin, num5, SpriteEffects.None, 0f);
			HorizonRenderer.DrawSun(vector);
			if (flag2)
			{
				Texture2D value3 = TextureAssets.Extra[280].Value;
				Microsoft.Xna.Framework.Color color3 = new Microsoft.Xna.Framework.Color(color.R, color.G, color.B, 100);
				spriteBatch.Draw(value3, vector, null, color3, rotation, origin, num5, SpriteEffects.None, 0f);
			}
		}
		if (!dayTime)
		{
			float num13 = 1f - cloudAlpha * 1.5f * atmo;
			if (num13 < 0f)
			{
				num13 = 0f;
			}
			moonColor *= num13;
			Vector2 position = new Vector2(num6, num7 + moonModY);
			if (WorldGen.drunkWorldGen)
			{
				spriteBatch.Draw(TextureAssets.SmileyMoon.Value, position, new Microsoft.Xna.Framework.Rectangle(0, 0, TextureAssets.SmileyMoon.Width(), TextureAssets.SmileyMoon.Height()), moonColor, num9 / 2f + (float)Math.PI, new Vector2(TextureAssets.SmileyMoon.Width() / 2, TextureAssets.SmileyMoon.Height() / 2), num8, SpriteEffects.None, 0f);
			}
			else if (pumpkinMoon)
			{
				spriteBatch.Draw(TextureAssets.PumpkinMoon.Value, position, new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.PumpkinMoon.Width() * moonPhase, TextureAssets.PumpkinMoon.Width(), TextureAssets.PumpkinMoon.Width()), moonColor, num9, new Vector2(TextureAssets.PumpkinMoon.Width() / 2, TextureAssets.PumpkinMoon.Width() / 2), num8, SpriteEffects.None, 0f);
			}
			else if (snowMoon)
			{
				spriteBatch.Draw(TextureAssets.SnowMoon.Value, position, new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.SnowMoon.Width() * moonPhase, TextureAssets.SnowMoon.Width(), TextureAssets.SnowMoon.Width()), moonColor, num9, new Vector2(TextureAssets.SnowMoon.Width() / 2, TextureAssets.SnowMoon.Width() / 2), num8, SpriteEffects.None, 0f);
			}
			else
			{
				spriteBatch.Draw(TextureAssets.Moon[num].Value, position, new Microsoft.Xna.Framework.Rectangle(0, TextureAssets.Moon[num].Width() * moonPhase, TextureAssets.Moon[num].Width(), TextureAssets.Moon[num].Width()), moonColor, num9, new Vector2(TextureAssets.Moon[num].Width() / 2, TextureAssets.Moon[num].Width() / 2), num8, SpriteEffects.None, 0f);
			}
		}
		Microsoft.Xna.Framework.Rectangle value4 = ((!dayTime) ? new Microsoft.Xna.Framework.Rectangle((int)((double)num6 - (double)TextureAssets.Moon[num].Width() * 0.5 * (double)num8), (int)((double)num7 - (double)TextureAssets.Moon[num].Width() * 0.5 * (double)num8 + (double)moonModY), (int)((float)TextureAssets.Moon[num].Width() * num8), (int)((float)TextureAssets.Moon[num].Width() * num8)) : new Microsoft.Xna.Framework.Rectangle((int)((double)num3 - (double)TextureAssets.Sun.Width() * 0.5 * (double)num5), (int)((double)num4 - (double)TextureAssets.Sun.Height() * 0.5 * (double)num5 + (double)sunModY), (int)((float)TextureAssets.Sun.Width() * num5), (int)((float)TextureAssets.Sun.Width() * num5)));
		Microsoft.Xna.Framework.Rectangle rectangle = new Microsoft.Xna.Framework.Rectangle(mouseX, mouseY, 1, 1);
		sunModY = (short)((double)sunModY * 0.999);
		moonModY = (short)((double)moonModY * 0.999);
		if (gameMenu && netMode != 1)
		{
			if (rectangle.Intersects(value4) || alreadyGrabbingSunOrMoon)
			{
				player[myPlayer].mouseInterface = true;
			}
			if ((mouseLeft || starGame) && hasFocus)
			{
				if (rectangle.Intersects(value4) || alreadyGrabbingSunOrMoon)
				{
					if (dayTime)
					{
						time = 54000.0 * (double)((float)(mouseX + TextureAssets.Sun.Width()) / ((float)screenWidth + (float)(TextureAssets.Sun.Width() * 2)));
						sunModY = (short)(mouseY - num4);
						if (time > 53990.0)
						{
							time = 53990.0;
						}
					}
					else
					{
						time = 32400.0 * (double)((float)(mouseX + TextureAssets.Moon[num].Width()) / ((float)screenWidth + (float)(TextureAssets.Moon[num].Width() * 2)));
						moonModY = (short)(mouseY - num7);
						if (time > 32390.0)
						{
							time = 32390.0;
						}
					}
					if (time < 10.0)
					{
						time = 10.0;
					}
					alreadyGrabbingSunOrMoon = true;
					AchievementsHelper.DoClassicTitleScreenAchievement();
				}
			}
			else
			{
				alreadyGrabbingSunOrMoon = false;
			}
		}
		LastCelestialBodyPosition = (dayTime ? new Vector2(num3, num4 + sunModY) : new Vector2(num6, num7 + moonModY));
		LastCelestialBodyPosition /= ScreenSize.ToVector2();
	}

	private void DrawStarsInBackground(SceneArea sceneArea, bool artificial)
	{
		if (netMode == 2)
		{
			return;
		}
		float num = 1f;
		if (GraveyardVisualIntensity > 0f)
		{
			float num2 = 1f - GraveyardVisualIntensity * 1.4f;
			if (num2 <= 0f)
			{
				return;
			}
			num *= num2;
		}
		Microsoft.Xna.Framework.Color colorOfTheSkies = ColorOfTheSkies;
		if (shimmerAlpha > 0f)
		{
			colorOfTheSkies *= 1f - shimmerAlpha;
		}
		if (remixWorld || !(255f * (1f - cloudAlpha * atmo) - (float)(int)colorOfTheSkies.R - 25f <= 0f))
		{
			for (int i = 0; i < numStars; i++)
			{
				DrawStar(ref sceneArea, num, colorOfTheSkies, i, star[i], artificial);
			}
		}
	}

	private void DrawStar(ref SceneArea sceneArea, float starOpacity, Microsoft.Xna.Framework.Color bgColorForStars, int i, Star theStar, bool artificial)
	{
		if (theStar == null || theStar.hidden)
		{
			return;
		}
		float num = shimmerAlpha;
		Microsoft.Xna.Framework.Color color = default(Microsoft.Xna.Framework.Color);
		float num2 = 1f - theStar.fadeIn;
		int num3 = (int)((float)(255 - bgColorForStars.R - 100) * theStar.twinkle * num2);
		int num4 = (int)((float)(255 - bgColorForStars.G - 100) * theStar.twinkle * num2);
		int num5 = (int)((float)(255 - bgColorForStars.B - 100) * theStar.twinkle * num2);
		num3 = (num3 + num5 + num4) / 3;
		if (num3 <= 0)
		{
			return;
		}
		num3 = (int)((double)num3 * 1.4);
		if (num3 > 255)
		{
			num3 = 255;
		}
		num4 = num3;
		num5 = num3;
		color.R = (byte)num3;
		color.G = (byte)num4;
		color.B = (byte)num5;
		color *= starOpacity;
		if (num > 0f)
		{
			Microsoft.Xna.Framework.Color value = color;
			if (i % 3 == 0)
			{
				value.G = (byte)((float)(int)color.G * (1f - num * 0f) * theStar.twinkle * theStar.twinkle);
			}
			else if (i % 3 == 1)
			{
				value.B = (byte)((float)(int)color.B * (1f - num * 0f) * theStar.twinkle * theStar.twinkle);
			}
			else if (i % 3 == 2)
			{
				value.R = (byte)((float)(int)color.R * (1f - num * 0f) * theStar.twinkle * theStar.twinkle);
			}
			color = Microsoft.Xna.Framework.Color.Lerp(color, value, num);
			if (artificial)
			{
				color *= num;
			}
			else
			{
				color *= 1f - num;
			}
		}
		Vector2 vector = new Vector2(theStar.position.X / 1920f, theStar.position.Y / 1200f);
		int num6 = sceneArea.bgTopY;
		if (worldSurface <= 30.0)
		{
			num6 = 0;
		}
		Vector2 vector2 = vector * new Vector2(sceneArea.totalWidth, sceneArea.totalHeight) + new Vector2(0f, num6);
		if (!theStar.falling)
		{
			if (vector2.X < 0f)
			{
				vector2.X += sceneArea.totalWidth;
			}
			if (vector2.X > sceneArea.totalWidth)
			{
				vector2.X -= sceneArea.totalWidth;
			}
			if (vector2.Y < 0f)
			{
				vector2.Y += sceneArea.totalHeight;
			}
			if (vector2.Y > sceneArea.totalHeight)
			{
				vector2.Y -= sceneArea.totalHeight;
			}
		}
		Texture2D value2 = TextureAssets.Star[theStar.type].Value;
		Vector2 origin = value2.Size() / 2f;
		if (theStar.falling)
		{
			theStar.fadeIn = 0f;
			int num7 = theStar.fallTime;
			float num8 = 30f;
			if ((float)num7 > num8)
			{
				num7 = (int)num8;
			}
			for (int j = 1; j < num7; j++)
			{
				Vector2 vector3 = theStar.fallSpeed * j * 0.4f;
				float num9 = theStar.scale * (1f - (float)j * 1f / num8);
				Microsoft.Xna.Framework.Color color2 = color;
				_ = theStar.rotation;
				color2 *= 1f - (float)j * 1f / num8;
				spriteBatch.Draw(value2, vector2 - vector3, null, color2, theStar.rotation, origin, num9 * theStar.twinkle, SpriteEffects.None, 0f);
			}
			if (starGame && theStar.fallSpeed.Y > 0f && Vector2.Distance(new Vector2(mouseX, mouseY), vector2) < 70f)
			{
				starsHit++;
				theStar.fallSpeed = vector2 - new Vector2(mouseX, mouseY);
				theStar.fallSpeed.Normalize();
				theStar.fallSpeed *= 10f;
				if (theStar.fallSpeed.Y > 0f)
				{
					theStar.fallSpeed.Y *= -1f;
				}
				SoundEngine.PlaySound(38);
				SoundEngine.PlaySound(37);
			}
		}
		spriteBatch.Draw(value2, vector2, null, color, theStar.rotation, origin, theStar.scale * theStar.twinkle, SpriteEffects.None, 0f);
	}

	private static void ApplyColorOfTheSkiesToTiles()
	{
		Microsoft.Xna.Framework.Color colorOfTheSkies = ColorOfTheSkies;
		tileColor.A = byte.MaxValue;
		tileColor.R = (byte)((colorOfTheSkies.R + colorOfTheSkies.G + colorOfTheSkies.B + colorOfTheSkies.R * 7) / 10);
		tileColor.G = (byte)((colorOfTheSkies.R + colorOfTheSkies.G + colorOfTheSkies.B + colorOfTheSkies.G * 7) / 10);
		tileColor.B = (byte)((colorOfTheSkies.R + colorOfTheSkies.G + colorOfTheSkies.B + colorOfTheSkies.B * 7) / 10);
		tileColor = SkyManager.Instance.ProcessTileColor(tileColor);
	}

	private static void UpdateAtmosphereTransparencyToSkyColor(float y)
	{
		float num = (float)maxTilesX / 4200f;
		num *= num;
		atmo = (float)((double)(y / 16f - (65f + 10f * num)) / (worldSurface / 5.0));
		if (atmo < 0f)
		{
			atmo = 0f;
		}
		if (atmo > 1f)
		{
			atmo = 1f;
		}
		if (gameMenu || netMode == 2)
		{
			atmo = 1f;
		}
		Microsoft.Xna.Framework.Color colorOfTheSkies = ColorOfTheSkies;
		colorOfTheSkies.R = (byte)((float)(int)colorOfTheSkies.R * atmo);
		colorOfTheSkies.G = (byte)((float)(int)colorOfTheSkies.G * atmo);
		colorOfTheSkies.B = (byte)((float)(int)colorOfTheSkies.B * atmo);
		if ((double)atmo <= 0.01)
		{
			colorOfTheSkies = Microsoft.Xna.Framework.Color.Black;
		}
		ColorOfTheSkies = colorOfTheSkies;
	}

	private void Debug_PrettifyMap()
	{
	}

	private static void DrawNetplayStatusText()
	{
		if (netMode == 1 && !string.IsNullOrWhiteSpace(Netplay.Connection.StatusText))
		{
			string text = Netplay.Connection.StatusText;
			if (!Netplay.Connection.HideStatusTextPercent)
			{
				text = text + ": " + (int)((float)Netplay.Connection.StatusCount / (float)Netplay.Connection.StatusMax * 100f) + "%";
			}
			if (_netplayStatusTextSnippets == null || _oldNetplayStatusText != text)
			{
				_netplayStatusTextSnippets = ChatManager.ParseMessage(text, Microsoft.Xna.Framework.Color.White).ToArray();
				_oldNetplayStatusText = text;
			}
			Vector2 position = new Vector2(628f - ChatManager.GetStringSize(FontAssets.MouseText.Value, _netplayStatusTextSnippets, Vector2.One).X * 0.5f + (float)(screenWidth - 800), 84f);
			int hoveredSnippet;
			if (Netplay.Connection.StatusTextHasShadows)
			{
				ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, _netplayStatusTextSnippets, position, 0f, Vector2.Zero, Vector2.One, out hoveredSnippet);
			}
			else
			{
				ChatManager.DrawColorCodedString(spriteBatch, FontAssets.MouseText.Value, _netplayStatusTextSnippets, position, 0f, Vector2.Zero, Vector2.One, out hoveredSnippet);
			}
		}
	}

	public static Vector2 GetChatDrawPosition(Player player)
	{
		return (((LocalPlayer.gravDir == 1f) ? player.Top : player.Bottom) + player.netOffset + new Vector2(0f, player.gfxOffY)).ToScreenPosition() + new Vector2(0f, -2f);
	}

	private void DrawPlayerChatBubbles()
	{
		for (int i = 0; i < 255; i++)
		{
			Player player = Main.player[i];
			if (player.active && player.chatOverhead.timeLeft > 0 && (!player.dead || player.ghost))
			{
				Vector2 messageSize = player.chatOverhead.messageSize;
				Vector2 chatDrawPosition = GetChatDrawPosition(player);
				chatDrawPosition.Y -= messageSize.Y / 2f;
				chatDrawPosition -= messageSize / 2f;
				chatDrawPosition = chatDrawPosition.Floor();
				int hoveredSnippet = 0;
				ChatManager.DrawColorCodedStringWithShadow(spriteBatch, FontAssets.MouseText.Value, player.chatOverhead.snippets, chatDrawPosition, player.chatOverhead.color, 0f, Vector2.Zero, Vector2.One, out hoveredSnippet);
			}
		}
	}

	private void DrawRainInMenu()
	{
		bool isActive = base.IsActive;
		Microsoft.Xna.Framework.Rectangle[] array = new Microsoft.Xna.Framework.Rectangle[6];
		for (int i = 0; i < array.Length; i++)
		{
			array[i] = new Microsoft.Xna.Framework.Rectangle(i * 4, 0, 2, 40);
		}
		Microsoft.Xna.Framework.Color color = ColorOfTheSkies * 0.85f;
		for (int j = 0; j < maxRain; j++)
		{
			if (Main.rain[j].active)
			{
				Rain rain = Main.rain[j];
				spriteBatch.Draw(TextureAssets.Rain.Value, rain.position - screenPosition, array[rain.type], color, rain.rotation, Vector2.Zero, rain.scale, SpriteEffects.None, 0f);
				if (isActive)
				{
					rain.Update();
				}
			}
		}
	}

	private void DoDraw_WallsTilesNPCs()
	{
		try
		{
			CacheNPCDraws();
			CacheProjDraws();
			DrawCachedNPCs(DrawCacheNPCsMoonMoon, behindTiles: true);
			DoDraw_WallsAndBlacks();
			TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
			DrawWoF();
			DrawBackGore();
			MoonlordDeathDrama.DrawPieces(spriteBatch);
			MoonlordDeathDrama.DrawExplosions(spriteBatch);
			TimeLogger.NPCs.AddTime(fromTimestamp);
			DrawCachedNPCs(DrawCacheNPCsBehindNonSolidTiles, behindTiles: true);
			DoDraw_Tiles_NonSolid();
			DoDraw_Waterfalls();
		}
		catch (Exception e)
		{
			TimeLogger.DrawException(e);
		}
		spriteBatch.End();
		try
		{
			bool detectCreature = player[myPlayer].detectCreature;
			if (!detectCreature)
			{
				DoDraw_DrawNPCsBehindTiles();
			}
			DoDraw_Tiles_Solid();
			if (detectCreature)
			{
				DoDraw_DrawNPCsBehindTiles();
			}
			DrawPlayers_BehindNPCs();
			DoDraw_DrawNPCsOverTiles();
		}
		catch (Exception e2)
		{
			TimeLogger.DrawException(e2);
		}
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
	}

	private void DoDraw_Waterfalls()
	{
		if (!DebugOptions.hideWater)
		{
			TimeLogger.StartTimestamp fromTimestamp = TimeLogger.Start();
			tileBatch.Begin(Rasterizer, Transform);
			waterfallManager.Draw();
			tileBatch.End();
			TimeLogger.Waterfalls.AddTime(fromTimestamp);
		}
	}

	private void DoDraw_Tiles_Solid()
	{
		TilesRenderer.PreDrawTiles(solidLayer: true);
		try
		{
			if (drawToScreen)
			{
				DrawTiles(solidLayer: true);
			}
			else
			{
				spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
				spriteBatch.Draw(tileTarget.Texture, tileTarget.Position - screenPosition, Microsoft.Xna.Framework.Color.White);
				spriteBatch.End();
			}
		}
		catch (Exception e)
		{
			TimeLogger.DrawException(e);
		}
		if (!DebugOptions.hideTiles)
		{
			DrawTileEntities(solidLayer: true);
		}
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		try
		{
			player[myPlayer].hitReplace.DrawFreshAnimations(spriteBatch);
			player[myPlayer].hitTile.DrawFreshAnimations(spriteBatch);
		}
		catch (Exception e2)
		{
			TimeLogger.DrawException(e2);
		}
		spriteBatch.End();
	}

	private void DoDraw_Tiles_NonSolid()
	{
		TilesRenderer.PreDrawTiles(solidLayer: false);
		if (drawToScreen)
		{
			spriteBatch.End();
			DrawTiles(solidLayer: false);
		}
		else
		{
			spriteBatch.Draw(tile2Target.Texture, tile2Target.Position - screenPosition, Microsoft.Xna.Framework.Color.White);
			spriteBatch.End();
		}
		try
		{
			if (!DebugOptions.hideTiles2)
			{
				DrawTileEntities(solidLayer: false);
			}
		}
		catch (Exception e)
		{
			TimeLogger.DrawException(e);
		}
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
	}

	private void DoDraw_DrawNPCsOverTiles()
	{
		DrawCachedProjs(DrawCacheProjsBehindNPCs);
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		try
		{
			DrawNPCs();
			DrawCachedNPCs(DrawCacheNPCProjectiles, behindTiles: false);
		}
		catch (Exception e)
		{
			TimeLogger.DrawException(e);
		}
		spriteBatch.End();
	}

	private void DoDraw_DrawNPCsBehindTiles()
	{
		DrawCachedProjs(DrawCacheProjsBehindNPCsAndTiles);
		spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		try
		{
			DrawNPCs(behindTiles: true);
		}
		catch (Exception e)
		{
			TimeLogger.DrawException(e);
		}
		spriteBatch.End();
	}

	private void DrawBackGore()
	{
		if (!drawBackGore)
		{
			return;
		}
		drawBackGore = false;
		if (ignoreErrors)
		{
			try
			{
				DrawGoreBehind();
				return;
			}
			catch (Exception e)
			{
				TimeLogger.DrawException(e);
				return;
			}
		}
		DrawGoreBehind();
	}

	private void DoDraw_WallsAndBlacks()
	{
		if (drawToScreen)
		{
			spriteBatch.End();
			DrawBlack();
			DrawWalls();
			spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.AlphaBlend, DefaultSamplerState, DepthStencilState.None, Rasterizer, null, Transform);
		}
		else
		{
			spriteBatch.Draw(wallTarget.Texture, wallTarget.Position - screenPosition, Microsoft.Xna.Framework.Color.White);
		}
		Overlays.Scene.Draw(spriteBatch, RenderLayers.Walls);
	}

	private static void SetBackColor(InfoToSetBackColor info, out Microsoft.Xna.Framework.Color sunColor, out Microsoft.Xna.Framework.Color moonColor)
	{
		double num = time;
		Microsoft.Xna.Framework.Color bgColorToSet = Microsoft.Xna.Framework.Color.White;
		sunColor = Microsoft.Xna.Framework.Color.White;
		moonColor = Microsoft.Xna.Framework.Color.White;
		float num2 = 0f;
		bool isInGameMenuOrIsServer = info.isInGameMenuOrIsServer;
		if (dayTime)
		{
			if (num < 13500.0)
			{
				num2 = (float)(num / 13500.0);
				sunColor.R = (byte)(num2 * 200f + 55f);
				sunColor.G = (byte)(num2 * 180f + 75f);
				sunColor.B = (byte)(num2 * 250f + 5f);
				bgColorToSet.R = (byte)(num2 * 230f + 25f);
				bgColorToSet.G = (byte)(num2 * 220f + 35f);
				bgColorToSet.B = (byte)(num2 * 220f + 35f);
			}
			if (num > 45900.0)
			{
				num2 = (float)(1.0 - (num / 54000.0 - 0.85) * 6.666666666666667);
				sunColor.R = (byte)(num2 * 120f + 55f);
				sunColor.G = (byte)(num2 * 100f + 25f);
				sunColor.B = (byte)(num2 * 120f + 55f);
				bgColorToSet.R = (byte)(num2 * 200f + 35f);
				bgColorToSet.G = (byte)(num2 * 85f + 35f);
				bgColorToSet.B = (byte)(num2 * 135f + 35f);
			}
			else if (num > 37800.0)
			{
				num2 = (float)(1.0 - (num / 54000.0 - 0.7) * 6.666666666666667);
				sunColor.R = (byte)(num2 * 80f + 175f);
				sunColor.G = (byte)(num2 * 130f + 125f);
				sunColor.B = (byte)(num2 * 100f + 155f);
				bgColorToSet.R = (byte)(num2 * 20f + 235f);
				bgColorToSet.G = (byte)(num2 * 135f + 120f);
				bgColorToSet.B = (byte)(num2 * 85f + 170f);
			}
		}
		if (!dayTime)
		{
			if (info.BloodMoonActive)
			{
				if (num < 16200.0)
				{
					num2 = (float)(1.0 - num / 16200.0);
					moonColor.R = (byte)(num2 * 10f + 205f);
					moonColor.G = (byte)(num2 * 170f + 55f);
					moonColor.B = (byte)(num2 * 200f + 55f);
					bgColorToSet.R = (byte)(40f - num2 * 40f + 35f);
					bgColorToSet.G = (byte)(num2 * 20f + 15f);
					bgColorToSet.B = (byte)(num2 * 20f + 15f);
				}
				else if (num >= 16200.0)
				{
					num2 = (float)((num / 32400.0 - 0.5) * 2.0);
					moonColor.R = (byte)(num2 * 50f + 205f);
					moonColor.G = (byte)(num2 * 100f + 155f);
					moonColor.B = (byte)(num2 * 100f + 155f);
					moonColor.R = (byte)(num2 * 10f + 205f);
					moonColor.G = (byte)(num2 * 170f + 55f);
					moonColor.B = (byte)(num2 * 200f + 55f);
					bgColorToSet.R = (byte)(40f - num2 * 40f + 35f);
					bgColorToSet.G = (byte)(num2 * 20f + 15f);
					bgColorToSet.B = (byte)(num2 * 20f + 15f);
				}
			}
			else if (num < 16200.0)
			{
				num2 = (float)(1.0 - num / 16200.0);
				moonColor.R = (byte)(num2 * 10f + 205f);
				moonColor.G = (byte)(num2 * 70f + 155f);
				moonColor.B = (byte)(num2 * 100f + 155f);
				bgColorToSet.R = (byte)(num2 * 30f + 5f);
				bgColorToSet.G = (byte)(num2 * 30f + 5f);
				bgColorToSet.B = (byte)(num2 * 30f + 5f);
			}
			else if (num >= 16200.0)
			{
				num2 = (float)((num / 32400.0 - 0.5) * 2.0);
				moonColor.R = (byte)(num2 * 50f + 205f);
				moonColor.G = (byte)(num2 * 100f + 155f);
				moonColor.B = (byte)(num2 * 100f + 155f);
				bgColorToSet.R = (byte)(num2 * 20f + 5f);
				bgColorToSet.G = (byte)(num2 * 30f + 5f);
				bgColorToSet.B = (byte)(num2 * 30f + 5f);
			}
			if (dontStarveWorld)
			{
				DontStarveSeed.ModifyNightColor(ref bgColorToSet, ref moonColor);
			}
		}
		if (cloudAlpha > 0f && !remixWorld)
		{
			float num3 = 1f - cloudAlpha * 0.9f * atmo;
			bgColorToSet.R = (byte)((float)(int)bgColorToSet.R * num3);
			bgColorToSet.G = (byte)((float)(int)bgColorToSet.G * num3);
			bgColorToSet.B = (byte)((float)(int)bgColorToSet.B * num3);
		}
		if (info.GraveyardInfluence > 0f && !remixWorld)
		{
			float num4 = 1f - info.GraveyardInfluence * 0.6f;
			bgColorToSet.R = (byte)((float)(int)bgColorToSet.R * num4);
			bgColorToSet.G = (byte)((float)(int)bgColorToSet.G * num4);
			bgColorToSet.B = (byte)((float)(int)bgColorToSet.B * num4);
		}
		if (isInGameMenuOrIsServer && !dayTime)
		{
			bgColorToSet.R = 35;
			bgColorToSet.G = 35;
			bgColorToSet.B = 35;
		}
		if (info.CorruptionBiomeInfluence > 0f)
		{
			float num5 = info.CorruptionBiomeInfluence;
			if (num5 > 1f)
			{
				num5 = 1f;
			}
			int r = bgColorToSet.R;
			int g = bgColorToSet.G;
			int b = bgColorToSet.B;
			r -= (int)(90f * num5 * ((float)(int)bgColorToSet.R / 255f));
			g -= (int)(140f * num5 * ((float)(int)bgColorToSet.G / 255f));
			b -= (int)(70f * num5 * ((float)(int)bgColorToSet.B / 255f));
			if (r < 15)
			{
				r = 15;
			}
			if (g < 15)
			{
				g = 15;
			}
			if (b < 15)
			{
				b = 15;
			}
			DontStarveSeed.FixBiomeDarkness(ref bgColorToSet, ref r, ref g, ref b);
			bgColorToSet.R = (byte)r;
			bgColorToSet.G = (byte)g;
			bgColorToSet.B = (byte)b;
			r = sunColor.R;
			g = sunColor.G;
			b = sunColor.B;
			r -= (int)(100f * num5 * ((float)(int)sunColor.R / 255f));
			g -= (int)(100f * num5 * ((float)(int)sunColor.G / 255f));
			b -= (int)(0f * num5 * ((float)(int)sunColor.B / 255f));
			if (r < 15)
			{
				r = 15;
			}
			if (g < 15)
			{
				g = 15;
			}
			if (b < 15)
			{
				b = 15;
			}
			sunColor.R = (byte)r;
			sunColor.G = (byte)g;
			sunColor.B = (byte)b;
		}
		if (info.CrimsonBiomeInfluence > 0f)
		{
			float num6 = info.CrimsonBiomeInfluence;
			if (num6 > 1f)
			{
				num6 = 1f;
			}
			int r2 = bgColorToSet.R;
			int g2 = bgColorToSet.G;
			int b2 = bgColorToSet.B;
			r2 -= (int)(40f * num6 * ((float)(int)bgColorToSet.G / 255f));
			g2 -= (int)(110f * num6 * ((float)(int)bgColorToSet.G / 255f));
			b2 -= (int)(140f * num6 * ((float)(int)bgColorToSet.B / 255f));
			if (r2 < 15)
			{
				r2 = 15;
			}
			if (g2 < 15)
			{
				g2 = 15;
			}
			if (b2 < 15)
			{
				b2 = 15;
			}
			DontStarveSeed.FixBiomeDarkness(ref bgColorToSet, ref r2, ref g2, ref b2);
			bgColorToSet.R = (byte)r2;
			bgColorToSet.G = (byte)g2;
			bgColorToSet.B = (byte)b2;
			r2 = sunColor.R;
			g2 = sunColor.G;
			b2 = sunColor.B;
			g2 -= (int)(90f * num6 * ((float)(int)sunColor.G / 255f));
			b2 -= (int)(110f * num6 * ((float)(int)sunColor.B / 255f));
			if (r2 < 15)
			{
				r2 = 15;
			}
			if (g2 < 15)
			{
				g2 = 15;
			}
			if (b2 < 15)
			{
				b2 = 15;
			}
			sunColor.R = (byte)r2;
			sunColor.G = (byte)g2;
			sunColor.B = (byte)b2;
		}
		if (info.JungleBiomeInfluence > 0f)
		{
			float num7 = info.JungleBiomeInfluence;
			if (num7 > 1f)
			{
				num7 = 1f;
			}
			int r3 = bgColorToSet.R;
			int G = bgColorToSet.G;
			int b3 = bgColorToSet.B;
			r3 -= (int)(40f * num7 * ((float)(int)bgColorToSet.R / 255f));
			b3 -= (int)(70f * num7 * ((float)(int)bgColorToSet.B / 255f));
			if (G > 255)
			{
				G = 255;
			}
			if (G < 15)
			{
				G = 15;
			}
			if (r3 > 255)
			{
				r3 = 255;
			}
			if (r3 < 15)
			{
				r3 = 15;
			}
			if (b3 < 15)
			{
				b3 = 15;
			}
			DontStarveSeed.FixBiomeDarkness(ref bgColorToSet, ref r3, ref G, ref b3);
			bgColorToSet.R = (byte)r3;
			bgColorToSet.G = (byte)G;
			bgColorToSet.B = (byte)b3;
			r3 = sunColor.R;
			G = sunColor.G;
			b3 = sunColor.B;
			r3 -= (int)(30f * num7 * ((float)(int)sunColor.R / 255f));
			b3 -= (int)(10f * num7 * ((float)(int)sunColor.B / 255f));
			if (r3 < 15)
			{
				r3 = 15;
			}
			if (G < 15)
			{
				G = 15;
			}
			if (b3 < 15)
			{
				b3 = 15;
			}
			sunColor.R = (byte)r3;
			sunColor.G = (byte)G;
			sunColor.B = (byte)b3;
		}
		if (info.MushroomBiomeInfluence > 0f)
		{
			float mushroomBiomeInfluence = info.MushroomBiomeInfluence;
			int r4 = bgColorToSet.R;
			int g3 = bgColorToSet.G;
			int b4 = bgColorToSet.B;
			g3 -= (int)(250f * mushroomBiomeInfluence * ((float)(int)bgColorToSet.G / 255f));
			r4 -= (int)(250f * mushroomBiomeInfluence * ((float)(int)bgColorToSet.R / 255f));
			b4 -= (int)(250f * mushroomBiomeInfluence * ((float)(int)bgColorToSet.B / 255f));
			if (g3 < 15)
			{
				g3 = 15;
			}
			if (r4 < 15)
			{
				r4 = 15;
			}
			if (b4 < 15)
			{
				b4 = 15;
			}
			DontStarveSeed.FixBiomeDarkness(ref bgColorToSet, ref r4, ref g3, ref b4);
			bgColorToSet.R = (byte)r4;
			bgColorToSet.G = (byte)g3;
			bgColorToSet.B = (byte)b4;
			r4 = sunColor.R;
			g3 = sunColor.G;
			b4 = sunColor.B;
			g3 -= (int)(10f * mushroomBiomeInfluence * ((float)(int)sunColor.G / 255f));
			r4 -= (int)(30f * mushroomBiomeInfluence * ((float)(int)sunColor.R / 255f));
			b4 -= (int)(10f * mushroomBiomeInfluence * ((float)(int)sunColor.B / 255f));
			if (r4 < 15)
			{
				r4 = 15;
			}
			if (g3 < 15)
			{
				g3 = 15;
			}
			if (b4 < 15)
			{
				b4 = 15;
			}
			sunColor.R = (byte)r4;
			sunColor.G = (byte)g3;
			sunColor.B = (byte)b4;
			r4 = moonColor.R;
			g3 = moonColor.G;
			b4 = moonColor.B;
			g3 -= (int)(140f * mushroomBiomeInfluence * ((float)(int)moonColor.R / 255f));
			r4 -= (int)(170f * mushroomBiomeInfluence * ((float)(int)moonColor.G / 255f));
			b4 -= (int)(190f * mushroomBiomeInfluence * ((float)(int)moonColor.B / 255f));
			if (r4 < 15)
			{
				r4 = 15;
			}
			if (g3 < 15)
			{
				g3 = 15;
			}
			if (b4 < 15)
			{
				b4 = 15;
			}
			moonColor.R = (byte)r4;
			moonColor.G = (byte)g3;
			moonColor.B = (byte)b4;
		}
		byte minimalLight = 15;
		switch (GetMoonPhase())
		{
		case MoonPhase.Empty:
			minimalLight = 11;
			break;
		case MoonPhase.QuarterAtLeft:
		case MoonPhase.QuarterAtRight:
			minimalLight = 13;
			break;
		case MoonPhase.HalfAtLeft:
		case MoonPhase.HalfAtRight:
			minimalLight = 15;
			break;
		case MoonPhase.ThreeQuartersAtLeft:
		case MoonPhase.ThreeQuartersAtRight:
			minimalLight = 17;
			break;
		case MoonPhase.Full:
			minimalLight = 19;
			break;
		}
		if (dontStarveWorld)
		{
			DontStarveSeed.ModifyMinimumLightColorAtNight(ref minimalLight);
		}
		if (bgColorToSet.R < minimalLight)
		{
			bgColorToSet.R = minimalLight;
		}
		if (bgColorToSet.G < minimalLight)
		{
			bgColorToSet.G = minimalLight;
		}
		if (bgColorToSet.B < minimalLight)
		{
			bgColorToSet.B = minimalLight;
		}
		if (info.BloodMoonActive)
		{
			if (bgColorToSet.R < 25)
			{
				bgColorToSet.R = 25;
			}
			if (bgColorToSet.G < 25)
			{
				bgColorToSet.G = 25;
			}
			if (bgColorToSet.B < 25)
			{
				bgColorToSet.B = 25;
			}
		}
		if (eclipse && dayTime)
		{
			float num8 = 1242f;
			eclipseLight = (float)(num / (double)num8);
			if (eclipseLight > 1f)
			{
				eclipseLight = 1f;
			}
		}
		else if (eclipseLight > 0f)
		{
			eclipseLight -= 0.01f;
			if (eclipseLight < 0f)
			{
				eclipseLight = 0f;
			}
		}
		if (eclipseLight > 0f)
		{
			float num9 = 1f - 0.925f * eclipseLight;
			float num10 = 1f - 0.96f * eclipseLight;
			float num11 = 1f - 1f * eclipseLight;
			int num12 = (int)((float)(int)bgColorToSet.R * num9);
			int num13 = (int)((float)(int)bgColorToSet.G * num10);
			int num14 = (int)((float)(int)bgColorToSet.B * num11);
			bgColorToSet.R = (byte)num12;
			bgColorToSet.G = (byte)num13;
			bgColorToSet.B = (byte)num14;
			sunColor.R = byte.MaxValue;
			sunColor.G = 127;
			sunColor.B = 67;
			if (bgColorToSet.R < 20)
			{
				bgColorToSet.R = 20;
			}
			if (bgColorToSet.G < 10)
			{
				bgColorToSet.G = 10;
			}
			if (!Lighting.NotRetro)
			{
				if (bgColorToSet.R < 20)
				{
					bgColorToSet.R = 20;
				}
				if (bgColorToSet.G < 14)
				{
					bgColorToSet.G = 14;
				}
				if (bgColorToSet.B < 6)
				{
					bgColorToSet.B = 6;
				}
			}
		}
		if ((remixWorld && !gameMenu) || WorldGen.remixWorldGen)
		{
			bgColorToSet.R = 1;
			bgColorToSet.G = 1;
			bgColorToSet.B = 1;
		}
		if (lightning > 0f)
		{
			float value = (float)(int)bgColorToSet.R / 255f;
			float value2 = (float)(int)bgColorToSet.G / 255f;
			float value3 = (float)(int)bgColorToSet.B / 255f;
			value = MathHelper.Lerp(value, 1f, lightning);
			value2 = MathHelper.Lerp(value2, 1f, lightning);
			value3 = MathHelper.Lerp(value3, 1f, lightning);
			bgColorToSet.R = (byte)(value * 255f);
			bgColorToSet.G = (byte)(value2 * 255f);
			bgColorToSet.B = (byte)(value3 * 255f);
		}
		if (!info.BloodMoonActive)
		{
			moonColor = Microsoft.Xna.Framework.Color.White;
		}
		instance.HorizonRenderer.ModifyHorizonLight(ref bgColorToSet);
		AuroraSky.ModifyTileColor(ref bgColorToSet, 0.08f);
		ColorOfTheSkies = bgColorToSet;
	}

	public static Microsoft.Xna.Framework.Rectangle GetAreaToLight()
	{
		Vector2 vector = Camera.ScaledPosition;
		Vector2 vector2 = Camera.ScaledSize;
		if (!Lighting.UsingNewLighting)
		{
			vector = Camera.UnscaledPosition;
			vector2 = Camera.UnscaledSize;
		}
		int num = (int)Math.Floor(vector.X / 16f) - 1;
		int num2 = (int)Math.Floor((vector.X + vector2.X) / 16f) + 2;
		int num3 = (int)Math.Floor(vector.Y / 16f) - 1;
		int num4 = (int)Math.Floor((vector.Y + vector2.Y) / 16f) + 2;
		return new Microsoft.Xna.Framework.Rectangle(num, num3, num2 - num, num4 - num3);
	}

	public static void ClampScreenPositionToWorld()
	{
		if (!DebugOptions.noLimits)
		{
			Microsoft.Xna.Framework.Rectangle worldPlayArea = WorldUtils.GetWorldPlayArea();
			Vector2 input = worldPlayArea.TopLeft() - GameViewMatrix.Translation;
			Vector2 input2 = worldPlayArea.BottomRight() - Camera.ScaledSize - GameViewMatrix.Translation;
			input = Utils.Round(input);
			input2 = Utils.Round(input2);
			screenPosition = Vector2.Clamp(screenPosition, input, input2);
		}
	}

	private static float ComputeScAdj(float screenY, float screenHeight)
	{
		float num = (float)(worldSurface * 16.0) / (screenY + screenHeight);
		float num2 = (float)maxTilesY * 0.15f * 16f;
		num2 -= screenY;
		if (num2 < 0f)
		{
			num2 = 0f;
		}
		num2 *= 0.00025f;
		float num3 = num2 * num2;
		num *= 0.45f - num3;
		if (maxTilesY <= 1200)
		{
			return num * -500f;
		}
		if (maxTilesY <= 1800)
		{
			return num * -300f;
		}
		return num * -150f;
	}

	private void DrawBG(SpriteBatchBeginner parentSpriteBatchBeginner)
	{
		scAdj = ComputeScAdj(screenPosition.Y, screenHeight);
		if (gameMenu)
		{
			scAdj = 0f;
		}
		if (resetClouds)
		{
			Cloud.resetClouds();
			resetClouds = false;
		}
		bgScale = 1f;
		bgWidthScaled = (int)((float)backgroundWidth[treeMntBGSet1[0]] * bgScale);
		ColorOfSurfaceBackgroundsModified = ColorOfTheSkies;
		ColorOfSurfaceBackgroundsBase = ColorOfTheSkies;
		int preferredBGStyleForPlayer = GetPreferredBGStyleForPlayer();
		backgroundLayerTransitionSpeed = 0.05f;
		if (bgDelay < 0)
		{
			bgDelay++;
		}
		else if (preferredBGStyleForPlayer != bgStyle)
		{
			DrawBG_HandleBackgroundTransition(preferredBGStyleForPlayer);
		}
		else if (bgDelay > 0)
		{
			bgDelay--;
		}
		if (gameMenu)
		{
			backgroundLayerTransitionSpeed = 0.02f;
			if (!dayTime)
			{
				bgStyle = 1;
			}
			else if (notTheBeesWorld && !remixWorld)
			{
				bgStyle = 3;
			}
			else
			{
				bgStyle = 0;
			}
			preferredBGStyleForPlayer = bgStyle;
			if (WorldGen.drunkWorldGen)
			{
				if (onlyShimmerOceanWorldsGeneration)
				{
					bgStyle = 6;
				}
				else if (vampireSeed)
				{
					bgStyle = 8;
				}
				else if (WorldGen.notTheBees)
				{
					bgStyle = 3;
				}
				else
				{
					bgStyle = 9;
				}
			}
		}
		if (instantBGTransitionCounter > 0)
		{
			instantBGTransitionCounter--;
			bgStyle = preferredBGStyleForPlayer;
			backgroundLayerTransitionSpeed = 1f;
		}
		UpdateBGVisibility_BackLayer(null, null);
		UpdateBGVisibility_FrontLayer(null, null);
		try
		{
			DrawSurfaceBG(parentSpriteBatchBeginner);
			if (BackgroundEnabled)
			{
				DrawUnderworldBackground(GameZoomTarget);
			}
		}
		catch (Exception ex)
		{
			if (!ignoreErrors)
			{
				throw ex;
			}
			TimeLogger.DrawException(ex);
		}
	}

	private void DrawBG_HandleBackgroundTransition(int newBackgroundStyle)
	{
		bool flag = SurfaceBackgroundID.Sets.IsForest[bgStyle];
		bool flag2 = SurfaceBackgroundID.Sets.IsForest[newBackgroundStyle];
		if (!gameMenu && flag && flag2)
		{
			int currentBackgroundOfStyle = WorldGen.GetCurrentBackgroundOfStyle(bgStyle);
			int currentBackgroundOfStyle2 = WorldGen.GetCurrentBackgroundOfStyle(newBackgroundStyle);
			if (currentBackgroundOfStyle == currentBackgroundOfStyle2)
			{
				instantBGTransitionCounter = 1;
				return;
			}
		}
		int num = (flag2 ? 60 : 30);
		bgDelay++;
		if (bgDelay > num)
		{
			bgDelay = -60;
			bgStyle = newBackgroundStyle;
			if (flag2)
			{
				bgDelay = 0;
			}
		}
	}

	private void UpdateBGVisibility_FrontLayer(int? targetBiomeOverride, float? transitionAmountOverride)
	{
		int value = bgStyle;
		if (targetBiomeOverride.HasValue)
		{
			value = targetBiomeOverride.Value;
		}
		float value2 = backgroundLayerTransitionSpeed;
		if (transitionAmountOverride.HasValue)
		{
			value2 = transitionAmountOverride.Value;
		}
		for (int i = 0; i < bgAlphaFrontLayer.Length; i++)
		{
			if (value == i)
			{
				bgAlphaFrontLayer[i] += value2;
				if (bgAlphaFrontLayer[i] > 1f)
				{
					bgAlphaFrontLayer[i] = 1f;
				}
			}
			else if (bgAlphaFrontLayer[i] != 0f && (!UpdateBGVisibility_FrontLayer_IsDesertVariantSwap(value, i) || !(bgAlphaFrontLayer[value] < 1f)))
			{
				bgAlphaFrontLayer[i] -= value2;
				if (bgAlphaFrontLayer[i] < 0f)
				{
					bgAlphaFrontLayer[i] = 0f;
				}
			}
		}
	}

	private bool UpdateBGVisibility_FrontLayer_IsDesertVariantSwap(int targetBiome, int originalBiome)
	{
		if (targetBiome == originalBiome)
		{
			return false;
		}
		if (!SurfaceBackgroundID.Sets.IsDesertVariant[targetBiome] || !SurfaceBackgroundID.Sets.IsDesertVariant[originalBiome])
		{
			return false;
		}
		Func<int, bool> func = (int bg) => bg switch
		{
			2 => desertBackgroundSet.Pure.HasAny, 
			5 => desertBackgroundSet.Corrupt.HasAny, 
			13 => desertBackgroundSet.Hallow.HasAny, 
			14 => desertBackgroundSet.Crimson.HasAny, 
			_ => false, 
		};
		if (func(targetBiome))
		{
			return func(originalBiome);
		}
		return false;
	}

	private void UpdateBGVisibility_BackLayer(int? targetBiomeOverride, float? transitionAmountOverride)
	{
		int value = bgStyle;
		if (targetBiomeOverride.HasValue)
		{
			value = targetBiomeOverride.Value;
		}
		_ = backgroundLayerTransitionSpeed;
		if (transitionAmountOverride.HasValue)
		{
			_ = transitionAmountOverride.Value;
		}
		switch (value)
		{
		case 2:
			DrawBG_ModifyBGFarBackLayerAlpha(1, null, transitionAmountOverride);
			break;
		case 3:
			if (WorldGen.jungleBG == 5)
			{
				DrawBG_ModifyBGFarBackLayerAlpha(15, null, transitionAmountOverride);
			}
			else
			{
				DrawBG_ModifyBGFarBackLayerAlpha(0, null, transitionAmountOverride);
			}
			break;
		case 1:
		case 5:
		case 13:
		case 14:
			DrawBG_ModifyBGFarBackLayerAlpha(2, null, transitionAmountOverride);
			break;
		case 6:
			if (WorldGen.hallowBG == 3)
			{
				DrawBG_ModifyBGFarBackLayerAlpha(6, null, transitionAmountOverride);
			}
			else
			{
				DrawBG_ModifyBGFarBackLayerAlpha(2, null, transitionAmountOverride);
			}
			break;
		case 4:
			DrawBG_ModifyBGFarBackLayerAlpha(3, null, transitionAmountOverride);
			break;
		case 7:
			DrawBG_ModifyBGFarBackLayerAlpha(4, null, transitionAmountOverride);
			break;
		case 8:
			DrawBG_ModifyBGFarBackLayerAlpha(5, null, transitionAmountOverride);
			break;
		case 9:
			DrawBG_ModifyBGFarBackLayerAlpha(0, 6, transitionAmountOverride);
			break;
		case 10:
		case 11:
		case 12:
			DrawBG_ModifyBGFarBackLayerAlpha(value, null, transitionAmountOverride);
			break;
		default:
			DrawBG_ModifyBGFarBackLayerAlpha(0, null, transitionAmountOverride);
			break;
		}
	}

	public static int GetPreferredBGStyleForPlayer()
	{
		int num = bgStyle;
		int num2 = (int)((screenPosition.X + (float)(screenWidth / 2)) / 16f);
		if (SceneMetrics.ZoneBeach)
		{
			num = (SceneMetrics.ZoneHallow ? 6 : (SceneMetrics.ZoneCorrupt ? ((SceneMetrics.BloodTileCount <= SceneMetrics.EvilTileCount) ? 1 : 8) : (SceneMetrics.ZoneCrimson ? 8 : ((SceneMetrics.HoneyBlockCount <= 400) ? 4 : 3))));
		}
		else if (SceneMetrics.ZoneGlowshroom)
		{
			num = 9;
		}
		else if (SceneMetrics.ZoneDesert)
		{
			num = ((SceneMetrics.ZoneCorrupt && SceneMetrics.EvilTileCount > SceneMetrics.BloodTileCount && SceneMetrics.EvilTileCount > SceneMetrics.HolyTileCount) ? 5 : ((SceneMetrics.ZoneCrimson && SceneMetrics.BloodTileCount > SceneMetrics.HolyTileCount) ? 14 : ((!SceneMetrics.ZoneHallow) ? 2 : 13)));
		}
		else if (SceneMetrics.ZoneHallow)
		{
			num = 6;
		}
		else if (SceneMetrics.ZoneCorrupt)
		{
			num = ((SceneMetrics.BloodTileCount <= SceneMetrics.EvilTileCount) ? 1 : 8);
		}
		else if (SceneMetrics.ZoneCrimson)
		{
			num = 8;
		}
		else if (SceneMetrics.ZoneJungle)
		{
			num = 3;
		}
		else if (SceneMetrics.ZoneSnow)
		{
			num = 7;
		}
		else
		{
			num = 0;
			if (num2 >= treeX[0])
			{
				num = ((num2 < treeX[1]) ? 10 : ((num2 >= treeX[2]) ? 12 : 11));
			}
		}
		return num;
	}

	private void DrawBG_ModifyBGFarBackLayerAlpha(int desiredBG, int? desiredBG2 = null, float? transitionAmountOverride = null)
	{
		float value = backgroundLayerTransitionSpeed;
		if (transitionAmountOverride.HasValue)
		{
			value = transitionAmountOverride.Value;
		}
		for (int i = 0; i < bgAlphaFarBackLayer.Length; i++)
		{
			bool flag = desiredBG == i;
			flag |= desiredBG2.HasValue && desiredBG2 == i;
			if (flag || (bgAlphaFarBackLayer[i] != 0f && (!UpdateBGVisibility_FrontLayer_IsDesertVariantSwap(desiredBG, i) || !(bgAlphaFarBackLayer[desiredBG] < 1f))))
			{
				bgAlphaFarBackLayer[i] = MathHelper.Clamp(bgAlphaFarBackLayer[i] + (flag ? value : (0f - value)), 0f, 1f);
			}
		}
	}

	public void DrawInfernoRings()
	{
		for (int i = 0; i < 255; i++)
		{
			if (!player[i].active || player[i].outOfRange || !player[i].inferno || player[i].dead)
			{
				continue;
			}
			LoadFlameRing();
			float num = 1f;
			float num2 = 0.1f;
			float num3 = 0.9f;
			if (!gamePaused && base.IsActive)
			{
				player[i].flameRingScale += 0.004f;
			}
			if (player[i].flameRingScale < 1f)
			{
				num = player[i].flameRingScale;
			}
			else
			{
				player[i].flameRingScale = 0.8f;
				num = player[i].flameRingScale;
			}
			if (!gamePaused && base.IsActive)
			{
				player[i].flameRingRot += 0.05f;
			}
			if (player[i].flameRingRot > (float)Math.PI * 2f)
			{
				player[i].flameRingRot -= (float)Math.PI * 2f;
			}
			if (player[i].flameRingRot < (float)Math.PI * -2f)
			{
				player[i].flameRingRot += (float)Math.PI * 2f;
			}
			for (int j = 0; j < 3; j++)
			{
				float num4 = num + num2 * (float)j;
				if (num4 > 1f)
				{
					num4 -= num2 * 2f;
				}
				float num5 = MathHelper.Lerp(0.8f, 0f, Math.Abs(num4 - num3) * 10f);
				spriteBatch.Draw(TextureAssets.FlameRing.Value, player[i].Center - screenPosition, new Microsoft.Xna.Framework.Rectangle(0, 400 * j, 400, 400), new Microsoft.Xna.Framework.Color(num5, num5, num5, num5 / 2f), player[i].flameRingRot + (float)Math.PI / 3f * (float)j, new Vector2(200f, 200f), num4, SpriteEffects.None, 0f);
			}
		}
	}

	private static void UpdateInvasion()
	{
		if (invasionType <= 0)
		{
			return;
		}
		if (invasionSize <= 0)
		{
			if (invasionType == 1)
			{
				NPC.SetEventFlagCleared(ref NPC.downedGoblins, 0);
				AchievementsHelper.NotifyProgressionEvent(10);
			}
			else if (invasionType == 2)
			{
				NPC.SetEventFlagCleared(ref NPC.downedFrost, 1);
				AchievementsHelper.NotifyProgressionEvent(12);
			}
			else if (invasionType == 3)
			{
				NPC.SetEventFlagCleared(ref NPC.downedPirates, 2);
				AchievementsHelper.NotifyProgressionEvent(11);
			}
			else if (invasionType == 4)
			{
				NPC.SetEventFlagCleared(ref NPC.downedMartians, 3);
				AchievementsHelper.NotifyProgressionEvent(13);
			}
			InvasionWarning();
			invasionType = 0;
			invasionDelay = 0;
			if (netMode == 2)
			{
				NetMessage.SendData(7);
			}
		}
		if (invasionX == (double)spawnTileX)
		{
			return;
		}
		float num = dayRate;
		if (num < 1f)
		{
			num = 1f;
		}
		if (invasionX > (double)spawnTileX)
		{
			invasionX -= num;
			if (invasionX <= (double)spawnTileX)
			{
				invasionX = spawnTileX;
				InvasionWarning();
			}
			else if (num > 0f)
			{
				invasionWarn--;
			}
		}
		else if (invasionX < (double)spawnTileX)
		{
			invasionX += num;
			if (invasionX >= (double)spawnTileX)
			{
				invasionX = spawnTileX;
				InvasionWarning();
			}
			else if (num > 0f)
			{
				invasionWarn--;
			}
		}
		if (invasionWarn <= 0)
		{
			invasionWarn = 3600;
			InvasionWarning();
		}
	}

	private static void InvasionWarning()
	{
		LocalizedText empty = LocalizedText.Empty;
		empty = ((invasionSize <= 0) ? ((invasionType == 2) ? Lang.misc[4] : ((invasionType == 3) ? Lang.misc[24] : ((invasionType != 4) ? (empty = Lang.misc[0]) : Lang.misc[42]))) : ((invasionX < (double)spawnTileX) ? ((invasionType == 2) ? Lang.misc[5] : ((invasionType == 3) ? Lang.misc[25] : ((invasionType != 4) ? (empty = Lang.misc[1]) : LocalizedText.Empty))) : ((invasionX > (double)spawnTileX) ? ((invasionType == 2) ? Lang.misc[6] : ((invasionType == 3) ? Lang.misc[26] : ((invasionType != 4) ? (empty = Lang.misc[2]) : LocalizedText.Empty))) : ((invasionType == 2) ? Lang.misc[7] : ((invasionType == 3) ? Lang.misc[27] : ((invasionType != 4) ? (empty = Lang.misc[3]) : Lang.misc[41]))))));
		if (netMode == 0)
		{
			NewText(empty.ToString(), 175, 75);
		}
		else if (netMode == 2 && empty.Value != "")
		{
			ChatHelper.BroadcastChatMessage(NetworkText.FromKey(empty.Key), new Microsoft.Xna.Framework.Color(175, 75, 255));
		}
	}

	public static bool CanStartInvasion(int type = 1, bool ignoreDelay = false)
	{
		if (invasionType != 0)
		{
			return false;
		}
		if (invasionDelay != 0 && !ignoreDelay)
		{
			return false;
		}
		int num = 0;
		for (int i = 0; i < 255; i++)
		{
			if (player[i].active && player[i].statLifeMax >= 200)
			{
				num++;
			}
		}
		return num > 0;
	}

	public static void StartInvasion(int type = 1)
	{
		if (invasionType != 0 && invasionSize == 0)
		{
			invasionType = 0;
		}
		if (invasionType != 0)
		{
			return;
		}
		int num = 0;
		for (int i = 0; i < 255; i++)
		{
			if (player[i].active && player[i].statLifeMax >= 200)
			{
				num++;
			}
		}
		if (num > 0)
		{
			invasionType = type;
			invasionSize = 80 + 40 * num;
			if (type == 3)
			{
				invasionSize += 40 + 20 * num;
			}
			if (type == 4)
			{
				invasionSize = 160 + 40 * num;
			}
			invasionSizeStart = invasionSize;
			invasionProgress = 0;
			invasionProgressIcon = type + 3;
			invasionProgressWave = 0;
			invasionProgressMax = invasionSizeStart;
			invasionWarn = 0;
			if (type == 4)
			{
				invasionX = spawnTileX - 1;
				invasionWarn = 2;
			}
			else if (rand.Next(2) == 0)
			{
				invasionX = 0.0;
			}
			else
			{
				invasionX = maxTilesX;
			}
			NPCDamageTracker.Start(new InvasionDamageTracker(invasionType));
		}
	}

	public static void FakeLoadInvasionStart()
	{
		int num = 0;
		int num2 = 0;
		switch (invasionType)
		{
		case 1:
		case 2:
			num = 80;
			num2 = 40;
			break;
		case 3:
			num = 120;
			num2 = 60;
			break;
		case 4:
			num = 160;
			num2 = 40;
			break;
		}
		int num3 = (int)Math.Ceiling((float)(invasionSize - num) / (float)num2);
		invasionSizeStart = num;
		if (num3 > 0)
		{
			invasionSizeStart += num3 * num2;
		}
	}

	private static void UpdateClient()
	{
		if (myPlayer == 255)
		{
			Netplay.Disconnect = true;
		}
		netPlayCounter++;
		if (netPlayCounter > 3600)
		{
			netPlayCounter = 0;
		}
		if (netPlayCounter % 420 == 0)
		{
			NetMessage.SendData(13, -1, -1, null, myPlayer);
		}
		if (netPlayCounter % 900 == 0)
		{
			NetMessage.SendData(36, -1, -1, null, myPlayer);
			NetMessage.SendData(16, -1, -1, null, myPlayer);
			NetMessage.SendData(40, -1, -1, null, myPlayer);
		}
		if (Netplay.Connection.IsActive)
		{
			Netplay.Connection.TimeOutTimer++;
			if (!stopTimeOuts && Netplay.Connection.TimeOutTimer > 7200)
			{
				statusText = Lang.inter[43].Value;
				Netplay.Disconnect = true;
			}
		}
		for (int i = 0; i < 400; i++)
		{
			if (item[i].active && item[i].playerIndexTheItemIsReservedFor == myPlayer)
			{
				item[i].FindOwner();
			}
		}
	}

	private static void UpdateServer()
	{
		netPlayCounter++;
		if (netPlayCounter % 3600 == 0)
		{
			NetMessage.SendData(7);
			netPlayCounter = 0;
		}
		for (int i = 0; i < maxNetPlayers; i++)
		{
			if (player[i].active && Netplay.Clients[i].IsActive)
			{
				Netplay.Clients[i].SpamUpdate();
			}
		}
		if (Math.IEEERemainder(netPlayCounter, 900.0) == 0.0)
		{
			bool flag = true;
			int num = lastItemUpdate;
			int num2 = 0;
			while (flag)
			{
				num++;
				if (num >= 400)
				{
					num = 0;
				}
				num2++;
				if (!item[num].active || item[num].playerIndexTheItemIsReservedFor == 255)
				{
					NetMessage.SendData(21, -1, -1, null, num);
				}
				if (num2 >= maxItemUpdates || num == lastItemUpdate)
				{
					flag = false;
				}
			}
			lastItemUpdate = num;
		}
		for (int j = 0; j < 400; j++)
		{
			WorldItem worldItem = item[j];
			if (!worldItem.active)
			{
				continue;
			}
			if (worldItem.playerIndexTheItemIsReservedFor == 255)
			{
				if (netPlayCounter % 5 == 0)
				{
					worldItem.FindOwner();
				}
				continue;
			}
			if (worldItem.timeSinceTheItemHasBeenReservedForSomeone >= 0)
			{
				worldItem.timeSinceTheItemHasBeenReservedForSomeone++;
			}
			if (!player[worldItem.playerIndexTheItemIsReservedFor].active || worldItem.timeSinceTheItemHasBeenReservedForSomeone % 300 == 0)
			{
				worldItem.FindOwner();
			}
		}
		EmergencyStacking.ProcessPendingTransfers();
		for (int k = 0; k < 255; k++)
		{
			if (Netplay.Clients[k].IsActive)
			{
				Netplay.Clients[k].TimeOutTimer++;
				if (Netplay.Clients[k].State == 0)
				{
					Netplay.Clients[k].TimeOutTimer += 3;
				}
				if (!stopTimeOuts && Netplay.Clients[k].TimeOutTimer > 7200)
				{
					Netplay.Clients[k].PendingTermination = true;
					Netplay.Clients[k].PendingTerminationApproved = true;
				}
			}
			if (player[k].active)
			{
				RemoteClient.CheckSection(k, player[k].position);
			}
		}
	}

	public static void NewText(string newText, byte R = byte.MaxValue, byte G = byte.MaxValue, byte B = byte.MaxValue)
	{
		chatMonitor.NewText(newText, R, G, B);
		SoundEngine.PlaySound(12);
	}

	public static void NewTextMultiline(string text, bool force = false, Microsoft.Xna.Framework.Color c = default(Microsoft.Xna.Framework.Color), int WidthLimit = -1)
	{
		chatMonitor.NewTextMultiline(text, force, c, WidthLimit);
		SoundEngine.PlaySound(12);
	}

	public static void StopRain(bool instant = false)
	{
		if (!IsRainingForever)
		{
			rainTime = 0;
			raining = false;
			maxRaining = 0f;
			coinRain = 0;
			if (instant)
			{
				cloudAlpha = maxRaining;
			}
		}
	}

	public static void StartRain(bool instant = false, float? strengthOverride = null, bool garenteeCoinRain = false)
	{
		if (!remixWorld && isThereAWorldSurface && !raining)
		{
			int range = 25;
			if (tenthAnniversaryWorld && !getGoodWorld)
			{
				range = 5;
			}
			range = Player.GetPlayerWithHighestLuck().RollLuck(range);
			if (range == 0 || garenteeCoinRain)
			{
				float num = (float)maxTilesX / 4200f;
				if (netMode == 0)
				{
					NewText(Lang.gen[93].Value, byte.MaxValue, 200, 150);
				}
				else if (netMode == 2)
				{
					ChatHelper.BroadcastChatMessage(NetworkText.FromKey(Lang.gen[93].Key), new Microsoft.Xna.Framework.Color(255, 200, 150));
				}
				coinRain = rand.Next(75, 151) * 100 * 100;
				coinRain = (int)((float)coinRain * num);
			}
		}
		int num2 = 86400;
		int num3 = num2 / 24;
		int num4 = rand.Next(num3 * 8, num2);
		if (rand.Next(3) == 0)
		{
			num4 += rand.Next(0, num3);
		}
		if (rand.Next(4) == 0)
		{
			num4 += rand.Next(0, num3 * 2);
		}
		if (rand.Next(5) == 0)
		{
			num4 += rand.Next(0, num3 * 2);
		}
		if (rand.Next(6) == 0)
		{
			num4 += rand.Next(0, num3 * 3);
		}
		if (rand.Next(7) == 0)
		{
			num4 += rand.Next(0, num3 * 4);
		}
		if (rand.Next(8) == 0)
		{
			num4 += rand.Next(0, num3 * 5);
		}
		float num5 = 1f;
		if (rand.Next(2) == 0)
		{
			num5 += 0.05f;
		}
		if (rand.Next(3) == 0)
		{
			num5 += 0.1f;
		}
		if (rand.Next(4) == 0)
		{
			num5 += 0.15f;
		}
		if (rand.Next(5) == 0)
		{
			num5 += 0.2f;
		}
		if (!IsRainingForever)
		{
			rainTime = (int)((float)num4 * num5);
		}
		ChangeRain(instant, strengthOverride);
		raining = true;
	}

	public static void ChangeRain(bool instant = false, float? strengthOverride = null)
	{
		float val = (strengthOverride.HasValue ? strengthOverride.Value : ((cloudBGActive >= 1f || (double)numClouds > 150.0) ? ((rand.Next(3) != 0) ? ((float)rand.Next(40, 91) * 0.01f) : ((float)rand.Next(20, 91) * 0.01f)) : (((double)numClouds > 100.0) ? ((rand.Next(3) != 0) ? ((float)rand.Next(20, 61) * 0.01f) : ((float)rand.Next(10, 71) * 0.01f)) : ((rand.Next(3) != 0) ? ((float)rand.Next(5, 31) * 0.01f) : ((float)rand.Next(5, 41) * 0.01f)))));
		if (IsRainingForever)
		{
			val = Math.Max(val, 0.01f);
		}
		maxRaining = val;
		if (instant)
		{
			cloudAlpha = maxRaining;
		}
	}

	public static void StartSlimeRain(bool announce = true)
	{
		if (remixWorld || !isThereAWorldSurface || slimeRain)
		{
			return;
		}
		if (netMode == 1)
		{
			if (announce)
			{
				NetMessage.SendData(61, -1, -1, null, myPlayer, -19f);
				return;
			}
			slimeRainTime = 54000.0;
			slimeRain = true;
			SkyManager.Instance.Activate("Slime", default(Vector2));
		}
		else
		{
			if (raining)
			{
				return;
			}
			if (slimeRainTime <= 0.0)
			{
				slimeRainTime = rand.Next(32400, 54000);
			}
			slimeRain = true;
			slimeRainKillCount = 0;
			if (netMode == 0)
			{
				SkyManager.Instance.Activate("Slime", default(Vector2));
				if (announce)
				{
					slimeWarningTime = slimeWarningDelay;
				}
			}
			else if (announce)
			{
				slimeWarningTime = slimeWarningDelay;
				NetMessage.SendData(7);
			}
		}
	}

	public static void StopSlimeRain(bool announce = true)
	{
		if (!slimeRain)
		{
			return;
		}
		if (netMode == 1)
		{
			slimeRainTime = 0.0;
			slimeRain = false;
			SkyManager.Instance.Deactivate("Slime");
			return;
		}
		int num = 86400 * 7;
		if (hardMode)
		{
			num *= 2;
		}
		slimeRainTime = -rand.Next(3024, 6048) * 100;
		slimeRain = false;
		if (netMode == 0)
		{
			if (announce)
			{
				slimeWarningTime = slimeWarningDelay;
			}
			SkyManager.Instance.Deactivate("Slime");
		}
		else if (announce)
		{
			slimeWarningTime = slimeWarningDelay;
			NetMessage.SendData(7);
		}
	}

	private static void UpdateTime()
	{
		if (LanternNight.LanternsUp)
		{
			cloudBGActive = 0f;
			if (numClouds > 30)
			{
				numClouds = 30;
			}
		}
		if (ladyBugRainBoost > 0)
		{
			ladyBugRainBoost -= dayRate;
		}
		if (pumpkinMoon)
		{
			bloodMoon = false;
			snowMoon = false;
		}
		if (snowMoon)
		{
			bloodMoon = false;
		}
		if (((netMode != 1 && !gameMenu) || netMode == 2) && (isThereAWorldSurface || remixWorld))
		{
			if (slimeRainTime > 0.0)
			{
				slimeRainTime -= dayRate;
				if (slimeRainTime <= 0.0)
				{
					StopSlimeRain();
				}
			}
			else if (slimeRainTime < 0.0)
			{
				slimeRainTime += dayRate;
				if (slimeRainTime > 0.0)
				{
					slimeRainTime = 0.0;
				}
			}
			if (raining)
			{
				if (!CreativePowerManager.Instance.GetPower<CreativePowers.FreezeRainPower>().Enabled)
				{
					if (LanternNight.LanternsUp)
					{
						StopRain();
					}
					else
					{
						rainTime -= dayRate;
						if (dayRate > 0)
						{
							int num = 86400 / dayRate / 24;
							if (rainTime <= 0)
							{
								StopRain();
							}
							else if (rand.Next(num * 2) == 0)
							{
								ChangeRain();
							}
						}
					}
				}
			}
			else if (!slimeRain && !LanternNight.LanternsUp && !LanternNight.NextNightIsLanternNight)
			{
				int num2 = 86400;
				num2 /= ((dayRate == 0) ? 1 : dayRate);
				bool flag = !CreativePowerManager.Instance.GetPower<CreativePowers.FreezeRainPower>().Enabled && dayRate != 0;
				if (flag)
				{
					bool flag2 = false;
					for (int i = 0; i < 255; i++)
					{
						if (Main.player[i].active && Main.player[i].statLifeMax >= 120)
						{
							flag2 = true;
							break;
						}
					}
					if (!flag2)
					{
						flag = false;
					}
				}
				if (flag)
				{
					if (rand.Next((int)((double)num2 * 5.75)) == 0)
					{
						StartRain();
					}
					else if (cloudBGActive >= 1f && rand.Next((int)((double)num2 * 4.25)) == 0)
					{
						StartRain();
					}
					else if (ladyBugRainBoost > 0 && rand.Next(num2) == 0)
					{
						StartRain();
					}
				}
				if (!raining && !NPC.BusyWithAnyInvasionOfSorts() && dayTime && time < 27000.0 && dayRate > 0)
				{
					int num3 = (int)(450000.00000000006 / (double)dayRate);
					if (!NPC.downedSlimeKing)
					{
						num3 /= 2;
						if (WorldGen.Skyblock.lowTiles)
						{
							num3 /= 5;
						}
					}
					else if (hardMode)
					{
						num3 = (int)((double)num3 * 1.5);
					}
					bool flag3 = AnyPlayerReadyToFightKingSlime();
					if (!flag3)
					{
						num3 *= 5;
					}
					if (num3 > 0 && (flag3 || expertMode) && rand.Next(num3) == 0)
					{
						StartSlimeRain();
					}
				}
			}
		}
		if (maxRaining != oldMaxRaining)
		{
			if (netMode == 2)
			{
				NetMessage.SendData(7);
			}
			oldMaxRaining = maxRaining;
		}
		UpdateTimeRate();
		double num4 = time;
		time += dayRate;
		CultistRitual.UpdateTime();
		BirthdayParty.UpdateTime();
		LanternNight.UpdateTime();
		Sandstorm.UpdateTime();
		DD2Event.UpdateTime();
		CreditsRollEvent.UpdateTime();
		WorldGen.mysticLogsEvent.UpdateTime();
		PylonSystem.Update();
		if (!dedServ)
		{
			if (NPC.MoonLordCountdown > 0)
			{
				float num5 = MathHelper.Clamp((float)Math.Sin((float)NPC.MoonLordCountdown / 60f * 0.5f) * 2f, 0f, 1f);
				num5 *= 0.75f - 0.5f * ((float)NPC.MoonLordCountdown / (float)NPC.MaxMoonLordCountdown);
				if (!Terraria.Graphics.Effects.Filters.Scene["MoonLordShake"].IsActive())
				{
					Terraria.Graphics.Effects.Filters.Scene.Activate("MoonLordShake", Main.player[myPlayer].position);
				}
				Terraria.Graphics.Effects.Filters.Scene["MoonLordShake"].GetShader().UseIntensity(num5);
			}
			else if (Terraria.Graphics.Effects.Filters.Scene["MoonLordShake"].IsActive())
			{
				Terraria.Graphics.Effects.Filters.Scene.Deactivate("MoonLordShake");
			}
		}
		if (NPC.MoonLordCountdown > 0)
		{
			NPC.MoonLordCountdown--;
			if (NPC.MoonLordCountdown <= 0 && netMode != 1)
			{
				NPC.SpawnOnPlayer(Player.FindClosest(new Vector2(maxTilesX / 2, (float)worldSurface / 2f) * 16f, 0, 0), 398);
			}
		}
		if (NPC.taxCollector && netMode != 2 && !gameMenu)
		{
			Main.player[myPlayer].taxTimer += dayRate;
			if (Main.player[myPlayer].taxTimer >= Player.taxRate)
			{
				Main.player[myPlayer].taxTimer -= Player.taxRate;
				Main.player[myPlayer].CollectTaxes();
			}
		}
		if (netMode != 1)
		{
			UpdateSlimeRainWarning();
		}
		if (netMode != 1)
		{
			if (NPC.travelNPC)
			{
				if (!dayTime || time > 48600.0)
				{
					WorldGen.UnspawnTravelNPC();
				}
			}
			else if (!IsFastForwardingTime() && dayTime && time < 27000.0)
			{
				int num6 = dayRate;
				if (num6 < 1)
				{
					num6 = 1;
				}
				int num7 = (int)(27000.0 / (double)num6);
				num7 *= 4;
				if (rand.Next(num7) == 0)
				{
					int num8 = 0;
					for (int j = 0; j < maxNPCs; j++)
					{
						if (npc[j].active && npc[j].townNPC && npc[j].type != 37 && npc[j].type != 453)
						{
							num8++;
						}
					}
					if (num8 >= 2)
					{
						WorldGen.SpawnTravelNPC();
					}
				}
			}
			NPC.travelNPC = false;
		}
		if (netMode != 1)
		{
			if (!dayTime || time > 48600.0)
			{
				WorldGen.UnspawnHomelessNPC();
			}
			else if (!IsFastForwardingTime() && dayTime && time < 27000.0)
			{
				int num9 = dayRate;
				if (num9 < 1)
				{
					num9 = 1;
				}
				int maxValue = (int)(27000.0 / (double)num9);
				if (rand.Next(maxValue) == 0)
				{
					int num10 = 0;
					for (int k = 0; k < maxNPCs; k++)
					{
						if (npc[k].active && npc[k].townNPC && !npc[k].homeless && npc[k].type != 37 && npc[k].type != 453 && npc[k].type != 368)
						{
							num10++;
						}
					}
					if (num10 >= 1)
					{
						UpdateTime_SpawnTownNPCs(forceUpdate: true);
						WorldGen.SpawnHomelessNPC();
					}
				}
			}
		}
		bool stopEvents = ShouldNormalEventsBeAbleToStart();
		if (!dayTime)
		{
			eclipse = false;
			if (!IsFastForwardingTime() && !stopEvents)
			{
				if (WorldGen.spawnEye && netMode != 1 && time > 4860.0)
				{
					for (int l = 0; l < 255; l++)
					{
						if (Main.player[l].active && !Main.player[l].dead && ((double)Main.player[l].position.Y < worldSurface * 16.0 || (double)spawnTileY > worldSurface) && NPC.Spawner.CanSpawnEnemiesNear(Main.player[l]))
						{
							NPC.SpawnOnPlayer(l, 4);
							WorldGen.spawnEye = false;
							break;
						}
					}
				}
				if (WorldGen.spawnHardBoss > 0 && netMode != 1 && time > 4860.0)
				{
					bool flag4 = false;
					for (int m = 0; m < maxNPCs; m++)
					{
						if (npc[m].active && npc[m].boss)
						{
							flag4 = true;
						}
					}
					if (!flag4)
					{
						for (int n = 0; n < 255; n++)
						{
							if (Main.player[n].active && !Main.player[n].dead && ((double)Main.player[n].position.Y < worldSurface * 16.0 || (double)spawnTileY > worldSurface) && NPC.Spawner.CanSpawnEnemiesNear(Main.player[n]))
							{
								if (SpecialSeedFeatures.Mechdusa)
								{
									NPC.SpawnMechQueen(n);
								}
								else if (WorldGen.spawnHardBoss == 1)
								{
									NPC.SpawnOnPlayer(n, 134);
								}
								else if (WorldGen.spawnHardBoss == 2)
								{
									NPC.SpawnOnPlayer(n, 125);
									NPC.SpawnOnPlayer(n, 126);
								}
								else if (WorldGen.spawnHardBoss == 3)
								{
									NPC.SpawnOnPlayer(n, 127);
								}
								break;
							}
						}
					}
					WorldGen.spawnHardBoss = 0;
				}
				if (netMode != 1)
				{
					double num11 = 16200.0;
					bool num12 = num4 < num11 && time >= num11;
					bool flag5 = raining;
					if (num12 && flag5 && (!NPC.downedDeerclops || rand.Next(4) == 0))
					{
						for (int num13 = 0; num13 < 255; num13++)
						{
							Player player = Main.player[num13];
							if (player.active && !player.dead && !((double)player.position.Y >= worldSurface * 16.0) && player.ZoneSnow && player.townNPCs <= 0 && (player.statLifeMax2 >= 200 || player.statDefense >= 9) && NPC.Spawner.CanSpawnEnemiesNear(Main.player[num13]) && !NPC.AnyDanger())
							{
								NPC.SpawnOnPlayer(num13, 668);
								break;
							}
						}
					}
				}
			}
			if (time > 32400.0)
			{
				UpdateTime_StartDay(ref stopEvents);
			}
			HandleMeteorFall();
		}
		else
		{
			WorldGen.spawnHardBoss = 0;
			WorldGen.spawnEye = false;
			bloodMoon = false;
			stopMoonEvent();
			if (time > 54000.0)
			{
				UpdateTime_StartNight(ref stopEvents);
			}
			UpdateTime_SpawnTownNPCs(forceUpdate: false);
		}
		if (dayTime)
		{
			tileBlockLight[718] = false;
		}
		else
		{
			tileBlockLight[718] = true;
		}
	}

	public static bool AnyPlayerReadyToFightKingSlime()
	{
		for (int i = 0; i < 255; i++)
		{
			if (player[i].active && player[i].statLifeMax > 140 && player[i].statDefense > 8)
			{
				return true;
			}
		}
		return false;
	}

	public static void SkipToTime(int timeToSet, bool setIsDayTime)
	{
		_ = time;
		_ = dayTime;
		while (setIsDayTime != dayTime)
		{
			bool stopEvents = ShouldNormalEventsBeAbleToStart();
			if (dayTime)
			{
				UpdateTime_StartNight(ref stopEvents);
			}
			else
			{
				UpdateTime_StartDay(ref stopEvents);
			}
		}
		time = timeToSet;
		if (netMode == 2)
		{
			NetMessage.TrySendData(7);
		}
	}

	public static bool ShouldNormalEventsBeAbleToStart()
	{
		if (!NPC.LunarApocalypseIsUp && !NPC.AnyNPCs(398) && NPC.MoonLordCountdown <= 0)
		{
			return LanternNight.LanternsUp;
		}
		return true;
	}

	public static void UpdateTime_StartNight(ref bool stopEvents)
	{
		if (fastForwardTimeToDusk)
		{
			fastForwardTimeToDusk = false;
			UpdateTimeRate();
		}
		if (moondialCooldown > 0)
		{
			moondialCooldown--;
		}
		if (!isThereAWorldSurface)
		{
			WorldGen.spawnMeteor = false;
		}
		NPC.ResetBadgerHatTime();
		NPC.freeCake = false;
		Star.NightSetup();
		NPC.setFireFlyChance();
		BirthdayParty.CheckNight();
		LanternNight.CheckNight();
		WorldGen.mysticLogsEvent.StartNight();
		WorldGen.prioritizedTownNPCType = 0;
		checkForSpawns = 0;
		if (rand.Next(50) == 0 && netMode != 1 && NPC.downedBoss2)
		{
			WorldGen.spawnMeteor = true;
		}
		if (LanternNight.LanternsUp)
		{
			stopEvents = true;
		}
		if (eclipse && netMode != 1)
		{
			AchievementsHelper.NotifyProgressionEvent(3);
		}
		eclipse = false;
		if (netMode != 1)
		{
			AchievementsHelper.NotifyProgressionEvent(0);
		}
		if (!IsFastForwardingTime() && !stopEvents)
		{
			if ((!NPC.downedBoss1 || SpecialSeedFeatures.BossesKeepSpawning || WorldGen.Skyblock.noAltars) && netMode != 1)
			{
				bool flag = false;
				for (int i = 0; i < 255; i++)
				{
					if (player[i].active && player[i].statLifeMax >= 200 && player[i].statDefense > 10)
					{
						flag = true;
						break;
					}
				}
				int maxValue = 3;
				if (WorldGen.Skyblock.lowTiles)
				{
					maxValue = 10;
				}
				if (flag && rand.Next(maxValue) == 0)
				{
					int num = 0;
					for (int j = 0; j < maxNPCs; j++)
					{
						if (npc[j].active && npc[j].townNPC)
						{
							num++;
						}
					}
					if (num >= 4)
					{
						WorldGen.spawnEye = true;
						if (netMode == 0)
						{
							NewText(Lang.misc[9].Value, 50, byte.MaxValue, 130);
						}
						else if (netMode == 2)
						{
							ChatHelper.BroadcastChatMessage(Lang.misc[9].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
						}
					}
				}
			}
			if (netMode != 1 && !pumpkinMoon && !DD2Event.Ongoing && !snowMoon && (WorldGen.altarCount > 0 || WorldGen.Skyblock.lowTiles) && hardMode && !WorldGen.spawnEye && rand.Next(10) == 0)
			{
				bool flag2 = false;
				for (int k = 0; k < maxNPCs; k++)
				{
					if (npc[k].active && npc[k].boss)
					{
						flag2 = true;
					}
				}
				if (!flag2 && (!NPC.downedMechBoss1 || !NPC.downedMechBoss2 || !NPC.downedMechBoss3 || SpecialSeedFeatures.BossesKeepSpawning))
				{
					if (remixWorld && getGoodWorld)
					{
						if (rand.Next(2) == 0)
						{
							WorldGen.spawnHardBoss = rand.Next(3) + 1;
							if (netMode == 0)
							{
								NewText(Lang.misc[108].Value, 50, byte.MaxValue, 130);
							}
							else if (netMode == 2)
							{
								ChatHelper.BroadcastChatMessage(Lang.misc[108].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
							}
						}
					}
					else
					{
						for (int l = 0; l < 1000; l++)
						{
							int num2 = rand.Next(3) + 1;
							if (num2 == 1 && (!NPC.downedMechBoss1 || SpecialSeedFeatures.BossesKeepSpawning))
							{
								WorldGen.spawnHardBoss = num2;
								if (netMode == 0)
								{
									NewText(Lang.misc[28].Value, 50, byte.MaxValue, 130);
								}
								else if (netMode == 2)
								{
									ChatHelper.BroadcastChatMessage(Lang.misc[28].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
								}
								break;
							}
							if (num2 == 2 && (!NPC.downedMechBoss2 || SpecialSeedFeatures.BossesKeepSpawning))
							{
								WorldGen.spawnHardBoss = num2;
								if (netMode == 0)
								{
									NewText(Lang.misc[29].Value, 50, byte.MaxValue, 130);
								}
								else if (netMode == 2)
								{
									ChatHelper.BroadcastChatMessage(Lang.misc[29].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
								}
								break;
							}
							if (num2 == 3 && (!NPC.downedMechBoss3 || SpecialSeedFeatures.BossesKeepSpawning))
							{
								WorldGen.spawnHardBoss = num2;
								if (netMode == 0)
								{
									NewText(Lang.misc[30].Value, 50, byte.MaxValue, 130);
								}
								else if (netMode == 2)
								{
									ChatHelper.BroadcastChatMessage(Lang.misc[30].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
								}
								break;
							}
						}
					}
				}
			}
			int maxValue2 = 9;
			if (tenthAnniversaryWorld)
			{
				maxValue2 = 6;
			}
			if (!WorldGen.spawnEye && moonPhase != 4 && rand.Next(maxValue2) == 0 && netMode != 1)
			{
				for (int m = 0; m < 255; m++)
				{
					if (player[m].active && player[m].statLifeMax > 120)
					{
						bloodMoon = true;
						break;
					}
				}
				if (bloodMoon)
				{
					sundialCooldown = 0;
					moondialCooldown = 0;
					AchievementsHelper.NotifyProgressionEvent(4);
					if (netMode == 0)
					{
						NewText(Lang.misc[8].Value, 50, byte.MaxValue, 130);
					}
					else if (netMode == 2)
					{
						ChatHelper.BroadcastChatMessage(Lang.misc[8].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
					}
				}
			}
		}
		time = 0.0;
		dayTime = false;
		if (netMode == 2)
		{
			NetMessage.SendData(7);
		}
	}

	public static void UpdateTime_StartDay(ref bool stopEvents)
	{
		WorldGen.ResetTreeShakes();
		if (fastForwardTimeToDawn)
		{
			fastForwardTimeToDawn = false;
			UpdateTimeRate();
		}
		AnglerQuestSwap();
		BirthdayParty.CheckMorning();
		LanternNight.CheckMorning();
		if (invasionDelay > 0)
		{
			invasionDelay--;
		}
		WorldGen.prioritizedTownNPCType = 0;
		checkForSpawns = 0;
		time = 0.0;
		if (bloodMoon && netMode != 1)
		{
			AchievementsHelper.NotifyProgressionEvent(5);
		}
		bloodMoon = false;
		CheckForMoonEventsScoreDisplay();
		CheckForMoonEventsStartingTemporarySeasons();
		checkXMas();
		checkHalloween();
		stopMoonEvent();
		dayTime = true;
		if (sundialCooldown > 0)
		{
			sundialCooldown--;
		}
		moonPhase++;
		if (moonPhase >= 8)
		{
			moonPhase = 0;
		}
		if (drunkWorld && netMode != 1)
		{
			WorldGen.crimson = !WorldGen.crimson;
		}
		if (netMode == 2)
		{
			NetMessage.SendData(7);
		}
		if (netMode == 1)
		{
			return;
		}
		AchievementsHelper.NotifyProgressionEvent(1);
		if (stopEvents)
		{
			return;
		}
		if (hardMode && NPC.downedMechBossAny && rand.Next(20) == 0)
		{
			sundialCooldown = 0;
			moondialCooldown = 0;
			eclipse = true;
			AchievementsHelper.NotifyProgressionEvent(2);
			if (eclipse)
			{
				if (remixWorld)
				{
					if (netMode == 0)
					{
						NewText(Lang.misc[106].Value, 50, byte.MaxValue, 130);
					}
					else if (netMode == 2)
					{
						ChatHelper.BroadcastChatMessage(Lang.misc[106].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
					}
				}
				else if (netMode == 0)
				{
					NewText(Lang.misc[20].Value, 50, byte.MaxValue, 130);
				}
				else if (netMode == 2)
				{
					ChatHelper.BroadcastChatMessage(Lang.misc[20].ToNetworkText(), new Microsoft.Xna.Framework.Color(50, 255, 130));
				}
			}
			if (netMode == 2)
			{
				NetMessage.SendData(7);
			}
		}
		else
		{
			if (snowMoon || pumpkinMoon || DD2Event.Ongoing)
			{
				return;
			}
			if (WorldGen.shadowOrbSmashed)
			{
				if (!NPC.downedGoblins)
				{
					if (rand.Next(3) == 0)
					{
						StartInvasion();
					}
				}
				else if ((hardMode && rand.Next(60) == 0) || (!hardMode && rand.Next(30) == 0))
				{
					StartInvasion();
				}
			}
			if (invasionType == 0 && hardMode && (WorldGen.altarCount > 0 || WorldGen.Skyblock.lowTiles) && ((NPC.downedPirates && rand.Next(60) == 0) || (!NPC.downedPirates && rand.Next(30) == 0)))
			{
				StartInvasion(3);
			}
		}
	}

	private static void HandleMeteorFall()
	{
		if (netMode != 1 && WorldGen.spawnMeteor)
		{
			if (time < 15000.0)
			{
				_canShowMeteorFall = true;
			}
			else
			{
				if (_canShowMeteorFall && time <= 16200.0)
				{
					AmbienceServer.ForceEntitySpawn(new AmbienceServer.AmbienceSpawnInfo
					{
						skyEntityType = SkyEntityType.Meteor,
						targetPlayer = -1
					});
				}
				_canShowMeteorFall = false;
			}
		}
		if (time > 16200.0 && WorldGen.spawnMeteor)
		{
			WorldGen.spawnMeteor = false;
			if (WorldGen.Skyblock.lowTiles)
			{
				WorldGen.StartMeteorShower();
			}
			else if (!WorldGen.dropMeteor() && rand.Next(3) == 0)
			{
				WorldGen.StartMeteorShower();
			}
		}
	}

	private static void UpdateSlimeRainWarning()
	{
		if (slimeWarningTime <= 0)
		{
			return;
		}
		slimeWarningTime--;
		if (slimeWarningTime > 0)
		{
			return;
		}
		if (netMode == 0)
		{
			if (slimeRainTime > 0.0)
			{
				NewText(Lang.gen[74].Value, 50, byte.MaxValue, 130);
			}
			else
			{
				NewText(Lang.gen[75].Value, 50, byte.MaxValue, 130);
			}
		}
		else if (slimeRainTime > 0.0)
		{
			ChatHelper.BroadcastChatMessage(NetworkText.FromKey(Lang.gen[74].Key), new Microsoft.Xna.Framework.Color(50, 255, 130));
		}
		else
		{
			ChatHelper.BroadcastChatMessage(NetworkText.FromKey(Lang.gen[75].Key), new Microsoft.Xna.Framework.Color(50, 255, 130));
		}
	}

	public static BestiaryUnlockProgressReport GetBestiaryProgressReport()
	{
		float num = 0f;
		int num2 = 0;
		List<BestiaryEntry> entries = BestiaryDB.Entries;
		for (int i = 0; i < entries.Count; i++)
		{
			int num3 = ((entries[i].UIInfoProvider.GetEntryUICollectionInfo().UnlockState > BestiaryEntryUnlockState.NotKnownAtAll_0) ? 1 : 0);
			num2++;
			num += (float)num3;
		}
		return new BestiaryUnlockProgressReport
		{
			EntriesTotal = num2,
			CompletionAmountTotal = num
		};
	}

	private static void UpdateTime_SpawnTownNPCs(bool forceUpdate)
	{
		int worldUpdateRate = WorldGen.GetWorldUpdateRate();
		if (netMode == 1 || !(worldUpdateRate > 0 || forceUpdate))
		{
			return;
		}
		checkForSpawns++;
		if (!forceUpdate && checkForSpawns < 7200 / worldUpdateRate)
		{
			return;
		}
		checkForSpawns = 0;
		int num = 0;
		for (int i = 0; i < 255; i++)
		{
			if (player[i].active)
			{
				num++;
			}
		}
		for (int j = 0; j < NPCID.Count; j++)
		{
			townNPCCanSpawn[j] = false;
		}
		WorldGen.prioritizedTownNPCType = 0;
		int num2 = 0;
		int num3 = 0;
		int num4 = 0;
		int num5 = 0;
		int num6 = 0;
		int num7 = 0;
		int num8 = 0;
		int num9 = 0;
		int num10 = 0;
		int num11 = 0;
		int num12 = 0;
		int num13 = 0;
		int num14 = 0;
		int num15 = 0;
		int num16 = 0;
		int num17 = 0;
		int num18 = 0;
		int num19 = 0;
		int num20 = 0;
		int num21 = 0;
		int num22 = 0;
		int num23 = 0;
		int num24 = 0;
		int num25 = 0;
		int num26 = 0;
		int num27 = 0;
		int num28 = 0;
		int num29 = 0;
		int num30 = 0;
		int num31 = 0;
		int num32 = 0;
		int num33 = 0;
		int num34 = 0;
		int num35 = 0;
		int num36 = 0;
		int num37 = 0;
		int num38 = 0;
		int num39 = 0;
		int num40 = 0;
		for (int k = 0; k < maxNPCs; k++)
		{
			if (npc[k].active && npc[k].townNPC)
			{
				if (npc[k].type != 368 && npc[k].type != 37 && npc[k].type != 453 && !npc[k].homeless)
				{
					WorldGen.QuickFindHome(k);
				}
				if (npc[k].type == 37)
				{
					num7++;
				}
				if (npc[k].type == 17)
				{
					num2++;
				}
				if (npc[k].type == 18)
				{
					num3++;
				}
				if (npc[k].type == 19)
				{
					num5++;
				}
				if (npc[k].type == 20)
				{
					num4++;
				}
				if (npc[k].type == 22)
				{
					num6++;
				}
				if (npc[k].type == 38)
				{
					num8++;
				}
				if (npc[k].type == 54)
				{
					num9++;
				}
				if (npc[k].type == 107)
				{
					num11++;
				}
				if (npc[k].type == 108)
				{
					num10++;
				}
				if (npc[k].type == 124)
				{
					num12++;
				}
				if (npc[k].type == 142)
				{
					num13++;
				}
				if (npc[k].type == 160)
				{
					num14++;
				}
				if (npc[k].type == 178)
				{
					num15++;
				}
				if (npc[k].type == 207)
				{
					num16++;
				}
				if (npc[k].type == 208)
				{
					num17++;
				}
				if (npc[k].type == 209)
				{
					num18++;
				}
				if (npc[k].type == 227)
				{
					num19++;
				}
				if (npc[k].type == 228)
				{
					num20++;
				}
				if (npc[k].type == 229)
				{
					num21++;
				}
				if (npc[k].type == 353)
				{
					num22++;
				}
				if (npc[k].type == 369)
				{
					num23++;
				}
				if (npc[k].type == 441)
				{
					num24++;
				}
				if (npc[k].type == 550)
				{
					num25++;
				}
				if (npc[k].type == 588)
				{
					num26++;
				}
				if (npc[k].type == 633)
				{
					num27++;
				}
				if (npc[k].type == 637)
				{
					num28++;
				}
				if (npc[k].type == 638)
				{
					num29++;
				}
				if (npc[k].type == 656)
				{
					num30++;
				}
				if (npc[k].type == 670)
				{
					num31++;
				}
				if (npc[k].type == 678)
				{
					num32++;
				}
				if (npc[k].type == 679)
				{
					num33++;
				}
				if (npc[k].type == 680)
				{
					num34++;
				}
				if (npc[k].type == 681)
				{
					num35++;
				}
				if (npc[k].type == 682)
				{
					num36++;
				}
				if (npc[k].type == 683)
				{
					num37++;
				}
				if (npc[k].type == 684)
				{
					num38++;
				}
				if (npc[k].type == 663)
				{
					num39++;
				}
				num40++;
			}
		}
		if (WorldGen.prioritizedTownNPCType == 0)
		{
			bool flag = NPC.SpawnAllowed_Merchant();
			bool flag2 = NPC.SpawnAllowed_ArmsDealer();
			bool flag3 = NPC.SpawnAllowed_Nurse();
			bool flag4 = NPC.SpawnAllowed_DyeTrader();
			bool flag5 = NPC.SpawnAllowed_Demolitionist();
			BestiaryUnlockProgressReport bestiaryProgressReport = GetBestiaryProgressReport();
			if (!NPC.downedBoss3 && num7 == 0 && dungeonX >= 0 && dungeonY >= 0)
			{
				int num41 = NPC.NewNPC(NPC.GetSpawnSourceForTownSpawn(), dungeonX * 16 + 8, dungeonY * 16, 37);
				npc[num41].homeless = false;
				npc[num41].homeTileX = dungeonX;
				npc[num41].homeTileY = dungeonY;
			}
			bool flag6 = false;
			if (rand.Next(40) == 0)
			{
				flag6 = true;
			}
			bool flag7 = flag6 && num40 >= 20;
			if (NPC.unlockedPartyGirlSpawn)
			{
				flag7 = true;
			}
			bool flag8 = BirthdayParty.GenuineParty;
			if (NPC.unlockedSlimeGreenSpawn)
			{
				flag8 = true;
			}
			if (num6 < 1)
			{
				townNPCCanSpawn[22] = true;
			}
			if (flag && num2 < 1)
			{
				townNPCCanSpawn[17] = true;
			}
			if (flag3 && num3 < 1 && num2 > 0)
			{
				townNPCCanSpawn[18] = true;
			}
			if (flag2 && num5 < 1)
			{
				townNPCCanSpawn[19] = true;
			}
			if ((infectedSeed || NPC.downedBoss1 || NPC.downedBoss2 || NPC.downedBoss3) && num4 < 1)
			{
				townNPCCanSpawn[20] = true;
			}
			if (flag5 && num2 > 0 && num8 < 1)
			{
				townNPCCanSpawn[38] = true;
			}
			if (NPC.savedStylist && num22 < 1)
			{
				townNPCCanSpawn[353] = true;
			}
			if (NPC.savedAngler && num23 < 1)
			{
				townNPCCanSpawn[369] = true;
			}
			if (NPC.downedBoss3 && num9 < 1)
			{
				townNPCCanSpawn[54] = true;
			}
			if (NPC.savedGoblin && num11 < 1)
			{
				townNPCCanSpawn[107] = true;
			}
			if (NPC.savedTaxCollector && num24 < 1)
			{
				townNPCCanSpawn[441] = true;
			}
			if (NPC.savedWizard && num10 < 1)
			{
				townNPCCanSpawn[108] = true;
			}
			if (NPC.savedMech && num12 < 1)
			{
				townNPCCanSpawn[124] = true;
			}
			if (NPC.downedFrost && num13 < 1 && xMas)
			{
				townNPCCanSpawn[142] = true;
			}
			if (((tenthAnniversaryWorld && !getGoodWorld) || NPC.downedMechBossAny) && num15 < 1)
			{
				townNPCCanSpawn[178] = true;
			}
			if (flag4 && num16 < 1 && num40 >= 4)
			{
				townNPCCanSpawn[207] = true;
			}
			if (NPC.downedQueenBee && num20 < 1)
			{
				townNPCCanSpawn[228] = true;
			}
			if (NPC.downedPirates && num21 < 1)
			{
				townNPCCanSpawn[229] = true;
			}
			if (num14 < 1 && hardMode)
			{
				townNPCCanSpawn[160] = true;
			}
			if (hardMode && NPC.downedPlantBoss && num18 < 1)
			{
				townNPCCanSpawn[209] = true;
			}
			if (num40 >= 8 && num19 < 1)
			{
				townNPCCanSpawn[227] = true;
			}
			if (flag7 && num17 < 1)
			{
				townNPCCanSpawn[208] = true;
			}
			if (NPC.savedBartender && num25 < 1)
			{
				townNPCCanSpawn[550] = true;
			}
			if (NPC.savedGolfer && num26 < 1)
			{
				townNPCCanSpawn[588] = true;
			}
			if (((vampireSeed && !infectedSeed) || bestiaryProgressReport.CompletionPercent >= 0.1f) && num27 < 1)
			{
				townNPCCanSpawn[633] = true;
			}
			if (NPC.boughtCat && num28 < 1)
			{
				townNPCCanSpawn[637] = true;
			}
			if (NPC.boughtDog && num29 < 1)
			{
				townNPCCanSpawn[638] = true;
			}
			if (NPC.boughtBunny && num30 < 1)
			{
				townNPCCanSpawn[656] = true;
			}
			if (NPC.unlockedSlimeBlueSpawn && num31 < 1)
			{
				townNPCCanSpawn[670] = true;
			}
			if (flag8 && num32 < 1)
			{
				townNPCCanSpawn[678] = true;
			}
			if (NPC.unlockedSlimeOldSpawn && num33 < 1)
			{
				townNPCCanSpawn[679] = true;
			}
			if (NPC.unlockedSlimePurpleSpawn && num34 < 1)
			{
				townNPCCanSpawn[680] = true;
			}
			if (NPC.unlockedSlimeRainbowSpawn && num35 < 1)
			{
				townNPCCanSpawn[681] = true;
			}
			if (NPC.unlockedSlimeRedSpawn && num36 < 1)
			{
				townNPCCanSpawn[682] = true;
			}
			if (NPC.unlockedSlimeYellowSpawn && num37 < 1)
			{
				townNPCCanSpawn[683] = true;
			}
			if (NPC.unlockedSlimeCopperSpawn && num38 < 1)
			{
				townNPCCanSpawn[684] = true;
			}
			bool flag9 = num2 > 0 && num3 > 0 && num4 > 0 && num5 > 0 && num6 > 0 && num8 > 0 && num9 > 0 && num10 > 0 && num11 > 0 && num12 > 0 && num14 > 0 && num15 > 0 && num16 > 0 && num17 > 0 && num18 > 0 && num19 > 0 && num20 > 0 && num21 > 0 && num22 > 0 && num23 > 0 && num24 > 0 && num25 > 0 && num26 > 0 && num27 > 0;
			if (tenthAnniversaryWorld && !getGoodWorld)
			{
				flag9 = true;
			}
			if (NPC.unlockedPrincessSpawn)
			{
				flag9 = true;
			}
			if (flag9 && num39 < 1)
			{
				townNPCCanSpawn[663] = true;
			}
			int num42 = WorldGen.prioritizedTownNPCType;
			if (num42 == 0 && infectedSeed && num4 < 1)
			{
				num42 = 20;
			}
			if (num42 == 0 && vampireSeed && !infectedSeed && num27 < 1)
			{
				num42 = 633;
			}
			if (num42 == 0 && num6 < 1)
			{
				num42 = 22;
			}
			if (num42 == 0 && flag && num2 < 1)
			{
				num42 = 17;
			}
			if (num42 == 0 && flag3 && num3 < 1 && num2 > 0)
			{
				num42 = 18;
			}
			if (num42 == 0 && flag2 && num5 < 1)
			{
				num42 = 19;
			}
			if (num42 == 0 && NPC.savedGoblin && num11 < 1)
			{
				num42 = 107;
			}
			if (num42 == 0 && NPC.savedWizard && num10 < 1)
			{
				num42 = 108;
			}
			if (num42 == 0 && (NPC.downedBoss1 || NPC.downedBoss2 || NPC.downedBoss3) && num4 < 1)
			{
				num42 = 20;
			}
			if (num42 == 0 && flag5 && num2 > 0 && num8 < 1)
			{
				num42 = 38;
			}
			if (num42 == 0 && NPC.downedQueenBee && num20 < 1)
			{
				num42 = 228;
			}
			if (num42 == 0 && NPC.downedMechBossAny && num15 < 1)
			{
				num42 = 178;
			}
			if (num42 == 0 && NPC.savedMech && num12 < 1)
			{
				num42 = 124;
			}
			if (num42 == 0 && NPC.savedAngler && num23 < 1)
			{
				num42 = 369;
			}
			if (num42 == 0 && hardMode && NPC.downedPlantBoss && num18 < 1)
			{
				num42 = 209;
			}
			if (num42 == 0 && NPC.downedPirates && num21 < 1)
			{
				num42 = 229;
			}
			if (num42 == 0 && NPC.downedBoss3 && num9 < 1)
			{
				num42 = 54;
			}
			if (num42 == 0 && NPC.savedStylist && num22 < 1)
			{
				num42 = 353;
			}
			if (num42 == 0 && num40 >= 4 && flag4 && num16 < 1)
			{
				num42 = 207;
			}
			if (num42 == 0 && num40 >= 8 && num19 < 1)
			{
				num42 = 227;
			}
			if (num42 == 0 && flag7 && num17 < 1)
			{
				num42 = 208;
			}
			if (num42 == 0 && NPC.downedFrost && num13 < 1 && xMas)
			{
				num42 = 142;
			}
			if (num42 == 0 && NPC.savedBartender && num25 < 1)
			{
				num42 = 550;
			}
			if (num42 == 0 && NPC.savedGolfer && num26 < 1)
			{
				num42 = 588;
			}
			if (num42 == 0 && NPC.savedTaxCollector && num24 < 1)
			{
				num42 = 441;
			}
			if (num42 == 0 && hardMode && num14 < 1)
			{
				num42 = 160;
			}
			if (num42 == 0 && bestiaryProgressReport.CompletionPercent >= 0.1f && num27 < 1)
			{
				num42 = 633;
			}
			if (num42 == 0 && flag9 && num39 < 1)
			{
				num42 = 663;
			}
			if (num42 == 0 && NPC.unlockedSlimeCopperSpawn && num38 < 1)
			{
				num42 = 684;
			}
			if (num42 == 0 && NPC.unlockedSlimeBlueSpawn && num31 < 1)
			{
				num42 = 670;
			}
			if (num42 == 0 && flag8 && num32 < 1)
			{
				num42 = 678;
			}
			if (num42 == 0 && NPC.unlockedSlimeOldSpawn && num33 < 1)
			{
				num42 = 679;
			}
			if (num42 == 0 && NPC.unlockedSlimePurpleSpawn && num34 < 1)
			{
				num42 = 680;
			}
			if (num42 == 0 && NPC.unlockedSlimeRedSpawn && num36 < 1)
			{
				num42 = 682;
			}
			if (num42 == 0 && NPC.unlockedSlimeYellowSpawn && num37 < 1)
			{
				num42 = 683;
			}
			if (num42 == 0 && NPC.unlockedSlimeRainbowSpawn && num35 < 1)
			{
				num42 = 681;
			}
			if (num42 == 0 && NPC.boughtBunny && num30 < 1)
			{
				num42 = 656;
			}
			if (num42 == 0 && NPC.boughtCat && num28 < 1)
			{
				num42 = 637;
			}
			if (num42 == 0 && NPC.boughtDog && num29 < 1)
			{
				num42 = 638;
			}
			WorldGen.prioritizedTownNPCType = num42;
		}
	}

	public static int DamageVar(float dmg, float luck = 0f)
	{
		if (DebugOptions.NoDamageVar)
		{
			return (int)dmg;
		}
		float num = dmg * (1f + (float)rand.Next(-15, 16) * 0.01f);
		if (luck > 0f)
		{
			if (rand.NextFloat() < luck)
			{
				float num2 = dmg * (1f + (float)rand.Next(-15, 16) * 0.01f);
				if (num2 > num)
				{
					num = num2;
				}
			}
		}
		else if (luck < 0f && rand.NextFloat() < 0f - luck)
		{
			float num3 = dmg * (1f + (float)rand.Next(-15, 16) * 0.01f);
			if (num3 < num)
			{
				num = num3;
			}
		}
		return (int)Math.Round(num);
	}

	public static double CalculateDamageNPCsTake(int Damage, int Defense)
	{
		double num = (double)Damage - (double)Defense * 0.5;
		if (num < 1.0)
		{
			num = 1.0;
		}
		return num;
	}

	public static double CalculateDamagePlayersTakeInPVP(int Damage, int Defense)
	{
		double num = (double)Damage - (double)Defense * 0.5;
		if (num < 1.0)
		{
			num = 1.0;
		}
		return num;
	}

	public static double CalculateDamagePlayersTake(int Damage, int Defense)
	{
		double num = (double)Damage - (double)Defense * 0.5;
		if (masterMode)
		{
			num = Damage - Defense;
		}
		else if (expertMode)
		{
			num = (double)Damage - (double)Defense * 0.75;
		}
		if (num < 1.0)
		{
			num = 1.0;
		}
		return num;
	}

	public void OnTileChangeEvent(int x, int y, int count, TileChangeType eventType)
	{
		WorldGen.PlayLiquidChangeSound(eventType, x, y, count);
	}

	public static bool IsFullScreenThatWouldBeStuckOnCrashMessage()
	{
		if (dedServ)
		{
			return false;
		}
		if (graphics == null)
		{
			return true;
		}
		return graphics.IsFullScreen;
	}

	public static void ClearPendingPlayerSelectCallbacks()
	{
		_pendingCharacterSelect = null;
	}

	public static void SelectPlayer(PlayerFileData data)
	{
		if (data.Player.loadStatus != StatusID.Ok)
		{
			throw new Exception("Tried to select a player with loadStatus: " + data.Player.loadStatus);
		}
		myPlayer = 0;
		ServerSideCharacter = false;
		data.SetAsActive();
		if (_pendingCharacterSelect != null)
		{
			_pendingCharacterSelect();
			_pendingCharacterSelect = null;
		}
		else if (menuMultiplayer)
		{
			SoundEngine.PlaySound(10);
			if (autoJoin)
			{
				if (Netplay.SetRemoteIP(getIP))
				{
					menuMode = 10;
					Netplay.StartTcpClient();
				}
				autoJoin = false;
			}
			else if (menuServer)
			{
				LoadWorlds();
				menuMode = 6;
			}
			else
			{
				menuMode = 13;
				clrInput();
			}
		}
		else
		{
			LocalPlayer.position = Vector2.Zero;
			LoadWorlds();
			SoundEngine.PlaySound(10);
			menuMode = 6;
		}
	}

	public static void ToggleFullScreen()
	{
		SetFullScreen(!graphics.IsFullScreen);
	}

	public static void SetFullScreen(bool fullscreen)
	{
		SetDisplayMode(PendingResolutionWidth, PendingResolutionHeight, fullscreen);
	}

	public static void SetResolution(int width, int height)
	{
		SetDisplayMode(width, height, graphics.IsFullScreen);
	}

	public static void SetDisplayMode(int width, int height, bool fullscreen)
	{
		bool flag = false;
		Form form = null;
		if (Platform.IsWindows)
		{
			form = (Form)Control.FromHandle(instance.Window.Handle);
			screenMaximized = form.WindowState == FormWindowState.Maximized;
			if (screenBorderless && screenMaximized && !graphics.IsFullScreen)
			{
				screenMaximized = false;
				form.WindowState = FormWindowState.Normal;
			}
			flag = form.FormBorderStyle == FormBorderStyle.None;
		}
		else
		{
			screenMaximized = false;
		}
		bool flag2 = false;
		int num3;
		int num4;
		if (screenBorderless || screenMaximized || graphics.IsFullScreen || fullscreen)
		{
			bool flag3 = false;
			if (PlayerInput.SteamDeckIsUsed)
			{
				flag3 = true;
				if (!fullscreen && !graphics.IsFullScreen)
				{
					width = 1280;
					height = 800;
					TryPickingDefaultUIScale(800f);
				}
			}
			if (Platform.IsWindows)
			{
				form.MinimumSize = new Size(0, 0);
				if (!fullscreen && !flag3)
				{
					SetDisplayModeAsBorderless(ref width, ref height, form);
				}
			}
			if (width > maxScreenW)
			{
				float num = (float)height / (float)width;
				width = maxScreenW;
				height = (int)(num * (float)width);
			}
			if (height > maxScreenH)
			{
				float num2 = (float)width / (float)height;
				height = maxScreenH;
				width = (int)(num2 * (float)height);
			}
			PlayerInput.RawMouseScale = new Vector2((float)width / (float)instance.Window.ClientBounds.Width, (float)height / (float)instance.Window.ClientBounds.Height);
			if (!graphics.IsFullScreen)
			{
				num3 = Math.Max(graphics.PreferredBackBufferWidth, graphics.GraphicsDevice.Viewport.Width);
				num4 = Math.Max(graphics.PreferredBackBufferHeight, graphics.GraphicsDevice.Viewport.Height);
				if (num3 != graphics.PreferredBackBufferWidth || num4 != graphics.PreferredBackBufferHeight)
				{
					flag2 = true;
				}
			}
			else
			{
				num3 = graphics.PreferredBackBufferWidth;
				num4 = graphics.PreferredBackBufferHeight;
			}
		}
		else
		{
			PlayerInput.RawMouseScale = Vector2.One;
			if (Platform.IsWindows)
			{
				form.MinimumSize = new Size(minScreenW, minScreenH);
				if (flag)
				{
					width = displayWidth[0];
					height = displayHeight[0];
				}
			}
			width = Math.Min(width, maxScreenW);
			height = Math.Min(height, maxScreenH);
			num3 = graphics.GraphicsDevice.Viewport.Width;
			num4 = graphics.GraphicsDevice.Viewport.Height;
			flag2 = graphics.PreferredBackBufferWidth != graphics.GraphicsDevice.Viewport.Width || graphics.PreferredBackBufferHeight != graphics.GraphicsDevice.Viewport.Height;
		}
		if (Platform.IsWindows && !fullscreen && !flag2)
		{
			if (form.ClientSize.Width < graphics.PreferredBackBufferWidth)
			{
				width = form.ClientSize.Width;
				flag2 = true;
			}
			if (form.ClientSize.Height < graphics.PreferredBackBufferHeight)
			{
				height = form.ClientSize.Height;
				flag2 = true;
			}
		}
		width &= 0x7FFFFFFE;
		height &= 0x7FFFFFFE;
		width = Math.Max(width, minScreenW);
		height = Math.Max(height, minScreenH);
		if (graphics.IsFullScreen != fullscreen)
		{
			graphics.PreferredBackBufferWidth = width;
			graphics.PreferredBackBufferHeight = height;
			graphics.ApplyChanges();
			graphics.ToggleFullScreen();
		}
		if (width != num3 || height != num4 || flag2)
		{
			mapTime = 0;
			if (gamePaused)
			{
				renderNow = true;
			}
			screenWidth = width;
			screenHeight = height;
			graphics.PreferredBackBufferWidth = screenWidth;
			graphics.PreferredBackBufferHeight = screenHeight;
			graphics.ApplyChanges();
			PlayerInput.CacheOriginalScreenDimensions();
			FixUIScale();
			if (Main.OnResolutionChanged != null)
			{
				Main.OnResolutionChanged(new Vector2(screenWidth, screenHeight));
			}
			PendingResolutionWidth = screenWidth;
			PendingResolutionHeight = screenHeight;
			PlayerInput.CacheOriginalScreenDimensions();
			if (Platform.IsWindows && !fullscreen)
			{
				if (screenBorderless)
				{
					ApplyBorderlessResolution(form);
					form.FormBorderStyle = FormBorderStyle.None;
				}
				else
				{
					form.FormBorderStyle = FormBorderStyle.Sizable;
				}
				form.SendToBack();
				form.BringToFront();
			}
			Lighting.Initialize();
			if (!drawToScreen && !_isResizingAndRemakingTargets)
			{
				_isResizingAndRemakingTargets = true;
				instance.InitTargets();
				_isResizingAndRemakingTargets = false;
			}
			UserInterface.ActiveInstance.Recalculate();
			instance._needsMenuUIRecalculation = true;
			Console.WriteLine(Language.GetTextValue("Misc.ResolutionChanged", width, height));
		}
		if (!graphics.SynchronizeWithVerticalRetrace)
		{
			graphics.SynchronizeWithVerticalRetrace = true;
			graphics.ApplyChanges();
		}
	}

	public static void FixUIScale()
	{
		UIScale = UIScaleWanted;
	}

	public void FullscreenStartup()
	{
		startFullscreen = false;
		int currentValue = graphics.PreferredBackBufferWidth;
		int currentValue2 = graphics.PreferredBackBufferHeight;
		Configuration.Get("DisplayWidth", ref currentValue);
		Configuration.Get("DisplayHeight", ref currentValue2);
		SetDisplayMode(currentValue, currentValue2, fullscreen: true);
	}

	public void UpdateDisplaySettings()
	{
		if (startFullscreen)
		{
			FullscreenStartup();
		}
		SetResolution(base.GraphicsDevice.Viewport.Width, base.GraphicsDevice.Viewport.Height);
	}

	public static void OpenPlayerSelectFromNet(Action onPlayerSelected)
	{
		QueueMainThreadAction(delegate
		{
			OpenPlayerSelect(onPlayerSelected);
		});
	}

	private static void OpenPlayerSelect(Action onPlayerSelected)
	{
		if ((gameMenu && (menuMode == 10 || menuMode == 14)) || WorldGen.isGeneratingOrLoadingWorld)
		{
			return;
		}
		if (!gameMenu)
		{
			WorldGen.SaveAndQuit(delegate
			{
				OpenPlayerSelect(onPlayerSelected);
			});
			return;
		}
		menuMode = 888;
		_blockFancyUIWhileLoading = true;
		LoadPlayers();
		MenuUI.SetState(_characterSelectMenu);
		_blockFancyUIWhileLoading = false;
		_pendingCharacterSelect = onPlayerSelected;
	}

	public static void SwitchNetMode(int mode)
	{
		if (mode >= 0 && mode <= 2)
		{
			_targetNetMode = mode;
			_hasPendingNetmodeChange = true;
		}
	}

	public static void WeGameRequireExitGame()
	{
		GameAskedToQuit = true;
	}
}
